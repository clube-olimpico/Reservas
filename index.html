<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Clube Ol√≠mpico - Sistema de Reservas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
	<!-- Configura√ß√µes para evitar cache -->
    <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="expires" content="0">

<style>
/* Estilos globais */
body {
    font-family: Arial, sans-serif; 
    margin: 0;
    padding: 0; 
}

    /* Container da tela de login */ 
    #loginScreen {
	box-sizing: border-box; /* Garantir que padding e borda sejam inclu√≠dos na largura */  
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #ffffff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    width: 95%;
    max-width: 350px;
    text-align: center; 
}

/* Cabe√ßalho da tela de login */
#loginHeader {
    margin-bottom: 30px;  
}

#loginHeader h1 {
    font-size: 32px; 
    color: #333;
    margin: 0;
}

#loginHeader h2 {
    font-size: 24px;
    color: #555;
    margin: 10px 0;
}

#loginHeader h3 {
    font-size: 24px;
    color: #777;
    margin: 40px 0;
}

.input-group {
    display: flex;
    align-items: center; /* Alinha os elementos verticalmente */
    gap: 10px;
    width: 100%;
}

.label-senha {
    white-space: nowrap; /* Impede que o texto do label quebre em v√°rias linhas */
    font-weight: bold;
}


.input-container {
    position: relative; /* Permite posicionamento absoluto do bot√£o */
    display: flex;
    align-items: center;
    gap: 5px;
    width: 100%; /* Ocupa toda a largura dispon√≠vel */
}


/* Campo de entrada de senha */
.input-container input {
    width: 280%;
    padding-right: 150px; /* Espa√ßo para o bot√£o √† direita */
	padding: 12px 16px; /* Padding vertical e horizontal */
    box-sizing: border-box;
	height: 35px; /* Altura menor */
}

/* Bot√£o de alternar senha */
#toggleSenha {
    position: right; /* Posicionamento absoluto dentro do container */
    top: 50%; /* Centraliza verticalmente */
    right: 100px; /* Ajuste este valor para mover o bot√£o mais para a esquerda */
    transform: translateY(-50%); /* Centraliza verticalmente */
    background: none;
    border: none;
    cursor: pointer;
    font-size: 18px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
	max-width: 10%;
}


    /* T√≠tulo */
    #loginScreen h2 {
        margin-bottom: 20px;
        font-size: 24px;
        color: #333; 
    }

    /* Dropdown de sele√ß√£o de jogadores */
    #jogadorSelect {
        width: 100%;
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    /* Bot√£o de entrar */
    #loginScreen button {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 10px 20px;
        font-size: 16px;
        border-radius: 5px;
        cursor: pointer;
        width: 100%;
		margin-top: 20px; /* Adiciona espa√ßo entre o √∫ltimo campo e o bot√£o */
    }

    #loginScreen button:hover {
        background-color: #45a049;
    }

    /* Conte√∫do principal (inicialmente oculto) */
    #mainContent {
        display: none;
        text-align: center;
    }

    /* Mensagem de boas-vindas */
    #nomeJogador {
        font-weight: bold;
        color: #4CAF50;
    }

    /* Bot√£o de sair */
    #mainContent button {
        background-color: #f44336;
        color: white;
        border: none;
        padding: 10px 20px;
        font-size: 16px;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 20px;
    }

    #mainContent button:hover {
        background-color: #d32f2f;
    }


/* Cont√™iner principal do formul√°rio */
.form-container {
    padding: 10px;
    margin: 0 auto;
    max-width: 500px;
    margin-top: -5px; /* Espa√ßamento para evitar sobreposi√ß√£o com a barra fixa */
}

/* Configura√ß√£o das linhas do formul√°rio */
.form-row {
    display: flex;
    align-items: center;
    margin-bottom: 7px;
    flex-wrap: nowrap; /* Mant√©m label e input na mesma linha */
}

/* Estiliza√ß√£o dos labels */
label {
    margin-right: 10px;
    width: 160px; /* Tamanho fixo do label para alinhamento */
    font-size: 1rem;
}

/* Configura√ß√£o do campo "Nome do Jogador" */
.jogador-input {
    width: 50px; /* Largura fixa para manter consist√™ncia */
    box-sizing: border-box; /* Inclui padding e bordas no c√°lculo da largura */
    margin: 0;
    padding: 5px;
}


/* Ajusta o tamanho do select de jogadores */
    #jogador1 {
        width: 100% !important;
        max-width: 313px;
    }
	#jogador2 {
        width: 100% !important;
        max-width: 330px;
    }
	#jogador3 {
        width: 100% !important;
        max-width: 330px;
    }
	#jogador4 {
        width: 100% !important;
        max-width: 300px;
    }

/* Responsividade: ajuste para dispositivos m√≥veis */
@media (max-width: 600px) {
     th, td {
        display: table-cell;
		vertical-align: middle; /* Mant√©m o texto alinhado no meio */
		padding: 20px 4px;
        font-size: 18px; /* Opcional: reduz o tamanho da fonte para melhor ajuste */
    }

    .jogador-input {
        width: 100% !important; /* Campo ocupa toda a largura dispon√≠vel */
        max-width: 175px; /* Limita a largura m√°xima */
    }

    /* Aumenta a largura dos campos de entrada em dispositivos m√≥veis */
    input, select, button {
        width: 100% !important; /* Faz com que os campos ocupem toda a largura dispon√≠vel */
        max-width: 400px; /* Define uma largura m√°xima para evitar que fiquem muito largos */
    }

    /* Ajusta o tamanho do select de jogadores */
    #jogador1 {
        width: 100% !important;
        max-width: 193px;
    }
	#jogador2 {
        width: 100% !important;
        max-width: 210px;
    }
	#jogador3 {
        width: 100% !important;
        max-width: 210px;
    }
	#jogador4 {
        width: 100% !important;
        max-width: 210px;
    }

    /* Ajusta o tamanho do select de quadra */
    #quadra {
        width: 100% !important;
        max-width: 210px;
    }

    /* Ajusta o tamanho do select de dia */
    #dia {
        width: 100% !important;
        max-width: 210px;
    }

    /* Ajusta o tamanho do select de dura√ß√£o */
    #duracao {
        width: 100% !important;
        max-width: 210px;
    }

    /* Ajusta o tamanho do select de hor√°rio */
    #hora {
        width: 100% !important;
        max-width: 210px;
    }
	.horario {
        padding: 5px 4px;
        height: 25px;
        line-height: 1;
		font-size: 16px; /* Opcional: reduz o tamanho da fonte para melhor ajuste */
    }
	
}


/* Estiliza√ß√£o geral para inputs, selects e bot√µes */
input, select, button {
    flex-grow: 1;
    padding: 5px;
    font-size: 1rem;
}

/* Cont√™iner de jogadores (campos din√¢micos) */
.jogadores-container {
    display: flex;
    flex-direction: column;
    margin-top: 0px;
}

/* Bot√£o de adicionar jogador */
.add-jogador {
    font-size: 2rem;
    cursor: pointer;
    color: blue;
    margin-top: 1px;
}

/* Estiliza√ß√£o dos bot√µes */
button {
    background-color: #4CAF50;
    color: white;
    border: none;
    cursor: pointer;
    width: 100%;
    padding: 9px;
    margin-top: 1px;
    margin-bottom: -10px;
}

button:hover {
    background-color: #45a049;
}

/* Cont√™iner para as abas de navega√ß√£o */
.tab-container {
    display: flex;
    justify-content: center;
    margin-bottom: 10px;
    position: fixed; /* Fixa as abas no topo */
    top: 0;
    left: 0;
    width: 100%;
    background-color: white; /* Destaque visual */
    z-index: 1000;
    padding: 3px;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1); /* Adiciona uma sombra */
}

/* Configura√ß√£o para tabelas */
.tabela-container {
    overflow-x: auto; /* Permite rolagem horizontal */
    width: 100%;
    margin-top: -10px;
}

table {
    width: 100%;
    margin-top: 20px;
    border-collapse: collapse;
}

th, td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
    white-space: nowrap; /* Impede a quebra de linha */
    overflow: hidden; /* Evita que o conte√∫do transborde */
    text-overflow: ellipsis; /* Adiciona "..." caso o texto seja muito longo */
	height: 10px; /* Ajuste a altura conforme necess√°rio */
	display: table-cell;
}


th {
    background-color: #f2f2f2;
}

/* Estilo para cabe√ßalho */
.header {
    text-align: center;
    font-size: 1.5rem;
    margin-top: 20px;
    margin-bottom: 10px;
    text-indent: 10px; /* Ajuste o valor para o espa√ßamento desejado */
}

/* Classe para aba selecionada */
.selected {
    font-weight: bold;
    background-color: #228B22;
    color: white;
}

/* Transi√ß√£o de opacidade */
.fade-out {
    transition: opacity 0.3s ease-out;
    opacity: 0;
}

/* Estiliza√ß√£o dos bot√µes de aba */
.tab-button {
    position: relative; /* Adiciona posicionamento relativo para o efeito da linha */
    transition: background-color 0.3s ease;
    background-color: #4CAF50;
    color: white;
    border: none;
    padding: 5px 20px;
    margin: 5px;
    cursor: pointer;
}

/* Linha inferior do bot√£o selecionado */
.tab-button.selected::after {
    content: "";
    display: block;
    width: 100%;
    height: 3px;
    background-color: #228B22;
    position: absolute;
    bottom: -8px;
    left: 0;
}

.tab-button:hover {
    background-color: #45a049;
}

/* Bot√£o de aba desabilitado */
.tab-button[disabled] {
    cursor: not-allowed;
    background-color: red;
}

.tab-button.selected {
/* Aba selecionada */
    font-weight: bold;
    background-color: #228B22 !important;
    color: white !important;
    border: 2px solid #1A6418 !important;
}

/* Indicadores de carregamento */
#loading {
    display: block;
    text-align: center;
    font-size: 1.5rem;
}

#content {
    display: none;
}

/* Estiliza√ß√£o para tela cheia */
.fullscreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: white;
    z-index: 9999;
    overflow: auto;
}

.fullscreen table {
    width: 100%;
    height: auto;
}



</style>
</head>

<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script> 
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>   

	
	
<script>
	
//***********************************************************************************************************************************************************************

// Ajuste manual da vers√£o do Sistema
const VersaoSistema = 'v1.3.6'; // Vers√£o atual do sistema 

let vDesabilitarF12 = true; // deixar true para fazer o deploy  
let vAbrirSistema = true; // deixar true para fazer o deploy

let piramideInicioTorneio = null;
let piramideFimTorneio = null;
let vatualizarOpcoesHorario = true; // inicialmente atualizar o campo Hor√°rio 
// Vari√°veis globais que s√£o configuradas em configuracoes.html
window.DiasParaLimpar = undefined; // Ajuste conforme necess√°rio (1,2,3,4,5,6). Ex: se DiasParaLimpar = 4, s√≥ √© permitido fazer reserva em at√© 2 dias de anteced√™ncia.
let vLimparDiasAnteriores = false;
window.vDomingo = undefined; // Valor padr√£o: fechado, pois o clube n√£o abre aos domingos ("aberto", "fechado").

const jogadoresRestritos = ["YURI HARDER", "EDUARDO BERGMAN","BIANCA KROKER","MANUELA KROKER","WILMAR KROKER"]; // jogadores que s√≥ tem acesso √†s quadra 1 e 2.

let quadrasInativas = new Set();
let reservasPorQuadra = {};
let quadraSelecionada = 'Quadra 1 - Coberta'; 
let duplasConfigGlobais = {}; 
let convidadoConfigGlobais = {};
let bloqueiosQuadra = {};

//***********************************************************************************************************************************************************************

if (vDesabilitarF12) {
  // Bloqueia o menu de contexto e o acesso ao console
  document.addEventListener('contextmenu', event => event.preventDefault());
  document.addEventListener('keydown', event => {
    if (event.key === "F12" || (event.ctrlKey && event.shiftKey && event.key === "I")) {
      event.preventDefault();
    }
  });
} else {
  // O c√≥digo est√° comentado (n√£o ser√° executado)
  /*
  document.addEventListener('contextmenu', event => event.preventDefault());
  document.addEventListener('keydown', event => {
    if (event.key === "F12" || (event.ctrlKey && event.shiftKey && event.key === "I")) {
      event.preventDefault();
    }
  });
  */
}


// Configura√ß√£o do Firebase
const firebaseConfig = {
    apiKey: "SUA_API_KEY",
    authDomain: "agenda-5ce95.firebaseapp.com",
    projectId: "agenda-5ce95",
    storageBucket: "agenda-5ce95.appspot.com",
    messagingSenderId: "852007565195",
    appId: "1:852007565195:web:d7bd789d140858f53f618e"
};

// Inicializa√ß√£o do Firebase
const app = firebase.initializeApp(firebaseConfig);
const database = firebase.database();


// Configura√ß√£o inicial do banco de dados
function inicializarEstruturaInicial() { 
    const estruturaInicial = {
        config: {
            DiasParaLimpar: 4, // Valor padr√£o
            vDomingo: "fechado", // Padr√£o fechado
            Quadras: {
                Quadra1: "liberada",
                Quadra2: "liberada",
                Quadra3: "liberada",
            },
        },
        reservas: {
            "Quadra 1 - Coberta": {},
            "Quadra 2 - Aberta": {},
            "Quadra 3 - Coberta": {},
        },
    };

    database.ref("sistemas").set(estruturaInicial)
        .then(() => {
            console.info("Estrutura inicial criada com sucesso no Firebase.");
        })
        .catch((error) => {
            console.error("Erro ao criar estrutura inicial no Firebase:", error);
        });
}

function atualizarLegenda(piramideAtiva) {
    const legendaContainer = document.querySelector('#legenda');
    if (!legendaContainer) {
        console.error("Container da legenda n√£o encontrado!");
        return;
    }

    // Remove todas as linhas existentes antes de recri√°-las
    legendaContainer.innerHTML = '<strong style="font-size: 14px;">Legenda:</strong>';

    if (!piramideAtiva) {
        //alert('piramide nao ativa');
        // Configura a legenda sem a pir√¢mide, com cada item em uma linha
        const itens = [
            { cor: 'lightgreen', texto: '1 Hora' },
            { cor: 'lightblue', texto: '2 Horas' },
            { cor: 'lightcoral', texto: 'Aula' } 
        ];

        itens.forEach((item, index) => {
            const linha = document.createElement('div');
            linha.style.display = 'flex';
            linha.style.alignItems = 'center';
            linha.style.marginBottom = '2px'; // Espa√ßamento entre os itens

            // Adiciona uma margem maior ao √∫ltimo item (Aula)
            if (index === itens.length - 1) {
                linha.style.marginBottom = '-5px'; // Aumenta o espa√ßo entre a linha 2 e a planilha
            }

            const icone = document.createElement('span');
            icone.style.display = 'inline-block';
            icone.style.width = '15px';
            icone.style.height = '17px';
            icone.style.backgroundColor = item.cor;
            icone.style.marginRight = '5px';

            const texto = document.createElement('span');
            texto.style.fontSize = '12px';
            texto.textContent = item.texto;

            linha.appendChild(icone);
            linha.appendChild(texto);
            legendaContainer.appendChild(linha);
        });
    } else {
        //alert('piramide ativa');
        // Configura a legenda com a pir√¢mide, em duas linhas
        const linha1 = document.createElement('div');
        linha1.id = 'linha-1';
        linha1.style.display = 'flex';
        linha1.style.alignItems = 'center';
        linha1.style.gap = '2px'; // Espa√ßamento entre os itens
		linha1.style.marginTop = '5px'; // Aumenta o espa√ßo entre o Label "Legenda" e a linha 1
        linha1.style.marginBottom = '5px'; // Aumenta o espa√ßo entre a linha 1 e a linha 2

        const linha2 = document.createElement('div');
        linha2.id = 'linha-2';
        linha2.style.display = 'flex';
        linha2.style.alignItems = 'center';
        linha2.style.gap = '2px'; // Espa√ßamento entre os itens

        // Adiciona os itens √† linha 1
        linha1.innerHTML = `
            <span style="display: inline-block; width: 15px; height: 17px; background-color: lightgreen; margin-right: 2px;"></span>
            <span style="font-size: 12px;">1 Hora</span>
            <span style="display: inline-block; width: 15px; height: 18px; background-color: lightblue; margin-right: 2px; margin-left: 10px;"></span>
            <span style="font-size: 12px;">2 Horas</span>
        `;

        // Adiciona os itens √† linha 2
        linha2.innerHTML = `
            <span style="display: inline-block; width: 15px; height: 18px; background-color: lightcoral; margin-right: 5px;"></span>
            <span style="font-size: 12px;">Aula</span>
            <span id="piramide-span" style="display: inline-block; width: 15px; height: 18px; background-color: #FFEB99 ; margin-left: 19px; margin-right: 1px;"></span>
            <span id="piramide-text" style="font-size: 12px;">Pir√¢mide</span>
        `;

        // Adiciona as linhas ao container da legenda
        legendaContainer.appendChild(linha1);
        legendaContainer.appendChild(linha2);
    }
}

function removerSessoesAntigas() {
    const usuariosRef = database.ref('sistemas/usuariosOnline');
    const agora = Date.now();
    const limiteTempo = 3 * 60 * 60 * 1000; //  sess√µes de mais de 3 horas ser√£o exclu√≠das

    console.log("‚è≥ Iniciando verifica√ß√£o de sess√µes antigas...");


    usuariosRef.once('value', snapshot => {
        const usuarios = snapshot.val();

        if (!usuarios) {
            console.log("‚úÖ Nenhum usu√°rio online encontrado.");
            return;
        }

        Object.entries(usuarios).forEach(([id, sessao]) => {
            const timestampSessao = sessao.timestamp || 0;
            const diff = agora - timestampSessao;

            if ((agora - timestampSessao) > limiteTempo) {
				console.warn(`üóëÔ∏è Sess√£o antiga detectada! Tentando remover ${id} (${sessao.usuario})`);

				database.ref(`sistemas/usuariosOnline/${id}`).remove()
					.then(() => {
						console.log(`‚úÖ Sess√£o ${id} removida com sucesso do banco.`);
					})
					.catch((error) => {
						console.error(`‚ùå Erro ao remover sess√£o ${id}:`, error);
					});
			} else {
				console.log(`‚úÖ Sess√£o ainda v√°lida. Mantida no sistema.`);
			}
        });
    });
}




let githubToken = ''; // Vari√°vel global para armazenar o token

// Inicializa√ß√£o do sistema
function InicializarSistema() {
    return new Promise((resolve, reject) => {
        const sistemaRef = database.ref("sistemas"); 

        sistemaRef.on('value', (snapshot) => {
            const data = snapshot.val();

            if (data) {
                const minVersion = data.version;
                if (VersaoSistema !== minVersion) {
                    alert("Sua vers√£o est√° desatualizada. Atualize o aplicativo para continuar.");
                    window.close();
                }

                const config = data.config;
				
				githubToken = config.githubToken;
				
				//alert(`token: ${githubToken}`);
				
				
               
			   
			    if (vAbrirSistema) {
				  // Permiss√£o para abrir o sistema
				  if (config && config.Abrir === false) {
				    alert("‚ö†Ô∏è Aten√ß√£o:\n\nO sistema est√° em manuten√ß√£o provis√≥ria no momento.\nPor favor, tente novamente mais tarde.\n\nObrigado pela compreens√£o.");
					window.close();
					return;
				  }
				} else {
				  // O c√≥digo est√° comentado (n√£o ser√° executado)
				  /*
				  if (config && config.Abrir === false) {
					window.close();
					return;
				  }
				  */
				}
		        
				

                // Verifica se a pir√¢mide est√° ativa (em tempo real)
                const piramideAtiva = config?.Piramide?.ativa || false; // Valor padr√£o: false
				piramideInicioTorneio = config?.Piramide?.inicio || null;
				piramideFimTorneio = config?.Piramide?.fim || null;
                const duracaoSelect = document.getElementById('duracao');
                const piramideOption = duracaoSelect?.querySelector('option[value="3-piramide"]');

                if (piramideOption) {
                    piramideOption.style.display = piramideAtiva ? 'block' : 'none'; // Mostra ou oculta a op√ß√£o "Pir√¢mide"
                }
                
                // Atualiza a legenda com base no estado da Pir√¢mide
                atualizarLegenda(piramideAtiva);
                
                if (piramideAtiva) {
                    window.config = window.config || {};
                    window.config.Piramide = config.Piramide;
                }

                if (config) {
                    window.DiasParaLimpar = config.DiasParaLimpar || 4;
                    window.vDomingo = config.vDomingo || "fechado";
                    window.vDomingoAte = config.vDomingoAte || "23:00"; // Valor padr√£o caso n√£o esteja definido
					
					duplasConfigGlobais = config.Duplas || {}; // Carrega a config de Duplas na vari√°vel global
					
				    convidadoConfigGlobais = config.Convidados || {}; // Carrega a config de Convidados
					
					bloqueiosQuadra = config.Quadras?.Bloqueios || {};  // Carrega a config de Bloqueios
					
                    quadrasInativas.clear();
                    const quadras = config.Quadras || {};
                    if (quadras.Quadra1 === "interditada") quadrasInativas.add("Quadra 1 - Coberta");
                    if (quadras.Quadra2 === "interditada") quadrasInativas.add("Quadra 2 - Aberta");
                    if (quadras.Quadra3 === "interditada") quadrasInativas.add("Quadra 3 - Coberta");

                    atualizarDatas();
					
					if (vatualizarOpcoesHorario) {
					  atualizarOpcoesHorario();
					  document.getElementById('quadra').selectedIndex = 0;
					  vatualizarOpcoesHorario = false;
					}
                }
            } else {
                inicializarEstruturaInicial();
            }

            let quadraInicial = quadraSelecionada || "Quadra 1 - Coberta";
            if (quadrasInativas.has(quadraInicial)) {
                const proximasQuadras = ["Quadra 2 - Aberta", "Quadra 3 - Coberta"].filter(quadra => !quadrasInativas.has(quadra));
                if (proximasQuadras.length > 0) {
                    quadraInicial = proximasQuadras[0];
                } else {
                    quadrasInativas.clear();
                    quadrasInativas.add("Quadra 1 - Coberta");
                    quadrasInativas.add("Quadra 2 - Aberta");
                    quadrasInativas.add("Quadra 3 - Coberta");

                    atualizarEstadoQuadras();

                    const selectQuadra = document.getElementById('quadra');
                    if (selectQuadra) {
                        selectQuadra.innerHTML = "";
                        const defaultOption = document.createElement('option');
                        defaultOption.value = "";
                        defaultOption.textContent = "Nenhuma quadra dispon√≠vel";
                        selectQuadra.appendChild(defaultOption);
                    }

                    const tabelaContainer = document.querySelector('.tabela-container');
                    const header = document.querySelector('.header');
                    if (tabelaContainer) tabelaContainer.style.display = 'none';
                    if (header) header.style.display = 'none';

                    alert("Todas as quadras est√£o interditadas no momento.");
                    resolve();
                    return; 
                }
            }

            document.querySelectorAll('.tab-button').forEach(button => {
                if (button.innerText.trim() === quadraInicial) {
                    button.classList.add('selected');
                } else {
                    button.classList.remove('selected');
                }
            });

            const selectQuadra = document.getElementById('quadra');
			if (selectQuadra) {
				selectQuadra.innerHTML = "";

				const jogadorLogado = localStorage.getItem("jogadorLogado")?.toUpperCase();
				const isRestrito = jogadoresRestritos.includes(jogadorLogado);
				const todasQuadras = ["Quadra 1 - Coberta", "Quadra 2 - Aberta", "Quadra 3 - Coberta"];
				const quadrasAutorizadas = isRestrito
					? ["Quadra 1 - Coberta", "Quadra 2 - Aberta"]
					: todasQuadras;

				quadrasAutorizadas.forEach(quadra => {
					if (!quadrasInativas.has(quadra)) {
						const option = document.createElement('option');
						option.value = quadra;
						option.textContent = quadra;
						selectQuadra.appendChild(option);
					}
				});

				// Esta linha foi restaurada para definir a quadra inicial
				selectQuadra.value = quadraInicial;
			}

            const tabelaContainer = document.querySelector('.tabela-container');
            const header = document.querySelector('.header');
            if (tabelaContainer) tabelaContainer.style.display = 'block';
            if (header) {
                header.style.display = 'block';
                header.innerText = quadraInicial;
            }

            atualizarEstadoQuadras();
            selecionarQuadra(quadraInicial);
			
			// ADICIONE ESTA LINHA PARA FOR√áAR O RESET DO DROPDOWN
			//document.getElementById('quadra').selectedIndex = 0;
            resolve();

        }, (error) => {
            console.error("Erro ao carregar dados iniciais:", error);
            reject(error);
        });
    });
}





function atualizarEstadoQuadras() {
    // Atualiza o estado visual das quadras com base no conjunto quadrasInativas
    document.querySelectorAll('.tab-button').forEach(button => {
        const quadraNome = button.innerText.trim();

        if (quadrasInativas.has(quadraNome)) {
            button.style.setProperty("background-color", "red", "important");
            button.style.setProperty("cursor", "not-allowed", "important");
            button.onclick = () => alert(`A ${quadraNome} est√° interditada provisoriamente.`);
        } else {
            button.style.setProperty("background-color", "#lightgreen", "important");
            button.style.setProperty("cursor", "pointer", "important");
            button.onclick = () => selecionarQuadra(quadraNome);
        }
    });

    // --- NOVO: Desativa o bot√£o Agendar se todas as quadras estiverem inativas OU se o dropdown estiver vazio
	const todasIndisponiveis = ["Quadra 1 - Coberta", "Quadra 2 - Aberta", "Quadra 3 - Coberta"]
		.every(quadra => quadrasInativas.has(quadra));

	const selectQuadra = document.getElementById('quadra');
	const dropdownVazio = !selectQuadra || selectQuadra.options.length === 0;

	const botaoAgendar = document.getElementById('botaoAgendar');
	if (botaoAgendar) {
		const desativar = todasIndisponiveis || dropdownVazio;

		// A MUDAN√áA EST√Å AQUI:
		// Se a condi√ß√£o 'desativar' for verdadeira, o bot√£o √© desabilitado.
		// Se for falsa, N√ÉO FAZEMOS NADA, deixando o bot√£o no estado em que ele j√° est√°.
		if (desativar) {
			botaoAgendar.disabled = true;
		}

		// A l√≥gica de estilo pode ser mantida ou simplificada se preferir,
		// mas o importante √© a condi√ß√£o 'if' acima.
		botaoAgendar.style.opacity = botaoAgendar.disabled ? "0.5" : "1";
		botaoAgendar.style.cursor = botaoAgendar.disabled ? "not-allowed" : "pointer";
		botaoAgendar.title = botaoAgendar.disabled ? "Preencha todos os campos para agendar" : "";
	}
}


function atualizarReservasQuadra(quadra) {
    limparTabela();
    const reservas = reservasPorQuadra[quadra];
    if (reservas) {
        const tabela = document.getElementById('tabelaCorpo');
        for (const key in reservas) {
            const { jogadores, dia, hora, duracao, borda } = reservas[key];
            const rowIndex = hora - 6;
            const colIndex = dia;

            // Ignorar s√°bado (coluna 6) das 21:00 √†s 23:00 e domingo (coluna 7) das 06:00 √†s 08:00
            if ((colIndex === 6 && hora >= 21 && hora <= 23) || (colIndex === 7 && hora >= 6 && hora <= 8)) {
                continue;
            }

            const cell = tabela.rows[rowIndex]?.cells[colIndex];
            if (cell) {
                cell.innerHTML = jogadores;
                cell.setAttribute("data-duracao", duracao);
                cell.style.backgroundColor = jogadores.toLowerCase().includes('aula') ? 'lightcoral' :
                    (duracao === 1 ? 'lightgreen' : 'lightblue');

                // Configurar bordas para reservas de 1h ou 2h
                if (borda === '1h') {
                    cell.style.border = '2px solid black';
                } else if (borda === '2h') {
                    configurarBordasDuracao2(cell, tabela, rowIndex, colIndex);
                }
            }
        }
    }
}

function configurarBordasDuracao2(cell, tabela, rowIndex, colIndex) {
    if (cell.rowSpan > 1) {
        cell.style.borderTop = '2px solid black';
        cell.style.borderLeft = '2px solid black';
        cell.style.borderRight = '2px solid black';
        cell.style.borderBottom = '2px solid black';
    } else {
        cell.style.borderTop = '2px solid black';
        cell.style.borderLeft = '2px solid black';
        cell.style.borderRight = '2px solid black';
        cell.style.borderBottom = 'none';

        const cellNext = tabela.rows[rowIndex + 1]?.cells[colIndex];
        if (cellNext) {
            cellNext.style.borderTop = 'none';
            cellNext.style.borderLeft = '2px solid black';
            cellNext.style.borderRight = '2px solid black';
            cellNext.style.borderBottom = '2px solid black';
        }
    }
}




function verificarVersao() {
    const elementoVersao = document.getElementById('VersaoSistema');
    if (elementoVersao) {
        elementoVersao.textContent = `${VersaoSistema}`;
    } else {
        console.error('Elemento para exibir a vers√£o n√£o encontrado!');
    }
}

let jogadorCount = 1;

function atualizarEstadoDomingo() {
    const tabela = document.getElementById('tabelaCorpo');
    const diaDomingo = 7; // coluna do domingo
    const horarioLimite = window.vDomingoAte ? parseInt(window.vDomingoAte.split(':')[0]) : 23;

    for (let i = 0; i < tabela.rows.length; i++) {
        const horario = i + 6;
        const celulaDomingo = tabela.rows[i].cells[diaDomingo];

        // Bloqueia sempre das 6h √†s 8h
        if (horario >= 6 && horario < 8) {
            celulaDomingo.style.backgroundColor = '#f2f2f2';
            celulaDomingo.style.pointerEvents = 'none';
            celulaDomingo.style.cursor = 'not-allowed';
            continue;
        }

        if (vDomingo === 'fechado') {
            if (horario >= 12) {
                celulaDomingo.style.backgroundColor = '#f2f2f2';
                celulaDomingo.style.pointerEvents = 'none';
                celulaDomingo.style.cursor = 'not-allowed';
            } else if (celulaDomingo.innerHTML.trim() === "") {
                celulaDomingo.style.backgroundColor = '';
                celulaDomingo.style.pointerEvents = '';
                celulaDomingo.style.cursor = '';
            }
        } else if (vDomingo === 'aberto') {
            if (horario >= horarioLimite) {
                celulaDomingo.style.backgroundColor = '#f2f2f2';
                celulaDomingo.style.pointerEvents = 'none';
                celulaDomingo.style.cursor = 'not-allowed';
            } else if (horario >= 8 && celulaDomingo.innerHTML.trim() === "") {
                celulaDomingo.style.backgroundColor = '';
                celulaDomingo.style.pointerEvents = '';
                celulaDomingo.style.cursor = '';
            }
        }
    }
	atualizarOpcoesHorario();
}





function limparTabela() {
    const tabela = document.getElementById('tabelaCorpo');
    for (let i = 0; i < tabela.rows.length; i++) {
        for (let j = 1; j < tabela.rows[i].cells.length - 1; j++) {
            const horario = i + 6;

            if ((j === 6 && horario === 6) || (j === 7 && horario >= 6 && horario <= 7) || (j === 6 && horario >= 21 && horario <= 23)) {
                continue;
            }

            const cell = tabela.rows[i].cells[j];
            if (cell.rowSpan > 1) {
                const nextCell = tabela.rows[i + 1]?.cells[j];
                if (nextCell) {
                    nextCell.style.display = '';
                }
                cell.rowSpan = 1;
            }

            cell.style.borderTop = "1px solid #ddd";
            cell.style.borderBottom = "1px solid #ddd";
            cell.style.borderLeft = "1px solid #ddd";
            cell.style.borderRight = "1px solid #ddd";
            cell.style.backgroundColor = "";
            cell.innerHTML = "";
        }
    }
}

// Fun√ß√£o para selecionar a quadra e carregar suas reservas
function selecionarQuadra(quadra) {
    // Obt√©m o nome original da quadra
    const botoes = document.querySelectorAll('.tab-button');
    let nomeOriginal = null;

    botoes.forEach(button => {
        // Verifica se o bot√£o corresponde ao nome exibido ou ao nome original
        if (
            button.getAttribute('data-nome-original') === quadra ||
            button.innerHTML.replace('<br>', '').trim() === quadra
        ) {
            nomeOriginal = button.getAttribute('data-nome-original');
            
            // Alerta com o label do bot√£o clicado
            const labelBotao = button.textContent.trim(); // Obt√©m o texto do bot√£o
            //alert(`Label do bot√£o clicado: ${labelBotao}`);
        }
    });

    // alert(`quadra: ${quadra}`); 
    if (!nomeOriginal) {
        // Substitui quebras de linha e espa√ßos m√∫ltiplos por um √∫nico espa√ßo
        const quadraNormalized = quadra.replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim();
        //console.log(`Valor ajustado de quadra: "${quadraNormalized}"`);
        //alert(`Valor ajustado de quadra: "${quadraNormalized}"`);
        // Verifica o nome normalizado
        if (quadraNormalized === "Quadra 1 - Coberta" || quadraNormalized === "Quadra 1 Coberta") {
            nomeOriginal = "Quadra 1 - Coberta";
        } else if (quadraNormalized === "Quadra 2 - Aberta" || quadraNormalized === "Quadra 2 Aberta") {
            nomeOriginal = "Quadra 2 - Aberta";
        } else if (quadraNormalized === "Quadra 3 - Coberta" || quadraNormalized === "Quadra 3 Coberta") {
            nomeOriginal = "Quadra 3 - Coberta"; 
        }
    }
	
    //nomeOriginal = "Quadra 3 - Coberta";
	
    //alert(`Quadra selecionada: ${nomeOriginal}`); // Alerta com o nome da quadra

    if (!nomeOriginal) {
        console.error('Quadra n√£o encontrada:', quadra);
        return;
    }

    // Verifica se a quadra est√° interditada
    const isQuadraInterditada = quadrasInativas.has(nomeOriginal);

    if (isQuadraInterditada) {
        alert(`A ${nomeOriginal} est√° interditada provisoriamente.`);
        return;
    }

    // Atualiza a quadra selecionada
    quadraSelecionada = nomeOriginal;
    document.querySelector('.header').innerText = nomeOriginal;

    // Remove a classe 'selected' e estilo inline de todos os bot√µes
    botoes.forEach(button => {
        button.classList.remove('selected');
        button.style.backgroundColor = ''; // Remove estilo inline
        button.style.color = ''; // Remove estilo inline
        button.style.border = ''; // Remove estilo inline
    });

    // Adiciona a classe 'selected' e estilo inline ao bot√£o correspondente
    botoes.forEach(button => {
        if (button.getAttribute('data-nome-original') === nomeOriginal) {
            button.classList.add('selected'); // Aplica a classe 'selected' para quadra selecionada
            button.style.backgroundColor = '#228B22'; // Cor verde escuro para quadra selecionada
			button.style.color = 'white'; // Texto branco
            button.style.border = '2px solid #1A6418'; // Borda escura para quadra selecionada (apenas para a verde)
        }

        // Verifica se a quadra est√° interditada e aplica o estilo vermelho
        if (quadrasInativas.has(button.getAttribute('data-nome-original'))) {
            button.style.backgroundColor = 'red'; // Bot√£o vermelho para quadras interditadas
            button.style.color = 'white'; // Texto branco
            button.style.border = ''; // Remove a borda para o bot√£o vermelho 
        }
    });

    // Atualiza o estado do domingo ap√≥s selecionar a quadra
    atualizarEstadoDomingo();

    // Atualiza e exibe reservas para a quadra selecionada
    carregarReservas(nomeOriginal);
}



function carregarReservas(quadra) {
    celulasExcluidas.clear();
    reservasExcluidasFirebase.clear();

    const reservasRef = database.ref(`sistemas/reservas/${quadra}`);

    reservasRef.off('value'); // Remove ouvintes antigos
    reservasRef.on('value', (snapshot) => {
        const reservas = snapshot.val();

        limparTabela();
        atualizarEstadoDomingo();
        aplicarBloqueiosVisuais(quadra);

        if (reservas) {
            try {
                const tabela = document.getElementById('tabelaCorpo');
                const totalRows = tabela.rows.length;
                const totalCols = tabela.rows[0]?.cells.length || 0;

                for (const key in reservas) {
                    const reserva = reservas[key]; 

                    if (typeof reserva.jogadores === 'undefined' || reserva.jogadores === null) {
                        const erroMsg = `‚ö†Ô∏è Erro de Dados Encontrado!\n\nExiste uma reserva antiga ou corrompida que est√° impedindo a exibi√ß√£o correta da agenda.\n\nPor favor, envie esta informa√ß√£o para o administrador:\n\n- Quadra: ${quadra}\n- Chave do Problema: ${key}`;
                        alert(erroMsg);
                        throw new Error(erroMsg);
                    }
                    
                    let { jogadores, dia, hora, duracao, borda } = reserva;

                    const rowIndex = hora - 6;
                    const colIndex = dia;

                    if (rowIndex >= 0 && rowIndex < totalRows && colIndex >= 0 && colIndex < totalCols) {
                        const cell = tabela.rows[rowIndex].cells[colIndex];
                        cell.setAttribute("data-duracao", duracao || "segunda-celula");

                        let corFundo;
                        if (jogadores.toLowerCase().includes('aula')) {
                            corFundo = 'lightcoral';
                            cell.innerHTML = "aula"; 
                        } else if (duracao === 3 || (reservas[key.split('_')[0] + '_' + (hora - 1)] && reservas[key.split('_')[0] + '_' + (hora - 1)].duracao === 3)) {
                            corFundo = '#FFEB99';
							
							// --- IN√çCIO DA CORRE√á√ÉO ---
                            // Formata os nomes dos jogadores com a posi√ß√£o correta na pir√¢mide
                            const jogadoresArray = jogadores.split(', ');
                            const jogadoresFormatados = jogadoresArray.map(apelido => {
                                const jogadorInfo = jogadoresData[apelido];
                                
                                if (jogadorInfo && jogadorInfo.piramide && jogadorInfo.piramide !== "0") {
                                    const piramidePos = parseInt(jogadorInfo.piramide, 10);
                                    let displayRank = piramidePos; // Por padr√£o, o ranking √© a posi√ß√£o do banco

                                    // Se for da pir√¢mide feminina (61+), calcula o ranking real para exibi√ß√£o
                                    if (piramidePos >= 61) {
                                        displayRank = piramidePos - 60; // Ex: 61 -> 1, 69 -> 9
                                    }
                                    
                                    // Retorna o nome formatado com o ranking correto
                                    return `${displayRank} - ${apelido}`;
                                } else {
                                    // Se n√£o tiver info da pir√¢mide, retorna s√≥ o apelido
                                    return apelido;
                                }
                            });
                            // Junta os nomes com uma quebra de linha para melhor visualiza√ß√£o na c√©lula
                            cell.innerHTML = jogadoresFormatados.join('<br>');
                            // --- FIM DA CORRE√á√ÉO ---

                        } else {
                            corFundo = duracao === 1 ? 'lightgreen' : 'lightblue';
                            cell.innerHTML = jogadores;
                        }

                        cell.style.backgroundColor = corFundo;

                        if (borda === '1h') {
                            cell.style.border = '2px solid black';
                        } else if (borda === '2h') {
                            configurarBordasDuracao2(cell, tabela, rowIndex, colIndex);
                        }
                    }
                }
            } catch (error) {
                console.error("Execu√ß√£o interrompida devido a dados inv√°lidos:", error.message);
                return;
            }
        } 

        adicionarEventoClique(); 
    });
}




function bloquearDomingo() {
    const tabela = document.getElementById('tabelaCorpo');
    const diaDomingo = 7;

    for (let i = 0; i < tabela.rows.length; i++) {
        const horario = i + 6;
        const cell = tabela.rows[i].cells[diaDomingo];
        if (horario >= 12 && horario <= 23) {
            cell.style.backgroundColor = '#f2f2f2';
            cell.style.pointerEvents = 'none';
            cell.style.cursor = 'not-allowed';
        }
    }
    console.log('üö´ Domingo bloqueado');
}




function validarDiaReserva(jogadores) {
    console.log("Iniciando valida√ß√£o da reserva...");

    // Se algum jogador for "aula" , retorna true imediatamente
    if (jogadores.some(jogador => {
        let nome = jogador.toLowerCase();
        return nome.includes("aula");
    })) {
        console.log("Reserva identificada como 'aula'. Valida√ß√£o ignorada.");
        return true;
    }

    const duracao = document.getElementById('duracao').value;
    console.log("Dura√ß√£o selecionada:", duracao);

    const diaSelecionado = parseInt(document.getElementById('dia').value);
    const horaSelecionada = parseInt(document.getElementById('hora').value);
    console.log("Dia selecionado:", diaSelecionado, "Hora selecionada:", horaSelecionada);

    if (duracao === "3-piramide") {
        console.log("Modo Pir√¢mide detectado. Aplicando regras especiais.");
		
		// --- IN√çCIO DA NOVA VALIDA√á√ÉO DE DATAS DO TORNEIO ---
        if (!piramideInicioTorneio || !piramideFimTorneio) {
            alert("N√£o √© poss√≠vel agendar jogos da Pir√¢mide, pois as datas do torneio ainda n√£o foram configuradas.");
            return false;
        }

        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);
        const diaDaSemanaHoje = hoje.getDay() === 0 ? 7 : hoje.getDay();
        let diff = diaSelecionado - diaDaSemanaHoje;
        if (diff < 0) diff += 7;
        const dataDaReserva = new Date(hoje);
        dataDaReserva.setDate(hoje.getDate() + diff);

        const dataInicioObj = parseDateDDMMYYYY(piramideInicioTorneio);
        const dataFimObj = parseDateDDMMYYYY(piramideFimTorneio);

        if (!dataInicioObj || !dataFimObj) {
            alert("Erro nas datas do torneio da Pir√¢mide. Contate o administrador.");
            return false;
        }
        
        dataFimObj.setHours(23, 59, 59, 999); // Garante que o dia final seja inclu√≠do na verifica√ß√£o

        if (dataDaReserva < dataInicioObj) {
            alert(`O torneio da Pir√¢mide s√≥ come√ßa em ${piramideInicioTorneio.replace(/-/g, '/')}.`);
            return false;
        }

        if (dataDaReserva > dataFimObj) {
            alert(`O torneio da Pir√¢mide terminou em ${piramideFimTorneio.replace(/-/g, '/')}.`);
            return false;
        }
        // --- FIM DA NOVA VALIDA√á√ÉO DE DATAS DO TORNEIO --- 

        if (jogadores.length !== 2) {
            alert("Reservas da Pir√¢mide devem ter exatamente 2 jogadores.");
			limparCampos();
            return false;
        }
		
		const configPiramide = window.config?.Piramide; 
        if (!configPiramide || !configPiramide.ativa) {
            alert("Configura√ß√£o da Pir√¢mide n√£o foi encontrada ou est√° desativada. Atualize a p√°gina.");
            return false;
        }

        const quadraSelecionada = document.getElementById('quadra').value;
        let quadraConfig;
        let prefixoQuadra;

        if (quadraSelecionada.includes("1")) {
            quadraConfig = configPiramide["Quadra-1"];
            prefixoQuadra = "1-";
            if (!quadraConfig || !quadraConfig["Quadra-1-ativa"]) {
                alert("Quadra 1 - Coberta est√° interditada para jogos da Pir√¢mide.");
                return false;
            }
        } else if (quadraSelecionada.includes("2")) {
            quadraConfig = configPiramide["Quadra-2"];
            prefixoQuadra = "2-";
            if (!quadraConfig || !quadraConfig["Quadra-2-ativa"]) {
                alert("Quadra 2 - Aberta est√° interditada para jogos da Pir√¢mide.");
                return false;
            }
        } else if (quadraSelecionada.includes("3")) {
            quadraConfig = configPiramide["Quadra-3"];
            prefixoQuadra = "3-";
            if (!quadraConfig || !quadraConfig["Quadra-3-ativa"]) {
                alert("Quadra 3 - Coberta est√° interditada para jogos da Pir√¢mide.");
                return false; 
            }
        }

        if (!quadraConfig) {
            alert("Configura√ß√£o da quadra n√£o encontrada.");
            return false;
        }

        const diasSemana = [1, 2, 3, 4, 5];
        if (diasSemana.includes(diaSelecionado)) {
            if (!quadraConfig[prefixoQuadra + "DiasDeSemana"]) {
                alert(`Reservas para jogos da Pir√¢mide na ${quadraSelecionada} n√£o s√£o permitidas durante a semana.`);
                return false;
            }
            if (quadraConfig[prefixoQuadra + "DiasDeSemana-exceto-17-19"]) {
                const horaFim = horaSelecionada + 2;
                if (horaSelecionada < 19 && horaFim > 17) {
                    alert(`Reservas da Pir√¢mide na ${quadraSelecionada} s√£o proibidas de segunda a sexta entre 17:00 e 19:00 (hor√°rio exclusivo para todos os s√≥cios).`);
                    return false;
                }
            }
        }

        if (diaSelecionado === 6) {
            if (!quadraConfig[prefixoQuadra + "Sabado"]) {
                alert(`Reservas para jogos da Pir√¢mide na ${quadraSelecionada} n√£o s√£o permitidas aos s√°bados.`);
                return false;
            }
            if (quadraConfig[prefixoQuadra + "Sabado-exceto-7-12"] && horaSelecionada >= 7 && horaSelecionada < 12) {
                alert(`Reservas da Pir√¢mide na ${quadraSelecionada} s√£o proibidas aos s√°bados entre 07:00 e 12:00 (hor√°rio exclusivo para todos os s√≥cios).`);
                return false;
            }
        }

        if (diaSelecionado === 7) {
            if (!quadraConfig[prefixoQuadra + "Domingo"]) {
                alert(`Reservas para jogos da Pir√¢mide na ${quadraSelecionada} n√£o s√£o permitidas aos domingos.`);
                return false;
            }
            if (quadraConfig[prefixoQuadra + "Domingo-exceto-8-12"] && horaSelecionada >= 8 && horaSelecionada < 12) {
                alert(`Reservas da Pir√¢mide na ${quadraSelecionada} s√£o proibidas aos domingos entre 08:00 e 12:00 (hor√°rio exclusivo para todos os s√≥cios).`);
                return false;
            }
        }

        console.log("Todas as regras da Pir√¢mide foram validadas com sucesso.");
    } 
	
        console.log("Modo padr√£o detectado. Aplicando regras normais de reserva.");
	
	//alert('entrei na valida√ßao');
    
    const diasParaLimpar = window.DiasParaLimpar;
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);

    let maxDiasPermitidos;
    switch (diasParaLimpar) {
        case 1: maxDiasPermitidos = 5; break;
        case 2: maxDiasPermitidos = 4; break;
        case 3: maxDiasPermitidos = 3; break;
        case 4: maxDiasPermitidos = 2; break;
        case 5: maxDiasPermitidos = 1; break;
        case 6: maxDiasPermitidos = 0; break;
        default:
            alert("Erro: Configura√ß√£o inv√°lida de DiasParaLimpar.");
            return false;
    }

    const ultimoDiaPermitido = new Date(hoje);
    ultimoDiaPermitido.setDate(hoje.getDate() + maxDiasPermitidos);

    const diferencaDias = (diaSelecionado - hoje.getDay() + 7) % 7;
    const dataSelecionada = new Date(hoje);
    dataSelecionada.setDate(hoje.getDate() + diferencaDias);

    if (dataSelecionada > ultimoDiaPermitido || dataSelecionada < hoje) {
        alert(gerarMensagemErro(diasParaLimpar));
        return false;
    }

    return true;
}



async function validarSeTemReserva(jogadores) {
    console.log("Iniciando valida√ß√£o de reservas...");
	
	// Se algum jogador for "aula" , retorna true imediatamente
	if (jogadores.some(jogador => {
		let nome = jogador.toLowerCase();
		return nome === "aula";
	})) {
		console.log("Reserva marcada como 'aula'. Valida√ß√£o interrompida.");
		return true;
	}
	
		
    return new Promise((resolve) => {
        let conflito = false;
        let jogadoresComConflito = [];

        const reservasRef = database.ref("sistemas/reservas");
        reservasRef.once("value").then((snapshot) => {
            const reservas = snapshot.val() || {};
            //console.log("Reservas carregadas do banco de dados:", reservas);

            const agora = new Date();
            const diaSelecionado = parseInt(document.getElementById('dia').value, 10);
            const horaSelecionada = parseInt(document.getElementById('hora').value, 10);
            const duracaoSelecionada = parseInt(document.getElementById('duracao').value, 10);

            const novaReservaDataHoraInicio = new Date(agora);
            novaReservaDataHoraInicio.setDate(agora.getDate() + ((diaSelecionado + 7 - agora.getDay()) % 7));
            novaReservaDataHoraInicio.setHours(horaSelecionada, 0, 0, 0);
            
            const novaReservaDataHoraFim = new Date(novaReservaDataHoraInicio);
            novaReservaDataHoraFim.setHours(novaReservaDataHoraInicio.getHours() + duracaoSelecionada); 
            
            // Verificando reservas existentes
            for (const quadra in reservas) {
                //console.log("Verificando quadra:", quadra);
                for (const key in reservas[quadra]) {
                    const reserva = reservas[quadra][key];
                    //console.log("Verificando reserva existente:", reserva);

                    // --- IN√çCIO DA VALIDA√á√ÉO DE SEGURAN√áA (√öNICA ADI√á√ÉO) ---
                    if (typeof reserva.jogadores === 'undefined' || reserva.jogadores === null) {
                        const erroMsg = `‚ö†Ô∏è Erro de Dados Encontrado!\n\nExiste uma reserva antiga ou corrompida que impede a valida√ß√£o do seu agendamento.\n\nPor favor, envie esta informa√ß√£o para o administrador:\n\n- Quadra: ${quadra}\n- Chave do Problema: ${key}`;
                        alert(erroMsg);
                        conflito = true; // Usa a flag de conflito existente para parar o processo
                        break;           // Interrompe o loop interno
                    }
                    // --- FIM DA VALIDA√á√ÉO DE SEGURAN√áA ---

                    jogadores.forEach(jogador => {
					    if (jogador === "Convidado") {
							return;
						}
                        
                        const jogadoresNaReserva = reserva.jogadores.split(', ');
                        if (jogadoresNaReserva.includes(jogador)) {
                            const reservaDia = parseInt(reserva.dia, 10);
                            const reservaHora = parseInt(reserva.hora, 10);
                            const reservaDuracao = parseInt(reserva.duracao, 10) || 1;
                            const reservaDataHoraInicio = new Date(agora);
                            reservaDataHoraInicio.setDate(agora.getDate() + ((reservaDia + 7 - agora.getDay()) % 7));
                            reservaDataHoraInicio.setHours(reservaHora, 0, 0, 0);
                            
                            const reservaDataHoraFim = new Date(reservaDataHoraInicio);
                            reservaDataHoraFim.setHours(reservaDataHoraInicio.getHours() + reservaDuracao);
                            
                            if (reservaDataHoraInicio > agora) {
                                conflito = true;
                                if (!jogadoresComConflito.includes(jogador)) {
                                    jogadoresComConflito.push(jogador);
                                }
                            }

                            if (agora >= reservaDataHoraInicio && agora < reservaDataHoraFim) {
                                conflito = true;
                                if (!jogadoresComConflito.includes(jogador)) {
                                    jogadoresComConflito.push(jogador);
                                }
                            }
                        }
                    });
                }
                if (conflito) break; // Interrompe o loop externo se um conflito foi encontrado
            }

            // Se houver conflito, exibe mensagem de erro
            if (conflito) {
                // Se o conflito N√ÉO foi por dado corrompido, mas por jogador repetido, mostra a mensagem.
                if (jogadoresComConflito.length > 0) {
                     const mensagem = jogadoresComConflito.length > 1
                        ? `Os jogadores ${jogadoresComConflito.join(", ")} ainda t√™m uma reserva ativa e n√£o podem agendar outra antes de finaliz√°-la.`
                        : `O jogador ${jogadoresComConflito[0]} ainda tem uma reserva ativa e n√£o pode agendar outra antes de finaliz√°-la.`;
                     alert(mensagem);
                }
                // Em ambos os casos (dado corrompido ou jogador repetido), a valida√ß√£o falha.
                resolve(false);
            } else {
                resolve(true);
            }
        });
    });
}
function gerarMensagemErro(diasParaLimpar) {
    let diasAntecedencia;
    switch (diasParaLimpar) {
        case 1: diasAntecedencia = 5; break;
        case 2: diasAntecedencia = 4; break;
        case 3: diasAntecedencia = 3; break;
        case 4: diasAntecedencia = 2; break;
        case 5: diasAntecedencia = 1; break;
        case 6: return "S√≥ √© permitido fazer reservas para o dia atual.";
        default: return "Valor de DiasParaLimpar inv√°lido.";
    }
    limparCampos();
    return `N√£o √© permitido fazer reservas com mais de ${diasAntecedencia} dias de anteced√™ncia.`; 
}

window.atualizarOpcoesHorario = function() {
    const duracao = document.getElementById('duracao').value;
    const dia = document.getElementById('dia').value;
    const quadra = document.getElementById('quadra').value; // Pega a quadra selecionada
    const horaSelect = document.getElementById('hora');
    horaSelect.innerHTML = '';

    if (!duracao || !dia) return;

    // --- L√≥gica para buscar bloqueios do dia ---
    const quadraKey = `Quadra-${quadra.split(' ')[1]}`;
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    const diaDaSemanaHoje = hoje.getDay() === 0 ? 7 : hoje.getDay();
    let diff = dia - diaDaSemanaHoje;
    if (diff < 0) diff += 7;
    const dataDaReserva = new Date(hoje);
    dataDaReserva.setDate(hoje.getDate() + diff);
    const dataFormatada = `${dataDaReserva.getFullYear()}-${String(dataDaReserva.getMonth() + 1).padStart(2, '0')}-${String(dataDaReserva.getDate()).padStart(2, '0')}`;
    const bloqueioDoDia = bloqueiosQuadra[quadraKey]?.[dataFormatada];
    // --- Fim da l√≥gica ---

    const horarios = [];
    // Define os hor√°rios dispon√≠veis com base no dia da semana
    if (dia == 7) { // Domingo
        const limite = vDomingo === 'fechado' ? 12 : parseInt(vDomingoAte.split(':')[0]);
        for (let i = 8; i < limite; i++) horarios.push(i);
    } else if (dia == 6) { // S√°bado
        for (let i = 7; i < 21; i++) horarios.push(i);
    } else { // Dias de Semana
        for (let i = 6; i <= 22; i++) horarios.push(i);
    }

    // Filtra os hor√°rios com base nos bloqueios e na dura√ß√£o
    horarios.forEach(h => {
        let isBloqueado = false;
        if (bloqueioDoDia && bloqueioDoDia.regras) {
            const inicioBloqueio = parseInt(bloqueioDoDia.regras.inicio.split(':')[0]);
            const fimBloqueio = parseInt(bloqueioDoDia.regras.fim.split(':')[0]);
            
            // Verifica se o hor√°rio de in√≠cio ou qualquer parte da dura√ß√£o cai dentro do bloqueio
            for(let i = 0; i < parseInt(duracao === '3-piramide' ? 2 : duracao); i++) {
                if ((h + i) >= inicioBloqueio && (h + i) < fimBloqueio) {
                    isBloqueado = true;
                    break;
                }
            }
        }

        // Se n√£o estiver bloqueado, adiciona a op√ß√£o
        if (!isBloqueado) {
            const duracaoNum = parseInt(duracao === '3-piramide' ? 2 : duracao);
            // Garante que o hor√°rio final n√£o ultrapasse o limite do dia
            const limiteDia = (dia == 7) ? (vDomingo === 'fechado' ? 12 : parseInt(vDomingoAte.split(':')[0])) : (dia == 6 ? 21 : 23);
            if (h + duracaoNum <= limiteDia) {
                 const option = document.createElement('option');
                 option.value = h;
                 option.textContent = `${String(h).padStart(2, '0')}:00 - ${String(h + duracaoNum).padStart(2, '0')}:00`;
                 horaSelect.appendChild(option);
            }
        }
    });
};


window.adicionarJogador = function() {
    if (jogadorCount < 4) {
        jogadorCount++;
        const jogadoresContainer = document.getElementById('jogadoresContainer');

        const newDiv = document.createElement('div');
        newDiv.className = 'form-row';

        const label = document.createElement('label');
        label.setAttribute('for', `jogador${jogadorCount}`);
        label.textContent = 'Jogador:';

        const novoSelect = document.createElement('select');
        novoSelect.id = `jogador${jogadorCount}`;
        novoSelect.name = `jogador${jogadorCount}`;
        
        // 1. Copia as op√ß√µes do primeiro campo, que j√° est√° com a lista correta (seja a geral ou a da pir√¢mide)
        const primeiroSelect = document.getElementById('jogador1');
        if (primeiroSelect) {
            novoSelect.innerHTML = primeiroSelect.innerHTML;
        }

        // 2. Remove do novo campo a op√ß√£o que foi selecionada no campo anterior
        const selectAnterior = document.getElementById(`jogador${jogadorCount - 1}`);
        if (selectAnterior && selectAnterior.value && selectAnterior.value !== "Convidado") {
            const optionToRemove = novoSelect.querySelector(`option[value="${selectAnterior.value}"]`);
            if (optionToRemove) {
                optionToRemove.remove();
            }
        }
        
        newDiv.appendChild(label);
        newDiv.appendChild(novoSelect);
        jogadoresContainer.appendChild(newDiv);

        novoSelect.focus();
    }
};


// Fun√ß√£o original, apenas atualizada para usar transa√ß√µes Firebase
async function atualizarTabela() {
    let isErro = false;

    const jogadores = [];
    for (let i = 1; i <= jogadorCount; i++) {
        let jogadorSelect = document.getElementById(`jogador${i}`);
        if (jogadorSelect) {
            let apelido = jogadorSelect.value;
            if (apelido) {
                jogadores.push(apelido);
            }
        }
    }
	
	console.log("Jogadores selecionados:", jogadores);

    if (jogadores.length === 0) {
        alert('Selecione pelo menos 1 jogador.');
        return;
    }


    // Nova valida√ß√£o: verifica se o jogador logado est√° na reserva 
    const jogadorLogado = localStorage.getItem('jogadorLogado');
    const isAdmin = jogadorLogado === "RONALDO TABORDA";
    const isAula = jogadores.some(j => j.toLowerCase() === "aula");

    if (!isAdmin && !isAula) {
        const jogadorEstaNaReserva = jogadores.some(jogador => {
            const nomeCompletoJogador = jogadoresData[jogador]?.nomeCompleto || "";
            return nomeCompletoJogador.toLowerCase() === jogadorLogado.toLowerCase() ||
                jogador.toLowerCase() === jogadorLogado.toLowerCase();
        });

        if (!jogadorEstaNaReserva) {
            alert("Voc√™ n√£o pode fazer uma reserva sem constar nela. Por favor, inclua seu nome na lista de jogadores.");
            //limparCampos();
            return;
        }
    }

    // Verifica se a reserva cont√©m apenas "Convidado"
    const isApenasConvidado = jogadores.length === 1 && jogadores[0] === "Convidado";
    if (isApenasConvidado) {
        alert("Reservas n√£o podem conter apenas um Convidado. √â necess√°rio um s√≥cio acompanhando.");
        limparCampos();
        return;
    }

    const duracao = parseInt(document.getElementById('duracao').value);
	 if (duracao === 2 && (jogadores.length < 2 || jogadores.length > 4)) {
        alert('Reservas de 2 horas precisam ter no m√≠nimo 2 e no m√°ximo 4 jogadores.');
        return;
    }
	

    const quadra = document.getElementById('quadra').value;
	if (quadrasInativas.has(quadra)) {
        alert(`A ${quadra} est√° interditada provisoriamente.`);
        limparCampos();
        return;
    }
	
		
	
    const dia = parseInt(document.getElementById('dia').value, 10);
    const horaSelecionada = parseInt(document.getElementById('hora').value, 10);

    console.log("Dia selecionado:", dia, "Hora selecionada:", horaSelecionada, "Dura√ß√£o:", duracao);

    // SUBSTITUA O TRECHO ANTIGO DENTRO DE atualizarTabela POR ESTE:

	const isConvidado = jogadores.includes("Convidado");
	if (isConvidado) {
		// Agora, em vez de buscar no banco, usamos a vari√°vel global.
		const convidadoConfig = convidadoConfigGlobais;

		if (!convidadoConfig) {
			alert("Configura√ß√µes do convidado n√£o encontradas.");
			return;
		}

		// Verifica se todas as quadras est√£o desativadas OU todos os dias est√£o desativados
		if (
			(!convidadoConfig.Quadra1 && !convidadoConfig.Quadra2 && !convidadoConfig.Quadra3) || // Todas as quadras desativadas
			(!convidadoConfig.DiasDeSemana && !convidadoConfig.FimDeSemana) // Todos os dias desativados
		) {
			alert("Convidados n√£o podem jogar, pois todas as quadras ou todos os dias est√£o desativados para n√£o s√≥cios.");
			return;
		}

		// Verifica se a quadra selecionada √© permitida para o convidado
		const quadraPermitida = convidadoConfig[`Quadra${quadra.split(' ')[1]}`];
		if (!quadraPermitida) {
			// Monta a mensagem informando quais quadras s√£o permitidas
			const quadrasPermitidas = [];
			if (convidadoConfig.Quadra1) quadrasPermitidas.push("Quadra 1 - Coberta");
			if (convidadoConfig.Quadra2) quadrasPermitidas.push("Quadra 2 - Aberta");
			if (convidadoConfig.Quadra3) quadrasPermitidas.push("Quadra 3 - Coberta");

			const mensagemQuadras = quadrasPermitidas.length > 0
				? `Convidados s√≥ podem utilizar as seguintes quadras: ${quadrasPermitidas.join(", ")}.`
				: "Convidados n√£o podem utilizar nenhuma quadra.";
			limparCampos();
			alert(mensagemQuadras);
			return;
		}
		
		// Verifica os dias permitidos para o convidado
		const diaDaSemana = dia >= 1 && dia <= 5; // Segunda a sexta
		const fimDeSemana = dia === 6 || dia === 7; // S√°bado e domingo

		if (!convidadoConfig.DiasDeSemana && !convidadoConfig.FimDeSemana) {
			alert("Convidados n√£o podem fazer reservas em nenhum dia.");
			limparCampos();
			return;
		}

		if (!convidadoConfig.DiasDeSemana && diaDaSemana) {
			alert("Convidados s√≥ podem fazer reservas no fim de semana (s√°bado e domingo).");
			limparCampos();
			return;
		}

		if (!convidadoConfig.FimDeSemana && fimDeSemana) {
			alert("Convidados s√≥ podem fazer reservas durante a semana (segunda a sexta).");
			limparCampos();
			return;
		}
	}

    if (!validarDiaReserva(jogadores)) {
        console.log("Valida√ß√£o de dia falhou.");
        limparCampos();
        return;
    }

    console.log("Verificando se j√° existe uma reserva ativa...");
    const reservaValida = await validarSeTemReserva(jogadores);
    if (!reservaValida) {
        console.log("Valida√ß√£o de reserva falhou. Bloqueando agendamento.");
        limparCampos();
        return;
    }

    

    if (horaSelecionada < 6 || horaSelecionada > 22) {
        alert('Hor√°rio selecionado deve ser entre 6 e 22.');
        return;
    }
	
	
	// >>> VALIDA√áAO DE DUPLAS <<<
    //const quadra = document.getElementById('quadra').value;
    //const dia = parseInt(document.getElementById('dia').value, 10);
    //const horaSelecionada = parseInt(document.getElementById('hora').value, 10);
    
    //const isRegraDuplasOk = await validarRegraDeDuplas(jogadores, quadra, dia, horaSelecionada);
	// Linha nova (adicionando a vari√°vel 'duracao'):
	//const duracao = parseInt(document.getElementById('duracao').value); // Esta linha j√° deve existir um pouco mais acima no seu c√≥digo
	const isRegraDuplasOk = await validarRegraDeDuplas(jogadores, quadra, dia, horaSelecionada, duracao);
    if (!isRegraDuplasOk) {
        limparCampos(); // Limpa o formul√°rio se a valida√ß√£o falhar
        return; // Interrompe o processo de agendamento
    }
    // >>> FIM DO NOVO BLOCO DE DUPLAS <<<
	
	
	const reservasRef = database.ref(`sistemas/reservas/${quadra}`);
    console.log("üì¶ Refer√™ncia do Firebase:", `sistemas/reservas/${quadra}`);

    const key1 = `${dia}_${horaSelecionada}`;
    const key2 = `${dia}_${horaSelecionada + 1}`;
    console.log(`üîë Chave 1 (inicio da reserva): ${key1}`);
    console.log(`üîë Chave 2 (fim da reserva): ${key2}`);

    const tabela = document.getElementById('tabelaCorpo');
    const linhaInicial = horaSelecionada - 6;

    let corFundo = jogadores.some(jogador => jogador.toLowerCase().includes('aula'))
        ? 'lightcoral'
        : duracao === 1 ? 'lightgreen'
        : duracao === 2 ? 'lightblue'
        : duracao === 3 ? '#FFEB99'
        : 'white';

    console.log(`üéØ Dura√ß√£o selecionada: ${duracao}`);
    console.log("üë• Jogadores:", jogadores);

    // üîé Verifica√ß√£o manual de disponibilidade ANTES de iniciar grava√ß√£o
    await reservasRef.once('value', (snapshot) => {
        const reservas = snapshot.val() || {};
        let horariosLivres = true;
		
		
        const loopDuracao = duracao === 3 ? duracao - 1 : duracao;
        for (let i = 0; i < loopDuracao; i++) {
            const horarioChave = `${dia}_${horaSelecionada + i}`;
            if (reservas[horarioChave]) {
                horariosLivres = false;
                console.warn(`‚õî Hor√°rio ocupado detectado: ${horarioChave}`);
                break;
            }
        }

        if (!horariosLivres) {
            alert('Um ou mais hor√°rios j√° est√£o reservados para essa quadra!');
            limparCampos();
            //selecionarQuadra(quadra);
            isErro = true;
        }
    });

    if (isErro) return;
	
	console.log("Reserva liberada, prosseguir com o agendamento.");

    if (duracao === 1) {
        const reservaData = {
            jogadores: jogadores.join(', '),
            dia,
            hora: horaSelecionada,
            duracao,
            borda: '1h'
        };

        console.log("üì§ Dados a gravar (1h):", reservaData);

        reservasRef.child(key1).transaction(currentData => {
            if (currentData === null) {
                console.log("‚úÖ Hor√°rio livre. Gravando reserva 1h...");
                return reservaData;
            }
            console.warn("üö´ Hor√°rio ocupado. Reserva n√£o ser√° gravada.");
            alert("Hor√°rio j√° est√° reservado. Cancelando a reserva..");
            isErro = true;
            return;
        }, (error, committed) => {
            if (error || !committed) {
                console.error("‚ùå Erro ao salvar a reserva:", error);
                isErro = true;
            } else {
                console.log("‚úÖ Reserva 1h salva com sucesso!");
            }
        });

    } else if (duracao === 2 || duracao === 3) {
        console.log("üß© Reserva de dura√ß√£o longa (2h ou 3h)");

        if (jogadores.length === 1) {
            tabela.rows[linhaInicial].cells[dia].innerHTML = jogadores[0];
            tabela.rows[linhaInicial + 1].cells[dia].innerHTML = jogadores[0];
        } else {
            if (jogadores.length >= 1) tabela.rows[linhaInicial].cells[dia].innerHTML = jogadores[0];
            if (jogadores.length >= 2) tabela.rows[linhaInicial + 1].cells[dia].innerHTML = jogadores[1];
            if (jogadores.length >= 3) tabela.rows[linhaInicial].cells[dia].innerHTML += `, ${jogadores[2]}`;
            if (jogadores.length === 4) tabela.rows[linhaInicial + 1].cells[dia].innerHTML += `, ${jogadores[3]}`;
        }

        tabela.rows[linhaInicial].cells[dia].style.backgroundColor = corFundo;
        tabela.rows[linhaInicial + 1].cells[dia].style.backgroundColor = corFundo;
        tabela.rows[linhaInicial].cells[dia].style.border = '2px solid black';

        const reservaData1 = {
            jogadores: tabela.rows[linhaInicial].cells[dia].innerHTML,
            dia,
            hora: horaSelecionada,
            duracao,
            borda: '2h'
        };

        const reservaData2 = {
            jogadores: tabela.rows[linhaInicial + 1].cells[dia].innerHTML,
            dia,
            hora: horaSelecionada + 1
        };

        console.log("üì§ Dados parte 1 (linha de cima):", reservaData1);
        console.log("üì§ Dados parte 2 (linha de baixo):", reservaData2);

        reservasRef.child(key1).transaction(currentData => {
            if (currentData === null) {
                console.log("‚úÖ Parte 1 dispon√≠vel. Gravando...");
                return reservaData1;
            }
            console.warn("üö´ Parte 1 j√° est√° reservada.");
            alert("Hor√°rio j√° est√° reservado. Cancelando a reserva..");
            isErro = true;
            return;
        }, (error1, committed1) => {
            if (error1 || !committed1) {
                console.error("‚ùå Erro na grava√ß√£o da primeira parte:", error1);
                isErro = true;
            } else {
                console.log("‚úÖ Parte 1 salva. Prosseguindo com parte 2...");

                reservasRef.child(key2).transaction(currentData => {
                    if (currentData === null) {
                        console.log("‚úÖ Parte 2 dispon√≠vel. Gravando...");
                        return reservaData2;
                    }
                    console.warn("üö´ Parte 2 j√° est√° reservada.");
                    alert("Hor√°rio j√° est√° reservado. Cancelando a reserva.");
                    isErro = true;
                    return;
                }, async (error2, committed2) => {
                    if (error2 || !committed2) {
                        console.error("‚ùå Erro na grava√ß√£o da segunda parte:", error2);
                        console.log("üßπ Revertendo: removendo a parte 1 da reserva...");
                        await reservasRef.child(key1).remove();
                        isErro = true;
                    } else {
                        console.log("‚úÖ Reserva completa (2h) salva com sucesso!");
                    }
                });
            }
        });
    }

    setTimeout(() => {
        if (!isErro) {
            if (jogadores.includes("Convidado")) exibirMensagemConvidado();
            if (duracao === 3) exibirMensagemPiramide();
        } else {
            // alert("Ocorreu um erro ao salvar a reserva. Tente novamente.");
        }
        selecionarQuadra(quadra);
        limparCampos();
    }, 500);
}


// Fun√ß√£o para adicionar evento de clique nas c√©lulas
function adicionarEventoClique() {
    const tabela = document.getElementById('tabelaCorpo');

    for (let i = 0; i < tabela.rows.length; i++) {
        for (let j = 0; j < tabela.rows[i].cells.length; j++) {
            const celula = tabela.rows[i].cells[j];
			
			// --- IN√çCIO DA CORRE√á√ÉO ---
            // Se a c√©lula j√° tem um cursor de 'ajuda', significa que √© um bloqueio.
            // Nesse caso, n√£o fazemos nada e pulamos para a pr√≥xima c√©lula.
            if (celula.style.cursor === 'help') {
                continue;
            }
            // --- FIM DA CORRE√á√ÉO ---

            // Remove qualquer evento de clique anterior
            celula.onclick = null;

            // Ignora as c√©lulas das colunas 0 e 8 (que cont√™m os hor√°rios)
            if (j !== 0 && j !== 8) {
                celula.onclick = function () {
                    if (celula.innerHTML !== "") {
                        // Verifica se o conte√∫do da c√©lula √© "aula"
                        const mensagem = celula.innerHTML.trim().toLowerCase() === "aula"
                            ? "Voc√™ quer excluir esta aula?"
                            : "Voc√™ quer excluir esta reserva?";

                        const confirmacao = confirm(mensagem);
                        if (confirmacao) {
                            excluirReserva(i, j); // Passa a posi√ß√£o da c√©lula
                        }
                    }
                };
            }
        }
    }
}



function capitalizarNome(nome) {
    if (!nome) return ""; // Retorno seguro para strings vazias ou nulas

    return nome.split(' ')
               .map(palavra => palavra.charAt(0).toUpperCase() + palavra.slice(1))
               .join(' ');
}

// Vari√°vel global para rastrear c√©lulas j√° exclu√≠das
const celulasExcluidas = new Set();

function excluirReserva(horaIndex, diaIndex) {
    console.log("üîπ Iniciando processo de exclus√£o...");
    
    try {
        // Verifica√ß√£o do usu√°rio logado
        const jogadorLogado = localStorage.getItem('jogadorLogado');
        console.log("üîπ Jogador logado:", jogadorLogado);

        if (!jogadorLogado) {
            console.error("‚õî Erro ao identificar o jogador logado.");
            alert("‚ö†Ô∏è Aten√ß√£o:\n\nN√£o conseguimos identificar o jogador logado!\nPor favor, fa√ßa o login novamente.");
            return;
        }

        // Obten√ß√£o segura dos elementos da tabela
        const tabela = document.getElementById('tabelaCorpo');
        if (!tabela) {
            throw new Error("Tabela n√£o encontrada");
        }

        const celulaId = `${horaIndex}_${diaIndex}`; 
        console.log("üîπ C√©lula alvo:", celulaId);

        // Verifica√ß√£o de duplica√ß√£o de exclus√£o
        if (celulasExcluidas.has(celulaId)) {
            console.log("‚ö†Ô∏è C√©lula j√° foi exclu√≠da anteriormente.");
            return;
        }

        const quadraAtual = quadraSelecionada;
        console.log("üîπ Quadra atual:", quadraAtual);

        // Obten√ß√£o segura da c√©lula
        const primeiraCelula = tabela.rows[horaIndex]?.cells[diaIndex];
        if (!primeiraCelula) {
            console.log("‚ö†Ô∏è C√©lula inv√°lida ou inexistente.");
            return;
        }

        // Obten√ß√£o da dura√ß√£o e jogadores
        const duracao = primeiraCelula.getAttribute('data-duracao') || "1";
        console.log("üîπ Dura√ß√£o da reserva:", duracao);
        
        let jogadoresArray = primeiraCelula.textContent.trim().split(',')
            .map(j => j.replace(/^\d+\s*-\s*/, '').trim().toLowerCase())
            .filter(j => j); // Remove entradas vazias

        // Tratamento para reservas de longa dura√ß√£o
        if (duracao === "2" || duracao === "3") {
            const segundaCelula = tabela.rows[horaIndex + 1]?.cells[diaIndex];
            if (segundaCelula) {
                const jogadoresSegundaCelula = segundaCelula.textContent.trim().split(',')
                    .map(j => j.replace(/^\d+\s*-\s*/, '').trim().toLowerCase())
                    .filter(j => j);
                //jogadoresArray = [...new Set([...jogadoresArray, ...jogadoresSegundaCelula])];
				jogadoresArray = [...jogadoresArray, ...jogadoresSegundaCelula];
            }
        }

        console.log("üîπ Jogadores na reserva:", jogadoresArray);

        // Verifica√ß√£o de permiss√µes
        const apelidoJogadorLogado = Object.keys(jogadoresData).find(
            apelido => jogadoresData[apelido].nomeCompleto.toLowerCase() === jogadorLogado.toLowerCase()
        ) || jogadorLogado;

        const tipoReserva = primeiraCelula.textContent.trim().toLowerCase();
        console.log("üîπ Tipo de reserva identificado:", tipoReserva);

        if (tipoReserva.includes("aula")) {
            if (jogadorLogado !== "RILDO SANTOS" && jogadorLogado !== "RONALDO TABORDA") {
                alert("‚õî Aten√ß√£o:\n\nApenas o professor RILDO SANTOS ou o Administrador podem excluir reservas do tipo 'aula'.");
                console.log("‚õî Permiss√£o negada: apenas RILDO SANTOS ou RONALDO TABORDA podem excluir 'aula'.");
                return;
            }
        } else {
            if (jogadorLogado !== "RONALDO TABORDA" && !jogadoresArray.includes(apelidoJogadorLogado.toLowerCase())) {
                alert("‚õî Aten√ß√£o:\n\nApenas jogadores da reserva podem exclu√≠-la!\nVoc√™ n√£o tem permiss√£o para excluir esta reserva.");
                console.log("‚õî Jogador n√£o tem permiss√£o para excluir esta reserva.");
                return;
            }
        }

        console.log("‚úÖ Permiss√£o concedida para excluir a reserva.");

        // CORRE√á√ÉO: Pegar a data correta da tabela
        const tabelaPrincipal = document.getElementById('tabelaQuadra');
        let dataReserva = 'data-desconhecida';
        
        if (tabelaPrincipal && tabelaPrincipal.rows[1]) {
            // A linha 1 cont√©m as datas (Segunda=col1, Ter√ßa=col2, etc.)
            const linhaDatas = tabelaPrincipal.rows[1];
            const dataTabela = linhaDatas.cells[diaIndex-1]?.textContent.trim();
            
            if (dataTabela) {
                console.log("üîπ Data bruta da tabela:", dataTabela);
                const partes = dataTabela.split('/');
                if (partes.length === 3) {
                    const dia = partes[0].padStart(2, '0');
                    const mes = partes[1].padStart(2, '0');
                    const ano = partes[2].length === 2 ? `20${partes[2]}` : partes[2];
                    dataReserva = `${dia}-${mes}-${ano}`;
                    console.log("‚úÖ Data formatada corretamente:", dataReserva);
                }
            }
        }

        // Processo de exclus√£o
        if (duracao === "2" || duracao === "3") {
            console.log("üîπ Exclus√£o de reserva de 2h ou 3h.");
            const segundaCelula = tabela.rows[horaIndex + 1]?.cells[diaIndex];

            requestAnimationFrame(() => {
                limparCelula(primeiraCelula);
                if (segundaCelula) limparCelula(segundaCelula);
            });

            if (primeiraCelula.rowSpan === 2) {
                primeiraCelula.rowSpan = 1;
                if (segundaCelula) segundaCelula.style.display = '';
            }

            excluirReservaFirebase(horaIndex + 6, diaIndex, quadraAtual);
            excluirReservaFirebase(horaIndex + 7, diaIndex, quadraAtual);
        } 
        else if (duracao === "1") {
            console.log("üîπ Exclus√£o de reserva de 1h.");
            requestAnimationFrame(() => {
                limparCelula(primeiraCelula);
            });
            excluirReservaFirebase(horaIndex + 6, diaIndex, quadraAtual);
        } 
        else {
            console.log("‚ö†Ô∏è Dura√ß√£o inv√°lida, n√£o ser√° exclu√≠do.");
            return;
        }

        // Obter o hor√°rio inicial corretamente
const horarioTexto = tabela.rows[horaIndex]?.querySelector('.horario')?.textContent.trim();
const horaInicial = parseInt(horarioTexto.split(':')[0], 10); // Extrai a hora corretamente

// Garantir que a dura√ß√£o seja num√©rica e aplicar a l√≥gica correta
const duracaoNumerica = parseInt(duracao, 10);
const horasParaAdicionar = duracaoNumerica >= 2 ? 2 : 1; // Se for 2 ou mais, adiciona 2 horas; se for 1, adiciona 1 hora

// Calcular o hor√°rio final corretamente
const horaFinal = horaInicial + horasParaAdicionar;

// Formatar corretamente o hor√°rio
const horarioFormatado = `${horaInicial.toString().padStart(2, '0')}:00 - ${horaFinal.toString().padStart(2, '0')}:00`;

// Registrar a exclus√£o com a data correta
registrarExclusao(
    quadraAtual,
    horarioFormatado,
    jogadoresArray.map(capitalizarNome), // Usando a fun√ß√£o correta aqui
	jogadorLogado,
    duracaoNumerica, // Garantindo que a dura√ß√£o √© num√©rica
    dataReserva
);


        celulasExcluidas.add(celulaId);
        console.log("‚úÖ Reserva exclu√≠da com sucesso.");
        carregarReservas(quadraAtual);

    } catch (error) {
        console.error("‚ùå Erro fatal durante a exclus√£o:", error);
        alert("‚ö†Ô∏è Ocorreu um erro inesperado durante a exclus√£o. Por favor, tente novamente.");
    }
}


// Fun√ß√£o para limpar o conte√∫do da c√©lula
function limparCelula(celula) {
    if (celula) {
        celula.innerHTML = ""; // Limpa o conte√∫do da c√©lula
        celula.style.backgroundColor = ""; // Restaura a cor de fundo
        celula.style.border = "1px solid #ddd"; // Restaura a borda padr√£o
        celula.removeAttribute('data-duracao'); // Remove o atributo de dura√ß√£o

        // Remover rowSpan apenas se a reserva for de 2 horas e tiver apenas um jogador
        if (celula.rowSpan === 2) {
            celula.rowSpan = 1; // Restaura o rowSpan para o padr√£o
        }
    }
}

const reservasExcluidasFirebase = new Set();

function excluirReservaFirebase(horaSelecionada, diaIndex, quadra) {
    const key = `${diaIndex}_${horaSelecionada}`;

    if (!reservasExcluidasFirebase.has(key)) {
        reservasExcluidasFirebase.add(key);
        database.ref(`sistemas/reservas/${quadra}/${key}`).remove()
            .then(() => {
                reservasExcluidasFirebase.delete(key);
            })
            .catch((error) => console.error(`Erro ao remover a reserva do Firebase: ${error}`));
    }
}

function limparCampos() {
    // N√£o reseta o campo "Jogador 1" e mant√©m o seu valor
    const jogadoresContainer = document.getElementById('jogadoresContainer');
    while (jogadoresContainer.children.length > 1) {
        jogadoresContainer.removeChild(jogadoresContainer.lastChild); // Remove apenas os campos de jogador adicionais
    }
    jogadorCount = 1; // Reseta o contador de jogadores para 1
    document.getElementById('dataForm').reset(); // Reseta o formul√°rio
    document.getElementById('jogador1').value = ''; // Mant√©m o campo "Jogador 1"
    document.getElementById('duracao').value = '1'; // Reseta a dura√ß√£o para 1 hora
    atualizarOpcoesHorario(); // Atualiza as op√ß√µes de hor√°rio
	
}

// Monitora as altera√ß√µes no Firebase
const reservasRef = database.ref('sistemas/reservas/' + quadraSelecionada);
reservasRef.off('value'); // Remove ouvintes anteriores

reservasRef.on('value', (snapshot) => {
    const reservas = snapshot.val();

    limparTabela(); // Limpa toda a tabela antes de preencher com dados atualizados

    if (reservas) {
        for (const key in reservas) {
            const { jogadores, dia, hora, duracao, borda } = reservas[key];
            const rowIndex = hora - 6;

            // Atualiza a c√©lula com os jogadores recuperados do Firebase
            document.getElementById('tabelaCorpo').rows[rowIndex].cells[dia].innerHTML = jogadores;

            // Aplica a cor de fundo com base na reserva
            let corFundo;
            if (jogadores.toLowerCase().includes('aula')) {
                corFundo = 'lightcoral';
            } else {
                corFundo = duracao === 1 ? 'lightgreen' : 'lightblue';
            }

            const cell = document.getElementById('tabelaCorpo').rows[rowIndex]?.cells[dia];
            if (cell) {
                cell.style.backgroundColor = corFundo;
            }

            // Aplica bordas dependendo da dura√ß√£o da reserva
            if (borda === '1h') {
                document.getElementById('tabelaCorpo').rows[rowIndex].cells[dia].style.border = '2px solid black';
            } else if (borda === '2h') {
                document.getElementById('tabelaCorpo').rows[rowIndex].cells[dia].style.borderTop = '2px solid black';
                document.getElementById('tabelaCorpo').rows[rowIndex].cells[dia].style.borderLeft = '2px solid black';
                document.getElementById('tabelaCorpo').rows[rowIndex].cells[dia].style.borderRight = '2px solid black';
                document.getElementById('tabelaCorpo').rows[rowIndex].cells[dia].style.borderBottom = 'none';

                document.getElementById('tabelaCorpo').rows[rowIndex + 1].cells[dia].style.borderTop = 'none';
                document.getElementById('tabelaCorpo').rows[rowIndex + 1].cells[dia].style.borderLeft = '2px solid black';
                document.getElementById('tabelaCorpo').rows[rowIndex + 1].cells[dia].style.borderRight = '2px solid black';
                document.getElementById('tabelaCorpo').rows[rowIndex + 1].cells[dia].style.borderBottom = '2px solid black';
            }
        }

        // Ap√≥s recuperar as reservas, adicionar eventos de clique nas c√©lulas
        adicionarEventoClique();
    }
});

function atualizarDatas() {
  const dataInicio = new Date();
  
  let diaDaSemana = dataInicio.getDay(); 
  const dias = document.querySelectorAll("th");
  //let vAtualizarDatas = 1; 

  const linhaDatas = dias[0].parentNode.nextElementSibling;

  try {
    if (!vLimparDiasAnteriores) { 
            LimparDiasAnteriores();
            vLimparDiasAnteriores = true; // Define como falso ap√≥s a primeira execu√ß√£o
    }
  } catch (error){
        console.error("Erro ao limpar dias anteriores:", error);
    }


  
  //alert(`dia da semana: ${diaDaSemana}`);
  
  switch (DiasParaLimpar) {
  //switch (vAtualizarDatas) {
    case 1: 
      switch (diaDaSemana) {
        case 0: preencherCeldas(dataInicio, [1, 2, 3, 4, 5, -1, 0], linhaDatas); break;
        case 1: preencherCeldas(dataInicio, [0, 1, 2, 3, 4, 5, -1], linhaDatas); break;
        case 2: preencherCeldas(dataInicio, [-1, 0, 1, 2, 3, 4, 5], linhaDatas); break;
        case 3: preencherCeldas(dataInicio, [5, -1, 0, 1, 2, 3, 4], linhaDatas); break;
        case 4: preencherCeldas(dataInicio, [4, 5, -1, 0, 1, 2, 3], linhaDatas); break;
        case 5: preencherCeldas(dataInicio, [3, 4, 5, -1, 0, 1, 2], linhaDatas); break;
        case 6: preencherCeldas(dataInicio, [2, 3, 4, 5, -1, 0, 1], linhaDatas); break;
      }
      break;
    case 2:
      switch (diaDaSemana) {
        case 0: preencherCeldas(dataInicio, [1, 2, 3, 4, -2, -1, 0], linhaDatas); break;
        case 1: preencherCeldas(dataInicio, [0, 1, 2, 3, 4, -2, -1], linhaDatas); break;
        case 2: preencherCeldas(dataInicio, [-1, 0, 1, 2, 3, 4, -2], linhaDatas); break;
        case 3: preencherCeldas(dataInicio, [-2, -1, 0, 1, 2, 3, 4], linhaDatas); break;
        case 4: preencherCeldas(dataInicio, [4, -2, -1, 0, 1, 2, 3], linhaDatas); break;
        case 5: preencherCeldas(dataInicio, [3, 4, -2, -1, 0, 1, 2], linhaDatas); break;
        case 6: preencherCeldas(dataInicio, [2, 3, 4, -2, -1, 0, 1], linhaDatas); break;
      }
      break;
    case 3:
      switch (diaDaSemana) {
        case 0: preencherCeldas(dataInicio, [1, 2, 3, -3, -2, -1, 0], linhaDatas); break;
        case 1: preencherCeldas(dataInicio, [0, 1, 2, 3, -3, -2, -1], linhaDatas); break;
        case 2: preencherCeldas(dataInicio, [-1, 0, 1, 2, 3, -3, -2], linhaDatas); break;
        case 3: preencherCeldas(dataInicio, [-2, -1, 0, 1, 2, 3, -3], linhaDatas); break;
        case 4: preencherCeldas(dataInicio, [-3, -2, -1, 0, 1, 2, 3], linhaDatas); break;
        case 5: preencherCeldas(dataInicio, [3, -3, -2, -1, 0, 1, 2], linhaDatas); break;
        case 6: preencherCeldas(dataInicio, [2, 3, -3, -2, -1, 0, 1], linhaDatas); break;
      }
      break;
    case 4:
      switch (diaDaSemana) {
        case 0: preencherCeldas(dataInicio, [1, 2, -4, -3, -2, -1, 0], linhaDatas); break;
        case 1: preencherCeldas(dataInicio, [0, 1, 2, -4, -3, -2, -1], linhaDatas); break;
        case 2: preencherCeldas(dataInicio, [-1, 0, 1, 2, -4, -3, -2], linhaDatas); break;
        case 3: preencherCeldas(dataInicio, [-2, -1, 0, 1, 2, -4, -3], linhaDatas); break;
        case 4: preencherCeldas(dataInicio, [-3, -2, -1, 0, 1, 2, -4], linhaDatas); break;
        case 5: preencherCeldas(dataInicio, [-4, -3, -2, -1, 0, 1, 2], linhaDatas); break;
        case 6: preencherCeldas(dataInicio, [2, -4, -3, -2, -1, 0, 1], linhaDatas); break;
      }
      break;
    case 5:
      switch (diaDaSemana) {
        case 0: preencherCeldas(dataInicio, [1, -5, -4, -3, -2, -1, 0], linhaDatas); break;
        case 1: preencherCeldas(dataInicio, [0, 1, -5, -4, -3, -2, -1], linhaDatas); break;
        case 2: preencherCeldas(dataInicio, [-1, 0, 1, -5, -4, -3, -2], linhaDatas); break;
        case 3: preencherCeldas(dataInicio, [-2, -1, 0, 1, -5, -4, -3], linhaDatas); break;
        case 4: preencherCeldas(dataInicio, [-3, -2, -1, 0, 1, -5, -4], linhaDatas); break;
        case 5: preencherCeldas(dataInicio, [-4, -3, -2, -1, 0, 1, -5], linhaDatas); break;
        case 6: preencherCeldas(dataInicio, [-5, -4, -3, -2, -1, 0, 1], linhaDatas); break;
      }
      break;
    case 6:
      switch (diaDaSemana) {
        case 0: preencherCeldas(dataInicio, [-6, -5, -4, -3, -2, -1, 0], linhaDatas); break;
        case 1: preencherCeldas(dataInicio, [0, -6, -5, -4, -3, -2, -1], linhaDatas); break;
        case 2: preencherCeldas(dataInicio, [-1, 0, -6, -5, -4, -3, -2], linhaDatas); break;
        case 3: preencherCeldas(dataInicio, [-2, -1, 0, -6, -5, -4, -3], linhaDatas); break;
        case 4: preencherCeldas(dataInicio, [-3, -2, -1, 0, -6, -5, -4], linhaDatas); break;
        case 5: preencherCeldas(dataInicio, [-4, -3, -2, -1, 0, -6, -5], linhaDatas); break;
        case 6: preencherCeldas(dataInicio, [-5, -4, -3, -2, -1, 0, -6], linhaDatas); break;
      }
      break;
	  case 7:
      switch (diaDaSemana) {
        case 0: preencherCeldas(dataInicio, [-6, -5, -4, -3, -2, -1, 0], linhaDatas); break;
        case 1: preencherCeldas(dataInicio, [0, -6, -5, -4, -3, -2, -1], linhaDatas); break;
        case 2: preencherCeldas(dataInicio, [-1, 0, -6, -5, -4, -3, -2], linhaDatas); break;
        case 3: preencherCeldas(dataInicio, [-2, -1, 0, -6, -5, -4, -3], linhaDatas); break;
        case 4: preencherCeldas(dataInicio, [-3, -2, -1, 0, -6, -5, -4], linhaDatas); break;
        case 5: preencherCeldas(dataInicio, [-4, -3, -2, -1, 0, -6, -5], linhaDatas); break;
        case 6: preencherCeldas(dataInicio, [-5, -4, -3, -2, -1, 0, -6], linhaDatas); break;
      }
      break;
  }
  
}

function preencherCeldas(dataInicio, ajustes, linhaDatas) {
  for (let i = 0; i < ajustes.length; i++) {
    let novaData = new Date(dataInicio);
    novaData.setDate(dataInicio.getDate() + ajustes[i]);

    linhaDatas.children[i].innerHTML = novaData.toLocaleDateString('pt-BR');
  }
}


async function LimparDiasAnteriores() {
    console.log("üü¢ Iniciando LimparDiasAnteriores...");
    const reservasParaExcluir = []; // Array para armazenar logs
    let operacaoSucesso = true;

    try {
        const dataAtual = new Date();
        dataAtual.setHours(0, 0, 0, 0);
        const quadras = ["Quadra 1 - Coberta", "Quadra 2 - Aberta", "Quadra 3 - Coberta"];

        // Coletar todas as reservas primeiro
        for (const quadra of quadras) {
            console.log(`\nüèüÔ∏è Verificando quadra: ${quadra}`);

            for (let dia = 1; dia <= DiasParaLimpar; dia++) {
                const dataParaLimpar = new Date(dataAtual);
                dataParaLimpar.setDate(dataAtual.getDate() - dia);
                const diaIndex = dataParaLimpar.getDay() || 7;

                console.log(`üìÖ Verificando Dia ${diaIndex} (Data: ${dataParaLimpar.toLocaleDateString()})`);

                for (let hora = 6; hora <= 22; hora++) {
                    const horaIndex = hora - 6;
                    const key = `${diaIndex}_${hora}`;

                    // Pular hor√°rios bloqueados
                    if ((diaIndex === 6 && hora === 6) || 
                        (diaIndex === 7 && hora >= 6 && hora < 8) || 
                        (diaIndex === 6 && hora >= 21 && hora <= 23)) {
                        continue; 
                    }

                    const reservaRef = database.ref(`sistemas/reservas/${quadra}/${key}`);
                    const snapshot = await reservaRef.once('value');
                    const reserva = snapshot.val();

                    if (reserva && !reserva.jogadores?.toLowerCase().includes('aula')) {
                        // Formatar dados para o log
                        let { jogadores, duracao } = reserva;
                        
                        // Para reservas de 2h/3h, buscar jogadores da segunda hora
                        if (duracao === 2 || duracao === 3) {
                            const segundaHoraRef = database.ref(`sistemas/reservas/${quadra}/${diaIndex}_${hora + 1}`);
                            const segundaSnapshot = await segundaHoraRef.once('value');
                            const segundaReserva = segundaSnapshot.val();
                            if (segundaReserva?.jogadores) {
                                jogadores = `${jogadores}, ${segundaReserva.jogadores}`;
                            }
                        }

                        /*const jogadoresArray = [...new Set( // Remover duplicados
                            jogadores.split(',')
                                .map(j => j.trim())
                                .filter(j => j.length > 0)
                        )];*/
						const jogadoresArray = [
							...jogadores.split(',')
								.map(j => j.trim())
								.filter(j => j.length > 0)
						];

                        const dataReserva = dataParaLimpar.toLocaleDateString('pt-BR').split('/');
                        const dataFormatada = `${dataReserva[0].padStart(2, '0')}-${dataReserva[1].padStart(2, '0')}-${dataReserva[2]}`;
                        
                        const horasParaAdicionar = duracao === 3 ? 2 : duracao;
                        const horarioFormatado = `${hora.toString().padStart(2, '0')}:00 - ${(hora + horasParaAdicionar).toString().padStart(2, '0')}:00`;

                        // Adicionar ao array de logs
                        reservasParaExcluir.push({
                            exclusao: new Date().toLocaleString('pt-BR', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            }).replace(',', ''),
                            quadra,
                            data: dataFormatada,
                            horario: horarioFormatado,
                            duracao: duracao === 3 ? "2 Horas - Pir√¢mide" : duracao === 2 ? "2 Horas" : "1 Hora",
                            jogadores: jogadoresArray, 
                            usuario: "SISTEMA"
                        });

                        // Remover reserva
                        await reservaRef.remove();
                        console.log(`‚úÖ Reserva removida: ${key}`);

                        // Remover segunda hora se for reserva de 2h/3h
                        if (duracao === 2 || duracao === 3) {
                            await database.ref(`sistemas/reservas/${quadra}/${diaIndex}_${hora + 1}`).remove();
                            console.log(`‚úÖ Reserva removida: ${diaIndex}_${hora + 1}`);
                        }
                    }
                }
            }
        }

        // Registrar logs
        if (reservasParaExcluir.length > 0) {
            await registrarExclusao(reservasParaExcluir);
            console.log(`üìä Total de reservas removidas: ${reservasParaExcluir.length}`);
        } else {
            console.log("‚ÑπÔ∏è Nenhuma reserva antiga para remover");
        }

    } catch (erro) {
        console.error(`‚ö†Ô∏è ERRO na fun√ß√£o LimparDiasAnteriores: ${erro.message}`);
        operacaoSucesso = false;
        
        // Tenta registrar os logs mesmo em caso de erro
        if (reservasParaExcluir.length > 0) {
            try {
                await registrarExclusao(reservasParaExcluir);
                console.log(`üìä Logs parciais registrados (${reservasParaExcluir.length} reservas)`);
            } catch (erroLog) {
                console.error(`‚ö†Ô∏è ERRO ao registrar logs: ${erroLog.message}`);
            }
        }
    } finally {
        console.log(operacaoSucesso ? "‚úÖ Opera√ß√£o conclu√≠da" : "‚ö†Ô∏è Opera√ß√£o conclu√≠da com erros");
    }
}


// As vari√°veis globais permanecem as mesmas
let jogadoresData = {};
let jogadoresListener = null;

// As vari√°veis globais e a fun√ß√£o encontrarLinha permanecem as mesmas.

function carregarJogadores() {
    return new Promise((resolve, reject) => {
        console.log("üîÑ Carregando jogadores...");
        const jogadoresRef = database.ref("sistemas/cadastro/jogadores");
        const duracaoSelect = document.getElementById('duracao');
        const jogadorLogadoNome = localStorage.getItem('jogadorLogado');

        if (jogadoresListener) {
            jogadoresRef.off('value', jogadoresListener);
        }

        jogadoresListener = jogadoresRef.on('value', (snapshot) => {
            const todosJogadores = snapshot.val();
            if (!todosJogadores) {
                console.error("Nenhum jogador encontrado no banco de dados.");
                resolve(); 
                return;
            }

            jogadoresData = {};
            Object.keys(todosJogadores).forEach((nome) => {
                const jogador = todosJogadores[nome];
                jogadoresData[jogador.apelido] = {
                    nomeCompleto: nome,
                    piramide: jogador.piramide || "0"
                };
            });

            let jogadoresParaExibir = { ...todosJogadores };
            const duracao = duracaoSelect ? duracaoSelect.value : "";

            if (duracao === "3-piramide") {
                console.log("üêç Modo Pir√¢mide ativado. Filtrando lista de oponentes...");
                const jogadorLogadoApelido = Object.keys(jogadoresData).find(
                    apelido => jogadoresData[apelido].nomeCompleto === jogadorLogadoNome
                );
                const jogadorLogadoInfo = jogadorLogadoApelido ? jogadoresData[jogadorLogadoApelido] : null;

                if (!jogadorLogadoInfo || !jogadorLogadoInfo.piramide || jogadorLogadoInfo.piramide === "0") {
                    alert("Voc√™ n√£o participa da Pir√¢mide, portanto n√£o pode agendar jogos.");
                    jogadoresParaExibir = {};
                } else {
                    const posLogado = parseInt(jogadorLogadoInfo.piramide, 10);
                    let oponentesValidos = {};

                    // Filtro para Pir√¢mide Feminina (Posi√ß√£o >= 61) - L√ìGICA ORIGINAL MANTIDA
                    if (posLogado >= 61) {
                        Object.keys(todosJogadores).forEach(nome => {
                            const oponente = todosJogadores[nome];
                            if (parseInt(oponente.piramide, 10) >= 61) {
                                oponentesValidos[nome] = oponente;
                            }
                        });
                    } 
                    // --- IN√çCIO DA NOVA L√ìGICA (SUBSTITUI√á√ÉO) ---
                    // Filtro para Pir√¢mide Masculina (Posi√ß√£o 1-60) com a "Regra de Desafio Ascendente"
                    else {
                        console.log("üêç Pir√¢mide Masculina: Aplicando nova 'Regra de Desafio Ascendente'.");
                        const nomeCompletoLogado = jogadoresData[jogadorLogadoApelido].nomeCompleto;

                        Object.keys(todosJogadores).forEach(nomeOponente => {
                            const oponente = todosJogadores[nomeOponente];
                            const posOponente = parseInt(oponente.piramide, 10);

                            // Ignora oponentes inv√°lidos, da pir√¢mide feminina, ou o pr√≥prio jogador
                            if (!posOponente || posOponente > 60 || posOponente === posLogado) {
                                return;
                            }

                            // CONDI√á√ÉO 1: O jogador logado pode desafiar o oponente? (Desafio para cima)
                            const limiteLogado = encontrarLinha(posLogado);
                            const euPossoDesafiar = (posLogado - limiteLogado) <= posOponente && posOponente < posLogado;

                            // CONDI√á√ÉO 2: O oponente pode desafiar o jogador logado? (Desafio vindo de baixo)
                            const limiteOponente = encontrarLinha(posOponente);
                            const oponentePodeMeDesafiar = (posOponente - limiteOponente) <= posLogado && posLogado < posOponente;

                            // Se qualquer uma das condi√ß√µes for verdadeira, a "conex√£o" √© v√°lida
                            if (euPossoDesafiar || oponentePodeMeDesafiar) {
                                oponentesValidos[nomeOponente] = oponente;
                            }
                        });
                        
                        // Adiciona o pr√≥prio jogador logado √† lista para que ele apare√ßa no dropdown
                        if (todosJogadores[nomeCompletoLogado]) {
                            oponentesValidos[nomeCompletoLogado] = todosJogadores[nomeCompletoLogado];
                        }
                    }
                    // --- FIM DA NOVA L√ìGICA (SUBSTITUI√á√ÉO) ---
                    jogadoresParaExibir = oponentesValidos;
                }
            }
            
            const selectsParaPreencher = [];
            document.querySelectorAll('select[id^="jogador"]').forEach(select => {
                selectsParaPreencher.push(select); 
            });
            if (!jogadorLogadoNome) {
                const selectLogin = document.getElementById("jogadorSelect");
                if (selectLogin) selectsParaPreencher.push(selectLogin);
            }
            
            selectsParaPreencher.forEach(select => {
                const valorJaSelecionado = select.value;
                select.innerHTML = '<option value="">Selecione um jogador</option>';
                Object.keys(jogadoresParaExibir).forEach((nome) => {
                    const jogador = jogadoresParaExibir[nome];
                    const option = document.createElement('option');
                    option.value = jogador.apelido;
                    option.textContent = nome;
                    select.appendChild(option);
                });
                if (select.querySelector(`option[value='${valorJaSelecionado}']`)) {
                    select.value = valorJaSelecionado;
                }
            });
            
            resolve();

        }, (error) => {
            console.error("Erro ao carregar jogadores do Firebase:", error);
            reject(error);
        });
    });
}



// Chame a fun√ß√£o para carregar os jogadores ao carregar a p√°gina
window.onload = function () {
    console.log("‚úÖ P√°gina carregada - Chamando verificarVersao()");
    verificarVersao();
	
	removerSessoesAntigas();

    let jogadorLogado = localStorage.getItem('jogadorLogado');
    let loginScreen = document.getElementById('loginScreen');
    let contentElement = document.getElementById('content');
    let loadingElement = document.getElementById('loading');

    console.log("üîÑ Chamando carregarJogadores()");

    carregarJogadores(jogadorLogado).then(() => {
        console.log("‚úÖ Jogadores carregados com base no estado de login!");

        //desmarccar esse trecho para canccelar o login do usuario

        //jogadorLogado = 'LOGADO'; 

        // ***********************************************

        if (jogadorLogado) {
            // O usu√°rio j√° est√° autenticado, ent√£o esconde a tela de login
            loginScreen.style.display = 'none';
            contentElement.style.display = 'none';
            console.log("‚úÖ Jogador j√° autenticado, pulando tela de login.");

            InicializarSistema().then(() => {
                if (loadingElement) loadingElement.style.display = 'none';
                contentElement.style.display = 'block';

                // Gera um identificador √∫nico para a sess√£o do usu√°rio
                const sessionId = localStorage.getItem("sessionId") || Math.random().toString(36).substr(2, 9);
                localStorage.setItem("sessionId", sessionId);

                // Cria refer√™ncia no Firebase para rastrear usu√°rios ativos
                const userStatusRef = database.ref(`sistemas/usuariosOnline/${sessionId}`);

                // Adiciona o usu√°rio ao banco quando ele acessa
                userStatusRef.set({
                    sessionId: sessionId,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    usuario: jogadorLogado  // Adiciona o nome do jogador
                });

                // Remove automaticamente quando o usu√°rio fechar a aba
                userStatusRef.onDisconnect().remove();

            }).catch(error => {
                console.error("‚ùå Erro ao inicializar o sistema:", error);
            });

        } else {
            // O usu√°rio precisa fazer login
            loginScreen.style.display = 'block';
            contentElement.style.display = 'none';

            InicializarSistema().then(() => {
                console.log("‚úÖ Sistema inicializado!");
                if (loadingElement) loadingElement.style.display = 'none';

                // Gera um identificador √∫nico para a sess√£o do usu√°rio
                const sessionId = localStorage.getItem("sessionId") || Math.random().toString(36).substr(2, 9);
                localStorage.setItem("sessionId", sessionId);

                // Cria refer√™ncia no Firebase para rastrear usu√°rios ativos
                const userStatusRef = database.ref(`sistemas/usuariosOnline/${sessionId}`); 

                // Adiciona o usu√°rio ao banco quando ele acessa
                userStatusRef.set({
                    sessionId: sessionId,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    usuario: 'primeiro acesso'  // como ainda n√£o fez o login, cadastra-se sem um usuario
                });

                // Remove automaticamente quando o usu√°rio fechar a aba
                userStatusRef.onDisconnect().remove();

            }).catch(error => {
                console.error("‚ùå Erro ao inicializar o sistema:", error);
            });
        }
    }).catch(error => {
        console.error("‚ùå Erro ao carregar jogadores:", error);
    });
};




document.addEventListener('DOMContentLoaded', () => {
//alert('entrei no addEventListener');
    const tabelaContainer = document.querySelector('.tabela-container');
    const horariosColuna = document.querySelectorAll('#tabelaCorpo td:first-child, #tabelaCorpo td:last-child');
    let isExpanded = false;

    // Ajusta os hor√°rios em telas pequenas
    const ajustarHorariosCelular = () => {
        const larguraTela = window.innerWidth;

        if (larguraTela <= 600) { // Verifica se a tela √© pequena
            horariosColuna.forEach(celula => {
                if (celula.textContent.includes(' - ')) {
                    const horarios = celula.textContent.split(' - ');
                    celula.innerHTML = `${horarios[0]}<br>${horarios[1]}`; // Quebra os hor√°rios em linhas
                }
            });
        }
    };

    // Chamada inicial ao carregar a p√°gina
    ajustarHorariosCelular();

    // Listener para alterar layout ao clicar duas vezes
    tabelaContainer.addEventListener('dblclick', (event) => {
        const target = event.target;

        if ((target.tagName === 'TH' || target.tagName === 'TD') && target.innerText.includes('Hor√°rios')) {
            if (isExpanded) {
                tabelaContainer.style.marginTop = "-10px";
            } else {
                tabelaContainer.style.marginTop = "55px";
            }

            isExpanded = !isExpanded;
            tabelaContainer.classList.toggle('fullscreen');
        }
    });
	
	
	const header = document.querySelector('.header'); // Seleciona o t√≠tulo da quadra
    let tapCount = 0; // Contador de toques
    let lastTapTime = 0; // Tempo do √∫ltimo toque

    header.addEventListener('click', () => {
        const currentTime = new Date().getTime();
        const tapInterval = 300; // Intervalo m√°ximo entre toques (em milissegundos)

        // Verifica se o tempo entre os toques √© menor que o intervalo definido
        if (currentTime - lastTapTime < tapInterval) {
            tapCount++;
        } else {
            tapCount = 1; // Reseta o contador se o intervalo for maior
        }

        lastTapTime = currentTime;

        // Se o usu√°rio tocar 3 vezes no t√≠tulo
        if (tapCount === 3) {
            tapCount = 0; // Reseta o contador
            confirmarLogout(); // Chama a fun√ß√£o de confirma√ß√£o de logout
        }
    });

    // Nova funcionalidade: Ajusta os nomes dos bot√µes para celular
    const ajustarNomesBotoes = () => {
        const larguraTela = window.innerWidth;
        const botoes = document.querySelectorAll('.tab-button');

        botoes.forEach(botao => {
            const nomeOriginal = botao.getAttribute('data-nome-original'); // Recupera o nome original
            if (!nomeOriginal) {
                botao.setAttribute('data-nome-original', botao.innerHTML); // Armazena o nome original uma √∫nica vez
            }

            if (larguraTela <= 600) {
                // Ajuste para celular: quebra o texto em duas linhas
                const partesNome = botao.getAttribute('data-nome-original').split(' - ');
                if (partesNome.length === 2) {
                    botao.innerHTML = `${partesNome[0]}<br>${partesNome[1]}`;
                }
            } else {
                // Ajuste para computador: restaura o nome original
                botao.innerHTML = botao.getAttribute('data-nome-original');
            }
        });
    };

    // Ajuste inicial e ao redimensionar a tela
    ajustarNomesBotoes();
    window.addEventListener('resize', ajustarNomesBotoes);
});





function fazerLogin() {
    let jogadorSelect = document.getElementById('jogadorSelect');
    let jogadorSelecionado = jogadorSelect.value; // Apelido selecionado
    let senhaInput = document.getElementById("senha");
    let senhaDigitada = senhaInput.value;
    let loginScreen = document.getElementById('loginScreen');
    let contentElement = document.getElementById('content');

    if (!jogadorSelecionado || !senhaDigitada) {
        alert("Por favor, selecione um jogador e digite a senha.");
        return;
    }

    // Busca o nome completo do jogador com base no apelido selecionado
    const jogadoresRef = database.ref("sistemas/cadastro/jogadores");
    jogadoresRef.once('value', (snapshot) => {
        const jogadores = snapshot.val();
        let nomeCompleto = '';
        let dataNascimento = '';

        // Encontra o nome completo e a data de nascimento correspondente ao apelido selecionado
        Object.keys(jogadores).forEach((nome) => {
            if (jogadores[nome].apelido === jogadorSelecionado) {
                nomeCompleto = nome; // Nome completo
                dataNascimento = jogadores[nome].niver ? jogadores[nome].niver.replace(/\//g, "") : ""; // Formato ddmmyyyy
            }
        });

        if (!nomeCompleto) {
            alert("Jogador n√£o encontrado.");
            return;
        }

        // Verifica se a senha digitada corresponde √† data de nascimento
        if (senhaDigitada !== dataNascimento) {
            alert("üîí Senha inv√°lida! \nTente novamente ou entre em contato com o administrador.\nRonaldo Taborda.");
            senhaInput.value = ""; // Limpa o campo senha
            return;
        }

        // Exibe o nome completo do jogador na mensagem de confirma√ß√£o
        const confirmacao = confirm(`Voc√™ selecionou o jogador: ${nomeCompleto}. Deseja continuar?`);

        if (confirmacao) {
            // Grava o nome completo no localStorage
            localStorage.setItem('jogadorLogado', nomeCompleto); // Salva o nome completo
            loginScreen.style.display = 'none';
            contentElement.style.display = 'block';
			atualizarPrimeiroAcesso(nomeCompleto); 
        } else {
            // Se o usu√°rio cancelar, limpa os campos jogador e senha
            jogadorSelect.value = '';
            senhaInput.value = '';
        }
    }).catch(error => {
        console.error("Erro ao acessar o banco de dados:", error);
        alert("Erro ao acessar o banco de dados. Tente novamente mais tarde.");
    });
}





 function confirmarLogout() {
    const jogadorLogado = localStorage.getItem('jogadorLogado'); // Recupera o nome do jogador logado

    // Mensagem personalizada com o nome do jogador
    const confirmacao = confirm(`Voc√™ est√° logado como ${jogadorLogado}. Deseja realmente sair do sistema?`);

    if (confirmacao) {
        fazerLogout(); // Se o usu√°rio confirmar, faz o logout
    }
}


function fazerLogout() {
    localStorage.removeItem('jogadorLogado'); // Remove o jogador logado do localStorage
    window.location.reload(); // Recarrega a p√°gina para voltar √† tela de login
}


// üöÄ Atualiza a lista de jogadores quando a dura√ß√£o for alterada
document.addEventListener("DOMContentLoaded", function () {
    const duracaoSelect = document.getElementById('duracao');

    if (duracaoSelect) {
        duracaoSelect.addEventListener('change', function() {
            carregarJogadores(); // Recarrega os jogadores ao mudar a dura√ß√£o
        });
    } else {
        console.warn("‚ö†Ô∏è Elemento #duracao n√£o encontrado. O evento de mudan√ßa n√£o foi adicionado.");
    }

    // Adicionando verifica√ß√£o para "Rildo Santos"
    const jogador1Select = document.getElementById("jogador1");

    if (jogador1Select) {
        jogador1Select.addEventListener("change", function () {
            if (jogador1Select.value === "Rildo") {
                const isAula = confirm("Essa reserva √© para um jogo ou uma aula?\nOK para Aula, Cancelar para Jogo");

                if (isAula) {
                    let aulaOption = jogador1Select.querySelector("option[value='aula']");
                    if (!aulaOption) {
                        aulaOption = document.createElement("option");
                        aulaOption.value = "aula";
                        aulaOption.textContent = "Aula";
                        jogador1Select.appendChild(aulaOption);
                    }
                    jogador1Select.value = "aula";
                }
            }
        });
    } else {
        console.warn("‚ö†Ô∏è Elemento #jogador1 n√£o encontrado. O evento de mudan√ßa n√£o foi adicionado.");
    }
});

// Fun√ß√£o para exibir mensagem ao reservar com convidado
function exibirMensagemConvidado() {
    const mensagem = `Reserva de Convidado efetuada com sucesso!\n\n‚ö†Ô∏è Aten√ß√£o!\n\nValor da taxa: R$ 50,00 por pessoa.\nPagamento: O pagamento deve ser realizado diretamente com o Toni.\nPrioridade dos s√≥cios: Se um s√≥cio quiser jogar, a reserva do convidado poder√° ser cancelada em at√©, no m√°ximo, 4 horas antes do jogo.`;
    alert(mensagem);
}

function exibirMensagemPiramide() {
    const mensagem = `Reserva Pir√¢mide efetuada com sucesso!\n\n‚ö†Ô∏è Aten√ß√£o!\n\nüì¢ Informar no grupo Data, hor√°rio e jogadores.\nüí∞ Valor da taxa: R$ 5,00 por jogador.\nüìå O pagamento deve ser realizado no PIX do Edemar:\n   - Chave: tedemar@hotmail.com\n`;
    alert(mensagem);
}



// Fun√ß√£o simplificada de log
async function registrarExclusao(quadra, horario, jogadores, usuario, duracao, dataReserva) {
  // 1. Compatibilidade com o processamento em lote (NOVO)
  if (Array.isArray(quadra)) {
    return registrarExclusaoEmLote(quadra); // quadra cont√©m o array de logs
  }

  // 2. C√ìDIGO ORIGINAL TOTALMENTE PRESERVADO (in√≠cio)
  const token = githubToken;
  const usuarioGit = 'clube-olimpico';
  const repo = 'Reservas';
  const caminhoArquivo = 'logs/reservas-excluidas.json';
  const url = `https://api.github.com/repos/${usuarioGit}/${repo}/contents/${caminhoArquivo}`;

  try {
    // Obter o arquivo atual
    let response = await fetch(url, {
      headers: {
        'Authorization': `token ${token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });

    if (!response.ok) {
      throw new Error(`Erro ao buscar arquivo: ${response.status}`); 
    }

    let fileData = await response.json();
    let logs = [];
    let sha = fileData.sha;

    // Decodificar conte√∫do existente
    if (fileData.content) {
      try {
        logs = JSON.parse(atob(fileData.content.replace(/\s/g, ''))) || [];
      } catch (e) {
        console.warn('Falha ao decodificar logs existentes, iniciando novo', e);
      }
    }

    // Adicionar novo registro
    logs.push({
      exclusao: new Date().toLocaleString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      }).replace(',', ''),
      quadra: quadra,
      data: dataReserva,
      horario: horario,
      duracao: duracao === 3 ? "2 Horas - Pir√¢mide" : duracao === 2 ? "2 Horas" : "1 Hora",
      jogadores: jogadores,
      usuario: usuario || 'SISTEMA'
    });

    // Enviar atualiza√ß√£o
    response = await fetch(url, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: `Exclus√£o registrada: ${quadra} - ${dataReserva} ${horario}`,
        content: btoa(JSON.stringify(logs, null, 2)),
        sha: sha
      })
    });

    if (!response.ok) {
      throw new Error(`Falha no upload: ${response.status}`);
    }

    console.log('‚úÖ Log registrado com sucesso');
  } catch (erro) {
    console.error('‚ùå Erro ao salvar log:', erro);
    // Fallback local (original mantido)
    const logsFallback = JSON.parse(localStorage.getItem('logs_fallback') || '[]');
    logsFallback.push({
      exclusao: new Date().toLocaleString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      }).replace(',', ''),
      quadra: quadra,
      data: dataReserva,
      horario: horario,
      duracao: duracao === 3 ? "2 Horas (Pir√¢mide)" : duracao === 2 ? "2 Horas" : "1 Hora",
      jogadores: jogadores,
      usuario: usuario || 'SISTEMA'
    });
    localStorage.setItem('logs_fallback', JSON.stringify(logsFallback));
  }
  // FIM DO C√ìDIGO ORIGINAL
}

// Fun√ß√£o adicional (NOVA) - n√£o substitui nada, apenas complementa
async function registrarExclusaoEmLote(logs) {
  const token = githubToken;
  const usuarioGit = 'clube-olimpico';
  const repo = 'Reservas';
  const caminhoArquivo = 'logs/reservas-excluidas.json';
  const url = `https://api.github.com/repos/${usuarioGit}/${repo}/contents/${caminhoArquivo}`;

  try {
    // Obter vers√£o atual do arquivo
    let response = await fetch(url, {
      headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
    });
    
    if (!response.ok) throw new Error(`Erro ao buscar arquivo: ${response.status}`);
    
    const fileData = await response.json();
    let logsExistentes = [];
    if (fileData.content) {
      try {
        logsExistentes = JSON.parse(atob(fileData.content.replace(/\s/g, ''))) || [];
      } catch (e) {
        console.warn('Falha ao decodificar logs existentes', e);
      }
    }

    // Combinar com os novos logs
    const todosLogs = [...logsExistentes, ...logs];

    // Enviar atualiza√ß√£o
    response = await fetch(url, {
      method: 'PUT',
      headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: `Exclus√µes em lote: ${logs.length} reservas`,
        content: btoa(JSON.stringify(todosLogs, null, 2)),
        sha: fileData.sha
      })
    });

    if (!response.ok) throw new Error(`Falha no upload: ${response.status}`);
    console.log(`‚úÖ ${logs.length} logs registrados em lote`);
  } catch (erro) {
    console.error('‚ùå Erro ao salvar logs em lote:', erro);
    // Fallback para localStorage
    const logsFallback = JSON.parse(localStorage.getItem('logs_fallback') || '[]');
    logs.forEach(log => logsFallback.push(log));
    localStorage.setItem('logs_fallback', JSON.stringify(logsFallback));
  }
}

// Fun√ß√£o para atualizar o valor "primeiro acesso"
function atualizarPrimeiroAcesso(jogadorLogado) {
    const sessionId = localStorage.getItem("sessionId");
    if (sessionId) {
        const userStatusRef = database.ref(`sistemas/usuariosOnline/${sessionId}`);
        // Atualiza o valor do usu√°rio para o nome do jogador
        userStatusRef.update({ usuario: jogadorLogado })
            .then(() => console.log("‚úÖ Valor de 'primeiro acesso' atualizado para:", jogadorLogado))
            .catch(error => console.error("‚ùå Erro ao atualizar 'primeiro acesso':", error));
    } else {
        console.error("‚ùå SessionId n√£o encontrado. N√£o foi poss√≠vel atualizar 'primeiro acesso'.");
    }
}

async function validarRegraDeDuplas(jogadores, quadraSelecionada, dia, hora, duracao) {
    console.clear();
    console.log("--- INICIANDO VALIDA√á√ÉO DE DUPLAS ---");
    console.log(`Dados recebidos: Quadra=${quadraSelecionada}, DiaSemana=${dia}, HoraIn√≠cio=${hora}, Dura√ß√£o=${duracao}h`);

    const duplasConfig = duplasConfigGlobais;

    if (!duplasConfig || !duplasConfig.ativa) {
        return true; // Regra global desativada
    }
    if (jogadores.some(j => j.toLowerCase() === 'aula')) {
        return true; // Regra n√£o se aplica a aulas
    }

    const quadraKey = `Quadra-${quadraSelecionada.split(' ')[1]}`;
    const configDaQuadra = duplasConfig[quadraKey];

    if (!configDaQuadra || !configDaQuadra[`${quadraKey}-ativa`]) {
        return true; // Regra desativada para esta quadra
    }

    // L√≥gica de data para flexibiliza√ß√£o
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0); 
    const diaDaSemanaHoje = hoje.getDay() === 0 ? 7 : hoje.getDay();
    let diff = dia - diaDaSemanaHoje;
    if (diff < 0) {
        diff += 7;
    }
    const dataDaReserva = new Date(hoje);
    dataDaReserva.setDate(hoje.getDate() + diff);
    const dataFormatadaParaChave = `${dataDaReserva.getFullYear()}-${String(dataDaReserva.getMonth() + 1).padStart(2, '0')}-${String(dataDaReserva.getDate()).padStart(2, '0')}`;
    
    // L√≥gica de Exce√ß√µes (Datas Especiais) - tem prioridade
    const excecao = duplasConfig.DatasEspeciais?.[quadraKey]?.[dataFormatadaParaChave];
    if (excecao && excecao.regras) {
        const horarioInicioRegra = parseInt((excecao.regras.inicio || "0:00").split(':')[0]);
        const horarioFimRegra = parseInt((excecao.regras.fim || "0:00").split(':')[0]);
        const horarioFimReserva = hora + duracao;

        if (hora < horarioFimRegra && horarioFimReserva > horarioInicioRegra) {
		
		    // *** IN√çCIO DA ALTERA√á√ÉO PARA EXCE√á√ïES ***
            // 1. Valida√ß√£o de Convidado em datas de exce√ß√£o
            if (jogadores.includes("Convidado")) {
                alert(`‚ö†Ô∏è Aten√ß√£o: Regra de Exce√ß√£o para Duplas\n\nNa data ${dataFormatadaParaChave.split('-').reverse().join('/')} (${excecao.descricao || 'Data Especial'}), o hor√°rio das ${excecao.regras.inicio} √†s ${excecao.regras.fim} na ${quadraSelecionada} √© exclusivo para jogos entre s√≥cios.\n\nRegras para este hor√°rio:\n‚Ä¢ Apenas jogos de duplas (4 jogadores).\n‚Ä¢ N√£o √© permitida a inclus√£o de convidados.\n\nPara agendar com menos de 4 s√≥cios, tente novamente no dia da reserva, caso o hor√°rio ainda esteja dispon√≠vel.`);
                return false;
            }
            // *** FIM DA ALTERA√á√ÉO ***
            // --- IN√çCIO DA CORRE√á√ÉO: L√ìGICA DE FLEXIBILIZA√á√ÉO ADICIONADA √ÄS EXCE√á√ïES ---
            // Apenas exige 4 jogadores se a reserva for para um DIA FUTURO
            if (dataDaReserva > hoje) {
                if (jogadores.length !== 4) {
                    alert(`‚ö†Ô∏è Aten√ß√£o: Regra de Exce√ß√£o\n\nNa data ${dataFormatadaParaChave.split('-').reverse().join('/')} (${excecao.descricao || 'Data Especial'}), o hor√°rio das ${excecao.regras.inicio} √†s ${excecao.regras.fim} na ${quadraSelecionada} √© exclusivo para jogos de duplas com 4 jogadores.\n\nPara agendar com menos jogadores, tente novamente no dia da reserva, caso o hor√°rio ainda esteja dispon√≠vel.`);
                    return false;
                }
            }
            // Se for para hoje, a regra √© flex√≠vel e a valida√ß√£o passa.
            // --- FIM DA CORRE√á√ÉO ---
        }
        return true;
    }

    // L√≥gica para Regras Semanais
    const diaDaSemana = dia >= 1 && dia <= 5;
    const sabado = dia === 6;
    const domingo = dia === 7;
    let diaConfigKey, nomeDoPeriodo, inicioKey, fimKey;

    if (diaDaSemana) {
        diaConfigKey = `${quadraKey.split('-')[1]}-DiasDeSemana`;

        const configDiasEspecificos = configDaQuadra.DiasDeSemanaConfig;
        if (!configDaQuadra[diaConfigKey] || !configDiasEspecificos) {
            return true;
        }
        const diaSemanaMap = { 1: 'segunda', 2: 'terca', 3: 'quarta', 4: 'quinta', 5: 'sexta' };
        if (!configDiasEspecificos[diaSemanaMap[dia]]) {
            return true; 
        }
        
        const diasAtivosNomes = [];
        if (configDiasEspecificos.segunda) diasAtivosNomes.push("Segunda-feira");
        if (configDiasEspecificos.terca) diasAtivosNomes.push("Ter√ßa-feira");
        if (configDiasEspecificos.quarta) diasAtivosNomes.push("Quarta-feira");
        if (configDiasEspecificos.quinta) diasAtivosNomes.push("Quinta-feira");
        if (configDiasEspecificos.sexta) diasAtivosNomes.push("Sexta-feira");
        
        if (diasAtivosNomes.length < 5) {
            nomeDoPeriodo = `nos seguintes dias: ${diasAtivosNomes.join(', ')}`;
        } else {
            nomeDoPeriodo = "durante a semana";
        }

    } else if (sabado) {
        diaConfigKey = `${quadraKey.split('-')[1]}-Sabado`;
        nomeDoPeriodo = "aos S√°bados";
    } else if (domingo) {
        diaConfigKey = `${quadraKey.split('-')[1]}-Domingo`;
        nomeDoPeriodo = "aos Domingos";
    } else {
        return true;
    }

    if (!configDaQuadra[diaConfigKey]) {
        return true;
    }

    inicioKey = `${diaConfigKey}-Inicio`;
    fimKey = `${diaConfigKey}-Fim`;
    const horarioInicioRegra = parseInt((configDaQuadra[inicioKey] || "0:00").split(':')[0]);
    const horarioFimRegra = parseInt((configDaQuadra[fimKey] || "0:00").split(':')[0]);
    const horarioFimReserva = hora + duracao;

    if (hora < horarioFimRegra && horarioFimReserva > horarioInicioRegra) {
	
	    // *** IN√çCIO DA ALTERA√á√ÉO ***
        // Valida se h√° convidados no hor√°rio de duplas da regra semanal.
        if (jogadores.includes("Convidado")) {
            alert(`‚ö†Ô∏è Aten√ß√£o: Hor√°rio Priorit√°rio para Duplas\n\nNo hor√°rio das ${configDaQuadra[inicioKey]} √†s ${configDaQuadra[fimKey]} ${nomeDoPeriodo}, a quadra √© exclusiva para jogos entre s√≥cios.\n\nRegras para este hor√°rio:\n‚Ä¢ Apenas jogos de duplas (4 jogadores).\n‚Ä¢ N√£o √© permitida a inclus√£o de convidados.\n\nPara agendar com menos de 4 s√≥cios, tente novamente no dia da reserva, caso o hor√°rio ainda esteja dispon√≠vel.`);
            return false;
        }
        // *** FIM DA ALTERA√á√ÉO *** 
	
	
        if (dataDaReserva > hoje) {
            if (jogadores.length !== 4) {
                alert(`‚ö†Ô∏è Aten√ß√£o: Hor√°rio Priorit√°rio para Duplas\n\nNa ${quadraSelecionada}, o hor√°rio das ${configDaQuadra[inicioKey]} √†s ${configDaQuadra[fimKey]} ${nomeDoPeriodo} √© priorit√°rio para jogos de duplas (4 jogadores).\n\nPara agendar com menos jogadores, tente novamente no dia da reserva, caso o hor√°rio ainda esteja dispon√≠vel.`);
                return false;
            }
        } 
    }

    console.log("VALIDA√á√ÉO OK: A reserva passou por todas as regras de Duplas.");
    return true; 
}




function aplicarBloqueiosVisuais(quadra) {
    const quadraKey = `Quadra-${quadra.split(' ')[1]}`;
    if (!bloqueiosQuadra || !bloqueiosQuadra[quadraKey]) {
        return; 
    }
    const bloqueiosDaQuadra = bloqueiosQuadra[quadraKey];
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    const diaDaSemanaHoje = hoje.getDay() === 0 ? 7 : hoje.getDay();

    for (let dia = 1; dia <= 7; dia++) {
        let diff = dia - diaDaSemanaHoje;
        if (diff < 0) diff += 7;
        const dataDaReserva = new Date(hoje);
        dataDaReserva.setDate(hoje.getDate() + diff);
        const dataFormatada = `${dataDaReserva.getFullYear()}-${String(dataDaReserva.getMonth() + 1).padStart(2, '0')}-${String(dataDaReserva.getDate()).padStart(2, '0')}`;
        const bloqueioDoDia = bloqueiosDaQuadra[dataFormatada];

        if (bloqueioDoDia && bloqueioDoDia.regras) {
            const tabela = document.getElementById('tabelaCorpo');
            const inicioBloqueio = parseInt(bloqueioDoDia.regras.inicio.split(':')[0]);
            const fimBloqueio = parseInt(bloqueioDoDia.regras.fim.split(':')[0]);

            for (let hora = inicioBloqueio; hora < fimBloqueio; hora++) {
                const rowIndex = hora - 6;
                if (tabela.rows[rowIndex]) {
                    const cell = tabela.rows[rowIndex].cells[dia];
                    if (cell) {
                        cell.innerHTML = ""; // Garante que a c√©lula fique vazia
                        
                        // --- √öNICA ALTERA√á√ÉO: Cor de fundo para vermelho ---
                        cell.style.backgroundColor = 'lightcoral';
                        
                        cell.style.cursor = 'help';
                        const motivo = bloqueioDoDia.descricao || "Uso interno do clube";
                        cell.title = motivo;
                        
                        cell.onclick = () => {
                            const dataFormatadaBrasileira = dataFormatada.split('-').reverse().join('/');
                            alert(`‚ÑπÔ∏è Informa√ß√£o: Hor√°rio Bloqueado\n\nO hor√°rio das ${bloqueioDoDia.regras.inicio} √†s ${bloqueioDoDia.regras.fim} na ${quadra} do dia ${dataFormatadaBrasileira} est√° indispon√≠vel.\n\nMotivo: ${motivo}`);
                        };
                        
                        cell.style.borderTop = "1px solid #bbb";
                        cell.style.borderBottom = "1px solid #bbb";
                        cell.style.borderLeft = "1px solid #bbb";
                        cell.style.borderRight = "1px solid #bbb";
                    }
                }
            }
        }
    }
}


function parseDateDDMMYYYY(dateString) {
    if (!dateString) return null;
    const parts = dateString.split('-');
    if (parts.length !== 3) return null;
    // new Date(ano, m√™s - 1, dia)
    return new Date(parts[2], parts[1] - 1, parts[0]);
}

/**
 * Calcula em qual linha da pir√¢mide um jogador da categoria masculina est√°.
 * @param {number} posicao - A posi√ß√£o do jogador no ranking.
 * @returns {number} - O n√∫mero da linha.
 */
function encontrarLinha(posicao) {
    if (posicao <= 0) return 0;
    // F√≥rmula matem√°tica para encontrar a linha em uma pir√¢mide num√©rica
    return Math.ceil((-1 + Math.sqrt(1 + 8 * posicao)) / 2);
}

</script>



<body>

 <!-- Tela de carregamento -->
    <div id="loading" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem; background-color: white; width: 100%; height: 100vh; display: flex; align-items: center; justify-content: center; z-index: 9999;">
        Carregando... Aguarde.
    </div>

<!-- Tela de Login -->
<div id="loginScreen">
    <!-- Cabe√ßalho com as informa√ß√µes do clube -->
    <div id="loginHeader">
        <h1>Clube Ol√≠mpico</h1>
        <h2>Quadras de T√™nis</h2>
        <h3>Sistema de Reservas</h3>
    </div>

    <!-- Painel de sele√ß√£o de jogadores -->
    <div id="loginForm">
        <h2>Selecione seu nome:</h2>
        <div class="input-group">
            <select id="jogadorSelect">
                <option value="">Carregando jogadores...</option>
            </select>
        </div>
        
       <div class="input-container">
    <label for="senha" class="label-senha">Senha:</label>
    <input type="password" id="senha" placeholder="Digite sua senha" inputmode="numeric" pattern="[0-9]*" maxlength="8">
    <button type="button" id="toggleSenha">üëÅÔ∏è</button>
</div>
        
        <button onclick="fazerLogin()">Entrar</button>
    </div>
</div>

<!-- Conte√∫do Principal -->
<div id="mainContent" style="display: none; text-align: center;">
    <h2>Bem-vindo, <span id="nomeJogador"></span>!</h2>
    <button onclick="fazerLogout()">Sair</button>
</div>


<!-- Conte√∫do da p√°gina (inicialmente oculto) -->
<div id="content" style="display: none;">

<div class="tab-container" style="display: flex; justify-content: center; margin-bottom: 10px;">
    <button class="tab-button" onclick="selecionarQuadra('Quadra 1 - Coberta')">Quadra 1 - Coberta</button>
    <button class="tab-button" onclick="selecionarQuadra('Quadra 2 - Aberta')">Quadra 2 - Aberta</button>
    <button class="tab-button" onclick="selecionarQuadra('Quadra 3 - Coberta')">Quadra 3 - Coberta</button>
</div>



<div id="VersaoSistema" style="text-align: right; margin-top: 70px; margin-right: 10px; font-size: 1rem; color: #555; cursor: default; position: relative; z-index: 9999;">
    
</div>


 



<div class="form-container">
    <form id="dataForm">
	
	    <div class="form-row">
			<label for="quadra">Quadra:</label>
			<select id="quadra" onchange="selecionarQuadra(this.value)">
				<option value="Quadra 1 - Coberta">Quadra 1 - Coberta</option>
				<option value="Quadra 2 - Aberta">Quadra 2 - Aberta</option>
				<option value="Quadra 3 - Coberta">Quadra 3 - Coberta</option>
			</select>
		</div>



        <div class="form-row">
            <label for="dia">Dia:</label>
            <select id="dia"  onchange="atualizarOpcoesHorario()">
				<option value="1">Segunda-Feira</option>
				<option value="2">Ter√ßa-Feira</option>
				<option value="3">Quarta-Feira</option>
				<option value="4">Quinta-Feira</option>
				<option value="5">Sexta-Feira</option>
				<option value="6">S√°bado</option>
				<option value="7">Domingo</option>
			</select>

        </div>

        <div class="form-row">
			<label for="duracao">Dura√ß√£o:</label>
			<select id="duracao" onchange="atualizarOpcoesHorario()">
			<option value="1">1 hora</option>
			<option value="2">2 horas</option>
			<option value="3-piramide" style="display: none;">Pir√¢mide</option> <!-- Op√ß√£o inicialmente oculta -->
			</select>
		</div>
		

        <div class="form-row">
            <label for="hora">Hor√°rio:</label>
            <select id="hora">
                <!-- As op√ß√µes de hor√°rio ser√£o ajustadas pelo JavaScript --> 
            </select>
        </div>

        <div class="jogadores-container" id="jogadoresContainer">
			<div class="form-row">
				<label for="jogador1">Jogador:</label>
				<select id="jogador1" name="jogador" required style="width: 100px;">
					<option value="">Selecione um jogador</option>
				</select>
				<span class="add-jogador" onclick="adicionarJogador()">+</span>
			</div>
		</div>

        <button id="botaoAgendar" type="button" onclick="atualizarTabela()">Agendar</button>
    </form>
</div>

<div style="display: flex; justify-content: space-between; align-items: center;">
    <h2 class="header" style="margin: 1; font-size: 20px;">Quadra 1 - Coberta</h2> <!-- T√≠tulo √† esquerda -->

    
    <div id="legenda" style="margin-left: 20px; margin-right: 10px; text-align: left; margin-bottom: 10px;">
    <strong style="font-size: 14px;">Legenda:</strong>
    <div style="display: flex; flex-direction: column; gap: 5px;">
        <!-- Primeira linha: 1 Hora e 2 Horas -->
        <div id="linha-1" style="display: flex; align-items: center;">
            <span style="display: inline-block; width: 15px; height: 17px; background-color: lightgreen; margin-right: 2px;"></span>
            <span style="font-size: 12px;">1 Hora</span>
            <span style="display: inline-block; width: 15px; height: 18px; background-color: lightblue; margin-right: 2px; margin-left: 10px;"></span>
            <span style="font-size: 12px;">2 Horas</span>
        </div>
        <!-- Segunda linha: Aula e Pir√¢mide -->
        <div id="linha-2" style="display: flex; align-items: center;">
            <span style="display: inline-block; width: 15px; height: 18px; background-color: lightcoral; margin-right: 5px;"></span>
            <span style="font-size: 12px;">Aula</span>
            <span id="piramide-span" style="display: inline-block; width: 15px; height: 18px; background-color: #FFEB99 ; margin-left: 19px; margin-right: 1px;"></span>
            <span id="piramide-text" style="font-size: 12px;">Pir√¢mide</span>
        </div>
    </div>
	</div>
</div>

<div class="tabela-container">
<table id="tabelaQuadra" style="width: 100%; margin-top: 10px;"> 
    <tr>
        <th rowspan="2" style="text-align: center;">Hor√°rios</th>
        <th>Segunda-Feira</th>
        <th>Ter√ßa-Feira</th>
        <th>Quarta-Feira</th>
        <th>Quinta-Feira</th>
        <th>Sexta-Feira</th> 
        <th>S√°bado</th>
        <th>Domingo</th>
        <th rowspan="2" style="text-align: center;">Hor√°rios</th>
    </tr>
    <tr style="background-color: #f2f2f2;">
        <td style="font-weight: bold; font-size: 0.9em;">09/10/24</td>
        <td style="font-weight: bold; font-size: 0.9em;">10/10/24</td>
        <td style="font-weight: bold; font-size: 0.9em;">11/10/24</td>
        <td style="font-weight: bold; font-size: 0.9em;">12/10/24</td>
        <td style="font-weight: bold; font-size: 0.9em;">13/10/24</td>
        <td style="font-weight: bold; font-size: 0.9em;">14/10/24</td>
        <td style="font-weight: bold; font-size: 0.9em;">15/10/24</td>
    </tr>
    <tbody id="tabelaCorpo">
    <tr>
        <td class="horario">06:00 - 07:00</td>
        <td></td><td></td><td></td><td></td><td></td>
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- S√°bado -->
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
        <td class="horario">06:00 - 07:00</td>
    </tr>
    <tr>
        <td class="horario">07:00 - 08:00</td>
        <td></td><td></td><td></td><td></td><td></td>
        <td></td>
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
        <td class="horario">07:00 - 08:00</td>
    </tr>
    <tr>
        <td class="horario">08:00 - 09:00</td>
        <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
        <td class="horario">08:00 - 09:00</td>
    </tr>
    <tr>
        <td class="horario">09:00 - 10:00</td>
        <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
        <td class="horario">09:00 - 10:00</td>
    </tr>
    <tr>
        <td class="horario">10:00 - 11:00</td>
        <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
        <td class="horario">10:00 - 11:00</td>
    </tr>
    <tr>
        <td class="horario">11:00 - 12:00</td>
        <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
        <td class="horario">11:00 - 12:00</td>
    </tr>
    <tr>
        <td class="horario">12:00 - 13:00</td>
        <td></td><td></td><td></td><td></td><td></td><td></td>
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
        <td class="horario">12:00 - 13:00</td>
    </tr>
    <tr>
        <td class="horario">13:00 - 14:00</td>
        <td></td><td></td><td></td><td></td><td></td><td></td>
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
        <td class="horario">13:00 - 14:00</td>
    </tr>
    <tr>
        <td class="horario">14:00 - 15:00</td>
        <td></td><td></td><td></td><td></td><td></td><td></td>
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
        <td class="horario">14:00 - 15:00</td>
    </tr>
    <tr>
        <td class="horario">15:00 - 16:00</td>
        <td></td><td></td><td></td><td></td><td></td><td></td>
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
        <td class="horario">15:00 - 16:00</td>
    </tr>
    <tr>
        <td class="horario">16:00 - 17:00</td>
        <td></td><td></td><td></td><td></td><td></td><td></td>
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
        <td class="horario">16:00 - 17:00</td>
    </tr>
    <tr>
        <td class="horario">17:00 - 18:00</td>
        <td></td><td></td><td></td><td></td><td></td><td></td>
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
        <td class="horario">17:00 - 18:00</td>
    </tr>
    <tr>
        <td class="horario">18:00 - 19:00</td>
        <td></td><td></td><td></td><td></td><td></td><td></td>
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
        <td class="horario">18:00 - 19:00</td>
    </tr>
    <tr>
        <td class="horario">19:00 - 20:00</td>
        <td></td><td></td><td></td><td></td><td></td><td></td>
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
        <td class="horario">19:00 - 20:00</td>
    </tr>
    <tr>
        <td class="horario">20:00 - 21:00</td>
        <td></td><td></td><td></td><td></td><td></td><td></td>
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
        <td class="horario">20:00 - 21:00</td>
    </tr>
    <tr>
        <td class="horario">21:00 - 22:00</td>
        <td></td><td></td><td></td><td></td><td></td>
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- S√°bado -->
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
        <td class="horario">21:00 - 22:00</td>
    </tr>
    <tr>
        <td class="horario">22:00 - 23:00</td>
        <td></td><td></td><td></td><td></td><td></td>
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- S√°bado -->
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
        <td class="horario">22:00 - 23:00</td>
    </tr>
</tbody>

</table>
</div>
</div>
</body>

<script>
        document.addEventListener('DOMContentLoaded', function () {
    const toggleButton = document.getElementById('toggleSenha');
    const senhaInput = document.getElementById('senha');

    toggleButton.addEventListener('click', function () {
        if (senhaInput.type === 'password') {
            senhaInput.type = 'text';
            toggleButton.textContent = 'üôà'; // √çcone de olho fechado
        } else {
            senhaInput.type = 'password';
            toggleButton.textContent = 'üëÅÔ∏è'; // √çcone de olho aberto
        }
    });
});
</script>


<footer style="text-align: center; margin-top: 20px; font-size: 0.9em; color: #555;">
        Desenvolvido por Ronaldo Taborda
    </footer>
</html>
