<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Clube Olímpico - Sistema de Reservas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
}

.form-container {
    padding: 20px;
    margin: 0 auto;
    max-width: 500px;
    margin-top: -10px; /* Espaçamento para evitar sobreposição com a barra fixa */
}

.form-row {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    flex-wrap: nowrap; /* Garante que o label e o input fiquem na mesma linha */
}

label {
    margin-right: 10px;
    width: 160px; /* Ajusta o tamanho do label */
    font-size: 1rem;
}

/* Ajuste a largura do campo de entrada para todos os campos "Nome do Jogador" */
.jogador-input {
    width: 300px; /* Largura fixa de 300px para todos os campos */
    box-sizing: border-box; /* Inclui padding e bordas no cálculo da largura */
    margin: 0; /* Garante que não haja margem extra */
    padding: 5px; /* Garante um padding consistente */
}

/* Responsividade para dispositivos móveis */
@media (max-width: 600px) {
    .jogador-input {
        width: 100% !important; /* No celular, o campo ocupa 100% da largura disponível */
        max-width: 190px; /* No celular, não ultrapassa 300px */
    }
}

input, select, button {
    flex-grow: 1;
    padding: 5px;
    font-size: 1rem;
}

.jogadores-container {
    display: flex;
    flex-direction: column; /* Coloca os campos em coluna */
    margin-top: 10px; /* Espaço entre os campos */
}

.add-jogador {
    font-size: 2rem;
    cursor: pointer;
    color: blue;
    margin-top: 5px; /* Espaço acima do botão de adicionar */
}

button {
    background-color: #4CAF50;
    color: white;
    border: none;
    cursor: pointer;
    width: 100%;
    padding: 10px;
    margin-top: 10px;
}

button:hover {
    background-color: #45a049;
}

.tab-container {
    display: flex;
    justify-content: center;
    margin-bottom: 10px;
    position: fixed; /* Fixa os botões no topo */
    top: 0;
    left: 0;
    width: 100%;
    background-color: white; /* Fundo branco para destacar */
    z-index: 1000; /* Garante que fique acima de outros elementos */
    padding: 10px;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1); /* Sombra para realce */
}

.tabela-container {
    overflow-x: auto; /* Permite rolar horizontalmente */
    width: 100%; /* Garante que o contêiner ocupe toda a largura da tela */
    margin-top: 10px; /* Espaço para não sobrepor os botões fixos */
}

table {
    width: 100%;
    margin-top: 20px;
    border-collapse: collapse;
}

th, td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: center;
}

th {
    background-color: #f2f2f2;
}

.header {
    text-align: center;
    font-size: 1.5rem;
    margin-top: 20px;
    margin-bottom: 10px;
}

.selected {
    font-weight: bold;
    background-color: #228B22; /* Fundo verde escuro */
    color: white; /* Texto branco */
}

.fade-out {
    transition: opacity 0.3s ease-out;
    opacity: 0;
}

.tab-button {
    transition: background-color 0.3s ease;
    background-color: #4CAF50; /* Cor padrão */
    color: white;
    border: none;
    padding: 10px 20px;
    margin: 5px;
    cursor: pointer;
}
.tab-button:hover {
    background-color: #45a049; /* Cor ao passar o mouse */
}

.tab-button[disabled] {
    cursor: not-allowed; /* Cursor de bloqueio */
    background-color: red; /* Cor de fundo para interditado */
}

.tab-button.selected {
    font-weight: bold;
    background-color: #228B22 !important; /* Fundo verde escuro */
    color: white !important; /* Texto branco */
    border: 2px solid #1A6418 !important; /* Borda mais escura */
}

#loading {
    display: block;
    text-align: center;
    font-size: 1.5rem;
}

#content {
    display: none;
}

.fullscreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: white; /* Para garantir uma boa visualização */
    z-index: 9999;
    overflow: auto; /* Permite rolar caso necessário */
}

.fullscreen table {
    width: 100%; /* Garante que a tabela se ajuste ao contêiner */
    height: auto; /* Preserva o aspecto da tabela */
	
}

</style>	
	
	<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>


	<script>
	
//***********************************************************************************************************************************************************************

// Ajuste manual da versão do Sistema
const VersaoSistema = 'v1.0.0'; // Versão atual do sistema

 

// variáveis globais que são configurada em configuracoes.html
window.DiasParaLimpar = undefined; // Ajuste conforme necessário (1,2,3,4,5,6) ex: se DiasParaLimpar = 4, então só é permitido fazer reserva em até 2 dias de antecedencia

window.vDomingo = undefined; // Valor padrão fechado, pois o clube nao abre aos domingos (aberto,fechado)


let quadrasInativas = new Set();
let reservasPorQuadra = {};
let quadraSelecionada = 'Quadra 1 - Coberta'; 
		
//************************************************************************************************************************************************************************

	
	// descomentar quando publicar  
	 
		 document.addEventListener('contextmenu', event => event.preventDefault());
  document.addEventListener('keydown', event => {
    if (event.key === "F12" || (event.ctrlKey && event.shiftKey && event.key === "I")) {
      event.preventDefault();
    }
  });
   

	
	// Configuração do Firebase
const firebaseConfig = {
    apiKey: "SUA_API_KEY",
    authDomain: "agenda-5ce95.firebaseapp.com",
    projectId: "agenda-5ce95",
    storageBucket: "agenda-5ce95.appspot.com",
    messagingSenderId: "852007565195",
    appId: "1:852007565195:web:d7bd789d140858f53f618e"
};

// Inicializando o Firebase
const app = firebase.initializeApp(firebaseConfig);
const database = firebase.database();
console.log("Firebase inicializado");


// Nova estrutura inicial do banco de dados
function inicializarEstruturaInicial() {
    const estruturaInicial = {
        config: {
            DiasParaLimpar: 4, // Valor padrão
            vDomingo: "fechado", // Padrão fechado
            Quadras: {
                Quadra1: "liberada",
                Quadra2: "liberada",
                Quadra3: "liberada",
            },
        },
        reservas: {
            "Quadra 1 - Coberta": {},
            "Quadra 2 - Aberta": {},
            "Quadra 3 - Coberta": {},
        },
    };

    // Configurar o nó "sistema"
    database.ref("sistema").set(estruturaInicial)
        .then(() => {
            console.log("Estrutura inicial criada com sucesso no Firebase.");
        })
        .catch((error) => {
            console.error("Erro ao criar estrutura inicial no Firebase:", error);
        });
}



// Carregar dados iniciais do banco de dados
function InicializarSistema() {
    return new Promise((resolve, reject) => {
        const sistemaRef = database.ref("sistema");

        sistemaRef.on('value', (snapshot) => {
            const data = snapshot.val();

            if (data) {
                const config = data.config;

                if (config) {
                    window.DiasParaLimpar = config.DiasParaLimpar || 4;
                    window.vDomingo = config.vDomingo || "fechado";

                    // Atualizar estado das quadras
                    quadrasInativas.clear();
                    const quadras = config.Quadras || {};
                    if (quadras.Quadra1 === "interditada") quadrasInativas.add("Quadra 1 - Coberta");
                    if (quadras.Quadra2 === "interditada") quadrasInativas.add("Quadra 2 - Aberta");
                    if (quadras.Quadra3 === "interditada") quadrasInativas.add("Quadra 3 - Coberta");

                    atualizarDatas();
                    atualizarOpcoesHorario();
					
                }

                console.log("Configurações carregadas:", config);
            } else {
                console.log("Dados não encontrados. Inicializando estrutura...");
                inicializarEstruturaInicial();
            }

            // Determinar qual quadra será selecionada por padrão
            let quadraInicial = "Quadra 1 - Coberta"; // Padrão inicial
            if (quadrasInativas.has(quadraInicial)) {
                console.log(`${quadraInicial} está interditada.`);

                // Selecionar a próxima quadra ativa
                const proximasQuadras = ["Quadra 2 - Aberta", "Quadra 3 - Coberta"]
                    .filter(quadra => !quadrasInativas.has(quadra));

                if (proximasQuadras.length > 0) {
    quadraInicial = proximasQuadras[0]; // Pega a primeira quadra ativa
} else {
    console.log("Todas as quadras estão interditadas.");

    // **1. Sincronize quadrasInativas com todas as quadras antes de atualizar**
    quadrasInativas.clear(); // Limpa qualquer estado antigo
    quadrasInativas.add("Quadra 1 - Coberta");
    quadrasInativas.add("Quadra 2 - Aberta");
    quadrasInativas.add("Quadra 3 - Coberta");

    // **2. Atualize os botões visualmente antes de qualquer outra ação**
    atualizarEstadoQuadras();

    // Limpar o campo de seleção de quadras
    const selectQuadra = document.getElementById('quadra');
    if (selectQuadra) {
        selectQuadra.innerHTML = ""; // Remove todas as opções
        const defaultOption = document.createElement('option');
        defaultOption.value = "";
        defaultOption.textContent = "Nenhuma quadra disponível";
        selectQuadra.appendChild(defaultOption);
    }

    // Ocultar a interface da planilha
    const tabelaContainer = document.querySelector('.tabela-container');
    const header = document.querySelector('.header');
    if (tabelaContainer) tabelaContainer.style.display = 'none';
    if (header) header.style.display = 'none';

    // Exibir o alerta informando que todas as quadras estão interditadas
    alert("Todas as quadras estão interditadas no momento.");
    resolve();
    return; // Interrompe a execução caso todas as quadras estejam interditadas
}

            }

            console.log("Quadra selecionada automaticamente:", quadraInicial);

            // Atualiza o botão ativo na interface
            document.querySelectorAll('.tab-button').forEach(button => {
                if (button.innerText.trim() === quadraInicial) {
                    button.classList.add('selected');
                } else {
                    button.classList.remove('selected');
                }
            });

            // Atualiza o campo de seleção de quadras
            const selectQuadra = document.getElementById('quadra');
            if (selectQuadra) {
                selectQuadra.innerHTML = ""; // Limpa as opções
                ["Quadra 1 - Coberta", "Quadra 2 - Aberta", "Quadra 3 - Coberta"].forEach(quadra => {
                    if (!quadrasInativas.has(quadra)) {
                        const option = document.createElement('option');
                        option.value = quadra;
                        option.textContent = quadra;
                        selectQuadra.appendChild(option);
                    }
                });
                selectQuadra.value = quadraInicial; // Define a quadra inicial
            }

            // Exibir a interface da planilha
            const tabelaContainer = document.querySelector('.tabela-container');
            const header = document.querySelector('.header');
            if (tabelaContainer) tabelaContainer.style.display = 'block';
            if (header) {
                header.style.display = 'block';
                header.innerText = quadraInicial; // Atualiza o título da quadra
            }

            // **FORÇAR** atualização visual dos botões das quadras interditadas
            atualizarEstadoQuadras();

            // Seleciona a quadra inicial
            selecionarQuadra(quadraInicial);

            resolve();
        }, (error) => {
            console.error("Erro ao carregar dados iniciais:", error);
            reject(error);
        });
    });
}

 

function atualizarEstadoQuadras() {
    console.log("Atualizando estado visual das quadras...");
	

    // Verifica se o conjunto quadrasInativas está atualizado
    console.log("Quadras inativas:", Array.from(quadrasInativas));

    // Atualiza os botões de quadra
    document.querySelectorAll('.tab-button').forEach(button => {
        const quadraNome = button.innerText.trim();

        if (quadrasInativas.has(quadraNome)) {
            console.log(`Interditando visualmente: ${quadraNome}`);
            button.style.setProperty("background-color", "red", "important"); // Prioriza a cor
            button.style.setProperty("cursor", "not-allowed", "important"); // Prioriza o cursor
            button.onclick = () => alert(`A ${quadraNome} está interditada provisoriamente.`);
        } else {
            console.log(`Liberando visualmente: ${quadraNome}`);
            button.style.setProperty("background-color", "#4CAF50", "important"); // Prioriza a cor padrão
            button.style.setProperty("cursor", "pointer", "important"); // Prioriza o cursor padrão
            button.onclick = () => selecionarQuadra(quadraNome); // Permitir seleção de quadra ativa
        }
    });
}




function atualizarReservasQuadra(quadra) {
    console.log(`Atualizando reservas para a quadra: ${quadra}`);
    limparTabela();
    const reservas = reservasPorQuadra[quadra];
    if (reservas) {
        const tabela = document.getElementById('tabelaCorpo');
        for (const key in reservas) {
            const { jogadores, dia, hora, duracao, borda } = reservas[key];
            const rowIndex = hora - 6;
            const colIndex = dia;

             // Ignorar sábado (coluna 6) das 21:00 às 23:00 e domingo (coluna 7) das 06:00 às 08:00
            if ((colIndex === 6 && hora >= 21 && hora <= 23) || (colIndex === 7 && hora >= 6 && hora <= 8)) {
                continue; // Pule estas células
            }

            const cell = tabela.rows[rowIndex]?.cells[colIndex];
            if (cell) {
                cell.innerHTML = jogadores;
                cell.setAttribute("data-duracao", duracao);
                cell.style.backgroundColor = jogadores.toLowerCase().includes('aula') ? 'lightcoral' :
                    (duracao === 1 ? 'lightgreen' : 'lightblue');

                // Configurar bordas para reservas de 1h ou 2h
                if (borda === '1h') {
                    cell.style.border = '2px solid black';
                } else if (borda === '2h') {
                    configurarBordasDuracao2(cell, tabela, rowIndex, colIndex);
                }
            }
        }
    }
}




function configurarBordasDuracao2(cell, tabela, rowIndex, colIndex) {
    // Verifica se a célula está mesclada
    if (cell.rowSpan > 1) {
        // Para células mescladas, aplica bordas completas
        cell.style.borderTop = '2px solid black';
        cell.style.borderLeft = '2px solid black';
        cell.style.borderRight = '2px solid black';
        cell.style.borderBottom = '2px solid black'; // Mantém a borda inferior
    } else {
        // Configuração padrão para células não mescladas
        cell.style.borderTop = '2px solid black';
        cell.style.borderLeft = '2px solid black';
        cell.style.borderRight = '2px solid black';
        cell.style.borderBottom = 'none';

        const cellNext = tabela.rows[rowIndex + 1]?.cells[colIndex];
        if (cellNext) {
            cellNext.style.borderTop = 'none';
            cellNext.style.borderLeft = '2px solid black';
            cellNext.style.borderRight = '2px solid black';
            cellNext.style.borderBottom = '2px solid black';
        }
    }
}




// Função para buscar a versão mais recente e redirecionar
function verificarVersao() {
            const elementoVersao = document.getElementById('VersaoSistema');
            if (elementoVersao) {
                elementoVersao.textContent = `${VersaoSistema}`;
                console.log("Versão atualizada para: ", VersaoSistema);
            } else {
                console.error('Elemento para exibir a versão não encontrado!');
            }
        }


let jogadorCount = 1;


function atualizarEstadoDomingo() {
    const tabela = document.getElementById('tabelaCorpo');
    const diaDomingo = 7; // Índice da coluna correspondente ao domingo

    for (let i = 0; i < tabela.rows.length; i++) {
        const horario = i + 6; // Calcula o horário (06:00 corresponde à linha 0)
        const celulaDomingo = tabela.rows[i].cells[diaDomingo];

        if (vDomingo === 'aberto') {
            // Limpa o bloqueio
            if (horario >= 12 && horario <= 23) {
                celulaDomingo.style.backgroundColor = ''; // Remove a cor de fundo
                celulaDomingo.style.pointerEvents = ''; // Reativa interação
                celulaDomingo.style.cursor = ''; // Restaura o cursor padrão
            }
        } else if (vDomingo === 'fechado') {
            // Reaplica o bloqueio
            if (horario >= 12 && horario <= 23) {
                celulaDomingo.style.backgroundColor = '#f2f2f2'; // Cor cinza
                celulaDomingo.style.pointerEvents = 'none'; // Desativa interação
                celulaDomingo.style.cursor = 'not-allowed'; // Cursor indicando bloqueio
            }
        }
    } 
}		
		
		
// Função para limpar a tabela antes de exibir as reservas da quadra selecionada
function limparTabela() {
    console.log('Limpando tabela...');
    const tabela = document.getElementById('tabelaCorpo');
    for (let i = 0; i < tabela.rows.length; i++) {
        for (let j = 1; j < tabela.rows[i].cells.length - 1; j++) {
            const horario = i + 6; // Calcula o horário com base na linha
            
            // Ignorar sábado (coluna 6) das 06:00 às 07:00 e domingo (coluna 7) das 06:00 às 08:00
            if ((j === 6 && horario === 6) || (j === 7 && horario >= 6 && horario <= 7) || (j === 6 && horario >= 21 && horario <= 23)) {
                continue; // Pule estas células
            }

            const cell = tabela.rows[i].cells[j];
            if (cell.rowSpan > 1) {
                // Restaurar células mescladas
                const nextCell = tabela.rows[i + 1]?.cells[j];
                if (nextCell) {
                    nextCell.style.display = ''; // Reexibir a próxima célula
                }
                cell.rowSpan = 1; // Resetar o rowSpan
            }

            // Restaurar bordas padrão
            cell.style.borderTop = "1px solid #ddd";
            cell.style.borderBottom = "1px solid #ddd";
            cell.style.borderLeft = "1px solid #ddd";
            cell.style.borderRight = "1px solid #ddd";
            cell.style.backgroundColor = ""; // Restaurar cor de fundo padrão
            cell.innerHTML = ""; // Limpar conteúdo da célula
        }
    }
}






// Função para selecionar a quadra e carregar suas reservas
function selecionarQuadra(quadra) {
    console.log("Quadra selecionada:", quadra);

    // Verifica se a quadra está interditada
    const isQuadraInterditada = quadrasInativas.has(quadra);

    if (isQuadraInterditada) {
        alert(`A ${quadra} está interditada provisoriamente.`);
    }

    // Atualiza a quadra selecionada
    quadraSelecionada = quadra;
    document.querySelector('.header').innerText = quadra;

    // Remove a classe 'selected' e estilo inline de todos os botões
    const botoes = document.querySelectorAll('.tab-button');
    botoes.forEach(button => {
        button.classList.remove('selected');
        button.style.backgroundColor = ''; // Remove estilo inline
        button.style.color = ''; // Remove estilo inline
        button.style.border = ''; // Remove estilo inline
    });

    // Adiciona a classe 'selected' e estilo inline ao botão correspondente
    botoes.forEach(button => {
        const textoBotao = button.textContent.trim();
        console.log(`Comparando "${textoBotao}" com "${quadra}"`);

        if (textoBotao === quadra) {
            button.classList.add('selected'); // Aplica a classe 'selected' para quadra selecionada
            button.style.backgroundColor = '#228B22'; // Cor verde escuro para quadra selecionada
            button.style.color = 'white'; // Texto branco
            button.style.border = '2px solid #1A6418'; // Borda escura para quadra selecionada (apenas para a verde)
        }

        // Verifica se a quadra está interditada e aplica o estilo vermelho
        if (quadrasInativas.has(button.textContent.trim())) {
            button.style.backgroundColor = 'red'; // Botão vermelho para quadras interditadas
            button.style.color = 'white'; // Texto branco
            button.style.border = ''; // Remove a borda para o botão vermelho
        }
    });

    // Atualiza o estado do domingo após selecionar a quadra
    atualizarEstadoDomingo();

    // Atualiza e exibe reservas para a quadra selecionada
    carregarReservas(quadra);
	//carregarReservas(quadra);
}



function carregarReservas(quadra) {
    console.log("Carregando reservas para:", quadra);
	
	

    celulasExcluidas.clear();
    reservasExcluidasFirebase.clear();

    const reservasRef = database.ref(`sistema/reservas/${quadra}`);

    reservasRef.off('value'); // Remove ouvintes antigos
    reservasRef.on('value', (snapshot) => {
        const reservas = snapshot.val();
        limparTabela();

        if (reservas) {
            const tabela = document.getElementById('tabelaCorpo');
            const totalRows = tabela.rows.length;
            const totalCols = tabela.rows[0]?.cells.length || 0;

            for (const key in reservas) {
                const { jogadores, dia, hora, duracao, borda } = reservas[key];
                const rowIndex = hora - 6;
                const colIndex = dia;

                if (rowIndex >= 0 && rowIndex < totalRows && colIndex >= 0 && colIndex < totalCols) {
                    const cell = tabela.rows[rowIndex].cells[colIndex];
                    cell.setAttribute("data-duracao", duracao);

                    let corFundo;
                    if (jogadores.toLowerCase().includes('aula')) {
                        corFundo = 'lightcoral';
                    } else {
                        corFundo = duracao === 1 ? 'lightgreen' : 'lightblue';
                    }
                    cell.style.backgroundColor = corFundo;

                    if (borda === '1h') {
                        cell.style.border = '2px solid black';
                    } else if (borda === '2h') {
                        configurarBordasDuracao2(cell, tabela, rowIndex, colIndex);
                    }

                    if (duracao === 2) {
                        const cellNext = tabela.rows[rowIndex + 1]?.cells[colIndex];
                        if (cellNext) {
                            const proxJogadores = reservas[`${key.split('_')[0]}_${hora + 1}`]?.jogadores;

                            // Verifica se o jogador atual é o mesmo da próxima célula
                            if (proxJogadores === jogadores) {
							    //alert("2 jogadores iguais");
                                cell.rowSpan = 2; // Une as duas células
                                cell.style.verticalAlign = 'middle';
                                cell.innerHTML = jogadores; // Exibe os jogadores na célula unida
                                cellNext.style.display = 'none'; // Oculta a próxima célula
								configurarBordasDuracao2(cell, tabela, rowIndex, colIndex);
                            } else {
                                cell.innerHTML = jogadores; // Exibe os jogadores diretamente na célula
                            }
                        }
                    } else {
                        // Reserva normal: Exibe o nome diretamente na célula
                        cell.innerHTML = jogadores;
                    }
                }
            }
        }

        // Adicionar lógica para bloquear horários de domingo
        if (vDomingo === 'fechado') {
            const diaDomingo = 7; // Índice do domingo
            const tabela = document.getElementById('tabelaCorpo');
            for (let i = 0; i < tabela.rows.length; i++) {
                const horario = i + 6; // Calcula o horário baseado na linha
                const celulaDomingo = tabela.rows[i].cells[diaDomingo];
                if (horario >= 12 && horario <= 23) {
                    celulaDomingo.style.backgroundColor = '#f2f2f2'; // Cor cinza
                    celulaDomingo.style.pointerEvents = 'none'; // Desativa interação
                    celulaDomingo.style.cursor = 'not-allowed'; // Cursor bloqueado
                }
            }
        }
		
        adicionarEventoClique();
		
    });
}





		
     console.log(" vai entrar na função validarDiaReserva DiasParaLimpar:",DiasParaLimpar);

         // Função para validar o dia da reserva
    function validarDiaReserva(jogadores) {
    // Verifica se é uma reserva de "aula" 
    if (jogadores.some(jogador => jogador.toLowerCase().includes('aula'))) {
        console.log('Reserva de "aula"  detectada. Validação de dia ignorada.');
        return true; // Permite a reserva sem validação
    }

    const diasParaLimpar = window.DiasParaLimpar; // Usar a constante global
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0); // Zerando horas para evitar problemas de comparação

    const diaSelecionado = parseInt(document.getElementById('dia').value); // Valor do select
    console.log('DiasParaLimpar:', diasParaLimpar);
    console.log('Dia selecionado:', diaSelecionado);

    let maxDiasPermitidos;
    switch (diasParaLimpar) {
        case 1: maxDiasPermitidos = 5; break;
        case 2: maxDiasPermitidos = 4; break;
        case 3: maxDiasPermitidos = 3; break;
        case 4: maxDiasPermitidos = 2; break;
        case 5: maxDiasPermitidos = 1; break;
        case 6: maxDiasPermitidos = 0; break; // Apenas para o dia atual
        default:
            console.error("Valor de DiasParaLimpar inválido.");
            return false;
    }
    console.log('Máximo de dias permitido para reserva:', maxDiasPermitidos);

    const ultimoDiaPermitido = new Date(hoje);
    ultimoDiaPermitido.setDate(hoje.getDate() + maxDiasPermitidos);
    console.log('Último dia permitido:', ultimoDiaPermitido);

    const diferencaDias = (diaSelecionado - hoje.getDay() + 7) % 7;
    const dataSelecionada = new Date(hoje);
    dataSelecionada.setDate(hoje.getDate() + diferencaDias);
    console.log('Data selecionada:', dataSelecionada);

    if (dataSelecionada > ultimoDiaPermitido || dataSelecionada < hoje) {
        const msg = gerarMensagemErro(diasParaLimpar);
        alert(msg);
        console.error('Reserva fora do intervalo permitido.');
        return false;
    }

    console.log('Reserva permitida.');
    return true;
}



// Função para gerar a mensagem de erro com base no DiasParaLimpar
function gerarMensagemErro(diasParaLimpar) {
    let diasAntecedencia;
    switch (diasParaLimpar) {
        case 1:
            diasAntecedencia = 5;
            break;
        case 2:
            diasAntecedencia = 4;
            break;
        case 3:
            diasAntecedencia = 3;
            break;
        case 4:
            diasAntecedencia = 2;
            break;
        case 5:
            diasAntecedencia = 1;
            break;
        case 6:
            return "Só é permitido fazer reservas para o dia atual.";
        default:
            return "Valor de DiasParaLimpar inválido.";
    }
	limparCampos();
    return `Não é permitido fazer reservas com mais de ${diasAntecedencia} dias de antecedência.`; 
}



        // Atualiza as opções de horário de acordo com a duração escolhida
window.atualizarOpcoesHorario = function() {
    const duracao = document.getElementById('duracao').value;
    const dia = document.getElementById('dia').value; // Obtém o valor do campo "Dia"
    const hora = document.getElementById('hora');
    hora.innerHTML = ''; // Limpa as opções anteriores

    if (!duracao || !dia) {
        console.log("Erro: Duração ou dia não definidos.");
        return; // Se o dia ou a duração não estiverem definidos, sai da função
    }

    // Verifica se o dia selecionado é domingo (dia == 7) e deve ser fechado
    if (dia == 7 && vDomingo === 'fechado') {
        // Para domingo, se a duração for de 1 hora, exclui 06:00-07:00 e 07:00-08:00
        if (duracao === '1') {
            for (let i = 8; i <= 11; i++) {
                if (i !== 6) { // Exclui 06:00-07:00
                    hora.innerHTML += `<option value="${i}">${i}:00 - ${i + 1}:00</option>`;
                }
            }
        }
        // Para domingo, se a duração for de 2 horas, exclui 06:00-08:00
        else if (duracao === '2') {
            for (let i = 8; i <= 10; i++) {
                if (i !== 6) { // Exclui 06:00-08:00
                    hora.innerHTML += `<option value="${i}">${i}:00 - ${i + 2}:00</option>`;
                }
            }
        }
    } else if (dia == 6) { // Caso para sábado (dia == 6)
        // Para sábado, se a duração for de 1 hora, exclui 06:00-07:00
        if (duracao === '1') {
            for (let i = 7; i < 21; i++) { // Inicia a partir de 07:00 e vai até 23:00
                hora.innerHTML += `<option value="${i}">${i}:00 - ${i + 1}:00</option>`;
            }
        }
        // Para sábado, se a duração for de 2 horas, exclui 06:00-08:00
        else if (duracao === '2') {
            for (let i = 7; i < 20; i++) { // Inicia a partir de 07:00 e vai até 22:00 para 2 horas
                hora.innerHTML += `<option value="${i}">${i}:00 - ${i + 2}:00</option>`;
            }
        }
    } else { // Caso para outros dias da semana
        // Caso para outros dias da semana, como segunda a sexta-feira e domingo
        if (duracao === '1') {
            for (let i = 6; i <= 22; i++) { // Horário de 06:00 até 22:00 para 1 hora
                hora.innerHTML += `<option value="${i}">${i}:00 - ${i + 1}:00</option>`;
            }
        } else if (duracao === '2') {
            for (let i = 6; i <= 21; i++) { // Horário de 06:00 até 21:00 para 2 horas
                hora.innerHTML += `<option value="${i}">${i}:00 - ${i + 2}:00</option>`;
            }
        }
    }

    // Log para verificar o que está acontecendo
    console.log(`Horários atualizados para Dia: ${dia}, Duração: ${duracao}`);
};



// Adiciona um novo campo para jogador
window.adicionarJogador = function() {
    if (jogadorCount < 4) {
        jogadorCount++; // Incrementa o contador de jogadores
        const jogadoresContainer = document.getElementById('jogadoresContainer');

        // Cria um novo div para o novo campo de entrada
        const newDiv = document.createElement('div');
        newDiv.className = 'form-row'; // Garante o alinhamento correto

        // Cria o label do campo
        const label = document.createElement('label');
        label.setAttribute('for', `jogador${jogadorCount}`);
        label.textContent = 'Jogador:';

        // Cria o campo de entrada
        const input = document.createElement('input');
        input.type = 'text';
        input.id = `jogador${jogadorCount}`;
        input.placeholder = `Nome do Jogador ${jogadorCount}`;
        input.maxLength = 20;
        input.required = true;

        // Aplica a classe 'jogador-input' para garantir o tamanho correto
        input.classList.add('jogador-input'); // Aplica o mesmo estilo

        // Adiciona o label e o input na nova linha
        newDiv.appendChild(label);
        newDiv.appendChild(input);

        // Adiciona a nova linha com o campo ao contêiner de jogadores
        jogadoresContainer.appendChild(newDiv);
		 // Define o foco no novo campo de entrada
        input.focus();
    }
};





//let quadrasInativas = new Set(); // Armazena as quadras interditadas

        // Atualiza a tabela com a nova reserva
atualizarTabela = function() {
    console.log('Iniciando a função AtualizarTabela');
	//alert("atualizarTabela");

    const jogadores = [];
	for (let i = 1; i <= jogadorCount; i++) {
		let jogador = document.getElementById(`jogador${i}`).value;

		// Substituir qualquer variação de "aula" por "aula"
		if (jogador.toLowerCase().includes('aula')) {
        jogador = 'aula';
		}

		if (jogador) {
        jogadores.push(jogador);
		}
	}

    if (jogadores.length === 0) {
        alert('Insira pelo menos 1 jogador.');
        return;
    }

    const quadra = document.getElementById('quadra').value;

    // Verifica se a quadra deve ser liberada
    
    // Verifica se a quadra está interditada
    if (quadrasInativas.has(quadra)) {
        alert(`A ${quadra} está interditada provisóriamente.`);
        limparCampos(); // Limpa os campos após exibir a mensagem
        return; // Sai imediatamente para evitar agendamento
    }

    const dia = document.getElementById('dia').value;
    const horaSelecionada = parseInt(document.getElementById('hora').value);
    const duracao = parseInt(document.getElementById('duracao').value);

    // Validações adicionais
    if (!validarDiaReserva(jogadores)) {
        return; // Sai da função se a reserva não for permitida
    }

    if (horaSelecionada < 6 || horaSelecionada > 22) {
        alert('Horário selecionado deve ser entre 6 e 22.');
        return;
    }

    const tabela = document.getElementById('tabelaCorpo');
    let horarioInicial = horaSelecionada - 6;

    console.log('Inserindo dados na tabela na linha:', horarioInicial);

    const reservasRef = database.ref(`sistema/reservas/${quadra}`);
    reservasRef.once('value', (snapshot) => { 
        const reservas = snapshot.val() || {}; // Pega os dados mais recentes
        console.log('Reservas recuperadas do Firebase:', reservas); // Log para depuração
        let horariosLivres = true;

        // Valida os horários
        for (let i = 0; i < duracao; i++) {
            const horarioChave = `${dia}_${horaSelecionada + i}`;
            console.log(`Chave: ${horarioChave}, Ocupado?:`, !!reservas[horarioChave]);
            if (reservas[horarioChave]) {
                horariosLivres = false;
                break;
            }
        }

        // Se algum horário estiver ocupado, exibe o erro e interrompe
        if (!horariosLivres) {
            alert('Um ou mais horários já estão reservados para essa quadra!');
            limparCampos();
            return;
        }

        let corFundo = jogadores.some(jogador => jogador.toLowerCase().includes('aula')) ? 'lightcoral' : (duracao === 1 ? 'lightgreen' : 'lightblue');

        // Se for 1 hora de duração
        if (duracao === 1) {
            const key = `${dia}_${horaSelecionada}`;
            const reservaData = {
                jogadores: jogadores.join(', '),
                dia: dia,
                hora: horaSelecionada,
                duracao: 1,
                borda: '1h'
            };

            reservasRef.child(key).set(reservaData)
                .then(() => console.log("Reserva salva com sucesso!"))
                .catch(error => console.error("Erro ao salvar a reserva:", error));

        } else if (duracao === 2) {
            // Se for 2 horas de duração
            if (jogadores.length === 1) {
                tabela.rows[horarioInicial].cells[dia].innerHTML = jogadores[0];
                tabela.rows[horarioInicial + 1].cells[dia].innerHTML = jogadores[0];
            } else {
			    //alert("atualizarTabela")
                if (jogadores.length >= 1) {
                    tabela.rows[horarioInicial].cells[dia].innerHTML = jogadores[0];
                }
                if (jogadores.length >= 2) {
                    tabela.rows[horarioInicial + 1].cells[dia].innerHTML = jogadores[1];
                }
                if (jogadores.length >= 3) {
                    tabela.rows[horarioInicial].cells[dia].innerHTML += `, ${jogadores[2]}`;
                }
                if (jogadores.length === 4) {
                    tabela.rows[horarioInicial + 1].cells[dia].innerHTML += `, ${jogadores[3]}`;
                }
            }

            tabela.rows[horarioInicial].cells[dia].style.backgroundColor = corFundo;
            tabela.rows[horarioInicial + 1].cells[dia].style.backgroundColor = corFundo;
            tabela.rows[horarioInicial].cells[dia].style.border = '2px solid black';

            const key1 = `${dia}_${horaSelecionada}`;
            const key2 = `${dia}_${horaSelecionada + 1}`;

            const reservaData1 = {
                jogadores: tabela.rows[horarioInicial].cells[dia].innerHTML,
                dia: dia,
                hora: horaSelecionada,
                duracao: 2,
                borda: '2h'
            };

            const reservaData2 = {
                jogadores: tabela.rows[horarioInicial + 1].cells[dia].innerHTML,
                dia: dia,
                hora: horaSelecionada + 1
            };

            reservasRef.child(key1).set(reservaData1)
                .then(() => console.log("Reserva para 1º horário salva com sucesso!"))
                .catch(error => console.error("Erro ao salvar a reserva:", error));

            reservasRef.child(key2).set(reservaData2)
                .then(() => console.log("Reserva para 2º horário salva com sucesso!"))
                .catch(error => console.error("Erro ao salvar a reserva:", error));
        }

        selecionarQuadra(quadra);
        limparCampos(); 
    });
};



// Função para adicionar evento de clique nas células
function adicionarEventoClique() {
    const tabela = document.getElementById('tabelaCorpo');

    for (let i = 0; i < tabela.rows.length; i++) {
        for (let j = 0; j < tabela.rows[i].cells.length; j++) {
            const celula = tabela.rows[i].cells[j];

            // Remove qualquer evento de clique anterior
            celula.onclick = null;

            // Ignora as células das colunas 0 e 8 (que contêm os horários)
            if (j !== 0 && j !== 8) {
                celula.onclick = function () {
                    if (celula.innerHTML !== "") {
                        // Verifica se o conteúdo da célula é "aula"
                        const mensagem = celula.innerHTML.trim().toLowerCase() === "aula"
                            ? "Você quer excluir esta aula?"
                            : "Você quer excluir esta reserva?";

                        const confirmacao = confirm(mensagem);
                        if (confirmacao) {
                            excluirReserva(i, j); // Passa a posição da célula
                        }
                    }
                };
            }
        }
    }
}





// Variável global para rastrear células já excluídas
const celulasExcluidas = new Set();

function excluirReserva(horaIndex, diaIndex) {
    const tabela = document.getElementById('tabelaCorpo');
    const celulaId = `${horaIndex}_${diaIndex}`;

    // Evita duplicidade de exclusão
    if (celulasExcluidas.has(celulaId)) {
        return;
    }

    const primeiraCelula = tabela.rows[horaIndex].cells[diaIndex];
    const duracao = primeiraCelula.getAttribute('data-duracao');

    // Verifica se é uma reserva de 2 horas para limpar duas células ao mesmo tempo
    if (duracao === "2") {
        const segundaCelula = tabela.rows[horaIndex + 1]?.cells[diaIndex];

        // Utiliza requestAnimationFrame para garantir que ambas as células sejam atualizadas imediatamente
        requestAnimationFrame(() => {
            limparCelula(primeiraCelula);
            limparCelula(segundaCelula);
        });
		
		  // Restaurar células mescladas e limpar corretamente
        if (primeiraCelula.rowSpan === 2) {
            primeiraCelula.rowSpan = 1; // Remove a mesclagem
            if (segundaCelula) {
                segundaCelula.style.display = ''; // Restaura a visibilidade da célula oculta
            }
        }

        // Exclusão no Firebase ocorre sem afetar a visualização do usuário
        excluirReservaFirebase(horaIndex + 6, diaIndex, quadraSelecionada);
        excluirReservaFirebase(horaIndex + 7, diaIndex, quadraSelecionada);
    } else if (duracao === "1") {
        // Reserva de 1 hora
        requestAnimationFrame(() => {
            limparCelula(primeiraCelula);
        });

        excluirReservaFirebase(horaIndex + 6, diaIndex, quadraSelecionada);
    }

    celulasExcluidas.add(celulaId);
	
	// Atualizar a interface após a exclusão
    carregarReservas(quadraSelecionada);
}


// Função para limpar o conteúdo da célula
function limparCelula(celula) {
    if (celula) {
        celula.innerHTML = ""; // Limpa o conteúdo da célula
        celula.style.backgroundColor = ""; // Restaura a cor de fundo
        celula.style.border = "1px solid #ddd"; // Restaura a borda padrão
        celula.removeAttribute('data-duracao'); // Remove o atributo de duração
		 // Remover rowSpan apenas se a reserva for de 2 horas e tiver apenas um jogador
        if (celula.rowSpan === 2) {
           ////celula.removeAttribute('rowSpan'); // Remove o rowSpan para restaurar as células separadas
		   celula.rowSpan = 1; // Restaura o rowSpan para o padrão
        }
    }
}


const reservasExcluidasFirebase = new Set();

function excluirReservaFirebase(horaSelecionada, diaIndex, quadra) {
    const key = `${diaIndex}_${horaSelecionada}`;

    if (!reservasExcluidasFirebase.has(key)) {
        reservasExcluidasFirebase.add(key);
        database.ref(`sistema/reservas/${quadra}/${key}`).remove()
            .then(() => {
                console.log(`Reserva removida com sucesso do Firebase para ${quadra}, chave=${key}`);
                reservasExcluidasFirebase.delete(key);

                // Atualiza a interface após a exclusão
                //carregarReservas(quadra);
            })
            .catch((error) => console.error(`Erro ao remover a reserva do Firebase: ${error}`));
    }
}

function salvarEstadoQuadras() {
    const estado = Array.from(quadrasInativas); // Converte o Set em Array para salvar no Firebase
    database.ref('estadoQuadras/').set({ interditadas: estado })
        .then(() => console.log("Estado das quadras salvo com sucesso no Firebase!"))
        .catch(error => console.error("Erro ao salvar estado das quadras:", error));
}





        function limparCampos() {
            // Não reseta o campo "Jogador 1" e mantém o seu valor
            const jogadoresContainer = document.getElementById('jogadoresContainer');
            while (jogadoresContainer.children.length > 1) {
                jogadoresContainer.removeChild(jogadoresContainer.lastChild); // Remove apenas os campos de jogador adicionais
            }
            jogadorCount = 1; // Reseta o contador de jogadores para 1
            document.getElementById('dataForm').reset(); // Reseta o formulário
            document.getElementById('jogador1').value = ''; // Mantém o campo "Jogador 1"
            document.getElementById('duracao').value = '1'; // Reseta a duração para 1 hora
            atualizarOpcoesHorario(); // Atualiza as opções de horário
        }


   
// Monitora as alterações no Firebase
const reservasRef = database.ref('sistema/reservas/' + quadraSelecionada);
reservasRef.off('value'); // Remove ouvintes anteriores
reservasRef.on('value', (snapshot) => {

console.log("Atualização recebida do Firebase:", snapshot.val());

    const reservas = snapshot.val();
	
limparTabela(); // Limpa toda a tabela antes de preencher com dados atualizados

    if (reservas) {
        for (const key in reservas) {
            const { jogadores, dia, hora, duracao, borda } = reservas[key];
            const rowIndex = hora - 6;

            // Atualiza a célula com os jogadores recuperados do Firebase
            document.getElementById('tabelaCorpo').rows[rowIndex].cells[dia].innerHTML = jogadores;

            // Aplicar a cor de fundo e bordas com base nos dados
            let corFundo;
			if (jogadores.toLowerCase().includes('aula') ) {
				corFundo = 'lightcoral';
			} else {
				corFundo = duracao === 1 ? 'lightgreen' : 'lightblue';
			}
			const cell = document.getElementById('tabelaCorpo').rows[rowIndex]?.cells[dia]; // Encontre a célula específica
			if (cell) { // Verifique se a célula foi encontrada
				cell.style.backgroundColor = corFundo;
			}



            document.getElementById('tabelaCorpo').rows[rowIndex].cells[dia].style.backgroundColor = corFundo;

            // Aplicar bordas
            if (borda === '1h') {
                document.getElementById('tabelaCorpo').rows[rowIndex].cells[dia].style.border = '2px solid black';
            } else if (borda === '2h') {
                document.getElementById('tabelaCorpo').rows[rowIndex].cells[dia].style.borderTop = '2px solid black';
                document.getElementById('tabelaCorpo').rows[rowIndex].cells[dia].style.borderLeft = '2px solid black';
                document.getElementById('tabelaCorpo').rows[rowIndex].cells[dia].style.borderRight = '2px solid black';
                document.getElementById('tabelaCorpo').rows[rowIndex].cells[dia].style.borderBottom = 'none';

                document.getElementById('tabelaCorpo').rows[rowIndex + 1].cells[dia].style.borderTop = 'none';
                document.getElementById('tabelaCorpo').rows[rowIndex + 1].cells[dia].style.borderLeft = '2px solid black';
                document.getElementById('tabelaCorpo').rows[rowIndex + 1].cells[dia].style.borderRight = '2px solid black';
                document.getElementById('tabelaCorpo').rows[rowIndex + 1].cells[dia].style.borderBottom = '2px solid black';
            }
        }

        // Após recuperar as reservas, adicionar eventos de clique nas células
        adicionarEventoClique();
    }
});





function atualizarDatas() {
    console.log("atualizarDatas foi chamada"); 
	
    const dataInicio = new Date();
    let diaDaSemana = dataInicio.getDay(); 
    const dias = document.querySelectorAll("th");
    console.log("Células selecionadas:", dias);

    const linhaDatas = dias[0].parentNode.nextElementSibling;

    // Limpa os dados dos dias anteriores com base em `DiasParaLimpar`
    try {
        LimparDiasAnteriores(); // Chama a função de limpeza com log para analisar a execução
    } catch (error) {
        console.error("Erro ao chamar LimparDiasAnteriores:", error);
    }
	
	
	//alert(`atualizarDatas:\nvDomingo: ${vDomingo}\nDiasParaLimpar: ${window.DiasParaLimpar}`);
	
    switch (DiasParaLimpar) {
        case 1:
            switch (diaDaSemana) {
                case 0: preencherCeldas(dataInicio, [1, 2, 3, 4, 5, -1, 0], linhaDatas); break;
                case 1: preencherCeldas(dataInicio, [0, 1, 2, 3, 4, 5, -1], linhaDatas); break;
                case 2: preencherCeldas(dataInicio, [-1, 0, 1, 2, 3, 4, 5], linhaDatas); break;
                case 3: preencherCeldas(dataInicio, [5, -1, 0, 1, 2, 3, 4], linhaDatas); break;
                case 4: preencherCeldas(dataInicio, [4, 5, -1, 0, 1, 2, 3], linhaDatas); break;
                case 5: preencherCeldas(dataInicio, [3, 4, 5, -1, 0, 1, 2], linhaDatas); break;
                case 6: preencherCeldas(dataInicio, [2, 3, 4, 5, -1, 0, 1], linhaDatas); break;
            }
            break;
        case 2:
            switch (diaDaSemana) {
                case 0: preencherCeldas(dataInicio, [1, 2, 3, 4, -2, -1, 0], linhaDatas); break;
                case 1: preencherCeldas(dataInicio, [0, 1, 2, 3, 4, -2, -1], linhaDatas); break;
                case 2: preencherCeldas(dataInicio, [-1, 0, 1, 2, 3, 4, -2], linhaDatas); break;
                case 3: preencherCeldas(dataInicio, [-2, -1, 0, 1, 2, 3, 4], linhaDatas); break;
                case 4: preencherCeldas(dataInicio, [4, -2, -1, 0, 1, 2, 3], linhaDatas); break;
                case 5: preencherCeldas(dataInicio, [3, 4, -2, -1, 0, 1, 2], linhaDatas); break;
                case 6: preencherCeldas(dataInicio, [2, 3, 4, -2, -1, 0, 1], linhaDatas); break;
            }
            break;
        case 3:
            switch (diaDaSemana) {
                case 0: preencherCeldas(dataInicio, [1, 2, 3, -3, -2, -1, 0], linhaDatas); break;
                case 1: preencherCeldas(dataInicio, [0, 1, 2, 3, -3, -2, -1], linhaDatas); break;
                case 2: preencherCeldas(dataInicio, [-1, 0, 1, 2, 3, -3, -2], linhaDatas); break;
                case 3: preencherCeldas(dataInicio, [-2, -1, 0, 1, 2, 3, -3], linhaDatas); break;
                case 4: preencherCeldas(dataInicio, [-3, -2, -1, 0, 1, 2, 3], linhaDatas); break;
                case 5: preencherCeldas(dataInicio, [3, -3, -2, -1, 0, 1, 2], linhaDatas); break;
                case 6: preencherCeldas(dataInicio, [2, 3, -3, -2, -1, 0, 1], linhaDatas); break;
            }
            break;
        case 4:
            switch (diaDaSemana) {
                case 0: preencherCeldas(dataInicio, [1, 2, -4, -3, -2, -1, 0], linhaDatas); break;
                case 1: preencherCeldas(dataInicio, [0, 1, 2, -4, -3, -2, -1], linhaDatas); break;
                case 2: preencherCeldas(dataInicio, [-1, 0, 1, 2, -4, -3, -2], linhaDatas); break;
                case 3: preencherCeldas(dataInicio, [-2, -1, 0, 1, 2, -4, -3], linhaDatas); break;
                case 4: preencherCeldas(dataInicio, [-3, -2, -1, 0, 1, 2, -4], linhaDatas); break;
                case 5: preencherCeldas(dataInicio, [-4, -3, -2, -1, 0, 1, 2], linhaDatas); break;
                case 6: preencherCeldas(dataInicio, [2, -4, -3, -2, -1, 0, 1], linhaDatas); break;
            }
            break;
        case 5:
            switch (diaDaSemana) {
                case 0: preencherCeldas(dataInicio, [1, -5, -4, -3, -2, -1, 0], linhaDatas); break;
                case 1: preencherCeldas(dataInicio, [0, 1, -5, -4, -3, -2, -1], linhaDatas); break;
                case 2: preencherCeldas(dataInicio, [-1, 0, 1, -5, -4, -3, -2], linhaDatas); break;
                case 3: preencherCeldas(dataInicio, [-2, -1, 0, 1, -5, -4, -3], linhaDatas); break;
                case 4: preencherCeldas(dataInicio, [-3, -2, -1, 0, 1, -5, -4], linhaDatas); break;
                case 5: preencherCeldas(dataInicio, [-4, -3, -2, -1, 0, 1, -5], linhaDatas); break;
                case 6: preencherCeldas(dataInicio, [-5, -4, -3, -2, -1, 0, 1], linhaDatas); break;
            }
            break;
        case 6:
            switch (diaDaSemana) {
                case 0: preencherCeldas(dataInicio, [-6, -5, -4, -3, -2, -1, 0], linhaDatas); break;
                case 1: preencherCeldas(dataInicio, [0, -6, -5, -4, -3, -2, -1], linhaDatas); break;
                case 2: preencherCeldas(dataInicio, [-1, 0, -6, -5, -4, -3, -2], linhaDatas); break;
                case 3: preencherCeldas(dataInicio, [-2, -1, 0, -6, -5, -4, -3], linhaDatas); break;
                case 4: preencherCeldas(dataInicio, [-3, -2, -1, 0, -6, -5, -4], linhaDatas); break;
                case 5: preencherCeldas(dataInicio, [-4, -3, -2, -1, 0, -6, -5], linhaDatas); break;
                case 6: preencherCeldas(dataInicio, [-5, -4, -3, -2, -1, 0, -6], linhaDatas); break;
            }
            break;
    }
}

// Função para preencher as células de datas, ignorando a primeira célula
function preencherCeldas(dataInicio, ajustes, linhaDatas) {
    for (let i = 0; i < ajustes.length; i++) {
        let novaData = new Date(dataInicio);
        novaData.setDate(dataInicio.getDate() + ajustes[i]);
		
		// Adiciona log para verificar a célula sendo preenchida
        console.log(`Preenchendo célula ${i + 1} com a data: ${novaData.toLocaleDateString('pt-BR')}`);
		
        linhaDatas.children[i].innerHTML = novaData.toLocaleDateString('pt-BR');
    }
}

function LimparDiasAnteriores() {
    console.log("Executando LimparDiasAnteriores para as três quadras");

    const dataAtual = new Date();
    dataAtual.setHours(0, 0, 0, 0); // Zerando horas para comparação exata

    const quadras = ["Quadra 1 - Coberta", "Quadra 2 - Aberta", "Quadra 3 - Coberta"];
    const tabela = document.getElementById('tabelaCorpo'); // Acessa a tabela

    quadras.forEach(quadra => {
        console.log(`Limpando dados da ${quadra}`);
        for (let dia = 1; dia <= DiasParaLimpar; dia++) {
            const dataParaLimpar = new Date(dataAtual);
            dataParaLimpar.setDate(dataAtual.getDate() - dia);
            const diaIndex = dataParaLimpar.getDay() || 7; // Trata domingo como 7

            for (let hora = 6; hora < 22; hora++) {
                const horaIndex = hora - 6; // Calcula o índice correto da linha
                const key = `${diaIndex}_${hora}`;

    // Ignorar sábado (coluna 6) das 06:00 às 07:00 e das 21:00 às 23:00 e domingo (coluna 7) das 06:00 às 08:00
	if ((diaIndex === 6 && hora === 6) || (diaIndex === 7 && hora >= 6 && hora <= 8) || (diaIndex === 6 && hora >= 21 && hora <= 23)) {
    // Pule estas células sem realizar qualquer operação
    console.log(`Ignorando célula: dia ${diaIndex}, hora ${hora}`);
    continue; 
}


                // Verifica a reserva no Firebase antes de remover
                const reservaRef = database.ref(`sistema/reservas/${quadra}/${key}`);
                reservaRef.once('value', (snapshot) => {
                    const reserva = snapshot.val();
                    if (reserva) {
                        const { jogadores } = reserva;
                        // Verifica se a reserva contém "aula"
                        if (jogadores && (jogadores.toLowerCase().includes('aula'))) {
                            console.log(`Reserva de "${jogadores}" não será removida.`);
                            return; // Sai da função de callback
                        }
                        // Remove a célula da interface e do Firebase
                        const celula = tabela.rows[horaIndex]?.cells[diaIndex];
                        if (celula) {
                            limparCelula(celula); // Função que limpa a célula na interface
                        }
                        reservaRef.remove()
                            .then(() => console.log(`Reserva removida com sucesso do Firebase para ${quadra}, chave=${key}`))
                            .catch(error => console.error(`Erro ao remover a reserva do Firebase: ${error}`));
                    }
                }, (error) => {
                    console.error(`Erro ao verificar a reserva do Firebase para ${key}: ${error}`);
                });
            }
        }
    });
}




function abrirManual() {
    window.open('manual.html', '_blank');
	
}



window.onload = function() {
    verificarVersao();
	
    const loadingElement = document.getElementById('loading');
    const contentElement = document.getElementById('content');

    // Verifique se os elementos existem
    if (!loadingElement || !contentElement) {
        console.error('Erro: elementos não encontrados!');
        return;
    }

    // Exibe a tela de carregamento
    loadingElement.style.display = 'block';
    contentElement.style.display = 'none';

    console.log('Inicializando sistema...');

    // Inicializa o sistema
    InicializarSistema()
        .then(() => {
            console.log('Sistema inicializado, exibindo conteúdo...');
            // Esconde a tela de "Carregando" e exibe o conteúdo
            loadingElement.style.display = 'none';
            contentElement.style.display = 'block';
    
        })
        .catch(error => {
            console.error("Erro ao inicializar o sistema:", error);
            // Exibe uma mensagem de erro se a Promise for rejeitada
        });
};

 
document.addEventListener('DOMContentLoaded', () => {
    const tabelaContainer = document.querySelector('.tabela-container');
    
    // Variável para controlar o estado de expansão
    let isExpanded = false;  // Inicia como falso, o que significa que o valor é 10px inicialmente

    tabelaContainer.addEventListener('dblclick', (event) => {
        // Verifica se o elemento clicado é uma célula (TH ou TD)
        const target = event.target;

        if ((target.tagName === 'TH' || target.tagName === 'TD') && target.innerText.includes('Horários')) {
            // Alterna o estado de expansão
            if (isExpanded) {
                // Se já estiver expandido, restaura para 10px
                tabelaContainer.style.marginTop = "10px";
            } else {
                // Se não estiver expandido, coloca margin-top em 70px
                tabelaContainer.style.marginTop = "70px";
            }

            // Alterna o estado
            isExpanded = !isExpanded;
            
            // Opcional: Se quiser adicionar uma classe para efeito de expansão, pode usar
            tabelaContainer.classList.toggle('fullscreen');
        }
    });
});



</script>



<body>

<div id="loading" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem;">
    Carregando... Aguarde.
</div>


<!-- Conteúdo da página (inicialmente oculto) -->
<div id="content" style="display: none;">

<div class="tab-container" style="display: flex; justify-content: center; margin-bottom: 10px;">
    <button class="tab-button" onclick="selecionarQuadra('Quadra 1 - Coberta')">Quadra 1 - Coberta</button>
    <button class="tab-button" onclick="selecionarQuadra('Quadra 2 - Aberta')">Quadra 2 - Aberta</button>
    <button class="tab-button" onclick="selecionarQuadra('Quadra 3 - Coberta')">Quadra 3 - Coberta</button>
</div>



<div id="VersaoSistema" style="text-align: right; margin-top: 80px; font-size: 1rem; color: #555; cursor: pointer; position: relative; z-index: 9999;" onclick="abrirManual()">
    
</div>






<div class="form-container">
    <form id="dataForm">
	
	    <div class="form-row">
			<label for="quadra">Quadra:</label>
			<select id="quadra">
				<option value="Quadra 1 - Coberta">Quadra 1 - Coberta</option>
				<option value="Quadra 2 - Aberta">Quadra 2 - Aberta</option>
				<option value="Quadra 3 - Coberta">Quadra 3 - Coberta</option>
			</select>
		</div>



        <div class="form-row">
            <label for="dia">Dia:</label>
            <select id="dia" style="width: 5px !important;" onchange="atualizarOpcoesHorario()">
				<option value="1">Segunda-Feira</option>
				<option value="2">Terça-Feira</option>
				<option value="3">Quarta-Feira</option>
				<option value="4">Quinta-Feira</option>
				<option value="5">Sexta-Feira</option>
				<option value="6">Sábado</option>
				<option value="7">Domingo</option>
			</select>

        </div>

        <div class="form-row">
            <label for="duracao">Duração:</label>
            <select id="duracao" onchange="atualizarOpcoesHorario()">
                <option value="1">1 hora</option>
                <option value="2">2 horas</option>
            </select>
        </div>

        <div class="form-row">
            <label for="hora">Horário:</label>
            <select id="hora">
                <!-- As opções de horário serão ajustadas pelo JavaScript -->
            </select>
        </div>

        <div class="jogadores-container" id="jogadoresContainer">
            <div class="form-row">
                <label for="jogador1">Jogador:</label>
                <input type="text" id="jogador1" name="jogador" placeholder="Nome do Jogador 1" maxlength="20" required style="width: 100px;" >
                <span class="add-jogador" onclick="adicionarJogador()">+</span>
            </div>
        </div>

        <button type="button" onclick="atualizarTabela()">Agendar</button>
    </form>
</div>

<div style="display: flex; justify-content: space-between; align-items: center;">
    <h2 class="header" style="margin: 1;">Quadra 1 - Coberta</h2> <!-- Título à esquerda -->
    
    <!-- Legenda de Cores -->
    <div style="margin-left: 20px; text-align: left;">
        <strong>Legenda:</strong>
        <ul style="list-style-type: none; padding: 0; margin: 0;">
            <li>
                <span style="display: inline-block; width: 20px; height: 20px; background-color: lightgreen; margin-right: 5px;"></span>
                1 Hora
            </li>
            <li>
                <span style="display: inline-block; width: 20px; height: 20px; background-color: lightblue; margin-right: 5px;"></span>
                2 Horas
            </li>
			<li>
                <span style="display: inline-block; width: 20px; height: 20px; background-color: lightcoral; margin-right: 5px;"></span>
                aula
            </li>
			<li>
              <a href="regras.html" class="regras-link">
               Regras
              </a>
           </li>
        </ul>
    </div>
</div>

<div class="tabela-container">
<table id="tabelaQuadra" style="width: 100%; margin-top: 10px;">
    <tr>
        <th rowspan="2" style="text-align: center;">Horários</th>
        <th>Segunda-Feira</th>
        <th>Terça-Feira</th>
        <th>Quarta-Feira</th>
        <th>Quinta-Feira</th>
        <th>Sexta-Feira</th>
        <th>Sábado</th>
        <th>Domingo</th>
        <th rowspan="2" style="text-align: center;">Horários</th>
    </tr>
    <tr style="background-color: #f2f2f2;">
        <td style="font-weight: bold; font-size: 0.9em;">09/10/24</td>
        <td style="font-weight: bold; font-size: 0.9em;">10/10/24</td>
        <td style="font-weight: bold; font-size: 0.9em;">11/10/24</td>
        <td style="font-weight: bold; font-size: 0.9em;">12/10/24</td>
        <td style="font-weight: bold; font-size: 0.9em;">13/10/24</td>
        <td style="font-weight: bold; font-size: 0.9em;">14/10/24</td>
        <td style="font-weight: bold; font-size: 0.9em;">15/10/24</td>
    </tr>
    <tbody id="tabelaCorpo">
        <tr>
			<td>06:00 - 07:00</td>
			<td></td><td></td><td></td><td></td><td></td>
			<td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Sábado -->
			<td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
			<td>06:00 - 07:00</td>
		</tr>
		<tr>
			<td>07:00 - 08:00</td>
			<td></td><td></td><td></td><td></td><td></td>
			<td></td>
			<td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
			<td>07:00 - 08:00</td>
		<tr>
            <td>08:00 - 09:00</td>
            <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td>08:00 - 09:00</td>
        </tr>
        <tr>
            <td>09:00 - 10:00</td>
            <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td>09:00 - 10:00</td>
        </tr>
        <tr>
            <td>10:00 - 11:00</td>
            <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td>10:00 - 11:00</td>
        </tr>
        <tr>
            <td>11:00 - 12:00</td>
            <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td>11:00 - 12:00</td>
        </tr>
        <!-- Horários bloqueados para domingo -->
        <tr>
            <td>12:00 - 13:00</td>
            <td></td><td></td><td></td><td></td><td></td><td></td>
            <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td>
            <td>12:00 - 13:00</td>
        </tr>
        <tr>
            <td>13:00 - 14:00</td>
            <td></td><td></td><td></td><td></td><td></td><td></td>
            <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td>
            <td>13:00 - 14:00</td>
        </tr>
        <tr>
            <td>14:00 - 15:00</td>
            <td></td><td></td><td></td><td></td><td></td><td></td>
            <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td>
            <td>14:00 - 15:00</td>
        </tr>
        <tr>
            <td>15:00 - 16:00</td>
            <td></td><td></td><td></td><td></td><td></td><td></td>
            <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td>
            <td>15:00 - 16:00</td>
        </tr>
        <tr>
            <td>16:00 - 17:00</td>
            <td></td><td></td><td></td><td></td><td></td><td></td>
            <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td>
            <td>16:00 - 17:00</td>
        </tr>
        <tr>
            <td>17:00 - 18:00</td>
            <td></td><td></td><td></td><td></td><td></td><td></td>
            <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td>
            <td>17:00 - 18:00</td>
        </tr>
        <tr>
            <td>18:00 - 19:00</td>
            <td></td><td></td><td></td><td></td><td></td><td></td>
            <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td>
            <td>18:00 - 19:00</td>
        </tr>
        <tr>
            <td>19:00 - 20:00</td>
            <td></td><td></td><td></td><td></td><td></td><td></td>
            <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td>
            <td>19:00 - 20:00</td>
        </tr>
        <tr>
            <td>20:00 - 21:00</td>
            <td></td><td></td><td></td><td></td><td></td><td></td>
            <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td>
            <td>20:00 - 21:00</td>
        </tr>
        <tr>
			<td>21:00 - 22:00</td>
			<td></td><td></td><td></td><td></td><td></td>
			<td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Sábado -->
			<td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
			<td>21:00 - 22:00</td>
		</tr>
        <tr>
			<td>22:00 - 23:00</td>
			<td></td><td></td><td></td><td></td><td></td>
			<td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Sábado -->
			<td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
			<td>22:00 - 23:00</td>
		</tr>
    </tbody>
</table>
</div>
</div>
</body>
<footer style="text-align: center; margin-top: 20px; font-size: 0.9em; color: #555;">
        Desenvolvido por Ronaldo Taborda
    </footer>
</html>
