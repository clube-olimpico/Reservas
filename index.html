<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Clube Ol√≠mpico - Sistema de Reservas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
	<!-- Configura√ß√µes para evitar cache -->
    <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="expires" content="0">

<style>
/* Estilos globais */
body {
    font-family: Arial, sans-serif;  
    margin: 0;
    padding: 0; 
}

    /* Container da tela de login */ 
    #loginScreen {
	box-sizing: border-box; /* Garantir que padding e borda sejam inclu√≠dos na largura */   
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #ffffff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    width: 95%;
    max-width: 350px;
    text-align: center; 
	z-index: 1000; /* ADICIONE ESTA LINHA */
}

/* Cabe√ßalho da tela de login */
#loginHeader {
    margin-bottom: 30px;  
}

#loginHeader h1 {
    font-size: 32px; 
    color: #333;
    margin: 0;
}

#loginHeader h2 {
    font-size: 24px;
    color: #555;
    margin: 10px 0;
}

#loginHeader h3 {
    font-size: 24px;
    color: #777;
    margin: 40px 0;
}

.input-group {
    display: flex;
    align-items: center; /* Alinha os elementos verticalmente */
    gap: 10px;
    width: 100%;
}

.label-senha {
    white-space: nowrap; /* Impede que o texto do label quebre em v√°rias linhas */
    font-weight: bold;
}


.input-container {
    position: relative; /* Permite posicionamento absoluto do bot√£o */
    display: flex;
    align-items: center;
    gap: 5px;
    width: 100%; /* Ocupa toda a largura dispon√≠vel */
}


/* Campo de entrada de senha */
.input-container input {
    width: 280%;
    padding-right: 150px; /* Espa√ßo para o bot√£o √† direita */
	padding: 12px 16px; /* Padding vertical e horizontal */
    box-sizing: border-box;
	height: 35px; /* Altura menor */
}

/* Bot√£o de alternar senha */
#toggleSenha {
    position: right; /* Posicionamento absoluto dentro do container */
    top: 50%; /* Centraliza verticalmente */
    right: 100px; /* Ajuste este valor para mover o bot√£o mais para a esquerda */
    transform: translateY(-50%); /* Centraliza verticalmente */
    background: none;
    border: none;
    cursor: pointer;
    font-size: 18px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
	max-width: 10%;
}


    /* T√≠tulo */
    #loginScreen h2 {
        margin-bottom: 20px;
        font-size: 24px;
        color: #333; 
    }

    /* Dropdown de sele√ß√£o de jogadores */
    #jogadorSelect {
        width: 100%;
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    /* Bot√£o de entrar */
    #loginScreen button {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 10px 20px;
        font-size: 16px;
        border-radius: 5px;
        cursor: pointer;
        width: 100%;
		margin-top: 20px; /* Adiciona espa√ßo entre o √∫ltimo campo e o bot√£o */
    }

    #loginScreen button:hover {
        background-color: #45a049;
    }

    /* Conte√∫do principal (inicialmente oculto) */
    #mainContent {
        display: none;
        text-align: center;
    }

    /* Mensagem de boas-vindas */
    #nomeJogador {
        font-weight: bold;
        color: #4CAF50;
    }

    /* Bot√£o de sair */
    #mainContent button {
        background-color: #f44336;
        color: white;
        border: none;
        padding: 10px 20px;
        font-size: 16px;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 20px;
    }

    #mainContent button:hover {
        background-color: #d32f2f;
    }


/* Cont√™iner principal do formul√°rio */
.form-container {
    padding: 10px;
    margin: 0 auto;
    max-width: 500px;
    margin-top: -5px; /* Espa√ßamento para evitar sobreposi√ß√£o com a barra fixa */
}

/* Configura√ß√£o das linhas do formul√°rio */
.form-row {
    display: flex;
    align-items: center;
    margin-bottom: 7px;
    flex-wrap: nowrap; /* Mant√©m label e input na mesma linha */
}

/* Estiliza√ß√£o dos labels */
label {
    margin-right: 10px;
    width: 160px; /* Tamanho fixo do label para alinhamento */
    font-size: 1rem;
}

/* Configura√ß√£o do campo "Nome do Jogador" */
.jogador-input {
    width: 50px; /* Largura fixa para manter consist√™ncia */
    box-sizing: border-box; /* Inclui padding e bordas no c√°lculo da largura */
    margin: 0;
    padding: 5px;
}


/* Ajusta o tamanho do select de jogadores */
    #jogador1 {
        width: 100% !important;
        max-width: 313px;
    }
	#jogador2 {
        width: 100% !important;
        max-width: 330px;
    }
	#jogador3 {
        width: 100% !important;
        max-width: 330px;
    }
	#jogador4 {
        width: 100% !important;
        max-width: 300px;
    }

/* Responsividade: ajuste para dispositivos m√≥veis */
@media (max-width: 600px) {

.motivo-resultado {
    text-align: center;
    font-size: 0.9em;
    font-style: italic;
    color: #666;
    margin-top: 10px;
    margin-bottom: 0;
}
body.dark-mode .motivo-resultado {
    color: #ccc;
}

/* --- AJUSTE PARA O FORMUL√ÅRIO DE W.O. NO CELULAR (SUGEST√ÉO 2) --- */
#wo-controls .form-row {
    flex-wrap: nowrap; /* Impede que a linha quebre */
    justify-content: flex-start; /* Alinha o conte√∫do √† esquerda */
}

#wo-controls .form-row label {
    white-space: nowrap; /* Impede que o texto do label quebre */
    font-size: 0.9em; /* Reduz um pouco o tamanho da fonte para caber */
}

/* Aumenta o espa√ßo vertical entre as linhas de confronto no modal de INFORMAR resultado */
#modalResultadoDuplas .duplas-match-container {
    margin-bottom: 20px;
}


	#modal-resultado-placar .matchup-row {
    margin-bottom: 13px; /* Aumenta o espa√ßo vertical. Ajuste o valor como desejar. */
}

/* DENTRO de @media (max-width: 600px) */

/* Ajusta o tamanho dos campos de tie-break para ficarem iguais aos de placar no celular */
#modalResultadoDuplas .tiebreak-container input[type="number"] {
    width: 30px !important;
    height: 30px;
    font-size: 1.0em;
    /* O padding e outros estilos ser√£o herdados, mas podemos garantir aqui se necess√°rio */
    padding: 2px 4px;
    box-sizing: border-box;
}

	/* 2. Aumenta o tamanho dos campos de placar e dos n√∫meros */
	.score-input {
		width: 20px !important; 
		height: 20px;
		font-size: 1.2em;
	}

/* ADICIONE ESTA NOVA REGRA NO LUGAR DA ANTIGA */
#modal-resultado-placar .team-names {
    font-size: 0.85em; /* Reduz o tamanho da fonte para 85% do normal */
}

    .matchup-row {
        padding: 0px !important;
    }

	
     th, td {
        display: table-cell;
		vertical-align: middle; /* Mant√©m o texto alinhado no meio */
		padding: 20px 4px;
        font-size: 18px; /* Opcional: reduz o tamanho da fonte para melhor ajuste */
    }

    .jogador-input {
        width: 100% !important; /* Campo ocupa toda a largura dispon√≠vel */
        max-width: 175px; /* Limita a largura m√°xima */
    }

    /* Aumenta a largura dos campos de entrada em dispositivos m√≥veis */
    input, select, button {
        width: 100% !important; /* Faz com que os campos ocupem toda a largura dispon√≠vel */
        max-width: 400px; /* Define uma largura m√°xima para evitar que fiquem muito largos */
    }

    /* Ajusta o tamanho do select de jogadores */
    #jogador1 {
        width: 100% !important;
        max-width: 193px;
    }
	#jogador2 {
        width: 100% !important;
        max-width: 210px;
    }
	#jogador3 {
        width: 100% !important;
        max-width: 210px;
    }
	#jogador4 {
        width: 100% !important;
        max-width: 210px;
    }

    /* Ajusta o tamanho do select de quadra */
    #quadra {
        width: 100% !important;
        max-width: 210px;
    }

    /* Ajusta o tamanho do select de dia */
    #dia {
        width: 100% !important;
        max-width: 210px;
    }

    /* Ajusta o tamanho do select de dura√ß√£o */
    #duracao {
        width: 100% !important;
        max-width: 210px;
    }

    /* Ajusta o tamanho do select de hor√°rio */
    #hora {
        width: 100% !important;
        max-width: 210px;
    }
	.horario {
        padding: 5px 4px;
        height: 25px;
        line-height: 1;
		font-size: 16px; /* Opcional: reduz o tamanho da fonte para melhor ajuste */
    }
	
	#theme-toggle-button {
		width: 50px !important; /* For√ßa a largura correta, sobrescrevendo a regra geral */
		height: 50px !important; /* Garante a altura para formar o c√≠rculo */
	}
	
	/* Aumenta o tamanho dos campos de tie-break especificamente no celular */
    .tiebreak-container input {
        width: 35px !important; 
    }
	
	
}


/* Estiliza√ß√£o geral para inputs, selects e bot√µes */
input, select, button {
    flex-grow: 1;
    padding: 5px;
    font-size: 1rem;
}

/* Cont√™iner de jogadores (campos din√¢micos) */
.jogadores-container {
    display: flex;
    flex-direction: column;
    margin-top: 0px;
}

/* Bot√£o de adicionar jogador */
.add-jogador {
    font-size: 2rem;
    cursor: pointer;
    color: blue;
    margin-top: 1px;
}

/* Estiliza√ß√£o dos bot√µes */
button {
    background-color: #4CAF50;
    color: white;
    border: none;
    cursor: pointer;
    width: 100%;
    padding: 9px;
    margin-top: 1px;
    margin-bottom: -10px;
}

button:hover {
    background-color: #45a049;
}

/* Cont√™iner para as abas de navega√ß√£o */
.tab-container {
    display: flex;
    justify-content: center;
    margin-bottom: 10px;
    position: fixed; /* Fixa as abas no topo */
    top: 0;
    left: 0;
    width: 100%;
    background-color: white; /* Destaque visual */
    z-index: 1000;
    padding: 3px;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1); /* Adiciona uma sombra */
}

/* Configura√ß√£o para tabelas */
.tabela-container {
    overflow-x: auto; /* Permite rolagem horizontal */
    width: 100%;
    margin-top: -10px;
}

table {
    width: 100%;
    margin-top: 20px;
    border-collapse: collapse;
}

th, td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
    white-space: nowrap; /* Impede a quebra de linha */
    overflow: hidden; /* Evita que o conte√∫do transborde */
    text-overflow: ellipsis; /* Adiciona "..." caso o texto seja muito longo */
	height: 10px; /* Ajuste a altura conforme necess√°rio */
	display: table-cell;
}


th {
    background-color: #f2f2f2;
}

/* Estilo para cabe√ßalho */
.header {
    text-align: center;
    font-size: 1.5rem;
    margin-top: 20px;
    margin-bottom: 10px;
    text-indent: 10px; /* Ajuste o valor para o espa√ßamento desejado */
	/* --- LINHAS ADICIONADAS --- */
    -webkit-user-select: none; /* Para Safari e Chrome no iOS */
    -moz-user-select: none;    /* Para Firefox */
    -ms-user-select: none;     /* Para Internet Explorer/Edge */
    user-select: none;         /* Padr√£o oficial */
}

/* Classe para aba selecionada */
.selected {
    font-weight: bold;
    background-color: #228B22;
    color: white;
}

/* Transi√ß√£o de opacidade */
.fade-out {
    transition: opacity 0.3s ease-out;
    opacity: 0;
}

/* Estiliza√ß√£o dos bot√µes de aba */
.tab-button {
    position: relative; /* Adiciona posicionamento relativo para o efeito da linha */
    transition: background-color 0.3s ease;
    background-color: #4CAF50;
    color: white;
    border: none;
    padding: 5px 20px;
    margin: 5px;
    cursor: pointer;
}

/* Linha inferior do bot√£o selecionado */
.tab-button.selected::after {
    content: "";
    display: block;
    width: 100%;
    height: 3px;
    background-color: #228B22;
    position: absolute;
    bottom: -8px;
    left: 0;
}

.tab-button:hover {
    background-color: #45a049;
}

/* Bot√£o de aba desabilitado */
.tab-button[disabled] {
    cursor: not-allowed;
    background-color: red;
}

.tab-button.selected {
/* Aba selecionada */
    font-weight: bold;
    background-color: #228B22 !important;
    color: white !important;
    border: 2px solid #1A6418 !important;
}

/* Indicadores de carregamento */
#loading {
    display: block;
    text-align: center;
    font-size: 1.5rem;
}

#content {
    display: none;
}

/* Estiliza√ß√£o para tela cheia */
.fullscreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: white;
    z-index: 9999;
    overflow: auto;
}

.fullscreen table {
    width: 100%;
    height: auto;
}



/*****************************************/
/****** Estilos para o Modo Escuro *******/
/*****************************************/

body.dark-mode {
    background-color: #121212;
    color: #ffffff;
}

body.dark-mode .form-container,
body.dark-mode #loginScreen {
    background-color: #1e1e1e;
    box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1);
}

body.dark-mode #loginScreen {
    background-color: #2a2a2a; /* Um cinza um pouco mais claro que o fundo */
    border: 1px solid #444;    /* Uma borda sutil para definir a caixa */
    color: #f1f1f1;            /* Define o texto padr√£o como branco */
}

/* Garante que o texto dos labels e t√≠tulos fique branco */
body.dark-mode #loginScreen h2,
body.dark-mode #loginScreen .label-senha {
    color: #f1f1f1;
}

/* Estilo para o t√≠tulo principal "Clube Ol√≠mpico" */
body.dark-mode #loginHeader h1 {
    color: #ffc107; /* Amarelo/Laranja para destaque, como em outros lugares */
    text-shadow: 0 0 8px rgba(255, 193, 7, 0.5); /* Adiciona um brilho sutil */
}

/* Estilo para o subt√≠tulo "Quadras de T√™nis" */
body.dark-mode #loginHeader h2 {
    color: #ccc; /* Mant√©m o cinza claro */
}

/* Estilo para o t√≠tulo "Sistema de Reservas" */
body.dark-mode #loginHeader h3 {
    color: #007bff; /* Traz o azul de volta! */
    text-shadow: 0 0 5px rgba(0, 123, 255, 0.5); /* Adiciona um brilho sutil azul */
}

/* Garante que os campos de input e select tenham o estilo escuro correto */
body.dark-mode #loginScreen #jogadorSelect,
body.dark-mode #loginScreen #senha {
    background-color: #333;
    color: #fff;
    border: 1px solid #555;
}

body.dark-mode h1,
body.dark-mode h2,
body.dark-mode h3 {
    color: #ffffff;
}

body.dark-mode input,
body.dark-mode select {
    background-color: #333333;
    color: #ffffff;
    border-color: #555555;
}

body.dark-mode button,
body.dark-mode .tab-button {
    background-color: #333333;
    color: #ffffff;
}

body.dark-mode button:hover,
body.dark-mode .tab-button:hover {
    background-color: #444444;
}

body.dark-mode .tab-button.selected {
    background-color: #005f00 !important;
}

body.dark-mode .header {
    color: #ffffff;
}

body.dark-mode table,
body.dark-mode th,
body.dark-mode td {
    border-color: #444444;
}

body.dark-mode th {
    background-color: #333333;
}

/* Cor espec√≠fica para #f2f2f2 no modo escuro */
body.dark-mode .f2f2f2-dark,
body.dark-mode [style*="background-color: rgb(242, 242, 242)"],
body.dark-mode [style*="background-color: #f2f2f2"] {
    background-color: #555555 !important;
}

#theme-toggle-button {
    position: fixed; /* Posi√ß√£o fixa em rela√ß√£o √† janela do navegador */
    bottom: 20px;    /* 20 pixels da parte inferior */
    right: 20px;     /* 20 pixels da parte direita */
    width: 50px;     /* Largura do bot√£o */
    height: 50px;    /* Altura do bot√£o */
    border-radius: 50%; /* Deixa o bot√£o redondo */
    background-color: #333;
    color: white;
    border: none;
    font-size: 24px; /* Tamanho do √≠cone/texto */
    cursor: pointer;
    z-index: 1001;   /* Garante que o bot√£o fique sobre outros elementos */
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

#theme-toggle-button:hover {
    background-color: #555;
}

/* Ajuste para o modo escuro, se desejar uma cor diferente para o bot√£o */
body.dark-mode #theme-toggle-button {
    background-color: #f1f1f1;
    color: #121212;
}

body.dark-mode #theme-toggle-button:hover {
    background-color: #dcdcdc;
}


/* Estilo espec√≠fico para o bot√£o "Agendar" no modo escuro */
body.dark-mode #botaoAgendar {
    background-color: blue;
    color: white; /* Garante que o texto "Agendar" permane√ßa branco e leg√≠vel */
}

/* Efeito opcional para quando passar o mouse sobre o bot√£o */
body.dark-mode #botaoAgendar:hover {
    background-color: #0000CD; /* Um tom de azul um pouco mais escuro */
}

/* Define o fundo opaco para a tela cheia no modo escuro */
body.dark-mode .fullscreen {
    background-color: #121212; /* A mesma cor do fundo do modo escuro */
}

/* Cor da vers√£o do sistema no modo escuro */
body.dark-mode #VersaoSistema {
    color: RoyalBlue;
}

/* Corrige bordas das c√©lulas espec√≠ficas bloqueadas manualmente no modo escuro */
body.dark-mode td[style*="background-color: #f2f2f2"],
body.dark-mode td[style*="background-color: rgb(242, 242, 242)"] {
    border: 1px solid #ffffff !important;
}

/* Bloco novo e corrigido */
body.dark-mode .modal-content {
    background-color: #333333; /* Um cinza mais claro para destacar o modal */
    color: #f1f1f1;            /* Texto principal um pouco mais suave que branco puro */
    border: 1px solid #555555; /* Uma borda sutil para definir a janela */
} 

body.dark-mode .modal-content h3 {
    color: #ffffff; /* Garante que o t√≠tulo fique branco e vis√≠vel */
}


body.dark-mode #loading {
    background-color: #121212 !important; /* Fundo escuro para combinar com o tema */
    color: #ffffff !important;           /* Garante que o texto seja branco e vis√≠vel */
}

/* Estilo para a caixa de resumo no modal de confirma√ß√£o */
.resumo-partida {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    background-color: #f9f9f9;
    text-align: center;
}

/* Estilo da mesma caixa para o modo escuro */
body.dark-mode .resumo-partida {
    background-color: #424242; /* Fundo cinza escuro */
    border-color: #555;      /* Borda sutil */
    color: #f1f1f1;          /* Texto claro */
}


/* ========================================================== */
/* fim do modo escuro */
/* ========================================================== */


/* Estilos para o Modal de Convites */
.modal-overlay {
    display: none; /* Come√ßa invis√≠vel */
    position: fixed; /* Cobre a tela inteira */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6); /* Fundo preto semitransparente */
    backdrop-filter: blur(5px); /* Efeito de desfoque que voc√™ pediu */
    z-index: 2000; /* Garante que fique na frente de tudo */
    justify-content: center;
    align-items: center;
}

.modal-content {
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    width: 90%;
    max-width: 500px; /* Mesma largura da sua caixa de convites */
    box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
}

.modal-content-reserva {
    background-color: white;
    padding: 20px 30px;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    position: relative;
    color: #333;
}

.modal-content-reserva h3 {
    margin-top: 0;
    text-align: center;
    color: #228B22;
	margin-bottom: 1px;
}

.modal-content-reserva p {
    margin: 5px 0;
    line-height: 1.5;
}

.modal-content-reserva hr {
    border: none;
    border-top: 1px solid #eee;
    margin: 15px 0;
}

.close-button {
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 28px;
    font-weight: bold;
    color: #aaa;
    cursor: pointer;
}

.close-button:hover {
    color: #333;
}

/* Estilos para os nomes dos jogadores no modal */
#modal-jogadores ul {
    list-style: none;
    padding-left: 0;
    margin: 0;
}

#modal-jogadores li {
    padding: 5px 0;
    border-bottom: 1px solid #f0f0f0;
}
#modal-jogadores li:last-child {
    border-bottom: none;
}

/* Estilos para o status de confirma√ß√£o */
.status-confirmado {
    color: green;
    font-weight: bold;
    margin-left: 8px;
}
.status-pendente {
    color: orange;
    font-weight: bold;
    margin-left: 8px;
}
.status-recusado {
    color: red;
    font-weight: bold;
    margin-left: 8px;
}

/* Ajustes para o Modo Escuro */
body.dark-mode .modal-content-reserva {
    background-color: #2a2a2a;
    color: #f1f1f1;
    border: 1px solid #555;
}

body.dark-mode .modal-content-reserva h3 {
    color: #4CAF50;
}

body.dark-mode .close-button {
    color: #888;
}
body.dark-mode .close-button:hover {
    color: #f1f1f1;
}
body.dark-mode #modal-jogadores li {
    border-bottom-color: #444;
}

/* COLE ESTE C√ìDIGO DENTRO DA SUA TAG <style> */

/* Estilos para os bot√µes dentro do novo modal de a√ß√µes */
.modal-content button {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
}

/* Modo escuro para os bot√µes do novo modal */
body.dark-mode .modal-content button {
    color: white; /* Garante que o texto seja branco em todos os bot√µes no modo escuro */
}

/* Ajusta o espa√ßamento do bot√£o de cancelar */
#btnModalCancelar {
    margin-top: 0;
}

/* ADICIONE ESTE NOVO BLOCO DE ESTILOS DENTRO DA SUA TAG <style> */

.edit-jogador-row {
    display: flex;
    align-items: center;
    gap: 0px; /* Controla o espa√ßo entre os itens */
    margin-bottom: 10px;
}

.edit-jogador-row select {
    flex-grow: 1;
    margin-right: 10px;
}

.remove-jogador-btn {
    cursor: pointer;
    color: red;
    font-size: 24px;
    font-weight: bold;
    padding: 0px;
}

/* Estilo base para o texto de status (computador) */
.edit-status-span {
    width: 85px; /* 
    text-align: left;
    font-size: 14px;
    font-weight: bold;
    flex-shrink: 0; /* Impede que o texto encolha */
}

/* Desabilita a sele√ß√£o de texto nas c√©lulas da planilha de reservas */ 
#tabelaCorpo td {
    -webkit-user-select: none; /* Safari */
    -moz-user-select: none;    /* Firefox */
    -ms-user-select: none;     /* IE 10+ e Edge */
    user-select: none;         /* Padr√£o */
}


/* ================================================== */
/* ====== ESTILOS PARA O CART√ÉO DE ANIVERS√ÅRIO ====== */
/* ================================================== */

#birthdayModalContent {
    background: linear-gradient(145deg, #6a11cb 0%, #2575fc 100%);
    color: white;
    padding: 25px 30px;
    border-radius: 15px;
    width: 90%;
    max-width: 420px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    text-align: center;
    position: relative;
    border: 3px solid rgba(255, 255, 255, 0.8);
    animation: jelly-bounce 0.8s ease-out;
}

@keyframes jelly-bounce {
  from, to { transform: scale(1, 1); }
  25% { transform: scale(0.9, 1.1); }
  50% { transform: scale(1.1, 0.9); }
  75% { transform: scale(0.95, 1.05); }
}

#birthdayModalContent h2 {
    margin-top: 10px;
    font-size: 2.2em;
    font-weight: bold;
    text-shadow: 2px 2px 5px rgba(0,0,0,0.5);
}

#birthdayModalContent p {
    font-size: 1.1em;
    line-height: 1.5;
}

#closeBirthdayModal {
    background-color: white;
    color: #2575fc;
    border: none;
    padding: 12px 30px;
    font-size: 1.1em;
    font-weight: bold;
    border-radius: 50px;
    cursor: pointer;
    margin-top: 15px;
    transition: all 0.2s ease-in-out;
    width: auto !important;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

#closeBirthdayModal:hover {
    transform: scale(1.05);
    background-color: #f0f0f0;
}

/* Estilo para o "selo" da idade */
.birthday-badge {
    position: absolute;
    top: -25px;
    right: -20px;
    background-color: #ffc107;
    color: #333;
    width: 70px;
    height: 70px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8em;
    font-weight: bold;
    border: 3px solid white;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    transform: rotate(15deg);
}


/* ================================================== */
/* Estilos para o novo placar de resultado */
/* ================================================== */
/* --- IN√çCIO DO BLOCO DE CSS PARA O PLACAR --- */

/* Estilo para a posi√ß√£o do jogador no placar */
.placar-posicao {
    font-size: 0.8em; /* Menor que o nome */
    color: #888; /* Cor mais suave */
    margin-right: 8px; /* Espa√ßamento entre a posi√ß√£o e o nome */
    width: 25px; /* Largura fixa para alinhamento */
    text-align: right; /* Alinha o n√∫mero √† direita */
    flex-shrink: 0; /* Impede que seja espremido */
}
body.dark-mode .placar-posicao {
    color: #bbb; /* Cor mais suave no modo escuro */
}

/* Estilos para o novo placar de resultado */
.placar-container {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size: 1.2em; 
    line-height: 1.6;
}
.placar-row {
    display: flex;
    align-items: center;
    padding: 4px 0;
    border-bottom: 1px solid #eee;
}
body.dark-mode .placar-row {
    border-bottom: 1px solid #444; 
}
.placar-row:last-child {
    border-bottom: none;
}
.placar-nome {
    font-weight: normal;
    flex-grow: 1; /* Pede para o nome ocupar o espa√ßo extra */
}
.placar-sets {
    display: flex;
    gap: 15px; 
    font-weight: bold; 
}
.set-score {
    width: 30px; 
    text-align: center;
    color: #888; 
}
body.dark-mode .set-score {
    color: #aaa;
}
.set-score.winner {
    color: #333; 
    font-weight: 900; 
}
body.dark-mode .set-score.winner {
    color: #fff;
}
.set-score sup {
    font-size: 0.7em;
    vertical-align: super;
    margin-left: -2px;
    font-weight: normal; 
}


#modal-resultado-placar .placar-container {
    margin-top: 10px;
}

/* --- FIM DO BLOCO DE CSS PARA O PLACAR --- */
/* ================================================== */
/* final de Estilos para o novo placar de resultado */
/* ================================================== */


/* ================================================== */
/* --- Estilos para o Modal de Resultado de Duplas --- */
.matchup-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 0;
    border-bottom: 1px solid #eee;
}
.matchup-row:last-child {
    border-bottom: none;
}
.team-names {
    font-size: 1em;
    font-weight: bold;
    text-align: center;
    flex-basis: 40%; /* Define a largura das colunas dos nomes */
}
.score-input-container {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-basis: 20%; /* Define a largura da coluna do placar */
    justify-content: center;
}
.score-input {
    width: 50px; /* Mesmo tamanho da pir√¢mide */
    text-align: center;
    font-size: 1em; /* Tamanho de fonte padr√£o, sem aumento */
    font-weight: normal; /* Remove o negrito */
    padding: 5px;
    border: 1px solid #ccc;
    border-radius: 4px;
}

/* Ajustes para o modo escuro */
body.dark-mode .matchup-row {
    border-bottom-color: #444;
}
body.dark-mode #duplasJogadoresInfo {
    color: #aaa;
}
body.dark-mode .score-input {
    background-color: #333;
    color: white;
    border-color: #555;
}

.score-column {
    display: flex;
    flex-direction: column; /* Empilha os itens verticalmente */
    align-items: center;    /* Centraliza os itens horizontalmente */
    flex-basis: 20%;        /* Ocupa o espa√ßo central */
}

/* --- Estilo para os par√™nteses do Tie-Break --- */
.tiebreak-paren {
    font-size: 1.1em;   /* Aumenta o tamanho da fonte do par√™ntesis */
    font-weight: normal;
    color: #888;
    display: inline-flex;
    align-items: center;
}
body.dark-mode .tiebreak-paren {
    color: #aaa;
}

/* Adicione esta nova regra para diminuir os campos do tie-break */
.tiebreak-container input[type="number"] {
    height: 20px;       /* Diminui a altura do campo */
    font-size: 0.9em;   /* Diminui a fonte do n√∫mero */
    padding: 2px 4px;   /* Ajusta o espa√ßamento interno */
}

/* ---  fim de Estilos para o Modal de Resultado de Duplas --- */
/* ================================================== */


#VersaoSistema {
    position: relative; /* Necess√°rio para que o z-index funcione */
    z-index: 1001;      /* Um valor alto, mas MENOR que o z-index dos modais (2000) */
}



/* Estilo para o fundo desfocado da p√°gina inteira */
.page-overlay {
    display: none; /* Come√ßa oculto */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6); /* Usa o mesmo fundo dos outros modais */
    backdrop-filter: blur(5px); /* O efeito de desfoque */
    z-index: 999; /* Fica atr√°s da janela de login, mas na frente do resto */
}



/* Estilos para a tela de bloqueio de vers√£o */
#versao-desatualizada-overlay {
    display: none; /* Come√ßa oculto */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(20, 20, 20, 0.9);
    backdrop-filter: blur(8px);
    z-index: 99999; /* Fica na frente de absolutamente tudo */
    justify-content: center;
    align-items: center;
    text-align: center;
    color: white;
}

#versao-desatualizada-overlay .mensagem-overlay {
    padding: 20px;
    border-radius: 10px;
    background-color: rgba(0, 0, 0, 0.4);
}

#versao-desatualizada-overlay h1 {
    color: #ffc107; /* Amarelo para destaque */
}



/* ================================================== */
/* --- ESTILOS PARA O MENU DE OP√á√ïES DO RESULTADO --- */
/* ================================================== */

/* Bot√£o de √≠cone (3 pontos) */
#btn-mais-opcoes {
    position: absolute;
    top: 50%;
    right: 0;
    transform: translateY(-50%);
    background: none;
    border: none;
    font-size: 28px;
    line-height: 1;
    font-weight: bold;
    cursor: pointer;
    color: #888;
    padding: 0 10px;
    width: auto !important; /* Sobrescreve regras gerais de bot√£o */
}
#btn-mais-opcoes:hover {
    color: #333;
}
body.dark-mode #btn-mais-opcoes {
    color: #aaa;
}
body.dark-mode #btn-mais-opcoes:hover {
    color: #fff;
}

/* O menu suspenso (dropdown) */
.menu-dropdown {
    display: none; /* Come√ßa oculto */
    position: absolute;
    top: 100%; /* Posiciona abaixo do cabe√ßalho */
    right: 0;
    background-color: white;
    border: 1px solid #ddd;
    border-radius: 5px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    z-index: 10;
    width: 200px;
}
body.dark-mode .menu-dropdown {
    background-color: #444;
    border-color: #666;
}

/* Itens dentro do menu */
.menu-dropdown a {
    display: block;
    padding: 10px 15px;
    color: #333;
    text-decoration: none;
    font-size: 1rem;
}
body.dark-mode .menu-dropdown a {
    color: #f1f1f1;
}
.menu-dropdown a:hover {
    background-color: #f5f5f5;
}
body.dark-mode .menu-dropdown a:hover {
    background-color: #555;
}

/* Classe para mostrar o menu */
.menu-dropdown.visivel {
    display: block;
}


/* ================================================================ */
/* --- ESTILOS FINAIS PARA A EXIBI√á√ÉO DO PLACAR (NEGRITO E RET) --- */
/* ================================================================ */

/* Estilo unificado para o NOME do vencedor da partida em qualquer tela */
.placar-nome.match-winner,
#modal-resultado-placar .placar-nome.match-winner {
    font-weight: 900 !important; /* Garante o negrito m√°ximo em todos os locais */
    color: #333;
}

/* Garante que a cor do nome do vencedor no modo escuro seja branca */
body.dark-mode .placar-nome.match-winner,
body.dark-mode #modal-resultado-placar .placar-nome.match-winner {
    color: #fff;
}



/* Estilo para a tag [RET] de desist√™ncia */
.ret-indicator {
    display: inline-block;
    background-color: #dc3545; /* Vermelho */
    color: white;
    font-size: 0.6em;
    font-weight: bold;
    padding: 2px 5px;
    border-radius: 3px;
    margin-right: 10px;
    vertical-align: middle;
}

/* Estilo para os inputs de placar quando desabilitados */
#placar-fields-container input:disabled {
    background-color: #f0f0f0; /* Fundo cinza claro */
    cursor: not-allowed;
}

body.dark-mode #placar-fields-container input:disabled {
    background-color: #3a3a3a; /* Fundo cinza escuro para o modo escuro */
}

/* Container para alinhar os bot√µes Salvar/Cancelar lado a lado */
.botoes-acao-container {
    display: flex;
    justify-content: center; /* Centraliza o par de bot√µes */
    gap: 15px; /* Cria um espa√ßo de 15px entre os bot√µes */
    margin-top: 20px; /* Mant√©m o espa√ßo acima dos bot√µes */
}

/* Ajuste para que os bot√µes no container n√£o ocupem 100% da largura */
.botoes-acao-container button {
    width: auto !important; /* Permite que o bot√£o tenha a largura do seu conte√∫do */
    padding: 10px 25px; /* Aumenta o espa√ßo interno para um visual melhor */
}


.motivo-resultado {
    text-align: center;
    font-size: 0.9em;
    font-style: italic;
    color: #666;
    margin-top: 10px;
    margin-bottom: 0;
}
body.dark-mode .motivo-resultado {
    color: #ccc;
}

</style>


</head>


<body> 

 <!-- Tela de carregamento -->
    <div id="pageOverlay" class="page-overlay"></div> <div id="loading" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem; background-color: white; width: 100%; height: 100vh; display: flex; align-items: center; justify-content: center; z-index: 9999;">
        Carregando... Aguarde.
    </div>

<!-- Tela de Login -->
<div id="loginScreen">
    <!-- Cabe√ßalho com as informa√ß√µes do clube -->
    <div id="loginHeader">
        <h1>Clube Ol√≠mpico</h1>
        <h2>Quadras de T√™nis</h2>
        <h3>Sistema de Reservas</h3>
    </div>

    <!-- Painel de sele√ß√£o de jogadores -->
    <div id="loginForm">
        <h2>Selecione seu nome:</h2>
        <div class="input-group">
            <select id="jogadorSelect">
                <option value="">Carregando jogadores...</option>
            </select>
        </div>
        
       <div class="input-container">
    <label for="senha" class="label-senha">Senha:</label>
    <input type="password" id="senha" placeholder="Digite sua senha" inputmode="numeric" pattern="[0-9]*" maxlength="8">
    <button type="button" id="toggleSenha">üëÅÔ∏è</button>
</div>
        
        <button onclick="fazerLogin()">Entrar</button>
    </div>
</div>

<!-- Conte√∫do Principal -->
<div id="mainContent" style="display: none; text-align: center;">
    <h2>Bem-vindo, <span id="nomeJogador"></span>!</h2>
    <button onclick="fazerLogout()">Sair</button>
</div>


<!-- Conte√∫do da p√°gina (inicialmente oculto) -->
<div id="content" style="display: none;">

<div class="tab-container" style="display: flex; justify-content: center; margin-bottom: 10px;">
    <button class="tab-button" onclick="selecionarQuadra('Quadra 1 - Coberta')">Quadra 1 - Coberta</button>
    <button class="tab-button" onclick="selecionarQuadra('Quadra 2 - Aberta')">Quadra 2 - Aberta</button>
    <button class="tab-button" onclick="selecionarQuadra('Quadra 3 - Coberta')">Quadra 3 - Coberta</button>
</div>



<div id="VersaoSistema" style="text-align: right; margin-top: 70px; margin-right: 10px; font-size: 1rem; cursor: default; position: relative; z-index: 1001;">
    
</div>


 

 

<div class="form-container">
    <form id="dataForm">
	
	    <div class="form-row">
			<label for="quadra">Quadra:</label>
			<select id="quadra" onchange="selecionarQuadra(this.value)">
				<option value="Quadra 1 - Coberta">Quadra 1 - Coberta</option>
				<option value="Quadra 2 - Aberta">Quadra 2 - Aberta</option>
				<option value="Quadra 3 - Coberta">Quadra 3 - Coberta</option>
			</select>
		</div>



        <div class="form-row">
            <label for="dia">Dia:</label>
            <select id="dia"  onchange="atualizarOpcoesHorario()">
				<option value="1">Segunda-Feira</option>
				<option value="2">Ter√ßa-Feira</option>
				<option value="3">Quarta-Feira</option>
				<option value="4">Quinta-Feira</option>
				<option value="5">Sexta-Feira</option>
				<option value="6">S√°bado</option>
				<option value="7">Domingo</option>
			</select>

        </div>

        <div class="form-row">
			<label for="duracao">Dura√ß√£o:</label>
			<select id="duracao" onchange="atualizarOpcoesHorario()">
			<option value="1">1 hora</option>
			<option value="2">2 horas</option>
			<option value="3-piramide" style="display: none;">Pir√¢mide</option> <!-- Op√ß√£o inicialmente oculta -->
			</select>
		</div>
		

        <div class="form-row">
            <label for="hora">Hor√°rio:</label>
            <select id="hora">
                <!-- As op√ß√µes de hor√°rio ser√£o ajustadas pelo JavaScript -->  
            </select>
        </div>

        <div class="jogadores-container" id="jogadoresContainer">
			<div class="form-row">
				<label for="jogador1">Jogador:</label>
				<select id="jogador1" name="jogador" required style="width: 100px;">
					<option value="">Selecione um jogador</option>
				</select>
				<span class="add-jogador" onclick="adicionarJogador()">+</span>
			</div>
		</div>

        <button id="botaoAgendar" type="button" onclick="atualizarTabela()">Agendar</button>
    </form>
</div>


<div id="modalConvites" class="modal-overlay">
    <div class="modal-content">
        <div id="convites-pendentes-container">
            <h3 style="margin-top: 0; text-align: center;">Meus Convites Pendentes</h3>
            <ul id="lista-convites" style="list-style: none; padding: 0;">
                </ul>
        </div>
    </div>
</div>



<div id="modalResultadoPiramide" class="modal-overlay">
    <div class="modal-content">
        <div style="position: relative; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
            <h3 style="margin-top: 0; margin-bottom: 0; text-align: center;">Resultado da Pir√¢mide</h3>
            
            <button id="btn-mais-opcoes" type="button" title="Mais Op√ß√µes">‚ãÆ</button>

            <div id="menu-opcoes-resultado" class="menu-dropdown">
				<a href="#" id="acao-jogo-normal">Jogo Normal</a>
				<a href="#" id="acao-wo">W.O.</a>
				<a href="#" id="acao-desistencia">Desist√™ncia</a>
			</div>
        </div>
        
        <h4 id="resultado-matchup" style="text-align: center; margin-top:-10px; margin-bottom: 15px;">Jogador 1 vs. Jogador 2</h4>

        <div id="placar-fields-container">
            <div class="form-row" style="justify-content: center; align-items: center; gap: 5px;">
                <label style="width: auto;">1¬∫ Set:</label>
                <input type="number" id="set1-j1" style="width: 50px; text-align: center;" min="0">
                <span>&times;</span>
                <input type="number" id="set1-j2" style="width: 50px; text-align: center;" min="0">
                
                <div class="tiebreak-container" id="tiebreak1-container" style="display: none; margin-left: 10px; align-items: center; gap: 5px;">
                    <span>(</span>
                    <input type="number" id="tb1-j1" style="width: 40px; text-align: center;" min="0" oninput="this.value=this.value.slice(0,2)">
                    <span>-</span>
                    <input type="number" id="tb1-j2" style="width: 40px; text-align: center;" min="0" oninput="this.value=this.value.slice(0,2)">
                    <span>)</span>
                </div>
            </div>

            <div class="form-row" style="justify-content: center; align-items: center; gap: 5px;">
                <label style="width: auto;">2¬∫ Set:</label>
                <input type="number" id="set2-j1" style="width: 50px; text-align: center;" min="0">
                <span>&times;</span>
                <input type="number" id="set2-j2" style="width: 50px; text-align: center;" min="0">

                <div class="tiebreak-container" id="tiebreak2-container" style="display: none; margin-left: 10px; align-items: center; gap: 5px;">
                    <span>(</span>
                    <input type="number" id="tb2-j1" style="width: 40px; text-align: center;" min="0" oninput="this.value=this.value.slice(0,2)">
                    <span>-</span>
                    <input type="number" id="tb2-j2" style="width: 40px; text-align: center;" min="0" oninput="this.value=this.value.slice(0,2)">
                    <span>)</span>
                </div>
            </div>

            <div id="terceiro-set-container" class="form-row" style="justify-content: center; align-items: center; gap: 10px; display: none;">
                <label style="width: auto;">3¬∫ Set:</label>
                <input type="number" id="set3-j1" style="width: 50px; text-align: center;" min="0" oninput="this.value=this.value.slice(0,2)">
                <span>&times;</span>
                <input type="number" id="set3-j2" style="width: 50px; text-align: center;" min="0" oninput="this.value=this.value.slice(0,2)">
            </div>
        </div>

        <div id="wo-controls" style="display: none; text-align: center; margin-bottom: 15px;">
            <div class="form-row" style="justify-content: center;">
                <label for="select-vencedor-wo" style="width: auto; margin-right: 10px;">Vencedor:</label>
                <select id="select-vencedor-wo" style="width: 180px !important;"></select>
            </div>
            <div class="form-row" style="justify-content: center; margin-top: 10px;">
                <label for="select-motivo-wo" style="width: auto; margin-right: 10px;">Motivo:</label>
                <select id="select-motivo-wo" style="width: 180px !important;">
                    <option value="">Selecione o motivo</option>
                    <option value="N√£o comparecimento">N√£o comparecimento</option>
                    <option value="Les√£o ou Doen√ßa (pr√©-jogo)">Les√£o ou Doen√ßa (pr√©-jogo)</option>
                    <option value="Desist√™ncia do Torneio">Desist√™ncia do Torneio</option>
                    <option value="Desqualifica√ß√£o">Desqualifica√ß√£o</option>
                </select>
            </div>
        </div>

        <div id="desistencia-controls" style="display: none; text-align: center; margin-bottom: 15px;">
             <div class="form-row" style="justify-content: center;">
                <label for="select-desistente" style="width: auto; margin-right: 10px;">Quem desistiu?</label>
                <select id="select-desistente" style="width: 180px !important;"></select>
            </div>
            <div class="form-row" style="justify-content: center; margin-top: 10px;">
                <label for="select-motivo-desistencia" style="width: auto; margin-right: 10px;">Motivo:</label>
                <select id="select-motivo-desistencia" style="width: 180px !important;">
                    <option value="">Selecione o motivo</option>
                    <option value="Les√£o">Les√£o</option>
                    <option value="Doen√ßa">Doen√ßa</option>
                    <option value="Fadiga extrema">Fadiga extrema</option>
                    <option value="Motivos pessoais">Motivos pessoais</option>
                </select>
            </div>
        </div>
        
        <div style="text-align: center; margin-bottom: 15px;">
            <a href="#" id="link-voltar-placar" style="display: none; font-size: 0.9em;">Voltar a inserir placar</a>
        </div>

        <hr style="border: none; border-top: 1px solid #eee; margin: 20px 0;">

        <p style="text-align: center; font-size: 1.1em;"><strong id="label-vencedor-final">Vencedor:</strong> <span id="resultado-vencedor" style="color: green; font-weight: bold;">-</span></p>
        
        <div class="botoes-acao-container">
			<button id="btnSalvarResultado" style="background-color: #28a745;">Salvar Resultado</button>
			<button id="btnCancelarResultado" style="background-color: #6c757d;">Cancelar</button>
		</div>
    </div>
</div>







<div style="display: flex; justify-content: space-between; align-items: center;">
    <h2 class="header" style="margin: 1; font-size: 20px;">Quadra 1 - Coberta</h2> <!-- T√≠tulo √† esquerda -->

    
    <div id="legenda" style="margin-left: 20px; margin-right: 10px; text-align: left; margin-bottom: 10px;">
    <strong style="font-size: 14px;">Legenda:</strong>
    <div style="display: flex; flex-direction: column; gap: 5px;">
        <!-- Primeira linha: 1 Hora e 2 Horas -->
        <div id="linha-1" style="display: flex; align-items: center;">
            <span style="display: inline-block; width: 15px; height: 17px; background-color: lightgreen; margin-right: 2px;"></span>
            <span style="font-size: 12px;">1 Hora</span>
            <span style="display: inline-block; width: 15px; height: 18px; background-color: lightblue; margin-right: 2px; margin-left: 10px;"></span>
            <span style="font-size: 12px;">2 Horas</span>
        </div>
        <!-- Segunda linha: Aula e Pir√¢mide -->
        <div id="linha-2" style="display: flex; align-items: center;">
            <span style="display: inline-block; width: 15px; height: 18px; background-color: lightcoral; margin-right: 5px;"></span>
            <span style="font-size: 12px;">Aula</span>
            <span id="piramide-span" style="display: inline-block; width: 15px; height: 18px; background-color: #FFEB99 ; margin-left: 19px; margin-right: 1px;"></span>
            <span id="piramide-text" style="font-size: 12px;">Pir√¢mide</span>
        </div>
    </div>
	</div>
</div>

<div id="modalDetalhesReserva" class="modal-overlay">
    <div class="modal-content-reserva">
        <span class="close-button" onclick="fecharModalDetalhes()">&times;</span>
        <h3>Detalhes da Reserva</h3>
        <p><strong>Quadra:</strong> <span id="modal-quadra"></span></p>
        <p><strong>Dia:</strong> <span id="modal-dia"></span></p>
        <p><strong>Data:</strong> <span id="modal-data"></span></p>
        <p><strong>Hor√°rio:</strong> <span id="modal-horario"></span></p>
        <p><strong>Dura√ß√£o:</strong> <span id="modal-duracao"></span></p>
        <p><strong>Status:</strong> <span id="modal-status"></span></p>
        <p><strong>Organizador(a):</strong> <span id="modal-organizador"></span></p>
        <hr>
        <p style="margin-bottom: 2px;margin-top: -10px;"><strong>Jogadores</strong></p>
        <div id="modal-jogadores">
            </div>

        <div id="modal-resultado-container" style="display: none; margin-top: 15px;">
			<hr>
			<p style="margin-bottom: 0px;margin-top: -10px;"><strong>Resultado do Jogo:</strong></p>
			<div id="modal-resultado-placar">
				</div>
		</div>
        </div>
    </div>
</div>


<div id="modalAcoesReserva" class="modal-overlay">
    <div class="modal-content">
        <h3 style="margin-top: 0; text-align: center;">O que deseja fazer?</h3>
        
        <button id="btnModalVer" style="background-color: #007bff;">Ver Detalhes</button>
        <button id="btnModalEditar" style="background-color: #ffc107; color: black;">Editar Jogadores</button>
		<button id="btnModalResultadoDuplas" style="background-color: #28a745; display: none;">Informar Resultado</button>
        <button id="btnModalExcluir" style="background-color: #dc3545;">Excluir Reserva</button>
        
        <hr style="border: none; border-top: 1px solid #eee; margin: 15px 0;">
        
        <button id="btnModalCancelar" style="background-color: #6c757d;">Cancelar</button>
    </div>
</div> 



<div id="modalEdicaoReserva" class="modal-overlay">
    <div class="modal-content">
        <span class="close-button" onclick="fecharModalEdicao()">&times;</span>
        <h3 style="margin-top: 0; text-align: center;">Editar Jogadores da Reserva</h3>
        
        <div id="edit-jogadores-container">
            </div>

        <button id="btnAdicionarJogadorEdicao" style="background-color: #17a2b8; margin-top: 15px;">Adicionar Jogador</button>
        
        <hr style="border: none; border-top: 1px solid #eee; margin: 20px 0;">
        
        <button id="btnSalvarEdicao" style="background-color: #28a745;">Salvar Altera√ß√µes</button>
    </div>
</div>

<div id="modalConfirmacaoResultado" class="modal-overlay">
    <div class="modal-content">
        <h3 style="margin-top: 0; text-align: center;">Confirma√ß√£o de Resultado</h3>
        
        
        <div id="resumo-partida-confirmacao" class="resumo-partida">
            </div>
        
        <div id="placar-informado-confirmacao" style="margin: 15px 0;">
            </div>
        
        <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
			<button id="btnAprovarResultado" style="background-color: #28a745; width: auto !important; padding: 10px 20px;">Aprovar</button>
			<button id="btnDepoisResultado" style="background-color: #6c757d; width: auto !important; padding: 10px 20px;">Depois</button>
			<button id="btnRecusarResultado" style="background-color: #dc3545; width: auto !important; padding: 10px 20px;">Recusar</button>
		</div>
    </div>
</div>


<div id="modalResolucaoArbitro" class="modal-overlay">
    <div class="modal-content">
        <h3 style="margin-top: 0; text-align: center;">Resolu√ß√£o de Disputa (√Årbitro)</h3>
        <p style="text-align: center;">O seguinte resultado foi recusado.<br>Analise e tome uma decis√£o.</p>

        <div id="resumo-partida-arbitro" class="resumo-partida">
            </div>

        <div id="placar-recusado-arbitro" style="margin: 15px 0;">
            </div>

        <div style="display: flex; justify-content: space-around; gap: 10px; margin-top: 20px;">
            <button id="btnAprovarPeloArbitro" style="background-color: #28a745; width: auto !important; padding: 10px 15px;">Aprovar</button>
            <button id="btnEditarPeloArbitro" style="background-color: #ffc107; color: black; width: auto !important; padding: 10px 15px;">Editar</button>
            <button id="btnCancelarPeloArbitro" style="background-color: #dc3545; width: auto !important; padding: 10px 15px;">Cancelar</button>
        </div>
         <hr style="border: none; border-top: 0px solid #eee; margin: 10px 0;">
         <button id="btnFecharArbitro" style="background-color: #6c757d; margin-top: 0;">Depois</button>
    </div>
</div>



<div id="modalResultadoDuplas" class="modal-overlay">
    <div class="modal-content">
        <h3 style="margin-top: 0; text-align: center;">Resultado da Partida de Duplas</h3>
        
        <p id="duplasJogadoresInfo" style="text-align: center; font-style: italic; color: #666;"></p>
        
        <div id="duplasMatchupsContainer" style="margin-top: 20px;">
            </div>
        
        <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
            <button id="btnSalvarDuplas" style="background-color: #28a745; width: auto !important; padding: 10px 20px;">Salvar</button>
            <button id="btnDepoisDuplas" onclick="fecharModalResultadoDuplas()" style="background-color: #6c757d; width: auto !important; padding: 10px 20px;">Depois</button>
            <button id="btnCancelarDuplas" onclick="fecharModalResultadoDuplas()" style="background-color: #dc3545; width: auto !important; padding: 10px 20px;">Cancelar</button>
        </div>
    </div>
</div>



<div class="tabela-container">
<table id="tabelaQuadra" style="width: 100%; margin-top: 10px;"> 
    <tr>
        <th rowspan="2" style="text-align: center;">Hor√°rios</th>
        <th>Segunda-Feira</th>
        <th>Ter√ßa-Feira</th>
        <th>Quarta-Feira</th>
        <th>Quinta-Feira</th>
        <th>Sexta-Feira</th> 
        <th>S√°bado</th>
        <th>Domingo</th>
        <th rowspan="2" style="text-align: center;">Hor√°rios</th>
    </tr>
    <tr style="background-color: #f2f2f2;">
        <td style="font-weight: bold; font-size: 0.9em;">09/10/24</td>
        <td style="font-weight: bold; font-size: 0.9em;">10/10/24</td>
        <td style="font-weight: bold; font-size: 0.9em;">11/10/24</td>
        <td style="font-weight: bold; font-size: 0.9em;">12/10/24</td>
        <td style="font-weight: bold; font-size: 0.9em;">13/10/24</td>
        <td style="font-weight: bold; font-size: 0.9em;">14/10/24</td>
        <td style="font-weight: bold; font-size: 0.9em;">15/10/24</td>
    </tr>
    <tbody id="tabelaCorpo">
    <tr>
        <td class="horario">06:00 - 07:00</td>
        <td></td><td></td><td></td><td></td><td></td>
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- S√°bado -->
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
        <td class="horario">06:00 - 07:00</td>
    </tr>
    <tr>
        <td class="horario">07:00 - 08:00</td>
        <td></td><td></td><td></td><td></td><td></td>
        <td></td>
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
        <td class="horario">07:00 - 08:00</td>
    </tr>
    <tr>
        <td class="horario">08:00 - 09:00</td>
        <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
        <td class="horario">08:00 - 09:00</td>
    </tr>
    <tr>
        <td class="horario">09:00 - 10:00</td>
        <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
        <td class="horario">09:00 - 10:00</td>
    </tr>
    <tr>
        <td class="horario">10:00 - 11:00</td>
        <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
        <td class="horario">10:00 - 11:00</td>
    </tr>
    <tr>
        <td class="horario">11:00 - 12:00</td>
        <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
        <td class="horario">11:00 - 12:00</td>
    </tr>
    <tr>
        <td class="horario">12:00 - 13:00</td>
        <td></td><td></td><td></td><td></td><td></td><td></td>
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
        <td class="horario">12:00 - 13:00</td>
    </tr>
    <tr>
        <td class="horario">13:00 - 14:00</td>
        <td></td><td></td><td></td><td></td><td></td><td></td>
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
        <td class="horario">13:00 - 14:00</td>
    </tr>
    <tr>
        <td class="horario">14:00 - 15:00</td>
        <td></td><td></td><td></td><td></td><td></td><td></td>
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
        <td class="horario">14:00 - 15:00</td>
    </tr>
    <tr>
        <td class="horario">15:00 - 16:00</td>
        <td></td><td></td><td></td><td></td><td></td><td></td>
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
        <td class="horario">15:00 - 16:00</td>
    </tr>
    <tr>
        <td class="horario">16:00 - 17:00</td>
        <td></td><td></td><td></td><td></td><td></td><td></td>
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
        <td class="horario">16:00 - 17:00</td>
    </tr>
    <tr>
        <td class="horario">17:00 - 18:00</td>
        <td></td><td></td><td></td><td></td><td></td><td></td>
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
        <td class="horario">17:00 - 18:00</td>
    </tr>
    <tr>
        <td class="horario">18:00 - 19:00</td>
        <td></td><td></td><td></td><td></td><td></td><td></td>
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
        <td class="horario">18:00 - 19:00</td>
    </tr>
    <tr>
        <td class="horario">19:00 - 20:00</td>
        <td></td><td></td><td></td><td></td><td></td><td></td>
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
        <td class="horario">19:00 - 20:00</td>
    </tr>
    <tr>
        <td class="horario">20:00 - 21:00</td>
        <td></td><td></td><td></td><td></td><td></td><td></td>
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
        <td class="horario">20:00 - 21:00</td>
    </tr>
    <tr>
        <td class="horario">21:00 - 22:00</td>
        <td></td><td></td><td></td><td></td><td></td>
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- S√°bado -->
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
        <td class="horario">21:00 - 22:00</td>
    </tr>
    <tr>
        <td class="horario">22:00 - 23:00</td>
        <td></td><td></td><td></td><td></td><td></td>
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- S√°bado -->
        <td style="background-color: #f2f2f2; pointer-events: none; cursor: not-allowed;"></td> <!-- Domingo -->
        <td class="horario">22:00 - 23:00</td>
    </tr>
</tbody>

</table>
</div>
</div>


<div id="birthdayModalOverlay" class="modal-overlay">
    <div id="birthdayModalContent">
        <span id="birthdayAge" class="birthday-badge"></span>
        <h2>Feliz Anivers√°rio, <span id="birthdayName"></span>!</h2>
        <p>O Clube Ol√≠mpico e todos os seus amigos do t√™nis desejam a voc√™ um dia espetacular, cheio de alegrias e grandes jogadas!</p>
  		<p style="font-size: 2em; margin: 10px 0;">ü•≥üéâüéÇüéæ</p>
        <button id="closeBirthdayModal">Obrigado!</button>
    </div>
</div>


<footer style="text-align: center; margin-top: 20px; font-size: 0.9em; color: #555;">
        Desenvolvido por Ronaldo Taborda
</footer>

<button id="theme-toggle-button">üåô</button>





<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script> 
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>   
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>



<script>
        document.addEventListener('DOMContentLoaded', function () {
    const toggleButton = document.getElementById('toggleSenha');
    const senhaInput = document.getElementById('senha');

    toggleButton.addEventListener('click', function () {
        if (senhaInput.type === 'password') {
            senhaInput.type = 'text';
            toggleButton.textContent = 'üôà'; // √çcone de olho fechado 
        } else {
            senhaInput.type = 'password';
            toggleButton.textContent = 'üëÅÔ∏è'; // √çcone de olho aberto
        }
    });
});
</script>
	
	
<script>
	
//***********************************************************************************************************************************************************************

// Ajuste manual da vers√£o do Sistema
const VersaoSistema = 'v1.7.3'; // Vers√£o atual do sistema       

let vDesabilitarF12 = true; // deixar true para fazer o deploy    
let vAbrirSistema = true; // deixar true para fazer o deploy
let vPermitirExclusaoAposJogo = false; // Mude para true para permitir que usu√°rios comuns excluam jogos passados durante os testes.

let piramideInicioTorneio = null;
let piramideFimTorneio = null;
let piramideAtivaGlobal = false;

let vatualizarOpcoesHorario = true; // inicialmente atualizar o campo Hor√°rio 
let vDomingoAnterior = null;
let vDomingoAteAnterior = null;

// Vari√°veis globais que s√£o configuradas em configuracoes.html
window.DiasParaLimpar = undefined; // Ajuste conforme necess√°rio (1,2,3,4,5,6). Ex: se DiasParaLimpar = 4, s√≥ √© permitido fazer reserva em at√© 2 dias de anteced√™ncia.
let vLimparDiasAnteriores = false;
window.vDomingo = undefined; // Valor padr√£o: fechado, pois o clube n√£o abre aos domingos ("aberto", "fechado").

const jogadoresRestritos = ["YURI HARDER", "EDUARDO BERGMAN","BIANCA KROKER","MANUELA KROKER","WILMAR KROKER"]; // jogadores que s√≥ tem acesso √†s quadra 1 e 2.

let arbitro = ""; 
let isArbitroEditing = false; // para a janela do √Årbritro nao ficar abrindo "do nada"

let quadrasInativas = new Set();
let reservasPorQuadra = {};
let quadraSelecionada = 'Quadra 1 - Coberta'; 
let duplasConfigGlobais = {}; 
let convidadoConfigGlobais = {};
let bloqueiosQuadra = {};
let horasParaExpirarConfig = 2; // Define um padr√£o de 2 horas
let vReservasPorConfirmacao = false; // Padr√£o: desligado
let edicaoOrganizadorAtiva = false;
let quebraHorarioDomingoConfig = { ativa: true, quadras: {} };
let exclusaoEmAndamento = false;
let agendamentoEmAndamento = false;
let administradores = [];
let rankingDuplasAtivo = false;

let clickTimer = null;


//***********************************************************************************************************************************************************************

if (vDesabilitarF12) {
  // Bloqueia o menu de contexto e o acesso ao console
  document.addEventListener('contextmenu', event => event.preventDefault());
  document.addEventListener('keydown', event => {
    if (event.key === "F12" || (event.ctrlKey && event.shiftKey && event.key === "I")) {
      event.preventDefault();
    }
  });
} else {
  // O c√≥digo est√° comentado (n√£o ser√° executado)
  /*
  document.addEventListener('contextmenu', event => event.preventDefault());
  document.addEventListener('keydown', event => {
    if (event.key === "F12" || (event.ctrlKey && event.shiftKey && event.key === "I")) {
      event.preventDefault();
    }
  });
  */
}


// Configura√ß√£o do Firebase
const firebaseConfig = {
    apiKey: "SUA_API_KEY",
    authDomain: "agenda-5ce95.firebaseapp.com",
    projectId: "agenda-5ce95",
    storageBucket: "agenda-5ce95.appspot.com",
    messagingSenderId: "852007565195",
    appId: "1:852007565195:web:d7bd789d140858f53f618e"
};

// Inicializa√ß√£o do Firebase
const app = firebase.initializeApp(firebaseConfig);
const database = firebase.database();


// Configura√ß√£o inicial do banco de dados
function inicializarEstruturaInicial() { 
    const estruturaInicial = {
        config: {
            DiasParaLimpar: 4, // Valor padr√£o
            vDomingo: "fechado", // Padr√£o fechado
            Quadras: {
                Quadra1: "liberada",
                Quadra2: "liberada",
                Quadra3: "liberada",
            },
        },
        reservas: {
            "Quadra 1 - Coberta": {},
            "Quadra 2 - Aberta": {},
            "Quadra 3 - Coberta": {},
        },
    };

    database.ref("sistemas").set(estruturaInicial)
        .then(() => {
            console.info("Estrutura inicial criada com sucesso no Firebase.");
        })
        .catch((error) => {
            console.error("Erro ao criar estrutura inicial no Firebase:", error);
        });
}

function atualizarLegenda(piramideAtiva) {
    const legendaContainer = document.querySelector('#legenda');
    if (!legendaContainer) {
        console.error("Container da legenda n√£o encontrado!");
        return;
    }

    // ---- IN√çCIO DA ALTERA√á√ÉO ----
    // L√ìGICA DE CORES DO TEMA
    const isDarkMode = document.body.classList.contains('dark-mode');
    const cor1h = isDarkMode ? 'mediumseagreen' : 'lightgreen';
    const cor2h = isDarkMode ? 'CornflowerBlue' : 'lightblue';
    const corAula = isDarkMode ? '#CD5C5C' : 'lightcoral'; // Usando um vermelho mais escuro para o modo escuro
    const corPiramide = isDarkMode ? 'goldenrod' : '#FFEB99';
    // ---- FIM DA ALTERA√á√ÉO ----

    legendaContainer.innerHTML = '<strong style="font-size: 14px;">Legenda:</strong>';

    if (!piramideAtiva) {
        // USA AS CORES DO TEMA
        const itens = [
            { cor: cor1h, texto: '1 Hora' },
            { cor: cor2h, texto: '2 Horas' },
            { cor: corAula, texto: 'Aula' }
        ];

        itens.forEach((item, index) => {
            const linha = document.createElement('div');
            linha.style.display = 'flex';
            linha.style.alignItems = 'center';
            linha.style.marginBottom = '2px';

            if (index === itens.length - 1) {
                linha.style.marginBottom = '-5px';
            }

            const icone = document.createElement('span');
            icone.style.display = 'inline-block';
            icone.style.width = '15px';
            icone.style.height = '17px';
            icone.style.backgroundColor = item.cor; // USA A COR DO TEMA
            icone.style.marginRight = '5px';

            const texto = document.createElement('span');
            texto.style.fontSize = '12px';
            texto.textContent = item.texto;

            linha.appendChild(icone);
            linha.appendChild(texto);
            legendaContainer.appendChild(linha);
        });
    } else {
        const linha1 = document.createElement('div');
        linha1.id = 'linha-1';
        linha1.style.display = 'flex';
        linha1.style.alignItems = 'center';
        linha1.style.gap = '2px';
        linha1.style.marginTop = '5px';
        linha1.style.marginBottom = '5px';

        const linha2 = document.createElement('div');
        linha2.id = 'linha-2';
        linha2.style.display = 'flex';
        linha2.style.alignItems = 'center';
        linha2.style.gap = '2px';

        // USA AS CORES DO TEMA
        linha1.innerHTML = `
            <span style="display: inline-block; width: 15px; height: 17px; background-color: ${cor1h}; margin-right: 2px;"></span>
            <span style="font-size: 12px;">1 Hora</span>
            <span style="display: inline-block; width: 15px; height: 18px; background-color: ${cor2h}; margin-right: 2px; margin-left: 10px;"></span>
            <span style="font-size: 12px;">2 Horas</span>
        `;

        // USA AS CORES DO TEMA
        linha2.innerHTML = `
            <span style="display: inline-block; width: 15px; height: 18px; background-color: ${corAula}; margin-right: 5px;"></span>
            <span style="font-size: 12px;">Aula</span>
            <span id="piramide-span" style="display: inline-block; width: 15px; height: 18px; background-color: ${corPiramide}; margin-left: 19px; margin-right: 1px;"></span>
            <span id="piramide-text" style="font-size: 12px;">Pir√¢mide</span>
        `;

        legendaContainer.appendChild(linha1);
        legendaContainer.appendChild(linha2);
    }
}


function removerSessoesAntigas() {
    const usuariosRef = database.ref('sistemas/usuariosOnline');
    const agora = Date.now();
    const limiteTempo = 3 * 60 * 60 * 1000; //  sess√µes de mais de 3 horas ser√£o exclu√≠das

    console.log("‚è≥ Iniciando verifica√ß√£o de sess√µes antigas...");


    usuariosRef.once('value', snapshot => {
        const usuarios = snapshot.val();

        if (!usuarios) {
            console.log("‚úÖ Nenhum usu√°rio online encontrado.");
            return;
        }

        Object.entries(usuarios).forEach(([id, sessao]) => {
            const timestampSessao = sessao.timestamp || 0;
            const diff = agora - timestampSessao;

            if ((agora - timestampSessao) > limiteTempo) {
				console.warn(`üóëÔ∏è Sess√£o antiga detectada! Tentando remover ${id} (${sessao.usuario})`);

				database.ref(`sistemas/usuariosOnline/${id}`).remove()
					.then(() => {
						console.log(`‚úÖ Sess√£o ${id} removida com sucesso do banco.`);
					})
					.catch((error) => {
						console.error(`‚ùå Erro ao remover sess√£o ${id}:`, error);
					});
			} else {
				console.log(`‚úÖ Sess√£o ainda v√°lida. Mantida no sistema.`);
			}
        });
    });
}




let githubToken = ''; // Vari√°vel global para armazenar o token

// Inicializa√ß√£o do sistema
function InicializarSistema() {
    return new Promise((resolve, reject) => {
        const sistemaRef = database.ref("sistemas"); 

        sistemaRef.on('value', (snapshot) => {
            const data = snapshot.val();

            if (data) {
                const minVersion = data.version;
				if (VersaoSistema !== minVersion) {
					const overlay = document.getElementById('versao-desatualizada-overlay');
					if (overlay) {
						overlay.querySelector('h1').textContent = 'Vers√£o Desatualizada';
						overlay.querySelector('p').textContent = 'Por favor, feche e reabra o aplicativo para aplicar a atualiza√ß√£o.';
						overlay.style.display = 'flex';
					}
					return; // Interrompe o carregamento
				}

                const config = data.config;
				
				vReservasPorConfirmacao = config.ReservasPorConfirmacao || false; // L√™ o interruptor do banco
				//vReservasPorConfirmacao = true; 
				
				horasParaExpirarConfig = config.horasParaExpirar || 2; // L√™ o valor do banco ou usa 2 como padr√£o
				edicaoOrganizadorAtiva = config.OrganizadorEdicao || false;
				quebraHorarioDomingoConfig = config.QuebraDeHorarioDomingo || { ativa: true, quadras: {} }; 
				
				if (config && config.Administradores && Object.keys(config.Administradores).length > 0) {
                    // Extrai os objetos {nomeCompleto, apelido} e cria uma lista S√ì com os nomes completos
                    administradores = Object.values(config.Administradores).map(admin => admin.nomeCompleto);
                } else {
                    // Se a lista estiver vazia no Firebase, usa um admin padr√£o por seguran√ßa
                    administradores = ["RONALDO TABORDA"];
                }
				
				if (config && config.Arbitro) {
					arbitro = config.Arbitro; // Guarda o objeto {nomeCompleto, apelido}
				} else {
					arbitro = { nomeCompleto: "RONALDO TABORDA", apelido: "RONALDO TABORDA" }; // Padr√£o de seguran√ßa
				}
				
				 // ADICIONE A LINHA ABAIXO PARA TESTAR
                //alert('Administradores carregados: ' + administradores.join(', '));
				//alert('√Årbitro carregado: ' + arbitro.nomeCompleto);

				
				githubToken = config.githubToken;
				
				//alert(`token: ${githubToken}`);
				
				verificarConvitesPendentes(data.reservas);
                verificarConfirmacoesResultado(data.reservas); 
				verificarDisputasArbitro(data.reservas);
				verificarNotificacoes(); 
			   
			   if (vAbrirSistema) {
				  // A verifica√ß√£o de manuten√ß√£o s√≥ roda se a "chave mestra" do desenvolvedor estiver LIGADA
				  if (config && config.Abrir === false) {
					const overlay = document.getElementById('versao-desatualizada-overlay');
					if (overlay) {
						overlay.querySelector('h1').textContent = 'Sistema em Manuten√ß√£o';
						overlay.querySelector('p').textContent = 'O sistema est√° passando por uma manuten√ß√£o provis√≥ria. Por favor, tente novamente mais tarde.';
						overlay.style.display = 'flex';
					}
					return; // Interrompe o carregamento
				  }
				}
		        
				

                // Verifica se a pir√¢mide est√° ativa (em tempo real)
                const piramideAtiva = config?.Piramide?.ativa || false; // Valor padr√£o: false
				piramideAtivaGlobal = piramideAtiva;
				piramideInicioTorneio = config?.Piramide?.inicio || null;
				piramideFimTorneio = config?.Piramide?.fim || null;
                const duracaoSelect = document.getElementById('duracao');
                const piramideOption = duracaoSelect?.querySelector('option[value="3-piramide"]');

                if (piramideOption) {
                    piramideOption.style.display = piramideAtiva ? 'block' : 'none'; // Mostra ou oculta a op√ß√£o "Pir√¢mide"
                }
                
                // Atualiza a legenda com base no estado da Pir√¢mide
                atualizarLegenda(piramideAtiva);
                
                if (piramideAtiva) {
                    window.config = window.config || {};
                    window.config.Piramide = config.Piramide;
                }

                if (config) {
                    window.DiasParaLimpar = config.DiasParaLimpar || 4;
                    //window.vDomingo = config.vDomingo || "fechado";
                    //window.vDomingoAte = config.vDomingoAte || "23:00"; // Valor padr√£o caso n√£o esteja definido
					window.vDomingo = config.vDomingo || "fechado";
					window.vDomingoAte = config.vDomingoAte || "23:00";

					// --- IN√çCIO DA L√ìGICA DE DETEC√á√ÉO DE MUDAN√áA ---
					// A condi√ß√£o (vDomingoAnterior !== null) impede a execu√ß√£o na primeira carga da p√°gina.
					if (vDomingoAnterior !== null && (window.vDomingo !== vDomingoAnterior || window.vDomingoAte !== vDomingoAteAnterior)) {
						console.log("Detectada mudan√ßa na configura√ß√£o de Domingo. For√ßando atualiza√ß√£o dos hor√°rios.");
						atualizarOpcoesHorario(); // For√ßa a atualiza√ß√£o do dropdown
					}

					// Atualiza os valores anteriores para a pr√≥xima verifica√ß√£o
					vDomingoAnterior = window.vDomingo;
					vDomingoAteAnterior = window.vDomingoAte;
					
					duplasConfigGlobais = config.Duplas || {}; // Carrega a config de Duplas na vari√°vel global
					
				    convidadoConfigGlobais = config.Convidados || {}; // Carrega a config de Convidados
					
					rankingDuplasAtivo = config.Duplas?.Ranking || false;
					
					bloqueiosQuadra = config.Quadras?.Bloqueios || {};  // Carrega a config de Bloqueios
					
                    quadrasInativas.clear();
                    const quadras = config.Quadras || {};
                    if (quadras.Quadra1 === "interditada") quadrasInativas.add("Quadra 1 - Coberta");
                    if (quadras.Quadra2 === "interditada") quadrasInativas.add("Quadra 2 - Aberta");
                    if (quadras.Quadra3 === "interditada") quadrasInativas.add("Quadra 3 - Coberta");

                    atualizarDatas();
					
					//alert(" inicializarSistema vatualizarOpcoesHorario = " + vatualizarOpcoesHorario);

					if (vatualizarOpcoesHorario) {
					  atualizarOpcoesHorario();
					  document.getElementById('quadra').selectedIndex = 0;
					  vatualizarOpcoesHorario = false;
					  //alert(" primeira execu√ß√£o vatualizarOpcoesHorario = " + vatualizarOpcoesHorario);
					}
                }
            } else {
                inicializarEstruturaInicial();
            }

            let quadraInicial = quadraSelecionada || "Quadra 1 - Coberta";
            if (quadrasInativas.has(quadraInicial)) {
                const proximasQuadras = ["Quadra 2 - Aberta", "Quadra 3 - Coberta"].filter(quadra => !quadrasInativas.has(quadra));
                if (proximasQuadras.length > 0) {
                    quadraInicial = proximasQuadras[0];
                } else {
                    quadrasInativas.clear();
                    quadrasInativas.add("Quadra 1 - Coberta");
                    quadrasInativas.add("Quadra 2 - Aberta");
                    quadrasInativas.add("Quadra 3 - Coberta");

                    atualizarEstadoQuadras();

                    const selectQuadra = document.getElementById('quadra');
                    if (selectQuadra) {
                        selectQuadra.innerHTML = "";
                        const defaultOption = document.createElement('option');
                        defaultOption.value = "";
                        defaultOption.textContent = "Nenhuma quadra dispon√≠vel";
                        selectQuadra.appendChild(defaultOption);
                    }

                    const tabelaContainer = document.querySelector('.tabela-container');
                    const header = document.querySelector('.header');
                    if (tabelaContainer) tabelaContainer.style.display = 'none';
                    if (header) header.style.display = 'none';

                    alert("Todas as quadras est√£o interditadas no momento.");
                    resolve();
                    return; 
                }
            }

            document.querySelectorAll('.tab-button').forEach(button => {
                if (button.innerText.trim() === quadraInicial) {
                    button.classList.add('selected');
                } else {
                    button.classList.remove('selected');
                }
            });

            const selectQuadra = document.getElementById('quadra');
			if (selectQuadra) {
				selectQuadra.innerHTML = "";

				const jogadorLogado = localStorage.getItem("jogadorLogado")?.toUpperCase();
				const isRestrito = jogadoresRestritos.includes(jogadorLogado);
				const todasQuadras = ["Quadra 1 - Coberta", "Quadra 2 - Aberta", "Quadra 3 - Coberta"];
				const quadrasAutorizadas = isRestrito
					? ["Quadra 1 - Coberta", "Quadra 2 - Aberta"]
					: todasQuadras;

				quadrasAutorizadas.forEach(quadra => {
					if (!quadrasInativas.has(quadra)) {
						const option = document.createElement('option');
						option.value = quadra;
						option.textContent = quadra;
						selectQuadra.appendChild(option);
					}
				});

				// Esta linha foi restaurada para definir a quadra inicial
				selectQuadra.value = quadraInicial;
			}

            const tabelaContainer = document.querySelector('.tabela-container');
            const header = document.querySelector('.header');
            if (tabelaContainer) tabelaContainer.style.display = 'block';
            if (header) {
                header.style.display = 'block';
                header.innerText = quadraInicial;
            }

            atualizarEstadoQuadras();
            selecionarQuadra(quadraInicial);
			
			// ADICIONE ESTA LINHA PARA FOR√áAR O RESET DO DROPDOWN
			//document.getElementById('quadra').selectedIndex = 0;
            resolve();

        }, (error) => {
            console.error("Erro ao carregar dados iniciais:", error);
            reject(error);
        });
    });
}





function atualizarEstadoQuadras() {
    // Atualiza o estado visual das quadras com base no conjunto quadrasInativas
    document.querySelectorAll('.tab-button').forEach(button => {
        const quadraNome = button.innerText.trim();

        if (quadrasInativas.has(quadraNome)) {
            button.style.setProperty("background-color", "red", "important");
            button.style.setProperty("cursor", "not-allowed", "important");
            button.onclick = () => alert(`A ${quadraNome} est√° interditada provisoriamente.`);
        } else {
            button.style.setProperty("background-color", "#lightgreen", "important");
            button.style.setProperty("cursor", "pointer", "important");
            button.onclick = () => selecionarQuadra(quadraNome);
        }
    });

    // --- NOVO: Desativa o bot√£o Agendar se todas as quadras estiverem inativas OU se o dropdown estiver vazio
	const todasIndisponiveis = ["Quadra 1 - Coberta", "Quadra 2 - Aberta", "Quadra 3 - Coberta"]
		.every(quadra => quadrasInativas.has(quadra));

	const selectQuadra = document.getElementById('quadra');
	const dropdownVazio = !selectQuadra || selectQuadra.options.length === 0;

	const botaoAgendar = document.getElementById('botaoAgendar');
	if (botaoAgendar) {
		const desativar = todasIndisponiveis || dropdownVazio;

		// A MUDAN√áA EST√Å AQUI:
		// Se a condi√ß√£o 'desativar' for verdadeira, o bot√£o √© desabilitado.
		// Se for falsa, N√ÉO FAZEMOS NADA, deixando o bot√£o no estado em que ele j√° est√°.
		if (desativar) {
			botaoAgendar.disabled = true;
		}

		// A l√≥gica de estilo pode ser mantida ou simplificada se preferir,
		// mas o importante √© a condi√ß√£o 'if' acima.
		botaoAgendar.style.opacity = botaoAgendar.disabled ? "0.5" : "1";
		botaoAgendar.style.cursor = botaoAgendar.disabled ? "not-allowed" : "pointer";
		botaoAgendar.title = botaoAgendar.disabled ? "Preencha todos os campos para agendar" : "";
	}
}


function atualizarReservasQuadra(quadra) {
    limparTabela();
    const reservas = reservasPorQuadra[quadra];
    if (reservas) {
        const tabela = document.getElementById('tabelaCorpo');
        for (const key in reservas) {
            const { jogadores, dia, hora, duracao, borda } = reservas[key];
            const rowIndex = hora - 6;
            const colIndex = dia;

            // Ignorar s√°bado (coluna 6) das 21:00 √†s 23:00 e domingo (coluna 7) das 06:00 √†s 08:00
            if ((colIndex === 6 && hora >= 21 && hora <= 23) || (colIndex === 7 && hora >= 6 && hora <= 8)) {
                continue;
            }

            const cell = tabela.rows[rowIndex]?.cells[colIndex];
            if (cell) {
                cell.innerHTML = jogadores;
                cell.setAttribute("data-duracao", duracao);
                //cell.style.backgroundColor = jogadores.toLowerCase().includes('aula') ? 'lightcoral' :
                //    (duracao === 1 ? 'lightgreen' : 'lightblue');
                cell.style.backgroundColor = jogadores.toLowerCase().trim() === 'aula' ? 'lightcoral' :
					(duracao === 1 ? 'lightgreen' : 'lightblue');					

                // Configurar bordas para reservas de 1h ou 2h
                if (borda === '1h') {
                    cell.style.border = '2px solid black';
                } else if (borda === '2h') {
                    configurarBordasDuracao2(cell, tabela, rowIndex, colIndex);
                }
            }
        }
    }
}

function configurarBordasDuracao2(cell, tabela, rowIndex, colIndex) {
    if (cell.rowSpan > 1) {
        cell.style.borderTop = '2px solid black';
        cell.style.borderLeft = '2px solid black';
        cell.style.borderRight = '2px solid black';
        cell.style.borderBottom = '2px solid black';
    } else {
        cell.style.borderTop = '2px solid black';
        cell.style.borderLeft = '2px solid black';
        cell.style.borderRight = '2px solid black';
        cell.style.borderBottom = 'none';

        const cellNext = tabela.rows[rowIndex + 1]?.cells[colIndex];
        if (cellNext) {
            cellNext.style.borderTop = 'none';
            cellNext.style.borderLeft = '2px solid black';
            cellNext.style.borderRight = '2px solid black';
            cellNext.style.borderBottom = '2px solid black';
        }
    }
}




function verificarVersao() {
    const elementoVersao = document.getElementById('VersaoSistema');
    if (elementoVersao) {
        elementoVersao.textContent = `${VersaoSistema}`;
    } else {
        console.error('Elemento para exibir a vers√£o n√£o encontrado!');
    }
}

let jogadorCount = 1;

function atualizarEstadoDomingo() {
    const tabela = document.getElementById('tabelaCorpo');
    const diaDomingo = 7; // coluna do domingo
    const horarioLimite = window.vDomingoAte ? parseInt(window.vDomingoAte.split(':')[0]) : 23;

    for (let i = 0; i < tabela.rows.length; i++) {
        const horario = i + 6;
        const celulaDomingo = tabela.rows[i].cells[diaDomingo];

        // Bloqueia sempre das 6h √†s 8h
        if (horario >= 6 && horario < 8) {
            celulaDomingo.style.backgroundColor = '#f2f2f2';
            celulaDomingo.style.pointerEvents = 'none';
            celulaDomingo.style.cursor = 'not-allowed';
            continue;
        }

        if (vDomingo === 'fechado') {
            if (horario >= 12) {
                celulaDomingo.style.backgroundColor = '#f2f2f2';
                celulaDomingo.style.pointerEvents = 'none';
                celulaDomingo.style.cursor = 'not-allowed';
            } else if (celulaDomingo.innerHTML.trim() === "") {
                celulaDomingo.style.backgroundColor = '';
                celulaDomingo.style.pointerEvents = '';
                celulaDomingo.style.cursor = '';
            }
        } else if (vDomingo === 'aberto') {
            if (horario >= horarioLimite) {
                celulaDomingo.style.backgroundColor = '#f2f2f2';
                celulaDomingo.style.pointerEvents = 'none';
                celulaDomingo.style.cursor = 'not-allowed';
            } else if (horario >= 8 && celulaDomingo.innerHTML.trim() === "") {
                celulaDomingo.style.backgroundColor = '';
                celulaDomingo.style.pointerEvents = '';
                celulaDomingo.style.cursor = '';
            }
        }
    }

}





function limparTabela() {
    const tabela = document.getElementById('tabelaCorpo');
    for (let i = 0; i < tabela.rows.length; i++) {
        for (let j = 1; j < tabela.rows[i].cells.length - 1; j++) {
            const horario = i + 6;

            if ((j === 6 && horario === 6) || (j === 7 && horario >= 6 && horario <= 7) || (j === 6 && horario >= 21 && horario <= 23)) {
                continue;
            }

            const cell = tabela.rows[i].cells[j];
            if (cell.rowSpan > 1) {
                const nextCell = tabela.rows[i + 1]?.cells[j];
                if (nextCell) {
                    nextCell.style.display = '';
                }
                cell.rowSpan = 1;
            }

            cell.style.borderTop = "1px solid #ddd";
            cell.style.borderBottom = "1px solid #ddd";
            cell.style.borderLeft = "1px solid #ddd";
            cell.style.borderRight = "1px solid #ddd";
            cell.style.backgroundColor = "";
            cell.innerHTML = "";
        }
    }
}

// Fun√ß√£o para selecionar a quadra e carregar suas reservas
function selecionarQuadra(quadra) {
    // Obt√©m o nome original da quadra
    const botoes = document.querySelectorAll('.tab-button');
    let nomeOriginal = null;

    botoes.forEach(button => {
        // Verifica se o bot√£o corresponde ao nome exibido ou ao nome original
        if (
            button.getAttribute('data-nome-original') === quadra ||
            button.innerHTML.replace('<br>', '').trim() === quadra
        ) {
            nomeOriginal = button.getAttribute('data-nome-original');
            
            // Alerta com o label do bot√£o clicado
            const labelBotao = button.textContent.trim(); // Obt√©m o texto do bot√£o
            //alert(`Label do bot√£o clicado: ${labelBotao}`);
        }
    });

    // alert(`quadra: ${quadra}`); 
    if (!nomeOriginal) {
        // Substitui quebras de linha e espa√ßos m√∫ltiplos por um √∫nico espa√ßo
        const quadraNormalized = quadra.replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim();
        //console.log(`Valor ajustado de quadra: "${quadraNormalized}"`);
        //alert(`Valor ajustado de quadra: "${quadraNormalized}"`);
        // Verifica o nome normalizado
        if (quadraNormalized === "Quadra 1 - Coberta" || quadraNormalized === "Quadra 1 Coberta") {
            nomeOriginal = "Quadra 1 - Coberta";
        } else if (quadraNormalized === "Quadra 2 - Aberta" || quadraNormalized === "Quadra 2 Aberta") {
            nomeOriginal = "Quadra 2 - Aberta";
        } else if (quadraNormalized === "Quadra 3 - Coberta" || quadraNormalized === "Quadra 3 Coberta") {
            nomeOriginal = "Quadra 3 - Coberta"; 
        }
    }
	
    //nomeOriginal = "Quadra 3 - Coberta";
	
    //alert(`Quadra selecionada: ${nomeOriginal}`); // Alerta com o nome da quadra

    if (!nomeOriginal) {
        console.error('Quadra n√£o encontrada:', quadra);
        return;
    }

    // Verifica se a quadra est√° interditada
    const isQuadraInterditada = quadrasInativas.has(nomeOriginal);

    if (isQuadraInterditada) {
        alert(`A ${nomeOriginal} est√° interditada provisoriamente.`);
        return;
    }

    // Atualiza a quadra selecionada
    quadraSelecionada = nomeOriginal;
    document.querySelector('.header').innerText = nomeOriginal;

    // Remove a classe 'selected' e estilo inline de todos os bot√µes
    botoes.forEach(button => {
        button.classList.remove('selected');
        button.style.backgroundColor = ''; // Remove estilo inline
        button.style.color = ''; // Remove estilo inline
        button.style.border = ''; // Remove estilo inline
    });

    // Adiciona a classe 'selected' e estilo inline ao bot√£o correspondente
    botoes.forEach(button => {
        if (button.getAttribute('data-nome-original') === nomeOriginal) {
            button.classList.add('selected'); // Aplica a classe 'selected' para quadra selecionada
            button.style.backgroundColor = '#228B22'; // Cor verde escuro para quadra selecionada
			button.style.color = 'white'; // Texto branco
            button.style.border = '2px solid #1A6418'; // Borda escura para quadra selecionada (apenas para a verde)
        }

        // Verifica se a quadra est√° interditada e aplica o estilo vermelho
        if (quadrasInativas.has(button.getAttribute('data-nome-original'))) {
            button.style.backgroundColor = 'red'; // Bot√£o vermelho para quadras interditadas
            button.style.color = 'white'; // Texto branco
            button.style.border = ''; // Remove a borda para o bot√£o vermelho 
        }
    });

    // Atualiza o estado do domingo ap√≥s selecionar a quadra
    atualizarEstadoDomingo();

    // Atualiza e exibe reservas para a quadra selecionada
    carregarReservas(nomeOriginal);
}



function carregarReservas(quadra) {
    if (agendamentoEmAndamento) { return; } // Mant√©m a prote√ß√£o contra concorr√™ncia
    celulasExcluidas.clear();
    reservasExcluidasFirebase.clear();

    const reservasRef = database.ref(`sistemas/reservas/${quadra}`);

    reservasRef.off('value'); // Remove ouvintes antigos
    reservasRef.on('value', (snapshot) => {
        if (agendamentoEmAndamento) { return; } // Prote√ß√£o extra
	    reservasPorQuadra[quadra] = snapshot.val() || {};
        const reservas = snapshot.val();

        limparTabela();
        atualizarEstadoDomingo();
        aplicarBloqueiosVisuais(quadra);

        if (reservas) {
            try {
                const tabela = document.getElementById('tabelaCorpo');
                const totalRows = tabela.rows.length;
                const totalCols = tabela.rows[0]?.cells.length || 0;

                for (const key in reservas) {
                    const reserva = reservas[key]; 

                    if (typeof reserva.jogadores === 'undefined' || reserva.jogadores === null) {
                        continue;
                    }
                    
                    if (reserva.borda === undefined && reserva.duracao > 1) continue;

                    const { dia, hora, duracao } = reserva;
                    const rowIndex = hora - 6;
                    const colIndex = dia;

                    if (rowIndex >= 0 && rowIndex < totalRows && colIndex >= 0 && colIndex < totalCols) {
                        const cell = tabela.rows[rowIndex].cells[colIndex];
                        cell.setAttribute("data-duracao", duracao || "segunda-celula");
						
                        if (vReservasPorConfirmacao === true && (reserva.status === 'pendente' || reserva.status === 'confirmada')) {
                            // L√≥gica para o sistema de confirma√ß√£o (permanece igual e correta)
                            const { confirmacoes } = reserva;
                            const isDarkMode = document.body.classList.contains('dark-mode');
                            const corReserva1h = isDarkMode ? 'mediumseagreen' : 'lightgreen';
                            const corReserva2h = isDarkMode ? 'CornflowerBlue' : 'lightblue';
                            const corPiramide = isDarkMode ? 'goldenrod' : '#FFEB99';
                            
                            let corFundo;
                            if (reserva.duracao === 1) corFundo = corReserva1h;
                            else if (reserva.duracao === 2) corFundo = corReserva2h;
                            else if (reserva.duracao === 3) corFundo = corPiramide;
                            
                            cell.style.backgroundColor = corFundo;
                            
                            const getStyledNames = (jogadoresArray, isPiramideGame) => {
                                if (!jogadoresArray || jogadoresArray.length === 0) return "";
                                let nomesHtml = [];
                                jogadoresArray.forEach(apelido => {
                                    let nomeParaExibir = apelido.trim();
                                    
                                    if (isPiramideGame) {
                                        const jogadorInfo = jogadoresData[nomeParaExibir];
                                        if (jogadorInfo && jogadorInfo.piramide && jogadorInfo.piramide !== "0") {
                                            const piramidePos = parseInt(jogadorInfo.piramide, 10);
                                            let displayRank = piramidePos;
                                            if (piramidePos >= 61) { displayRank = piramidePos - 60; }
                                            nomeParaExibir = `${displayRank} - ${apelido}`;
                                        }
                                    }
                                    
                                    let styles = '';
                                    const status = reserva.confirmacoes ? reserva.confirmacoes[apelido.trim()] : true;
                                    if (apelido.trim().toLowerCase() === 'convidado') {
                                        styles = `color: ${isDarkMode ? 'white' : 'black'};`;
                                    } else if (status === true) {
                                        styles = `color: ${isDarkMode ? 'white' : 'black'};`;
                                    } else if (status === false) {
                                        styles = `color: red;`;
                                    } else if (status === 'recusado') {
                                        styles = `color: red; text-decoration: line-through;`;
                                    }
                                    nomesHtml.push(`<span style="${styles}">${nomeParaExibir}</span>`);
                                });
                                return nomesHtml.join(isPiramideGame ? '<br>' : ', ');
                            };

                            const isPiramide = reserva.duracao === 3;
                            const todosOsJogadores = (reserva.jogadores_completo || reserva.jogadores).split(', ').map(j => j.trim());
                            let jogadoresParaExibir;

                            if (reserva.status === 'confirmada') {
                                jogadoresParaExibir = todosOsJogadores.filter(apelido => {
                                    const status = reserva.confirmacoes[apelido.trim()];
                                    const isConvidado = apelido.trim().toLowerCase() === 'convidado';
                                    return status === true || isConvidado;
                                });
                            } else { // 'pendente'
                                jogadoresParaExibir = todosOsJogadores;
                            }

                            let jogadoresParte1 = [];
                            let jogadoresParte2 = [];

                            if (reserva.duracao > 1) { // 2h or Piramide
                                jogadoresParaExibir.forEach((jogador, index) => {
                                    if (index === 0 || index === 2) {
                                        jogadoresParte1.push(jogador);
                                    } else if (index === 1 || index === 3) {
                                        jogadoresParte2.push(jogador);
                                    }
                                });
                            } else { // 1h
                                jogadoresParte1 = jogadoresParaExibir;
                            }
                            
                            cell.innerHTML = getStyledNames(jogadoresParte1, isPiramide);
                            
                            if (reserva.duracao === 2) {
                                configurarBordasDuracao2(cell, tabela, rowIndex, colIndex);
                            } else if (reserva.duracao === 1) {
                                cell.style.border = '2px solid black';
                            }
                            
                            if (reserva.duracao > 1) {
                                const cell2 = tabela.rows[rowIndex + 1]?.cells[colIndex];
                                if(cell2) {
                                    cell2.innerHTML = getStyledNames(jogadoresParte2, isPiramide);
                                    cell2.style.backgroundColor = corFundo;
                                }
                            }

                        } else {
                            // L√≥gica para reservas simples (Confirma√ß√£o OFF)
                            const { jogadores, borda, confirmacoes } = reserva;
                            const isDarkMode = document.body.classList.contains('dark-mode');
                            const corReserva1h = isDarkMode ? 'mediumseagreen' : 'lightgreen';
                            const corReserva2h = isDarkMode ? 'CornflowerBlue' : 'lightblue';
                            const corPiramide = isDarkMode ? 'goldenrod' : '#FFEB99';
                            let corFundo;

                            const getJogadoresVisiveis = (listaJogadores, confirmacoesObj) => {
                                if (!confirmacoesObj) {
                                    return listaJogadores;
                                }
                                const jogadoresArray = listaJogadores.split(', ').map(j => j.trim());
                                const filtrados = jogadoresArray.filter(apelido => confirmacoesObj[apelido] !== 'recusado');
                                return filtrados.join(', ');
                            };

                            const jogadoresVisiveis = getJogadoresVisiveis(jogadores, confirmacoes);
                            
                            const textoNormalizado = jogadores.toLowerCase().trim();
                            if (textoNormalizado === 'aula' || textoNormalizado === 'manutencao') {
								corFundo = 'lightcoral';
								if (textoNormalizado === 'aula') {
									cell.innerHTML = "aula";
									cell.style.color = ''; 
								} else {
									cell.innerHTML = "üí¶ Manuten√ß√£o";
									cell.style.color = 'white';
								}
							}
                            else if (reserva.duracao === 3 || (reservas[`${dia}_${hora - 1}`] && reservas[`${dia}_${hora - 1}`].duracao === 3)) {
                                corFundo = corPiramide;
                                cell.style.color = ''; // <-- CORRE√á√ÉO ADICIONADA AQUI
                                const jogadoresArray = jogadoresVisiveis.split(', ');
                                const jogadoresFormatados = jogadoresArray.map(apelido => {
                                    const jogadorInfo = jogadoresData[apelido.trim()];
                                    if (jogadorInfo && jogadorInfo.piramide && jogadorInfo.piramide !== "0") {
                                        const piramidePos = parseInt(jogadorInfo.piramide, 10);
                                        let displayRank = piramidePos >= 61 ? piramidePos - 60 : piramidePos;
                                        return `${displayRank} - ${apelido}`;
                                    }
                                    return apelido;
                                });
                                cell.innerHTML = jogadoresFormatados.join('<br>');
                            }
                            else {
                                corFundo = reserva.duracao === 1 ? corReserva1h : corReserva2h;
                                cell.innerHTML = jogadoresVisiveis;
                                cell.style.color = ''; // <-- CORRE√á√ÉO ADICIONADA AQUI
                            }

                            cell.style.backgroundColor = corFundo;

                            if (borda === '1h') {
                                cell.style.border = '2px solid black';
                            } else if (borda === '2h') {
                                configurarBordasDuracao2(cell, tabela, rowIndex, colIndex);
                            }

                            if (reserva.duracao > 1) {
                                const key2 = `${dia}_${hora + 1}`;
                                const reservaSegundaParte = reservas[key2];
                                if (reservaSegundaParte) {
                                    const cell2 = tabela.rows[rowIndex + 1]?.cells[colIndex];
                                    if (cell2) {
                                        const jogadoresVisiveisParte2 = getJogadoresVisiveis(reservaSegundaParte.jogadores, reservaSegundaParte.confirmacoes);
                                        
                                        if (reserva.duracao === 3) {
                                            const jogadoresArray2 = jogadoresVisiveisParte2.split(', ');
                                            const jogadoresFormatados2 = jogadoresArray2.map(apelido => {
                                                const jogadorInfo = jogadoresData[apelido.trim()];
                                                if (jogadorInfo && jogadorInfo.piramide && jogadorInfo.piramide !== "0") {
                                                    const piramidePos = parseInt(jogadorInfo.piramide, 10);
                                                    let displayRank = piramidePos >= 61 ? piramidePos - 60 : piramidePos;
                                                    return `${displayRank} - ${apelido}`;
                                                }
                                                return apelido;
                                            });
                                            cell2.innerHTML = jogadoresFormatados2.join('<br>');
                                        } else {
                                            cell2.innerHTML = jogadoresVisiveisParte2;
                                        }
                                        cell2.style.backgroundColor = corFundo;
										cell2.style.color = '';
                                    }
                                }
                            }
                        }
                    }
                }
            } catch (error) {
                console.error("Execu√ß√£o interrompida devido a dados inv√°lidos:", error.message);
                return;
            }
        } 
        configurarEventosDaTabela();
    });
}



function bloquearDomingo() {
    const tabela = document.getElementById('tabelaCorpo');
    const diaDomingo = 7;

    for (let i = 0; i < tabela.rows.length; i++) {
        const horario = i + 6;
        const cell = tabela.rows[i].cells[diaDomingo];
        if (horario >= 12 && horario <= 23) {
            cell.style.backgroundColor = '#f2f2f2';
            cell.style.pointerEvents = 'none';
            cell.style.cursor = 'not-allowed';
        }
    }
    console.log('üö´ Domingo bloqueado');
}




function validarDiaReserva(jogadores) {
    console.log("Iniciando valida√ß√£o da reserva...");

    // Se algum jogador for "aula" , retorna true imediatamente
    if (jogadores.some(jogador => {
        let nome = jogador.toLowerCase();
        //return nome.includes("aula");
		return nome.trim() === "aula";
    })) {
        console.log("Reserva identificada como 'aula'. Valida√ß√£o ignorada.");
        return true;
    }

    const duracao = document.getElementById('duracao').value;
    console.log("Dura√ß√£o selecionada:", duracao);

    const diaSelecionado = parseInt(document.getElementById('dia').value);
    const horaSelecionada = parseInt(document.getElementById('hora').value);
    console.log("Dia selecionado:", diaSelecionado, "Hora selecionada:", horaSelecionada);

    if (duracao === "3-piramide") {
        console.log("Modo Pir√¢mide detectado. Aplicando regras especiais.");
		
		// --- IN√çCIO DA NOVA VALIDA√á√ÉO DE DATAS DO TORNEIO ---
        if (!piramideInicioTorneio || !piramideFimTorneio) {
            alert("N√£o √© poss√≠vel agendar jogos da Pir√¢mide, pois as datas do torneio ainda n√£o foram configuradas.");
            return false;
        }

        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);
        const diaDaSemanaHoje = hoje.getDay() === 0 ? 7 : hoje.getDay();
        let diff = diaSelecionado - diaDaSemanaHoje;
        if (diff < 0) diff += 7;
        const dataDaReserva = new Date(hoje);
        dataDaReserva.setDate(hoje.getDate() + diff);

        const dataInicioObj = parseDateDDMMYYYY(piramideInicioTorneio);
        const dataFimObj = parseDateDDMMYYYY(piramideFimTorneio);

        if (!dataInicioObj || !dataFimObj) {
            alert("Erro nas datas do torneio da Pir√¢mide. Contate o administrador.");
            return false;
        }
        
        dataFimObj.setHours(23, 59, 59, 999); // Garante que o dia final seja inclu√≠do na verifica√ß√£o

        if (dataDaReserva < dataInicioObj) {
            alert(`O torneio da Pir√¢mide s√≥ come√ßa em ${piramideInicioTorneio.replace(/-/g, '/')}.`);
            return false;
        }

        if (dataDaReserva > dataFimObj) {
            alert(`O torneio da Pir√¢mide terminou em ${piramideFimTorneio.replace(/-/g, '/')}.`);
            return false;
        }
        // --- FIM DA NOVA VALIDA√á√ÉO DE DATAS DO TORNEIO --- 

        if (jogadores.length !== 2) {
            alert("Reservas da Pir√¢mide devem ter exatamente 2 jogadores.");
			limparCampos();
            return false;
        }
		
		const configPiramide = window.config?.Piramide; 
        if (!configPiramide || !configPiramide.ativa) {
            alert("Configura√ß√£o da Pir√¢mide n√£o foi encontrada ou est√° desativada. Atualize a p√°gina.");
            return false;
        }

        const quadraSelecionada = document.getElementById('quadra').value;
        let quadraConfig;
        let prefixoQuadra;

        if (quadraSelecionada.includes("1")) {
            quadraConfig = configPiramide["Quadra-1"];
            prefixoQuadra = "1-";
            if (!quadraConfig || !quadraConfig["Quadra-1-ativa"]) {
                alert("Quadra 1 - Coberta est√° interditada para jogos da Pir√¢mide.");
                return false;
            }
        } else if (quadraSelecionada.includes("2")) {
            quadraConfig = configPiramide["Quadra-2"];
            prefixoQuadra = "2-";
            if (!quadraConfig || !quadraConfig["Quadra-2-ativa"]) {
                alert("Quadra 2 - Aberta est√° interditada para jogos da Pir√¢mide.");
                return false;
            }
        } else if (quadraSelecionada.includes("3")) {
            quadraConfig = configPiramide["Quadra-3"];
            prefixoQuadra = "3-";
            if (!quadraConfig || !quadraConfig["Quadra-3-ativa"]) {
                alert("Quadra 3 - Coberta est√° interditada para jogos da Pir√¢mide.");
                return false; 
            }
        }

        if (!quadraConfig) {
            alert("Configura√ß√£o da quadra n√£o encontrada.");
            return false;
        }

        const diasSemana = [1, 2, 3, 4, 5];
        if (diasSemana.includes(diaSelecionado)) {
            if (!quadraConfig[prefixoQuadra + "DiasDeSemana"]) {
                alert(`Reservas para jogos da Pir√¢mide na ${quadraSelecionada} n√£o s√£o permitidas durante a semana.`);
                return false;
            }
            if (quadraConfig[prefixoQuadra + "DiasDeSemana-exceto-17-19"]) {
                const horaFim = horaSelecionada + 2;
                if (horaSelecionada < 19 && horaFim > 17) {
                    alert(`Reservas da Pir√¢mide na ${quadraSelecionada} s√£o proibidas de segunda a sexta entre 17:00 e 19:00 (hor√°rio exclusivo para todos os s√≥cios).`);
                    return false;
                }
            }
        }

        if (diaSelecionado === 6) {
            if (!quadraConfig[prefixoQuadra + "Sabado"]) {
                alert(`Reservas para jogos da Pir√¢mide na ${quadraSelecionada} n√£o s√£o permitidas aos s√°bados.`);
                return false;
            }
            if (quadraConfig[prefixoQuadra + "Sabado-exceto-7-12"] && horaSelecionada >= 7 && horaSelecionada < 12) {
                alert(`Reservas da Pir√¢mide na ${quadraSelecionada} s√£o proibidas aos s√°bados entre 07:00 e 12:00 (hor√°rio exclusivo para todos os s√≥cios).`);
                return false;
            }
        }

        if (diaSelecionado === 7) {
            if (!quadraConfig[prefixoQuadra + "Domingo"]) {
                alert(`Reservas para jogos da Pir√¢mide na ${quadraSelecionada} n√£o s√£o permitidas aos domingos.`);
                return false;
            }
            if (quadraConfig[prefixoQuadra + "Domingo-exceto-8-12"] && horaSelecionada >= 8 && horaSelecionada < 12) {
                alert(`Reservas da Pir√¢mide na ${quadraSelecionada} s√£o proibidas aos domingos entre 08:00 e 12:00 (hor√°rio exclusivo para todos os s√≥cios).`);
                return false;
            }
        }

        console.log("Todas as regras da Pir√¢mide foram validadas com sucesso.");
    } 
	
        console.log("Modo padr√£o detectado. Aplicando regras normais de reserva.");
	
	//alert('entrei na valida√ßao');
    
    const diasParaLimpar = window.DiasParaLimpar;
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);

    let maxDiasPermitidos;
    switch (diasParaLimpar) {
        case 1: maxDiasPermitidos = 5; break;
        case 2: maxDiasPermitidos = 4; break;
        case 3: maxDiasPermitidos = 3; break;
        case 4: maxDiasPermitidos = 2; break;
        case 5: maxDiasPermitidos = 1; break;
        case 6: maxDiasPermitidos = 0; break;
        default:
            alert("Erro: Configura√ß√£o inv√°lida de DiasParaLimpar.");
            return false;
    }

    const ultimoDiaPermitido = new Date(hoje);
    ultimoDiaPermitido.setDate(hoje.getDate() + maxDiasPermitidos);

    const diferencaDias = (diaSelecionado - hoje.getDay() + 7) % 7;
    const dataSelecionada = new Date(hoje);
    dataSelecionada.setDate(hoje.getDate() + diferencaDias);

    if (dataSelecionada > ultimoDiaPermitido || dataSelecionada < hoje) {
        alert(gerarMensagemErro(diasParaLimpar));
        return false;
    }

    return true;
}



async function validarSeTemReserva(jogadores) {
    // Verifica se o usu√°rio logado √© o 'ERIK MANUTENCAO'.
    const jogadorLogado = localStorage.getItem('jogadorLogado');
    if (jogadorLogado && jogadorLogado.trim().toUpperCase() === 'ERIK MANUTENCAO') {
        console.log("Valida√ß√£o de reserva ativa ignorada para o usu√°rio de manuten√ß√£o.");
        return true; // Se for, permite o agendamento e encerra a fun√ß√£o aqui.
    }

    // Se algum jogador for "aula" , retorna true imediatamente
    if (jogadores.some(jogador => {
        let nome = jogador.toLowerCase();
        return nome === "aula";
    })) {
        console.log("Reserva marcada como 'aula'. Valida√ß√£o interrompida.");
        return true;
    }

    return new Promise((resolve) => {
        let conflito = false;
        let jogadoresComConflito = [];

        const reservasRef = database.ref("sistemas/reservas");
        reservasRef.once("value").then((snapshot) => {
            const todasAsReservas = snapshot.val() || {};
            const agora = new Date();

            // Verificando reservas existentes
            for (const quadra in todasAsReservas) {
                const reservasDaQuadra = todasAsReservas[quadra];
                for (const key in reservasDaQuadra) {
                    let reserva = reservasDaQuadra[key];

                    if (typeof reserva.jogadores === 'undefined' || reserva.jogadores === null) {
                        const erroMsg = `‚ö†Ô∏è Erro de Dados Encontrado!\n\nExiste uma reserva antiga ou corrompida que impede a valida√ß√£o do seu agendamento.\n\nPor favor, envie esta informa√ß√£o para o administrador:\n\n- Quadra: ${quadra}\n- Chave do Problema: ${key}`;
                        alert(erroMsg);
                        conflito = true;
                        break;
                    }

                    // Pula para a pr√≥xima itera√ß√£o se a reserva n√£o tiver a propriedade 'borda',
                    // pois isso indica que √© a segunda (ou terceira) hora de uma reserva mais longa.
                    if (reserva.borda === undefined) {
                        continue;
                    }
                    
                    const jogadoresNaReservaCompleta = [];
                    // Adiciona os jogadores da primeira hora
                    jogadoresNaReservaCompleta.push(...(reserva.jogadores_completo || reserva.jogadores).split(',').map(j => j.trim()));

                    // Se for uma reserva de mais de 1h, busca os jogadores da(s) hora(s) seguinte(s)
                    if (reserva.duracao > 1) {
                        const duracaoReal = reserva.duracao === 3 ? 2 : reserva.duracao;
                        for (let i = 1; i < duracaoReal; i++) {
                            const chaveProximaHora = `${reserva.dia}_${reserva.hora + i}`;
                            const reservaProximaHora = reservasDaQuadra[chaveProximaHora];
                            if (reservaProximaHora) {
                                jogadoresNaReservaCompleta.push(...(reservaProximaHora.jogadores_completo || reservaProximaHora.jogadores).split(',').map(j => j.trim()));
                            }
                        }
                    }
                    const jogadoresUnicosNaReserva = [...new Set(jogadoresNaReservaCompleta)];
					
					if (typeof reserva.jogadores === 'undefined' || reserva.jogadores === null) {
                        const erroMsg = `‚ö†Ô∏è Erro de Dados Encontrado!\n\nExiste uma reserva antiga ou corrompida que impede a valida√ß√£o do seu agendamento.\n\nPor favor, envie esta informa√ß√£o para o administrador:\n\n- Quadra: ${quadra}\n- Chave do Problema: ${key}`;
                        //alert(erroMsg);
						mostrarNotificacao(erroMsg, 'error');
                        conflito = true;
                        break;
                    }

                    // Agora, verifica se algum dos jogadores que est√£o tentando agendar est√° nesta reserva completa
                    jogadores.forEach(jogador => {
                        if (jogador === "Convidado") return;

                        if (jogadoresUnicosNaReserva.includes(jogador)) {
                            
                            if (reserva.confirmacoes && reserva.confirmacoes[jogador] === 'recusado') {
                                return;
                            }

                            const dataDaTabelaString = document.querySelector(`#tabelaQuadra tr:nth-child(2) td:nth-child(${reserva.dia})`).textContent;
                            const [dia, mes, ano] = dataDaTabelaString.split('/');
                            const reservaDataHoraInicio = new Date(ano, mes - 1, dia, reserva.hora, 0, 0, 0);

                            // L√≥gica corrigida para calcular a dura√ß√£o real
                            const duracaoCorrigida = reserva.duracao === 3 ? 2 : parseInt(reserva.duracao, 10);
                            
                            const reservaDataHoraFim = new Date(reservaDataHoraInicio);
                            reservaDataHoraFim.setHours(reservaDataHoraInicio.getHours() + duracaoCorrigida);

                            if (reservaDataHoraFim > agora) {
                                conflito = true;
                                if (!jogadoresComConflito.includes(jogador)) {
                                    jogadoresComConflito.push(jogador);
                                }
                            }
                        }
                    });
                }
                if (conflito) break;
            }

            if (conflito) {
                if (jogadoresComConflito.length > 0) {
                    const mensagem = jogadoresComConflito.length > 1
                        ? `Os jogadores ${jogadoresComConflito.join(", ")} ainda t√™m uma reserva ativa e n√£o podem agendar outra antes de finaliz√°-la.`
                        : `O jogador ${jogadoresComConflito[0]} ainda tem uma reserva ativa e n√£o pode agendar outra antes de finaliz√°-la.`;
                    alert(mensagem); // Mantido o alert() original
                }
                resolve(false);
            } else {
                resolve(true);
            }
        });
    });
}

function gerarMensagemErro(diasParaLimpar) {
    let diasAntecedencia;
    switch (diasParaLimpar) {
        case 1: diasAntecedencia = 5; break;
        case 2: diasAntecedencia = 4; break;
        case 3: diasAntecedencia = 3; break;
        case 4: diasAntecedencia = 2; break;
        case 5: diasAntecedencia = 1; break;
        case 6: return "S√≥ √© permitido fazer reservas para o dia atual.";
        default: return "Valor de DiasParaLimpar inv√°lido.";
    }
    limparCampos();
    return `N√£o √© permitido fazer reservas com mais de ${diasAntecedencia} dias de anteced√™ncia.`; 
}

window.atualizarOpcoesHorario = function() {

 

    const duracao = document.getElementById('duracao').value;
    const dia = document.getElementById('dia').value;
    const quadra = document.getElementById('quadra').value; // Pega a quadra selecionada
    const horaSelect = document.getElementById('hora');
    horaSelect.innerHTML = '';

    if (!duracao || !dia) return;

    // --- L√≥gica para buscar bloqueios do dia ---
    const quadraKey = `Quadra-${quadra.split(' ')[1]}`;
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    const diaDaSemanaHoje = hoje.getDay() === 0 ? 7 : hoje.getDay();
    let diff = dia - diaDaSemanaHoje;
    if (diff < 0) diff += 7;
    const dataDaReserva = new Date(hoje);
    dataDaReserva.setDate(hoje.getDate() + diff);
    const dataFormatada = `${dataDaReserva.getFullYear()}-${String(dataDaReserva.getMonth() + 1).padStart(2, '0')}-${String(dataDaReserva.getDate()).padStart(2, '0')}`;
    const bloqueioDoDia = bloqueiosQuadra[quadraKey]?.[dataFormatada];
    // --- Fim da l√≥gica ---

    const horarios = [];
    // Define os hor√°rios dispon√≠veis com base no dia da semana
    if (dia == 7) { // Domingo
        const limite = vDomingo === 'fechado' ? 12 : parseInt(vDomingoAte.split(':')[0]);
        for (let i = 8; i < limite; i++) horarios.push(i);
    } else if (dia == 6) { // S√°bado
        for (let i = 7; i < 21; i++) horarios.push(i);
    } else { // Dias de Semana
        for (let i = 6; i <= 22; i++) horarios.push(i);
    }

    // Filtra os hor√°rios com base nos bloqueios e na dura√ß√£o
    horarios.forEach(h => {
        let isBloqueado = false;
        if (bloqueioDoDia && bloqueioDoDia.regras) {
            const inicioBloqueio = parseInt(bloqueioDoDia.regras.inicio.split(':')[0]);
            const fimBloqueio = parseInt(bloqueioDoDia.regras.fim.split(':')[0]);
            
            // Verifica se o hor√°rio de in√≠cio ou qualquer parte da dura√ß√£o cai dentro do bloqueio
            for(let i = 0; i < parseInt(duracao === '3-piramide' ? 2 : duracao); i++) {
                if ((h + i) >= inicioBloqueio && (h + i) < fimBloqueio) {
                    isBloqueado = true;
                    break;
                }
            }
        }

        // Se n√£o estiver bloqueado, adiciona a op√ß√£o
        if (!isBloqueado) {
            const duracaoNum = parseInt(duracao === '3-piramide' ? 2 : duracao);
            // Garante que o hor√°rio final n√£o ultrapasse o limite do dia
            const limiteDia = (dia == 7) ? (vDomingo === 'fechado' ? 12 : parseInt(vDomingoAte.split(':')[0])) : (dia == 6 ? 21 : 23);
            if (h + duracaoNum <= limiteDia) {
                 const option = document.createElement('option');
                 option.value = h;
                 option.textContent = `${String(h).padStart(2, '0')}:00 - ${String(h + duracaoNum).padStart(2, '0')}:00`;
                 horaSelect.appendChild(option);
            }
        }
    });
};


// Substitua sua fun√ß√£o inteira por esta
window.adicionarJogador = function() {
    if (jogadorCount < 4) {
        jogadorCount++;
        const jogadoresContainer = document.getElementById('jogadoresContainer');

        const newDiv = document.createElement('div');
        newDiv.className = 'form-row';

        const label = document.createElement('label');
        label.setAttribute('for', `jogador${jogadorCount}`);
        label.textContent = 'Jogador:';

        const novoSelect = document.createElement('select');
        novoSelect.id = `jogador${jogadorCount}`;
        novoSelect.name = `jogador${jogadorCount}`;
        
        // 1. Copia as op√ß√µes do primeiro campo, que tem a lista completa.
        const primeiroSelect = document.getElementById('jogador1');
        if (primeiroSelect) {
            novoSelect.innerHTML = primeiroSelect.innerHTML;
        }

        // ==========================================================
        // IN√çCIO DA CORRE√á√ÉO PRINCIPAL
        // ==========================================================
        // 2. Coleta TODOS os jogadores j√° selecionados nos campos anteriores.
        const jogadoresJaSelecionados = [];
        for (let i = 1; i < jogadorCount; i++) {
            const selectAnterior = document.getElementById(`jogador${i}`);
            if (selectAnterior && selectAnterior.value && selectAnterior.value !== "Convidado") {
                jogadoresJaSelecionados.push(selectAnterior.value);
            }
        }

        // 3. Remove cada um dos jogadores j√° selecionados do novo dropdown.
        jogadoresJaSelecionados.forEach(apelido => {
            const optionToRemove = novoSelect.querySelector(`option[value="${apelido}"]`);
            if (optionToRemove) {
                optionToRemove.remove();
            }
        });
        // ==========================================================
        // FIM DA CORRE√á√ÉO
        // ==========================================================
        
        newDiv.appendChild(label);
        newDiv.appendChild(novoSelect);
        jogadoresContainer.appendChild(newDiv);

        novoSelect.focus();
    }
};




// SUBSTITUA SUA FUN√á√ÉO 'atualizarTabela' PELA VERS√ÉO ABAIXO
async function atualizarTabela() {

const diaSelecionado = parseInt(document.getElementById('dia').value, 10);
const hoje = new Date();
const diaDaSemanaHoje = hoje.getDay() === 0 ? 7 : hoje.getDay(); // Ajusta Domingo para 7
const isReservaParaHoje = (diaSelecionado === diaDaSemanaHoje);

    const jogadores = [];
    for (let i = 1; i <= jogadorCount; i++) {
        let jogadorSelect = document.getElementById(`jogador${i}`);
        if (jogadorSelect) {
            let apelido = jogadorSelect.value;
            if (apelido) {
                jogadores.push(apelido);
            }
        }
    }

    if (jogadores.length === 0) { alert('Selecione pelo menos 1 jogador.'); return; }
    const jogadorLogado = localStorage.getItem('jogadorLogado');
    //const isAdmin = jogadorLogado === "RONALDO TABORDA";
    const isAula = jogadores.some(j => j.toLowerCase() === "aula");

    if (isAula) {
        // Se for uma aula, apenas o usu√°rio "RILDO SANTOS" ou um Administrador podem agendar.
        if (jogadorLogado !== "RILDO SANTOS" && !isUsuarioAdmin()) {
            alert("Apenas o professor Rildo ou um Administrador podem agendar reservas do tipo 'aula'.");
            limparCampos();
            return;
        }
    } else {
        // Se n√£o for uma aula (jogo normal), um Admin pode agendar para qualquer um.
        // Um usu√°rio comum s√≥ pode agendar se ele mesmo estiver na lista de jogadores.
        if (!isUsuarioAdmin()) {
            // L√≥gica corrigida para verificar se o apelido selecionado corresponde ao nome completo do usu√°rio logado.
            const jogadorEstaNaReserva = jogadores.some(apelidoSelecionado => {
                const infoJogador = jogadoresData[apelidoSelecionado];
                if (infoJogador) {
                    return infoJogador.nomeCompleto.toLowerCase() === jogadorLogado.toLowerCase();
                }
                return false;
            });

            if (!jogadorEstaNaReserva) {
                alert("Voc√™ –Ω–µ pode fazer uma reserva sem constar nela. Por favor, inclua seu nome na lista de jogadores.");
                limparCampos();
                return;
            }
        }
    }
	
	
	const quadra = document.getElementById('quadra').value;
    const dia = parseInt(document.getElementById('dia').value, 10);
    const horaSelecionada = parseInt(document.getElementById('hora').value, 10);
    const duracao = parseInt(document.getElementById('duracao').value);

    const isConvidado = jogadores.includes("Convidado");
	if (isConvidado) {
		// Agora, em vez de buscar no banco, usamos a vari√°vel global.
		const convidadoConfig = convidadoConfigGlobais;

		if (!convidadoConfig) {
			alert("Configura√ß√µes do convidado n√£o encontradas.");
			return;
		}

		// Verifica se todas as quadras est√£o desativadas OU todos os dias est√£o desativados
		if (
			(!convidadoConfig.Quadra1 && !convidadoConfig.Quadra2 && !convidadoConfig.Quadra3) || // Todas as quadras desativadas
			(!convidadoConfig.DiasDeSemana && !convidadoConfig.FimDeSemana) // Todos os dias desativados
		) {
			alert("Convidados n√£o podem jogar, pois todas as quadras ou todos os dias est√£o desativados para n√£o s√≥cios.");
			return;
		}

		// Verifica se a quadra selecionada √© permitida para o convidado
		const quadraPermitida = convidadoConfig[`Quadra${quadra.split(' ')[1]}`];
		if (!quadraPermitida) {
			// Monta a mensagem informando quais quadras s√£o permitidas
			const quadrasPermitidas = [];
			if (convidadoConfig.Quadra1) quadrasPermitidas.push("Quadra 1 - Coberta");
			if (convidadoConfig.Quadra2) quadrasPermitidas.push("Quadra 2 - Aberta");
			if (convidadoConfig.Quadra3) quadrasPermitidas.push("Quadra 3 - Coberta");

			const mensagemQuadras = quadrasPermitidas.length > 0
				? `Convidados s√≥ podem utilizar as seguintes quadras: ${quadrasPermitidas.join(", ")}.`
				: "Convidados n√£o podem utilizar nenhuma quadra.";
			limparCampos();
			alert(mensagemQuadras);
			return;
		}

		// Verifica os dias permitidos para o convidado
		const diaDaSemana = dia >= 1 && dia <= 5; // Segunda a sexta
		const fimDeSemana = dia === 6 || dia === 7; // S√°bado e domingo

		if (!convidadoConfig.DiasDeSemana && !convidadoConfig.FimDeSemana) {
			alert("Convidados n√£o podem fazer reservas em nenhum dia.");
			limparCampos();
			return;
		}

		if (!convidadoConfig.DiasDeSemana && diaDaSemana) {
			alert("Convidados s√≥ podem fazer reservas no fim de semana (s√°bado e domingo).");
			limparCampos();
			return;
		}

		if (!convidadoConfig.FimDeSemana && fimDeSemana) {
			alert("Convidados s√≥ podem fazer reservas durante a semana (segunda a sexta).");
			limparCampos();
			return;
		}
	}
	
	//const duracao = parseInt(document.getElementById('duracao').value);
	if (duracao === 2 && (jogadores.length < 2 || jogadores.length > 4)) { alert('Reservas de 2 horas precisam ter no m√≠nimo 2 e no m√°ximo 4 jogadores.'); return; }
    //const quadra = document.getElementById('quadra').value;
	if (quadrasInativas.has(quadra)) { alert(`A ${quadra} est√° interditada provisoriamente.`); limparCampos(); return; }
    //const dia = parseInt(document.getElementById('dia').value, 10);
    //const horaSelecionada = parseInt(document.getElementById('hora').value, 10);
    if (!validarDiaReserva(jogadores)) { limparCampos(); return; }
    const reservaValida = await validarSeTemReserva(jogadores);
    if (!reservaValida) { limparCampos(); return; }
	const isRegraDuplasOk = await validarRegraDeDuplas(jogadores, quadra, dia, horaSelecionada, duracao);
    if (!isRegraDuplasOk) { limparCampos(); return; }
    
    const isQuebraHorarioOk = validarQuebraHorarioDomingo(dia, horaSelecionada, duracao, quadra);
    if (!isQuebraHorarioOk) {
        limparCampos();
        return; 
    }
    
    let reservaSalvaComSucesso = false;
    agendamentoEmAndamento = true;
	
	try {
        const reservasRef = database.ref(`sistemas/reservas/${quadra}`);
        const key1 = `${dia}_${horaSelecionada}`;
        const key2 = `${dia}_${horaSelecionada + 1}`;
        const snapshot = await reservasRef.once('value');
        const reservas = snapshot.val() || {};
        const loopDuracao = duracao === 3 ? 2 : duracao;
        for (let i = 0; i < loopDuracao; i++) {
            const horarioChave = `${dia}_${horaSelecionada + i}`; 
            if (reservas[horarioChave]) {
                throw new Error('Um ou mais hor√°rios j√° est√£o reservados para essa quadra!');
            }
        }
        
        // --- L√ìGICA DO ORGANIZADOR ---
        const organizadorApelido = Object.keys(jogadoresData).find(apelido => jogadoresData[apelido].nomeCompleto === jogadorLogado) || jogadorLogado;

        if (vReservasPorConfirmacao === false) {
            // L√≥gica para quando o sistema de confirma√ß√£o est√° DESLIGADO
            if (duracao === 1) {
                const reservaData = { jogadores: jogadores.join(', '), dia, hora: horaSelecionada, duracao, borda: '1h', organizador: organizadorApelido }; // ORGANIZADOR ADICIONADO
                await runTransaction(reservasRef.child(key1), currentData => (currentData === null ? reservaData : undefined));
            } else if (duracao === 2 || duracao === 3) {
                let jogadoresParte1 = "", jogadoresParte2 = "";
                if (jogadores.length === 1) {
                    jogadoresParte1 = jogadores[0]; jogadoresParte2 = jogadores[0];
                } else {
                    const parte1Array = [], parte2Array = [];
                    if (jogadores.length >= 1) parte1Array.push(jogadores[0]);
                    if (jogadores.length >= 2) parte2Array.push(jogadores[1]);
                    if (jogadores.length >= 3) parte1Array.push(jogadores[2]);
                    if (jogadores.length >= 4) parte2Array.push(jogadores[3]);
                    jogadoresParte1 = parte1Array.join(', '); jogadoresParte2 = parte2Array.join(', ');
                }
                const reservaData1 = { jogadores: jogadoresParte1, dia, hora: horaSelecionada, duracao, borda: '2h', organizador: organizadorApelido }; // ORGANIZADOR ADICIONADO
                let reservaData2;
                if (duracao === 3) {
                    reservaData2 = { jogadores: jogadoresParte2, dia, hora: horaSelecionada + 1, organizador: organizadorApelido }; // ORGANIZADOR ADICIONADO
                } else {
                    reservaData2 = { jogadores: jogadoresParte2, dia, hora: horaSelecionada + 1, duracao, organizador: organizadorApelido }; // ORGANIZADOR ADICIONADO
                }
                await runTransaction(reservasRef.child(key1), currentData => (currentData === null ? reservaData1 : undefined));
                try {
                    await runTransaction(reservasRef.child(key2), currentData => (currentData === null ? reservaData2 : undefined));
                } catch (err2) {
                    await reservasRef.child(key1).remove(); throw err2;
                }
            }
        } else {
            // L√≥gica para quando o sistema de confirma√ß√£o est√° LIGADO
            const isPiramide = document.getElementById('duracao').value === '3-piramide';
            const outrosJogadores = jogadores.filter(j => j !== organizadorApelido);
            const restoSaoConvidados = outrosJogadores.length > 0 && outrosJogadores.every(j => j.toLowerCase() === 'convidado');

            if (isReservaParaHoje || isAula || jogadores.length === 1 || isPiramide || restoSaoConvidados) {
				// Se a reserva for para HOJE, ou for Aula, 1 jogador, Pir√¢mide ou com Convidados, a reserva √© DIRETA
				console.log("Executando agendamento direto (Reserva para hoje ou caso de exce√ß√£o)...");
                if (duracao === 1) {
                    const reservaData = { jogadores: jogadores.join(', '), dia, hora: horaSelecionada, duracao, borda: '1h', organizador: organizadorApelido }; // ORGANIZADOR ADICIONADO
                    await runTransaction(reservasRef.child(key1), currentData => (currentData === null ? reservaData : undefined));
                } else if (duracao === 2 || duracao === 3) {
                    let jogadoresParte1 = "", jogadoresParte2 = "";
                    if (jogadores.length === 1) {
                        jogadoresParte1 = jogadores[0]; jogadoresParte2 = jogadores[0];
                    } else {
                        const parte1Array = [], parte2Array = [];
                        if (jogadores.length >= 1) parte1Array.push(jogadores[0]);
                        if (jogadores.length >= 2) parte2Array.push(jogadores[1]);
                        if (jogadores.length >= 3) parte1Array.push(jogadores[2]);
                        if (jogadores.length >= 4) parte2Array.push(jogadores[3]);
                        jogadoresParte1 = parte1Array.join(', '); jogadoresParte2 = parte2Array.join(', ');
                    }
                    const reservaData1 = { jogadores: jogadoresParte1, dia, hora: horaSelecionada, duracao, borda: '2h', organizador: organizadorApelido }; // ORGANIZADOR ADICIONADO
                    let reservaData2;
                    if (duracao === 3) {
                        reservaData2 = { jogadores: jogadoresParte2, dia, hora: horaSelecionada + 1, organizador: organizadorApelido }; // ORGANIZADOR ADICIONADO
                    } else {
                        reservaData2 = { jogadores: jogadoresParte2, dia, hora: horaSelecionada + 1, duracao, organizador: organizadorApelido }; // ORGANIZADOR ADICIONADO
                    }
                    await runTransaction(reservasRef.child(key1), currentData => (currentData === null ? reservaData1 : undefined));
                    try {
                        await runTransaction(reservasRef.child(key2), currentData => (currentData === null ? reservaData2 : undefined));
                    } catch (err2) {
                        await reservasRef.child(key1).remove(); throw err2;
                    }
                }
            } else {
                // Caso contr√°rio, a reserva fica PENDENTE de confirma√ß√£o (j√° inclui organizador na 'reservaMetadata')
                console.log("Executando agendamento pendente de confirma√ß√£o...");
                const confirmacoes = {};
                jogadores.forEach(apelido => {
                    if (apelido.toLowerCase() !== 'convidado') {
                        confirmacoes[apelido] = (apelido === organizadorApelido);
                    }
                });
                const expiraEm = Date.now() + (horasParaExpirarConfig * 3600000);
                const reservaMetadata = { jogadores_completo: jogadores.join(', '), status: 'pendente', organizador: organizadorApelido, expiraEm: expiraEm, confirmacoes: confirmacoes };

                if (duracao === 1) {
                    const reservaData = { jogadores: jogadores.join(', '), dia, hora: horaSelecionada, duracao, borda: '1h', ...reservaMetadata };
                    await runTransaction(reservasRef.child(key1), currentData => (currentData === null ? reservaData : undefined));
                } else if (duracao === 2) {
                    let jogadoresPrimeiraHora = "", jogadoresSegundaHora = "";
                    if (jogadores.length === 2) {
                        jogadoresPrimeiraHora = jogadores[0];
                        jogadoresSegundaHora = jogadores[1];
                    } else {
                        jogadoresPrimeiraHora = jogadores.slice(0, 2).join(', ');
                        jogadoresSegundaHora = jogadores.slice(2).join(', ');
                    }
                    const reservaPendente1 = { jogadores: jogadoresPrimeiraHora, dia, hora: horaSelecionada, duracao, borda: '2h', ...reservaMetadata };
                    const reservaPendente2 = { jogadores: jogadoresSegundaHora, dia, hora: horaSelecionada + 1, ...reservaMetadata, duracao }; 
                    
                    await runTransaction(reservasRef.child(key1), currentData => (currentData === null ? reservaPendente1 : undefined));
                    try {
                        await runTransaction(reservasRef.child(key2), currentData => (currentData === null ? reservaPendente2 : undefined));
                    } catch (err2) {
                        await reservasRef.child(key1).remove(); throw err2;
                    }
                }
            }
        }
        reservaSalvaComSucesso = true;
    } catch (error) {
        alert(error.message);
    } finally {
        agendamentoEmAndamento = false;
    }

    if (reservaSalvaComSucesso) {
        const isPiramide = document.getElementById('duracao').value === '3-piramide';
        const organizadorApelido = Object.keys(jogadoresData).find(apelido => jogadoresData[apelido].nomeCompleto === jogadorLogado);
        const outrosJogadores = jogadores.filter(j => j !== organizadorApelido);
        const restoSaoConvidados = outrosJogadores.length > 0 && outrosJogadores.every(j => j.toLowerCase() === 'convidado');
        //const precisaConfirmacao = vReservasPorConfirmacao && !isAula && jogadores.length > 1 && !isPiramide && !restoSaoConvidados;
		const precisaConfirmacao = vReservasPorConfirmacao && !isReservaParaHoje && !isAula && jogadores.length > 1 && !isPiramide && !restoSaoConvidados;
    
        
        if (precisaConfirmacao) {
			 alert('Reserva pr√©-agendada!\nOs outros jogadores precisam confirmar a participa√ß√£o para que o hor√°rio seja garantido.');
		} else {
			 alert('Reserva efetuada com sucesso!');
		}
		
        if (jogadores.includes("Convidado")) {
            exibirMensagemConvidado();
        }
        if (isPiramide) {
            exibirMensagemPiramide();
        }
    }
    
    limparCampos();
    selecionarQuadra(quadra);
}





function capitalizarNome(nome) {
    if (!nome) return ""; // Retorno seguro para strings vazias ou nulas

    return nome.split(' ')
               .map(palavra => palavra.charAt(0).toUpperCase() + palavra.slice(1))
               .join(' ');
}




// Vari√°vel global para rastrear c√©lulas j√° exclu√≠das
const celulasExcluidas = new Set();


// SUBSTITUA SUA FUN√á√ÉO 'excluirReserva' PELA VERS√ÉO ABAIXO
async function excluirReserva(horaIndex, diaIndex) {
    try {
        const jogadorLogado = localStorage.getItem('jogadorLogado');
        if (!jogadorLogado) {
            alert("‚ö†Ô∏è Aten√ß√£o:\n\nN√£o conseguimos identificar o jogador logado!");
            return;
        }

        const quadraAtual = quadraSelecionada;
        const horaClicada = horaIndex + 6;
        const reservasDaQuadraAtual = reservasPorQuadra[quadraAtual] || {};

        let keyPrincipal = `${diaIndex}_${horaClicada}`;
        let reservaPrincipal = reservasDaQuadraAtual[keyPrincipal];

        const keyAnterior = `${diaIndex}_${horaClicada - 1}`;
        const reservaAnterior = reservasDaQuadraAtual[keyAnterior];
        
        if (reservaAnterior && reservaAnterior.duracao > 1 && reservaPrincipal && reservaPrincipal.borda === undefined) {
            keyPrincipal = keyAnterior;
            reservaPrincipal = reservaAnterior;
        }

        if (!reservaPrincipal) {
            console.warn("‚ö†Ô∏è Reserva principal n√£o encontrada. A a√ß√£o ser√° interrompida.");
            return;
        }
        
        const reserva1 = reservaPrincipal;
        const key1 = keyPrincipal;
        const key2 = `${diaIndex}_${reserva1.hora + 1}`;
        const reserva2 = (reserva1.duracao > 1) ? reservasDaQuadraAtual[key2] : null;

        let temPermissao = false;
        const apelidoJogadorLogado = Object.keys(jogadoresData).find(
            apelido => jogadoresData[apelido].nomeCompleto.toLowerCase() === jogadorLogado.toLowerCase()
        ) || jogadorLogado;
        const isAula = (reserva1.jogadores_completo || reserva1.jogadores).toLowerCase().trim() === 'aula';
        
        if (isAula) {
            if (jogadorLogado === "RILDO SANTOS" || isUsuarioAdmin()) { temPermissao = true; } 
            else { alert("‚õî Aten√ß√£o:\n\nApenas o professor RILDO SANTOS ou o Administrador podem excluir reservas do tipo 'aula'."); }
        } else if (vReservasPorConfirmacao === true && reserva1.status === 'pendente') {
            if (isUsuarioAdmin() || reserva1.organizador === apelidoJogadorLogado) { temPermissao = true; } 
            else { alert("‚õî Aten√ß√£o:\n\nApenas o organizador da reserva ou o administrador podem excluir uma reserva pendente."); }
        } else {
            let jogadoresNaReserva = (reserva1.jogadores_completo || reserva1.jogadores).split(', ').map(j => j.trim());
            if (reserva2 && (reserva2.jogadores_completo || reserva2.jogadores)) {
                const jogadoresSegundaParte = (reserva2.jogadores_completo || reserva2.jogadores).split(', ').map(j => j.trim());
                jogadoresNaReserva = [...new Set([...jogadoresNaReserva, ...jogadoresSegundaParte])];
            }
            const statusDoJogador = reserva1.confirmacoes ? reserva1.confirmacoes[apelidoJogadorLogado] : undefined;
            if (isUsuarioAdmin() || (jogadoresNaReserva.includes(apelidoJogadorLogado) && statusDoJogador !== 'recusado')) {
                temPermissao = true;
            } else {
                if (statusDoJogador === 'recusado') {
                    alert("‚õî Aten√ß√£o:\n\nVoc√™ n√£o pode excluir uma reserva que j√° recusou.");
                } else {
                    alert("‚õî Aten√ß√£o:\n\nApenas jogadores da reserva podem exclu√≠-la!");
                }
            }
        }

        if (temPermissao) {
            const dataReserva = document.getElementById('tabelaQuadra').rows[1].cells[diaIndex-1]?.textContent.trim().replace(/\//g, '-');
            const duracaoDaReserva = reserva1.duracao === 3 ? 2 : reserva1.duracao;
            const horaFinal = reserva1.hora + duracaoDaReserva;
            const horarioFormatado = `${String(reserva1.hora).padStart(2, '0')}:00 - ${String(horaFinal).padStart(2, '0')}:00`;
            
            let listaJogadoresParaLog;
            if (reserva1.jogadores_completo) {
                listaJogadoresParaLog = reserva1.jogadores_completo.split(',').map(j => j.trim());
            } else {
                let listaCombinada = (reserva1.jogadores).split(',').map(j => j.trim());
                if (reserva2 && reserva2.jogadores) {
                    const jogadoresSegundaParte = (reserva2.jogadores).split(',').map(j => j.trim());
                    listaCombinada.push(...jogadoresSegundaParte);
                }
                const socios = listaCombinada.filter(j => j.toLowerCase() !== 'convidado');
                const convidados = listaCombinada.filter(j => j.toLowerCase() === 'convidado');
                const sociosUnicos = [...new Set(socios)];
                listaJogadoresParaLog = [...sociosUnicos, ...convidados];
            }

            let duracaoTexto = reserva1.duracao === 1 ? "1 Hora" : "2 Horas";
            if(reserva1.duracao === 3) duracaoTexto = "2 Horas - Pir√¢mide";

            const jogadoresComPosicao = listaJogadoresParaLog.map(apelido => {
                const jogadorInfo = jogadoresData[apelido.trim()];
                return {
                    apelido: apelido,
                    posicao: jogadorInfo ? jogadorInfo.piramide : "0"
                };
            });
            
            // --- IN√çCIO DA ATUALIZA√á√ÉO PARA O LOG DO ADMIN ---
            
            const isParticipante = listaJogadoresParaLog.includes(apelidoJogadorLogado);
            let usuarioParaLog = jogadorLogado; // Valor padr√£o √© o nome normal.
            
            // Se o usu√°rio for admin E N√ÉO for participante, formata o nome para o log.
            if (isUsuarioAdmin() && !isParticipante) {
                usuarioParaLog = `${jogadorLogado} (Admin)`;
            }
            
            let logData = {
                quadra: quadraAtual,
                horario: horarioFormatado,
                jogadores: jogadoresComPosicao,
                usuario: usuarioParaLog, // <-- USA A NOVA VARI√ÅVEL
                duracao: duracaoTexto,
                data: dataReserva,
				motivo: "Exclu√≠do manualmente pelo usu√°rio"
            };

            // --- FIM DA ATUALIZA√á√ÉO ---

            if (reserva1.status) {
                logData.statusNoMomentoDaExclusao = reserva1.status;
                logData.organizadorDaReserva = reserva1.organizador;
				logData.confirmacoes = traduzirConfirmacoesParaLog(reserva1.confirmacoes);
            } else {
                logData.statusNoMomentoDaExclusao = 'confirmada';
            }
            
            if (reserva1.resultado) {
                logData.resultado = reserva1.resultado;
            }
			
			if (reserva1.resultadoDuplas) {
                logData.resultadoDuplas = reserva1.resultadoDuplas;
            }
            
            registrarExclusao(logData);
            
            const updates = {};
            updates[`sistemas/reservas/${quadraAtual}/${key1}`] = null;
            if (reserva1.duracao > 1) {
                updates[`sistemas/reservas/${quadraAtual}/${key2}`] = null;
            }
            database.ref().update(updates);
            
            console.log("‚úÖ Comandos de exclus√£o enviados para o Firebase.");
        }
    } catch (error) {
        console.error("‚ùå Erro fatal durante a exclus√£o:", error);
        alert("‚ö†Ô∏è Ocorreu um erro inesperado durante a exclus√£o.");
    }
}



// Fun√ß√£o para limpar o conte√∫do da c√©lula
function limparCelula(celula) {
    if (celula) {
        celula.innerHTML = ""; // Limpa o conte√∫do da c√©lula
        celula.style.backgroundColor = ""; // Restaura a cor de fundo
        celula.style.border = "1px solid #ddd"; // Restaura a borda padr√£o
        celula.removeAttribute('data-duracao'); // Remove o atributo de dura√ß√£o

        // Remover rowSpan apenas se a reserva for de 2 horas e tiver apenas um jogador
        if (celula.rowSpan === 2) {
            celula.rowSpan = 1; // Restaura o rowSpan para o padr√£o
        }
    }
}

const reservasExcluidasFirebase = new Set();

function excluirReservaFirebase(horaSelecionada, diaIndex, quadra) {
    const key = `${diaIndex}_${horaSelecionada}`;

    if (!reservasExcluidasFirebase.has(key)) {
        reservasExcluidasFirebase.add(key);
        database.ref(`sistemas/reservas/${quadra}/${key}`).remove()
            .then(() => {
                reservasExcluidasFirebase.delete(key);
            })
            .catch((error) => console.error(`Erro ao remover a reserva do Firebase: ${error}`));
    }
}

function limparCampos() {
    // N√£o reseta o campo "Jogador 1" e mant√©m o seu valor
    const jogadoresContainer = document.getElementById('jogadoresContainer');
    while (jogadoresContainer.children.length > 1) {
        jogadoresContainer.removeChild(jogadoresContainer.lastChild); // Remove apenas os campos de jogador adicionais
    }
    jogadorCount = 1; // Reseta o contador de jogadores para 1
    document.getElementById('dataForm').reset(); // Reseta o formul√°rio
    document.getElementById('jogador1').value = ''; // Mant√©m o campo "Jogador 1"
    document.getElementById('duracao').value = '1'; // Reseta a dura√ß√£o para 1 hora
	//alert('limparCampos');
    atualizarOpcoesHorario(); // Atualiza as op√ß√µes de hor√°rio
	
	// Procura e remove a op√ß√£o 'Aula' de todos os seletores de jogador
    document.querySelectorAll('select[id^="jogador"]').forEach(select => {
        const aulaOption = select.querySelector("option[value='aula']");
        if (aulaOption) {
            aulaOption.remove();
        }
    });
	
}

// Monitora as altera√ß√µes no Firebase
const reservasRef = database.ref('sistemas/reservas/' + quadraSelecionada);
reservasRef.off('value'); // Remove ouvintes anteriores

reservasRef.on('value', (snapshot) => {
    const reservas = snapshot.val();

    limparTabela(); // Limpa toda a tabela antes de preencher com dados atualizados

    if (reservas) {
        for (const key in reservas) {
            const { jogadores, dia, hora, duracao, borda } = reservas[key];
            const rowIndex = hora - 6;

            // Atualiza a c√©lula com os jogadores recuperados do Firebase
            document.getElementById('tabelaCorpo').rows[rowIndex].cells[dia].innerHTML = jogadores;

            // Aplica a cor de fundo com base na reserva
            let corFundo;
            //if (jogadores.toLowerCase().includes('aula')) {
			if (jogadores.toLowerCase().trim() === 'aula') {
                corFundo = 'lightcoral';
            } else {
                corFundo = duracao === 1 ? 'lightgreen' : 'lightblue';
            }

            const cell = document.getElementById('tabelaCorpo').rows[rowIndex]?.cells[dia];
            if (cell) {
                cell.style.backgroundColor = corFundo;
            }

            // Aplica bordas dependendo da dura√ß√£o da reserva
            if (borda === '1h') {
                document.getElementById('tabelaCorpo').rows[rowIndex].cells[dia].style.border = '2px solid black';
            } else if (borda === '2h') {
                document.getElementById('tabelaCorpo').rows[rowIndex].cells[dia].style.borderTop = '2px solid black';
                document.getElementById('tabelaCorpo').rows[rowIndex].cells[dia].style.borderLeft = '2px solid black';
                document.getElementById('tabelaCorpo').rows[rowIndex].cells[dia].style.borderRight = '2px solid black';
                document.getElementById('tabelaCorpo').rows[rowIndex].cells[dia].style.borderBottom = 'none';

                document.getElementById('tabelaCorpo').rows[rowIndex + 1].cells[dia].style.borderTop = 'none';
                document.getElementById('tabelaCorpo').rows[rowIndex + 1].cells[dia].style.borderLeft = '2px solid black';
                document.getElementById('tabelaCorpo').rows[rowIndex + 1].cells[dia].style.borderRight = '2px solid black';
                document.getElementById('tabelaCorpo').rows[rowIndex + 1].cells[dia].style.borderBottom = '2px solid black';
            }
        }

        // Ap√≥s recuperar as reservas, adicionar eventos de clique nas c√©lulas
        configurarEventosDaTabela();
    }
});

function atualizarDatas() {
  const dataInicio = new Date();
  
  let diaDaSemana = dataInicio.getDay(); 
  const dias = document.querySelectorAll("th");
  //let vAtualizarDatas = 1; 

  const linhaDatas = dias[0].parentNode.nextElementSibling;

  try {
    if (!vLimparDiasAnteriores) { 
            LimparDiasAnteriores();
            vLimparDiasAnteriores = true; // Define como falso ap√≥s a primeira execu√ß√£o
    }
  } catch (error){
        console.error("Erro ao limpar dias anteriores:", error);
    }


  
  //alert(`dia da semana: ${diaDaSemana}`);
  
  switch (DiasParaLimpar) {
  //switch (vAtualizarDatas) {
    case 1: 
      switch (diaDaSemana) {
        case 0: preencherCeldas(dataInicio, [1, 2, 3, 4, 5, -1, 0], linhaDatas); break;
        case 1: preencherCeldas(dataInicio, [0, 1, 2, 3, 4, 5, -1], linhaDatas); break;
        case 2: preencherCeldas(dataInicio, [-1, 0, 1, 2, 3, 4, 5], linhaDatas); break;
        case 3: preencherCeldas(dataInicio, [5, -1, 0, 1, 2, 3, 4], linhaDatas); break;
        case 4: preencherCeldas(dataInicio, [4, 5, -1, 0, 1, 2, 3], linhaDatas); break;
        case 5: preencherCeldas(dataInicio, [3, 4, 5, -1, 0, 1, 2], linhaDatas); break;
        case 6: preencherCeldas(dataInicio, [2, 3, 4, 5, -1, 0, 1], linhaDatas); break;
      }
      break;
    case 2:
      switch (diaDaSemana) {
        case 0: preencherCeldas(dataInicio, [1, 2, 3, 4, -2, -1, 0], linhaDatas); break;
        case 1: preencherCeldas(dataInicio, [0, 1, 2, 3, 4, -2, -1], linhaDatas); break;
        case 2: preencherCeldas(dataInicio, [-1, 0, 1, 2, 3, 4, -2], linhaDatas); break;
        case 3: preencherCeldas(dataInicio, [-2, -1, 0, 1, 2, 3, 4], linhaDatas); break;
        case 4: preencherCeldas(dataInicio, [4, -2, -1, 0, 1, 2, 3], linhaDatas); break;
        case 5: preencherCeldas(dataInicio, [3, 4, -2, -1, 0, 1, 2], linhaDatas); break;
        case 6: preencherCeldas(dataInicio, [2, 3, 4, -2, -1, 0, 1], linhaDatas); break;
      }
      break;
    case 3:
      switch (diaDaSemana) {
        case 0: preencherCeldas(dataInicio, [1, 2, 3, -3, -2, -1, 0], linhaDatas); break;
        case 1: preencherCeldas(dataInicio, [0, 1, 2, 3, -3, -2, -1], linhaDatas); break;
        case 2: preencherCeldas(dataInicio, [-1, 0, 1, 2, 3, -3, -2], linhaDatas); break;
        case 3: preencherCeldas(dataInicio, [-2, -1, 0, 1, 2, 3, -3], linhaDatas); break;
        case 4: preencherCeldas(dataInicio, [-3, -2, -1, 0, 1, 2, 3], linhaDatas); break;
        case 5: preencherCeldas(dataInicio, [3, -3, -2, -1, 0, 1, 2], linhaDatas); break;
        case 6: preencherCeldas(dataInicio, [2, 3, -3, -2, -1, 0, 1], linhaDatas); break;
      }
      break;
    case 4:
      switch (diaDaSemana) {
        case 0: preencherCeldas(dataInicio, [1, 2, -4, -3, -2, -1, 0], linhaDatas); break;
        case 1: preencherCeldas(dataInicio, [0, 1, 2, -4, -3, -2, -1], linhaDatas); break;
        case 2: preencherCeldas(dataInicio, [-1, 0, 1, 2, -4, -3, -2], linhaDatas); break;
        case 3: preencherCeldas(dataInicio, [-2, -1, 0, 1, 2, -4, -3], linhaDatas); break;
        case 4: preencherCeldas(dataInicio, [-3, -2, -1, 0, 1, 2, -4], linhaDatas); break;
        case 5: preencherCeldas(dataInicio, [-4, -3, -2, -1, 0, 1, 2], linhaDatas); break;
        case 6: preencherCeldas(dataInicio, [2, -4, -3, -2, -1, 0, 1], linhaDatas); break;
      }
      break;
    case 5:
      switch (diaDaSemana) {
        case 0: preencherCeldas(dataInicio, [1, -5, -4, -3, -2, -1, 0], linhaDatas); break;
        case 1: preencherCeldas(dataInicio, [0, 1, -5, -4, -3, -2, -1], linhaDatas); break;
        case 2: preencherCeldas(dataInicio, [-1, 0, 1, -5, -4, -3, -2], linhaDatas); break;
        case 3: preencherCeldas(dataInicio, [-2, -1, 0, 1, -5, -4, -3], linhaDatas); break;
        case 4: preencherCeldas(dataInicio, [-3, -2, -1, 0, 1, -5, -4], linhaDatas); break;
        case 5: preencherCeldas(dataInicio, [-4, -3, -2, -1, 0, 1, -5], linhaDatas); break;
        case 6: preencherCeldas(dataInicio, [-5, -4, -3, -2, -1, 0, 1], linhaDatas); break;
      }
      break;
    case 6:
      switch (diaDaSemana) {
        case 0: preencherCeldas(dataInicio, [-6, -5, -4, -3, -2, -1, 0], linhaDatas); break;
        case 1: preencherCeldas(dataInicio, [0, -6, -5, -4, -3, -2, -1], linhaDatas); break;
        case 2: preencherCeldas(dataInicio, [-1, 0, -6, -5, -4, -3, -2], linhaDatas); break;
        case 3: preencherCeldas(dataInicio, [-2, -1, 0, -6, -5, -4, -3], linhaDatas); break;
        case 4: preencherCeldas(dataInicio, [-3, -2, -1, 0, -6, -5, -4], linhaDatas); break;
        case 5: preencherCeldas(dataInicio, [-4, -3, -2, -1, 0, -6, -5], linhaDatas); break;
        case 6: preencherCeldas(dataInicio, [-5, -4, -3, -2, -1, 0, -6], linhaDatas); break;
      }
      break;
	  case 7:
      switch (diaDaSemana) {
        case 0: preencherCeldas(dataInicio, [-6, -5, -4, -3, -2, -1, 0], linhaDatas); break;
        case 1: preencherCeldas(dataInicio, [0, -6, -5, -4, -3, -2, -1], linhaDatas); break;
        case 2: preencherCeldas(dataInicio, [-1, 0, -6, -5, -4, -3, -2], linhaDatas); break;
        case 3: preencherCeldas(dataInicio, [-2, -1, 0, -6, -5, -4, -3], linhaDatas); break;
        case 4: preencherCeldas(dataInicio, [-3, -2, -1, 0, -6, -5, -4], linhaDatas); break;
        case 5: preencherCeldas(dataInicio, [-4, -3, -2, -1, 0, -6, -5], linhaDatas); break;
        case 6: preencherCeldas(dataInicio, [-5, -4, -3, -2, -1, 0, -6], linhaDatas); break;
      }
      break;
  }
  
}

function preencherCeldas(dataInicio, ajustes, linhaDatas) {
  for (let i = 0; i < ajustes.length; i++) {
    let novaData = new Date(dataInicio);
    novaData.setDate(dataInicio.getDate() + ajustes[i]);

    linhaDatas.children[i].innerHTML = novaData.toLocaleDateString('pt-BR');
  }
}



// SUBSTITUA SUA FUN√á√ÉO 'LimparDiasAnteriores' PELA VERS√ÉO ABAIXO
// SUBSTITUA A SUA FUN√á√ÉO INTEIRA PELA VERS√ÉO FINAL ABAIXO
async function LimparDiasAnteriores() {
    console.log("üü¢ Iniciando LimparDiasAnteriores...");
    const reservasParaExcluir = [];
    const updates = {};
    let operacaoSucesso = true;

    try {
        const dataAtual = new Date();
        dataAtual.setHours(0, 0, 0, 0);
        const quadras = ["Quadra 1 - Coberta", "Quadra 2 - Aberta", "Quadra 3 - Coberta"];

        for (const quadra of quadras) {
            for (let dia = 2; dia <= DiasParaLimpar; dia++) {
                const dataParaLimpar = new Date(dataAtual);
                dataParaLimpar.setDate(dataAtual.getDate() - dia);
                const diaIndex = dataParaLimpar.getDay() === 0 ? 7 : dataParaLimpar.getDay();

                for (let hora = 6; hora <= 22; hora++) {
                    const key = `${diaIndex}_${hora}`;
                    const snapshot = await database.ref(`sistemas/reservas/${quadra}/${key}`).once('value');
                    const reserva = snapshot.val();

                    if (!reserva) continue;

                    // CASO 1: √â UMA PEND√äNCIA DA PIR√ÇMIDE PARA AUTO-CONFIRMAR?
                    if (reserva.status === 'resultado_pendente' && reserva.duracao === 3 && reserva.resultado) {
                        console.warn(`‚è≥ Auto-confirmando resultado pendente em ${quadra} (${key}).`);

                        // --- IN√çCIO DA ADI√á√ÉO DA L√ìGICA DE LOG ---
                        let jogadoresArray;
                        if (reserva.jogadores_completo) {
                            jogadoresArray = reserva.jogadores_completo.split(',').map(j => j.trim());
                        } else {
                            const segundaSnapshot = await database.ref(`sistemas/reservas/${quadra}/${diaIndex}_${hora + 1}`).once('value');
                            const segundaReserva = segundaSnapshot.val();
                            jogadoresArray = [reserva.jogadores, segundaReserva?.jogadores].filter(Boolean).map(j => j.trim());
                        }
                        
                        const dataFormatada = dataParaLimpar.toLocaleDateString('pt-BR').replace(/\//g, '-');
                        const horarioFormatado = `${hora.toString().padStart(2, '0')}:00 - ${(hora + 2).toString().padStart(2, '0')}:00`;
                        const jogadoresComPosicao = jogadoresArray.map(apelido => ({
                            apelido: apelido,
                            posicao: getDisplayRank(jogadoresData[apelido.trim()]?.piramide) || "0"
                        }));

                        let logData = {
                            exclusao: new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }).replace(',', ''),
                            quadra: quadra, data: dataFormatada, horario: horarioFormatado, duracao: "2 Horas - Pir√¢mide",
                            jogadores: jogadoresComPosicao, usuario: "SISTEMA",
                            motivo: "Resultado confirmado e reserva limpa automaticamente por decurso de prazo.",
                            statusNoMomentoDaExclusao: reserva.status, organizadorDaReserva: reserva.organizador,
                            confirmacoes: traduzirConfirmacoesParaLog(reserva.confirmacoes), resultado: reserva.resultado
                        };
                        reservasParaExcluir.push(logData);
                        // --- FIM DA ADI√á√ÉO DA L√ìGICA DE LOG ---

                        const rankUpdates = processarTrocaDeRanking(reserva); 
                        Object.assign(updates, rankUpdates);

                        const dataReserva = dataParaLimpar.toLocaleDateString('pt-BR');
                        const vencedorApelido = reserva.resultado.vencedor;
                        const perdedorApelido = reserva.resultado.perdedor;
                        const vencedorInfo = jogadoresData[vencedorApelido];
                        const perdedorInfo = jogadoresData[perdedorApelido];

                        if (vencedorInfo && perdedorInfo) {
                            const decisao = "confirmado automaticamente por decurso de prazo";
                            const placarFormatado = formatarPlacarParaMensagem(reserva.resultado);
                            const detalhesAdicionais = `\n${placarFormatado}\nVencedor(a): ${vencedorApelido}.`;

                            const msgParaVencedor = `O resultado do seu jogo da Pir√¢mide contra ${perdedorApelido} (${dataReserva}) foi ${decisao}.${detalhesAdicionais}`;
                            const msgParaPerdedor = `O resultado do seu jogo da Pir√¢mide contra ${vencedorApelido} (${dataReserva}) foi ${decisao}.${detalhesAdicionais}`;
                            
                            const notificacaoKeyVencedor = database.ref().push().key;
                            const notificacaoKeyPerdedor = database.ref().push().key;
                            
                            // Salva a notifica√ß√£o correta para cada jogador
                            updates[`sistemas/cadastro/jogadores/${vencedorInfo.nomeCompleto}/notificacoes/${notificacaoKeyVencedor}`] = msgParaVencedor;
                            updates[`sistemas/cadastro/jogadores/${perdedorInfo.nomeCompleto}/notificacoes/${notificacaoKeyPerdedor}`] = msgParaPerdedor;
                            // --- FIM DA CORRE√á√ÉO ---
                        }

                        updates[`sistemas/reservas/${quadra}/${key}`] = null;
                        const key2 = `${diaIndex}_${hora + 1}`;
                        updates[`sistemas/reservas/${quadra}/${key2}`] = null;
                    
                    } 
                    // CASO 2: √â UMA RESERVA NORMAL ANTIGA PARA APAGAR? (Sua l√≥gica original INTACTA)
                    else if (reserva.jogadores?.toLowerCase().trim() !== 'aula' && reserva.borda) {
                        
                        let jogadoresArray;
                        if (reserva.jogadores_completo) {
                            jogadoresArray = reserva.jogadores_completo.split(',').map(j => j.trim());
                        } else {
                            let jogadoresCombinados = reserva.jogadores;
                            if (reserva.duracao > 1) {
                                const segundaSnapshot = await database.ref(`sistemas/reservas/${quadra}/${diaIndex}_${hora + 1}`).once('value');
                                const segundaReserva = segundaSnapshot.val();
                                if (segundaReserva?.jogadores) {
                                    jogadoresCombinados += `, ${segundaReserva.jogadores}`;
                                }
                            }
                            jogadoresArray = [...new Set(jogadoresCombinados.split(',').map(j => j.trim()))];
                        }

                        const dataFormatada = dataParaLimpar.toLocaleDateString('pt-BR').replace(/\//g, '-');
                        const horasParaAdicionar = reserva.duracao === 3 ? 2 : reserva.duracao;
                        const horarioFormatado = `${hora.toString().padStart(2, '0')}:00 - ${(hora + horasParaAdicionar).toString().padStart(2, '0')}:00`;
                        let duracaoTexto = reserva.duracao === 1 ? "1 Hora" : "2 Horas";
                        if (reserva.duracao === 3) duracaoTexto = "2 Horas - Pir√¢mide";
                        const jogadoresComPosicao = jogadoresArray.map(apelido => ({
                            apelido: apelido,
                            posicao: getDisplayRank(jogadoresData[apelido.trim()]?.piramide) || "0"
                        }));

                        let logData = {
                            exclusao: new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }).replace(',', ''),
                            quadra: quadra, data: dataFormatada, horario: horarioFormatado, duracao: duracaoTexto,
                            jogadores: jogadoresComPosicao, usuario: "SISTEMA", motivo: "Limpeza autom√°tica de reserva antiga"
                        };
                        
                        if (reserva.status) {
                            logData.statusNoMomentoDaExclusao = reserva.status;
                            logData.organizadorDaReserva = reserva.organizador;
							logData.confirmacoes = traduzirConfirmacoesParaLog(reserva.confirmacoes);
                        }
                        if (reserva.resultado) {
                            logData.resultado = reserva.resultado;
                        }
						if (reserva.resultadoDuplas) {
                            logData.resultadoDuplas = reserva.resultadoDuplas;
                        }
                        reservasParaExcluir.push(logData);

                        updates[`sistemas/reservas/${quadra}/${key}`] = null;
                        if (reserva.duracao > 1) {
                            const key2 = `${diaIndex}_${hora + 1}`;
                            updates[`sistemas/reservas/${quadra}/${key2}`] = null;
                        }
                    }
                }
            }
        }

        if (Object.keys(updates).length > 0) {
            await database.ref().update(updates);
        }
        if (reservasParaExcluir.length > 0) {
            await registrarExclusao(reservasParaExcluir);
        } else if (Object.keys(updates).length === 0) {
            console.log("‚ÑπÔ∏è Nenhuma reserva antiga para remover ou confirmar.");
        }

    } catch (erro) {
        console.error(`‚ö†Ô∏è ERRO na fun√ß√£o LimparDiasAnteriores: ${erro.message}`);
        operacaoSucesso = false;
        if (reservasParaExcluir.length > 0) {
            try { await registrarExclusao(reservasParaExcluir); } catch (erroLog) { console.error(`‚ö†Ô∏è ERRO ao registrar logs: ${erroLog.message}`); }
        }
    } finally {
        console.log(operacaoSucesso ? "‚úÖ Opera√ß√£o de limpeza conclu√≠da" : "‚ö†Ô∏è Opera√ß√£o de limpeza conclu√≠da com erros");
    }
}



// As vari√°veis globais permanecem as mesmas
let jogadoresData = {};
let jogadoresListener = null;

// As vari√°veis globais e a fun√ß√£o encontrarLinha permanecem as mesmas.

function carregarJogadores() {
    return new Promise((resolve, reject) => {
        console.log("üîÑ Carregando jogadores...");
        const jogadoresRef = database.ref("sistemas/cadastro/jogadores");
        const duracaoSelect = document.getElementById('duracao');
        const jogadorLogadoNome = localStorage.getItem('jogadorLogado');

        if (jogadoresListener) {
            jogadoresRef.off('value', jogadoresListener);
        }

        jogadoresListener = jogadoresRef.on('value', (snapshot) => {
            const todosJogadores = snapshot.val();
            if (!todosJogadores) {
                console.error("Nenhum jogador encontrado no banco de dados.");
                resolve(); 
                return;
            }

            jogadoresData = {};
            Object.keys(todosJogadores).forEach((nome) => {
                const jogador = todosJogadores[nome];
                jogadoresData[jogador.apelido] = {
                    nomeCompleto: nome,
                    piramide: jogador.piramide || "0",
					niver: jogador.niver || ""
                };
            });

            let jogadoresParaExibir = { ...todosJogadores };
            const duracao = duracaoSelect ? duracaoSelect.value : "";

            if (duracao === "3-piramide") {
                console.log("üêç Modo Pir√¢mide ativado. Filtrando lista de oponentes...");
                const jogadorLogadoApelido = Object.keys(jogadoresData).find(
                    apelido => jogadoresData[apelido].nomeCompleto === jogadorLogadoNome
                );
                const jogadorLogadoInfo = jogadorLogadoApelido ? jogadoresData[jogadorLogadoApelido] : null;

                if (!jogadorLogadoInfo || !jogadorLogadoInfo.piramide || jogadorLogadoInfo.piramide === "0") {
                    alert("Voc√™ n√£o participa da Pir√¢mide, portanto n√£o pode agendar jogos.");
                    jogadoresParaExibir = {};
                } else {
                    const posLogado = parseInt(jogadorLogadoInfo.piramide, 10);
                    let oponentesValidos = {};

                    // Filtro para Pir√¢mide Feminina (Posi√ß√£o >= 61) - L√ìGICA ORIGINAL MANTIDA
                    if (posLogado >= 61) {
                        Object.keys(todosJogadores).forEach(nome => {
                            const oponente = todosJogadores[nome];
                            if (parseInt(oponente.piramide, 10) >= 61) {
                                oponentesValidos[nome] = oponente;
                            }
                        });
                    } 
                    // --- IN√çCIO DA NOVA L√ìGICA (SUBSTITUI√á√ÉO) ---
                    // Filtro para Pir√¢mide Masculina (Posi√ß√£o 1-60) com a "Regra de Desafio Ascendente"
                    else {
                        console.log("üêç Pir√¢mide Masculina: Aplicando nova 'Regra de Desafio Ascendente'.");
                        const nomeCompletoLogado = jogadoresData[jogadorLogadoApelido].nomeCompleto;

                        Object.keys(todosJogadores).forEach(nomeOponente => {
                            const oponente = todosJogadores[nomeOponente];
                            const posOponente = parseInt(oponente.piramide, 10);

                            // Ignora oponentes inv√°lidos, da pir√¢mide feminina, ou o pr√≥prio jogador
                            if (!posOponente || posOponente > 60 || posOponente === posLogado) {
                                return;
                            }

                            // CONDI√á√ÉO 1: O jogador logado pode desafiar o oponente? (Desafio para cima)
                            const limiteLogado = encontrarLinha(posLogado);
                            const euPossoDesafiar = (posLogado - limiteLogado) <= posOponente && posOponente < posLogado;

                            // CONDI√á√ÉO 2: O oponente pode desafiar o jogador logado? (Desafio vindo de baixo)
                            const limiteOponente = encontrarLinha(posOponente);
                            const oponentePodeMeDesafiar = (posOponente - limiteOponente) <= posLogado && posLogado < posOponente;

                            // Se qualquer uma das condi√ß√µes for verdadeira, a "conex√£o" √© v√°lida
                            if (euPossoDesafiar || oponentePodeMeDesafiar) {
                                oponentesValidos[nomeOponente] = oponente;
                            }
                        });
                        
                        // Adiciona o pr√≥prio jogador logado √† lista para que ele apare√ßa no dropdown
                        if (todosJogadores[nomeCompletoLogado]) {
                            oponentesValidos[nomeCompletoLogado] = todosJogadores[nomeCompletoLogado];
                        }
                    }
                    // --- FIM DA NOVA L√ìGICA (SUBSTITUI√á√ÉO) ---
                    jogadoresParaExibir = oponentesValidos;
                }
            }
            
            const selectsParaPreencher = [];
            document.querySelectorAll('select[id^="jogador"]').forEach(select => {
                selectsParaPreencher.push(select); 
            });
            if (!jogadorLogadoNome) {
                const selectLogin = document.getElementById("jogadorSelect");
                if (selectLogin) selectsParaPreencher.push(selectLogin);
            }
            
            selectsParaPreencher.forEach(select => {
                const valorJaSelecionado = select.value;
                select.innerHTML = '<option value="">Selecione um jogador</option>';
                Object.keys(jogadoresParaExibir).forEach((nome) => {
                    const jogador = jogadoresParaExibir[nome];
                    const option = document.createElement('option');
                    option.value = jogador.apelido;
                    option.textContent = nome;
                    select.appendChild(option);
                });
                if (select.querySelector(`option[value='${valorJaSelecionado}']`)) {
                    select.value = valorJaSelecionado;
                }
            });
            
            resolve();

        }, (error) => {
            console.error("Erro ao carregar jogadores do Firebase:", error);
            reject(error);
        });
    });
}



// Chame a fun√ß√£o para carregar os jogadores ao carregar a p√°gina
// Chame a fun√ß√£o para carregar os jogadores ao carregar a p√°gina
window.onload = function () {
    console.log("‚úÖ P√°gina carregada - Chamando verificarVersao()");
    verificarVersao();
	removerSessoesAntigas();

    let jogadorLogado = localStorage.getItem('jogadorLogado');
    let loginScreen = document.getElementById('loginScreen');
    let contentElement = document.getElementById('content');
    let loadingElement = document.getElementById('loading');

    // Esconde as telas principais por padr√£o para evitar "piscar" na tela
    loginScreen.style.display = 'none';
    contentElement.style.display = 'none';

    console.log("üîÑ Chamando carregarJogadores()");
    carregarJogadores(jogadorLogado).then(() => {
        console.log("‚úÖ Jogadores carregados!");

        InicializarSistema().then(() => {
            console.log("‚úÖ Sistema inicializado!");

            // Atraso para garantir que a tela de "Carregando" seja vista
            setTimeout(() => {
                // Esconde a tela de carregamento
                if (loadingElement) loadingElement.style.display = 'none';

                if (jogadorLogado) {
                    // Se o usu√°rio est√° logado, mostra o conte√∫do principal
                    contentElement.style.display = 'block';
                    // E checa se √© seu anivers√°rio
                    checarAniversario();
                } else {
                    // Se o usu√°rio n√£o est√° logado, mostra a tela de login
					document.getElementById('pageOverlay').style.display = 'block';
                    loginScreen.style.display = 'block';
                }
            }, 500); // Meio segundo de atraso. Ajuste se desejar.


            // L√≥gica de sess√£o online (continua a mesma)
            if (jogadorLogado) {
                const sessionId = localStorage.getItem("sessionId") || Math.random().toString(36).substr(2, 9);
                localStorage.setItem("sessionId", sessionId);
                const userStatusRef = database.ref(`sistemas/usuariosOnline/${sessionId}`);
                userStatusRef.set({
                    sessionId: sessionId,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    usuario: jogadorLogado
                });
                userStatusRef.onDisconnect().remove();
            } else {
                const sessionId = localStorage.getItem("sessionId") || Math.random().toString(36).substr(2, 9);
                localStorage.setItem("sessionId", sessionId);
                const userStatusRef = database.ref(`sistemas/usuariosOnline/${sessionId}`);
                userStatusRef.set({
                    sessionId: sessionId,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    usuario: 'primeiro acesso'
                });
                userStatusRef.onDisconnect().remove();
            }

        }).catch(error => {
            console.error("‚ùå Erro ao inicializar o sistema:", error);
            if (loadingElement) loadingElement.style.display = 'none'; // Esconde o loading tamb√©m em caso de erro
        });
    }).catch(error => {
        console.error("‚ùå Erro ao carregar jogadores:", error);
        if (loadingElement) loadingElement.style.display = 'none'; // Esconde o loading tamb√©m em caso de erro
    });
};



document.addEventListener('DOMContentLoaded', () => {
//alert('entrei no addEventListener');
    const tabelaContainer = document.querySelector('.tabela-container');
    const horariosColuna = document.querySelectorAll('#tabelaCorpo td:first-child, #tabelaCorpo td:last-child');
    let isExpanded = false;

    // Ajusta os hor√°rios em telas pequenas
    const ajustarHorariosCelular = () => {
        const larguraTela = window.innerWidth;

        if (larguraTela <= 600) { // Verifica se a tela √© pequena
            horariosColuna.forEach(celula => {
                if (celula.textContent.includes(' - ')) {
                    const horarios = celula.textContent.split(' - ');
                    celula.innerHTML = `${horarios[0]}<br>${horarios[1]}`; // Quebra os hor√°rios em linhas
                }
            });
        }
    };

    // Chamada inicial ao carregar a p√°gina
    ajustarHorariosCelular();

    // Listener para alterar layout ao clicar duas vezes
    tabelaContainer.addEventListener('dblclick', (event) => {
        const target = event.target;

        if ((target.tagName === 'TH' || target.tagName === 'TD') && target.innerText.includes('Hor√°rios')) {
            if (isExpanded) {
                tabelaContainer.style.marginTop = "-10px";
            } else {
                tabelaContainer.style.marginTop = "55px";
            }

            isExpanded = !isExpanded;
            tabelaContainer.classList.toggle('fullscreen');
        }
    });
	
	
	const header = document.querySelector('.header'); // Seleciona o t√≠tulo da quadra
    let tapCount = 0; // Contador de toques
    let lastTapTime = 0; // Tempo do √∫ltimo toque

    header.addEventListener('click', () => {
        const currentTime = new Date().getTime();
        const tapInterval = 300; // Intervalo m√°ximo entre toques (em milissegundos)

        // Verifica se o tempo entre os toques √© menor que o intervalo definido
        if (currentTime - lastTapTime < tapInterval) {
            tapCount++;
        } else {
            tapCount = 1; // Reseta o contador se o intervalo for maior
        }

        lastTapTime = currentTime;

        // Se o usu√°rio tocar 3 vezes no t√≠tulo
        if (tapCount === 3) {
            tapCount = 0; // Reseta o contador
            confirmarLogout(); // Chama a fun√ß√£o de confirma√ß√£o de logout
        }
    });

    // Nova funcionalidade: Ajusta os nomes dos bot√µes para celular
    const ajustarNomesBotoes = () => {
        const larguraTela = window.innerWidth;
        const botoes = document.querySelectorAll('.tab-button');

        botoes.forEach(botao => {
            const nomeOriginal = botao.getAttribute('data-nome-original'); // Recupera o nome original
            if (!nomeOriginal) {
                botao.setAttribute('data-nome-original', botao.innerHTML); // Armazena o nome original uma √∫nica vez
            }

            if (larguraTela <= 600) {
                // Ajuste para celular: quebra o texto em duas linhas
                const partesNome = botao.getAttribute('data-nome-original').split(' - ');
                if (partesNome.length === 2) {
                    botao.innerHTML = `${partesNome[0]}<br>${partesNome[1]}`;
                }
            } else {
                // Ajuste para computador: restaura o nome original
                botao.innerHTML = botao.getAttribute('data-nome-original');
            }
        });
    };

    // Ajuste inicial e ao redimensionar a tela
    ajustarNomesBotoes();
    window.addEventListener('resize', ajustarNomesBotoes);
	
});





function fazerLogin() {
    let jogadorSelect = document.getElementById('jogadorSelect');
    let jogadorSelecionado = jogadorSelect.value; // Apelido selecionado
    let senhaInput = document.getElementById("senha");
    let senhaDigitada = senhaInput.value;
    let loginScreen = document.getElementById('loginScreen');
    let contentElement = document.getElementById('content');

    if (!jogadorSelecionado || !senhaDigitada) {
        alert("Por favor, selecione um jogador e digite a senha.");
        return;
    }

    // Busca o nome completo do jogador com base no apelido selecionado
    const jogadoresRef = database.ref("sistemas/cadastro/jogadores");
    jogadoresRef.once('value', (snapshot) => {
        const jogadores = snapshot.val();
        let nomeCompleto = '';
        let dataNascimento = '';

        // Encontra o nome completo e a data de nascimento correspondente ao apelido selecionado
        Object.keys(jogadores).forEach((nome) => {
            if (jogadores[nome].apelido === jogadorSelecionado) {
                nomeCompleto = nome; // Nome completo
                dataNascimento = jogadores[nome].niver ? jogadores[nome].niver.replace(/\//g, "") : ""; // Formato ddmmyyyy
            }
        });

        if (!nomeCompleto) {
            alert("Jogador n√£o encontrado.");
            return;
        }

        // Verifica se a senha digitada corresponde √† data de nascimento
        if (senhaDigitada !== dataNascimento) {
            alert("üîí Senha inv√°lida! \nTente novamente ou entre em contato com o administrador.\nRonaldo Taborda.");
            senhaInput.value = ""; // Limpa o campo senha
            return;
        }

        // Exibe o nome completo do jogador na mensagem de confirma√ß√£o
        const confirmacao = confirm(`Voc√™ selecionou o jogador: ${nomeCompleto}. Deseja continuar?`);

        if (confirmacao) {
            // Grava o nome completo no localStorage
            localStorage.setItem('jogadorLogado', nomeCompleto); // Salva o nome completo
			document.getElementById('pageOverlay').style.display = 'none'; // <-- ADICIONE ESTA LINHA
            //alert('Resultado do teste isUsuarioAdmin(): ' + isUsuarioAdmin());
            loginScreen.style.display = 'none';
            contentElement.style.display = 'block';
			atualizarPrimeiroAcesso(nomeCompleto); 
			checarAniversario();
        } else {
            // Se o usu√°rio cancelar, limpa os campos jogador e senha
            jogadorSelect.value = '';
            senhaInput.value = '';
        }
    }).catch(error => {
        console.error("Erro ao acessar o banco de dados:", error);
        alert("Erro ao acessar o banco de dados. Tente novamente mais tarde.");
    });
}





 function confirmarLogout() {
    const jogadorLogado = localStorage.getItem('jogadorLogado'); // Recupera o nome do jogador logado

    // Mensagem personalizada com o nome do jogador
    const confirmacao = confirm(`Voc√™ est√° logado como ${jogadorLogado}. Deseja realmente sair do sistema?`);

    if (confirmacao) {
        fazerLogout(); // Se o usu√°rio confirmar, faz o logout
    }
}


function fazerLogout() {
    localStorage.removeItem('jogadorLogado'); // Remove o jogador logado do localStorage
    window.location.reload(); // Recarrega a p√°gina para voltar √† tela de login
}


// üöÄ Atualiza a lista de jogadores quando a dura√ß√£o for alterada
document.addEventListener("DOMContentLoaded", function () {
    const duracaoSelect = document.getElementById('duracao');

    if (duracaoSelect) {
        duracaoSelect.addEventListener('change', function() {
            carregarJogadores(); // Recarrega os jogadores ao mudar a dura√ß√£o
        });
    } else {
        console.warn("‚ö†Ô∏è Elemento #duracao n√£o encontrado. O evento de mudan√ßa n√£o foi adicionado.");
    }

    // Adicionando verifica√ß√£o para "Rildo Santos"
    const jogador1Select = document.getElementById("jogador1");

    if (jogador1Select) {
        jogador1Select.addEventListener("change", function () {
			const rildoSelecionado = jogador1Select.value === "Rildo";
			const aulaOption = jogador1Select.querySelector("option[value='aula']");

			if (rildoSelecionado) {
				const isAula = confirm("Essa reserva √© para um jogo ou uma aula?\nOK para Aula, Cancelar para Jogo");
				if (isAula) {
					if (!aulaOption) {
						const novaAulaOption = document.createElement("option");
						novaAulaOption.value = "aula";
						novaAulaOption.textContent = "Aula";
						jogador1Select.appendChild(novaAulaOption);
					}
					jogador1Select.value = "aula";
				} else {
					// Se o usu√°rio clicar em "Cancelar" (Jogo), remove a op√ß√£o "Aula" caso ela exista
					if (aulaOption) aulaOption.remove();
				}
			} else {
				// Se o usu√°rio selecionar qualquer outro jogador, remove a op√ß√£o "Aula" caso ela exista
				if (aulaOption) aulaOption.remove();
			}
		});
    } else {
        console.warn("‚ö†Ô∏è Elemento #jogador1 n√£o encontrado. O evento de mudan√ßa n√£o foi adicionado.");
    }
});

// Fun√ß√£o para exibir mensagem ao reservar com convidado
function exibirMensagemConvidado() {
    const mensagem = `Reserva de Convidado efetuada com sucesso!\n\n‚ö†Ô∏è Aten√ß√£o!\n\nValor da taxa: R$ 50,00 por pessoa.\nPagamento: O pagamento deve ser realizado diretamente com o Toni.\nPrioridade dos s√≥cios: Se um s√≥cio quiser jogar, a reserva do convidado poder√° ser cancelada em at√©, no m√°ximo, 4 horas antes do jogo.`;
    alert(mensagem);
}

function exibirMensagemPiramide() {
    const mensagem = `Reserva Pir√¢mide efetuada com sucesso!\n\n‚ö†Ô∏è Aten√ß√£o!\n\nüì¢ Informar no grupo Data, hor√°rio e jogadores.\nüí∞ Valor da taxa: R$ 5,00 por jogador.\nüìå O pagamento deve ser realizado no PIX do Edemar:\n   - Chave: tedemar@hotmail.com\n`;
    alert(mensagem);
}



// Fun√ß√£o simplificada de log
// Substitua sua fun√ß√£o inteira por esta
async function registrarExclusao(logData) {
  // 1. Compatibilidade com o processamento em lote (preservada)
  if (Array.isArray(logData)) {
    return registrarExclusaoEmLote(logData);
  }

  const token = githubToken;
  const usuarioGit = 'clube-olimpico';
  const repo = 'Reservas';
  const caminhoArquivo = 'logs/reservas-excluidas.json';
  const url = `https://api.github.com/repos/${usuarioGit}/${repo}/contents/${caminhoArquivo}`;

  try {
    let response = await fetch(url, {
      headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
    });

    if (!response.ok) throw new Error(`Erro ao buscar arquivo: ${response.status}`);
    
    let fileData = await response.json();
    let logs = [];
    if (fileData.content) {
      try {
        //logs = JSON.parse(atob(fileData.content.replace(/\s/g, ''))) || [];
		//logs = JSON.parse(atob(fileData.content)) || [];
		logs = JSON.parse(b64_to_utf8(fileData.content)) || [];
      } catch (e) { console.warn('Falha ao decodificar logs existentes, iniciando novo', e); }
    }

    // --- IN√çCIO DA CORRE√á√ÉO ---
    // Cria o novo registro de log com a data de exclus√£o e o resto dos dados
    const novoLog = {
      exclusao: new Date().toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }).replace(',', ''),
      ...logData // Adiciona todos os dados do objeto que recebemos (quadra, horario, jogadores, status, etc.)
    };
    
    // Converte a dura√ß√£o para o formato de texto, se necess√°rio
    if (typeof novoLog.duracao === 'number') {
        novoLog.duracao = novoLog.duracao === 3 ? "2 Horas - Pir√¢mide" : novoLog.duracao === 2 ? "2 Horas" : "1 Hora";
    }

    logs.push(novoLog);
    // --- FIM DA CORRE√á√ÉO ---

    response = await fetch(url, {
      method: 'PUT',
      headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: `Exclus√£o registrada: ${logData.quadra} - ${logData.data} ${logData.horario}`,
        content: utf8_to_b64(JSON.stringify(logs, null, 2)),
        sha: fileData.sha
      })
    });

    if (!response.ok) throw new Error(`Falha no upload: ${response.status}`);
    console.log('‚úÖ Log registrado com sucesso');

  } catch (erro) {
    // L√≥gica de fallback para localStorage (preservada)
    console.error('‚ùå Erro ao salvar log:', erro);
    const logsFallback = JSON.parse(localStorage.getItem('logs_fallback') || '[]');
    const novoLogFallback = {
        exclusao: new Date().toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }).replace(',', ''),
        ...logData
    };
    logsFallback.push(novoLogFallback);
    localStorage.setItem('logs_fallback', JSON.stringify(logsFallback));
  }
}


// Fun√ß√£o adicional (NOVA) - n√£o substitui nada, apenas complementa
async function registrarExclusaoEmLote(logs) {
  const token = githubToken;
  const usuarioGit = 'clube-olimpico';
  const repo = 'Reservas';
  const caminhoArquivo = 'logs/reservas-excluidas.json';
  const url = `https://api.github.com/repos/${usuarioGit}/${repo}/contents/${caminhoArquivo}`; 

  try {
    // Obter vers√£o atual do arquivo
    let response = await fetch(url, {
      headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
    });
    
    if (!response.ok) throw new Error(`Erro ao buscar arquivo: ${response.status}`);
    
    const fileData = await response.json();
    let logsExistentes = [];
    if (fileData.content) {
      try {
        //logsExistentes = JSON.parse(atob(fileData.content)) || [];
		logsExistentes = JSON.parse(b64_to_utf8(fileData.content)) || [];
      } catch (e) {
        console.warn('Falha ao decodificar logs existentes', e);
      }
    }

    // Combinar com os novos logs
    const todosLogs = [...logsExistentes, ...logs];

    // Enviar atualiza√ß√£o
    response = await fetch(url, {
      method: 'PUT',
      headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: `Exclus√µes em lote: ${logs.length} reservas`,
        content: utf8_to_b64(JSON.stringify(todosLogs, null, 2)),
        sha: fileData.sha
      })
    });

    if (!response.ok) throw new Error(`Falha no upload: ${response.status}`);
    console.log(`‚úÖ ${logs.length} logs registrados em lote`);
  } catch (erro) {
    console.error('‚ùå Erro ao salvar logs em lote:', erro);
    // Fallback para localStorage
    const logsFallback = JSON.parse(localStorage.getItem('logs_fallback') || '[]');
    logs.forEach(log => logsFallback.push(log));
    localStorage.setItem('logs_fallback', JSON.stringify(logsFallback));
  }
}

// Fun√ß√£o para atualizar o valor "primeiro acesso"
function atualizarPrimeiroAcesso(jogadorLogado) {
    const sessionId = localStorage.getItem("sessionId");
    if (sessionId) {
        const userStatusRef = database.ref(`sistemas/usuariosOnline/${sessionId}`);
        // Atualiza o valor do usu√°rio para o nome do jogador
        userStatusRef.update({ usuario: jogadorLogado })
            .then(() => console.log("‚úÖ Valor de 'primeiro acesso' atualizado para:", jogadorLogado))
            .catch(error => console.error("‚ùå Erro ao atualizar 'primeiro acesso':", error));
    } else {
        console.error("‚ùå SessionId n√£o encontrado. N√£o foi poss√≠vel atualizar 'primeiro acesso'.");
    }
}

// Substitua a sua fun√ß√£o pela vers√£o original e funcional
async function validarRegraDeDuplas(jogadores, quadraSelecionada, dia, hora, duracao) {
    console.clear();
    console.log("--- INICIANDO VALIDA√á√ÉO DE DUPLAS ---");
    console.log(`Dados recebidos: Quadra=${quadraSelecionada}, DiaSemana=${dia}, HoraIn√≠cio=${hora}, Dura√ß√£o=${duracao}h`);

    const duplasConfig = duplasConfigGlobais;

    if (!duplasConfig || !duplasConfig.ativa) {
        return true; // Regra global desativada
    }
    if (jogadores.some(j => j.toLowerCase() === 'aula')) {
        return true; // Regra n√£o se aplica a aulas
    }

    const quadraKey = `Quadra-${quadraSelecionada.split(' ')[1]}`;
    const configDaQuadra = duplasConfig[quadraKey];

    if (!configDaQuadra || !configDaQuadra[`${quadraKey}-ativa`]) {
        return true; // Regra desativada para esta quadra
    }

    // L√≥gica de data para flexibiliza√ß√£o
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0); 
    const diaDaSemanaHoje = hoje.getDay() === 0 ? 7 : hoje.getDay();
    let diff = dia - diaDaSemanaHoje;
    if (diff < 0) {
        diff += 7;
    }
    const dataDaReserva = new Date(hoje);
    dataDaReserva.setDate(hoje.getDate() + diff);
    const dataFormatadaParaChave = `${dataDaReserva.getFullYear()}-${String(dataDaReserva.getMonth() + 1).padStart(2, '0')}-${String(dataDaReserva.getDate()).padStart(2, '0')}`;
    
    // L√≥gica de Exce√ß√µes (Datas Especiais) - tem prioridade
    const excecao = duplasConfig.DatasEspeciais?.[quadraKey]?.[dataFormatadaParaChave];
    if (excecao && excecao.regras) {
        const horarioInicioRegra = parseInt((excecao.regras.inicio || "0:00").split(':')[0]);
        const horarioFimRegra = parseInt((excecao.regras.fim || "0:00").split(':')[0]);
        const horarioFimReserva = hora + duracao;

        if (hora < horarioFimRegra && horarioFimReserva > horarioInicioRegra) {
		
            // Valida√ß√£o de Convidado em datas de exce√ß√£o
            if (jogadores.includes("Convidado")) {
                alert(`‚ö†Ô∏è Aten√ß√£o: Regra de Exce√ß√£o para Duplas\n\nNa data ${dataFormatadaParaChave.split('-').reverse().join('/')} (${excecao.descricao || 'Data Especial'}), o hor√°rio das ${excecao.regras.inicio} √†s ${excecao.regras.fim} na ${quadraSelecionada} √© exclusivo para jogos entre s√≥cios.\n\nRegras para este hor√°rio:\n‚Ä¢ Apenas jogos de duplas (4 jogadores).\n‚Ä¢ N√£o √© permitida a inclus√£o de convidados.\n\nPara agendar com menos de 4 s√≥cios, tente novamente no dia da reserva, caso o hor√°rio ainda esteja dispon√≠vel.`);
                return false;
            }
            
            if (dataDaReserva > hoje) {
                if (jogadores.length !== 4) {
                    alert(`‚ö†Ô∏è Aten√ß√£o: Regra de Exce√ß√£o\n\nNa data ${dataFormatadaParaChave.split('-').reverse().join('/')} (${excecao.descricao || 'Data Especial'}), o hor√°rio das ${excecao.regras.inicio} √†s ${excecao.regras.fim} na ${quadraSelecionada} √© exclusivo para jogos de duplas com 4 jogadores.\n\nPara agendar com menos jogadores, tente novamente no dia da reserva, caso o hor√°rio ainda esteja dispon√≠vel.`);
                    return false;
                }
            }
        }
        return true;
    }

    // L√≥gica para Regras Semanais
    const diaDaSemana = dia >= 1 && dia <= 5;
    const sabado = dia === 6;
    const domingo = dia === 7;
    let diaConfigKey, nomeDoPeriodo, inicioKey, fimKey;

    if (diaDaSemana) {
        diaConfigKey = `${quadraKey.split('-')[1]}-DiasDeSemana`;

        const configDiasEspecificos = configDaQuadra.DiasDeSemanaConfig;
        if (!configDaQuadra[diaConfigKey] || !configDiasEspecificos) {
            return true;
        }
        const diaSemanaMap = { 1: 'segunda', 2: 'terca', 3: 'quarta', 4: 'quinta', 5: 'sexta' };
        if (!configDiasEspecificos[diaSemanaMap[dia]]) {
            return true; 
        }
        
        const diasAtivosNomes = [];
        if (configDiasEspecificos.segunda) diasAtivosNomes.push("Segunda-feira");
        if (configDiasEspecificos.terca) diasAtivosNomes.push("Ter√ßa-feira");
        if (configDiasEspecificos.quarta) diasAtivosNomes.push("Quarta-feira");
        if (configDiasEspecificos.quinta) diasAtivosNomes.push("Quinta-feira");
        if (configDiasEspecificos.sexta) diasAtivosNomes.push("Sexta-feira");
        
        if (diasAtivosNomes.length < 5) {
            nomeDoPeriodo = `nos seguintes dias: ${diasAtivosNomes.join(', ')}`;
        } else {
            nomeDoPeriodo = "durante a semana";
        }

    } else if (sabado) {
        diaConfigKey = `${quadraKey.split('-')[1]}-Sabado`;
        nomeDoPeriodo = "aos S√°bados";
    } else if (domingo) {
        diaConfigKey = `${quadraKey.split('-')[1]}-Domingo`;
        nomeDoPeriodo = "aos Domingos";
    } else {
        return true;
    }

    if (!configDaQuadra[diaConfigKey]) {
        return true;
    }

    inicioKey = `${diaConfigKey}-Inicio`;
    fimKey = `${diaConfigKey}-Fim`;
    const horarioInicioRegra = parseInt((configDaQuadra[inicioKey] || "0:00").split(':')[0]);
    const horarioFimRegra = parseInt((configDaQuadra[fimKey] || "0:00").split(':')[0]);
    const horarioFimReserva = hora + duracao;

    if (hora < horarioFimRegra && horarioFimReserva > horarioInicioRegra) {
	
        if (jogadores.includes("Convidado")) {
            alert(`‚ö†Ô∏è Aten√ß√£o: Hor√°rio Priorit√°rio para Duplas\n\nNo hor√°rio das ${configDaQuadra[inicioKey]} √†s ${configDaQuadra[fimKey]} ${nomeDoPeriodo}, a quadra √© exclusiva para jogos entre s√≥cios.\n\nRegras para este hor√°rio:\n‚Ä¢ Apenas jogos de duplas (4 jogadores).\n‚Ä¢ N√£o √© permitida a inclus√£o de convidados.\n\nPara agendar com menos de 4 s√≥cios, tente novamente no dia da reserva, caso o hor√°rio ainda esteja dispon√≠vel.`);
            return false;
        }
	
        if (dataDaReserva > hoje) {
            if (jogadores.length !== 4) {
                alert(`‚ö†Ô∏è Aten√ß√£o: Hor√°rio Priorit√°rio para Duplas\n\nNa ${quadraSelecionada}, o hor√°rio das ${configDaQuadra[inicioKey]} √†s ${configDaQuadra[fimKey]} ${nomeDoPeriodo} √© priorit√°rio para jogos de duplas (4 jogadores).\n\nPara agendar com menos jogadores, tente novamente no dia da reserva, caso o hor√°rio ainda esteja dispon√≠vel.`);
                return false;
            }
        } 
    }

    console.log("VALIDA√á√ÉO OK: A reserva passou por todas as regras de Duplas.");
    return true; 
}


function aplicarBloqueiosVisuais(quadra) {
    const quadraKey = `Quadra-${quadra.split(' ')[1]}`;
    if (!bloqueiosQuadra || !bloqueiosQuadra[quadraKey]) {
        return; 
    }
    const bloqueiosDaQuadra = bloqueiosQuadra[quadraKey];
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    const diaDaSemanaHoje = hoje.getDay() === 0 ? 7 : hoje.getDay();

    for (let dia = 1; dia <= 7; dia++) {
        let diff = dia - diaDaSemanaHoje;
        if (diff < 0) diff += 7;
        const dataDaReserva = new Date(hoje);
        dataDaReserva.setDate(hoje.getDate() + diff);
        const dataFormatada = `${dataDaReserva.getFullYear()}-${String(dataDaReserva.getMonth() + 1).padStart(2, '0')}-${String(dataDaReserva.getDate()).padStart(2, '0')}`;
        const bloqueioDoDia = bloqueiosDaQuadra[dataFormatada];

        if (bloqueioDoDia && bloqueioDoDia.regras) {
            const tabela = document.getElementById('tabelaCorpo');
            const inicioBloqueio = parseInt(bloqueioDoDia.regras.inicio.split(':')[0]);
            const fimBloqueio = parseInt(bloqueioDoDia.regras.fim.split(':')[0]);

            for (let hora = inicioBloqueio; hora < fimBloqueio; hora++) {
                const rowIndex = hora - 6;
                if (tabela.rows[rowIndex]) {
                    const cell = tabela.rows[rowIndex].cells[dia];
                    if (cell) {
                        cell.innerHTML = "";
                        cell.style.backgroundColor = 'lightcoral';
                        cell.style.cursor = 'help';
                        
                        // --- IN√çCIO DA CORRE√á√ÉO ---
                        // Armazena os dados do bloqueio diretamente na c√©lula
                        const motivo = bloqueioDoDia.descricao || "Uso interno do clube";
                        cell.dataset.blocked = "true";
                        cell.dataset.motivo = motivo;
                        cell.dataset.horarioInicio = bloqueioDoDia.regras.inicio;
                        cell.dataset.horarioFim = bloqueioDoDia.regras.fim;
                        cell.dataset.data = dataFormatada.split('-').reverse().join('/');
                        // Remove o onclick daqui
                        // --- FIM DA CORRE√á√ÉO ---
                        
                        cell.style.borderTop = "1px solid #bbb";
                        cell.style.borderBottom = "1px solid #bbb";
                        cell.style.borderLeft = "1px solid #bbb";
                        cell.style.borderRight = "1px solid #bbb";
                    }
                }
            }
        }
    }
}



function parseDateDDMMYYYY(dateString) {
    if (!dateString) return null;
    const parts = dateString.split('-');
    if (parts.length !== 3) return null;
    // new Date(ano, m√™s - 1, dia)
    return new Date(parts[2], parts[1] - 1, parts[0]);
}

/**
 * Calcula em qual linha da pir√¢mide um jogador da categoria masculina est√°.
 * @param {number} posicao - A posi√ß√£o do jogador no ranking.
 * @returns {number} - O n√∫mero da linha.
 */
function encontrarLinha(posicao) {
    if (posicao <= 0) return 0;
    // F√≥rmula matem√°tica para encontrar a linha em uma pir√¢mide num√©rica
    return Math.ceil((-1 + Math.sqrt(1 + 8 * posicao)) / 2);
}


// Fun√ß√£o para alternar entre os temas
function toggleTheme() {
    const body = document.body;
    body.classList.toggle('dark-mode');

    // Salva a prefer√™ncia do tema no localStorage
    if (body.classList.contains('dark-mode')) {
        localStorage.setItem('theme', 'dark');
    } else {
        localStorage.setItem('theme', 'light');
    }

    // CHAMA A FUN√á√ÉO PARA REDESENHAR A LEGENDA COM AS CORES CERTAS
    atualizarLegenda(piramideAtivaGlobal);

    // FOR√áA O REDESENHO DA PLANILHA PARA APLICAR AS NOVAS CORES
    carregarReservas(quadraSelecionada); 
}

// Roda todo o c√≥digo de tema depois que a p√°gina carregar
document.addEventListener('DOMContentLoaded', function() {
    // Fun√ß√£o para aplicar o tema salvo
    function applyTheme() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
        }
    }

    // Primeiro, aplica o tema que j√° estava salvo
    applyTheme();

    // Depois, adiciona o evento de clique ao bot√£o
    document.getElementById('theme-toggle-button').addEventListener('click', toggleTheme);
});


// SUBSTITUA SUA FUN√á√ÉO 'verificarConvitesPendentes' PELA VERS√ÉO ABAIXO
function verificarConvitesPendentes(todasAsReservas) {
    if (vReservasPorConfirmacao === false) {
        return; 
    }

    const jogadorLogadoCompleto = localStorage.getItem('jogadorLogado');
    // --- LINHA DE SEGURAN√áA ADICIONADA ---
    if (!jogadorLogadoCompleto) return; // Se n√£o h√° ningu√©m logado, n√£o faz nada.

    const jogadorLogadoApelido = Object.keys(jogadoresData).find(
        apelido => jogadoresData[apelido].nomeCompleto === jogadorLogadoCompleto
    );

    const modalConvites = document.getElementById('modalConvites');
    const listaConvites = document.getElementById('lista-convites');

    if (!listaConvites || !modalConvites) return;
    listaConvites.innerHTML = '';
    modalConvites.style.display = 'none';
    
    if (!todasAsReservas || !jogadorLogadoApelido) return;

    let encontrouConvite = false;

    for (const quadra in todasAsReservas) {
        const reservasDaQuadra = todasAsReservas[quadra];
        for (const key in reservasDaQuadra) {
            const reserva = reservasDaQuadra[key];

            if (reserva.borda === undefined && reserva.duracao > 1) {
                continue;
            }

            if (reserva.status === 'pendente' && reserva.confirmacoes && reserva.confirmacoes[jogadorLogadoApelido] === false) {
                
                encontrouConvite = true;
                
                const li = document.createElement('li');
                li.style.marginBottom = '15px';
                
                const horaFim = reserva.hora + reserva.duracao;
                const listaDeJogadores = reserva.jogadores_completo || reserva.jogadores; 

                li.innerHTML = `
                    <span><strong>${quadra}</strong><br>${document.querySelector(`#dia option[value="${reserva.dia}"]`).textContent} das ${reserva.hora}:00 √†s ${horaFim}:00</span><br>
                    <span style="font-size: 0.9em;">Com: ${listaDeJogadores}<br>(Org: ${reserva.organizador})</span>
                    <div style="margin-top: 8px; display: flex; justify-content: center; gap: 10px;">
                        <button onclick="confirmarPresenca('${key}', '${quadra}')" style="padding: 8px 15px; font-size: 0.9em; width: auto !important; background-color: #4CAF50; color: white; border-radius: 5px; border: none; cursor: pointer;">Confirmar</button>
                        <button onclick="fecharModalConvites()" style="padding: 8px 15px; font-size: 0.9em; width: auto !important; background-color: #777; color: white; border-radius: 5px; border: none; cursor: pointer;">Depois</button>
                        <button onclick="recusarPresenca('${key}', '${quadra}')" style="padding: 8px 15px; font-size: 0.9em; width: auto !important; background-color: #f44336; color: white; border-radius: 5px; border: none; cursor: pointer;">Recusar</button>
                    </div>
                `;
                listaConvites.appendChild(li);
            }
        }
    }

    if (encontrouConvite) {
        modalConvites.style.display = 'flex';
    }
}



function fecharModalConvites() {
    document.getElementById('modalConvites').style.display = 'none';
}

// Substitua a fun√ß√£o confirmarPresenca por esta
// COLE ESTE C√ìDIGO COMPLETO NO LUGAR DA SUA FUN√á√ÉO ATUAL
async function confirmarPresenca(reservaKey, quadra) {
    const jogadorLogadoCompleto = localStorage.getItem('jogadorLogado');
    const jogadorLogadoApelido = Object.keys(jogadoresData).find(
        apelido => jogadoresData[apelido].nomeCompleto === jogadorLogadoCompleto
    );

    if (!jogadorLogadoApelido) {
        return alert('Erro: N√£o foi poss√≠vel identificar seu usu√°rio.');
    }

    const reservaRef = database.ref(`sistemas/reservas/${quadra}/${reservaKey}`);

    try {
        const { committed, snapshot } = await reservaRef.transaction(currentData => {
            if (currentData === null || currentData.status !== 'pendente') {
                return undefined;
            }

            if (currentData.confirmacoes) {
                currentData.confirmacoes[jogadorLogadoApelido] = true;
            }

            let todosConfirmaram = true;
            for (const jogador in currentData.confirmacoes) {
                // Considera apenas s√≥cios para a confirma√ß√£o, ignorando 'recusado'
                if (currentData.confirmacoes[jogador] === false) {
                    todosConfirmaram = false;
                    break;
                }
            }
 
            if (todosConfirmaram) {
                currentData.status = 'confirmada';
            }

            return currentData;
        });

        if (committed) {
            const reserva = snapshot.val();
            if (reserva === null) {
                alert('N√£o foi poss√≠vel confirmar. A reserva pode ter sido cancelada por outro jogador.');
                return;
            }

            // ---- IN√çCIO DA CORRE√á√ÉO ----
            // Se a reserva for de 2 horas, sincroniza a segunda parte IMEDIATAMENTE.
            if (reserva.duracao > 1) {
                const reserva2Ref = database.ref(`sistemas/reservas/${quadra}/${reserva.dia}_${reserva.hora + 1}`);
                
                // Prepara um objeto com os dados que precisam ser sincronizados.
                const updatesParaSegundaParte = {
                    status: reserva.status, // Sincroniza o status geral ('pendente' ou 'confirmada')
                    confirmacoes: reserva.confirmacoes // Sincroniza o objeto de confirma√ß√µes completo
                };
                
                // Executa a atualiza√ß√£o na segunda parte da reserva.
                await reserva2Ref.update(updatesParaSegundaParte);
            }
            // ---- FIM DA CORRE√á√ÉO ----

            // Exibe o alerta apropriado ap√≥s a sincroniza√ß√£o.
            if (reserva.status === 'confirmada') {
                alert('Presen√ßa confirmada! A reserva agora est√° garantida para todos.');
            } else {
                alert('Presen√ßa confirmada! Ainda aguardando os demais jogadores.');
            }
        } else {
            alert('N√£o foi poss√≠vel confirmar. A reserva pode ter sido alterada ou cancelada por outro jogador.');
        }
    } catch (error) {
        console.error("Erro na transa√ß√£o de confirma√ß√£o:", error);
        alert("Ocorreu um erro ao confirmar a presen√ßa. Verifique o console.");
    }
}



// COLE ESTE C√ìDIGO COMPLETO NO LUGAR DA SUA FUN√á√ÉO ATUAL
// COLE ESTE C√ìDIGO COMPLETO NO LUGAR DA SUA FUN√á√ÉO ATUAL
// COLE ESTA FUN√á√ÉO COMPLETA NO LUGAR DA SUA ATUAL 'recusarPresenca'
async function recusarPresenca(reservaKey, quadra) {
    const jogadorLogadoCompleto = localStorage.getItem('jogadorLogado');
    const jogadorLogadoApelido = Object.keys(jogadoresData).find(
        apelido => jogadoresData[apelido].nomeCompleto === jogadorLogadoCompleto
    );
    if (!jogadorLogadoApelido) { return alert('Erro: N√£o foi poss√≠vel identificar seu usu√°rio.'); }
    if (!confirm("Tem certeza que deseja recusar este convite? A a√ß√£o n√£o pode ser desfeita.")) { return; }

    const reservaRef = database.ref(`sistemas/reservas/${quadra}/${reservaKey}`);
    
    const stateCapture = { lastKnownData: null };
    
    try {
        const { committed, snapshot } = await reservaRef.transaction(currentData => {
            stateCapture.lastKnownData = currentData; 

            if (currentData === null || currentData.status !== 'pendente') { return undefined; }
            if (!currentData.jogadores_completo.split(', ').map(j => j.trim()).includes(jogadorLogadoApelido)) { return undefined; }
            
            currentData.confirmacoes[jogadorLogadoApelido] = "recusado";
            
            const todosOsJogadoresOriginais = currentData.jogadores_completo.split(', ').map(j => j.trim());
            const jogadoresAtivos = todosOsJogadoresOriginais.filter(apelido => apelido.toLowerCase() === 'convidado' || currentData.confirmacoes[apelido] !== 'recusado');
            
            let deveCancelar = false;
            const restamApenasConvidados = jogadoresAtivos.length > 0 && jogadoresAtivos.every(p => p.toLowerCase() === 'convidado');
            
            if (isHorarioDuplaObrigatoria(quadra, currentData.dia, currentData.hora, currentData.duracao) && jogadoresAtivos.length < 4) {
                deveCancelar = true;
            }
            if (!deveCancelar && currentData.duracao === 2 && jogadoresAtivos.length < 2) {
                deveCancelar = true;
            }
            if (!deveCancelar && restamApenasConvidados) {
                deveCancelar = true;
            }
            if (!deveCancelar && currentData.duracao === 1 && jogadoresAtivos.length < 2) {
                deveCancelar = true;
            }
            
            if (deveCancelar) { 
                return null; 
            } 
            else {
                let todosRestantesConfirmaram = true;
                for (const jogador in currentData.confirmacoes) {
                    if (currentData.confirmacoes[jogador] === false) {
                        todosRestantesConfirmaram = false;
                        break;
                    }
                }
                if (todosRestantesConfirmaram) {
                    currentData.status = 'confirmada';
                }
                
                return currentData;
            }
        });

        if (committed) {
            const reservaFinal = snapshot.val();
            if (reservaFinal === null) {
                
                // ---- IN√çCIO DO BLOCO DE L√ìGICA RESTAURADO E CORRIGIDO ----
                let motivoCancelamento = "n√£o atender √†s regras do sistema.";
                
                if (stateCapture.lastKnownData) {
                    const reservaParaLog = stateCapture.lastKnownData;
                    
                    // L√≥gica original e correta para prever o estado final e determinar o motivo
                    const futureConfirmacoes = { ...reservaParaLog.confirmacoes };
                    if (futureConfirmacoes.hasOwnProperty(jogadorLogadoApelido)) {
                        futureConfirmacoes[jogadorLogadoApelido] = "recusado";
                    }

                    let activePlayerCount = 0;
                    const activePlayers = [];
                    // Adiciona convidados √† lista de jogadores ativos para contagem
                    reservaParaLog.jogadores_completo.split(', ').map(j => j.trim()).forEach(p => {
                        if(p.toLowerCase() === 'convidado') activePlayers.push(p);
                    });

                    for (const player in futureConfirmacoes) {
                        if (futureConfirmacoes[player] !== "recusado") {
                            activePlayerCount++;
                            activePlayers.push(player);
                        }
                    }
                    const activePlayersAreAllGuests = activePlayers.length > 0 && activePlayers.every(p => p.toLowerCase() === 'convidado');

                    if (isHorarioDuplaObrigatoria(quadra, reservaParaLog.dia, reservaParaLog.hora, reservaParaLog.duracao) && activePlayerCount < 4) {
                        motivoCancelamento = "a reserva ficou com menos de 4 jogadores em um hor√°rio obrigat√≥rio para duplas.";
                    } else if (reservaParaLog.duracao === 2 && activePlayerCount < 2) {
                        motivoCancelamento = "a reserva de 2 horas ficou com menos de 2 jogadores.";
                    } else if (activePlayersAreAllGuests) {
                        motivoCancelamento = "a reserva ficou apenas com convidados, o que n√£o √© permitido.";
                    } else if (reservaParaLog.duracao === 1 && activePlayerCount < 2) { 
                        motivoCancelamento = "a reserva de 1 hora ficou com menos de 2 participantes.";
                    }
                    
                    // Bloco que prepara e grava o log (preservado)
                    const confirmacoesParaLog = { ...reservaParaLog.confirmacoes };
                    confirmacoesParaLog[jogadorLogadoApelido] = "recusado";
                    const jogadoresParaLog = Object.keys(confirmacoesParaLog);
                    if ((reservaParaLog.jogadores_completo || reservaParaLog.jogadores).toLowerCase().includes('convidado')) {
                        // Adiciona a quantidade correta de convidados ao log
                        const convidadosCount = (reservaParaLog.jogadores_completo.match(/convidado/gi) || []).length;
                        for(let i=0; i < convidadosCount; i++) {
                            jogadoresParaLog.push('Convidado');
                        }
                    }
                    
                    const dataDaReserva = new Date();
                    const diaDaSemanaHoje = dataDaReserva.getDay() === 0 ? 7 : dataDaReserva.getDay();
                    let diff = reservaParaLog.dia - diaDaSemanaHoje;
                    if (diff < 0) diff += 7;
                    dataDaReserva.setDate(new Date().getDate() + diff);
                    const dataFormatada = `${String(dataDaReserva.getDate()).padStart(2, '0')}-${String(dataDaReserva.getMonth() + 1).padStart(2, '0')}-${dataDaReserva.getFullYear()}`;
                    const horaFinal = reservaParaLog.hora + reservaParaLog.duracao;
                    const horarioFormatado = `${String(reservaParaLog.hora).padStart(2, '0')}:00 - ${String(horaFinal).padStart(2, '0')}:00`;
                    let duracaoTexto = reservaParaLog.duracao === 1 ? "1 Hora" : "2 Horas";
                    if (reservaParaLog.duracao === 3) duracaoTexto = "2 Horas - Pir√¢mide";
                    
                    const logData = {
                        quadra: quadra,
                        horario: horarioFormatado,
                        jogadores: [...new Set(jogadoresParaLog)].map(capitalizarNome),
                        usuario: "SISTEMA",
                        duracao: duracaoTexto,
                        data: dataFormatada,
                        statusNoMomentoDaExclusao: 'cancelada',
                        organizadorDaReserva: reservaParaLog.organizador,
                        confirmacoes: traduzirConfirmacoesParaLog(confirmacoesParaLog),
						motivo: motivoCancelamento
                    };
                    await registrarExclusao(logData);
                    
                    if (reservaParaLog.duracao > 1) {
                        const reserva2Ref = database.ref(`sistemas/reservas/${quadra}/${reservaParaLog.dia}_${reservaParaLog.hora + 1}`);
                        await reserva2Ref.remove();
                    }
                }
                
                // A MENSAGEM DE ALERTA AGORA USA O MOTIVO DETALHADO E CORRETO
                alert(`Convite recusado. A reserva foi cancelada automaticamente porque ${motivoCancelamento}`);
                // ---- FIM DO BLOCO DE L√ìGICA RESTAURADO ----

            } else {
                 if (reservaFinal.duracao > 1) {
                    const reserva2Ref = database.ref(`sistemas/reservas/${quadra}/${reservaFinal.dia}_${reservaFinal.hora + 1}`);
                    await reserva2Ref.update({
                        status: reservaFinal.status,
                        confirmacoes: reservaFinal.confirmacoes
                    });
                }
                if (reservaFinal.status === 'confirmada') {
                    alert('Convite recusado. Como voc√™ era o √∫ltimo pendente, a reserva agora est√° confirmada para o(s) jogador(es) restante(s).');
                } else {
                    alert('Convite recusado. O seu status foi atualizado.');
                }
            }
        } else {
            alert('N√£o foi poss√≠vel recusar o convite. A reserva pode ter sido alterada ou cancelada por outro jogador enquanto voc√™ decidia.');
        }
    } catch (error) {
        console.error("Erro na transa√ß√£o de recusa:", error);
        alert("Ocorreu um erro ao recusar o convite.");
    }
}

						
						


/**
 * NOVA FUN√á√ÉO AUXILIAR
 * Verifica se um determinado hor√°rio √© obrigat√≥rio para duplas, sem mostrar alertas.
 * Retorna 'true' se for um hor√°rio de duplas, 'false' caso contr√°rio.
 */
function isHorarioDuplaObrigatoria(quadraSelecionada, dia, hora, duracao) {
    const duplasConfig = duplasConfigGlobais;
    if (!duplasConfig || !duplasConfig.ativa) return false;

    const quadraKey = `Quadra-${quadraSelecionada.split(' ')[1]}`;
    const configDaQuadra = duplasConfig[quadraKey];
    if (!configDaQuadra || !configDaQuadra[`${quadraKey}-ativa`]) return false;

    // L√≥gica para checar exce√ß√µes e regras semanais (similar √† valida√ß√£o, mas sem alertas)
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0); 
    const diaDaSemanaHoje = hoje.getDay() === 0 ? 7 : hoje.getDay();
    let diff = dia - diaDaSemanaHoje;
    if (diff < 0) diff += 7;
    const dataDaReserva = new Date(hoje);
    dataDaReserva.setDate(hoje.getDate() + diff);
    const dataFormatadaParaChave = `${dataDaReserva.getFullYear()}-${String(dataDaReserva.getMonth() + 1).padStart(2, '0')}-${String(dataDaReserva.getDate()).padStart(2, '0')}`;
    
    const excecao = duplasConfig.DatasEspeciais?.[quadraKey]?.[dataFormatadaParaChave];
    if (excecao && excecao.regras) {
        const inicio = parseInt((excecao.regras.inicio || "0:00").split(':')[0]);
        const fim = parseInt((excecao.regras.fim || "0:00").split(':')[0]);
        if (hora >= inicio && (hora + duracao) <= fim) return true;
    }

    const diaDaSemana = dia >= 1 && dia <= 5;
    const sabado = dia === 6;
    const domingo = dia === 7;
    let diaConfigKey;
    if (diaDaSemana) {
        const configDiasEspecificos = configDaQuadra.DiasDeSemanaConfig;
        if (!configDaQuadra[`Quadra-${quadraKey.split('-')[1]}-DiasDeSemana`] || !configDiasEspecificos) {
            return false;
        }
        const diaSemanaMap = { 1: 'segunda', 2: 'terca', 3: 'quarta', 4: 'quinta', 5: 'sexta' };
        if (!configDiasEspecificos[diaSemanaMap[dia]]) {
            return false; 
        }
        diaConfigKey = `${quadraKey.split('-')[1]}-DiasDeSemana`;
    }
    else if (sabado) diaConfigKey = `${quadraKey.split('-')[1]}-Sabado`;
    else if (domingo) diaConfigKey = `${quadraKey.split('-')[1]}-Domingo`;
    else return false;

    if (!configDaQuadra[diaConfigKey]) return false;

    const inicio = parseInt((configDaQuadra[`${diaConfigKey}-Inicio`] || "0:00").split(':')[0]);
    const fim = parseInt((configDaQuadra[`${diaConfigKey}-Fim`] || "0:00").split(':')[0]);
    if (hora >= inicio && (hora + duracao) <= fim) return true;

    return false;
}



// COLE ESTE C√ìDIGO COMPLETO NO LUGAR DA SUA FUN√á√ÉO ATUAL
async function limparReservasExpiradas() {
    if (vReservasPorConfirmacao === false) {
        console.log("‚ÑπÔ∏è Limpeza de reservas expiradas ignorada (funcionalidade desligada).");
        return; 
    }
    console.log("üßπ Iniciando verifica√ß√£o de reservas pendentes expiradas...");
    
    const quadras = ["Quadra 1 - Coberta", "Quadra 2 - Aberta", "Quadra 3 - Coberta"];
    const agora = Date.now();
    const updates = {};
    const logsParaRegistrar = [];

    try {
        const snapshot = await database.ref('sistemas/reservas').once('value');
        const todasAsReservas = snapshot.val();

        if (!todasAsReservas) {
            console.log("‚úÖ Nenhuma reserva encontrada para verificar.");
            return;
        }

        for (const quadra of quadras) {
            const reservasDaQuadra = todasAsReservas[quadra];
            if (reservasDaQuadra) {
                for (const key in reservasDaQuadra) {
                    const reserva = reservasDaQuadra[key];

                    if (reserva.borda === undefined && reserva.duracao > 1) {
                        continue;
                    }
                    
                    if (reserva.status === 'pendente' && agora > reserva.expiraEm) {
                        console.warn(`üóëÔ∏è Reserva expirada encontrada em ${quadra} (${key}). Marcando para remo√ß√£o e log.`);
                        
                        // ---- IN√çCIO DA CORRE√á√ÉO PARA O LOG ----
                        // 1. A lista de s√≥cios para o log vem das chaves do objeto de confirma√ß√µes, que tem o hist√≥rico completo.
                        const jogadoresParaLog = Object.keys(reserva.confirmacoes);

                        // 2. Adiciona "Convidado" √† lista se ele existia na reserva.
                        if ((reserva.jogadores_completo || reserva.jogadores).toLowerCase().includes('convidado')) {
                            if (!jogadoresParaLog.includes('Convidado')) {
                                jogadoresParaLog.push('Convidado');
                            }
                        }
                        // ---- FIM DA CORRE√á√ÉO PARA O LOG ----

                        const dataDaReserva = new Date();
                        const diaDaSemanaHoje = dataDaReserva.getDay() === 0 ? 7 : dataDaReserva.getDay();
                        let diff = reserva.dia - diaDaSemanaHoje;
                        if (diff < 0) diff += 7;
                        dataDaReserva.setDate(new Date().getDate() + diff);
                        const dataFormatada = `${String(dataDaReserva.getDate()).padStart(2, '0')}-${String(dataDaReserva.getMonth() + 1).padStart(2, '0')}-${dataDaReserva.getFullYear()}`;
                        
                        const horaFinal = reserva.hora + reserva.duracao;
                        const horarioFormatado = `${String(reserva.hora).padStart(2, '0')}:00 - ${String(horaFinal).padStart(2, '0')}:00`;
                        
                        let duracaoTexto = reserva.duracao === 1 ? "1 Hora" : "2 Horas";
                        if (reserva.duracao === 3) duracaoTexto = "2 Horas - Pir√¢mide";
                        
                        const logData = {
                            exclusao: new Date().toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }).replace(',', ''),
                            quadra: quadra,
                            horario: horarioFormatado,
                            jogadores: jogadoresParaLog.map(capitalizarNome), // Usa a lista reconstru√≠da
                            usuario: "SISTEMA",
                            duracao: duracaoTexto,
                            data: dataFormatada,
                            statusNoMomentoDaExclusao: 'expirada',
                            organizadorDaReserva: reserva.organizador,
                            confirmacoes: traduzirConfirmacoesParaLog(reserva.confirmacoes),
							motivo: "Reserva expirada por falta de confirma√ß√£o"
                        };
                        
                        logsParaRegistrar.push(logData);

                        updates[`sistemas/reservas/${quadra}/${key}`] = null;
                        if (reserva.duracao > 1) {
                            const key2 = `${reserva.dia}_${reserva.hora + 1}`;
                            updates[`sistemas/reservas/${quadra}/${key2}`] = null; 
                        }
                    }
                }
            }
        }

        if (Object.keys(updates).length > 0) {
            await registrarExclusao(logsParaRegistrar);
            await database.ref().update(updates);
            console.log(`‚úÖ ${logsParaRegistrar.length} reserva(s) expirada(s) removida(s) e logada(s) com sucesso.`);
        } else {
            console.log("‚úÖ Nenhuma reserva expirada encontrada.");
        }

    } catch (error) {
        console.error("‚ùå Erro durante a limpeza de reservas expiradas:", error);
    }
}




// Fun√ß√£o auxiliar para codificar corretamente strings com caracteres especiais
function utf8_to_b64(str) {
    return btoa(unescape(encodeURIComponent(str)));
}

// Fun√ß√£o auxiliar para decodificar corretamente strings com caracteres especiais
function b64_to_utf8(str) {
    return decodeURIComponent(atob(str).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
}



// VERS√ÉO NOVA E ATUALIZADA
/**
 * Traduz os status de um objeto de confirma√ß√µes para serem mais claros no log.
 * Converte 'true' para 'confirmado' e 'false' para 'pendente'.
 * @param {object} confirmacoes Objeto de confirma√ß√µes original.
 * @returns {object} Novo objeto com os valores traduzidos, ou undefined se a entrada for nula.
 */
function traduzirConfirmacoesParaLog(confirmacoes) {
    if (!confirmacoes) {
        return undefined; // Retorna undefined se n√£o houver confirma√ß√µes
    }
    
    const confirmacoesTraduzidas = {};
    for (const jogador in confirmacoes) {
        if (confirmacoes.hasOwnProperty(jogador)) {
            const status = confirmacoes[jogador];
            
            // L√≥gica expandida para traduzir true e false
            if (status === true) {
                confirmacoesTraduzidas[jogador] = "confirmado";
            } else if (status === false) {
                confirmacoesTraduzidas[jogador] = "pendente";
            } else {
                // Mant√©m outros valores como 'recusado' intactos
                confirmacoesTraduzidas[jogador] = status;
            }
        }
    }
    return confirmacoesTraduzidas;
}


/**
 * Executa uma transa√ß√£o do Firebase e a encapsula em uma Promise para uso com async/await.
 * @param {firebase.database.Reference} ref - A refer√™ncia do Firebase para a transa√ß√£o.
 * @param {function} updateFunction - A fun√ß√£o que atualiza os dados.
 * @returns {Promise<firebase.database.DataSnapshot>} - Resolve com o snapshot em caso de sucesso.
 * @rejects {Error} - Rejeita com um erro em caso de falha ou se o hor√°rio j√° estiver ocupado.
 */
function runTransaction(ref, updateFunction) {
    return new Promise((resolve, reject) => {
        ref.transaction(updateFunction, (error, committed, snapshot) => {
            if (error) {
                console.error("Erro na transa√ß√£o do Firebase:", error);
                reject(new Error("Ocorreu um erro de comunica√ß√£o com o banco de dados."));
            } else if (!committed) {
                // Este √© o caso da condi√ß√£o de corrida: algu√©m agendou primeiro.
                console.warn("Conflito de agendamento detectado.");
                reject(new Error("Hor√°rio j√° est√° reservado por outro jogador."));
            } else {
                // Sucesso!
                resolve(snapshot);
            }
        });
    });
}

//
// ADICIONE ESTAS TR√äS NOVAS FUN√á√ïES AO SEU SCRIPT
//

/**
 * Fecha o modal de detalhes da reserva.
 */
function fecharModalDetalhes() {
    const modal = document.getElementById('modalDetalhesReserva');
    if (modal) {
        modal.style.display = 'none';
    }
}



/**
 * Busca os dados de uma reserva e exibe no modal.
 * @param {object} reserva - O objeto da reserva do Firebase.
 */
// SUBSTITUA A SUA FUN√á√ÉO INTEIRA PELA VERS√ÉO CORRIGIDA ABAIXO
// SUBSTITUA A SUA FUN√á√ÉO 'exibirDetalhesReserva' PELA VERS√ÉO ABAIXO

function exibirDetalhesReserva(reserva) {
    if (!reserva) return;

    // --- C√ìDIGO DE DEBUG (PARTE 1) ---
    console.log("--- DEBUG: DADOS DA RESERVA ANTES DE GERAR O PLACAR ---");
    console.log("Objeto 'reserva' completo:", reserva);
    // --- FIM DO C√ìDIGO DE DEBUG ---

    // --- IN√çCIO DA NOVA FUNCIONALIDADE ---
    if ((reserva.jogadores || "").toLowerCase().trim() === 'manutencao') {
        const modal = document.getElementById('modalDetalhesReserva');
        const modalTitle = document.querySelector('#modalDetalhesReserva h3');
        const organizadorRow = document.getElementById('modal-organizador').parentElement;
        const jogadoresDiv = document.getElementById('modal-jogadores');
        const jogadoresLabel = jogadoresDiv.previousElementSibling;
        const statusElement = document.getElementById('modal-status');
        const resultadoContainer = document.getElementById('modal-resultado-container');

        modalTitle.textContent = 'Detalhes da Manuten√ß√£o';
        organizadorRow.style.display = 'none'; 
        if (jogadoresLabel) jogadoresLabel.style.display = 'none'; 
        resultadoContainer.style.display = 'none'; 

        document.getElementById('modal-quadra').textContent = quadraSelecionada;
        document.getElementById('modal-dia').textContent = document.querySelector(`#dia option[value="${reserva.dia}"]`).textContent;
        document.getElementById('modal-data').textContent = document.querySelector(`#tabelaQuadra tr:nth-child(2) td:nth-child(${reserva.dia})`).textContent;
        document.getElementById('modal-duracao').textContent = '1 Hora';
        document.getElementById('modal-horario').textContent = `${String(reserva.hora).padStart(2, '0')}:00 - ${String(reserva.hora + 1).padStart(2, '0')}:00`;
        statusElement.textContent = 'Manuten√ß√£o';
        statusElement.style.color = ''; 

        jogadoresDiv.innerHTML = `<p style="margin: 0;">Este hor√°rio est√° reservado para a manuten√ß√£o peri√≥dica da quadra.</p>`;

        modal.style.display = 'flex';
        return; 
    }
    // --- FIM DA NOVA FUNCIONALIDADE ---

    let listaDeApelidos = [];
    if (reserva.jogadores_completo) {
        listaDeApelidos = reserva.jogadores_completo.split(',').map(j => j.trim());
    } else {
        const jogador1 = (reserva.jogadores || "").split(',').map(j => j.trim());
        listaDeApelidos.push(...jogador1);
        if (reserva.duracao > 1) {
            const keySegundaParte = `${reserva.dia}_${reserva.hora + 1}`;
            const reservaSegundaParte = reservasPorQuadra[quadraSelecionada]?.[keySegundaParte];
            if (reservaSegundaParte && reservaSegundaParte.jogadores) {
                const jogador2 = reservaSegundaParte.jogadores.split(',').map(j => j.trim());
                listaDeApelidos.push(...jogador2);
            }
        }
    }

    document.querySelector('#modalDetalhesReserva h3').textContent = 'Detalhes da Reserva';
    document.getElementById('modal-organizador').parentElement.style.display = 'block';
    const jogadoresLabelOriginal = document.getElementById('modal-jogadores').previousElementSibling;
    if(jogadoresLabelOriginal) jogadoresLabelOriginal.style.display = 'block';

    document.getElementById('modal-quadra').textContent = quadraSelecionada;
    document.getElementById('modal-dia').textContent = document.querySelector(`#dia option[value="${reserva.dia}"]`).textContent;
    document.getElementById('modal-data').textContent = document.querySelector(`#tabelaQuadra tr:nth-child(2) td:nth-child(${reserva.dia})`).textContent;
    let duracaoTexto = reserva.duracao === 1 ? "1 Hora" : "2 Horas";
    if (reserva.duracao === 3) duracaoTexto = "2 Horas - Pir√¢mide";
    document.getElementById('modal-duracao').textContent = duracaoTexto;
    const horaFim = reserva.hora + (reserva.duracao === 1 ? 1 : 2);
    document.getElementById('modal-horario').textContent = `${String(reserva.hora).padStart(2, '0')}:00 - ${String(horaFim).padStart(2, '0')}:00`;
    
    const organizadorElement = document.getElementById('modal-organizador');
    organizadorElement.textContent = reserva.organizador ? (jogadoresData[reserva.organizador]?.nomeCompleto || reserva.organizador) : 'N/A';

    const statusElement = document.getElementById('modal-status');
    const jogadoresDiv = document.getElementById('modal-jogadores');
    const resultadoContainer = document.getElementById('modal-resultado-container');
    const resultadoPlacarDiv = document.getElementById('modal-resultado-placar');
    const isDarkMode = document.body.classList.contains('dark-mode');
    
    resultadoContainer.style.display = 'none';
    resultadoPlacarDiv.innerHTML = '';
    
    const statusPrincipal = reserva.status || 'confirmada';
    statusElement.textContent = capitalizarNome(statusPrincipal.replace(/_/g, ' '));
    if (statusPrincipal.includes('pendente')) {
        statusElement.style.color = isDarkMode ? '#FFA726' : 'orange';
    } else if (statusPrincipal.includes('recusado') || statusPrincipal.toLowerCase().includes('cancelada')) {
        statusElement.style.color = isDarkMode ? '#EF5350' : 'red';
    } else if (statusPrincipal === 'finalizada') {
        statusElement.style.color = isDarkMode ? '#2196F3' : '#007bff';
    } else {
        statusElement.style.color = isDarkMode ? '#66BB6A' : 'green';
    }
	
    const temResultado = reserva.resultado || reserva.resultadoDuplas;

    if (temResultado) {
		jogadoresDiv.innerHTML = `<p style="margin: 0; font-size: 0.95em;"><em>${listaDeApelidos.map(j => capitalizarNome(j)).join(', ')}</em></p>`;
        
        resultadoContainer.style.display = 'block';
        if (reserva.resultado) { 
            // --- C√ìDIGO DE DEBUG (PARTE 2) ---
            console.log("Chamando 'gerarPlacarHtml' com:", reserva.resultado, listaDeApelidos[0], listaDeApelidos[1]);
            // --- FIM DO C√ìDIGO DE DEBUG ---
            resultadoPlacarDiv.innerHTML = gerarPlacarHtml(reserva.resultado, listaDeApelidos[0], listaDeApelidos[1]);
        } else if (reserva.resultadoDuplas) { 
            resultadoPlacarDiv.innerHTML = gerarPlacarDuplasHtml(reserva.resultadoDuplas);
        }

    } else {
        let jogadoresHtml = '<ul>';
        listaDeApelidos.forEach(apelido => {
            let statusTexto = '';
            if (reserva.confirmacoes && apelido.toLowerCase() !== 'convidado') {
                const status = reserva.confirmacoes[apelido];
                if (status === true) statusTexto = '<span class="status-confirmado">(‚úì Confirmado)</span>';
                else if (status === false) statusTexto = '<span class="status-pendente">(‚ùì Pendente)</span>';
                else if (status === 'recusado') statusTexto = '<span class="status-recusado">(‚úó Recusado)</span>';
            }
            jogadoresHtml += `<li>${apelido.toUpperCase()} ${statusTexto}</li>`;
        });
        jogadoresHtml += '</ul>';
        jogadoresDiv.innerHTML = jogadoresHtml;
    }
    
    document.getElementById('modalDetalhesReserva').style.display = 'flex';
}



// COLE ESTA FUN√á√ÉO COMPLETA NO LUGAR DA SUA ATUAL 'configurarEventosDaTabela'
// C√ìDIGO COMPLETO E ATUALIZADO
function configurarEventosDaTabela() {
    const tabelaCorpo = document.getElementById('tabelaCorpo');
    if (!tabelaCorpo) return;

    const novoTabelaCorpo = tabelaCorpo.cloneNode(true);
    tabelaCorpo.parentNode.replaceChild(novoTabelaCorpo, tabelaCorpo);

    // Listener para o CLIQUE SIMPLES
    novoTabelaCorpo.addEventListener('click', function(event) {
        const cell = event.target.closest('td');
        if (!cell || cell.classList.contains('horario')) {
            return;
        }
        
        if (cell.dataset.blocked === 'true') {
            const motivo = cell.dataset.motivo;
            const inicio = cell.dataset.horarioInicio;
            const fim = cell.dataset.horarioFim;
            const data = cell.dataset.data;
            const quadra = quadraSelecionada;
            alert(`‚ÑπÔ∏è Informa√ß√£o: Hor√°rio Bloqueado\n\nO hor√°rio das ${inicio} √†s ${fim} na ${quadra} do dia ${data} est√° indispon√≠vel.\n\nMotivo: ${motivo}`);
            return; 
        }

        if (cell.innerHTML.trim() === '') {
            return;
        }
        
        clearTimeout(clickTimer);
        
        clickTimer = setTimeout(function() {
            const rowIndex = cell.parentElement.rowIndex - 2;
            const colIndex = cell.cellIndex;
            const hora = rowIndex + 6;
            const dia = colIndex;
            
            const reservasDaQuadra = reservasPorQuadra[quadraSelecionada] || {};
            let keyClicada = `${dia}_${hora}`;
            let reservaParaAcao = reservasDaQuadra[keyClicada];

            if (!reservaParaAcao) return;

            if (reservaParaAcao.borda === undefined) {
                const keyAnterior = `${dia}_${hora - 1}`;
                const reservaAnterior = reservasDaQuadra[keyAnterior];
                if (reservaAnterior && reservaAnterior.duracao > 1) {
                    reservaParaAcao = reservaAnterior;
                    keyClicada = keyAnterior;
                }
            }

            // --- IN√çCIO DA ATUALIZA√á√ÉO ---
            // A vari√°vel do jogador logado foi movida para cima para ser usada em todos os casos
            const jogadorLogado = localStorage.getItem('jogadorLogado');
            const apelidoJogadorLogado = Object.keys(jogadoresData).find(
                apelido => jogadoresData[apelido].nomeCompleto.toLowerCase() === jogadorLogado.toLowerCase()
            ) || jogadorLogado;
            // --- FIM DA ATUALIZA√á√ÉO ---

            if (reservaParaAcao.duracao === 3) {
                if (Object.keys(jogadoresData).length === 0) {
                    alert("Os dados dos jogadores ainda est√£o sendo carregados. Por favor, aguarde um instante e tente novamente.");
                    return;
                }

                // L√≥gica de Pir√¢mide (INTACTA)
                let todosJogadoresDaPartida = [];
                const jogadoresParte1 = (reservaParaAcao.jogadores_completo || reservaParaAcao.jogadores).split(',').map(j => j.trim());
                todosJogadoresDaPartida.push(...jogadoresParte1);
                const keySegundaParte = `${reservaParaAcao.dia}_${reservaParaAcao.hora + 1}`;
                const reservaSegundaParte = reservasDaQuadra[keySegundaParte];
                if (reservaSegundaParte) {
                    const jogadoresParte2 = (reservaSegundaParte.jogadores_completo || reservaSegundaParte.jogadores).split(',').map(j => j.trim());
                    todosJogadoresDaPartida.push(...jogadoresParte2);
                }
                const jogadoresUnicos = [...new Set(todosJogadoresDaPartida)];
                const isParticipante = jogadoresUnicos.includes(apelidoJogadorLogado);

                if (isUsuarioAdmin() || isParticipante) {
                    mostrarOpcoesPiramide(reservaParaAcao, keyClicada, quadraSelecionada);
                } else {
                    return; 
                }
            } 
            else if (reservaParaAcao.jogadores.toLowerCase().trim() === 'aula') {
                // L√≥gica de Aula (INTACTA)
                if (jogadorLogado === "RILDO SANTOS" || isUsuarioAdmin()) {
                    const confirmacao = confirm("Voc√™ quer excluir esta aula?");
                    if (confirmacao) {
                        excluirReserva(rowIndex, colIndex);
                    }
                }
                return; 
            } 
            else {
                // --- IN√çCIO DA ATUALIZA√á√ÉO ---
                // L√≥gica de permiss√£o para JOGOS DE DUPLA / REGULARES
                let listaDeJogadores = [];
                if (reservaParaAcao.jogadores_completo) {
                    listaDeJogadores = reservaParaAcao.jogadores_completo.split(',').map(j => j.trim());
                } else {
                    listaDeJogadores.push(...reservaParaAcao.jogadores.split(',').map(j => j.trim()));
                    if (reservaParaAcao.duracao > 1) {
                        const keySegundaParte = `${reservaParaAcao.dia}_${reservaParaAcao.hora + 1}`;
                        const reservaSegundaParte = reservasDaQuadra[keySegundaParte];
                        if (reservaSegundaParte && reservaSegundaParte.jogadores) {
                           listaDeJogadores.push(...reservaSegundaParte.jogadores.split(',').map(j => j.trim()));
                        }
                    }
                }
                const isParticipante = [...new Set(listaDeJogadores)].includes(apelidoJogadorLogado);

                // S√ì ABRE O MODAL SE FOR PARTICIPANTE OU ADMIN
                if (isUsuarioAdmin() || isParticipante) {
                    mostrarOpcoesReserva(reservaParaAcao, keyClicada, quadraSelecionada);
                }
                // --- FIM DA ATUALIZA√á√ÉO ---
            }
        }, 250);
    });

    // Listener para o DUPLO-CLIQUE (INTACTO)
    novoTabelaCorpo.addEventListener('dblclick', function(event) {
        clearTimeout(clickTimer);
        const cell = event.target.closest('td');
        if (!cell || cell.innerHTML.trim() === '' || cell.classList.contains('horario') || cell.dataset.blocked === 'true') {
            return;
        }

        const rowIndex = cell.parentElement.rowIndex - 2;
        const colIndex = cell.cellIndex;
        const hora = rowIndex + 6; 
        const dia = colIndex;
        
        const reservasDaQuadra = reservasPorQuadra[quadraSelecionada] || {};
        const keyClicada = `${dia}_${hora}`;
        let reservaParaExibir = reservasDaQuadra[keyClicada];

        if (!reservaParaExibir) return;

        const keyAnterior = `${dia}_${hora - 1}`;
        const reservaAnterior = reservasDaQuadra[keyAnterior];
        
        if (reservaAnterior && reservaAnterior.duracao > 1 && reservaParaExibir.borda === undefined) {
            reservaParaExibir = reservaAnterior;
        }

        if (reservaParaExibir) {
            if (reservaParaExibir.jogadores.toLowerCase().trim() === 'aula') {
                return;
            }
            exibirDetalhesReserva(reservaParaExibir);
        }
    });
}




function mostrarOpcoesReserva(reserva, key, quadra) {
    let btnResultadoPiramide = document.getElementById('btnModalResultado');
    if (btnResultadoPiramide) {
        btnResultadoPiramide.remove();
    }

    const jogadorLogado = localStorage.getItem('jogadorLogado');
    const apelidoJogadorLogado = Object.keys(jogadoresData).find(
        apelido => jogadoresData[apelido].nomeCompleto.toLowerCase() === jogadorLogado.toLowerCase()
    ) || jogadorLogado;

    let listaDeJogadores = [];
    if (reserva.jogadores_completo) {
        listaDeJogadores = reserva.jogadores_completo.split(',').map(j => j.trim());
    } else {
        const jogadoresParte1 = reserva.jogadores.split(',').map(j => j.trim());
        listaDeJogadores.push(...jogadoresParte1);
        if (reserva.duracao > 1) {
            const keySegundaParte = `${reserva.dia}_${reserva.hora + 1}`;
            const reservasDaQuadra = reservasPorQuadra[quadra] || {};
            const reservaSegundaParte = reservasDaQuadra[keySegundaParte];
            if (reservaSegundaParte && reservaSegundaParte.jogadores) {
                const jogadoresParte2 = reservaSegundaParte.jogadores.split(',').map(j => j.trim());
                listaDeJogadores.push(...jogadoresParte2);
            }
        }
    }
    listaDeJogadores = [...new Set(listaDeJogadores)];
    
    const isOrganizador = reserva.organizador === apelidoJogadorLogado;
    const isPendente = reserva.status === 'pendente';
    const isParticipante = listaDeJogadores.includes(apelidoJogadorLogado);
    const statusDoJogador = reserva.confirmacoes ? reserva.confirmacoes[apelidoJogadorLogado] : undefined;
    
    const modal = document.getElementById('modalAcoesReserva');
    const btnVer = document.getElementById('btnModalVer');
    const btnEditar = document.getElementById('btnModalEditar');
    const btnExcluir = document.getElementById('btnModalExcluir');
    const btnCancelar = document.getElementById('btnModalCancelar');
    const btnResultadoDuplas = document.getElementById('btnModalResultadoDuplas');

    if (btnResultadoDuplas) {
        btnResultadoDuplas.style.display = 'none';
    }
    
    //const podeEditar = (isOrganizador || isUsuarioAdmin()) && isPendente;
	const podeEditar = isPendente && (isUsuarioAdmin() || (isOrganizador && edicaoOrganizadorAtiva));
   
    btnEditar.style.display = podeEditar ? 'block' : 'none';

    const temPermissaoBaseParaExcluir = isUsuarioAdmin() || (isPendente && isOrganizador) || (!isPendente && isParticipante && statusDoJogador !== 'recusado');
    
    const agora = new Date();
    // --- A CORRE√á√ÉO EST√Å NA LINHA ABAIXO ---
    const dataString = document.getElementById('tabelaQuadra').rows[1].cells[reserva.dia - 1].textContent;
    const [dia, mes, ano] = dataString.split('/');
    const horaFim = reserva.hora + reserva.duracao;
    const dataHoraFimReserva = new Date(ano, mes - 1, dia, horaFim, 0, 0);
    const isJogoFuturo = agora < dataHoraFimReserva;
    const podeExcluir = temPermissaoBaseParaExcluir && (isJogoFuturo || isUsuarioAdmin() || vPermitirExclusaoAposJogo);
    btnExcluir.style.display = podeExcluir ? 'block' : 'none';
    
    const listaDeSocios = listaDeJogadores.filter(j => j.toLowerCase() !== 'convidado');
    
    if (btnResultadoDuplas) {
        if (reserva.resultadoDuplas) {
            btnResultadoDuplas.textContent = 'Ver Resultado';
            btnResultadoDuplas.style.backgroundColor = '#17a2b8';
            btnResultadoDuplas.style.display = 'block';
            btnResultadoDuplas.onclick = () => {
                fecharModalAcoes();
                abrirModalResultadoDuplas(reserva, key, quadra, true);
            };
        } 
        else {
            //const podeInformarResultadoDuplas = (listaDeSocios.length === 4 && !isPendente && (isParticipante || isUsuarioAdmin()));
			const podeInformarResultadoDuplas = rankingDuplasAtivo && listaDeSocios.length === 4 && !isPendente && (isParticipante || isUsuarioAdmin());
            
            if (podeInformarResultadoDuplas) {
                btnResultadoDuplas.textContent = 'Informar Resultado';
                btnResultadoDuplas.style.backgroundColor = '#28a745';
                btnResultadoDuplas.style.display = 'block';
                btnResultadoDuplas.onclick = () => {
                    fecharModalAcoes();
                    abrirModalResultadoDuplas(reserva, key, quadra, false);
                };
            }
        }
    }

    const temAcaoDeResultado = btnResultadoDuplas && btnResultadoDuplas.style.display === 'block';
    if (!podeEditar && !podeExcluir && !temAcaoDeResultado) {
        return;
    }

    btnVer.onclick = () => {
        exibirDetalhesReserva(reserva);
        fecharModalAcoes();
    };
    btnEditar.onclick = () => {
        iniciarModoEdicao(reserva, key, quadra);
        fecharModalAcoes();
    };
    btnExcluir.onclick = () => {
        fecharModalAcoes();
        setTimeout(() => {
            if (confirm("Voc√™ tem certeza que deseja excluir esta reserva?")) {
                excluirReserva(reserva.hora - 6, reserva.dia);
            }
        }, 100);
    };
    btnCancelar.onclick = fecharModalAcoes;
    modal.onclick = (event) => {
        if (event.target === modal) {
            fecharModalAcoes();
        }
    };

    modal.style.display = 'flex';
}





function iniciarModoEdicao(reserva, key, quadra) {
    reservaEmEdicao = { key, quadra, dadosOriginais: reserva };

    const container = document.getElementById('edit-jogadores-container');
    container.innerHTML = '';
    const jogadoresParaEditar = reserva.jogadores_completo.split(',').map(j => j.trim());

    jogadoresParaEditar.forEach(apelido => {
        const newRow = document.createElement('div');
        newRow.className = 'edit-jogador-row';
        
        const novoSelect = document.createElement('select');
        novoSelect.innerHTML = document.getElementById('jogadorSelect').innerHTML;
        novoSelect.value = apelido;

        // ==========================================================
        // IN√çCIO DA ALTERA√á√ÉO JAVASCRIPT
        // ==========================================================
        // Removemos os estilos inline e adicionamos uma classe para controle via CSS
        const statusSpan = document.createElement('span');
        statusSpan.className = 'edit-status-span'; 
        // ==========================================================
        // FIM DA ALTERA√á√ÉO JAVASCRIPT
        // ==========================================================

        const status = reserva.confirmacoes ? reserva.confirmacoes[apelido] : null;

        if (apelido.toLowerCase() === 'convidado') {
            statusSpan.textContent = '';
        } else if (status === true) {
            novoSelect.disabled = true;
            statusSpan.textContent = '(Confirmado)';
            statusSpan.style.color = 'green';
        } else if (status === false) {
            statusSpan.textContent = '(Pendente)';
            statusSpan.style.color = 'orange';
        } else if (status === 'recusado') {
            statusSpan.textContent = '(Recusado)';
            statusSpan.style.color = 'red';
        }
        
        newRow.appendChild(novoSelect);
        newRow.appendChild(statusSpan);

        if (status !== true) {
            const removeButton = document.createElement('span');
            removeButton.className = 'remove-jogador-btn';
            removeButton.innerHTML = '&times;';
            removeButton.onclick = () => newRow.remove();
            newRow.appendChild(removeButton);
        } else {
            const placeholder = document.createElement('span');
            placeholder.className = 'remove-jogador-btn';
            placeholder.innerHTML = '&times;';
            placeholder.style.visibility = 'hidden';
            newRow.appendChild(placeholder);
        }
        
        container.appendChild(newRow);
    });

    document.getElementById('btnAdicionarJogadorEdicao').onclick = adicionarJogadorNaEdicao;
    document.getElementById('btnSalvarEdicao').onclick = salvarEdicao;

    document.getElementById('modalEdicaoReserva').style.display = 'flex';
}




// VERS√ÉO FINAL E COMPLETA DA FUN√á√ÉO, COM AS VALIDA√á√ïES ADICIONADAS CONFORME SOLICITADO

// VERS√ÉO FINAL COM M√âTODO DE EXCLUS√ÉO CORRIGIDO E MAIS ROBUSTO

// VERS√ÉO FINAL COM A INCLUS√ÉO DO LOG NA EXCLUS√ÉO AUTOM√ÅTICA

// VERS√ÉO FINAL COM A REGRA DE 1 HORA CORRIGIDA

// VERS√ÉO FINAL COM A CORRE√á√ÉO DO STATUS NO LOG DE CANCELAMENTO AUTOM√ÅTICO

// VERS√ÉO FINAL COM A INCLUS√ÉO DO LOG NA EXCLUS√ÉO AUTOM√ÅTICA
// VERS√ÉO FINAL COM A REGRA DE 1 HORA CORRIGIDA
// VERS√ÉO FINAL COM A CORRE√á√ÉO DO STATUS NO LOG DE CANCELAMENTO AUTOM√ÅTICO
async function salvarEdicao() {
    if (!reservaEmEdicao) return;

    // Pega os dados dos jogadores de dentro do modal
    const container = document.getElementById('edit-jogadores-container');
    const novosJogadoresSelects = container.querySelectorAll('select');
    const novosApelidos = Array.from(novosJogadoresSelects).map(select => select.value).filter(val => val);

    if (novosApelidos.length === 0) {
        alert("Uma reserva n√£o pode ficar sem jogadores.");
        return;
    }

    const sociosNaLista = novosApelidos.filter(j => j.toLowerCase() !== 'convidado');
    if (new Set(sociosNaLista).size !== sociosNaLista.length) {
        alert("N√£o √© permitido adicionar o mesmo s√≥cio mais de uma vez na reserva.");
        return;
    }

    const { key, quadra, dadosOriginais } = reservaEmEdicao;

    // VALIDA√á√ÉO 1: REGRAS DE DUPLAS
    const isRegraDuplasOk = await validarRegraDeDuplas(novosApelidos, quadra, dadosOriginais.dia, dadosOriginais.hora, dadosOriginais.duracao);
    if (!isRegraDuplasOk) {
        return;
    }

    // VALIDA√á√ÉO 2: CONFLITO DE RESERVAS (APENAS PARA JOGADORES ADICIONADOS)
    const jogadoresOriginais = new Set(dadosOriginais.jogadores_completo.split(',').map(j => j.trim()));
    const jogadoresAdicionados = novosApelidos.filter(apelido => !jogadoresOriginais.has(apelido));
    if (jogadoresAdicionados.length > 0) {
        const reservaValida = await validarSeTemReserva(jogadoresAdicionados);
        if (!reservaValida) {
            return;
        }
    }

    // L√≥gica para reconstruir o objeto de confirma√ß√µes
    const novoConfirmacoes = {};
    novosApelidos.forEach(apelido => {
        const statusOriginal = dadosOriginais.confirmacoes[apelido];
        if (statusOriginal === true) {
            novoConfirmacoes[apelido] = true;
        } else if (statusOriginal === 'recusado') {
            novoConfirmacoes[apelido] = 'recusado';
        } else if (apelido.toLowerCase() !== 'convidado') {
            novoConfirmacoes[apelido] = false;
        }
    });

    // VALIDA√á√ÉO 3: N√öMERO M√çNIMO DE JOGADORES ATIVOS
    const jogadoresAtivos = novosApelidos.filter(apelido => novoConfirmacoes[apelido] !== 'recusado');
    const numJogadoresAtivos = jogadoresAtivos.length;
    const apenasConvidadosAtivos = numJogadoresAtivos > 0 && jogadoresAtivos.every(j => j.toLowerCase() === 'convidado');
    let motivoCancelamento = '';

    if (dadosOriginais.duracao === 2 && numJogadoresAtivos < 2) {
        motivoCancelamento = 'a reserva de 2 horas ficou com menos de 2 jogadores ativos.';
    } else if (dadosOriginais.duracao === 1 && numJogadoresAtivos < 2) {
        motivoCancelamento = 'a reserva de 1 hora ficou com menos de 2 participantes ativos.';
    } else if (apenasConvidadosAtivos) {
        motivoCancelamento = 'a reserva ficou apenas com convidados, o que n√£o √© permitido.';
    }

    if (motivoCancelamento) {
        alert(`A reserva ser√° cancelada automaticamente porque, ap√≥s a edi√ß√£o, ${motivoCancelamento}`);
        
        try {
            const jogadorLogado = localStorage.getItem('jogadorLogado');
            const dataDaReserva = new Date();
            const diaDaSemanaHoje = dataDaReserva.getDay() === 0 ? 7 : dataDaReserva.getDay();
            let diff = dadosOriginais.dia - diaDaSemanaHoje;
            if (diff < 0) diff += 7;
            dataDaReserva.setDate(new Date().getDate() + diff);
            const dataFormatada = `${String(dataDaReserva.getDate()).padStart(2, '0')}-${String(dataDaReserva.getMonth() + 1).padStart(2, '0')}-${dataDaReserva.getFullYear()}`;

            const horaFinal = dadosOriginais.hora + (dadosOriginais.duracao === 1 ? 1 : 2);
            const horarioFormatado = `${String(dadosOriginais.hora).padStart(2, '0')}:00 - ${String(horaFinal).padStart(2, '0')}:00`;
            let duracaoTexto = dadosOriginais.duracao === 1 ? "1 Hora" : "2 Horas";
            if (dadosOriginais.duracao === 3) duracaoTexto = "2 Horas - Pir√¢mide";

            const logData = {
                quadra: quadra,
                horario: horarioFormatado,
                jogadores: dadosOriginais.jogadores_completo.split(',').map(j => capitalizarNome(j.trim())),
                usuario: jogadorLogado,
                duracao: duracaoTexto,
                motivo: `Cancelado automaticamente ap√≥s edi√ß√£o: ${motivoCancelamento}`,
                // --- CORRE√á√ÉO DO STATUS NO LOG ---
                statusNoMomentoDaExclusao: 'cancelada', // Alterado de dadosOriginais.status para 'cancelada'
                // --- FIM DA CORRE√á√ÉO ---
                organizadorDaReserva: dadosOriginais.organizador,
                confirmacoes: traduzirConfirmacoesParaLog(dadosOriginais.confirmacoes)
            };
            
            await registrarExclusao(logData);
        } catch(logError) {
            console.error("ERRO CR√çTICO: Falha ao registrar o log da exclus√£o autom√°tica.", logError);
            alert("Aten√ß√£o: A reserva ser√° cancelada, mas houve uma falha ao registrar o log. Avise o administrador.");
        }
        
        const refPrimeiraHora = database.ref(`sistemas/reservas/${quadra}/${key}`);
        const refSegundaHora = dadosOriginais.duracao > 1 ? database.ref(`sistemas/reservas/${quadra}/${dadosOriginais.dia}_${dadosOriginais.hora + 1}`) : null;

        try {
            await refPrimeiraHora.remove();
            if (refSegundaHora) {
                await refSegundaHora.remove();
            }
        } catch (error) {
            console.error("Erro no cancelamento autom√°tico p√≥s-edi√ß√£o:", error);
            alert("Ocorreu um erro ao cancelar a reserva automaticamente.");
        } finally {
            fecharModalEdicao(); 
        }
        return; 
    }

    // Se todas as valida√ß√µes passaram, o c√≥digo para ATUALIZAR a reserva √© executado
    let todosConfirmaram = Object.values(novoConfirmacoes).every(status => status === true || status === 'recusado');
    if(Object.values(novoConfirmacoes).some(status => status === false)) { todosConfirmaram = false; }
    const novoStatus = todosConfirmaram ? 'confirmada' : 'pendente';
    
    const updates = {};
    const jogadoresParte1 = [], jogadoresParte2 = [];
    if (dadosOriginais.duracao > 1) {
        novosApelidos.forEach((apelido, index) => {
            if (index === 0 || index === 2) jogadoresParte1.push(apelido);
            if (index === 1 || index === 3) jogadoresParte2.push(apelido);
        });
    } else {
        jogadoresParte1.push(...novosApelidos);
    }
    
    updates[`sistemas/reservas/${quadra}/${key}/status`] = novoStatus;
    updates[`sistemas/reservas/${quadra}/${key}/jogadores_completo`] = novosApelidos.join(', ');
    updates[`sistemas/reservas/${quadra}/${key}/jogadores`] = jogadoresParte1.join(', ');
    updates[`sistemas/reservas/${quadra}/${key}/confirmacoes`] = novoConfirmacoes;

    if (dadosOriginais.duracao > 1) {
        const key2 = `${dadosOriginais.dia}_${dadosOriginais.hora + 1}`;
        updates[`sistemas/reservas/${quadra}/${key2}/status`] = novoStatus;
        updates[`sistemas/reservas/${quadra}/${key2}/jogadores_completo`] = novosApelidos.join(', ');
        updates[`sistemas/reservas/${quadra}/${key2}/jogadores`] = jogadoresParte2.join(', ');
        updates[`sistemas/reservas/${quadra}/${key2}/confirmacoes`] = novoConfirmacoes;
    }

    try {
        await database.ref().update(updates);
        
        // --- IN√çCIO DA L√ìGICA DE MENSAGEM INTELIGENTE ---
        const statusOriginal = dadosOriginais.status;
        if (statusOriginal === 'pendente' && novoStatus === 'confirmada') {
            alert("Altera√ß√µes salvas! Como n√£o h√° mais jogadores pendentes, a reserva foi automaticamente confirmada para os participantes restantes.");
        } else {
            alert("Reserva atualizada com sucesso!");
        }
        // --- FIM DA L√ìGICA DE MENSAGEM INTELIGENTE ---

    } catch (error) {
        alert("Erro ao atualizar a reserva. Tente novamente.");
        console.error("Erro ao salvar edi√ß√£o:", error);
    } finally {
        fecharModalEdicao();
    }
}



function cancelarEdicao() {
    reservaEmEdicao = null;

    ['quadra', 'dia', 'duracao', 'hora'].forEach(id => document.getElementById(id).disabled = false);

    limparCampos();

    const botaoAgendar = document.getElementById('botaoAgendar');
    botaoAgendar.textContent = 'Agendar';
    botaoAgendar.onclick = atualizarTabela;
    botaoAgendar.style.backgroundColor = '#4CAF50';

    const cancelButton = document.getElementById('cancelButton');
    if (cancelButton) {
        cancelButton.remove();
    }
}

// ADICIONE ESTA NOVA FUN√á√ÉO
function fecharModalAcoes() {
    document.getElementById('modalAcoesReserva').style.display = 'none';
}


// ADICIONE ESTAS DUAS NOVAS FUN√á√ïES

/**
 * Fecha o modal de edi√ß√£o de reserva.
 */
function fecharModalEdicao() {
    reservaEmEdicao = null; // Limpa a reserva em edi√ß√£o
    document.getElementById('modalEdicaoReserva').style.display = 'none';
}

/**
 * Adiciona um novo campo de jogador dentro do modal de edi√ß√£o.
 */
// SUBSTITUA A SUA FUN√á√ÉO adicionarJogadorNaEdicao ATUAL POR ESTA VERS√ÉO
/**
 * Adiciona um novo campo de jogador dentro do modal de edi√ß√£o,
 * removendo os jogadores que j√° foram selecionados.
 */
function adicionarJogadorNaEdicao() {
    const container = document.getElementById('edit-jogadores-container');
    const jogadorRows = container.getElementsByClassName('edit-jogador-row');

    if (jogadorRows.length >= 4) {
        alert("O limite de 4 jogadores por reserva foi atingido.");
        return;
    }

    // ==========================================================
    // IN√çCIO DA L√ìGICA DE FILTRAGEM
    // ==========================================================

    // 1. Coleta os apelidos de todos os jogadores j√° selecionados no modal
    const jogadoresJaSelecionados = [];
    const selectsAtuais = container.querySelectorAll('select');
    selectsAtuais.forEach(select => {
        // Ignora o "Convidado" para que possa ser selecionado m√∫ltiplas vezes
        if (select.value && select.value.toLowerCase() !== 'convidado') {
            jogadoresJaSelecionados.push(select.value);
        }
    });

    // ==========================================================
    // FIM DA L√ìGICA DE FILTRAGEM
    // ==========================================================

    const newRow = document.createElement('div');
    newRow.className = 'edit-jogador-row';
    
    const novoSelect = document.createElement('select');
    // Popula o novo campo com a lista completa de jogadores
    novoSelect.innerHTML = document.getElementById('jogadorSelect').innerHTML;

    // Remove os jogadores j√° selecionados do novo campo
    jogadoresJaSelecionados.forEach(apelido => {
        const optionToRemove = novoSelect.querySelector(`option[value="${apelido}"]`);
        if (optionToRemove) {
            optionToRemove.remove();
        }
    });
    
    const removeButton = document.createElement('span');
    removeButton.className = 'remove-jogador-btn';
    removeButton.innerHTML = '&times;';
    removeButton.onclick = () => newRow.remove();

    newRow.appendChild(novoSelect);
    newRow.appendChild(removeButton);
    container.appendChild(newRow);
}



/**
 * Valida a regra "Quebra Hor√°rio Domingo", que otimiza as reservas por quadra
 * no bloco das 8:00 √†s 12:00 aos domingos.
 * @param {number} dia - O dia da semana selecionado (1-7).
 * @param {number} hora - A hora de in√≠cio selecionada.
 * @param {number} duracao - A dura√ß√£o da reserva selecionada.
 * @param {string} quadra - A quadra selecionada (ex: "Quadra 1 - Coberta").
 * @returns {boolean} - Retorna 'true' se a reserva for v√°lida, 'false' se for bloqueada.
 */
function validarQuebraHorarioDomingo(dia, hora, duracao, quadra) {
    // Regra do "Mesmo Dia": Se a reserva for para hoje, ignora todas as regras.
    const hoje = new Date();
    const diaDaSemanaHoje = hoje.getDay() === 0 ? 7 : hoje.getDay();
    if (dia === diaDaSemanaHoje) {
        return true;
    }

    // --- In√≠cio das Pr√©-condi√ß√µes ---
    if (dia !== 7) {
        return true;
    }
    if (quebraHorarioDomingoConfig.ativa === true) {
        return true;
    }
    
    const quadraKey = `Quadra-${quadra.split(' ')[1]}`;
    if (!quebraHorarioDomingoConfig.quadras || !quebraHorarioDomingoConfig.quadras[quadraKey]) {
        return true;
    }
    
    const isBlocoPadraoDomingo = (window.vDomingo === 'fechado') || (window.vDomingo === 'aberto' && window.vDomingoAte === '12:00');
    if (!isBlocoPadraoDomingo) {
        return true;
    }

    // --- Fim das Pr√©-condi√ß√µes ---

    // Cen√°rio: Tentativa de agendar √†s 9:00 (qualquer dura√ß√£o)
    if (hora === 9) {
         alert(`‚ö†Ô∏è Regra de Otimiza√ß√£o de Domingo\n\nNa ${quadra}, para evitar a quebra de hor√°rios, reservas de 1 hora n√£o s√£o permitidas √†s 9:00.`);
         return false;
    }

    // Cen√°rio: Tentativa de agendar 1 hora √†s 8:00
    if (hora === 8 && duracao === 1) {
        alert(`‚ö†Ô∏è Regra de Otimiza√ß√£o de Domingo\n\nNa ${quadra}, para evitar a quebra de hor√°rios, reservas de 1 hora n√£o s√£o permitidas √†s 8:00.`);
        return false;
    }

    // Cen√°rio: Tentativa de agendar 1 hora √†s 10:00
    if (hora === 10 && duracao === 1) {
        alert(`‚ö†Ô∏è Regra de Otimiza√ß√£o de Domingo\n\nNa ${quadra}, para evitar a quebra de hor√°rios, reservas de 1 hora n√£o s√£o permitidas √†s 10:00.`);
        return false;
    }

    // Cen√°rio: Tentativa de agendar 1 hora √†s 11:00
    if (hora === 11 && duracao === 1) {
        alert(`‚ö†Ô∏è Regra de Otimiza√ß√£o de Domingo\n\nNa ${quadra}, para evitar a quebra de hor√°rios, reservas de 1 hora n√£o s√£o permitidas √†s 11:00.`);
        return false;
    }
    
    // Cen√°rio: Tentativa de 2 horas √†s 9:00 (redundante, mas seguro)
    if (hora === 9 && duracao === 2) {
        alert(`‚ö†Ô∏è Regra de Otimiza√ß√£o de Domingo\n\nNa ${quadra}, para evitar hor√°rios vagos de 1 hora, esta reserva de 2 horas n√£o pode come√ßar √†s 9:00.\n\nPor favor, escolha come√ßar √†s 8:00 ou √†s 10:00.`);
        return false;
    }

    // Se passou por todas as verifica√ß√µes, a reserva √© v√°lida.
    return true;
}




/* ================================================== */
/* === FUN√á√ÉO DE ANIVERS√ÅRIO (VERS√ÉO COM CHUVA DE CONFETES) === */
/* ================================================== */

function checarAniversario() {
    const jogadorLogado = localStorage.getItem('jogadorLogado');
    if (!jogadorLogado) return;

    const jogadorApelido = Object.keys(jogadoresData).find(
        apelido => jogadoresData[apelido].nomeCompleto === jogadorLogado
    );

    if (!jogadorApelido || !jogadoresData[jogadorApelido].niver) return;

    const niver = jogadoresData[jogadorApelido].niver; // Formato: "dd/mm/yyyy"
    if (niver.length < 10) return;

    const niverDiaMes = niver.substring(0, 5);

    const hoje = new Date();
    const hojeDia = String(hoje.getDate()).padStart(2, '0');
    const hojeMes = String(hoje.getMonth() + 1).padStart(2, '0');
    const hojeDiaMes = `${hojeDia}/${hojeMes}`;

    if (niverDiaMes == hojeDiaMes) {
        
        // --- 1. Inicia a CHUVA de confetes ---
        // Vamos guardar o ID do intervalo para podermos par√°-lo depois
        const duration = 15 * 1000; // Dura√ß√£o total da anima√ß√£o em milissegundos
        const animationEnd = Date.now() + duration;
        let defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 1999 }; // zIndex baixo para ficar atr√°s do modal

        function randomInRange(min, max) {
            return Math.random() * (max - min) + min;
        }

        const interval = setInterval(function() {
            let timeLeft = animationEnd - Date.now();
            if (timeLeft <= 0) {
                return clearInterval(interval);
            }
            let particleCount = 50 * (timeLeft / duration);
            // Lan√ßa os confetes
            confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
            confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
        }, 250);


        // --- 2. Aguarda um pouco para mostrar o cart√£o ---
        setTimeout(() => {
            // --- 3. Calcula a idade ---
            const anoNiver = parseInt(niver.substring(6, 10), 10);
            const mesNiver = parseInt(niver.substring(3, 5), 10) - 1;
            const diaNiver = parseInt(niver.substring(0, 2), 10);
            let idade = hoje.getFullYear() - anoNiver;
            if (hoje.getMonth() < mesNiver || (hoje.getMonth() === mesNiver && hoje.getDate() < diaNiver)) {
                idade--;
            }

            // --- 4. Prepara e exibe o modal ---
            const modal = document.getElementById('birthdayModalOverlay');
            const nomeSpan = document.getElementById('birthdayName');
            const idadeSpan = document.getElementById('birthdayAge');
            const closeButton = document.getElementById('closeBirthdayModal');

            nomeSpan.textContent = jogadorLogado.split(' ')[0];
            idadeSpan.textContent = idade;
            modal.style.display = 'flex';

            // --- 5. Define a a√ß√£o de fechar o modal ---
            const fecharModal = () => {
                modal.style.display = 'none';
                // Para a chuva de confetes
                clearInterval(interval);
                
                // Dispara a explos√£o final de confetes!
                confetti({
                    particleCount: 200,
                    spread: 180,
                    startVelocity: 55,
                    zIndex: 9999 // zIndex alto para ficar na frente de tudo
                });
            };

            closeButton.onclick = fecharModal;
            modal.onclick = function(event) {
                if (event.target === modal) {
                    fecharModal();
                }
            };
        }, 1500); // Aumentei um pouco o atraso para dar tempo dos confetes come√ßarem
    }
}

// ==========================================================
// ====== C√ìDIGO DA FUNCIONALIDADE - RESULTADO PIR√ÇMIDE ======
// ==========================================================

// Vari√°vel global para guardar a refer√™ncia da reserva em edi√ß√£o de resultado
let reservaResultadoEmEdicao = null;


// SUBSTITUA SUA FUN√á√ÉO 'mostrarOpcoesPiramide' PELA VERS√ÉO ABAIXO
// SUBSTITUA SUA FUN√á√ÉO ATUAL PELA VERS√ÉO ATUALIZADA
function mostrarOpcoesPiramide(reserva, key, quadra) {
    const modal = document.getElementById('modalAcoesReserva');
    const btnVer = document.getElementById('btnModalVer');
    const btnExcluir = document.getElementById('btnModalExcluir');
    const btnCancelar = document.getElementById('btnModalCancelar');
    const btnEditarJogadores = document.getElementById('btnModalEditar');
	
	const btnResultadoDuplas = document.getElementById('btnModalResultadoDuplas');
    if (btnResultadoDuplas) {
        btnResultadoDuplas.style.display = 'none';
    }
    
    let btnResultado = document.getElementById('btnModalResultado');
    if (btnResultado) btnResultado.remove();
    btnResultado = document.createElement('button');
    btnResultado.id = 'btnModalResultado';

    if (reserva.status === 'resultado_pendente') {
        btnResultado.textContent = 'Editar Resultado';
        btnResultado.style.backgroundColor = '#ffc107';
        btnResultado.style.color = 'black';
        btnResultado.onclick = async () => { 
            await abrirModalResultado(reserva, key, quadra, false); 
            fecharModalAcoes();
        };
    } else if (reserva.resultado) {
        btnResultado.textContent = 'Ver Resultado';
        btnResultado.style.backgroundColor = '#17a2b8';
        // --- IN√çCIO DA ATUALIZA√á√ÉO ---
        // A√ß√£o 'onclick' corrigida para chamar a fun√ß√£o correta
        btnResultado.onclick = async () => { 
            await abrirModalResultado(reserva, key, quadra, true); 
            fecharModalAcoes();
        };
        // --- FIM DA ATUALIZA√á√ÉO ---
    } else {
        btnResultado.textContent = 'Informar Resultado';
        btnResultado.style.backgroundColor = '#28a745';
        btnResultado.onclick = async () => { 
            await abrirModalResultado(reserva, key, quadra, false); 
            fecharModalAcoes();
        };
    }

    btnVer.after(btnResultado);
    btnEditarJogadores.style.display = 'none';

    const agora = new Date();
    const dataString = document.getElementById('tabelaQuadra').rows[1].cells[reserva.dia - 1].textContent;
    const [dia, mes, ano] = dataString.split('/');
    const horaFim = reserva.hora + 2; // Jogos de pir√¢mide sempre duram 2 horas
    const dataHoraFimReserva = new Date(ano, mes - 1, dia, horaFim, 0, 0);

    const isJogoFuturo = agora < dataHoraFimReserva;
    const podeExcluir = isUsuarioAdmin() || vPermitirExclusaoAposJogo || isJogoFuturo;
    btnExcluir.style.display = podeExcluir ? 'block' : 'none';

    btnVer.onclick = () => {
        exibirDetalhesReserva(reserva);
        fecharModalAcoes();
    };
    btnExcluir.onclick = () => {
        fecharModalAcoes();
        setTimeout(() => {
            if (confirm("Voc√™ tem certeza que deseja excluir esta reserva?")) {
                excluirReserva(reserva.hora - 6, reserva.dia);
            }
        }, 100);
    };
    btnCancelar.onclick = fecharModalAcoes;
    modal.onclick = (event) => {
        if (event.target === modal) fecharModalAcoes();
    };

    modal.style.display = 'flex';
}

// ==================================================================
// PACOTE DE AJUSTES FINAIS (T√çTULO COM APELIDO E COR DO VENCEDOR)
// ==================================================================

/**
 * Abre o modal de resultados, agora com t√≠tulo formatado com apelidos e spans para cor.
 */
// SUBSTITUA SUA FUN√á√ÉO 'abrirModalResultado' PELA VERS√ÉO ABAIXO
async function abrirModalResultado(reserva, key, quadra, modoVisualizacao) {
    // --- IN√çCIO DA CORRE√á√ÉO ---
    let listaDeJogadores;
	modoResultado = 'placar';

    // 1. Verifica se a lista completa de jogadores j√° existe.
    if (reserva.jogadores_completo) {
        listaDeJogadores = reserva.jogadores_completo.split(',').map(j => j.trim());
    } else {
        // 2. Se n√£o existe, busca a segunda parte da reserva para reconstruir a lista.
        const jogador1Apelido = reserva.jogadores.split(',').map(j => j.trim())[0];
        const keySegundaHora = `${reserva.dia}_${reserva.hora + 1}`;
        const reserva2Ref = database.ref(`sistemas/reservas/${quadra}/${keySegundaHora}`);
        const snapshot2 = await reserva2Ref.once('value');
        const reserva2 = snapshot2.val();
        
        if (!reserva2 || !reserva2.jogadores) {
            alert("Erro: N√£o foi poss√≠vel encontrar a segunda parte desta reserva de Pir√¢mide.");
            return;
        }
        const jogador2Apelido = reserva2.jogadores.split(',').map(j => j.trim())[0];
        listaDeJogadores = [jogador1Apelido, jogador2Apelido];
    }
    
    const jogador1Apelido = listaDeJogadores[0];
    const jogador2Apelido = listaDeJogadores[1];
    // --- FIM DA CORRE√á√ÉO ---

    reservaResultadoEmEdicao = { reserva, key, quadra, jogador1: jogador1Apelido, jogador2: jogador2Apelido };
	
	// --- IN√çCIO DAS NOVAS MODIFICA√á√ïES ---

    // 1. Resetar a interface para o estado padr√£o (placar)
    document.getElementById('placar-fields-container').style.display = 'block';
    document.getElementById('wo-controls').style.display = 'none';
    document.getElementById('desistencia-controls').style.display = 'none';
    document.getElementById('link-voltar-placar').style.display = 'none';
    document.getElementById('menu-opcoes-resultado').classList.remove('visivel');

    // 2. Popular os novos menus <select> com os nomes dos jogadores
    const selectVencedorWo = document.getElementById('select-vencedor-wo');
    const selectDesistente = document.getElementById('select-desistente');
    selectVencedorWo.innerHTML = `<option value="">Selecione</option><option value="${jogador1Apelido}">${jogador1Apelido}</option><option value="${jogador2Apelido}">${jogador2Apelido}</option>`;
    selectDesistente.innerHTML = `<option value="">Selecione</option><option value="${jogador1Apelido}">${jogador1Apelido}</option><option value="${jogador2Apelido}">${jogador2Apelido}</option>`;

    // --- FIM DAS NOVAS MODIFICA√á√ïES ---
    
    const modal = document.getElementById('modalResultadoPiramide');
    const matchup = document.getElementById('resultado-matchup');
    matchup.innerHTML = `<span id="apelido-j1">${jogador1Apelido}</span> x <span id="apelido-j2">${jogador2Apelido}</span>`;

    // Limpa e prepara todos os campos
    ['set1-j1', 'set1-j2', 'set2-j1', 'set2-j2', 'set3-j1', 'set3-j2', 'tb1-j1', 'tb1-j2', 'tb2-j1', 'tb2-j2'].forEach(id => {
        const input = document.getElementById(id);
        const novoInput = input.cloneNode(true);
        input.parentNode.replaceChild(novoInput, input);
        novoInput.value = '';
        novoInput.disabled = modoVisualizacao;
    });
    
    document.getElementById('tiebreak1-container').style.display = 'none';
    document.getElementById('tiebreak2-container').style.display = 'none';
    document.getElementById('terceiro-set-container').style.display = 'none';
    document.getElementById('resultado-vencedor').textContent = '-';

    // Se um resultado j√° existe, preenche o formul√°rio
    if (reserva.resultado) {
        if (reserva.resultado.set1) {
            [document.getElementById('set1-j1').value, document.getElementById('set1-j2').value] = reserva.resultado.set1.placar.split('x');
            if (reserva.resultado.set1.tiebreak) {
                [document.getElementById('tb1-j1').value, document.getElementById('tb1-j2').value] = reserva.resultado.set1.tiebreak.split('-');
            }
        }
        if (reserva.resultado.set2) {
            [document.getElementById('set2-j1').value, document.getElementById('set2-j2').value] = reserva.resultado.set2.placar.split('x');
            if (reserva.resultado.set2.tiebreak) {
                [document.getElementById('tb2-j1').value, document.getElementById('tb2-j2').value] = reserva.resultado.set2.tiebreak.split('-');
            }
        }
        if (reserva.resultado.set3) {
            [document.getElementById('set3-j1').value, document.getElementById('set3-j2').value] = reserva.resultado.set3.split('x');
        }
        calcularVencedorPiramide();
    }

    // Configura os bot√µes e listeners
    document.getElementById('btnSalvarResultado').style.display = modoVisualizacao ? 'none' : 'block';
    document.getElementById('btnCancelarResultado').onclick = fecharModalResultado;

    if (!modoVisualizacao) {
        ['set1-j1', 'set1-j2', 'set2-j1', 'set2-j2', 'set3-j1', 'set3-j2', 'tb1-j1', 'tb1-j2', 'tb2-j1', 'tb2-j2'].forEach(id => {
            document.getElementById(id).addEventListener('input', calcularVencedorPiramide);
        });
        document.getElementById('btnSalvarResultado').onclick = salvarResultadoPiramide;
    }
    
    modal.style.display = 'flex';
}

// --- NOVO BLOCO DE C√ìDIGO PARA CONTROLE DA INTERFACE DO MENU ---

// Estado para controlar o modo de preenchimento
// ==============================================================================
// NOVO BLOCO DE L√ìGICA PARA O MENU DE 3 OP√á√ïES E CONTROLE DOS CAMPOS
// ==============================================================================

// Estado para controlar o modo de preenchimento
let modoResultado = 'placar'; // pode ser 'placar', 'wo' ou 'desistencia'

// Nova fun√ß√£o auxiliar para habilitar/desabilitar os campos de placar
function setPlacarFieldsState(disabled) {
    const container = document.getElementById('placar-fields-container');
    const inputs = container.querySelectorAll('input[type="number"]');
    inputs.forEach(input => {
        input.disabled = disabled;

        // --- L√ìGICA ADICIONADA AQUI ---
        // Se a fun√ß√£o est√° sendo usada para desabilitar os campos...
        if (disabled) {
            // ...ela tamb√©m limpa o valor de cada um.
            input.value = '';
        }
    });
}

// Fun√ß√£o para resetar a UI para o modo de placar padr√£o
function resetarParaModoPlacar() {
    modoResultado = 'placar';

    // Oculta os pain√©is de W.O. e Desist√™ncia
    document.getElementById('wo-controls').style.display = 'none';
    document.getElementById('desistencia-controls').style.display = 'none';

    // Restaura os labels para o padr√£o
    document.querySelector('label[for="select-vencedor-wo"]').textContent = 'Vencedor:';
    document.getElementById('label-vencedor-final').textContent = 'Vencedor:';

    // --- L√ìGICA PRINCIPAL DA CORRE√á√ÉO ---
    // Verifica se h√° um resultado original guardado na mem√≥ria (caso de edi√ß√£o)
    if (reservaResultadoEmEdicao && reservaResultadoEmEdicao.reserva.resultado) {
        const resultadoOriginal = reservaResultadoEmEdicao.reserva.resultado;

        // Repopula os campos com os dados originais
        if (resultadoOriginal.set1 && resultadoOriginal.set1.placar) {
            [document.getElementById('set1-j1').value, document.getElementById('set1-j2').value] = resultadoOriginal.set1.placar.split('x');
            if (resultadoOriginal.set1.tiebreak) {
                [document.getElementById('tb1-j1').value, document.getElementById('tb1-j2').value] = resultadoOriginal.set1.tiebreak.split('-');
            }
        }
        if (resultadoOriginal.set2 && resultadoOriginal.set2.placar) {
            [document.getElementById('set2-j1').value, document.getElementById('set2-j2').value] = resultadoOriginal.set2.placar.split('x');
            if (resultadoOriginal.set2.tiebreak) {
                [document.getElementById('tb2-j1').value, document.getElementById('tb2-j2').value] = resultadoOriginal.set2.tiebreak.split('-');
            }
        }
        if (resultadoOriginal.set3) {
            [document.getElementById('set3-j1').value, document.getElementById('set3-j2').value] = resultadoOriginal.set3.split('x');
        }

        // Recalcula o vencedor e atualiza os tie-breaks vis√≠veis
        calcularVencedorPiramide();

    } else {
        // Se n√£o for uma edi√ß√£o (resultado novo), apenas limpa os campos
        setPlacarFieldsState(true); // Usamos o "desabilitar" para for√ßar a limpeza
        document.getElementById('resultado-vencedor').textContent = '-';
    }

    // Garante que os campos de placar fiquem habilitados
    setPlacarFieldsState(false);
}

// Event listener para o bot√£o de mais op√ß√µes (‚ãÆ) - Sem altera√ß√µes
// Event listener para o bot√£o de mais op√ß√µes (‚ãÆ) - VERS√ÉO ATUALIZADA
document.getElementById('btn-mais-opcoes').addEventListener('click', function() {
    // Primeiro, pega a refer√™ncia de todos os itens do menu
    const itemJogoNormal = document.getElementById('acao-jogo-normal');
    const itemWo = document.getElementById('acao-wo');
    const itemDesistencia = document.getElementById('acao-desistencia');

    // Deixa todos os itens vis√≠veis por padr√£o, antes de fazer a checagem
    itemJogoNormal.style.display = 'block';
    itemWo.style.display = 'block';
    itemDesistencia.style.display = 'block';

    // Agora, esconde o item que corresponde ao modo atual
    if (modoResultado === 'placar') {
        itemJogoNormal.style.display = 'none';
    } else if (modoResultado === 'wo') {
        itemWo.style.display = 'none';
    } else if (modoResultado === 'desistencia') {
        itemDesistencia.style.display = 'none';
    }

    // Finalmente, mostra ou esconde o container do menu
    document.getElementById('menu-opcoes-resultado').classList.toggle('visivel');
});

// Event listener para a op√ß√£o "Jogo Normal"
document.getElementById('acao-jogo-normal').addEventListener('click', function(e) {
    e.preventDefault();
    resetarParaModoPlacar();
    document.getElementById('menu-opcoes-resultado').classList.remove('visivel');
});

// Event listener para a op√ß√£o "W.O."
document.getElementById('acao-wo').addEventListener('click', function(e) {
    e.preventDefault();
    modoResultado = 'wo';
    setPlacarFieldsState(true); // Desabilita os campos de placar
    document.getElementById('wo-controls').style.display = 'block';
    document.getElementById('desistencia-controls').style.display = 'none';
    document.getElementById('menu-opcoes-resultado').classList.remove('visivel');
    
    // --- LINHA ADICIONADA ---
    document.querySelector('label[for="select-vencedor-wo"]').textContent = 'Vencedor por W.O.:';
	document.getElementById('label-vencedor-final').textContent = 'Vencedor por W.O.:';
});

// Event listener para a op√ß√£o "Desist√™ncia"
document.getElementById('acao-desistencia').addEventListener('click', function(e) {
    e.preventDefault();
    modoResultado = 'desistencia';
    setPlacarFieldsState(false); // Garante que os campos de placar estejam habilitados
    document.getElementById('wo-controls').style.display = 'none';
    document.getElementById('desistencia-controls').style.display = 'block';
    document.getElementById('menu-opcoes-resultado').classList.remove('visivel');
	document.getElementById('label-vencedor-final').textContent = 'Vencedor por Desist√™ncia:';
});

// --- O RESTANTE DAS FUN√á√ïES DE CONTROLE PERMANECE O MESMO ---

// Atualiza o vencedor automaticamente ao selecionar no menu de W.O.
document.getElementById('select-vencedor-wo').addEventListener('change', function() {
    const vencedor = this.value;
    document.getElementById('resultado-vencedor').textContent = vencedor || '-';
});

// Atualiza o vencedor automaticamente ao selecionar quem desistiu (l√≥gica inversa)
document.getElementById('select-desistente').addEventListener('change', function() {
    const desistente = this.value;
    if (!desistente) {
        document.getElementById('resultado-vencedor').textContent = '-';
        return;
    }
    const { jogador1, jogador2 } = reservaResultadoEmEdicao;
    const vencedor = (desistente === jogador1) ? jogador2 : jogador1;
    document.getElementById('resultado-vencedor').textContent = vencedor;
});

// Fecha o menu de op√ß√µes se clicar fora dele
window.addEventListener('click', function(e) {
    const menu = document.getElementById('menu-opcoes-resultado');
    const botao = document.getElementById('btn-mais-opcoes');
    if (menu && botao && !menu.contains(e.target) && !botao.contains(e.target)) {
        menu.classList.remove('visivel');
    }
});





/**
 * Calcula o vencedor e agora tamb√©m colore o apelido do vencedor no t√≠tulo.
 */
// SUBSTITUA SUA FUN√á√ÉO 'calcularVencedorPiramide' PELA VERS√ÉO ABAIXO
// SUBSTITUA A SUA FUN√á√ÉO INTEIRA PELA VERS√ÉO ATUALIZADA ABAIXO
function calcularVencedorPiramide() {
    // --- Refer√™ncias aos campos de input ---
    const inputs = {
        s1j1: document.getElementById('set1-j1'), s1j2: document.getElementById('set1-j2'),
        s2j1: document.getElementById('set2-j1'), s2j2: document.getElementById('set2-j2'),
        s3j1: document.getElementById('set3-j1'), s3j2: document.getElementById('set3-j2'),
        tb1j1: document.getElementById('tb1-j1'), tb1j2: document.getElementById('tb1-j2'),
        tb2j1: document.getElementById('tb2-j1'), tb2j2: document.getElementById('tb2-j2')
    };

    // Valida√ß√£o de comprimento dos d√≠gitos
    [inputs.s1j1, inputs.s1j2, inputs.s2j1, inputs.s2j2].forEach(input => {
        if (input.value.length > 1) {
            input.value = input.value.slice(0, 1);
        }
        if (parseInt(input.value) > 7) input.value = 7;
    });
    [inputs.tb1j1, inputs.tb1j2, inputs.tb2j1, inputs.tb2j2, inputs.s3j1, inputs.s3j2].forEach(input => {
        if (input.value.length > 2) {
            input.value = input.value.slice(0, 2);
        }
    });

    // A fun√ß√£o auxiliar interna foi movida para fora e agora √© global

    const jogador1Apelido = reservaResultadoEmEdicao.jogador1;
    const jogador2Apelido = reservaResultadoEmEdicao.jogador2;
    let setsJ1 = 0, setsJ2 = 0;
    let vencedorApelido = null;

    // Processa Set 1
    const s1v1 = parseInt(inputs.s1j1.value, 10), s1v2 = parseInt(inputs.s1j2.value, 10);
    const tb1v1 = parseInt(inputs.tb1j1.value, 10), tb1v2 = parseInt(inputs.tb1j2.value, 10);
    document.getElementById('tiebreak1-container').style.display = (s1v1 === 7 && s1v2 === 6) || (s1v1 === 6 && s1v2 === 7) ? 'inline-flex' : 'none';
    const vencedorSet1 = determinarVencedorSet(s1v1, s1v2, tb1v1, tb1v2);
    if (vencedorSet1 === 'j1') setsJ1++;
    if (vencedorSet1 === 'j2') setsJ2++;

    // Processa Set 2
    const s2v1 = parseInt(inputs.s2j1.value, 10), s2v2 = parseInt(inputs.s2j2.value, 10);
    const tb2v1 = parseInt(inputs.tb2j1.value, 10), tb2v2 = parseInt(inputs.tb2j2.value, 10);
    document.getElementById('tiebreak2-container').style.display = (s2v1 === 7 && s2v2 === 6) || (s2v1 === 6 && s2v2 === 7) ? 'inline-flex' : 'none';
    const vencedorSet2 = determinarVencedorSet(s2v1, s2v2, tb2v1, tb2v2);
    if (vencedorSet2 === 'j1') setsJ1++;
    if (vencedorSet2 === 'j2') setsJ2++;

    if (setsJ1 === 2) vencedorApelido = jogador1Apelido;
    else if (setsJ2 === 2) vencedorApelido = jogador2Apelido;

    // Processa 3¬∫ Set (Super Tie-break)
    const terceiroSetContainer = document.getElementById('terceiro-set-container');
    if (vencedorSet1 && vencedorSet2 && setsJ1 === 1 && setsJ2 === 1) {
        terceiroSetContainer.style.display = 'flex';
        const s3v1 = parseInt(inputs.s3j1.value, 10);
        const s3v2 = parseInt(inputs.s3j2.value, 10);
        if (!isNaN(s3v1) && !isNaN(s3v2)) {
            if ((s3v1 === 10 && s3v2 <= 8) || (s3v1 > 10 && (s3v1 - s3v2) === 2)) {
                vencedorApelido = jogador1Apelido;
            } else if ((s3v2 === 10 && s3v1 <= 8) || (s3v2 > 10 && (s3v2 - s3v1) === 2)) {
                vencedorApelido = jogador2Apelido;
            }
        }
    } else {
        terceiroSetContainer.style.display = 'none';
    }

    // --- Atualiza a interface ---
    const vencedorFinalSpan = document.getElementById('resultado-vencedor');
    const spanApelidoJ1 = document.getElementById('apelido-j1');
    const spanApelidoJ2 = document.getElementById('apelido-j2');
    
    spanApelidoJ1.style.color = '';
    spanApelidoJ2.style.color = '';

    if (vencedorApelido) {
¬† ¬† ¬† ¬† vencedorFinalSpan.textContent = vencedorApelido; // Alterado para usar apenas o apelido

¬† ¬† ¬† ¬† if (vencedorApelido === jogador1Apelido) spanApelidoJ1.style.color = 'green';
¬† ¬† ¬† ¬† else if (vencedorApelido === jogador2Apelido) spanApelidoJ2.style.color = 'green';
¬† ¬† } else {
¬† ¬† ¬† ¬† vencedorFinalSpan.textContent = '-';
¬† ¬† }
    
}


/**
 * Salva os dados do resultado, agora com a nova estrutura de tie-break.
 */
// NOVA VERS√ÉO: AGORA CHAMA O MODAL DE CONFIRMA√á√ÉO
// VERS√ÉO ATUALIZADA: SALVA DIRETAMENTE, SEM MODAL DE CONFIRMA√á√ÉO
// VERS√ÉO ATUALIZADA COM VALIDA√á√ÉO OBRIGAT√ìRIA PARA DESIST√äNCIA
function salvarResultadoPiramide() {
    if (!reservaResultadoEmEdicao) return;

    const { jogador1, jogador2 } = reservaResultadoEmEdicao;
    const jogadorLogadoCompleto = localStorage.getItem('jogadorLogado');
    let resultadoData = {};

    if (modoResultado === 'placar') {
        calcularVencedorPiramide();
        const vencedorApelido = document.getElementById('resultado-vencedor').textContent;

        if (vencedorApelido === '-') {
            return alert("O placar inserido n√£o define um vencedor. Por favor, corrija os valores.");
        }
        
        // --- VALIDA√á√ÉO DE PERMISS√ÉO PRIMEIRO ---
        const vencedorInfo = jogadoresData[vencedorApelido];
        const vencedorNomeCompleto = vencedorInfo ? vencedorInfo.nomeCompleto : vencedorApelido;
        if (!isUsuarioAdmin() && !isUsuarioArbitro() && (jogadorLogadoCompleto.toUpperCase() !== vencedorNomeCompleto.toUpperCase())) {
            return alert("Aten√ß√£o: Apenas o jogador declarado como vencedor, o √°rbitro ou um administrador podem salvar o resultado.");
        }

        resultadoData = {
            tipo: 'Placar Normal',
            vencedor: vencedorApelido,
            perdedor: (vencedorApelido === jogador1) ? jogador2 : jogador1,
            set1: { placar: `${document.getElementById('set1-j1').value}x${document.getElementById('set1-j2').value}`, tiebreak: (document.getElementById('tb1-j1').value && document.getElementById('tb1-j2').value) ? `${document.getElementById('tb1-j1').value}-${document.getElementById('tb1-j2').value}` : "" },
            set2: { placar: `${document.getElementById('set2-j1').value}x${document.getElementById('set2-j2').value}`, tiebreak: (document.getElementById('tb2-j1').value && document.getElementById('tb2-j2').value) ? `${document.getElementById('tb2-j1').value}-${document.getElementById('tb2-j2').value}` : "" },
            set3: (document.getElementById('set3-j1').value && document.getElementById('set3-j2').value) ? `${document.getElementById('set3-j1').value}x${document.getElementById('set3-j2').value}` : ""
        };

    } else if (modoResultado === 'wo') {
        const vencedorApelido = document.getElementById('select-vencedor-wo').value;
        const motivo = document.getElementById('select-motivo-wo').value;

        if (!vencedorApelido || !motivo) {
            return alert("Por favor, selecione o vencedor e o motivo do W.O.");
        }
        
        // --- VALIDA√á√ÉO DE PERMISS√ÉO PRIMEIRO ---
        const vencedorInfo = jogadoresData[vencedorApelido];
        const vencedorNomeCompleto = vencedorInfo ? vencedorInfo.nomeCompleto : vencedorApelido;
        if (!isUsuarioAdmin() && !isUsuarioArbitro() && (jogadorLogadoCompleto.toUpperCase() !== vencedorNomeCompleto.toUpperCase())) {
            return alert("Aten√ß√£o: Apenas o jogador declarado como vencedor, o √°rbitro ou um administrador podem salvar o resultado.");
        }
		
		
        
        resultadoData = {
            tipo: 'W.O.',
            vencedor: vencedorApelido,
            perdedor: (vencedorApelido === jogador1) ? jogador2 : jogador1,
            motivo: motivo
        };
        
    } else if (modoResultado === 'desistencia') {
        const desistente = document.getElementById('select-desistente').value;
        const motivo = document.getElementById('select-motivo-desistencia').value;
        const s1j1 = document.getElementById('set1-j1').value;
        const s1j2 = document.getElementById('set1-j2').value;

        if (!desistente) {
            return alert("Por favor, selecione quem desistiu da partida.");
        }
        
        const vencedorApelido = (desistente === jogador1) ? jogador2 : jogador1;

        // --- VALIDA√á√ÉO DE PERMISS√ÉO PRIMEIRO ---
        const vencedorInfo = jogadoresData[vencedorApelido];
        const vencedorNomeCompleto = vencedorInfo ? vencedorInfo.nomeCompleto : vencedorApelido;
        if (!isUsuarioAdmin() && !isUsuarioArbitro() && (jogadorLogadoCompleto.toUpperCase() !== vencedorNomeCompleto.toUpperCase())) {
            return alert("Aten√ß√£o: Apenas o jogador declarado como vencedor, o √°rbitro ou um administrador podem salvar o resultado.");
        }
        
        // Valida√ß√µes restantes
        if (s1j1 === '' || s1j2 === '') {
            return alert("Para Desist√™ncia, √© obrigat√≥rio preencher o placar parcial (pelo menos do 1¬∫ Set).");
        }
        if (!motivo) {
            return alert("Por favor, selecione o motivo da desist√™ncia.");
        }

        resultadoData = {
            tipo: 'Desist√™ncia',
            vencedor: vencedorApelido,
            perdedor: desistente,
            motivo: motivo,
            set1: { placar: `${s1j1}x${s1j2}`, tiebreak: (document.getElementById('tb1-j1').value && document.getElementById('tb1-j2').value) ? `${document.getElementById('tb1-j1').value}-${document.getElementById('tb1-j2').value}` : "" },
            set2: { placar: `${document.getElementById('set2-j1').value}x${document.getElementById('set2-j2').value}`, tiebreak: (document.getElementById('tb2-j1').value && document.getElementById('tb2-j2').value) ? `${document.getElementById('tb2-j1').value}-${document.getElementById('tb2-j2').value}` : "" },
            set3: (document.getElementById('set3-j1').value && document.getElementById('set3-j2').value) ? `${document.getElementById('set3-j1').value}x${document.getElementById('set3-j2').value}` : ""
        };
    }

    // Se passou por todas as valida√ß√µes, chama a fun√ß√£o de salvamento
    executarSalvamentoResultado(resultadoData);
}





async function executarSalvamentoResultado(resultadoData) {
    if (!reservaResultadoEmEdicao) return;
    
    const jogadorLogadoCompleto = localStorage.getItem('jogadorLogado');
    const jogadorLogadoApelido = Object.keys(jogadoresData).find(apelido => jogadoresData[apelido].nomeCompleto.toUpperCase() === jogadorLogadoCompleto.toUpperCase());
    resultadoData.informadoPor = isUsuarioAdmin() ? "Administrador" : (isUsuarioArbitro() ? "√Årbitro" : (jogadorLogadoApelido || jogadorLogadoCompleto));
    resultadoData.dataInformado = new Date().toISOString();

    const { reserva, key, quadra } = reservaResultadoEmEdicao;
    const updates = {};
    const path1 = `sistemas/reservas/${quadra}/${key}`;
    const novoStatus = (isUsuarioAdmin() || isUsuarioArbitro()) ? "finalizada" : "resultado_pendente"; 
    
    updates[`${path1}/status`] = novoStatus;
    updates[`${path1}/resultado`] = resultadoData;

    if (reserva.duracao > 1) {
        const key2 = `${reserva.dia}_${reserva.hora + 1}`;
        updates[`sistemas/reservas/${quadra}/${key2}/status`] = novoStatus;
        updates[`sistemas/reservas/${quadra}/${key2}/resultado`] = resultadoData;
    }

    if (isUsuarioAdmin() || isUsuarioArbitro()) {
        const tempReservaParaOperacoes = { ...reserva, resultado: resultadoData };
        const rankUpdates = processarTrocaDeRanking(tempReservaParaOperacoes);
        const notificacaoUpdates = enviarNotificacaoResultadoFinalizado(tempReservaParaOperacoes, isUsuarioAdmin() ? "informado pelo Administrador" : "corrigido pelo √Årbitro");
        Object.assign(updates, rankUpdates, notificacaoUpdates);
    }

    try {
        await database.ref().update(updates);
        let mensagemSucesso = '';
        if (isUsuarioAdmin()) {
            mensagemSucesso = "Resultado salvo e finalizado com sucesso pelo Administrador! Os jogadores ser√£o notificados.";
        } else if (isUsuarioArbitro()) {
            mensagemSucesso = "Resultado salvo e finalizado com sucesso pelo √Årbitro! Os jogadores ser√£o notificados.";
        } else {
            mensagemSucesso = "Resultado salvo! Aguardando confirma√ß√£o do oponente.";
        }
        alert(mensagemSucesso);
        
        // Fecha apenas o modal principal de resultado
        fecharModalResultado();

    } catch (error) {
        console.error("Erro ao salvar resultado:", error);
        alert("Ocorreu um erro ao salvar o resultado. Tente novamente.");
    }
}




/**
 * Fecha o modal de resultado e limpa a refer√™ncia global.
 */
function fecharModalResultado() {
    document.getElementById('modalResultadoPiramide').style.display = 'none';
    reservaResultadoEmEdicao = null;
}

function fecharModalConfirmacaoResultado() {
    document.getElementById('modalConfirmacaoResultado').style.display = 'none';
}


// Adicione esta nova fun√ß√£o ao seu script. Ela n√£o ir√° interferir com a original.
function formatarNomeCompleto(nome) {
    if (!nome || typeof nome !== 'string') return "";
    // Esta vers√£o garante a convers√£o para min√∫sculas antes de capitalizar
    return nome.toLowerCase().split(' ')
               .map(palavra => palavra.charAt(0).toUpperCase() + palavra.slice(1))
               .join(' ');
}



// COLE ESTAS 3 NOVAS FUN√á√ïES NO FINAL DO SEU SCRIPT

/**
 * Verifica se o jogador logado precisa confirmar algum resultado pendente e mostra o modal.
 */
// SUBSTITUA SUA FUN√á√ÉO 'verificarConfirmacoesResultado' PELA VERS√ÉO ABAIXO
async function verificarConfirmacoesResultado(todasAsReservas) {
    const jogadorLogadoCompleto = localStorage.getItem('jogadorLogado');
    if (!jogadorLogadoCompleto) return;

    const jogadorLogadoApelido = Object.keys(jogadoresData).find(
        apelido => jogadoresData[apelido].nomeCompleto.toUpperCase() === jogadorLogadoCompleto.toUpperCase()
    );

    if (!jogadorLogadoApelido) return;

    const modal = document.getElementById('modalConfirmacaoResultado');
    
    for (const quadra in todasAsReservas) {
        const reservasDaQuadra = todasAsReservas[quadra];
        for (const key in reservasDaQuadra) {
            let reservaStale = reservasDaQuadra[key]; // Dados potencialmente desatualizados

            if (reservaStale.status === 'resultado_pendente' && reservaStale.resultado && 
                reservaStale.resultado.perdedor === jogadorLogadoApelido &&
                reservaStale.resultado.informadoPor !== jogadorLogadoApelido) { // Garante que n√£o √© o pr√≥prio informante
                
                // --- IN√çCIO DA CORRE√á√ÉO ---
                // Busca os dados mais recentes da reserva para evitar inconsist√™ncias
                const reservaRef = database.ref(`sistemas/reservas/${quadra}/${key}`);
                const snapshot = await reservaRef.once('value');
                const reserva = snapshot.val(); // Usa os dados frescos do banco

                if (!reserva || !reserva.resultado) continue; // Pula se a reserva foi alterada/removida

                const resumoPartida = document.getElementById('resumo-partida-confirmacao');
                const placarInformado = document.getElementById('placar-informado-confirmacao');
                
                resumoPartida.innerHTML = `
                    <strong>Quadra:</strong> ${quadra}<br>
                    <strong>Data:</strong> ${document.querySelector(`#tabelaQuadra tr:nth-child(2) td:nth-child(${reserva.dia})`).textContent}<br>
                    <strong>Vencedor:</strong> ${reserva.resultado.vencedor}
                `;
                
                // L√ìGICA PARA RECONSTRUIR A ORDEM ORIGINAL DOS JOGADORES
                let jogador1Original, jogador2Original;
                if (reserva.jogadores_completo) {
                    const jogadoresDaPartida = reserva.jogadores_completo.split(',').map(j => j.trim());
                    jogador1Original = jogadoresDaPartida[0];
                    jogador2Original = jogadoresDaPartida[1];
                } else {
                    // Fallback para reservas mais antigas sem o campo 'jogadores_completo'
                    jogador1Original = reserva.jogadores.split(',').map(j => j.trim())[0];
                    const keySegundaHora = `${reserva.dia}_${reserva.hora + 1}`;
                    const reservaSegundaParte = reservasDaQuadra[keySegundaHora];
                     if (reservaSegundaParte && reservaSegundaParte.jogadores) {
                        jogador2Original = reservaSegundaParte.jogadores.split(',').map(j => j.trim())[0];
                    } else {
                        // Se n√£o for poss√≠vel reconstruir, pula para evitar mais erros
                        console.error("N√£o foi poss√≠vel reconstruir a lista de jogadores para a confirma√ß√£o de resultado.", reserva);
                        continue; 
                    }
                }

                // CHAMADA CORRIGIDA: Usa a ordem original dos jogadores
                placarInformado.innerHTML = gerarPlacarHtml(reserva.resultado, jogador1Original, jogador2Original);
                // --- FIM DA CORRE√á√ÉO ---

                document.getElementById('btnAprovarResultado').onclick = () => aprovarResultado(key, quadra);
                document.getElementById('btnRecusarResultado').onclick = () => recusarResultado(key, quadra);
                document.getElementById('btnDepoisResultado').onclick = fecharModalConfirmacaoResultado;
                
                modal.style.display = 'flex';
                return; 
            }
        }
    }
}



/**
 * Altera o status da reserva para 'finalizada' quando o perdedor aprova.
 */
// SUBSTITUA SUA FUN√á√ÉO 'aprovarResultado' PELA VERS√ÉO ABAIXO
// SUBSTITUA SUA FUN√á√ÉO 'aprovarResultado' PELA VERS√ÉO ABAIXO
async function aprovarResultado(reservaKey, quadra) {
    try {
        const reservaRef = database.ref(`sistemas/reservas/${quadra}/${reservaKey}`);
        const snapshot = await reservaRef.once('value');
        const reserva = snapshot.val();

        if (!reserva) {
            alert("Erro: A reserva n√£o foi encontrada.");
            document.getElementById('modalConfirmacaoResultado').style.display = 'none';
            return;
        }

        let updates = {};
        // 1. Prepara a atualiza√ß√£o do status da reserva
        updates[`sistemas/reservas/${quadra}/${reservaKey}/status`] = 'finalizada';
        if (reserva.duracao > 1) {
            const key2 = `${reserva.dia}_${reserva.hora + 1}`;
            updates[`sistemas/reservas/${quadra}/${key2}/status`] = 'finalizada';
        }

        // 2. Chama a nova fun√ß√£o para obter as atualiza√ß√µes de ranking
        const rankUpdates = processarTrocaDeRanking(reserva);
        // 3. Combina todas as atualiza√ß√µes em um √∫nico objeto
        updates = { ...updates, ...rankUpdates };

        await database.ref().update(updates);
        alert("Resultado confirmado com sucesso!");
        document.getElementById('modalConfirmacaoResultado').style.display = 'none';

    } catch (error) {
        alert("Erro ao confirmar o resultado. Tente novamente.");
        console.error("Erro em aprovarResultado:", error);
    }
}

/**
 * Altera o status da reserva para 'resultado_recusado' quando o perdedor recusa.
 */
// SUBSTITUA SUA FUN√á√ÉO 'recusarResultado' PELA VERS√ÉO ABAIXO
async function recusarResultado(reservaKey, quadra) {
    if (!confirm("Tem certeza que deseja recusar este resultado? A disputa dever√° ser resolvida com o √Årbitro.")) {
        return;
    }
    
    try {
        // Busca a vers√£o mais atual da reserva diretamente do banco
        const reservaRef = database.ref(`sistemas/reservas/${quadra}/${reservaKey}`);
        const snapshot = await reservaRef.once('value');
        const reserva = snapshot.val();

        if (!reserva) {
            alert("Erro: A reserva n√£o foi encontrada. Ela pode ter sido exclu√≠da por outro jogador.");
            document.getElementById('modalConfirmacaoResultado').style.display = 'none';
            return;
        }

        const updates = {};
        updates[`sistemas/reservas/${quadra}/${reservaKey}/status`] = 'resultado_recusado';
        if (reserva.duracao > 1) {
            const key2 = `${reserva.dia}_${reserva.hora + 1}`;
            updates[`sistemas/reservas/${quadra}/${key2}/status`] = 'resultado_recusado';
        }
    
        await database.ref().update(updates);
        alert("Resultado recusado. O status foi atualizado para que o √Årbitro possa resolver a disputa.");
        document.getElementById('modalConfirmacaoResultado').style.display = 'none';
    } catch (error) {
        alert("Erro ao recusar o resultado. Tente novamente.");
        console.error("Erro em recusarResultado:", error);
    }
}


// Esta fun√ß√£o verifica se um placar de set √© conclusivo.
function isSetConcluido(s1, s2) {
    return (
        (s1 === 6 && s2 <= 4) || (s2 === 6 && s1 <= 4) ||
        (s1 === 7 && s2 === 5) || (s2 === 7 && s1 === 5) ||
        (s1 === 7 && s2 === 6) || (s2 === 7 && s1 === 6)
    );
}


// Adicione esta nova fun√ß√£o ao seu script

/**
 * Gera o HTML do placar profissional com base nos dados da reserva.
 * @param {object} resultado - O objeto de resultado da reserva.
 * @param {string} jogador1Apelido - O apelido de um dos jogadores.
 * @param {string} jogador2Apelido - O apelido do outro jogador.
 * @returns {string} - O HTML completo do placar.
 */
// SUBSTITUA SUA FUN√á√ÉO 'gerarPlacarHtml' PELA VERS√ÉO FINAL ABAIXO

// VERS√ÉO FINAL E COMPLETA DA FUN√á√ÉO - SUBSTITUA A SUA ATUAL POR ESTA

function gerarPlacarHtml(resultado, jogador1Apelido, jogador2Apelido) {
    if (!resultado) return "";

    const jogador1Info = jogadoresData[jogador1Apelido] || { nomeCompleto: jogador1Apelido, piramide: '0' };
    const jogador2Info = jogadoresData[jogador2Apelido] || { nomeCompleto: jogador2Apelido, piramide: '0' };
    const vencedorDoResultado = resultado.vencedor;

    // ==========================================================
    // IN√çCIO DA CORRE√á√ÉO DEFINITIVA (L√ìGICA ROBUSTA DO VENCEDOR)
    // ==========================================================
    let p1_is_match_winner = false;
    let p2_is_match_winner = false;

    // Tentativa 1: Compara o apelido (padr√£o correto para novos resultados)
    if (jogador1Apelido.toUpperCase() === vencedorDoResultado.toUpperCase()) {
        p1_is_match_winner = true;
    } else if (jogador2Apelido.toUpperCase() === vencedorDoResultado.toUpperCase()) {
        p2_is_match_winner = true;
    }

    // Tentativa 2 (Fallback): Se a primeira falhou, compara o nome completo (para corrigir dados antigos)
    if (!p1_is_match_winner && !p2_is_match_winner) {
        if (jogador1Info && jogador1Info.nomeCompleto.toUpperCase() === vencedorDoResultado.toUpperCase()) {
            p1_is_match_winner = true;
        } else if (jogador2Info && jogador2Info.nomeCompleto.toUpperCase() === vencedorDoResultado.toUpperCase()) {
            p2_is_match_winner = true;
        }
    }
    // ==========================================================
    // FIM DA CORRE√á√ÉO DEFINITIVA
    // ==========================================================

    let posicaoHtmlP1 = '';
    if (jogador1Info && jogador1Info.piramide && jogador1Info.piramide !== "0") {
        const piramidePos = parseInt(jogador1Info.piramide, 10);
        const displayRank = piramidePos >= 61 ? piramidePos - 60 : piramidePos;
        posicaoHtmlP1 = `<span class="placar-posicao">${displayRank}</span>`;
    }

    let posicaoHtmlP2 = '';
    if (jogador2Info && jogador2Info.piramide && jogador2Info.piramide !== "0") {
        const piramidePos = parseInt(jogador2Info.piramide, 10);
        const displayRank = piramidePos >= 61 ? piramidePos - 60 : piramidePos;
        posicaoHtmlP2 = `<span class="placar-posicao">${displayRank}</span>`;
    }

    const scoresP1 = [];
    const scoresP2 = [];

    ['set1', 'set2', 'set3'].forEach(setKey => {
        const setData = resultado[setKey];
        if (setData && (setData.placar || typeof setData === 'string')) {
            const setPlacar = typeof setData === 'string' ? setData : setData.placar;
            if (setPlacar.includes('x')) {
                const [s1, s2] = setPlacar.split('x').map(Number);
                const p1_ganhou_set = s1 > s2;
                let tb1_html = '', tb2_html = '';
                if (typeof setData === 'object' && setData.tiebreak && setData.tiebreak.includes('-')) {
                    const [tb1, tb2] = setData.tiebreak.split('-');
                    tb1_html = `<sup>${tb1}</sup>`;
                    tb2_html = `<sup>${tb2}</sup>`;
                }
                scoresP1.push(`<span class="set-score ${p1_ganhou_set ? 'winner' : ''}">${s1}${tb1_html}</span>`);
                scoresP2.push(`<span class="set-score ${!p1_ganhou_set ? 'winner' : ''}">${s2}${tb2_html}</span>`);
            }
        }
    });

    const motivoHtml = resultado.motivo ? `<p class="motivo-resultado">Motivo: ${resultado.motivo}</p>` : '';

    // L√≥gica para W.O. (PRESERVADA)
    if (resultado.tipo === 'W.O.') {
        return `
            <div class="placar-container">
                <div class="placar-row">
                    ${posicaoHtmlP1}
                    <span class="placar-nome ${p1_is_match_winner ? 'match-winner' : ''}">${formatarNomeCompleto(jogador1Info.nomeCompleto)}</span>
                    <span class="placar-sets">${p1_is_match_winner ? '<span class="set-score winner">W.O.</span>' : ''}</span>
                </div>
                <div class="placar-row">
                    ${posicaoHtmlP2}
                    <span class="placar-nome ${p2_is_match_winner ? 'match-winner' : ''}">${formatarNomeCompleto(jogador2Info.nomeCompleto)}</span>
                    <span class="placar-sets">${p2_is_match_winner ? '<span class="set-score winner">W.O.</span>' : ''}</span>
                </div>
            </div>${motivoHtml}`;
    }

    // L√≥gica para Desist√™ncia (PRESERVADA)
    if (resultado.tipo === 'Desist√™ncia') {
        const p1_is_loser = jogador1Apelido === resultado.perdedor;
        const p2_is_loser = jogador2Apelido === resultado.perdedor;
        return `
            <div class="placar-container">
                <div class="placar-row">
                    ${posicaoHtmlP1}
                    <span class="placar-nome ${p1_is_match_winner ? 'match-winner' : ''}">${formatarNomeCompleto(jogador1Info.nomeCompleto)}</span>
                    ${p1_is_loser ? '<span class="ret-indicator">RET</span>' : ''}
                    <span class="placar-sets">${scoresP1.join('')}</span>
                </div>
                <div class="placar-row">
                    ${posicaoHtmlP2}
                    <span class="placar-nome ${p2_is_match_winner ? 'match-winner' : ''}">${formatarNomeCompleto(jogador2Info.nomeCompleto)}</span>
                    ${p2_is_loser ? '<span class="ret-indicator">RET</span>' : ''}
                    <span class="placar-sets">${scoresP2.join('')}</span>
                </div>
            </div>${motivoHtml}`;
    }

    // Retorno padr√£o para Jogo Normal (PRESERVADO)
    return `
      <div class="placar-container">
        <div class="placar-row">
          ${posicaoHtmlP1}
          <span class="placar-nome ${p1_is_match_winner ? 'match-winner' : ''}">${formatarNomeCompleto(jogador1Info.nomeCompleto)}</span>
          <span class="placar-sets">${scoresP1.join('')}</span>
        </div>
        <div class="placar-row">
          ${posicaoHtmlP2}
          <span class="placar-nome ${p2_is_match_winner ? 'match-winner' : ''}">${formatarNomeCompleto(jogador2Info.nomeCompleto)}</span>
          <span class="placar-sets">${scoresP2.join('')}</span>
        </div>
      </div>`;
}


// COLE ESTA FUN√á√ÉO QUE EST√Å FALTANDO NO SEU SCRIPT
function getDisplayRank(piramidePosStr) {
    if (!piramidePosStr || piramidePosStr === "0") {
        return null;
    }
    const piramidePos = parseInt(piramidePosStr, 10);
    if (isNaN(piramidePos)) {
        return null;
    }
    // Se a posi√ß√£o for 61 ou maior, subtrai 60 para obter o rank real da pir√¢mide feminina
    return piramidePos >= 61 ? piramidePos - 60 : piramidePos;
}

// Adicione esta nova fun√ß√£o ao seu script
/**
 * Processa a l√≥gica de troca de ranking de uma partida finalizada.
 * @param {object} reserva - O objeto da reserva contendo o resultado.
 * @returns {object} - Um objeto com as atualiza√ß√µes do banco de dados para os rankings, ou um objeto vazio se n√£o houver troca.
 */
function processarTrocaDeRanking(reserva) {
    const rankUpdates = {};
    if (!reserva || !reserva.resultado) return rankUpdates;

    const vencedorApelido = reserva.resultado.vencedor;
    const perdedorApelido = reserva.resultado.perdedor;

    const vencedorInfo = jogadoresData[vencedorApelido];
    const perdedorInfo = jogadoresData[perdedorApelido];

    // Garante que ambos os jogadores foram encontrados e possuem ranking
    if (vencedorInfo && perdedorInfo && vencedorInfo.piramide && perdedorInfo.piramide && vencedorInfo.piramide !== "0" && perdedorInfo.piramide !== "0") {
        const rankVencedor = parseInt(vencedorInfo.piramide, 10);
        const rankPerdedor = parseInt(perdedorInfo.piramide, 10);

        // A troca s√≥ acontece se o vencedor tiver um ranking inferior (n√∫mero MAIOR) ao do perdedor.
        if (rankVencedor > rankPerdedor) {
            console.log(`Troca de ranking ativada: ${vencedorApelido} (${rankVencedor}) venceu ${perdedorApelido} (${rankPerdedor}).`);

            rankUpdates[`sistemas/cadastro/jogadores/${vencedorInfo.nomeCompleto}/piramide`] = perdedorInfo.piramide;
            rankUpdates[`sistemas/cadastro/jogadores/${perdedorInfo.nomeCompleto}/piramide`] = vencedorInfo.piramide;
        }
    }
    return rankUpdates;
}


// Adicione estas duas novas fun√ß√µes ao seu script

/**
 * Fecha o modal de resolu√ß√£o do √°rbitro.
 */
function fecharModalArbitro() {
    document.getElementById('modalResolucaoArbitro').style.display = 'none';
}


// Adicione estas tr√™s novas fun√ß√µes ao seu script

/**
 * A√ß√£o do √°rbitro para APROVAR um resultado recusado.
 */
async function aprovarPeloArbitro(reservaKey, quadra) {
    if (!confirm("Tem certeza que deseja APROVAR este resultado? A partida ser√° finalizada e os jogadores notificados.")) return;

    try {
        const reservaRef = database.ref(`sistemas/reservas/${quadra}/${reservaKey}`);
        const snapshot = await reservaRef.once('value');
        const reserva = snapshot.val();

        if (!reserva) return alert("Erro: Reserva n√£o encontrada.");

        let updates = {};
        updates[`sistemas/reservas/${quadra}/${reservaKey}/status`] = 'finalizada';
        if (reserva.duracao > 1) {
            const key2 = `${reserva.dia}_${reserva.hora + 1}`;
            updates[`sistemas/reservas/${quadra}/${key2}/status`] = 'finalizada';
        }

        const rankUpdates = processarTrocaDeRanking(reserva);
        
        // --- ADICIONADO: Gera as notifica√ß√µes ---
        const decisao = isUsuarioAdmin() ? "aprovado pelo Administrador" : "aprovado pelo √Årbitro";
        const notificacaoUpdates = enviarNotificacaoResultadoFinalizado(reserva, decisao);
        
        // Combina todas as atualiza√ß√µes
        updates = { ...updates, ...rankUpdates, ...notificacaoUpdates };

        await database.ref().update(updates);
        alert("Resultado aprovado e finalizado com sucesso! Os jogadores ser√£o notificados.");
        fecharModalArbitro();
    } catch (error) {
        alert("Ocorreu um erro ao aprovar o resultado.");
        console.error("Erro em aprovarPeloArbitro:", error);
    }
}



/**
 * A√ß√£o do √°rbitro para ABRIR A EDI√á√ÉO de um resultado recusado.
 */
// SUBSTITUA SUA FUN√á√ÉO 'editarPeloArbitro' PELA VERS√ÉO ABAIXO
async function editarPeloArbitro(reservaKey, quadra) {
    const reservaRef = database.ref(`sistemas/reservas/${quadra}/${reservaKey}`);
    const snapshot = await reservaRef.once('value');
    const reserva = snapshot.val();

    if (!reserva) return alert("Erro: Reserva n√£o encontrada.");
    isArbitroEditing = true; // Avisa ao sistema que a edi√ß√£o come√ßou
    fecharModalArbitro();
    await abrirModalResultado(reserva, reservaKey, quadra, false); // Adicionado await
}



/**
 * A√ß√£o do √°rbitro para CANCELAR uma partida com resultado recusado.
 */
async function cancelarPeloArbitro(reservaKey, quadra) {
    if (!confirm("Tem certeza que deseja CANCELAR esta partida? O resultado ser√° mantido no hist√≥rico, a partida ser√° invalidada e os jogadores notificados.")) return;

    try {
        const reservaRef = database.ref(`sistemas/reservas/${quadra}/${reservaKey}`);
        const snapshot = await reservaRef.once('value');
        const reserva = snapshot.val();

        if (!reserva) return alert("Erro: Reserva n√£o encontrada.");

        const updates = {};
        updates[`sistemas/reservas/${quadra}/${reservaKey}/status`] = 'Cancelada';
        if (reserva.duracao > 1) {
            const key2 = `${reserva.dia}_${reserva.hora + 1}`;
            updates[`sistemas/reservas/${quadra}/${key2}/status`] = 'Cancelada';
        }

        // --- ADICIONADO: Gera as notifica√ß√µes ---
        const decisao = isUsuarioAdmin() ? "cancelado pelo Administrador" : "cancelado pelo √Årbitro";
        const notificacaoUpdates = enviarNotificacaoResultadoFinalizado(reserva, decisao);
        
        // Combina as atualiza√ß√µes
        Object.assign(updates, notificacaoUpdates);

        await database.ref().update(updates);
        alert("Partida cancelada com sucesso! Os jogadores ser√£o notificados.");
        fecharModalArbitro();
    } catch (error) {
        alert("Ocorreu um erro ao cancelar a partida.");
        console.error("Erro em cancelarPeloArbitro:", error);
    }
}


// SUBSTITUA SUA FUN√á√ÉO 'verificarDisputasArbitro' PELA VERS√ÉO ABAIXO
function verificarDisputasArbitro(todasAsReservas) {
    if (isArbitroEditing) return; // Se o √°rbitro est√° editando, n√£o faz nada.
    const jogadorLogadoCompleto = localStorage.getItem('jogadorLogado');
    
    if (!jogadorLogadoCompleto || !arbitro.nomeCompleto || jogadorLogadoCompleto.toUpperCase() !== arbitro.nomeCompleto.toUpperCase()) {
        return;
    }

    const modal = document.getElementById('modalResolucaoArbitro');
    
    for (const quadra in todasAsReservas) {
        const reservasDaQuadra = todasAsReservas[quadra];
        for (const key in reservasDaQuadra) {
            const reserva = reservasDaQuadra[key];

            if (reserva.status === 'resultado_recusado' && reserva.resultado) {
                
                const resumoPartida = document.getElementById('resumo-partida-arbitro');
                const placarRecusado = document.getElementById('placar-recusado-arbitro');
                
                resumoPartida.innerHTML = `
                    <strong>Quadra:</strong> ${quadra}<br>
                    <strong>Data:</strong> ${document.querySelector(`#tabelaQuadra tr:nth-child(2) td:nth-child(${reserva.dia})`).textContent}<br>
                    <strong>Vencedor Informado:</strong> ${reserva.resultado.vencedor}<br>
                    <strong>Recusado por:</strong> ${reserva.resultado.perdedor}
                `;

                // --- IN√çCIO DA CORRE√á√ÉO ---
                // L√≥gica para reconstruir a ordem original dos jogadores da partida.
                let jogador1Original, jogador2Original;
                if (reserva.jogadores_completo) {
                    const jogadoresDaPartida = reserva.jogadores_completo.split(',').map(j => j.trim());
                    jogador1Original = jogadoresDaPartida[0];
                    jogador2Original = jogadoresDaPartida[1];
                } else {
                    // Fallback para reservas antigas sem o campo 'jogadores_completo'.
                    jogador1Original = reserva.jogadores.split(',').map(j => j.trim())[0];
                    const keySegundaHora = `${reserva.dia}_${reserva.hora + 1}`;
                    const reservaSegundaParte = reservasDaQuadra[keySegundaHora];
                     if (reservaSegundaParte && reservaSegundaParte.jogadores) {
                        jogador2Original = reservaSegundaParte.jogadores.split(',').map(j => j.trim())[0];
                    } else {
                        console.error("N√£o foi poss√≠vel reconstruir a lista de jogadores para a tela do √°rbitro.", reserva);
                        continue; 
                    }
                }
                
                // Chamada CORRIGIDA: Usa a ordem original dos jogadores para renderizar o placar.
                placarRecusado.innerHTML = gerarPlacarHtml(reserva.resultado, jogador1Original, jogador2Original);
                // --- FIM DA CORRE√á√ÉO ---

                document.getElementById('btnAprovarPeloArbitro').onclick = () => aprovarPeloArbitro(key, quadra);
                document.getElementById('btnEditarPeloArbitro').onclick = () => editarPeloArbitro(key, quadra);
                document.getElementById('btnCancelarPeloArbitro').onclick = () => cancelarPeloArbitro(key, quadra);
                document.getElementById('btnFecharArbitro').onclick = fecharModalArbitro;
                
                modal.style.display = 'flex';
                return;
            }
        }
    }
}


/**
 * Verifica se o jogador atualmente logado est√° na lista de administradores.
 * @returns {boolean} - Retorna true se for admin, false caso contr√°rio.
 */
function isUsuarioAdmin() {
    const jogadorLogado = localStorage.getItem('jogadorLogado');
    if (!jogadorLogado) {
        return false;
    }
    // Compara o nome do jogador logado com a lista de admins (ambos em mai√∫sculas).
    return administradores.some(admin => admin.toUpperCase() === jogadorLogado.toUpperCase());
}


/**
 * Verifica se h√° notifica√ß√µes para o jogador logado, exibe-as e depois as apaga.
 */
async function verificarNotificacoes() {
    const jogadorLogado = localStorage.getItem('jogadorLogado');
    if (!jogadorLogado) return;

    const notificacoesRef = database.ref(`sistemas/cadastro/jogadores/${jogadorLogado}/notificacoes`);
    
    try {
        const snapshot = await notificacoesRef.once('value');
        const notificacoes = snapshot.val();

        if (notificacoes) {
            let mensagens = Object.values(notificacoes);
            
            // --- ALTERA√á√ïES AQUI ---
            // 1. Troca o √≠cone para 'informa√ß√£o'.
            // 2. Adiciona uma quebra de linha extra antes do primeiro item para melhor espa√ßamento.
            alert("‚ÑπÔ∏è Voc√™ tem as seguintes notifica√ß√µes do sistema:\n\n- " + mensagens.join('\n\n- '));
            
            await notificacoesRef.remove();
        }
    } catch (error) {
        console.error("Erro ao verificar notifica√ß√µes:", error);
    }
}



/**
 * Abre o modal de resultado de duplas.
 * Futuramente, esta fun√ß√£o tamb√©m ir√° gerar os confrontos.
 */
function abrirModalResultadoDuplas(reserva, key, quadra, modoVisualizacao = false) {
    const container = document.getElementById('duplasMatchupsContainer');
    const jogadoresInfo = document.getElementById('duplasJogadoresInfo');
    const modal = document.getElementById('modalResultadoDuplas');
    container.innerHTML = '';

    let jogadores = [];
    if (reserva.jogadores_completo) {
        jogadores = reserva.jogadores_completo.split(',').map(j => j.trim());
    } else {
        const jogadoresParte1 = reserva.jogadores.split(',').map(j => j.trim());
        jogadores.push(...jogadoresParte1);
        if (reserva.duracao > 1) {
            const keySegundaParte = `${reserva.dia}_${reserva.hora + 1}`;
            const reservasDaQuadra = reservasPorQuadra[quadra] || {};
            const reservaSegundaParte = reservasDaQuadra[keySegundaParte];
            if (reservaSegundaParte && reservaSegundaParte.jogadores) {
                const jogadoresParte2 = reservaSegundaParte.jogadores.split(',').map(j => j.trim());
                jogadores.push(...jogadoresParte2);
            }
        }
    }
    jogadores = [...new Set(jogadores)];

    if (jogadores.length !== 4) {
        alert("Erro: Esta fun√ß√£o s√≥ √© v√°lida para reservas com 4 s√≥cios.");
        return;
    }

    jogadoresInfo.innerHTML = `<strong>Jogadores:</strong> ${jogadores.map(j => capitalizarNome(j)).join(', ')}`;

    const confrontos = [
        { timeA: [jogadores[0], jogadores[1]], timeB: [jogadores[2], jogadores[3]] },
        { timeA: [jogadores[0], jogadores[2]], timeB: [jogadores[1], jogadores[3]] },
        { timeA: [jogadores[0], jogadores[3]], timeB: [jogadores[1], jogadores[2]] }
    ];

    confrontos.forEach((confronto, index) => {
        const timeANomes = `${capitalizarNome(confronto.timeA[0])}<br>${capitalizarNome(confronto.timeA[1])}`;
        const timeBNomes = `${capitalizarNome(confronto.timeB[0])}<br>${capitalizarNome(confronto.timeB[1])}`;
        const jogoNum = index + 1;

        // --- IN√çCIO DA ATUALIZA√á√ÉO ---
        // L√≥gica para determinar o estilo dos nomes (negrito para o vencedor)
        let estiloTimeA = "font-weight: normal;";
        let estiloTimeB = "font-weight: normal;";

        if (modoVisualizacao && reserva.resultadoDuplas && reserva.resultadoDuplas.confrontos[index]) {
            const jogo = reserva.resultadoDuplas.confrontos[index];
            const [placarA, placarB] = jogo.placar.split('x').map(Number);
            if (placarA > placarB) {
                estiloTimeA = "font-weight: bold;";
            } else if (placarB > placarA) {
                estiloTimeB = "font-weight: bold;";
            }
        }
        // --- FIM DA ATUALIZA√á√ÉO ---

        const matchupHtml = `
            <div class="duplas-match-container">
                <div class="matchup-row">
                    <span class="team-names" style="${estiloTimeA}">${timeANomes}</span>
                    <div class="score-column">
                        <div class="score-input-container">
                            <input type="number" id="jogo${jogoNum}-placarA" class="score-input" min="0" oninput="controlarTieBreakDuplas(${jogoNum})">
                            <span>&times;</span>
                            <input type="number" id="jogo${jogoNum}-placarB" class="score-input" min="0" oninput="controlarTieBreakDuplas(${jogoNum})">
                        </div>
                        <div id="duplas-tiebreak${jogoNum}-container" class="tiebreak-container" style="display: none; justify-content: center; gap: 5px; margin-top: 5px;">
                            <span class="tiebreak-paren">(</span><input type="number" id="duplas-tb${jogoNum}-A" style="width: 40px; text-align: center;" min="0"><span>-</span><input type="number" id="duplas-tb${jogoNum}-B" style="width: 40px; text-align: center;" min="0"><span class="tiebreak-paren">)</span>
                        </div>
                    </div>
                    <span class="team-names" style="${estiloTimeB}">${timeBNomes}</span>
                </div>
            </div>
        `;
        container.innerHTML += matchupHtml;
    });

    if (modoVisualizacao && reserva.resultadoDuplas) {
        reserva.resultadoDuplas.confrontos.forEach((jogo, index) => {
            const jogoNum = index + 1;
            const [placarA, placarB] = jogo.placar.split('x');
            document.getElementById(`jogo${jogoNum}-placarA`).value = placarA;
            document.getElementById(`jogo${jogoNum}-placarB`).value = placarB;
            document.getElementById(`jogo${jogoNum}-placarA`).disabled = true;
            document.getElementById(`jogo${jogoNum}-placarB`).disabled = true;

            if (jogo.tiebreak && jogo.tiebreak.includes('-')) {
                const [tbA, tbB] = jogo.tiebreak.split('-');
                document.getElementById(`duplas-tb${jogoNum}-A`).value = tbA;
                document.getElementById(`duplas-tb${jogoNum}-B`).value = tbB;
                document.getElementById(`duplas-tb${jogoNum}-A`).disabled = true;
                document.getElementById(`duplas-tb${jogoNum}-B`).disabled = true;
                controlarTieBreakDuplas(jogoNum);
            }
        });
        document.getElementById('btnSalvarDuplas').style.display = 'none';
        document.getElementById('btnCancelarDuplas').style.display = 'none';
        document.getElementById('btnDepoisDuplas').textContent = 'Fechar';
    } else {
        document.getElementById('btnSalvarDuplas').style.display = 'inline-block';
        document.getElementById('btnCancelarDuplas').style.display = 'inline-block';
        document.getElementById('btnDepoisDuplas').textContent = 'Depois';
        document.getElementById('btnSalvarDuplas').onclick = () => salvarResultadoDuplas(reserva, key, quadra);
    }
    
    modal.style.display = 'flex';
}



/**
 * Fecha o modal de resultado de duplas.
 */
function fecharModalResultadoDuplas() {
    document.getElementById('modalResultadoDuplas').style.display = 'none';
}


/**
 * Valida o placar de um √∫nico set, incluindo as regras de tie-break.
 * @param {number} score1 - Placar do jogador/time 1.
 * @param {number} score2 - Placar do jogador/time 2.
 * @param {number} tb1 - Placar do tie-break do jogador/time 1.
 * @param {number} tb2 - Placar do tie-break do jogador/time 2.
 * @returns {string|null} - Retorna 'j1' se o jogador 1 venceu, 'j2' se o jogador 2 venceu, ou null se o placar for inv√°lido.
 */
function determinarVencedorSet(score1, score2, tb1, tb2) {
    if (isNaN(score1) || isNaN(score2)) return null;

    // Regra de vit√≥ria padr√£o (ex: 6-4, 6-3, etc.)
    if ((score1 === 6 && score2 <= 4) || (score2 === 6 && score1 <= 4)) {
        return score1 > score2 ? 'j1' : 'j2';
    }
    // Regra de vit√≥ria por 7-5
    if ((score1 === 7 && score2 === 5) || (score2 === 7 && score1 === 5)) {
        return score1 > score2 ? 'j1' : 'j2';
    }

    // L√≥gica de TIE-BREAK (Placar de games 7-6 ou 6-7)
    if ((score1 === 7 && score2 === 6) || (score1 === 6 && score2 === 7)) {
        if (isNaN(tb1) || isNaN(tb2)) return null;

        const vencedorTB = Math.max(tb1, tb2);
        const perdedorTB = Math.min(tb1, tb2);
        let tiebreakValido = false;

        // CASO 1: Vit√≥ria Padr√£o no Tie-break (vencedor faz 7)
        if (vencedorTB === 7 && perdedorTB <= 5) {
            tiebreakValido = true;
        }
        // CASO 2: Vit√≥ria na "Prorroga√ß√£o" (vencedor faz mais de 7)
        else if (vencedorTB > 7 && (vencedorTB - perdedorTB === 2)) {
            tiebreakValido = true;
        }

        // Se o placar do tie-break for v√°lido, verifica a consist√™ncia
        if (tiebreakValido) {
            const setWinnerIsJ1 = score1 > score2;
            const tiebreakWinnerIsJ1 = tb1 > tb2;
            // O vencedor do game e do tie-break devem ser a mesma pessoa
            if (setWinnerIsJ1 === tiebreakWinnerIsJ1) {
                return score1 === 7 ? 'j1' : 'j2';
            }
        }
    }

    // Se nenhuma regra for atendida, o placar do set √© inv√°lido
    return null;
}


/**
 * Mostra ou esconde os campos de tie-break para um jogo de duplas
 * com base no placar inserido.
 * @param {number} jogoNum - O n√∫mero do jogo (1, 2 ou 3).
 */
function controlarTieBreakDuplas(jogoNum) {
    const placarA_input = document.getElementById(`jogo${jogoNum}-placarA`);
    const placarB_input = document.getElementById(`jogo${jogoNum}-placarB`);
    const tiebreakContainer = document.getElementById(`duplas-tiebreak${jogoNum}-container`);

    if (!placarA_input || !placarB_input || !tiebreakContainer) return;

    const placarA = parseInt(placarA_input.value, 10);
    const placarB = parseInt(placarB_input.value, 10);

    // L√≥gica correta, igual √† da Pir√¢mide: Mostra o tie-break apenas se o placar for 7x6 ou 6x7
    if ((placarA === 6 && placarB === 7) || (placarA === 7 && placarB === 6)) {
        tiebreakContainer.style.display = 'inline-flex';
    } else {
        tiebreakContainer.style.display = 'none';
    }
}




// SUBSTITUA A SUA FUN√á√ÉO PELA VERS√ÉO COMPLETA ABAIXO
/**
 * Valida, salva o resultado de uma partida de duplas e atualiza o ranking.
 */
// SUBSTITUA A SUA FUN√á√ÉO INTEIRA PELA VERS√ÉO ABAIXO
// SUBSTITUA SUA FUN√á√ÉO ATUAL POR ESTA VERS√ÉO ATUALIZADA
// SUBSTITUA PELA VERS√ÉO FINAL E CORRIGIDA
// SUBSTITUA SUA FUN√á√ÉO ATUAL PELA VERS√ÉO FINAL E CORRIGIDA
async function salvarResultadoDuplas(reserva, key, quadra) {
    const vitorias = {};
    const confrontosInfo = [];

    // --- IN√çCIO DA CORRE√á√ÉO ---
    // L√≥gica robusta para obter a lista completa de jogadores, independentemente de como a reserva foi criada.
    let jogadoresApelidos = [];
    if (reserva.jogadores_completo) {
        jogadoresApelidos = reserva.jogadores_completo.split(',').map(j => j.trim());
    } else {
        const jogadoresParte1 = reserva.jogadores.split(',').map(j => j.trim());
        jogadoresApelidos.push(...jogadoresParte1);
        if (reserva.duracao > 1) {
            const keySegundaParte = `${reserva.dia}_${reserva.hora + 1}`;
            const reservasDaQuadra = reservasPorQuadra[quadra] || {};
            const reservaSegundaParte = reservasDaQuadra[keySegundaParte];
            if (reservaSegundaParte && reservaSegundaParte.jogadores) {
                const jogadoresParte2 = reservaSegundaParte.jogadores.split(',').map(j => j.trim());
                jogadoresApelidos.push(...jogadoresParte2);
            }
        }
    }
    jogadoresApelidos = [...new Set(jogadoresApelidos)];
    // --- FIM DA CORRE√á√ÉO ---
    
    // O resto da sua l√≥gica original para validar os placares e contar as vit√≥rias.
    jogadoresApelidos.forEach(jogador => vitorias[jogador] = 0);

    const confrontosMap = [
        { timeA: [jogadoresApelidos[0], jogadoresApelidos[1]], timeB: [jogadoresApelidos[2], jogadoresApelidos[3]] },
        { timeA: [jogadoresApelidos[0], jogadoresApelidos[2]], timeB: [jogadoresApelidos[1], jogadoresApelidos[3]] },
        { timeA: [jogadoresApelidos[0], jogadoresApelidos[3]], timeB: [jogadoresApelidos[1], jogadoresApelidos[2]] }
    ];

    for (let i = 0; i < 3; i++) {
        const jogoNum = i + 1;
        const placarA = parseInt(document.getElementById(`jogo${jogoNum}-placarA`).value, 10);
        const placarB = parseInt(document.getElementById(`jogo${jogoNum}-placarB`).value, 10);
        const tbA = parseInt(document.getElementById(`duplas-tb${jogoNum}-A`).value, 10);
        const tbB = parseInt(document.getElementById(`duplas-tb${jogoNum}-B`).value, 10);
        if (isNaN(placarA) || isNaN(placarB)) {
            return alert(`Por favor, preencha o placar para o Jogo ${jogoNum}.`);
        }
        const vencedorDoSet = determinarVencedorSet(placarA, placarB, tbA, tbB);
        if (vencedorDoSet === null) {
            return alert(`O placar do Jogo ${jogoNum} (${placarA} x ${placarB}) √© inv√°lido.`);
        }
        const duplaVencedora = (vencedorDoSet === 'j1') ? confrontosMap[i].timeA : confrontosMap[i].timeB;
        duplaVencedora.forEach(jogador => vitorias[jogador]++);
        confrontosInfo.push({
            dupla1: confrontosMap[i].timeA.join(' / '),
            dupla2: confrontosMap[i].timeB.join(' / '),
            placar: `${placarA}x${placarB}`,
            tiebreak: (!isNaN(tbA) && !isNaN(tbB)) ? `${tbA}-${tbB}` : ""
        });
    }

    const jogadorLogadoApelido = Object.keys(jogadoresData).find(
        apelido => jogadoresData[apelido].nomeCompleto === localStorage.getItem('jogadorLogado')
    ) || localStorage.getItem('jogadorLogado');

    const resultadoDuplasObj = {
        dataInformado: new Date().toISOString(),
        informadoPor: jogadorLogadoApelido,
        confrontos: confrontosInfo
    };

    const updates = {};
    updates[`sistemas/reservas/${quadra}/${key}/status`] = 'finalizada';
    updates[`sistemas/reservas/${quadra}/${key}/resultadoDuplas`] = resultadoDuplasObj;
    const key2 = `${reserva.dia}_${reserva.hora + 1}`;
    updates[`sistemas/reservas/${quadra}/${key2}/status`] = 'finalizada';
    updates[`sistemas/reservas/${quadra}/${key2}/resultadoDuplas`] = resultadoDuplasObj;

    const nomesCompletos = jogadoresApelidos.map(apelido => {
        if (jogadoresData[apelido]) {
            return jogadoresData[apelido].nomeCompleto;
        }
        return undefined;
    });

    if (nomesCompletos.some(nome => !nome)) {
        alert("Erro: O nome completo de um dos jogadores n√£o foi encontrado. O ranking n√£o pode ser atualizado.");
        try {
            await database.ref().update({
                [`sistemas/reservas/${quadra}/${key}/status`]: 'finalizada',
                [`sistemas/reservas/${quadra}/${key}/resultadoDuplas`]: resultadoDuplasObj,
                [`sistemas/reservas/${quadra}/${key2}/status`]: 'finalizada',
                [`sistemas/reservas/${quadra}/${key2}/resultadoDuplas`]: resultadoDuplasObj
            });
            alert("Resultado da partida salvo, mas houve um erro ao encontrar os jogadores para atualizar o ranking.");
            fecharModalResultadoDuplas();
        } catch (error) {
            console.error("Erro ao salvar o resultado das duplas (sem ranking):", error);
            alert("Ocorreu um erro ao salvar o resultado.");
        }
        return;
    }

    const promessasDeLeitura = nomesCompletos.map(nome =>
        database.ref(`sistemas/cadastro/jogadores/${nome}`).once('value')
    );
    const snapshots = await Promise.all(promessasDeLeitura);

    snapshots.forEach((snapshot, index) => {
        const nomeCompleto = nomesCompletos[index];
        const dadosAtuais = snapshot.val() || {};
        const jogosAtuais = dadosAtuais.jogosDeDuplasJogados || 0;
        const vitoriasAtuais = dadosAtuais.vitoriasEmDuplas || 0;
        const vitoriasNestaPartida = vitorias[jogadoresApelidos[index]] || 0;
        updates[`sistemas/cadastro/jogadores/${nomeCompleto}/jogosDeDuplasJogados`] = jogosAtuais + 3;
        updates[`sistemas/cadastro/jogadores/${nomeCompleto}/vitoriasEmDuplas`] = vitoriasAtuais + vitoriasNestaPartida;
    });

    try {
        await database.ref().update(updates);
        alert("Resultado salvo e ranking atualizado com sucesso!");
        fecharModalResultadoDuplas();
    } catch (error) {
        console.error("Erro ao salvar o resultado e ranking das duplas:", error);
        alert("Ocorreu um erro ao salvar o resultado.");
    }
}


/**
 * Gera o HTML para exibir o resultado de uma partida de duplas (3 jogos).
 * @param {object} resultadoDuplas - O objeto de resultado salvo na reserva.
 * @returns {string} - O HTML formatado para ser exibido no modal.
 */
function gerarPlacarDuplasHtml(resultadoDuplas) {
    if (!resultadoDuplas || !resultadoDuplas.confrontos) return "";

    // Container principal que usa as classes de estilo j√° existentes
    let html = '<div class="placar-container">';

    resultadoDuplas.confrontos.forEach(jogo => {
        const [placarA, placarB] = jogo.placar.split('x').map(Number);
        const timeAVenceu = placarA > placarB;

        // Formata os nomes das duplas com quebra de linha
        const dupla1Nomes = jogo.dupla1.replace(' / ', '<br>');
        const dupla2Nomes = jogo.dupla2.replace(' / ', '<br>');

        let placarHtml;
        
        // NOVO: L√≥gica para o placar de tie-break, igual √† da pir√¢mide
        if (jogo.tiebreak) {
            const [tbA, tbB] = jogo.tiebreak.split('-');
            // Gera o placar com os n√∫meros do tie-break em superscript (<sup>)
            placarHtml = `
                <span class="set-score ${timeAVenceu ? 'winner' : ''}">${placarA}<sup>${tbA}</sup></span>
                <span>&times;</span>
                <span class="set-score ${!timeAVenceu ? 'winner' : ''}">${placarB}<sup>${tbB}</sup></span>
            `;
        } else {
            // Gera o placar normal, sem tie-break
            placarHtml = `
                <span class="set-score ${timeAVenceu ? 'winner' : ''}">${placarA}</span>
                <span>&times;</span>
                <span class="set-score ${!timeAVenceu ? 'winner' : ''}">${placarB}</span>
            `;
        }

        // ALTERADO: A estrutura do HTML foi modificada para atender ao novo layout
        html += `
            <div class="matchup-row" style="padding: 1px 0; font-size: 0.95em; align-items: center;">
                <span class="team-names" style="font-weight: ${timeAVenceu ? 'bold' : 'normal'}; text-align: center; flex-basis: 40%;">${dupla1Nomes}</span>
                <div class="score-input-container" style="flex-basis: 20%; display: flex; justify-content: center; gap: 5px; font-weight: bold; font-size: 1.1em;">
                    ${placarHtml}
                </div>
                <span class="team-names" style="font-weight: ${!timeAVenceu ? 'bold' : 'normal'}; text-align: center; flex-basis: 40%;">${dupla2Nomes}</span>
            </div>
        `;
    });

    html += '</div>';
    
    // Adiciona o rodap√© com informa√ß√µes de quem e quando o resultado foi inserido
    const dataInformado = new Date(resultadoDuplas.dataInformado).toLocaleString('pt-BR');
    html += `<p style="text-align: center; font-size: 0.8em; color: #888; margin-top: 15px;">Resultado informado por ${resultadoDuplas.informadoPor} em ${dataInformado}.</p>`;

    return html;
}



/**
 * Verifica se o jogador atualmente logado √© o √°rbitro do torneio.
 * @returns {boolean} - Retorna true se for o √°rbitro, false caso contr√°rio.
 */
function isUsuarioArbitro() {
    const jogadorLogado = localStorage.getItem('jogadorLogado');
    if (!jogadorLogado || !arbitro || !arbitro.nomeCompleto) {
        return false;
    }
    // Compara o nome do jogador logado com o nome do √°rbitro (ambos em mai√∫sculas).
    return jogadorLogado.toUpperCase() === arbitro.nomeCompleto.toUpperCase();
}



/**
 * Gera as atualiza√ß√µes do banco de dados para notificar os jogadores sobre uma decis√£o final.
 * @param {object} reserva - O objeto da reserva com os dados do resultado.
 * @param {string} decisao - O texto que descreve a decis√£o (ex: "aprovado pelo √Årbitro").
 * @returns {object} - Um objeto com as chaves de atualiza√ß√£o do Firebase para as notifica√ß√µes.
 */
function enviarNotificacaoResultadoFinalizado(reserva, decisao) {
    const notificacaoUpdates = {};
    if (!reserva || !reserva.resultado) return notificacaoUpdates;

    const { vencedor, perdedor } = reserva.resultado;
    const vencedorInfo = jogadoresData[vencedor];
    const perdedorInfo = jogadoresData[perdedor];

    if (vencedorInfo && perdedorInfo) {
        const dataReserva = document.querySelector(`#tabelaQuadra tr:nth-child(2) td:nth-child(${reserva.dia})`).textContent;
        let mensagemBase = '';
        let detalhesAdicionais = '';

        // --- IN√çCIO DA CORRE√á√ÉO ---
        // L√≥gica aprimorada para criar mensagens mais espec√≠ficas e detalhadas
        if (decisao.includes("cancelad")) {
            const placarDisputado = formatarPlacarParaMensagem(reserva.resultado).replace('Placar Final: ', '');
            
            mensagemBase = `A disputa sobre o resultado do seu jogo da Pir√¢mide contra NOME_OPONENTE (${dataReserva}) foi ${decisao}.`;
            detalhesAdicionais = `\nO placar informado de ${placarDisputado} foi invalidado e a partida n√£o afetar√° o ranking.`;
        } else {
            const placarFormatado = formatarPlacarParaMensagem(reserva.resultado);
            
            mensagemBase = `O resultado do seu jogo da Pir√¢mide contra NOME_OPONENTE (${dataReserva}) foi ${decisao}.`;
            detalhesAdicionais = `\n${placarFormatado}\nVencedor(a): ${vencedor}.`;
        }
        // --- FIM DA CORRE√á√ÉO ---

        // Mensagem para o vencedor
        const msgParaVencedor = mensagemBase.replace('NOME_OPONENTE', perdedor) + detalhesAdicionais;
        const notificacaoKeyVencedor = database.ref().push().key;
        notificacaoUpdates[`sistemas/cadastro/jogadores/${vencedorInfo.nomeCompleto}/notificacoes/${notificacaoKeyVencedor}`] = msgParaVencedor;
        
        // Mensagem para o perdedor
        const msgParaPerdedor = mensagemBase.replace('NOME_OPONENTE', vencedor) + detalhesAdicionais;
        const notificacaoKeyPerdedor = database.ref().push().key;
        notificacaoUpdates[`sistemas/cadastro/jogadores/${perdedorInfo.nomeCompleto}/notificacoes/${notificacaoKeyPerdedor}`] = msgParaPerdedor;
    }
    
    return notificacaoUpdates;
}




/**
 * Formata o objeto de resultado em uma string de placar leg√≠vel.
 * @param {object} resultado - O objeto de resultado da partida.
 * @returns {string} - O placar formatado (ex: "Placar final: 6x4, 7x6(7-5).").
 */
function formatarPlacarParaMensagem(resultado) {
    if (!resultado) return "";
    let placarString = "Placar final: ";
    const sets = [];
    if (resultado.set1 && resultado.set1.placar) {
        let setStr = resultado.set1.placar;
        if (resultado.set1.tiebreak) setStr += `(${resultado.set1.tiebreak})`;
        sets.push(setStr);
    }
    if (resultado.set2 && resultado.set2.placar) {
        let setStr = resultado.set2.placar;
        if (resultado.set2.tiebreak) setStr += `(${resultado.set2.tiebreak})`;
        sets.push(setStr);
    }
    if (resultado.set3) {
        sets.push(resultado.set3);
    }
    placarString += sets.join(', ');
    return placarString;
}

</script>

<div id="versao-desatualizada-overlay">
    <div class="mensagem-overlay">
        <h1></h1> <p></p>   </div>
</div>

</body>
</html>
