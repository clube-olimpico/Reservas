<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=430, user-scalable=no">

    
    <title>Configurações do Sistema</title> 

    <link rel="manifest" href="manifest-config.json">
    
    <meta name="theme-color" content="#4CAF50">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Configurações">

    <link rel="apple-touch-icon" href="logo-config-1.png">
    <link rel="icon" href="logo-config-1.png" type="image/png">

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
	
	<link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

<style>

/* --- TRUQUE: ESCONDE A OPÇÃO SELECIONADA DA LISTA --- */ 
#perfilSelect option:checked {
    display: none;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
    background-color: #f8f9fa;
    color: #212529;
    padding: 10px;
    display: flex;
    font-size: 18px;
    justify-content: center;
    align-items: flex-start; 
    
    /* --- MUDANÇAS PARA FIXAR A TELA --- */
    height: 100vh;       /* Força a altura exata da tela (antes era min-height) */
    margin: 0;
    overflow: hidden;    /* Remove completamente a rolagem */
    /* ---------------------------------- */
    
    box-sizing: border-box;  
}

.container {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    gap: 10px; 
}

/* --- CSS PARA O NOVO GERENCIADOR DE HORÁRIOS --- */

.tabela-config-horarios {
    width: 100%; border-collapse: collapse; margin-top: 10px;
}
.tabela-config-horarios th, .tabela-config-horarios td {
    padding: 10px 8px; text-align: center; border-bottom: 1px solid #eee;
}
.tabela-config-horarios th {
    background-color: #f8f9fa; font-size: 0.95em; color: #555;
}
.tabela-config-horarios input[type="time"] {
    width: 85px; padding: 5px; text-align: center; border: 1px solid #ccc; border-radius: 4px;
}
.tabela-config-horarios td:first-child { text-align: left; font-weight: 500; }

/* --- ESTILO PARA HORÁRIO PADRÃO FECHADO --- */
.tabela-config-horarios tr.fechado-padrao td {
    background-color: #ffebee !important; /* Vermelho claro */
    color: #a94442; /* Texto levemente avermelhado */
}

/* Deixa os inputs com aparência de desabilitados */
.tabela-config-horarios tr.fechado-padrao input,
.tabela-config-horarios tr.fechado-padrao select {
    background-color: transparent !important;
}

.tabela-horarios-scroll, .lista-dias-scroll {
    max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; background: #fff;
}
.lista-dias-scroll { padding: 0; background-color: #fafafa; }

/* Linha de Dia Especial */
.linha-dia-especial {
    display: flex; align-items: center; gap: 10px; padding: 8px 10px; border-bottom: 1px solid #eee; background: #fff;
}
.linha-dia-especial:hover { background-color: #f0f8ff; }
.linha-dia-especial .dia-label { flex: 1; font-size: 0.95em; font-weight: 500; color: #333; }
.linha-dia-especial select { width: 100px !important; min-width: 100px; padding: 5px; }
.linha-dia-especial input[type="time"] { width: 80px; padding: 5px; }

.linha-dia-especial.fechado { background-color: #ffebee; }
.linha-dia-especial.fechado input[type="time"] { opacity: 0.5; pointer-events: none; background-color: #eee; }

@media (max-width: 600px) {
    .linha-dia-especial { flex-wrap: wrap; padding: 10px; }
    .linha-dia-especial span.dia-label { width: 100%; margin-bottom: 5px; font-weight: bold; border-bottom: 1px dashed #eee; }
    .linha-dia-especial input[type="time"], .linha-dia-especial select { flex: 1; }
}
/* --- FIM ESTILOS HORÁRIOS --- */



#sistema { font-weight: bold; }




.quadra-container { margin-bottom: 5px; gap: 10px; }

/* Formulário Principal */
.form-container {
    box-sizing: border-box; /* Adicionado para travar a largura */
    padding: 20px; background: #ffffff; border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); width: 400px; text-align: center; margin: 10px auto;
}

.title-container { display: flex; flex-direction: column; align-items: center; text-align: center; margin-bottom: 5px; }
.title-container span { font-family: 'Arial', sans-serif; font-size: 1.3em; font-weight: bold; line-height: 1.0em; letter-spacing: 3px; text-align: center; }

label { font-weight: bold; width: 190px; white-space: nowrap; text-align: left; display: inline-block; }
select { flex: 1; padding: 5px; box-sizing: border-box; width: auto; min-width: 80px; }

button {
    margin-top: auto; margin-bottom: 20px; padding: 10px; font-size: 17px; background-color: #4CAF50; color: white; border: none; cursor: pointer; width: 250px; max-width: 90%; align-self: center; display: block;
}
button:hover { background-color: #45a049; }

#sistema.on { color: white; background-color: green; }
#sistema.off { color: white; background-color: red; }

#loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem; text-align: center; z-index: 1000; }
#content { display: none; }
.hr-line { border: 0; height: 6px; background: linear-gradient(to bottom, #cccccc, #dddddd, #eeeeee, #ffffff); width: 90%; max-width: 99%; margin: 10px auto; }



/* Abas */
.outros-container { margin-top: 20px; }
.outros-container { width: 100%; max-width: 100%; overflow-x: hidden; box-sizing: border-box; padding: 0 10px; }
#outros { overflow-x: hidden !important; max-width: 100% !important; width: 100%; }

.centraliza-checkbox { display: flex; justify-content: center; align-items: center; width: 100%; margin-top: 10px; }





/* Responsivo */
@media (max-width: 768px) {
    .form-container { width: 90%; padding: 10px; margin: 1px auto; box-sizing: border-box; }
    #sistema { width: 70px; min-width: 70px; flex: none; }
    #usuariosOnline { margin-left: auto; }
    .form-container .container > label { width: 150px; }
    
    #reservas .container label { width: 198px; flex-shrink: 0; }
    #reservas .container select { max-width: 170px; width: 100%; margin-left: auto; flex: initial; }
    
    /* NOVO: Ajuste do gerenciador no mobile */
    #tipoConfiguracaoHorario { max-width: 100% !important; margin-left: 0 !important; }

    #convidados .container > label { font-size: 21px !important; }
	
    .convidados-options { margin-left: -20px; white-space: nowrap; }
	
    .convidados-options label { max-width: 100%; white-space: nowrap; font-size: 22px; }
    
    

	
    #main-content { min-height: 500px; position: relative; width: 100%; max-width: 100%; overflow: hidden; box-sizing: border-box; }
    .tab-content { display: none; padding: 10px; width: 100%; max-width: 100%; box-sizing: border-box; position: absolute; top: 40px; left: 0; bottom: 0; overflow-y: auto; }
    .tab-content-active { display: block; }
    .tabs .tab { padding: 8px 10px; font-size: 16px; white-space: nowrap; }
}

.tab-content { display: none; padding: 10px; width: 100%; max-width: 100%; overflow: hidden; box-sizing: border-box; }
.tab-content-active { display: block; }
.tabs { display: flex; justify-content: center; margin-top: 10px; margin-bottom: 15px; }
.tab { padding: 10px 20px; cursor: pointer; background: none; border: none; border-bottom: 3px solid transparent; color: #6c757d; font-weight: 500; transition: all 0.2s ease-in-out; height: auto; display: flex; align-items: center; margin-bottom: -20px; }
.tab:hover { color: #0056b3; }
.tab.active { background: none; font-weight: 600; color: #007bff; border-bottom-color: #007bff; }

#usuariosOnline { background-color: #f2f2f2; font-weight: bold; border: 1px solid black; padding: 5px; }




#convidados { overflow-x: hidden !important; max-width: 100% !important; width: 100%; margin-top: 30px; padding-left: 20px !important; box-sizing: border-box !important; }
input:disabled, select:disabled, button:disabled { cursor: not-allowed; opacity: 0.7; }


/* Modais Gerais */

/* Atualize a classe .modal-overlay para ter o desfoque */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6); /* Fundo escuro transparente */
    z-index: 2000;
    justify-content: center;
    align-items: center;
    
    /* ADICIONE ISTO PARA O EFEITO DE DESFOQUE (MARCA D'ÁGUA) */
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px); /* Para funcionar no iPhone/Safari */
}

.modal-content { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
.modal-content h2 { margin-top: 0; color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; text-align: center; }
.modal-content .container { gap: 15px; }
.modal-content .container label { width: 90px; flex-shrink: 0; text-align: left; font-size: 16px; }
.modal-content .container input[type="text"], .modal-content .container input[type="date"], .modal-content .container .time-input-wrapper { flex: 1; }
.modal-content .container input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; width: 100%; box-sizing: border-box; }
.modal-content .time-input-wrapper { display: flex; align-items: center; gap: 10px; }
.modal-content .modal-buttons { justify-content: flex-end; width: 100%; margin-top: 15px; display: flex; gap: 10px; }
.modal-buttons button { padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 16px; width: auto; margin: 0; }
.modal-buttons .btn-adicionar { background-color: #4CAF50; color: white; border: none; }
.modal-buttons .btn-fechar { background-color: #f44336; color: white; border: none; }
.modal-content hr { width: 100%; border: none; border-top: 1px solid #eee; margin: 20px 0; }
.modal-content h3 { margin-bottom: 10px; font-size: 1.1em; }
#listaExcecoes ul, #listaBloqueios ul { list-style: none; padding: 0; }
#listaExcecoes li, #listaBloqueios li { background-color: #f9f9f9; padding: 10px; border-radius: 4px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; font-size: 15px; }
#listaExcecoes .btn-remover, #listaBloqueios .btn-remover { background-color: #e57373; color: white; border: none; cursor: pointer; border-radius: 50%; width: 22px; height: 22px; padding: 0; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center; line-height: 1; }
.no-select { -webkit-user-select: none; -ms-user-select: none; user-select: none; }
.dias-semana-label { display: flex; align-items: center; font-weight: normal; font-size: 16px; padding: 8px 0; cursor: pointer; gap: 10px; }
#reservasPorConfirmacao.confirmacao-on { color: green; }
#reservasPorConfirmacao.confirmacao-off { color: red; }
#edicaoOrganizador.edicao-on { color: green; }
#edicaoOrganizador.edicao-off { color: red; }

#otimizacaoHorarios.quebra-on { color: green; font-weight: normal; }
#otimizacaoHorarios.quebra-off { color: red; font-weight: normal; }

#otimizacaoHorarios, #edicaoOrganizador, #reservasPorConfirmacao, #sistema { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }

.input-group { display: flex; align-items: center; flex: 1; }
.input-group select { width: 100%; }
.add-button { width: auto; max-width: none; margin: 0; padding: 0; background: none; border: none; color: #007bff; cursor: pointer; font-size: 28px; font-weight: 400; line-height: 1; margin-left: 8px; }
.add-button:hover { color: #0056b3; }
.input-group input[type="text"] { width: 100%; padding: 5px; box-sizing: border-box; border: 1px solid #ced4da; border-radius: .25rem; }
#arbitro[readonly] { background-color: #e9ecef; cursor: default; }
.swap-button { width: auto; max-width: none; margin: 0; padding: 0; background: none; border: none; color: #6c757d; cursor: pointer; font-size: 20px; line-height: 1; margin-left: 8px; }
.swap-button:hover { color: #343a40; }
#reservas .container select {
    max-width: 170px !important;   /* Força o tamanho igual ao antigo */
    width: 100% !important;
    margin-left: auto !important;  /* Empurra para a direita */
    flex: initial !important;      /* Impede que o campo estique e invada o label */
}
.lista-jogadores-scroll { max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px; margin-top: 15px; }
.item-jogador { padding: 12px 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-size: 16px; }
.item-jogador:last-child { border-bottom: none; }
.item-jogador:hover { background-color: #f5f5f5; }
.label-help { cursor: help; }


/* AJUSTE PC: Alinha o bloco de baixo com o de cima */
#reservas > div {
    box-sizing: border-box; /* Inclui borda e padding no cálculo da largura */
    width: 400px;           /* Mesma largura do bloco de cima */
    margin: 10px auto;      /* Centraliza igual ao bloco de cima */
    display: block;
}



/* --- CORREÇÃO FINAL E SEGURA (V5) --- */

/* 1. CONFIGURAÇÃO DO BOX (Ajuste Estrutural) */
#reservas .form-container {
    margin-top: 0 !important;
    border-top: 1px solid #eee;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    padding-bottom: 20px;
    border-radius: 0 0 12px 12px !important; /* Fecha a borda embaixo */
}

/* 2. ALINHAMENTO DA LINHA (FLEXBOX SEGURO) */
.form-container .container {
    margin-bottom: 5px !important; /* Reduzi para ficar compacto igual à tela-1 */
    min-height: 30px; /* Altura mínima consistente */
    align-items: center;
}

/* 3. COMPORTAMENTO NO COMPUTADOR (RÍGIDO) 
   Aqui voltamos para a configuração que funcionou no seu print 'config-pc.jpg' */

#reservas .form-container .container label {
    flex: 0 0 190px !important;  /* TRAVADO: Largura fixa de 190px */
    width: 190px !important;     /* Garante que não estique nem encolha */
    font-weight: bold;
    white-space: nowrap;
    margin-right: 0;             /* Sem margem extra para alinhar matematicamente */
    overflow: visible !important; /* Garante que não apareça (...) */
}

#reservas .form-container .container select {
    flex: 0 0 135px !important;  /* TRAVADO: Largura fixa de 135px */
    width: 135px !important;
    min-width: 135px !important;
    max-width: 135px !important;
}

/* 4. COMPORTAMENTO NO CELULAR (FLEXÍVEL) 
   Só ativa se a tela for menor que 600px */

@media (max-width: 600px) {
    
    #reservas .form-container {
        width: 98% !important;
        margin: 0 auto !important;
        padding-left: 5px !important;
        padding-right: 5px !important;
    }

    /* Label no celular: Solta a trava de 190px e deixa ocupar o espaço livre */
    #reservas .form-container .container label {
        flex: 1 !important;        /* Ocupa o espaço que sobrar */
        width: auto !important;    /* Largura automática */
        margin-right: 5px !important;
        font-size: 21px !important; /* Leve ajuste de segurança se precisar */
    }

    /* Campo no celular: Trava em 80px para caber na linha */
    #reservas .form-container .container select {
        flex: 0 0 80px !important; /* TRAVADO EM 80px */
        width: 80px !important;
        min-width: 80px !important;
        max-width: 80px !important;
    }
}

/* --- FIM DE CORREÇÃO FINAL E SEGURA (V5) --- */


/* --- AJUSTE MODAL HORÁRIO PADRÃO --- */

/* Faz os botões do rodapé ocuparem 50% cada um */
.modal-buttons button {
    flex: 1;      /* Cresce para ocupar espaço igual */
    width: 100%;  /* Garante que o botão use o espaço disponível */
    margin: 0 5px; /* Um pequeno respiro entre eles */
}
/* Remove a margem do primeiro e último para alinhar perfeitamente */
.modal-buttons button:first-child { margin-left: 0; }
.modal-buttons button:last-child { margin-right: 0; }

/* --- FIM DE AJUSTE MODAL HORÁRIO PADRÃO --- */



/* --- Estilos Padrão (Desktop e Celular Deitado) --- */
.texto-mobile {
    display: none; /* Esconde "Abre/Fecha" normalmente */
}

/* --- Regras APENAS para Celular Vertical (Telas até 600px) --- */
@media (max-width: 600px) {

    /* Ajuste de Tamanho dos Botões Principais no Mobile */
    
    /* 1. Botão SALVAR / ADICIONAR (Verde) */
    .modal-buttons .btn-adicionar, 
    #btn-salvar-container button,
    .form-container > button {
        height: 45px !important;    /* Altura maior para o polegar */
        font-size: 18px !important;  /* Fonte bem legível */
        font-weight: bold !important;
        border-radius: 8px !important;
        width: 100% !important;
    }

    /* 2. Botões FECHAR, CANCELAR e EXCLUIR */
    .modal-buttons .btn-fechar,
    #btnExcluirPeriodo {
        height: 45px !important;     /* Agora todos terão a mesma altura */
        font-size: 18px !important;  /* Todos com a mesma fonte */
        font-weight: bold !important;
        border-radius: 8px !important;
        width: 100% !important;
    }

    /* Ajuste para o container dos botões não ficarem apertados */
    .modal-buttons {
        gap: 15px !important;
        margin-top: 20px !important;
    } 

    /* 1. Troca os textos do cabeçalho */
    .texto-desktop { display: none; }
    .texto-mobile { display: inline; }

    /* 2. Ajustes de Container para ganhar espaço */
    .modal-body { padding: 5px !important; }
    .modal-content { width: 98% !important; padding: 10px 5px !important; }
    
    /* 3. Tabela Rígida (Fixed Layout) */
    .tabela-config-horarios {
        width: 100% !important;
        table-layout: fixed; /* Obriga as colunas a terem tamanho exato */
        border-collapse: collapse;
    }

    /* 4. Largura das Colunas (Soma = 100%) */
    /* Dia (Aumentado para caber fonte maior) */
    .tabela-config-horarios th:nth-child(1), 
    .tabela-config-horarios td:first-child { 
        width: 22% !important; 
    }
    /* Status */
    .tabela-config-horarios th:nth-child(2), 
    .tabela-config-horarios td:nth-child(2) { 
        width: 26% !important; 
    }
    /* Abre */
    .tabela-config-horarios th:nth-child(3), 
    .tabela-config-horarios td:nth-child(3) { 
        width: 26% !important; 
    }
    /* Fecha */
    .tabela-config-horarios th:nth-child(4), 
    .tabela-config-horarios td:nth-child(4) { 
        width: 26% !important; 
    }

    /* 5. Estilo das Células */
    .tabela-config-horarios th, 
    .tabela-config-horarios td {
        padding: 2px 1px !important; /* Quase sem espaço entre colunas */
        vertical-align: middle !important;
        text-align: center;
    }

    /* 6. CORREÇÃO DA FONTE DO DIA */
    .tabela-config-horarios td:first-child {
        font-size: 16px !important; /* Fonte maior conforme pedido */
        font-weight: bold;
        text-align: left;
        padding-left: 2px !important;
        white-space: nowrap;
    }

    /* 7. AJUSTE DOS CAMPOS (Selects 100% e Horários com largura reduzida) */
    .tabela-config-horarios select {
        width: 100% !important;
        height: 34px !important;
        font-size: 15px !important;
        text-align: center !important;
    }

    .tabela-config-horarios input[type="time"] {
        /* Diminuímos a largura para o conteúdo "abraçar" a borda */
        width: 85px !important; 
        display: block;
        margin: 0 auto !important; /* Centraliza a própria caixinha na coluna */
        
        height: 34px !important;
        font-size: 15px !important;
        padding: 0 2px !important;
        border-radius: 4px;
        box-sizing: border-box !important;
    }
	
	
}
/* ---  FIM DE REGRAS APENAS PARA CELULAR VERTICAL (Telas até 600px) --- */


button:disabled {
    background-color: #cccccc !important;
    color: #666666 !important;
    cursor: not-allowed !important;
    box-shadow: none !important;
    opacity: 1 !important; /* Remove a transparência para ficar cinza sólido */
}


/* --- AJUSTES MOBILE: HORÁRIOS ESPECIAIS (Telas até 600px) --- */
@media (max-width: 600px) {
    
    /* 1. REGRA GERAL: Permite quebra de linha (útil para as Datas) */
    #modalHorarioEspecial .container {
        flex-wrap: wrap;
        gap: 5px !important;
    }

    /* --- CORREÇÃO: FORÇA O NOME A FICAR NA MESMA LINHA --- */
    #formPeriodoEspecial > .container:nth-child(1) {
        flex-wrap: nowrap !important;
    }

    /* Label do Nome */
    #modalHorarioEspecial label[style*="width: 140px"] {
        width: auto !important; 
        min-width: fit-content !important; 
        white-space: nowrap; 
        margin-right: 5px !important;
        margin-bottom: 0 !important;
		font-size: 18px !important;
    }
    
    /* Input do Nome */
    #nomePeriodo {
        flex: 1 !important; 
        width: auto !important;
        min-width: 0 !important; 
    }

    /* --- CORREÇÃO DA LINHA DE VIGÊNCIA (Força linha única) --- */
    
    /* 1. Seleciona a linha da Vigência (o 2º bloco do formulário) */
    #formPeriodoEspecial > .container:nth-child(2) {
        flex-wrap: nowrap !important;   /* OBRIGATÓRIO: Proíbe quebrar linha */
        align-items: center !important;
        gap: 2px !important;            /* Cola os itens uns nos outros */
    }

    /* 2. Ajusta o Label "Vigência:" */
    #formPeriodoEspecial > .container:nth-child(2) > label {
        width: auto !important;
        flex: 0 0 auto !important;      /* Ocupa só o espaço do texto */
        margin-right: 2px !important;
        font-size: 18px !important;
    }

    /* 3. Ajusta o container interno das datas */
    #formPeriodoEspecial > .container:nth-child(2) > div {
        display: flex !important;
        flex: 1 !important;             /* Ocupa todo o resto da linha */
        width: 100% !important;
        align-items: center !important;
        gap: 1px !important;
    }

    /* 4. O SEGREDO: Inputs de Data flexíveis */
    #dataInicioPeriodo, #dataFimPeriodo {
        flex: 1 !important;             /* Divide o espaço igualmente */
        width: auto !important;         /* Solta a largura fixa */
        min-width: 0 !important;        /* Permite encolher se precisar */
        max-width: 100% !important;
        
        /* Ajuste visual para caber "26/12/2025" */
        font-size: 15px !important;     /* Fonte menor */
        padding: 0 !important;          /* Sem borda interna */
        text-align: center;             /* Centralizado */
        height: 30px !important;
    }

    /* Texto "até" */
    #formPeriodoEspecial span {
        font-size: 15px !important; 
        margin: 0 10px !important;
    }

    /* Checkbox */
    #modalHorarioEspecial input[type="checkbox"] { margin: 0 !important; }
    .dias-semana-label { margin-bottom: 0 !important; padding-bottom: 0 !important; }
	#formPeriodoEspecial .dias-semana-label span {
		font-size: 14px !important; /* Ajuste aqui o tamanho que preferir */
	}

    /* 2. PAINEL AMARELO (Layout Compacto) */
    .painel-regra-mestra {
        padding: 8px !important;
        margin-bottom: 10px !important;
        margin-top: 10px !important;
    }

    .painel-regra-mestra .container {
        display: flex !important;
        flex-direction: row !important; 
        flex-wrap: wrap !important;
        justify-content: space-between !important;
        align-items: center !important; 
        gap: 5px !important;
    }
    
    /* Select (Aberto/Fechado) */
    #regraMestraStatus {
        flex: 1 !important;
        min-width: 80px !important;
        max-width: 110px !important;
        margin: 0 !important;
        height: 30px !important;
		font-size: 16px !important; 
        text-align: center !important; 
        text-align-last: center !important;
    }

    /* Container dos horários */
    .painel-regra-mestra div[style*="display: flex"] {
        flex: 2 !important;
        justify-content: flex-end !important;
        width: auto !important;
        gap: 2px !important;
    }

    /* Inputs de Horário maiores */
    #regraMestraInicio, #regraMestraFim {
        width: 85px !important;
        padding: 0 !important;
        text-align: center;
        height: 30px !important;
        font-size: 16px !important;
    }

    /* 3. BOTÃO CENTRALIZADO */
    #btnGerarDias {
        flex-basis: 100% !important;
        width: 96% !important;
        margin: 10px auto 0 auto !important;
        padding: 8px !important;
        height: auto !important;
        display: block !important;
    }

    /* 4. LISTA DE DIAS (Ajuste Fino V9 - Equilibrado sem buracos) */
    .linha-dia-especial {
        display: flex !important;
        flex-direction: row !important;
        flex-wrap: nowrap !important;   /* Linha única */
        align-items: center !important;
        justify-content: space-between !important; /* Distribui o espaço suavemente */
        padding: 8px 0px !important;
        gap: 2px !important;
        border-bottom: 1px solid #eee !important;
    }

    /* DATA: Fonte 15px, SEM esticar (buraco removido) */
    .linha-dia-especial .dia-label {
        width: auto !important;
        flex: 0 0 auto !important;      /* CORREÇÃO: Não cresce infinitamente (tira o buraco) */
        margin-bottom: 0 !important;
        font-weight: bold;
        color: #007bff;
        font-size: 16px !important;     /* Fonte Grande solicitada */
        white-space: nowrap !important;
        overflow: visible !important;   /* Garante que o (Seg) apareça */
        padding-left: 2px !important;
        margin-right: 5px !important;   /* Pequeno respiro entre data e status */
    }

    /* VISIBILIDADE DAS DATAS */
    .linha-dia-especial .view-desktop { display: none !important; }
    .linha-dia-especial .view-mobile { display: inline-block !important; }
    .linha-dia-especial .separador-hora { display: none !important; }
    .linha-dia-especial span:not(.dia-label):not(.view-mobile) { display: none; }

    /* SELECT (Status): Meio termo (66px) */
    .linha-dia-especial select.status-dia {
        width: 90px !important;         /* Alargamos para a palavra "Fechado" caber */
        min-width: 90px !important;
        height: 32px !important;
        padding: 0 !important;
        text-align: center !important;  
        text-align-last: center !important; 
        font-size: 15px !important;     /*  AGORA SIM A FONTE VAI OBEDECER! */
        margin: 0 !important;
    }

    /* INPUTS (Horários): Meio termo (46px) */
    .linha-dia-especial input.inicio-dia,
    .linha-dia-especial input.fim-dia {
        width: 46px !important;         /* Ajuste fino */
        min-width: 46px !important;
        height: 32px !important;
        padding: 0 !important;
        text-align: center;
        font-size: 13px !important;
        margin: 0 !important;
        border-radius: 4px;
    }
}

/* ---  FIM DE AJUSTES MOBILE: HORÁRIOS ESPECIAIS (Telas até 600px) --- */


/* --- ESTILOS DO MODAL DE AULAS (BLINDADO) --- */

/* 1. Remove a borda e margem que estão "chumbadas" no HTML (style inline) */
#modalHorarioAulas .cabecalho-modal-aulas {
    border-bottom: none !important;  /* Apaga a linha cinza */
    margin-bottom: 0 !important;     /* Remove o espaço extra */
    padding-bottom: 0 !important;    /* Cola nos botões */
}

/* 2. Ajusta o container dos botões para subir e encostar no título */
#modalHorarioAulas .quadras-tabs-container {
    margin-top: 0 !important;
    padding-top: 5px !important;     /* Pequeno respiro visual */
}

/* 1. Botões de Quadra (Estilo App Principal - Pílula e Tela Cheia) */
.quadras-tabs-container {
    display: flex;
    gap: 10px;
    margin-bottom: -10px;
    justify-content: space-between;
    width: 100%;
}

.quadra-tab {
    background-color: #f1f1f1;
    border: 1px solid #ddd;
    border-radius: 50px; 
    padding: 10px 5px;
    cursor: pointer;
    font-weight: bold;
    color: #555;
    flex: 1; 
    max-width: none; 
    text-align: center;
    line-height: 1.3;
    font-size: 16px;
    transition: all 0.2s;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}


.quadra-tab .mobile-text { display: none; }
.quadra-tab .desktop-text { display: inline; }

@media (max-width: 600px) {
    .quadras-tabs-container { gap: 5px; }
    .quadra-tab { 
        padding: 8px 2px; 
        font-size: 0.85em; 
        border-radius: 50px; 
    }
    .quadra-tab .desktop-text { display: none; }
    .quadra-tab .mobile-text { display: block; }
}

/* 2. Painel de Controle (Compacto e Alinhado) */
.painel-controle-aulas {
    background: #f8f9fa !important;
    padding: 10px !important;
    border: 1px solid #eee !important;
    border-radius: 8px !important;
    margin-bottom: 10px !important;
    display: block !important; /* Garante bloco padrão */
}

/* Container Flexível (A Linha Mestra) */
.painel-controle-aulas .linha-unica-flex {
    display: flex !important;
    flex-direction: row !important; /* Força horizontal */
    align-items: center !important;       
    justify-content: flex-start !important; 
    flex-wrap: nowrap !important;         
    gap: 20px !important;                 
    width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
}

/* GRUPO 1: Checkbox */
.painel-controle-aulas .label-ativar {
    display: flex !important;
    align-items: center !important;
    cursor: pointer !important;
    white-space: nowrap !important;
    flex-shrink: 0 !important; 
    margin: 0 !important;
    width: auto !important;
}
.painel-controle-aulas .label-ativar input {
    width: 18px !important;
    height: 18px !important;
    margin: 0 5px 0 0 !important;
    cursor: pointer !important;
    accent-color: #2e7d32 !important;
    display: inline-block !important;
}
.painel-controle-aulas .label-ativar span {
    font-weight: bold !important;
    color: #2e7d32 !important;
    font-size: 15px !important;
    display: inline-block !important;
}

/* GRUPO 2: Professor (Compacto e Grudado) */
.painel-controle-aulas .grupo-professor-compacto {
    display: flex !important;
    align-items: center !important;
    gap: 5px !important;          
    flex-shrink: 0 !important;    
    width: auto !important;
    margin: 0 !important;
}
.painel-controle-aulas .grupo-professor-compacto label {
    font-weight: bold !important;
    margin: 0 !important;
    font-size: 15px !important;
    white-space: nowrap !important;
    width: auto !important; 
    min-width: 0 !important; /* Remove qualquer largura mínima herdada */
    display: inline-block !important;
}

/* Note que mudei 'input' para 'select' aqui */
.painel-controle-aulas .grupo-professor-compacto select {
    width: 160px !important; 
    min-width: 160px !important;
    max-width: 160px !important;
    padding: 2px 5px !important;
    border: 1px solid #ccc !important;
    border-radius: 4px !important;
    height: 28px !important;      
    font-size: 14px !important;
    margin: 0 !important;
    display: inline-block !important;
    flex: none !important;
    background-color: white; /* Garante fundo branco */
}

/* GRUPO 3: Botões (Empurrados para a direita) */
.painel-controle-aulas .grupo-botoes {
    display: flex !important;
    gap: 5px !important;
    flex-shrink: 0 !important;
    margin-left: auto !important; 
    width: auto !important;
}

/* Botões Mini */
    .painel-controle-aulas .btn-mini {
        padding: 0 15px !important;    /*  AUMENTAMOS o espaço interno (largura) */
        height: 36px !important;       /*  AUMENTAMOS a altura de 28px para 36px */
        line-height: 34px !important;  /*  Acompanha a nova altura */
        background: #007bff !important;
        color: white !important;
        border: none !important;
        border-radius: 4px !important;
        cursor: pointer !important;
        font-size: 15px !important;    /*  AUMENTAMOS a fonte de 13px para 15px */
        white-space: nowrap !important;
        width: auto !important;
        min-width: 0 !important;
        margin: 0 !important;
        display: inline-block !important;
    }
    .painel-controle-aulas .btn-mini.outline {
        background: transparent !important;
        border: 1px solid #999 !important;
        color: #555 !important;
        line-height: 34px !important;  /*  Acompanha a nova altura */
    }
.painel-controle-aulas .btn-mini:hover { opacity: 0.9; }


/* --- TÍTULO DA QUADRA (MODO COMPUTADOR / NORMAL) --- */
#tituloAulaQuadra {
    /* Centraliza totalmente (Vertical e Horizontal) */
    display: flex;
    align-items: center;     
    justify-content: center; 

    /* Altura definida para criar o espaço onde ele vai centralizar */
    height: 15px;            
    width: 100%;

    /* Estilo do Texto */
    font-weight: bold;
    font-size: 18px;
    color: #333;

    /* Sem margens extras, a altura (height) cuida do espaço */
    margin: 0; 
    padding: 0;
}

/* Ajuste Celular */
/* ============================================================ */
/* === AJUSTES EXCLUSIVOS PARA CELULAR (Max-Width 600px) === */
/* ============================================================ */
@media (max-width: 600px) {
    

    /* --- CORREÇÃO DO TÍTULO NO CELULAR (MODO NORMAL) --- */
    #tituloAulaQuadra,
    #tituloDuplasQuadra,           /*  ADICIONAMOS AQUI (Para Duplas) */
    #tituloPiramideQuadra {        /*  E AQUI (Para Pirâmide) */
        height: 26px !important;       
        margin-top: 5px !important;   
        margin-bottom: 5px !important; 
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        font-size: 21px !important;    
    }

    /* 0. Reduz o espaço entre os botões de quadra e o painel cinza */
    .quadras-tabs-container {
        margin-bottom: -10px !important; /* Era 15px, reduzimos para 5px */
    }
    
    /* 1. Botões de Quadra: Texto quebrado para caber */
    .quadra-tab { 
        padding: 8px 2px; 
        font-size: 15px !important; /*  AUMENTAMOS DE 13px PARA 15px AQUI */ 
        height: auto;
    }
    .quadra-tab .desktop-text { display: none; }
    .quadra-tab .mobile-text { display: block; line-height: 1.2; }

    /* 2. PAINEL DE CONTROLE (Layout 2 Linhas) */
    .painel-controle-aulas .linha-unica-flex {
        flex-wrap: wrap !important; /* Permite quebrar para a linha 2 */
        gap: 5px !important; 
        align-items: center !important;
        justify-content: space-between !important; /* Separa Checkbox (esq) e Professor (dir) */
    }

    /* ITEM 1: Checkbox "Ativar Aulas" (Fica na esquerda da linha 1) */
    .painel-controle-aulas .label-ativar {
        flex: 0 0 auto !important; /* Ocupa só o espaço do texto */
        margin: 0 !important;
    }
    /* Ajuste leve de fonte para garantir que caiba */
    .painel-controle-aulas .label-ativar span {
        font-size: 16px !important; /*  AUMENTAMOS AQUI DE 14px PARA 16px */
    }

    /* ITEM 2: Grupo Professor (Fica na direita da linha 1) */
    .painel-controle-aulas .grupo-professor-compacto {
        flex: 1 !important; /* Ocupa o resto da linha */
        justify-content: flex-end !important; /* Empurra o input para a DIREITA */
        gap: 5px !important;
        width: auto !important;
    }
    
    /* Label "Professor:" */
    .painel-controle-aulas .grupo-professor-compacto label {
        font-size: 16px !important; /*  AUMENTAMOS AQUI DE 14px PARA 16px */
    }

    /* Input e Select do Professor (Aumentado para melhor leitura) */
    .painel-controle-aulas .grupo-professor-compacto input,
    .painel-controle-aulas .grupo-professor-compacto select {  
        width: 145px !important;    /*  LARGURA: Aumentamos de 120px para 145px */
        min-width: 0 !important;
        flex: 0 0 145px !important; /*  TRAVA DE LARGURA: Acompanha os 145px */
        height: 32px !important;    /*  ALTURA: Um pouquinho maior para o toque */
        font-size: 15px !important; /*  FONTE: Aumentamos de 13px para 15px */
        padding: 0 5px !important;  /* Dá um respiro interno para o texto não colar na borda */
    }

    /* ITEM 3: Botões (Vão para a linha 2, alinhados à direita) */
    .painel-controle-aulas .grupo-botoes {
        flex: 0 0 100% !important; /* Força ocupar uma nova linha inteira (100% largura) */
        justify-content: flex-end !important; /* Alinha os botões à DIREITA */
        margin: 5px 0 0 0 !important; /* Um pouco de espaço acima */
        width: 100% !important;
    }

    /* 3. Tabela: Rolagem Horizontal */
    .tabela-horarios-scroll {
        overflow-x: auto !important; 
        width: 100% !important;
        display: block !important;
        -webkit-overflow-scrolling: touch; 
    }
    /* 1. Destrave a Tabela (Essencial para as células encolherem) */
    .tabela-aulas {
        min-width: 100% !important; /* Libera para ficar menor que 600px */
        width: 100% !important;     /* Tenta ocupar a tela */
		margin-top: 0px !important;
    }

    /* Ajuste Agressivo de Altura */
    .tabela-aulas td, 
    .tabela-aulas th {
        height: 33px !important;       /* Força a altura exata que você quer */
		padding: 0px !important;       /* Remove qualquer gordura interna */
        line-height: 1.0 !important;   /* Cola o texto no teto/chão se precisar */
        vertical-align: middle !important; /* Centraliza o texto verticalmente */
        
        /* Garante que nada estique a célula */
        box-sizing: border-box !important;
    }

    /* Ajuste específico para as COLUNAS LATERAIS (Horários) */
    /* Adicionei th:first-child e th:last-child para funcionar com table-layout: fixed */
    .tabela-aulas th:first-child, 
    .tabela-aulas td:first-child,
    .tabela-aulas th:last-child, 
    .tabela-aulas td:last-child {
        width: 95px !important;       /*  LARGURA: Aumentamos de 85px para 95px para o texto não cortar */
        min-width: 95px !important;   /*  LARGURA: Aumentamos aqui também */
        max-width: 95px !important;   
        
        font-size: 15px !important;   /*  FONTE: Aumentamos de 13px para 15px! */  
        white-space: nowrap !important;
    }
	/* 4. Ajuste dos DIAS (Seg a Dom) - O "Miolo" da tabela */
    .tabela-aulas th:not(:first-child):not(:last-child),
    .tabela-aulas td:not(:first-child):not(:last-child) {
        width: 60px !important;      /* AJUSTE AQUI A LARGURA DOS DIAS */
        min-width: 60px !important;  /* Mantenha igual ao width */
        max-width:60px !important;  /* Trava para ficar uniforme */
    }
	/* 5. AUMENTAR FONTE DOS CABEÇALHOS (Horário, Seg, Ter...) */
    .tabela-aulas th,
    .tabela-aulas th:first-child,
    .tabela-aulas th:last-child {
        font-size: 15px !important;  /*  Aumentamos a fonte dos títulos! */
        padding-top: 4px !important; /* Dá um leve respiro em cima */
        padding-bottom: 4px !important; /* E embaixo, para não colar nas bordas */
    }
	
}
/* === FIM DE AJUSTES EXCLUSIVOS PARA CELULAR (Max-Width 600px) === */

/* 3. Tabela Visual */
.tabela-aulas {
    width: 100%;
    border-collapse: collapse; 
    margin-top: 10px;
    background-color: white;
}

.tabela-aulas th, 
.tabela-aulas td {
    border: 1px solid #ddd; 
    padding: 8px 4px;       
    text-align: center;
    vertical-align: middle;
    font-size: 14px;        
}

.tabela-aulas th {
    background-color: #f2f2f2;
    font-weight: bold;
    color: #333;
}

.tabela-aulas td:first-child,
.tabela-aulas td:last-child { 
    font-weight: normal;
    background-color: white;
    width: 110px; 
    white-space: nowrap;
    border-left: 1px solid #ddd;
    border-right: 1px solid #ddd;
}

.aula-cell-livre {
    background-color: #fff;
    cursor: pointer;
}
.aula-cell-livre:hover {
    background-color: #f9f9f9;
}

.aula-cell-marcada { 
    background-color: lightcoral !important; 
    color: black; 
    font-weight: normal;
    cursor: pointer;
}

.aula-cell-bloqueada {
    background-color: #f2f2f2 !important; 
    cursor: not-allowed !important;
    pointer-events: none;
}
/* --- FIM DE ESTILOS DO MODAL DE AULAS --- */


/* --- MODO TELA CHEIA (Maximizar) --- */
.modal-content.maximizado {
    width: 100vw !important;       /* Largura total da viewport */
    height: 100vh !important;      /* Altura total da viewport */
    max-width: none !important;    /* Remove limites */
    max-height: none !important;
    top: 0 !important;
    left: 0 !important;
    margin: 0 !important;
    border-radius: 0 !important;
    padding: 10px !important;
    
    /* Transforma em Flexbox vertical para a tabela crescer */
    display: flex !important;
    flex-direction: column !important;
}

/* Oculta o que não é necessário */
.modal-content.maximizado .cabecalho-modal-aulas, /* Vamos adicionar essa classe no H2 */
.modal-content.maximizado .painel-controle-aulas,
.modal-content.maximizado .modal-buttons {
    display: none !important;
}

/* Faz a tabela ocupar todo o espaço restante */
.modal-content.maximizado .tabela-horarios-scroll {
    flex: 1 !important;            /* Cresce para preencher o vazio */
    height: auto !important;       /* Reseta altura fixa se houver */
    overflow-y: auto !important;   /* Garante rolagem se precisar */
}

/* --- CLASSE PARA BLOQUEAR SELEÇÃO VISUAL --- */
.sem-selecao {
    -webkit-user-select: none; /* Safari */
    -moz-user-select: none;    /* Firefox */
    -ms-user-select: none;     /* IE10+/Edge */
    user-select: none;         /* Padrão */
}

/* ---  FIM DE MODO TELA CHEIA (Maximizar) --- */



/* ================================================================= */
/* ===  AJUSTE FINAL: TELA CHEIA MOBILE (Vertical) - DEFINITIVO  === */
/* ================================================================= */

@media (max-width: 600px) {

    /* 1. CONTAINER GERAL (Sem cores, fundo branco) */
    .modal-content.maximizado {
        width: 100vw !important;
        height: 100dvh !important;      /* CORRIGIDO: dvh respeita a barra do navegador */
        max-width: none !important;
        max-height: 100dvh !important;  /* CORRIGIDO: max-height também com dvh */
        top: 0 !important; left: 0 !important;
        margin: 0 !important; 
        padding: 10px !important;       /* AUMENTADO: de 5px para 10px para descolar do teto */
        border-radius: 0 !important;
        display: flex !important;
        flex-direction: column !important;
        background-color: white !important;
        z-index: 9999 !important;
        overflow: hidden !important; 
    }

    /* 2. ESCONDER O DESNECESSÁRIO */
    .modal-content.maximizado .cabecalho-modal-aulas, 
    .modal-content.maximizado .painel-controle-aulas,
    .modal-content.maximizado .modal-buttons {
        display: none !important;
    }

    /* 3. BOTÕES SUPERIORES (A Caixa Vermelha) - VERSÃO FORÇA BRUTA */
    /* 3. BOTÕES SUPERIORES (Aulas Maximizado) - CORRIGIDO */
    .modal-content.maximizado .quadras-tabs-container {
        flex: 0 0 auto !important; 
        
        /* AQUI ESTAVA O ERRO: Removemos as travas de altura e o corte (hidden) */
        height: auto !important;        
        max-height: none !important;    
        overflow: visible !important;   
        
        /* Ajuste de Posicionamento para não cortar no topo */
        margin-top: 10px !important;    /* Espaço seguro do teto */
        margin-bottom: 5px !important;  
        padding: 5px 0 !important;      /* Respiro interno */
        
        border: none !important;
        width: 100% !important;
        display: flex !important;       
        align-items: center !important; 
    }

    /* ADICIONAL DE SEGURANÇA: Garante que os botões dentro não tenham margem */
    .modal-content.maximizado .quadra-tab {
        margin-bottom: 0 !important;
        height: 100% !important;        /* Ocupa a altura da caixa pai */
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* 4. TÍTULO "QUADRA X" (O Ponto de Equilíbrio: 28px) -> MODO GIGANTE */
    .modal-content.maximizado #tituloAulaQuadra {
        display: flex !important;
        align-items: center !important;     
        justify-content: center !important; 
        
        width: 100% !important;
        
        height: 38px !important;            /*  AUMENTAMOS a altura para o texto caber */
        min-height: 38px !important;        /*  Acompanha a altura */
        
        margin: 5px 0 15px 0 !important;    /*  Damos mais respiro em cima e embaixo para preencher a tela */
        padding: 0 !important;
        
        font-size: 24px !important;         /*  FONTE GIGANTE: De 16px para 24px! */
        font-weight: bold !important;
        color: #333 !important;
        background: transparent !important;
        flex-shrink: 0 !important;
    }

    /* 5. TABELA DE HORÁRIOS */
    .modal-content.maximizado .tabela-horarios-scroll {
        margin-top: 0 !important;       /* Cola no título */
        padding-top: 0 !important;
        border-top: 1px solid #eee !important;
        flex: 1 !important;             /* Ocupa o resto da tela */
        height: auto !important;
        overflow-y: auto !important;
    }
    
    .modal-content.maximizado .tabela-aulas {
        margin-top: 0 !important;
    }
	
	/* 5. CABEÇALHOS DA TABELA (Dias e Horário) -> MODO GIGANTE */
    .modal-content.maximizado .tabela-aulas th,
    .modal-content.maximizado .tabela-aulas th:first-child,
    .modal-content.maximizado .tabela-aulas th:last-child {
        font-size: 18px !important;    /*  AUMENTAMOS a fonte de 15px para 18px */
        padding-top: 10px !important;  /*  Mais respiro em cima */
        padding-bottom: 10px !important; /*  Mais respiro em baixo */
    }
	
	/* 6. CÉLULAS MAIS ALTAS NO MODO MAXIMIZADO (Melhor área de toque) */
    .modal-content.maximizado .tabela-aulas td,
    .modal-content.maximizado .tabela-aulas th {
        height: 35px !important;       /*  Deixa as linhas um pouco mais altas */
        padding-top: 5px !important;   /*  Mais respiro interno em cima */
        padding-bottom: 5px !important;/*  Mais respiro interno em baixo */
    }
}
/* ================================================================= */



/* --- ESTILOS DO MODO FOCO (TELA CHEIA - HORÁRIOS ESPECIAIS) --- */

/* 1. Transforma o Modal em Tela Cheia e usa Flexbox */
#modalHorarioEspecial.modo-foco .modal-content {
    width: 100vw !important;
    height: 100vh !important;
    max-width: none !important;
    max-height: none !important;
    
    top: 0 !important;
    left: 0 !important;
    margin: 0 !important;
    
    border-radius: 0 !important;
    padding: 15px 25px !important;
    box-sizing: border-box !important;
    
    /* Organiza o conteúdo verticalmente */
    display: flex !important;
    flex-direction: column !important;
}

/* 2. Esconde o painel superior (Nome, Datas, Regra Mestra) */
#modalHorarioEspecial.modo-foco #areaSuperiorEspecial {
    display: none !important;
}

/* 3. Faz a lista de dias esticar para ocupar todo o espaço */
#modalHorarioEspecial.modo-foco .lista-dias-scroll {
    flex-grow: 1 !important;        /* Ocupa todo o espaço vazio */
    max-height: none !important;    /* Remove a trava de 400px */
    height: auto !important;        /* Altura automática */
    overflow-y: auto !important;    /* Barra de rolagem aparece aqui */
    margin-bottom: 15px !important; /* Separa dos botões do rodapé */
}

/* 4. Fixa os botões no rodapé sem serem esmagados */
#modalHorarioEspecial.modo-foco .modal-buttons {
    margin-top: 0 !important;
    flex-shrink: 0 !important;
}
/* --- FIM DE ESTILOS DO MODO FOCO (TELA CHEIA - HORÁRIOS ESPECIAIS) --- *


/* --- CORREÇÃO MOBILE: JANELA HORÁRIOS ESPECIAIS (VERTICAL) --- */
@media (max-width: 600px) {
    
    /* 1. Solta a janela do centro e cola no topo (Padding zerado) */
    #modalHorarioEspecial.modal-overlay {
        align-items: flex-start !important; 
        padding-top: 0 !important;       
        overflow: hidden !important;       
    }

    /* 2. Ajusta o tamanho da caixa branca para TELA CHEIA MÁXIMA */
    #modalHorarioEspecial .modal-content {
        width: 100vw !important;        
        height: 100dvh !important;      
        max-height: 100dvh !important;  
        padding: 8px 5px 15px 5px !important; /* Aumentado o espaço no fundo para 15px */
        border-radius: 0 !important;
        margin: 0 !important;    
        box-sizing: border-box !important; /* A MÁGICA: Impede que a tela vaze e corte os botões */
    }

    /* 3. Título Principal */
    #modalHorarioEspecial .modal-content > div:first-child {
        min-height: 24px !important;
        margin-bottom: 2px !important;
        margin-top: 0 !important;
    }
    #modalHorarioEspecial h2 {
        font-size: 1.6rem !important; 
        margin: 0 !important;
        line-height: 1 !important;
    }

    /* 4. REMOVE ESPAÇOS DO PAINEL SUPERIOR */
	/* 1. Mantém texto e campo na mesma linha (lado a lado) */
    .painel-destaque .container {
        display: flex !important;
        flex-direction: row !important; /* Força ficar na mesma linha */
        align-items: center !important; /* Alinha os dois pelo meio */
        gap: 10px !important; /* Dá um pequeno espaço entre o texto e o campo */
    }

    /* 2. Ajusta o texto "Gerenciar Período:" */
    label[for="selectPeriodoEspecial"] {
        font-size: 18px !important; 
        white-space: nowrap !important; /* Impede o texto de ser esmagado/quebrar de linha */
        width: auto !important; 
        margin: 0 !important;
    }

    /* 3. Faz o campo esticar e preencher todo o resto da linha */
    #selectPeriodoEspecial {
        font-size: 14.3px !important; 
        height: 45px !important; 
        flex: 1 !important; /* O SEGREDO: Manda o campo ocupar todo o espaço vazio à direita */
        width: 100% !important;
        margin: 0 !important;
    }
    #areaSuperiorEspecial {
        margin-bottom: 0 !important;
    }
    #areaSuperiorEspecial .painel-regra-mestra {
        margin-bottom: 2px !important;
    }

    /* 5. Container "Ajuste Fino" */
    #areaSuperiorEspecial + div {
        height: 40px !important;      
        margin: 0 !important;         
        padding-bottom: 0 !important;
        min-height: 0 !important;
        display: flex !important;     
        align-items: center !important; 
    }
    
    
    

    /* 8. Botões do rodapé */
    #modalHorarioEspecial .modal-buttons {
        padding-bottom: 0 !important;
        margin-bottom: 0 !important;
    }

    /* --- AJUSTE DO PAINEL AMARELO (Botão Centralizado) --- */
    .painel-regra-mestra .container {
        gap: 2px !important;
        justify-content: center !important; 
    }
    
    #btnGerarDias {
        width: auto !important;         
        min-width: 200px !important;    
        height: 30px !important;        
        margin-top: 4px !important;
        margin-left: auto !important;
        margin-right: auto !important;
        padding: 0 15px !important;
        font-size: 0.9rem !important; 
    }

    /* --- CORREÇÃO FINAL DAS LINHAS --- */
    #containerListaDiasEspeciais {
        gap: 0 !important; 
        background-color: #fff !important;
    }

    .linha-dia-especial {
        display: flex !important;
        flex-wrap: nowrap !important;
        align-items: center !important;
        justify-content: space-between !important; 
        gap: 2px !important;
        padding: 8px 2px !important;
        border-bottom: 1px solid #eee !important; 
        background-color: #fff !important; /* Fundo branco padrão */
    }

    /* CORREÇÃO DA COR (FECHADO): Sobrepõe o branco quando necessário */
    .linha-dia-especial.fechado {
        background-color: #ffebee !important; /* Rosa claro forte */
    }

    /* A. DATA */
    .linha-dia-especial .dia-label {
        width: 110px !important;       /*  AUMENTAMOS AQUI para o texto não cortar */
        min-width: 110px !important;   /*  AUMENTAMOS AQUI também */
        font-size: 16px !important;    /*  TROCAMOS de 0.80rem (12px) para 16px! */
        white-space: nowrap !important;
        overflow: hidden !important;
    }

    /* C. INPUTS (Hora) */
    .linha-dia-especial input[type="time"],
    .linha-dia-especial input.inicio-dia,
    .linha-dia-especial input.fim-dia {
        flex: 0 0 66px !important;    /* O ANTÍDOTO: Proíbe o campo de esticar como um elástico! */
        width: 66px !important;       
        min-width: 66px !important;   
        max-width: 66px !important;   /* TRAVA ABSOLUTA para ele não crescer 1 milímetro sequer */
        padding: 0 !important;
        text-align: center !important;
        font-size: 15px !important;   
        height: 32px !important;      
        border-radius: 4px !important;
        margin: 0 !important;
    }
}
/* --- FIM DE CORREÇÃO MOBILE: JANELA HORÁRIOS ESPECIAIS --- */


/* --- CORREÇÃO EXTRA: CELULAR NA HORIZONTAL (PAISAGEM) --- */
@media (max-height: 500px) {
    
    /* 1. Fundo ocupa tudo */
    #modalHorarioEspecial.modal-overlay {
        padding: 0 !important;
        align-items: flex-start !important;
        height: 100% !important;
    }

    /* 2. Janela Principal */
    #modalHorarioEspecial .modal-content {
        width: 100vw !important;
        height: 100dvh !important;
        max-height: none !important;
        border-radius: 0 !important;
        margin: 0 !important;
        
        /* AJUSTE: Aumentei o topo para 8px (estava 2px) para dar respiro */
        padding: 8px 5px 5px 5px !important;
        
        display: flex !important;
        flex-direction: column !important;
        overflow: hidden !important;
    }

    /* 3. Container do Título */
    #modalHorarioEspecial .modal-content > div:first-child {
        min-height: 24px !important;   /* Um pouco maior */
        margin-bottom: 5px !important; /* Aumentei para 5px (estava 2px) */
        margin-top: 0 !important;
    }

    /* 4. O Título em si */
    #modalHorarioEspecial h2 {
        font-size: 1.6rem !important; /* Fonte legível */
        margin: 0 !important;
        line-height: 1 !important;
    }
    
    /* 5. Scroll Interno */
    #corpoModalScroll {
        flex: 1 1 auto !important;
        overflow-y: auto !important;
        min-height: 0 !important;
        display: block !important;
    }

    /* 6. Rodapé */
    #modalHorarioEspecial .modal-buttons {
        flex-shrink: 0 !important;
        padding-top: 5px !important;
        padding-bottom: 2px !important;
    }
}
/* --- FIM DE CORREÇÃO EXTRA: CELULAR NA HORIZONTAL (PAISAGEM) --- */


/* --- AJUSTE FINO: MODO FOCO NO CELULAR (VERTICAL) --- */
@media (max-width: 600px) {
    
    /* 1. Remove gorduras laterais da janela maximizada */
    #modalHorarioEspecial.modo-foco .modal-content {
        padding-left: 5px !important;
        padding-right: 5px !important;
        width: 100% !important; /* Garante uso total */
    }

    /* 2. Ajusta o container da lista para colar nas bordas */
    #modalHorarioEspecial.modo-foco .lista-dias-scroll {
        border: none !important; /* Remove borda cinza se houver */
        padding: 0 !important;
    }

    /* 3. Otimiza a linha do dia (Data + Inputs) para ocupar tudo */
    #modalHorarioEspecial.modo-foco .linha-dia-especial {
        justify-content: space-between !important; /* Espalha os itens */
        padding-left: 2px !important;
        padding-right: 2px !important;
        gap: 2px !important; /* Reduz espaço entre elementos */
    }

    /* 4. Garante que o Select (Aberto/Fechado) tenha prioridade de espaço */
    #modalHorarioEspecial.modo-foco .linha-dia-especial select.status-dia {
        min-width: 80px !important; /* Força largura para caber "Fechado" */
        flex-shrink: 0 !important;  /* Impede que ele seja esmagado */
    }

    /* 5. Ajusta a Data para não roubar espaço demais */
    #modalHorarioEspecial.modo-foco .linha-dia-especial .dia-label {
        font-size: 16px !important; /* Leve redução se necessário */
        margin-right: 2px !important;
    }
}
/* --- FIM DE AJUSTE FINO: MODO FOCO NO CELULAR (VERTICAL) --- */


/* --- BOTÃO EXPANDIR (SVG) --- */
.btn-expandir {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0 5px; /* Reduzi um pouco a lateral */
    margin-left: auto; 
    display: none; 
    align-items: center;
    justify-content: center;
    
    /* Aumentei a área de clique para ficar confortável com o ícone maior */
    height: 34px; 
    width: 44px; 
    
    color: #555; 
    transition: transform 0.2s;
}

.btn-expandir:active {
    transform: scale(0.9);
}

.btn-expandir svg {
    width: 28px;  /* Aumentado de 24px para 28px */
    height: 28px; /* Aumentado de 24px para 28px */
    fill: currentColor;
    vertical-align: middle;
}
/* Remove o fundo verde ao passar o mouse ou clicar no celular */
.btn-expandir:hover, 
.btn-expandir:focus, 
.btn-expandir:active {
    background: transparent !important;      /* Força fundo transparente */
    background-color: transparent !important; 
    color: #555 !important;                  /* Mantém a cor cinza do ícone */
    box-shadow: none !important;             /* Remove sombras se houver */
    outline: none !important;                /* Remove borda de seleção */
    -webkit-tap-highlight-color: transparent; /* Remove o flash cinza do toque no Android/iOS */
}
/* --- FIM DE  BOTÃO EXPANDIR (SVG) --- */



/* --- AJUSTE FINO DO BOTÃO NO CELULAR (VERTICAL) --- */
@media (max-width: 600px) {

    /* 1. Garante que o ícone fique grande e visível */
    .btn-expandir svg {
        width: 35px !important;  /*  AUMENTAMOS de 28px para 35px */
        height: 35px !important; /*  AUMENTAMOS de 28px para 35px */
    }

    /* 2. Área de toque maior e alinhamento rígido */
    .btn-expandir {
        width: 50px !important;       /* Largura fixa para não empurrar o texto */
        height: 40px !important;      /* Altura igual à da linha do título */
        padding: 0 !important;        /* Remove bordas internas */
        margin-left: auto !important; /* Joga para a direita */
        display: flex !important;     /* Centraliza o SVG dentro do botão */
        align-items: center !important;
        justify-content: center !important;
    }

    /* 3. Ajuste do texto "Ajuste Fino" para não brigar por espaço */
    #areaSuperiorEspecial + div h3 {
        font-size: 18px !important;   /* Tamanho legível */
        line-height: 40px !important; /* Centraliza verticalmente com o botão */
        margin: 0 !important;
        white-space: nowrap;          /* Impede que o texto quebre linha */
    }
    
    /* 4. Trava a altura da linha inteira */
    #areaSuperiorEspecial + div {
        height: 40px !important;
        min-height: 40px !important;
        padding-right: 0 !important;  /* Aproveita até o último pixel da direita */
    }
}
/* --- FIM DE AJUSTE FINO DO BOTÃO NO CELULAR (VERTICAL) --- */ 



/* Adicione isso junto com os outros botões no CSS */ 
.btn-lapis {
    background: none !important; /* Garante fundo transparente */
    border: none !important;
    padding: 0 !important;
    margin-left: 8px !important; /* Mesmo espaçamento do botão anterior */
    cursor: pointer;
    font-size: 17px; /* Tamanho compatível com o layout */
    line-height: 1;
    width: auto !important; /* Não deixa esticar */
    color: #FFA500; /* Cor laranja (opcional) ou remova para cor padrão */
}
.btn-lapis:hover {
    transform: scale(1.1); /* Efeito suave ao passar o mouse */
}
/* Estilo específico para o Lápis Desabilitado (Admin) */
/* Estilo para deixar o Lápis Cinza/Apagado quando bloqueado */
.btn-lapis:disabled {
    background: transparent !important;     /* Sem fundo cinza */
    border: none !important;                /* Sem borda */
    cursor: not-allowed !important;         /* Mouse de bloqueado */
    
    /* O SEGREDO DO CINZA PARA EMOJIS: */
    filter: grayscale(100%) !important;     /* Remove o laranja do emoji */
    opacity: 0.3 !important;                /* Deixa ele bem clarinho (parecendo cinza) */
    
    transform: none !important;             /* Remove efeito de zoom */
}

/* fim de Adicione isso junto com os outros botões no CSS */



/* Classes para Perfil e Permissões que faltavam */
.select-padrao {
    flex: 1;
    height: 30px !important;
    padding: 0 5px;
    box-sizing: border-box;
}

.btn-extra {
    background: none !important;
    border: none !important;
    cursor: pointer;
    padding: 0 !important;
    margin: 0 0 0 5px !important; /* Pequena margem a esquerda */
    display: flex;
    align-items: center;
    justify-content: center;
    width: 30px !important; 
    height: 30px !important;
    font-size: 17px !important;
    line-height: 1 !important;
}

.container-fixo {
    margin-top: 0 !important;
}
/* --- ESTILO PARA O CAMPO DE PERMISSÕES DO ADMIN (SEM SETA) --- */
#permissoesSelect:disabled {
    appearance: none;           /* Padrão moderno: remove a seta */
    -webkit-appearance: none;   /* Chrome/Safari: remove a seta */
    -moz-appearance: none;      /* Firefox: remove a seta */
    
    background-image: none !important; /* Garante que nenhuma imagem de seta sobre */
    background-color: transparent !important; /* Fundo transparente para parecer texto puro */
    border: none !important;    /* Opcional: remove a borda se quiser parecer texto solto */
    
    color: #333 !important;     /* Mantém o texto preto forte (não deixa cinza) */
    opacity: 1 !important;      /* Garante visibilidade total */
    cursor: default;            /* Mouse padrão (seta) em vez de mãozinha */
    
    text-align: left;           /* Ou center, como preferir */
    padding-left: 0;            /* Remove recuo se tirar a borda */
    font-weight: bold;
}
/* fim de Classes para Perfil e Permissões que faltavam */


/* 1. Botão ADICIONAR (+): Forçamos ele a ficar maior */
button.add-button {
    font-size: 30px !important;   /* Tamanho do ícone + */
    width: 32px !important;       /* Largura da área de clique */
    height: 32px !important;      /* Altura da área de clique */
    
    /* Centralização garantida */
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    
    /* Opcional: Um ajuste fino se o + parecer "alto" demais */
    padding-bottom: 3px !important; 
}
/* fim de 1. Botão ADICIONAR (+): Forçamos ele a ficar maior */



/* --- LAYOUT INTELIGENTE (VERSÃO "AUTO") --- */

/* 1. TÍTULO "PERMISSÕES:" */
.titulo-smart {
    font-size: 1.5rem;
    font-weight: bold;
    color: #333;
    white-space: nowrap;
    flex: 0 0 auto;
}

/* 2. GRUPO [NOME + LIXEIRA] */
.grupo-nome-lixo-smart {
    display: flex;
    align-items: center;
    justify-content: space-between;
    
    /* AQUI ESTÁ A CORREÇÃO DEFINITIVA: */
    /* 'auto': O navegador calcula o tamanho real do texto. */
    /* Se (Título + Texto) > Largura da Tela --> ELE QUEBRA LINHA */
    /* Se (Título + Texto) < Largura da Tela --> ELE MANTÉM NA LINHA */
    flex: 1 1 auto;     
    
    /* Tamanho mínimo de segurança para não esmagar a lixeira e o "Operador" */
    min-width: 120px;   
}

/* O resto continua igual... */
.header-flex-smart {
    display: flex;
    flex-wrap: wrap;       
    align-items: center;    
    justify-content: center; /* Centraliza se cair pra linha de baixo */
    width: 100%;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
    margin-bottom: 15px;
    box-sizing: border-box;
    gap: 5px;
}

/* NOME DO PERFIL */
#textoNomePerfil {
    font-size: 1.5rem;
    font-weight: bold;
    color: #333;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; 
    margin-right: 10px;
    text-align: left;
    flex: 1;                 
}

/* LIXEIRA */
.btn-lixo-smart {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 22px; 
    line-height: 1;
    padding: 0;
    margin: 0;
    width: 30px; 
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #dc3545; 
    flex-shrink: 0;
}
/* --- fim de LAYOUT INTELIGENTE (VERSÃO "AUTO") --- */


/* --- AJUSTE HÍBRIDO PERMISSÕES V3 (ALINHAMENTO CORRIGIDO) --- */
@media (max-width: 600px) {
    
    /* 1. O Container: Garante base sólida */
    label[for="permissoesSelect"] + .input-group {
        position: relative !important;
        display: flex !important;       
        align-items: center !important;
        width: 100% !important;
        box-sizing: border-box !important;
    }

    /* === CENÁRIO 1: NORMAL (DROPDOWN ATIVO) === */
    /* Deve ficar IDÊNTICO ao campo de Perfil */
    
    #permissoesSelect:not(:disabled) {
        flex: 1 !important;             /* Cresce para ocupar espaço */
        width: 100% !important;         /* Garante largura total disponível */
        height: 30px !important;
        
        /* CORREÇÃO DO ALINHAMENTO ESQUERDA: */
        margin: 0 !important;           
        padding: 5px !important;        /* Padding padrão dos outros inputs */
        box-sizing: border-box !important;
    }

    /* Botão Lápis no fluxo normal (ao lado) */
    #permissoesSelect:not(:disabled) + #btnEditarPermissoes {
        position: static !important;    
        margin-left: 5px !important;    
        background: none !important;
        width: 30px !important;         /* Tamanho fixo para não dançar */
        height: 30px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }


    /* === CENÁRIO 2: ADMIN (TEXTO LONGO "⚡ACESSO TOTAL") === */
    /* Modo invasão: Texto estica, lápis flutua */
    
    #permissoesSelect:disabled {
        width: 100% !important;         
        flex: none !important;          
        height: 30px !important;
        
        /* Espaço na direita para o lápis flutuante */
        padding: 5px 30px 5px 5px !important; 
        
        /* CORREÇÃO DO ALINHAMENTO ESQUERDA: */
        margin: 0 !important;
        box-sizing: border-box !important;
        
        /* Visual do texto travado */
        opacity: 1 !important;
        color: #333 !important;
        -webkit-text-fill-color: #333 !important;
        font-weight: bold !important;
    }

    /* Botão Lápis Fantasma (Flutuante) */
    #permissoesSelect:disabled + #btnEditarPermissoes {
        position: absolute !important;  
        right: 0 !important;            
        top: 0 !important;
        width: 30px !important;
        height: 30px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        background: transparent !important;
        z-index: 10 !important;
        margin: 0 !important;
    }
}
/* --- fim de AJUSTE HÍBRIDO PERMISSÕES V3 (ALINHAMENTO CORRIGIDO) --- */



/* --- AUMENTAR APENAS PERFIL E PERMISSÕES NA DIREITA (MOBILE) --- */
@media (max-width: 600px) {
    
    /* Selecionamos especificamente os grupos ao lado dos rótulos "Perfil" e "Permissões" */
    
    label[for="perfilSelect"] + .input-group,
    label[for="permissoesSelect"] + .input-group {
        
        /* O TRUQUE: Margem negativa na direita */
        /* Isso faz o campo "avançar" sobre o espaço vazio da borda */
        margin-right: -12px !important; 
        
        /* Força o recálculo da largura para aproveitar esse espaço extra */
        width: auto !important;
        flex: 1 !important;
    }
}
/* --- fim de AUMENTAR APENAS PERFIL E PERMISSÕES NA DIREITA (MOBILE) --- */


/* --- LAYOUT ULTRA-COMPACTO FINAL (FONTE AJUSTADA) --- */
@media (max-height: 500px) {

    /* 1. Ocultar instrução e linha divisória */
    .texto-instrucao, 
    .lista-permissoes hr {
        display: none !important;
    }

    /* 2. Cabeçalho: Zero espaço embaixo */
    .header-flex-smart {
        border-bottom: none !important;
        margin-bottom: 0 !important;
        padding-bottom: 0 !important;
        min-height: auto !important;
    }

    /* 3. Lista: Zero espaço em cima */
    .lista-permissoes {
        gap: 0 !important;
        margin-top: 0 !important;
    }

    /* 4. O PAINEL AZUL (Acesso Total): Fonte menor e colado no topo */
    .lista-permissoes > label:first-child {
        margin-top: -2px !important;
        margin-bottom: 3px !important;
        padding: 2px 5px !important;    /* Padding reduzido */
        min-height: 26px !important;    /* Altura reduzida */
        
        /* AQUI ESTÁ O AJUSTE DA FONTE: */
        font-size: 13px !important; 
    }

    /* 5. Os Outros Itens (Filhos) */
    .lista-permissoes label:not(:first-child) {
        padding: 0 !important;
        margin: 0 !important;
        min-height: 22px !important;
        font-size: 13px !important;
        display: flex !important;
        align-items: center !important;
    }
    
    .lista-permissoes input[type="checkbox"] {
        margin: 0 5px 0 0 !important;
        transform: scale(0.9);
    }

    /* 6. A Caixa do Modal */
    #modalPermissoes .modal-content {
        padding: 2px 5px !important;
        top: 0 !important;
        width: 98% !important;
        max-height: 100vh !important;
        border-radius: 4px !important;  
    }

    /* 7. Botões */
    #modalPermissoes .modal-buttons {
        margin-top: 2px !important;
        padding-top: 2px !important;
    }
    #modalPermissoes .modal-buttons button {
        height: 28px !important;
        line-height: 1 !important;
        font-size: 14px !important;
        padding: 0 10px !important;
    }
}
/* --- FIM DE LAYOUT ULTRA-COMPACTO FINAL (FONTE AJUSTADA) --- */



/* --- ESTILO RETRÔ: BORDA PRETA E FUNDO BRANCO (SEM CINZA/LARANJA) --- */
select:focus,
input:focus,
button:focus,
textarea:focus {
    /* 1. Remove o brilho laranja/azul do navegador */
    outline: none !important;
    box-shadow: none !important;
    
    /* 2. Força a borda a ficar PRETA (igual à versão antiga) */
    border-color: #000000 !important;
    
    /* 3. O PULO DO GATO: Força o fundo a ficar BRANCO ABSOLUTO */
    /* Isso impede que o campo fique cinza ao clicar */
    background-color: #ffffff !important;
    color: #000000 !important;
}

/* 4. Remove a "sombra de toque" (aquele flash cinza rápido do Android) */
* {
    -webkit-tap-highlight-color: transparent !important;
}
/* --- FIM DE ESTILO RETRÔ: BORDA PRETA E FUNDO BRANCO (SEM CINZA/LARANJA) --- --- */


/* --- CORREÇÃO DA LIXEIRA (REMOVER FUNDO VERDE) --- */
.btn-lixo-smart:hover {
    background-color: transparent !important; /* Força transparência */
    background: none !important;              /* Garante que não tenha imagem de fundo */
    transform: scale(1.1);                    /* Opcional: Um leve zoom para dar feedback */
}
/* --- fim de CORREÇÃO DA LIXEIRA (REMOVER FUNDO VERDE) --- */


/* --- NOTIFICAÇÕES (TOASTS) --- */
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 99999;
    display: flex;
    flex-direction: column;
    gap: 10px;
    pointer-events: none; /* Deixa clicar através do container vazio */
}

.toast {
    min-width: 280px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    animation: slideInRight 0.3s ease-out forwards;
    pointer-events: auto; /* Reativa cliques no toast */
    display: flex;
    align-items: center;
    font-size: 15px;
    line-height: 1.4;
}

.toast.success { background-color: #2e7d32; border-left: 5px solid #1b5e20; }
.toast.error { background-color: #d32f2f; border-left: 5px solid #b71c1c; }
.toast.warning { background-color: #ffa000; color: #333; border-left: 5px solid #ff6f00; }
.toast.info { background-color: #1976D2; border-left: 5px solid #0D47A1; }

@keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
@keyframes fadeOutUp {
    to { opacity: 0; transform: translateY(-20px); }
}

@media (max-width: 600px) {
    .toast-container { right: 10px; left: 10px; top: 10px; }
    .toast { width: 100%; box-sizing: border-box; }
}

/* --- MODAL DE CONFIRMAÇÃO GLOBAL --- */
#modalConfirmacaoGlobal .modal-content {
    text-align: center;
    max-width: 350px;
}
#modalConfirmacaoGlobal h3 {
    margin-top: 0;
    color: #333;
}
#modalConfirmacaoGlobal p {
    font-size: 16px;
    color: #555;
    margin: 20px 0;
}
/* --- fim de NOTIFICAÇÕES (TOASTS) --- */


/* --- CORREÇÃO: BOTÃO "NÃO" VISÍVEL --- */
#btnCancelarConf, 
#btnCancelarInput {
    background-color: #6c757d !important; /* Cinza Escuro Sólido */
    color: white !important;               /* Texto Branco */
    border: none !important;               /* Sem borda */
    box-shadow: 0 2px 5px rgba(0,0,0,0.2) !important; /* Sombra leve para destacar do fundo */
}

/* Efeito ao passar o mouse */
#btnCancelarConf:hover, 
#btnCancelarInput:hover {
    background-color: #5a6268 !important; /* Cinza um pouco mais escuro */
    transform: scale(1.05);               /* Leve zoom */
}
/* --- fim de CORREÇÃO: BOTÃO "NÃO" VISÍVEL --- */


/* ============================================================ */
/* === MODO ESCURO (DARK MODE) E BOTÃO DE TEMA - CORRIGIDO === */
/* ============================================================ */

/* 1. Botão Flutuante (Estado Padrão / Modo Claro) */
/* Fundo ESCURO para contrastar com a página branca */
#theme-toggle-button {
    position: fixed;
    bottom: 45px;
    right: 5px;
    
    /* --- ALTERE AQUI PARA DIMINUIR --- */
    width: 50px;       
    height: 50px;       /* (Mantenha igual à largura para ser redondo) */
    font-size: 24px;    /* (Diminua o ícone proporcionalmente) */
    /* -------------------------------- */
    
    border-radius: 50%;
    
    /* ... mantenha o restante das cores igual ... */
    background-color: #333 !important; 
    color: white !important;
    border: none;
    cursor: pointer;
    z-index: 10001;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    transition: transform 0.3s ease, background-color 0.3s;
}
#theme-toggle-button:hover { transform: scale(1.1); }

/* 2. Ajuste do botão quando o MODO ESCURO está ativo */
/* Fundo CLARO para contrastar com a página preta */
body.dark-mode #theme-toggle-button {
    background-color: #f1f1f1 !important;
    color: #333 !important;
    box-shadow: 0 2px 10px rgba(255,255,255,0.2); 
}

/* 3. A REGRA PRINCIPAL: Fundo do Site */
body.dark-mode {
    background-color: #121212 !important; /* Fundo Preto */
    color: #e0e0e0 !important;            /* Texto Claro */
}

/* 4. Correção do Rodapé (Botão Salvar) */
body.dark-mode .botao-salvar {
    background-color: #1e1e1e !important; 
    border-top: 1px solid #444 !important; 
    box-shadow: 0 -2px 10px rgba(0,0,0,0.5) !important; 
}

/* 5. Containers e Cartões */
body.dark-mode .form-container,
body.dark-mode .modal-content,
body.dark-mode .modal-content-reserva,
body.dark-mode .tabela-horarios-scroll, 
body.dark-mode .lista-dias-scroll,
body.dark-mode #containerListaDiasEspeciais {
    background-color: #1e1e1e !important;
    color: #e0e0e0 !important;
    border-color: #444 !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5) !important;
}

/* 6. Inputs e Selects */
body.dark-mode input,
body.dark-mode select,
body.dark-mode textarea {
    background-color: #2d2d2d !important;
    color: #fff !important;
    border: 1px solid #555 !important;
}

/* Correção do Foco no Modo Escuro (Substitui o fundo branco forçado) */
body.dark-mode select:focus,
body.dark-mode input:focus,
body.dark-mode textarea:focus {
    background-color: #333 !important; /* Fundo cinza escuro */
    border-color: #fff !important;     /* Borda branca */
    color: #fff !important;
}

/* 7. Tabelas */
body.dark-mode .tabela-config-horarios th {
    background-color: #2c2c2c !important;
    color: #ccc !important;
    border-bottom: 1px solid #444;
}
body.dark-mode .tabela-config-horarios td {
    border-bottom: 1px solid #444;
    color: #ddd;
}

/* 8. Abas (Tabs) */
body.dark-mode .tab {
    color: #aaa;
}
body.dark-mode .tab:hover {
    color: #fff;
}
body.dark-mode .tab.active {
    color: #4dabf7; /* Azul claro */
    border-bottom-color: #4dabf7;
}

/* 9. Textos e Títulos */
body.dark-mode h2, body.dark-mode h3, body.dark-mode label {
    color: #e0e0e0 !important;
}
body.dark-mode .title-container span {
    color: #fff;
}

/* 10. Linhas Especiais e Detalhes */
    body.dark-mode .linha-dia-especial {
        background-color: #1e1e1e !important;
        border-bottom: 1px solid #444 !important;
    }
    body.dark-mode .linha-dia-especial:hover {
        background-color: #2a2a2a !important;
    }
    body.dark-mode .linha-dia-especial .dia-label {
        color: #4dabf7 !important;
    }
    
    /* CORREÇÃO: Linha Fechada no Modo Escuro (Fundo avermelhado elegante) */
    body.dark-mode .linha-dia-especial.fechado {
        background-color: #3d1a1a !important; 
    }
    body.dark-mode .linha-dia-especial.fechado:hover {
        background-color: #4a2222 !important; 
    }

/* 11. Painéis de Destaque (Amarelo/Azul) */
body.dark-mode .painel-regra-mestra {
    background-color: #332b00 !important; /* Amarelo muito escuro */
    border-color: #665c00 !important;
}
body.dark-mode .painel-destaque {
    background-color: #0d2b42 !important; /* Azul muito escuro */
    border-color: #1a4f75 !important;
}
body.dark-mode .painel-destaque label {
    color: #ccc !important;
}

/* 12. Botões Desabilitados */
body.dark-mode button:disabled {
    background-color: #444 !important;
    color: #888 !important;
}

/* 13. Modal de Permissões */
body.dark-mode .header-flex-smart {
    border-bottom-color: #444;
}
body.dark-mode #textoNomePerfil {
    color: #fff;
}
body.dark-mode .btn-lapis {
    filter: brightness(1.2); /* Deixa o emoji mais brilhante */
}

/* 14. Modal Aulas */
body.dark-mode .quadra-tab {
    background-color: #333;
    border-color: #555;
    color: #ccc;
}

body.dark-mode .painel-controle-aulas {
    background-color: #252525 !important;
    border-color: #444 !important;
}
body.dark-mode #tituloAulaQuadra {
    color: #fff;
}
body.dark-mode .tabela-aulas th {
    background-color: #2c2c2c;
    color: #ddd;
    border-color: #444;
}
body.dark-mode .tabela-aulas td {
    border-color: #444;
    color: #ddd;
}
body.dark-mode .tabela-aulas td:first-child,
body.dark-mode .tabela-aulas td:last-child {
    background-color: #1e1e1e;
}
body.dark-mode .aula-cell-livre {
    background-color: #1e1e1e;
}
body.dark-mode .aula-cell-livre:hover {
    background-color: #333;
}
body.dark-mode .aula-cell-bloqueada {
    background-color: #333 !important;
}
/* --- CORREÇÃO: "ACESSO TOTAL" VISÍVEL NO MODO ESCURO --- */
body.dark-mode #permissoesSelect:disabled {
    color: #ffffff !important;                   /* Texto Branco */
    -webkit-text-fill-color: #ffffff !important; /* Garante branco no Chrome/Safari mobile */
    opacity: 1 !important;                       /* Remove transparência de desabilitado */
    font-weight: bold !important;
}


/* ============================================================ */
/* === FIM DE MODO ESCURO (DARK MODE) E BOTÃO DE TEMA === */
/* ============================================================ */



/* ============================================================ */
/* === BOTÃO SALVAR (RODAPÉ) - POSIÇÃO FIXA E VISUAL MODERNO === */
/* ============================================================ */

/* 1. O CONTAINER (A faixa branca/preta) */
/* Mantemos a posição fixa no rodapé, sem inventar moda */
.botao-salvar {
    position: fixed !important;
    bottom: 0 !important;
    left: 0 !important;
    width: 100% !important;
    
    display: flex !important;
    justify-content: center !important; /* Centraliza o botão na faixa */
    align-items: center !important;
    
    padding: 10px 0 !important; /* Espaço para o botão respirar */
    background: white;          /* Cor base (o Dark Mode cuida do resto) */
    
    box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1) !important;
    z-index: 1000 !important;
    
    margin: 0 !important; /* Garante que não suba nem desça */
}

/* 2. O BOTÃO EM SI (Onde acontece a mágica) */
/* Aqui aumentamos a largura e deixamos bonito */
.botao-salvar button {
    /* TAMANHO: Ocupa quase toda a largura (efeito esquerda-direita) */
    width: 96% !important;
    max-width: 800px !important; /* Trava no PC para não ficar infinito */
    height: 40px !important;     /* Altura confortável */
    
    /* VISUAL MODERNO */
    background-color: #28a745 !important; /* Verde vivo */
    color: white !important;
    font-size: 16px !important;
    font-weight: normal !important;
    text-transform: none !important; 
    letter-spacing: normal !important;
    
    border: none !important;
    border-radius: 8px !important; /* Cantos arredondados */
    box-shadow: 0 4px 6px rgba(0,0,0,0.1) !important;
    
    cursor: pointer !important;
    transition: transform 0.1s, background-color 0.2s !important;
    
    /* Remove margens antigas do botão */
    margin: 0 !important; 
    display: block !important;
}

/* Efeito de Clique */
.botao-salvar button:active {
    transform: scale(0.98) !important;
    box-shadow: 0 2px 3px rgba(0,0,0,0.1) !important;
}
/* ============================================================ */
/* === fim de BOTÃO SALVAR (RODAPÉ) - POSIÇÃO FIXA E VISUAL MODERNO === */
/* ============================================================ */



/* ============================================================ */
/* === CORREÇÃO SUPREMA: CORES ON/OFF (INÍCIO E CLIQUE) === */
/* ============================================================ */

/* --- 1. SISTEMA (Fundo Colorido) --- */
/* Aplica ao estado normal E ao foco/clique */
#sistema.on, 
#sistema.on:focus { 
    background-color: green !important; 
    color: white !important; 
    border-color: green !important;
}

#sistema.off, 
#sistema.off:focus { 
    background-color: red !important; 
    color: white !important; 
    border-color: red !important;
}

/* --- 2. OUTROS CAMPOS (Texto Colorido) --- */
/* Lista completa de classes ON (Verde) */
.confirmacao-on, .confirmacao-on:focus,
.edicao-on, .edicao-on:focus,
.quebra-on, .quebra-on:focus {
    color: green !important; 
    font-weight: bold !important;
    background-color: white !important; 
}

/* Lista completa de classes OFF (Vermelho) */
.confirmacao-off, .confirmacao-off:focus,
.edicao-off, .edicao-off:focus,
.quebra-off, .quebra-off:focus {
    color: red !important;
    font-weight: bold !important;
    background-color: white !important; 
}

/* --- 3. AJUSTES ESPECÍFICOS PARA MODO ESCURO --- */
/* Aqui trocamos as cores para versões que funcionam no fundo preto */

/* Sistema no Escuro */
body.dark-mode #sistema.on, 
body.dark-mode #sistema.on:focus { 
    background-color: #2E7D32 !important; 
    border-color: #1b5e20 !important;
}
body.dark-mode #sistema.off, 
body.dark-mode #sistema.off:focus { 
    background-color: #c62828 !important; 
    border-color: #b71c1c !important;
}

/* Outros Campos no Escuro (Texto Neon + Fundo Cinza) */
body.dark-mode .confirmacao-on, body.dark-mode .confirmacao-on:focus,
body.dark-mode .edicao-on, body.dark-mode .edicao-on:focus,
body.dark-mode .quebra-on, body.dark-mode .quebra-on:focus {
    color: #69f0ae !important;            
    background-color: #2d2d2d !important; 
}

body.dark-mode .confirmacao-off, body.dark-mode .confirmacao-off:focus,
body.dark-mode .edicao-off, body.dark-mode .edicao-off:focus,
body.dark-mode .quebra-off, body.dark-mode .quebra-off:focus {
    color: #ff5252 !important;            
    background-color: #2d2d2d !important; 
}
}
/* ============================================================ */
/* === FIM DE CORREÇÃO SUPREMA: CORES ON/OFF (INÍCIO E CLIQUE) === */
/* ============================================================ */



/* --- BOTÃO DE COR INTELIGENTE (ESTILO CÍRCULO) --- */
.botao-cor-custom {
    width: 24px;             /* Um pouco menor */
    height: 24px;
    border-radius: 50%;      /* Círculo perfeito */
    border: 2px solid #ffffff; /* Borda branca interna para destaque */
    outline: 1px solid #ccc;   /* Borda fina externa */
    cursor: pointer;
    background-color: #007bff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    transition: transform 0.1s;
    flex-shrink: 0;          /* Impede que o botão amasse */
}
.botao-cor-custom:active { transform: scale(0.90); }

/* --- MODAL DA GRADE DE CORES (SÓ PARA PC) --- */ 
#modalSeletorPC .modal-content {
    max-width: 320px;
    text-align: center;
}
.grid-cores-pc {
    display: grid;
    grid-template-columns: repeat(5, 1fr); /* 5 por linha */
    gap: 15px;
    justify-items: center;
    margin-top: 15px;
}
.dot-pc {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    transition: transform 0.2s;
}
.dot-pc:hover { transform: scale(1.15); border-color: #333; }

/* --- FIM DE BOTÃO DE COR INTELIGENTE --- */



/* --- FIXAR BOTÕES NO RODAPÉ (GRADE DE AULAS) --- */

/* 1. Transforma a janela em uma coluna flexível */
#modalHorarioAulas .modal-content {
    display: flex !important;
    flex-direction: column !important;
    max-height: 90vh !important; /* Garante que cabe na tela sem estourar */
    overflow: hidden !important; /* Remove a barra de rolagem da janela inteira */
    padding-bottom: 10px !important; /* Espaço extra no fundo */
}

/* 2. Faz a Tabela ocupar todo o espaço do meio e rolar sozinha */
#modalHorarioAulas .tabela-horarios-scroll {
    flex: 1 !important;          /* Cresce para ocupar o vazio */
    overflow-y: auto !important; /* Cria rolagem APENAS aqui dentro */
    max-height: none !important; /* Remove limites antigos */
    min-height: 0 !important;    /* Correção técnica para Flexbox */
    border-bottom: 1px solid #eee; /* Linha sutil separando dos botões */
}

/* 3. Fixa os Botões no fundo */
#modalHorarioAulas .modal-buttons {
    flex-shrink: 0 !important;   /* Impede que os botões sejam esmagados */
    margin-top: 10px !important; 
    padding-top: 5px !important;
    background-color: white !important; /* Fundo sólido para garantir leitura */
    z-index: 10;
}
/* --- FIIM DE FIXAR BOTÕES NO RODAPÉ (GRADE DE AULAS) --- */


/* --- CORREÇÃO TELA CHEIA (PC) - GRADE DE AULAS --- */
/* ESTE BLOCO SÓ RODA NO COMPUTADOR AGORA */
@media (min-width: 601px) {

    /* 1. O MODAL: Ocupa tudo e zera espaços */
    #modalHorarioAulas .modal-content.maximizado {
        width: 100vw !important;
        height: 100vh !important;
        max-width: none !important;
        max-height: none !important;
        
        top: 0 !important;
        left: 0 !important;
        margin: 0 !important;
        border: none !important;
        border-radius: 0 !important;
        
        padding: 0 !important; 
        padding-bottom: 0 !important;
        
        background-color: #fff !important;
        
        display: flex !important;
        flex-direction: column !important;
        z-index: 2147483647 !important;
    }

    /* 2. O TÍTULO: Branco, Sem Linha e Colado em Cima */
    #modalHorarioAulas .modal-content.maximizado #tituloAulaQuadra {
        flex: 0 0 auto !important;
        margin: 0 !important;        
        padding: 5px 0 10px 0 !important; 
        text-align: center;
        
        background-color: #fff !important; 
        color: #333 !important;
        font-size: 18px !important;
        font-weight: bold !important;
        
        border: none !important; 
        border-bottom: none !important;
    }

    /* 3. A ÁREA DE ROLAGEM: Ocupa o resto */
    #modalHorarioAulas .modal-content.maximizado .tabela-horarios-scroll {
        flex: 1 1 auto !important;
        height: auto !important;
        max-height: none !important;
        overflow-y: auto !important;
        
        margin: 0 !important;
        padding: 0 !important;
        border: none !important;
        background-color: #fff !important;
    }

    /* 4. A TABELA */
    #modalHorarioAulas .modal-content.maximizado .tabela-aulas {
        width: 100% !important;
        margin-bottom: 0 !important;
        border-bottom: none !important;
    }

    /* 5. CABEÇALHO DAS ABAS (Mantido o ajuste anterior) */
    #modalHorarioAulas .modal-content.maximizado .quadras-tabs-container {
        flex: 0 0 auto !important;
        width: 100%;
        padding: 5px 5px 0 5px !important; 
        background-color: #fff !important; 
        margin-bottom: 0 !important;
        border: none !important;
    }

    /* 6. ESCONDER ITENS DESNECESSÁRIOS */
    .modal-content.maximizado .painel-controle-aulas,
    .modal-content.maximizado .modal-buttons,
    .modal-content.maximizado .cabecalho-modal-aulas,
    .modal-content.maximizado .modal-footer {
        display: none !important;
    }

} /* FIM DO @MEDIA PC */
/* --- FIM DE CORREÇÃO TELA CHEIA (PC) - GRADE DE AULAS --- */


/* --- CORREÇÃO: FUNDO DOS BOTÕES GRADE DE AULAS (MODO ESCURO) --- */
body.dark-mode #modalHorarioAulas .modal-buttons {
    background-color: #1e1e1e !important; /* Mesma cor de fundo do modal escuro */
    border-top: 1px solid #333 !important; /* Uma linha sutil para acabamento */
}
/* --- FIM DE CORREÇÃO: FUNDO DOS BOTÕES GRADE DE AULAS (MODO ESCURO) --- */



/* --- ANIMAÇÃO DE ALERTA PARA O BOTÃO SALVAR --- */
@keyframes pulse-alert {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 69, 58, 0.7); }
    70% { transform: scale(1.02); box-shadow: 0 0 0 15px rgba(255, 69, 58, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 69, 58, 0); }
}

#btnSalvarGlobal.botao-alterado {
    background-color: #ff3b30 !important; 
    color: white !important;
    border: 2px solid #ffcccc !important;
    animation: pulse-alert 1.5s infinite;
}
/* --- fim de ANIMAÇÃO DE ALERTA PARA O BOTÃO SALVAR --- */

/* Classe para os slots de duplas selecionados na grade */
.dupla-cell-marcada {
    background-color: #ff3b30 !important;
    color: white !important;
    font-weight: normal;
    cursor: pointer;
}


/* Força a cor VERDE para os botões de Duplas quando ativos */
    #btn-duplas-q1.active,
    #btn-duplas-q2.active,
    #btn-duplas-q3.active {
        background-color: #4CAF50 !important;
        color: white !important;
        border-color: #4CAF50 !important;
    }

    /* Força a cor VERDE para os botões de Aulas quando ativos */
    #btn-aula-q1.active,
    #btn-aula-q2.active,
    #btn-aula-q3.active {
        background-color: #4CAF50 !important;
        color: white !important;
        border-color: #4CAF50 !important;
    }
/* Força a cor VERDE para os botões de Duplas quando ativos */



/* Painel de controle de duplas com o mesmo visual de aulas */
/* 6. CORREÇÃO DO PAINEL (AGORA CINZA IGUAL AULAS) */
/* --- CORREÇÃO FINAL: PAINEL DE DUPLAS IDÊNTICO A AULAS --- */
/* --- CORREÇÃO FINAL: ALINHAMENTO E CENTRALIZAÇÃO --- */

/* 1. A Caixa Cinza (Container Principal) */
.painel-controle-duplas {
    background-color: #f8f9fa !important;
    border: 1px solid #eee !important;
    border-radius: 8px !important;
    
    /* DEFINIÇÃO DE ALTURA SEGURA */
    /* Em vez de height fixa, usamos padding vertical para centralizar */
    padding: 6px 10px !important;  
    width: 100% !important;
    box-sizing: border-box !important;
    margin-bottom: 10px !important;

    /* FLEXBOX CENTRALIZADOR */
    display: flex !important;
    align-items: center !important;       /* Centraliza Verticalmente */
    justify-content: flex-end !important; /* Alinha à Direita */
}

/* 2. O Container Interno (Removemos margens que empurravam para baixo) */
.painel-controle-duplas .linha-unica-flex {
    display: flex !important;
    align-items: center !important;
    justify-content: flex-end !important;
    width: 100% !important;
    margin: 0 !important;  /* Zera margem para não vazar */
    padding: 0 !important; /* Zera padding */
}

/* 3. O Grupo de Botões */
.painel-controle-duplas .grupo-botoes {
    display: flex !important;
    align-items: center !important;
    gap: 10px !important;
    margin: 0 !important; /* Garante que o grupo não tenha margem */
}

/* 4. Estilo dos Botões */
.painel-controle-duplas .btn-mini {
    /* O COMANDO IMPORTANTE: Remove a trava de largura mínima */
    min-width: auto !important;  
    width: auto !important;
    
    height: 36px !important;
    padding: 0 15px !important;  /* Ajuste aqui a largura: 10px é padrão, 5px é bem justo */
    font-size: 15px !important;
    
    border-radius: 4px !important;
    cursor: pointer !important;
    white-space: nowrap !important;
    font-weight: normal !important;
    margin: 0 !important;
    
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
}

/* 5. Cores dos Botões */
.painel-controle-duplas .grupo-botoes button:first-child {
    background-color: #007bff !important; /* Azul */
    color: white !important;
    border: none !important;
}

.painel-controle-duplas .grupo-botoes button:last-child {
    background-color: white !important;
    color: #333 !important;
    border: 1px solid #ccc !important; /* Borda cinza */
}
/* fim de Painel de controle de duplas com o mesmo visual de aulas */



/* ================================================================= */
/* ===         BLOCO EXCLUSIVO DE ESTILOS: HORÁRIO DE DUPLAS      === */
/* ================================================================= */

/* --- 1. ESTRUTURA GERAL --- */
#modalHorarioDuplas .modal-content {
    display: flex !important;
    flex-direction: column !important;
    max-height: 90vh !important;
    overflow: hidden !important;
    padding-bottom: 0 !important;
}

/* --- AJUSTE DE SCROLL INTELIGENTE (RESPONSIVO) --- */
#modalHorarioDuplas .tabela-horarios-scroll {
    display: block !important;
    flex: 1 1 auto !important;    /* O SEGREDO: Faz a tabela ocupar apenas o espaço que sobra */
    overflow-y: auto !important;   /* Scroll vertical interno */
    overflow-x: auto !important;   /* Scroll horizontal para o celular */
    -webkit-overflow-scrolling: touch; /* Suaviza o scroll no iPhone */
    
    height: auto !important;       /* Libera a altura fixa */
    max-height: none !important;   /* Remove travas de pixels */
    min-height: 0 !important;      /* Essencial para o Flexbox encolher no celular */
    
    border-bottom: none !important;
}

/* --- 2. HIERARQUIA DE CAMADAS (FIX PARA O MENU FICAR POR CIMA) --- */

/* O Cabeçalho precisa estar NUMA CAMADA ACIMA (20) para o menu cobrir os botões */
.cabecalho-modal-duplas {
    flex-shrink: 0 !important;
    width: 100% !important;
    z-index: 20 !important; /* Mais alto que o resto */
}

/* Os outros itens fixos ficam na camada base (10) */
#modalHorarioDuplas .quadras-tabs-container,
.painel-controle-duplas,
#tituloDuplasQuadra, 
#modalHorarioDuplas .modal-buttons {
    flex-shrink: 0 !important; 
    width: 100% !important;
    z-index: 10 !important;
}

/* --- 3. CORES E REMOÇÃO DE LINHAS --- */

/* Elementos Brancos */
.cabecalho-modal-duplas,
#modalHorarioDuplas .quadras-tabs-container,
#modalHorarioDuplas .modal-buttons,
#tituloDuplasQuadra {
    background-color: white !important;
}

/* Painel de Controle (Cinza) */
.painel-controle-duplas { 
    background-color: #f8f9fa !important; 
}

/* Cabeçalho: Ajuste de altura e remoção de bordas */
.cabecalho-modal-duplas {
    position: relative !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    height: 55px !important;
    border-bottom: none !important;
    margin-bottom: 0 !important;
    padding: 0 !important; 
}

/* Título: Alinhamento preciso */
.cabecalho-modal-duplas h2 {
    margin: 0 !important;
    padding: 0 !important;
    line-height: 1 !important; 
    display: inline-block !important;
	border-bottom: none !important; /* Barreira contra a linha indesejada */
}

/* Container das Quadras: Sem borda superior (Remove a linha cinza) */
#modalHorarioDuplas .quadras-tabs-container {
    border: none !important;        
    border-top: none !important;
    box-shadow: none !important;    
    margin-top: 0 !important;
    padding-top: 5px !important;    
}

/* Título Secundário (Quadra X - Coberta) */
#tituloDuplasQuadra {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    height: 30px !important;
    padding: 0 !important;
    margin: 0 !important;
    border: none !important;        /* Remove TODAS as bordas */
    border-bottom: none !important; /* Garante que a linha de baixo suma */
    background-color: white !important;
}

/* --- 4. BOTÃO KEBAB (ALINHAMENTO À DIREITA) --- */
.kebab-menu-container {
    position: absolute !important;
    right: 0px !important; /* Colado na margem direita */
    top: 50% !important;
    transform: translateY(-50%) !important;
    z-index: 1010 !important;
    margin: 0 !important;
    padding: 0 !important;
    height: 40px !important; 
    display: flex !important;
    align-items: center !important;
}

.btn-kebab {
    background: transparent !important;
    border: none !important;
    width: 40px !important;
    height: 40px !important;
    border-radius: 50% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    cursor: pointer !important;
    padding: 0 !important;
    margin: 0 !important;
}

/* Ícone ⋮ */
.btn-kebab::before {
    content: "\22EE" !important;
    font-size: 26px !important;
    color: #888 !important;
    line-height: 1 !important;
}

/* --- 5. MENU DROPDOWN (ESTILO SÚMULA - CORRIGIDO FINAL) --- */
.menu-dropdown-sumula {
    display: none; 
    position: absolute !important;
    right: 0px !important;
    top: 45px !important;
    background-color: white !important;
    min-width: 210px !important;
    box-shadow: 0px 8px 24px rgba(0,0,0,0.15) !important;
    border-radius: 12px !important;
    border: 1px solid #eee !important;
    z-index: 1100 !important;
    padding: 8px 0 !important; 
}

.menu-item-sumula {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    padding: 12px 20px !important;
    /* Removemos fontes daqui para definir apenas no span e evitar confusão */
}

/* AQUI ESTAVA O ERRO: AGORA CORRIGIDO PARA ROBOTO E NEGRITO */
.menu-item-sumula span {
    font-family: 'Roboto', sans-serif !important; /* MUDADO: Agora sim usa a fonte certa */
    font-weight: 700 !important;                  /* MUDADO: 700 é o Negrito da imagem */
    font-size: 15px !important;
    color: #333 !important;
    letter-spacing: normal !important;
}

/* --- 6. SWITCHES --- */
.switch-sumula {
    position: relative !important;
    display: inline-block !important;
    width: 38px !important;
    height: 20px !important;
}

.switch-sumula input { opacity: 0; width: 0; height: 0; }

.slider-sumula {
    position: absolute !important;
    cursor: pointer !important;
    top: 0; left: 0; right: 0; bottom: 0 !important;
    background-color: #ccc !important;
    transition: .3s !important;
    border-radius: 20px !important;
}

.slider-sumula:before {
    position: absolute !important;
    content: "" !important;
    height: 14px !important;
    width: 14px !important;
    left: 3px !important;
    bottom: 3px !important;
    background-color: white !important;
    transition: .3s !important;
    border-radius: 50% !important;
}

input:checked + .slider-sumula { background-color: #4CAF50 !important; }
input:checked + .slider-sumula:before { transform: translateX(18px) !important; }

/* --- 7. TELA CHEIA (MAXIMIZADO) --- */
#modalHorarioDuplas .modal-content.maximizado {
    width: 100vw !important; 
    height: 100dvh !important; /* dVH corrigido */
    max-height: 100dvh !important; 
    border-radius: 0 !important;
    padding: 10px !important; 
    top: 0 !important; 
    left: 0 !important;
    display: flex !important;
    flex-direction: column !important;
}

#modalHorarioDuplas .modal-content.maximizado .cabecalho-modal-duplas,
#modalHorarioDuplas .modal-content.maximizado .painel-controle-duplas,
#modalHorarioDuplas .modal-content.maximizado .modal-buttons {
    display: none !important;
}

#modalHorarioDuplas .modal-content.maximizado .quadras-tabs-container {
    padding-top: 10px !important;
    background-color: white !important;
}

/* --- EFEITO FANTASMA E BLOQUEIO (QUANDO DESATIVADO) --- */
.duplas-desativadas {
    opacity: 0.5 !important;
    filter: grayscale(100%) !important;
    transition: all 0.3s ease !important;
    
    /* AQUI ESTÁ O SEGREDO: */
    /* Isso impede qualquer clique na tabela. O mouse não interage mais. */
    pointer-events: none !important; 
}


/* --- BOTÃO DESATIVADO (FOCO EM SELECIONAR E LIMPAR) --- */
.btn-acao-desativado {
    background-color: #f9f9f9 !important; /* Branco "sujo" quase cinza */
    color: #cccccc !important;            /* Texto muito claro, difícil de ler */
    border: 1px solid #eeeeee !important; /* Borda quase invisível */
    opacity: 0.6 !important;              /* Efeito de transparência */
    cursor: not-allowed !important;       /* Ícone de 'proibido' no mouse */
    pointer-events: none !important;      /* Impede qualquer clique ou hover */
    box-shadow: none !important;          /* Remove qualquer sombra de botão ativo */
    transform: none !important;           /* Impede efeitos de clique/pressão */
}

/* --- AJUSTES PARA CELULAR E MODO MAXIMIZADO (RESPONSIVIDADE) --- */
@media (max-width: 768px) {
    /* Ajusta o Modal para não vazar da tela no celular */
    #modalHorarioDuplas .modal-content {
        padding: 5px !important;
        height: 98dvh !important; /* dVH ignora a barra do navegador */
        max-height: 98dvh !important;
    }

    /* Diminui o cabeçalho para ganhar espaço vertical, mas acomoda a fonte maior */
    .cabecalho-modal-duplas {
        height: 45px !important; /*  AUMENTAMOS de 40px para 45px para o texto respirar */
    }

    .cabecalho-modal-duplas h2 {
        font-size: 1.5rem !important; /*  AUMENTAMOS A FONTE DE 1.1rem para 1.5rem (cerca de 24px) */
    }

    /* Ajusta os botões Quadra 1, 2, 3 para caberem sem apertar o resto */
    #modalHorarioDuplas .quadras-tabs-container,
    #modalHorarioPiramide .quadras-tabs-container { /* Já protegemos a Pirâmide também! */
        display: flex !important;
        gap: 5px !important;
        padding: 5px 2px !important;
		margin-top: -8px !important;
    }

    #modalHorarioDuplas .quadras-tabs-container button,
    #modalHorarioPiramide .quadras-tabs-container button {
        flex: 1 !important;
        padding: 8px 2px !important;
        font-size: 15px !important;     /*  AUMENTAMOS A FONTE PARA 15px! */
        white-space: normal !important; /*  PERMITE A QUEBRA DE LINHA (Igual à tela de Aulas) */
        height: auto !important;
    }

    /* Painel de controle (Selecionar/Limpar) mais compacto */
    .painel-controle-duplas {
        padding: 5px !important;
        gap: 5px !important;
    }

    /* Aumenta a fonte do "Ativar" nas telas de Duplas e Pirâmide */
    .painel-controle-duplas label span {
        font-size: 16px !important; /*  AUMENTAMOS AQUI PARA 16px (Padrão Aulas) */
    }
}
/* --- AJUSTES PARA CELULAR E MODO MAXIMIZADO (RESPONSIVIDADE) --- */


/* ================================================================= */
/* ===  fim de BLOCO EXCLUSIVO DE ESTILOS: HORÁRIO DE DUPLAS  === */
/* ================================================================= */



/* ================================================================= */
/* ===       BLOCO EXCLUSIVO DE ESTILOS: HORÁRIO DE PIRÂMIDE     === */
/* ================================================================= */

#modalHorarioPiramide .modal-content {
    display: flex !important;
    flex-direction: column !important;
    max-height: 90vh !important;
    width: 95% !important;
    max-width: 900px !important;
    overflow: hidden !important;
    /* AJUSTE AQUI: Reduzi o último valor (bottom) para 10px para aproximar da borda */
    padding: 15px 20px 0px 20px !important; 
    background-color: #ffffff !important;
}

/* --- CABEÇALHO (Título e Pontinhos ) --- */
#modalHorarioPiramide .cabecalho-modal-duplas {
    display: flex !important;
    align-items: center !important;     
    justify-content: center !important; 
    position: relative !important;
    
    /* ALTERAÇÃO 1: Força a altura da barra para 35px */
    min-height: 45px !important;
    height: 45px !important;
    
    /* ALTERAÇÃO 2: Diminui o espaço até a tabela */
    margin-bottom: 10px !important;
    
    border: none !important;            
    padding: 0 !important;              
}

#modalHorarioPiramide .cabecalho-modal-duplas h2 {
    margin: 0 !important;
    padding: 0 !important;
    line-height: 1 !important;
    color: #333 !important;
    font-size: 1.5rem !important;
    display: inline-block !important;
    border-bottom: none !important; /* REMOVE A LINHA INFERIOR MISTERIOSA */
}

/* ALTERAÇÃO 3: A caixa do botão DEVE ter a mesma altura da barra (35px) para não esticar */
#modalHorarioPiramide .kebab-menu-container {
    position: absolute !important;
    right: 0 !important;
    top: 50% !important;
    transform: translateY(-50%) !important; 
    z-index: 10 !important;
    
    /* Força a caixa do botão a caber no espaço reduzido */
    height: 35px !important; 
    width: 35px !important; 
}
/* -------------------------------------------------- */

/* PLANILHA: Fonte 14px, SEM negrito e AGORA DESBLOQUEADA */
#modalHorarioPiramide .tabela-horarios-scroll {
    display: block !important;
    flex: 1 1 auto !important;
    overflow-y: auto !important;
    border: none !important;
    border-radius: 4px !important;

    /* --- CORREÇÃO: FORÇA A PLANILHA A INICIAR DESBLOQUEADA --- */
    opacity: 1 !important;           /* Garante opacidade total */
    filter: none !important;         /* Remove filtro cinza/grayscale */
    pointer-events: auto !important; /* Garante que o clique funcione */
	max-height: none !important;
}

/* COLUNAS LATERAIS (HORÁRIOS): AGORA COM FUNDO BRANCO */
#modalHorarioPiramide .tabela-config-horarios td.sem-selecao {
    background-color: #ffffff !important; /* MUDADO: De cinza (#f2f2f2) para BRANCO (#ffffff) */
    color: #666 !important;              
    font-weight: normal !important;      
    font-size: 14px !important;
    padding: 8px 5px !important;
    border: 1px solid #ddd !important;
}

/* TÍTULO DA QUADRA */
#tituloPiramideQuadra {
    text-align: center !important;
    color: #333 !important; 
    margin: 2px 0 !important;
    font-weight: bold !important;
    font-size: 21px !important; /* MUDADO DE 16px PARA 21px */
}

/* BOTÕES DE AÇÃO - AJUSTADOS */
#modalHorarioPiramide .modal-buttons {
    display: flex !important;
    gap: 15px !important;
    margin-top: 15px !important; /* Reduzi levemente o topo também */
    padding: 0 !important;
    width: 100% !important;
}



/* ABAS DE QUADRAS */
#modalHorarioPiramide .quadras-tabs-container {
    margin-bottom: -10px !important;
}

/* ================================================================= */
/* === fim de BLOCO EXCLUSIVO DE ESTILOS: HORÁRIO DE PIRÂMIDE    === */
/* ================================================================= */



/* ================================================================= */
/* --- TELA CHEIA (MAXIMIZADO) - PIRÂMIDE                        --- */
/* ================================================================= */
#modalHorarioPiramide .modal-content.maximizado {
    width: 100vw !important; 
    height: 100vh !important; /* Usar vh puro garante a altura no PC */
    max-width: 100vw !important;
    max-height: 100vh !important; 
    margin: 0 !important;
    border-radius: 0 !important;
    padding: 2px 15px 15px 15px !important;
    top: 0 !important; 
    left: 0 !important;
    display: flex !important;
    flex-direction: column !important;
    box-sizing: border-box !important; /* O SEGREDO 1: Impede que o padding vaze a tela */
    background-color: #fff !important;
}

/* Esconde o cabeçalho, os botões Selecionar/Limpar e o rodapé */
#modalHorarioPiramide .modal-content.maximizado .cabecalho-modal-duplas,
#modalHorarioPiramide .modal-content.maximizado .painel-controle-duplas,
#modalHorarioPiramide .modal-content.maximizado .modal-buttons {
    display: none !important;
}

/* Garante que as abas fiquem visíveis no topo */
/* Garante que as abas fiquem visíveis no topo */
#modalHorarioPiramide .modal-content.maximizado .quadras-tabs-container {
    flex-shrink: 0 !important;
    padding-top: 5px !important;
    background-color: white !important;
    
    /* O SEGREDO 1: Margem negativa para PUXAR o título para mais perto dos botões */
    margin-bottom: -12px !important; 
}

/* O título (ex: Quadra 1 - Coberta) */
#modalHorarioPiramide .modal-content.maximizado #tituloPiramideQuadra {
    flex-shrink: 0 !important;
    
    /* O SEGREDO 2: Zera em cima e coloca margem embaixo para AFASTAR a planilha */
    margin-top: 0 !important; 
    margin-bottom: 10px !important; 
    
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
}

/* O SEGREDO 2: FORÇA A PLANILHA A ESTICAR E ELIMINA O ESPAÇO ACIMA DELA */
#modalHorarioPiramide .modal-content.maximizado .tabela-horarios-scroll {
    flex: 1 1 auto !important;   /* Faz crescer e comer o espaço vazio */
    height: auto !important;
    max-height: none !important; /* Tira qualquer trava antiga */
    min-height: 0 !important;    /* Permite o scroll perfeito no flexbox */
    overflow-y: auto !important;
    border: none !important;     /* Retira a linha também na tela cheia */
    padding-top: 0 !important;
    margin-top: 0 !important;
}

/* A MORTE DO VERDADEIRO VILÃO VERDE: Tira a margem da própria tabela lá dentro */
#modalHorarioPiramide .modal-content.maximizado .tabela-horarios-scroll table {
    margin-top: 0 !important;
}

/* ================================================================= */
/* --- fim de TELA CHEIA (MAXIMIZADO) - PIRÂMIDE                 --- */
/* ================================================================= */




/* ================================================================= */
/* --- AJUSTES MOBILE: JANELA E TELA CHEIA - PIRÂMIDE            --- */
/* ================================================================= */
@media (max-width: 600px) {
    
    /* 1. EXPANSÃO LATERAL GLOBAL (Mata o "fantasma" nas duas telas) */
    /* Remove a margem grossa tanto na janela normal quanto na maximizada */
    #modalHorarioPiramide .modal-content {
        width: 100% !important; 
        padding-left: 2px !important;
        padding-right: 2px !important;
		padding-top: 2px !important;
    }

    /* 2. Mantém o respiro do topo apenas quando estiver Maximizado */
    #modalHorarioPiramide .modal-content.maximizado {
        padding-top: 25px !important; 
    }

    /* 3. Zera a margem negativa, parando de puxar o título para cima dos botões */
    #modalHorarioPiramide .modal-content.maximizado .quadras-tabs-container {
        margin-bottom: 5px !important; 
    }

    /* 4. Reajusta as margens do título para o centro do novo espaço */
    #modalHorarioPiramide .modal-content.maximizado #tituloPiramideQuadra {
        margin-top: 5px !important; 
        margin-bottom: 10px !important; 
    }

    /* 5. RESPIRO DOS HORÁRIOS: Descola o "06:00 - 07:00" das linhas */
    /* Atacamos diretamente a regra travada para dar espaço ao texto */
    /* 5. RESPIRO DOS HORÁRIOS: Descola o "06:00 - 07:00" das linhas */
    /* Atacamos diretamente a regra travada para dar espaço ao texto */
    #modalHorarioPiramide .tabela-aulas th:first-child, 
    #modalHorarioPiramide .tabela-aulas td:first-child,
    #modalHorarioPiramide .tabela-aulas th:last-child, 
    #modalHorarioPiramide .tabela-aulas td:last-child {
        padding-left: 4px !important;
        padding-right: 4px !important;
        
        /* MUDE ESTES 4 VALORES ABAIXO: */
        font-size: 15px !important;   /* Era 13px */
        width: 95px !important;       /* Era 88px */
        min-width: 95px !important;   /* Era 88px */
        max-width: 95px !important;   /* Era 88px */
    }
}
/* ================================================================= */
/* ---  fim de AJUSTES MOBILE: JANELA E TELA CHEIA - PIRÂMIDE    --- */
/* ================================================================= */

/* ================================================================= */
/* --- BARRA DE ROLAGEM: TELA CHEIA (MAXIMIZADO) - PIRÂMIDE      --- */
/* ================================================================= */

/* Garante que o contêiner permita a rolagem se não couber no ecrã */
#modalHorarioPiramide .modal-content.maximizado .tabela-horarios-scroll {
    overflow-y: auto !important; 
}

/* Força o desenho visual da barra de rolagem customizada */
#modalHorarioPiramide .modal-content.maximizado .tabela-horarios-scroll::-webkit-scrollbar {
    width: 6px !important; /* Espessura da barra */
    display: block !important;
}

#modalHorarioPiramide .modal-content.maximizado .tabela-horarios-scroll::-webkit-scrollbar-track {
    background-color: #f1f1f1 !important; /* Cor do fundo da barra (trilho) */
    border-radius: 10px !important;
}

#modalHorarioPiramide .modal-content.maximizado .tabela-horarios-scroll::-webkit-scrollbar-thumb {
    background-color: #bbbbbb !important; /* Cor da barrinha que desce */
    border-radius: 10px !important;
}
/* ================================================================= */
/* --- FIM DA BARRA DE ROLAGEM: TELA CHEIA - PIRÂMIDE            --- */
/* ================================================================= */



/* ================================================================== */
/* --- CORREÇÕES DO MODO ESCURO - PIRÂMIDE E DUPLAS (UNIFICADO)   --- */
/* ================================================================== */

/* 1. Fundo dos Modais e Títulos */
body.dark-mode #modalHorarioPiramide .modal-content,
body.dark-mode #modalHorarioDuplas .modal-content {
    background-color: #1e1e1e !important;
}
body.dark-mode #modalHorarioPiramide .cabecalho-modal-duplas,
body.dark-mode #modalHorarioDuplas .cabecalho-modal-duplas {
    background-color: transparent !important;
}
body.dark-mode #modalHorarioPiramide h2,
body.dark-mode #modalHorarioDuplas h2 {
    color: #eee !important;
}
body.dark-mode #tituloPiramideQuadra,
body.dark-mode #tituloDuplasQuadra {
    color: #eee !important;
}

/* 2. Container das Abas das Quadras */
body.dark-mode #modalHorarioPiramide .quadras-tabs-container,
body.dark-mode #modalHorarioDuplas .quadras-tabs-container {
    background-color: #1e1e1e !important;
}
body.dark-mode #modalHorarioPiramide .quadra-tab:not(.active),
body.dark-mode #modalHorarioDuplas .quadra-tab:not(.active) {
    background-color: #333 !important;
    color: #ccc !important;
    border-color: #555 !important;
}

/* 3. A Barra Cinza de Controle (Ativar / Botões) */
body.dark-mode #modalHorarioPiramide .painel-controle-duplas,
body.dark-mode #modalHorarioDuplas .painel-controle-duplas {
    background-color: #2c2c2c !important;
    border-color: #444 !important;
}
body.dark-mode #checkboxAtivarQuadraPiramide:disabled + span,
body.dark-mode #checkboxAtivarQuadraDuplas:disabled + span {
    color: #777 !important;
}

/* 4. A Planilha de Horários */
body.dark-mode #modalHorarioPiramide .tabela-aulas th,
body.dark-mode #modalHorarioDuplas .tabela-aulas th {
    background-color: #2c2c2c !important;
    color: #eee !important;
    border-color: #444 !important;
}
body.dark-mode #modalHorarioPiramide .tabela-config-horarios td.sem-selecao,
body.dark-mode #modalHorarioDuplas .tabela-config-horarios td.sem-selecao {
    background-color: #252525 !important;
    color: #ccc !important;
    border-color: #444 !important;
}
body.dark-mode #modalHorarioPiramide .aula-cell-livre,
body.dark-mode #modalHorarioDuplas .aula-cell-livre {
    background-color: #1e1e1e !important;
    border-color: #333 !important;
}
body.dark-mode #modalHorarioPiramide .aula-cell-bloqueada,
body.dark-mode #modalHorarioDuplas .aula-cell-bloqueada {
    background-color: #2a2a2a !important;
    border-color: #333 !important;
}
/* Células Marcadas (Vermelho Adaptado para Escuro) */
body.dark-mode #modalHorarioPiramide .aula-cell-marcada,
body.dark-mode #modalHorarioDuplas .dupla-cell-marcada {
    background-color: #b71c1c !important; 
    color: #fff !important;
    border-color: #ff5252 !important;
}

/* 5. Botões Desativados (A "Capa Cinza") */
body.dark-mode #modalHorarioPiramide .btn-acao-desativado,
body.dark-mode #modalHorarioDuplas .btn-acao-desativado {
    background-color: #333 !important;
    color: #777 !important;
    border-color: #444 !important;
}

/* 6. Menus de 3 Pontinhos (Kebab) */
body.dark-mode #menuDropdownPiramide,
body.dark-mode #menuDropdownDuplas {
    background-color: #2c2c2c !important;
    border-color: #444 !important;
}
body.dark-mode #menuDropdownPiramide .menu-item-sumula span,
body.dark-mode #menuDropdownPiramide .menu-item-sumula div,
body.dark-mode #menuDropdownDuplas .menu-item-sumula span,
body.dark-mode #menuDropdownDuplas .menu-item-sumula div {
    color: #eee !important;
}
body.dark-mode #menuDropdownPiramide hr,
body.dark-mode #menuDropdownDuplas hr {
    border-top-color: #555 !important;
}
body.dark-mode #btnDataPiramideKebab {
    color: #66bb6a !important; 
}

/* 7. Caixinha Flutuante de Datas (Apenas Pirâmide) */
body.dark-mode #modalDataPiramide .modal-content {
    background-color: #1e1e1e !important;
    color: #eee !important;
    border-color: #444 !important;
}
body.dark-mode #modalDataPiramide h2,
body.dark-mode #modalDataPiramide label {
    color: #eee !important;
}
body.dark-mode #modalDataPiramide input[type="date"] {
    background-color: #2d2d2d !important;
    color: #fff !important;
    border: 1px solid #555 !important; 
    color-scheme: dark;
}
/* 1. Remove o fundo branco do Título da Quadra e do Rodapé (Botões) */
body.dark-mode #tituloDuplasQuadra,
body.dark-mode #modalHorarioDuplas .modal-buttons {
    background-color: transparent !important; 
}

/* 2. Prevenção: Garante que as abas não fiquem brancas caso você use a Tela Cheia */
body.dark-mode #modalHorarioDuplas .modal-content.maximizado .quadras-tabs-container {
    background-color: transparent !important;
}
/* ================================================================== */
/* --- FIM DE CORREÇÕES DO MODO ESCURO - PIRÂMIDE E DUPLAS        --- */
/* ================================================================== */



/* ================================================================== */
/* === TELA CHEIA NATIVA: AULAS, DUPLAS E PIRÂMIDE (MÁXIMA MOBILE)=== */
/* ================================================================== */
@media (max-width: 600px) {

    /* 1. Cola a janela no teto do ecrã */
    #modalHorarioAulas.modal-overlay,
    #modalHorarioDuplas.modal-overlay,
    #modalHorarioPiramide.modal-overlay {
        align-items: flex-start !important; 
        padding: 0 !important;       
    }

    /* 2. Força a caixa branca a esticar 100% até ao chão */
    #modalHorarioAulas .modal-content,
    #modalHorarioDuplas .modal-content,
    #modalHorarioPiramide .modal-content {
        width: 100vw !important;
        max-width: 100vw !important;
        
        /* Garantia tripla de altura máxima */
        height: 100% !important;        
        height: 100vh !important;       
        height: 100dvh !important;      
        max-height: none !important; 
        
        margin: 0 !important;
        border-radius: 0 !important;
        box-sizing: border-box !important;

        /* ATIVA O SISTEMA FLEX PARA PODER EMPURRAR OS BOTÕES */
        display: flex !important;
        flex-direction: column !important;
        
        /* O seu espaço de 10px no fundo mantido! */
        padding: 10px 5px 10px 5px !important;
    }

    /* 3. Remove margens invisíveis do rodapé e EMPURRA PRO CHÃO */
    #modalHorarioAulas .modal-buttons,
    #modalHorarioDuplas .modal-buttons,
    #modalHorarioPiramide .modal-buttons {
        margin-bottom: 0 !important;
        padding-bottom: 0 !important; 
        
        /* A MÁGICA: Empurra os botões para o espaço vazio lá embaixo */
        margin-top: auto !important; 
    }
}
/* ================================================================== */
/* === fim de TELA CHEIA NATIVA: AULAS, DUPLAS E PIRÂMIDE (FORÇA MÁXIMA) === */
/* ================================================================== */




/* ================================================================== */
/* === A SUA IDEIA: ENGANAR O CELULAR COM A LARGURA DAS 2 ABAS    === */
/* ================================================================== */
/* ================================================================== */
/* === AJUSTES EXCLUSIVOS PARA CELULAR (TELA ATÉ 768px)           === */
/* ================================================================== */
@media (max-width: 768px) {

    /* === A SUA IDEIA: ENGANAR O CELULAR COM A LARGURA DAS 2 ABAS === */
    .tabs {
        min-width: 430px !important; 
        display: flex !important;
        margin: 0 auto !important;
    }

    .tabs .tab {
        width: 215px !important; 
        flex: 0 0 215px !important;
        justify-content: center !important;
        text-align: center !important;
		font-size: 22px !important;
    }

    /* === ALINHAMENTO CIRÚRGICO À DIREITA E DESCOLA DAS BORDAS === */

    /* 1. DESCOLA DAS BORDAS: Aplica a todos os painéis (Cima e Baixo) */
    .form-container, 
    #reservas .form-container {
        width: 400px !important; 
        margin: 10px auto !important; 
        box-sizing: border-box !important;
    }

    /* 2. AUMENTA A LARGURA DAS CAIXINHAS DO PAINEL INFERIOR */
    #reservas .form-container .container select {
        flex: 0 0 130px !important; 
        width: 130px !important;
        min-width: 130px !important;
        max-width: 130px !important;
    }

    /* 3. Força a linha a ter os elementos separados (Painel superior) */
    #content > .form-container .container {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        flex-wrap: nowrap !important;
    }

    /* 4. O Label vira uma "mola" que preenche a esquerda */
    #content > .form-container .container > label {
        flex: 1 1 auto !important;
        font-size: 20px !important; 
        margin-right: 5px !important;
        white-space: nowrap !important;
        text-align: left !important;
        width: auto !important;
    }

    /* ================================================== */
    /* 5. A RÉGUA MESTRE: COLUNA FIXA DE 190px NA DIREITA */
    /* ================================================== */

    /* A. Quadras (A Régua base de 190px) */
    #estadoQuadra1, #estadoQuadra2, #estadoQuadra3 {
        flex: 0 0 190px !important;
        width: 190px !important;
        max-width: 190px !important;
        margin-left: auto !important; 
    }

    /* B. Sistema (100px ON + 10px espaço + 70px zeros = 180px) */
    label[for="sistema"] {
        margin-right: auto !important; 
    }
    #sistema {
        flex: 0 0 100px !important;
        width: 100px !important;
        margin-left: 0 !important; 
        box-sizing: border-box !important;
    }
    #usuariosOnline {
        flex: 0 0 70px !important;
        width: 70px !important;
        margin-left: 10px !important;
        text-align: center !important;
        padding: 0 !important;
        height: 30px !important;
        box-sizing: border-box !important;
    }

    /* C. Perfil e Permissões */
    #content > .form-container .input-group {
        flex: 0 0 190px !important;
        width: 190px !important;
        max-width: 190px !important;
        margin-left: auto !important;
        margin-right: 0 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
    }

    #permissoesSelect:disabled + #btnEditarPermissoes {
        position: static !important; 
        margin: 0 !important;
    }

    #content > .form-container .input-group select {
        flex: 0 0 145px !important;
        width: 145px !important;
        margin: 0 !important;
        padding-left: 5px !important;
        padding-right: 0 !important; 
    }

    #content > .form-container .input-group button {
        flex: 0 0 35px !important;
        width: 35px !important;
        margin-left: 10px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }
	
    /* 6. AJUSTE FINO: BOTÃO SALVAR (RODAPÉ FIXO) */
    .botao-salvar button {
        height: 55px !important;       /* Aumenta a altura (antes estava travado em 40px) */
        font-size: 20px !important;    /* Aumenta a letra (antes estava travado em 16px) */
        font-weight: bold !important;  /* Deixa o texto imponente */
        border-radius: 12px !important;/* Arredonda mais os cantos para ficar elegante */
    }
	
	/* 7. AJUSTE FINO: FONTE DENTRO DOS CAMPOS DE ENTRADA (CAIXINHAS)     */
    .form-container select,
    .form-container input {
        font-size: 17px !important; 
    }
	
	/* 8. AJUSTE FINO: TÍTULO PRINCIPAL "CONFIGURAÇÕES"                   */
    .title-container span {
        font-size: 30px !important; 
    }
		
} 
/* ========================================================================= */
/* === fim de A SUA IDEIA: ENGANAR O CELULAR COM A LARGURA DAS 2 ABAS    === */
/* ========================================================================= */



/* ================================================================= */
/* ===       BLOCO EXCLUSIVO DE ESTILOS: HORÁRIO CONVIDADOS      === */
/* ================================================================= */

#modalHorarioConvidados .modal-content {
    display: flex !important;
    flex-direction: column !important;
    max-height: 90vh !important;
    width: 95% !important;
    max-width: 900px !important;
    overflow: hidden !important;
    padding: 15px 20px 0px 20px !important; 
    background-color: #ffffff !important;
}

/* Cabeçalho e Título */
#modalHorarioConvidados .cabecalho-modal-duplas {
    display: flex !important;
    align-items: center !important;     
    justify-content: center !important; 
    position: relative !important;
    min-height: 45px !important;
    height: 45px !important;
    margin-bottom: 10px !important;
    border: none !important;            
    padding: 0 !important;              
}

#modalHorarioConvidados .cabecalho-modal-duplas h2 {
    margin: 0 !important;
    padding: 0 !important;
    line-height: 1 !important;
    color: #333 !important;
    font-size: 1.5rem !important;
    border-bottom: none !important; 
}

#modalHorarioConvidados .kebab-menu-container {
    position: absolute !important;
    right: 0 !important;
    top: 50% !important;
    transform: translateY(-50%) !important; 
    z-index: 10 !important;
    height: 35px !important; 
    width: 35px !important; 
}

/* Abas das Quadras e Painel */
#modalHorarioConvidados .quadras-tabs-container {
    margin-bottom: -10px !important;
}
#tituloConvidadosQuadra {
    text-align: center !important;
    color: #333 !important; 
    margin: 2px 0 !important;
    font-weight: bold !important;
    font-size: 21px !important; 
}

/* Tabela e Rolagem */
#modalHorarioConvidados .tabela-horarios-scroll {
    display: block !important;
    flex: 1 1 auto !important;
    overflow-y: auto !important;
    border: none !important;
    border-radius: 4px !important;
    max-height: none !important;
}

#modalHorarioConvidados .tabela-config-horarios td.sem-selecao {
    background-color: #ffffff !important; 
    color: #666 !important;              
    font-weight: normal !important;      
    font-size: 14px !important;
    padding: 8px 5px !important;
    border: 1px solid #ddd !important;
}

/* Rodapé (Botões Salvar/Fechar) */
#modalHorarioConvidados .modal-buttons {
    display: flex !important;
    gap: 15px !important;
    margin-top: 15px !important; 
    padding: 0 !important;
    width: 100% !important;
}

/* Ajustes Mobile (Iguais à Pirâmide) */
@media (max-width: 600px) {
    #modalHorarioConvidados .modal-content {
        width: 100% !important; 
        padding-left: 2px !important;
        padding-right: 2px !important;
        padding-top: 2px !important;
    }
    #modalHorarioConvidados .tabela-aulas th:first-child, 
    #modalHorarioConvidados .tabela-aulas td:first-child,
    #modalHorarioConvidados .tabela-aulas th:last-child, 
    #modalHorarioConvidados .tabela-aulas td:last-child {
        padding-left: 4px !important;
        padding-right: 4px !important;
        font-size: 15px !important;   
        width: 95px !important;       
        min-width: 95px !important;   
        max-width: 95px !important;   
    }
}
/* ================================================================= */
/* ===  fim de BLOCO EXCLUSIVO DE ESTILOS: HORÁRIO CONVIDADOS    === */
/* ================================================================= */

/* ================================================================= */
/* --- TELA CHEIA (MAXIMIZADO) - CONVIDADOS                      --- */
/* ================================================================= */
#modalHorarioConvidados .modal-content.maximizado {
    width: 100vw !important; 
    height: 100vh !important; 
    max-width: 100vw !important;
    max-height: 100vh !important; 
    margin: 0 !important;
    border-radius: 0 !important;
    padding: 2px 15px 15px 15px !important;
    top: 0 !important; 
    left: 0 !important;
    display: flex !important;
    flex-direction: column !important;
    box-sizing: border-box !important; 
    background-color: #fff !important;
}

/* 1. Esconde o cabeçalho, os botões Selecionar/Limpar e o rodapé */
#modalHorarioConvidados .modal-content.maximizado .cabecalho-modal-duplas,
#modalHorarioConvidados .modal-content.maximizado .painel-controle-duplas,
#modalHorarioConvidados .modal-content.maximizado .modal-buttons {
    display: none !important;
}

/* 2. Garante que as abas fiquem visíveis no topo e ajusta as margens */
#modalHorarioConvidados .modal-content.maximizado .quadras-tabs-container {
    flex-shrink: 0 !important;
    padding-top: 5px !important;
    background-color: white !important;
    margin-bottom: -12px !important; 
}

/* 3. Ajusta o título (ex: Quadra 1 - Coberta) */
#modalHorarioConvidados .modal-content.maximizado #tituloConvidadosQuadra {
    flex-shrink: 0 !important;
    margin-top: 0 !important; 
    margin-bottom: 10px !important; 
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
}

/* 4. Força a planilha a esticar e tira espaços extras */
#modalHorarioConvidados .modal-content.maximizado .tabela-horarios-scroll {
    flex: 1 1 auto !important;   
    height: auto !important;
    max-height: none !important; 
    min-height: 0 !important;    
    overflow-y: auto !important;
    border: none !important;     
    padding-top: 0 !important;
    margin-top: 0 !important;
}
#modalHorarioConvidados .modal-content.maximizado .tabela-horarios-scroll table {
    margin-top: 0 !important;
}

/* --- AJUSTES MOBILE PARA TELA CHEIA DOS CONVIDADOS --- */
@media (max-width: 600px) {
    #modalHorarioConvidados .modal-content.maximizado {
        padding-top: 45px !important; /* Aumentado para fugir da bateria/relógio do celular */
    }
    #modalHorarioConvidados .modal-content.maximizado .quadras-tabs-container {
        margin-top: 10px !important; /* Dá um fôlego extra pros botões */
        margin-bottom: 5px !important; 
    }
    #modalHorarioConvidados .modal-content.maximizado #tituloConvidadosQuadra {
        margin-top: 5px !important; 
        margin-bottom: 10px !important; 
    }
}
/* ================================================================= */
/* ================================================================= */
/* --- fim de TELA CHEIA (MAXIMIZADO) - CONVIDADOS               --- */
/* ================================================================= */


/* ================================================================= */
/* --- MENU FINANCEIRO DOS CONVIDADOS (3 PONTINHOS)              --- */
/* ================================================================= */

/* A Zona Financeira e o Efeito Fantasma (Bloqueado) */
.zona-financeira {
    display: flex;
    flex-direction: column;
    transition: all 0.3s ease;
}
.zona-financeira.bloqueada {
    opacity: 0.4;
    pointer-events: none; /* Impede cliques quando desativado */
    filter: grayscale(100%);
}

/* Design dos Campos */
.campo-financeiro {
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.campo-financeiro label {
    font-size: 13px;
    color: #666;
    font-weight: 600;
}
.icone-financeiro {
    font-size: 13px;
    margin-right: 3px;
}

/* Input de R$ Moderno */
.input-com-moeda {
    display: flex;
    align-items: center;
    background-color: #f5f5f7;
    border: 1px solid #e0e0e0 !important; /* Força a borda limpa */
    border-radius: 6px;
    overflow: hidden;
    height: 38px !important; /* Força a altura contra o Android */
    box-sizing: border-box;
}

.prefixo-moeda {
    background-color: #ededed;
    color: #555;
    font-weight: bold;
    font-size: 13px;
    padding: 0 10px;
    height: 100%;
    display: flex;
    align-items: center;
    border-right: 1px solid #e0e0e0;
}

.input-com-moeda input {
    flex: 1;
    border: none;
    background: transparent;
    padding: 0 8px;
    font-size: 14px;
    font-weight: 500;
    color: #333;
    outline: none;
    width: 100%;
}

/* Select do Recebedor */
/* Select do Recebedor - Rigorosamente alinhado para Android/S24 */
#recebedorConvidado {
    background-color: #f5f5f7 !important;
    border: 1px solid #e0e0e0 !important;
    border-radius: 6px !important;
    
    /* A MAGIA PARA O ANDROID NÃO ACHATAR: */
    height: 38px !important; 
    min-height: 38px !important;
    line-height: normal !important;
    padding: 0 8px !important; /* Espaçamento rigoroso apenas nas laterais */
    box-sizing: border-box !important;
    
    font-size: 14px !important;
    font-weight: 500 !important;
    color: #333 !important;
    width: 100% !important;
    outline: none !important;
    cursor: pointer !important;
    
    /* Garante que o texto não empurre a caixa para fora dos 38px */
    display: block !important;
    vertical-align: middle !important;
}

#recebedorConvidado:focus {
    border-color: #4CAF50 !important;
    background-color: #fff !important;
}
/* Input do WhatsApp - Rigorosamente alinhado */
#whatsappConvidado {
    background-color: #f5f5f7 !important;
    border: 1px solid #e0e0e0 !important;
    border-radius: 6px !important;
    
    height: 38px !important; 
    min-height: 38px !important;
    line-height: normal !important;
    padding: 0 8px !important; 
    box-sizing: border-box !important;
    
    font-size: 14px !important;
    font-weight: 500 !important;
    color: #333 !important;
    width: 100% !important;
    outline: none !important;
}

#whatsappConvidado:focus {
    border-color: #4CAF50 !important;
    background-color: #fff !important;
}

/* ================================================================= */
/* --- fim de MENU FINANCEIRO DOS CONVIDADOS (3 PONTINHOS)       --- */
/* ================================================================= */

/* ================================================================== */
/* --- MODO ESCURO: JANELA DE CONVIDADOS E MENU FINANCEIRO        --- */
/* ================================================================== */

/* 1. Fundo do Modal, Cabeçalho e Título */
body.dark-mode #modalHorarioConvidados .modal-content {
    background-color: #1e1e1e !important;
}
body.dark-mode #modalHorarioConvidados .cabecalho-modal-duplas {
    background-color: transparent !important;
}
body.dark-mode #modalHorarioConvidados h2 {
    color: #eee !important;
}
body.dark-mode #tituloConvidadosQuadra {
    color: #eee !important;
    background-color: transparent !important;
}

/* 2. Container das Abas das Quadras */
body.dark-mode #modalHorarioConvidados .quadras-tabs-container {
    background-color: #1e1e1e !important;
}
body.dark-mode #modalHorarioConvidados .quadra-tab:not(.active) {
    background-color: #333 !important;
    color: #ccc !important;
    border-color: #555 !important;
}

/* 3. A Barra Cinza de Controle (Ativar / Botões) */
body.dark-mode #modalHorarioConvidados .painel-controle-duplas {
    background-color: #2c2c2c !important;
    border-color: #444 !important;
}
body.dark-mode #checkboxAtivarQuadraConvidados:disabled + span {
    color: #777 !important;
}

/* 4. A Planilha de Horários */
body.dark-mode #modalHorarioConvidados .tabela-aulas th {
    background-color: #2c2c2c !important;
    color: #eee !important;
    border-color: #444 !important;
}
body.dark-mode #modalHorarioConvidados .tabela-config-horarios td.sem-selecao {
    background-color: #252525 !important;
    color: #ccc !important;
    border-color: #444 !important;
}
body.dark-mode #modalHorarioConvidados .aula-cell-livre {
    background-color: #1e1e1e !important;
    border-color: #333 !important;
}
body.dark-mode #modalHorarioConvidados .aula-cell-bloqueada {
    background-color: #2a2a2a !important;
    border-color: #333 !important;
}
body.dark-mode #modalHorarioConvidados .aula-cell-marcada {
    border-color: #ff5252 !important;
}

/* 5. Botões Desativados (A "Capa Cinza") e Rodapé */
body.dark-mode #modalHorarioConvidados .btn-acao-desativado {
    background-color: #333 !important;
    color: #777 !important;
    border-color: #444 !important;
}
body.dark-mode #modalHorarioConvidados .modal-buttons {
    background-color: transparent !important; 
}

/* 6. Menu de 3 Pontinhos (Kebab) */
body.dark-mode #menuDropdownConvidados {
    background-color: #2c2c2c !important;
    border-color: #444 !important;
}
body.dark-mode #menuDropdownConvidados .menu-item-sumula span {
    color: #eee !important;
}
body.dark-mode #menuDropdownConvidados hr {
    border-top-color: #555 !important;
}

/* 7. O NOVO PAINEL FINANCEIRO NO MODO ESCURO */
body.dark-mode .campo-financeiro label {
    color: #bbb !important;
}
body.dark-mode .input-com-moeda,
body.dark-mode #recebedorConvidado,
body.dark-mode #whatsappConvidado {
    background-color: #2d2d2d !important;
    border-color: #555 !important;
    color: #fff !important;
}
body.dark-mode .prefixo-moeda {
    background-color: #1e1e1e !important;
    color: #aaa !important;
    border-right-color: #555 !important;
}
body.dark-mode .input-com-moeda input {
    color: #fff !important;
}
body.dark-mode .input-com-moeda input::placeholder,
body.dark-mode #whatsappConvidado::placeholder {
    color: #777 !important;
}

/* Efeito ao clicar no campo (Foco) */
body.dark-mode #recebedorConvidado:focus, 
body.dark-mode .input-com-moeda:focus-within,
body.dark-mode #whatsappConvidado:focus {
    border-color: #4CAF50 !important; /* Mantém o Verde Suave */
    background-color: #333 !important;
}

/* ================================================================== */
/* --- fim de MODO ESCURO: JANELA DE CONVIDADOS E MENU FINANCEIRO --- */
/* ================================================================== */

/* ================================================================== */
/* --- CORREÇÃO SUPREMA: TÍTULOS DAS QUADRAS NO MODO ESCURO       --- */
/* ================================================================== */
body.dark-mode #tituloAulaQuadra,
body.dark-mode #tituloDuplasQuadra,
body.dark-mode #tituloPiramideQuadra,
body.dark-mode #tituloConvidadosQuadra {
    color: #eeeeee !important;
}
body.dark-mode #modalHorarioAulas .modal-content.maximizado .quadras-tabs-container,
body.dark-mode #modalHorarioDuplas .modal-content.maximizado .quadras-tabs-container,
body.dark-mode #modalHorarioPiramide .modal-content.maximizado .quadras-tabs-container,
body.dark-mode #modalHorarioConvidados .modal-content.maximizado .quadras-tabs-container {
    background-color: transparent !important;
}
/* ================================================================== */
/* --- fim de CORREÇÃO SUPREMA: TÍTULOS DAS QUADRAS NO MODO ESCURO -- */
/* ================================================================== */


</style>

</head>
<body>

<div id="loading">
    Carregando... Aguarde.
</div>
<div id="content">
    <div class="form-container">
        <div class="title-container">
            <span>
                Configurações
            </span>
        </div>
        <hr class="hr-line">
        <div class="container">
            <label for="sistema">
                Sistema:
            </label>
            <select id="sistema" onchange="atualizarEstadoSistema(); marcarComoAlterado()">
                <option value="ON">
                    ON
                </option>
                <option value="OFF">
                    OFF
                </option>
            </select>
            <input type="text" id="usuariosOnline" placeholder="000" readonly maxlength="3" style="width: 40px; height: 15px; text-align: center;" title="Número de usuários online (3 dígitos)">
            <script>
                document.getElementById('usuariosOnline').addEventListener('mousedown', function(event) {
                event.preventDefault();
                this.blur();
                window.getSelection().removeAllRanges();
                });
            </script>
        </div>
        <div class="container container-fixo">
            <label for="perfilSelect">
                Perfil:
            </label>
            <div class="input-group">
                <select id="perfilSelect" class="select-padrao">
                    <option value="Admin">
                        Admin
                    </option>
                    <option value="Visitante">
                        Visitante
                    </option>
                </select>
                <button type="button" class="btn-extra add-button" onclick="abrirModalAdicionarPerfil()" title="Adicionar Perfil">
                    +
                </button>
            </div>
        </div>
        <div class="container container-fixo">
            <label for="permissoesSelect">
                Permissões:
            </label>
            <div class="input-group">
                <select id="permissoesSelect" class="select-padrao">
                    <option selected>
                        Acesso Total
                    </option>
                </select>
                <button id="btnEditarPermissoes" type="button" class="btn-extra btn-lapis" onclick="abrirModalPermissoes()" title="Editar Permissões">
                    ✏️
                </button>
            </div>
        </div>
        <div class="container quadra-container">
            <label for="estadoQuadra1">
                Quadra 1 - Coberta:
            </label>
            <select id="estadoQuadra1" class="no-select" onfocus="this.oldValue = this.value;" onchange="handleEstadoQuadraChange(this, 1); marcarComoAlterado()" ondblclick="handleEstadoQuadraChange(this, 1)">
                <option value="liberada">
                    Liberada
                </option>
                <option value="interditada">
                    Interditada
                </option>
                <option value="bloqueada">
                    Bloqueada
                </option>
            </select>
        </div>
        <div class="container quadra-container">
            <label for="estadoQuadra2">
                Quadra 2 - Aberta:
            </label>
            <select id="estadoQuadra2" class="no-select" onfocus="this.oldValue = this.value;" onchange="handleEstadoQuadraChange(this, 2); marcarComoAlterado()" ondblclick="handleEstadoQuadraChange(this, 2)">
                <option value="liberada">
                    Liberada
                </option>
                <option value="interditada">
                    Interditada
                </option>
                <option value="bloqueada">
                    Bloqueada
                </option>
            </select>
        </div>
        <div class="container quadra-container">
            <label for="estadoQuadra3">
                Quadra 3 - Coberta:
            </label>
            <select id="estadoQuadra3" class="no-select" onfocus="this.oldValue = this.value;" onchange="handleEstadoQuadraChange(this, 3); marcarComoAlterado()" ondblclick="handleEstadoQuadraChange(this, 3)">
                <option value="liberada">
                    Liberada
                </option>
                <option value="interditada">
                    Interditada
                </option>
                <option value="bloqueada">
                    Bloqueada
                </option>
            </select>
        </div>
    </div>
    <div id="main-content">
        <div class="tabs">
            <div class="tab active" onclick="showTab('reservas')">
                Reservas
            </div>
            <div class="tab" onclick="showTab('outros')">
                Outros
            </div>
        </div>
        <div id="reservas" class="tab-content tab-content-active">
            <div class="form-container">
                <div class="container">
                    <label for="tipoConfiguracaoHorario">
                        Gerenciador Horários:
                    </label>
                    <select id="tipoConfiguracaoHorario" onchange="abrirGerenciadorHorarios(this.value)">
                        <option value="" disabled selected hidden>
                            Config
                        </option>
                        <option value="padrao">
                            Padrão
                        </option>
                        <option value="especial">
                            Especiais
                        </option>
                        <option value="aulas">
                            Aulas
                        </option>
                        <option value="duplas">
                            Duplas
                        </option>
                        <option value="piramide">
                            Pirâmide
                        </option>
						<option value="convidados">
                            Convidados
                        </option> 
                    </select>
                </div>
                <div class="container">
                    <label for="diasParaAgendar">
                        Dias para Agendar:
                    </label>
                    <select id="diasParaAgendar" onchange="marcarComoAlterado()">
                        <option value="0">
                            0
                        </option>
                        <option value="1">
                            1
                        </option>
                        <option value="2">
                            2
                        </option>
                        <option value="3">
                            3
                        </option>
                        <option value="4">
                            4
                        </option>
                    </select>
                </div>
                <div class="container">
                    <label for="reservasPorConfirmacao" class="label-help" title="ON: Reservas com múltiplos sócios exigem que cada um confirme sua presença.&#10;──────────&#10;OFF: Todas as reservas são confirmadas instantaneamente.">
                        Confirmação Reservas:
                    </label>
                    <select id="reservasPorConfirmacao" onchange="atualizarEstadoConfirmacao(); marcarComoAlterado()">
                        <option value="ON">
                            ON
                        </option>
                        <option value="OFF">
                            OFF
                        </option>
                    </select>
                </div>
                <div class="container">
                    <label for="horasParaExpirar" class="label-help" title="Define o tempo máximo que os jogadores têm para aceitar ou recusar um convite.&#10;──────────&#10;Se o prazo expirar, a reserva é cancelada automaticamente.">
                        Prazo para Confirmação:
                    </label>
                    <select id="horasParaExpirar" onchange="marcarComoAlterado()">
                        <option value="1">
                            1 hora
                        </option>
                        <option value="2">
                            2 horas
                        </option>
                        <option value="3">
                            3 horas
                        </option>
                        <option value="4">
                            4 horas
                        </option>
                        <option value="6">
                            6 horas
                        </option>
                        <option value="12">
                            12 horas
                        </option>
                    </select>
                </div>
                <div class="container">
                    <label for="edicaoOrganizador" class="label-help" title="ON: Permite que o organizador de uma reserva pendente possa adicionar ou remover jogadores.&#10;──────────&#10;OFF: O organizador pode apenas excluir a reserva.">
                        Edição pelo Organizador:
                    </label>
                    <select id="edicaoOrganizador" onchange="atualizarEstadoEdicaoOrganizador(); marcarComoAlterado()">
                        <option value="ON">
                            ON
                        </option>
                        <option value="OFF">
                            OFF
                        </option>
                    </select>
                </div>
                <div class="container">
                    <label for="otimizacaoHorarios" class="label-help" title="ON: O sistema ativa a otimização para dias curtos (4h ou menos), bloqueando horários quebrados para maximizar o uso da quadra. Dê duplo clique para escolher as quadras.&#10;──────────&#10;OFF: A otimização é desligada e os horários ficam livres.">
                        Otimização de Horários:
                    </label>
                    <select id="otimizacaoHorarios" onchange="mudarOtimizacao(); marcarComoAlterado()" ondblclick="if(this.value === 'ON') { abrirModalQuebraHorario(); }">
                        <option value="ON">
                            ON
                        </option>
                        <option value="OFF">
                            OFF
                        </option>
                    </select>
                </div>
                <div class="container">
                    <label for="selectLimpezaMural" class="label-help" title="Define quanto tempo as mensagens ficam no mural antes de sumirem.">
                        Mensagens do Mural:
                    </label>
                    <select id="selectLimpezaMural" onchange="verificarOpcaoMural(this); marcarComoAlterado()">
                        <option value="0" disabled selected>
                            Carregando...
                        </option>
                        <option value="1">
                            1 dia
                        </option>
                        <option value="2">
                            2 dias
                        </option>
                        <option value="3">
                            3 dias
                        </option>
                        <option value="7">
                            1 semana
                        </option>
                        <option value="30">
                            1 mês
                        </option>
                        <option value="custom">
                            Outros...
                        </option>
                    </select>
                </div>
            </div>
        </div>
        <div id="outros" class="tab-content">
			<div class="container" style="text-align: center; padding: 40px 20px; display: flex; flex-direction: column; align-items: center; width: 100%; box-sizing: border-box;">
				<h3 style="color: #666; margin-bottom: 5px;">Configurações Adicionais</h3>
				<p style="color: #999; font-size: 15px; margin-top: 0; line-height: 1.4;">
					Novas opções e configurações gerais do sistema serão adicionadas aqui futuramente.
				</p>
			</div>
		</div>
        
    </div>
    <div class="container botao-salvar">
        <button onclick="salvarConfiguracoes()" id="btnSalvarGlobal">
            Salvar Configurações
        </button>
    </div>
</div>
<div id="modalBloqueioQuadra" class="modal-overlay">
    <div class="modal-content">
        <h2 id="modalBloqueioTitulo">
            Bloqueio
        </h2>
        <div class="container">
            <label>
                Desc:
            </label>
            <input id="bloqueioDescricao">
        </div>
        <div class="container">
            <label>
                Data:
            </label>
            <input id="bloqueioData" oninput="formatarDataInput(event)">
        </div>
        <div class="container">
            <label>
                Horário:
            </label>
            <input type="time" id="bloqueioInicio">
            <input type="time" id="bloqueioFim">
        </div>
        <div class="modal-buttons">
            <button class="btn-fechar" onclick="fecharModalBloqueio()">
                Fechar
            </button>
            <button class="btn-adicionar" onclick="adicionarBloqueio()">
                Add
            </button>
        </div>
        <div id="listaBloqueios">
        </div>
    </div>
</div>
<div id="modalQuebraHorarioQuadras" class="modal-overlay">
    <div class="modal-content">
        <h2 id="modalQuebraHorarioTitulo" style="margin-bottom: 20px;">
            Otimização de Horários
        </h2>
        <div style="display: flex; flex-direction: column; gap: 15px; align-items: flex-start; margin-left: 20px;">
            <label style="font-weight: normal; cursor: pointer; font-size: 16px;">
                <input type="checkbox" id="quebraHorarioQuadra1" style="margin-right: 8px;">
                Quadra 1 - Coberta
            </label>
            <label style="font-weight: normal; cursor: pointer; font-size: 16px;">
                <input type="checkbox" id="quebraHorarioQuadra2" style="margin-right: 8px;">
                Quadra 2 - Aberta
            </label>
            <label style="font-weight: normal; cursor: pointer; font-size: 16px;">
                <input type="checkbox" id="quebraHorarioQuadra3" style="margin-right: 8px;">
                Quadra 3 - Coberta
            </label>
        </div>
        <div class="modal-buttons" style="margin-top: 25px;">
            <button class="btn-fechar" onclick="fecharModalQuebraHorario()">
                Fechar
            </button>
            <button class="btn-adicionar" onclick="salvarModalQuebraHorario()">
                Confirmar
            </button>
        </div>
    </div>
</div>
<div id="modalHorarioPadrao" class="modal-overlay">
    <div class="modal-content" style="max-width: 800px; width: 90%;">
        <h2>
            Horários Padrão
        </h2>
        <div class="tabela-horarios-scroll" style="max-height: none; overflow: visible;">
            <table class="tabela-config-horarios">
                <thead>
                    <tr>
                        <th>
                            Dia
                        </th>
                        <th>
                            Status
                        </th>
                        <th class="col-horario">
                            <span class="texto-desktop">
                                Abertura
                            </span>
                            <span class="texto-mobile">
                                Abre
                            </span>
                        </th>
                        <th class="col-horario">
                            <span class="texto-desktop">
                                Fechamento
                            </span>
                            <span class="texto-mobile">
                                Fecha
                            </span>
                        </th>
                    </tr>
                </thead>
                <tbody id="tbodyHorarioPadrao">
                </tbody>
            </table>
        </div>
        <div class="container modal-buttons">
            <button class="btn-fechar" onclick="fecharModalHorario('padrao')">
                Fechar
            </button>
            <button class="btn-adicionar" onclick="salvarHorarioPadrao()">
                Salvar
            </button>
        </div>
    </div>
</div>
<div id="modalHorarioEspecial" class="modal-overlay">
    <div class="modal-content" style="max-width: 700px; padding: 15px; display: flex; flex-direction: column; max-height: 95vh; overflow: hidden;">
        <div style="
            border: none;
            margin: 0 0 10px 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 25px;
            flex-shrink: 0; /* Não deixa esmagar */
            ">
            <h2 style="margin: 0; padding: 0; font-size: 1.5rem; line-height: 1;">
                Horários Especiais
            </h2>
        </div>
        <div id="corpoModalScroll" style="overflow-y: auto; flex: 1; padding-right: 5px; display: flex; flex-direction: column;">
            <div id="areaSuperiorEspecial">
                <div class="painel-destaque" style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #bbdefb;">
                    <div class="container" style="margin: 0; display: flex; align-items: center;">
                        <label for="selectPeriodoEspecial" style="width: auto; margin-right: 10px; font-size: 1rem;">
                            Gerenciar Período:
                        </label>
                        <select id="selectPeriodoEspecial" onchange="carregarPeriodoEspecial(this.value)" style="font-weight: bold; padding: 8px;">
                            <option value="novo">
                                + Criar Novo Período...
                            </option>
                        </select>
                    </div>
                </div>
                <div id="formPeriodoEspecial">
                    <div class="container" style="margin-bottom: 5px;">
                        <label style="width: 140px;">
                            Nome do Período:
                        </label>
                        <input type="text" id="nomePeriodo" placeholder="Ex: Recesso Fim de Ano" style="height: 30px; padding: 4px 8px;">
                    </div>
                    <div class="container" style="margin-bottom: 5px;">
                        <label>
                            Vigência:
                        </label>
                        <div style="display: flex; gap: 10px; flex: 1; align-items: center;">
                            <input type="date" id="dataInicioPeriodo" style="height: 30px; padding: 4px 8px;">
                            <span style="font-weight: bold;">
                                até
                            </span>
                            <input type="date" id="dataFimPeriodo" style="height: 30px; padding: 4px 8px;">
                        </div>
                    </div>
                    <div class="container" style="justify-content: flex-start; margin: 2px 0; padding: 0; align-items: center; min-height: 30px;">
                        <label class="dias-semana-label" style="width: auto !important; max-width: none !important; cursor: pointer; display: flex !important; align-items: center !important; justify-content: flex-start !important; margin: 0; gap: 5px;">
                            <input type="checkbox" id="periodoAtivo" checked onchange="atualizarCorPeriodoAtivo()" style="width: 20px; height: 20px; margin: 0; flex-shrink: 0;">
                            <span id="textoPeriodoAtivo" style="font-weight: bold; line-height: 1;">
                                Ativar este período especial
                            </span>
                        </label>
                    </div>
                    <div class="painel-regra-mestra" style="background: #fff3cd; padding: 5px 10px; border: 1px solid #ffeeba; border-radius: 8px;">
                        <p style="margin: 0 0 2px 0; font-weight: bold; color: #856404; font-size: 0.95em;">
                            ⚡ Preenchimento Rápido:
                        </p>
                        <div class="container" style="margin: 0; flex-wrap: wrap; gap: 5px; align-items: center;">
                            <select id="regraMestraStatus" style="max-width: 100px;">
                                <option value="aberto">
                                    Aberto
                                </option>
                                <option value="fechado">
                                    Fechado
                                </option>
                            </select>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <input type="time" id="regraMestraInicio" value="08:00">
                                <span>
                                    às
                                </span>
                                <input type="time" id="regraMestraFim" value="17:00">
                            </div>
                            <button id="btnGerarDias" class="btn-adicionar" onclick="gerarListaDias()" style="margin-left: auto; width: auto; font-size: 0.9em; background-color: #ffc107; color: #000;">
                                Gerar / Atualizar Dias
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div style="display: flex; width: 100%; align-items: center; justify-content: space-between; margin: 5px 0 5px 0; padding-bottom: 5px; box-sizing: border-box; height: 40px; flex-shrink: 0;">
                <h3 style="font-size: 1.1em; margin: 0; color: #333;">
                    Ajuste Fino (Dia a Dia):
                </h3>
                <button id="btnTelaCheiaEspecial" class="btn-expandir" onclick="alternarTelaCheiaEspecial()" title="Expandir / Minimizar">
                    <svg viewBox="0 0 24 24" id="icon-fullscreen">
                        <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
                    </svg>
                </button>
            </div>
            <div class="lista-dias-scroll" id="containerListaDiasEspeciais">
                <p style="text-align: center; color: #999; margin-top: 30px; font-style: italic;">
                    Defina as datas acima e clique em
                    <b>
                        "Gerar / Atualizar Dias"
                    </b>
                    .
                </p>
            </div>
        </div>
        <div class="container modal-buttons" style="margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; flex-shrink: 0;">
            <button id="btnExcluirPeriodo" class="btn-remover" onclick="excluirPeriodoSelecionado()" style="background-color: #dc3545; color: white; display: none;">
                Excluir
            </button>
            <button class="btn-fechar" onclick="fecharModalHorario('especial')" style="background-color: #6c757d;">
                Cancelar
            </button>
            <button id="btnSalvarEspecial" class="btn-adicionar" onclick="salvarPeriodoEspecial()" disabled style="background-color: #cccccc; color: white; cursor: not-allowed;">
                Salvar
            </button>
        </div>
    </div>
</div>
<div id="modalHorarioAulas" class="modal-overlay">
    <div class="modal-content" style="max-width: 900px; width: 95%; padding-top: 5px;">
        <div class="cabecalho-modal-aulas" style="text-align: center; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 5px;">
            <h2 style="margin: 0; border: none; padding: 0;">
                Grade de Aulas
            </h2>
        </div>
        <div class="quadras-tabs-container">
            <button class="quadra-tab active" id="btn-aula-q1" onclick="selecionarQuadraAula('Quadra1')">
                <span class="desktop-text">
                    Quadra 1 - Coberta
                </span>
                <span class="mobile-text">
                    Quadra 1
                    <br>
                    Coberta
                </span>
            </button>
            <button class="quadra-tab" id="btn-aula-q2" onclick="selecionarQuadraAula('Quadra2')">
                <span class="desktop-text">
                    Quadra 2 - Aberta
                </span>
                <span class="mobile-text">
                    Quadra 2
                    <br>
                    Aberta
                </span>
            </button>
            <button class="quadra-tab" id="btn-aula-q3" onclick="selecionarQuadraAula('Quadra3')">
                <span class="desktop-text">
                    Quadra 3 - Coberta
                </span>
                <span class="mobile-text">
                    Quadra 3
                    <br>
                    Coberta
                </span>
            </button>
        </div>
        <div class="painel-controle-aulas">
            <div class="linha-unica-flex">
                <label class="label-ativar">
                    <input type="checkbox" id="aula-ativo">
                    <span>
                        Ativar Aulas
                    </span>
                </label>
                <div class="grupo-professor-compacto">
                    <label>
                        Professor:
                    </label>
                    <select id="aula-professor">
                        <option value="">
                            Selecione...
                        </option>
                    </select>
                </div>
                <div class="grupo-botoes">
                    <button class="btn-mini" onclick="acaoAula('selecionar')">
                        Selecionar Tudo
                    </button>
                    <button class="btn-mini outline" onclick="acaoAula('limpar')">
                        Limpar Tudo
                    </button>
                </div>
            </div>
        </div>
        <div id="tituloAulaQuadra">
            Quadra 1 - Coberta
        </div>
        <div class="tabela-horarios-scroll" style="max-height: none; overflow: visible; border: none;">
            <table class="tabela-config-horarios tabela-aulas">
                <thead>
                    <tr>
                        <th
                            onclick="tratarCliqueHorario(event)"
                            class="sem-selecao"
                            title="Dê dois cliques para Tela Cheia"
                            style="cursor: pointer;">
                            Horário
                        </th>
                        <th>
                            Seg
                        </th>
                        <th>
                            Ter
                        </th>
                        <th>
                            Qua
                        </th>
                        <th>
                            Qui
                        </th>
                        <th>
                            Sex
                        </th>
                        <th>
                            Sáb
                        </th>
                        <th>
                            Dom
                        </th>
                        <th
                            onclick="tratarCliqueHorario(event)"
                            class="sem-selecao"
                            title="Dê dois cliques para Tela Cheia"
                            style="cursor: pointer;">
                            Horário
                        </th>
                    </tr>
                </thead>
                <tbody id="tbodyAulas">
                    <tr>
                        <td colspan="8" style="padding: 20px;">
                            Carregando...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="container modal-buttons" style="margin-top: 15px;">
            <button class="btn-fechar" onclick="fecharModalHorario('aulas')">
                Fechar
            </button>
            <button class="btn-adicionar" onclick="salvarConfiguracaoAulas()">
                Salvar
            </button>
        </div>
    </div>
</div>

<div id="modalHorarioConvidados" class="modal-overlay">
    <div class="modal-content">
        <div class="cabecalho-modal-duplas" onclick="tratarCliqueHorarioConvidados(event)">
            <h2 style="margin: 0; padding: 0; line-height: 1; display: inline-block;">
                Horário de Convidados
            </h2>
            <div class="kebab-menu-container">
                <button type="button" id="btnKebabConvidados" class="btn-kebab" onclick="toggleMenuConvidados(event)"></button>
                <div id="menuDropdownConvidados" class="menu-dropdown-sumula">
                    <div class="menu-item-sumula">
                        <span>Ativar</span>
                        <label class="switch-sumula" onclick="event.stopPropagation();">
                            <input type="checkbox" id="switchAtivarConvidados" onchange="toggleAtivarConvidados(this.checked)">
                            <span class="slider-sumula"></span>
                        </label>
                    </div>
    
                    <hr style="border: 0; border-top: 1px solid #eee; margin: 8px 0;">
    
                    <div id="zonaFinanceiraConvidados" class="zona-financeira" onclick="event.stopPropagation();" style="padding: 0 15px 10px 15px;">
                        
                        <div class="campo-financeiro">
                            <label for="taxaConvidado"><span class="icone-financeiro">💰</span> Taxa por Convidado</label>
                            <div class="input-com-moeda">
                                <span class="prefixo-moeda">R$</span>
                                <input type="text" id="taxaConvidado" placeholder="0,00" inputmode="numeric" oninput="aplicarMascaraReal(this)">
                            </div>
                        </div>
    
                        <div class="campo-financeiro" style="margin-top: 10px;">
                            <label for="recebedorConvidado"><span class="icone-financeiro">👤</span> Recebedor (Financeiro)</label>
                            <select id="recebedorConvidado">
                                <option value="">Selecione...</option>
                                </select>
                        </div>
						<div class="campo-financeiro" style="margin-top: 10px;">
                            <label for="whatsappConvidado"><span class="icone-financeiro">📱</span> WhatsApp</label>
                            <input type="tel" id="whatsappConvidado" placeholder="(00) 00000-0000" maxlength="15" oninput="aplicarMascaraTelefone(this)">
                        </div>
    
                    </div>
                </div>
            </div>
        </div>

        <div class="quadras-tabs-container">
            <button class="quadra-tab active" id="tabConvidadosQ1" onclick="selecionarQuadraConvidados('Quadra1')">
                <span class="desktop-text">Quadra 1 - Coberta</span>
                <span class="mobile-text">Quadra 1<br>Coberta</span>
            </button>
            <button class="quadra-tab" id="tabConvidadosQ2" onclick="selecionarQuadraConvidados('Quadra2')">
                <span class="desktop-text">Quadra 2 - Aberta</span>
                <span class="mobile-text">Quadra 2<br>Aberta</span>
            </button>
            <button class="quadra-tab" id="tabConvidadosQ3" onclick="selecionarQuadraConvidados('Quadra3')">
                <span class="desktop-text">Quadra 3 - Coberta</span>
                <span class="mobile-text">Quadra 3<br>Coberta</span>
            </button>
        </div>

        <div class="painel-controle-duplas">
            <div class="linha-unica-flex" style="justify-content: space-between !important;">
                <label style="display: flex; align-items: center; cursor: pointer; margin: 0; white-space: nowrap;">
                    <input type="checkbox" id="checkboxAtivarQuadraConvidados" onchange="toggleAtivarQuadraConvidados(this.checked)" style="width: 18px; height: 18px; margin: 0 5px 0 0; cursor: pointer; accent-color: #2e7d32;">
                    <span style="font-weight: bold; color: #2e7d32; font-size: 15px;">
                        Liberar
                    </span>
                </label>
                <div class="grupo-botoes">
                    <button type="button" class="btn-mini" onclick="selecionarTudoConvidados()">Selecionar Tudo</button>
                    <button type="button" class="btn-mini outline" onclick="limparTudoConvidados()">Limpar Tudo</button>
                </div>
            </div>
        </div>

        <div id="tituloConvidadosQuadra" style="text-align: center; font-weight: bold; margin: 5px 0; color: #333;">
            Quadra 1 - Coberta
        </div>

        <div class="tabela-horarios-scroll" style="border: none;">
            <table class="tabela-config-horarios tabela-aulas">
                <thead>
                    <tr>
                        <th class="sem-selecao" onclick="tratarCliqueHorarioConvidados(event)" title="Dê dois cliques para Tela Cheia" style="cursor: pointer;">Horário</th>
                        <th>Seg</th><th>Ter</th><th>Qua</th><th>Qui</th><th>Sex</th><th>Sáb</th><th>Dom</th>
                        <th class="sem-selecao" onclick="tratarCliqueHorarioConvidados(event)" title="Dê dois cliques para Tela Cheia" style="cursor: pointer;">Horário</th>
                    </tr>
                </thead>
                <tbody id="tabelaHorariosConvidados">
                    </tbody>
            </table>
        </div>

        <div class="container modal-buttons" style="margin-top: 15px;">
            <button class="btn-fechar" onclick="fecharModalHorarioConvidados()">Fechar</button>
            <button class="btn-adicionar" onclick="salvarConvidados()">Salvar</button>
        </div>
    </div>
</div>

<div id="modalHorarioDuplas" class="modal-overlay">
    <div class="modal-content" style="max-width: 900px; width: 95%; padding-top: 5px;">
        <div class="cabecalho-modal-duplas" onclick="tratarCliqueHorarioDuplas(event)">
            <h2 id="tituloPrincipalDuplas" style="margin: 0; padding: 0; line-height: 1; display: inline-block; transition: color 0.3s ease;">
                Horário de Duplas
            </h2>
            <div class="kebab-menu-container">
                <button type="button" id="btnKebabDuplas" class="btn-kebab" onclick="toggleMenuDuplas(event)">
                </button>
                <div id="menuDropdownDuplas" class="menu-dropdown-sumula">
					<div class="menu-item-sumula">
						<span>
							Ativar
						</span>
						<label class="switch-sumula" onclick="event.stopPropagation();">
							<input type="checkbox" id="switchAtivarDuplas" onchange="toggleAtivarDuplas(this.checked)">
							<span class="slider-sumula">
							</span>
						</label>
					</div>
					<div class="menu-item-sumula">
						<span>
							Ranking
						</span>
						<label class="switch-sumula" onclick="event.stopPropagation();">
							<input type="checkbox" id="switchRankingDuplas" onchange="toggleRankingDuplas(this.checked)">
							<span class="slider-sumula">
							</span>
						</label>
					</div>
					
					<div style="width: 100%; height: 1px; background-color: #ccc; margin: 10px 0;"></div>
					
					<div style="display: flex; justify-content: center; width: 100%;">
						<button onclick="acionarZerarRanking()" style="width: 100%; padding: 8px; background-color: #ff3b30; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 5px;">
							Zerar Ranking
						</button>
					</div>
				</div>
            </div>
        </div>
        <div class="quadras-tabs-container">
            <button class="quadra-tab active" id="btn-duplas-q1" onclick="selecionarQuadraDuplas('Quadra1')">
                <span class="desktop-text">
                    Quadra 1 - Coberta
                </span>
                <span class="mobile-text">
                    Quadra 1
                    <br>
                    Coberta
                </span>
            </button>
            <button class="quadra-tab" id="btn-duplas-q2" onclick="selecionarQuadraDuplas('Quadra2')">
                <span class="desktop-text">
                    Quadra 2 - Aberta
                </span>
                <span class="mobile-text">
                    Quadra 2
                    <br>
                    Aberta
                </span>
            </button>
            <button class="quadra-tab" id="btn-duplas-q3" onclick="selecionarQuadraDuplas('Quadra3')">
                <span class="desktop-text">
                    Quadra 3 - Coberta
                </span>
                <span class="mobile-text">
                    Quadra 3
                    <br>
                    Coberta
                </span>
            </button>
        </div>
        <div class="painel-controle-duplas">
            <div class="linha-unica-flex" style="justify-content: space-between !important;">
                <label style="display: flex; align-items: center; cursor: pointer; margin: 0; white-space: nowrap;">
                    <input type="checkbox" id="checkboxAtivarQuadraDuplas" onchange="toggleAtivarQuadraDuplas(this.checked)" style="width: 18px; height: 18px; margin: 0 5px 0 0; cursor: pointer; accent-color: #2e7d32;">
                    <span style="font-weight: bold; color: #2e7d32; font-size: 15px;">
                        Ativar
                    </span>
                </label>
                <div class="grupo-botoes">
                    <button type="button" id="btnSelecionarDuplas" class="btn-mini" onclick="acaoDuplas('selecionar')">
                        Selecionar Tudo
                    </button>
                    <button type="button" id="btnLimparDuplas" class="btn-mini outline" onclick="acaoDuplas('limpar')">
                        Limpar Tudo
                    </button>
                </div>
            </div>
        </div>
        <div id="tituloDuplasQuadra" style="text-align: center; font-weight: bold; margin: 5px 0;">
            Quadra 1 - Coberta
        </div>
        <div class="tabela-horarios-scroll" style="max-height: none; overflow: visible; border: none;">
            <table class="tabela-config-horarios tabela-aulas">
                <thead>
                    <tr>
                        <th onclick="tratarCliqueHorarioDuplas(event)" class="sem-selecao" title="Dê dois cliques para Tela Cheia" style="cursor: pointer;">
                            Horário
                        </th>
                        <th>
                            Seg
                        </th>
                        <th>
                            Ter
                        </th>
                        <th>
                            Qua
                        </th>
                        <th>
                            Qui
                        </th>
                        <th>
                            Sex
                        </th>
                        <th>
                            Sáb
                        </th>
                        <th>
                            Dom
                        </th>
                        <th onclick="tratarCliqueHorarioDuplas(event)" class="sem-selecao" title="Dê dois cliques para Tela Cheia" style="cursor: pointer;">
                            Horário
                        </th>
                    </tr>
                </thead>
                <tbody id="tbodyDuplas">
                </tbody>
            </table>
        </div>
        <div class="container modal-buttons" style="margin-top: 15px;">
            <button class="btn-fechar" onclick="fecharModalHorario('duplas')">
                Fechar
            </button>
            <button class="btn-adicionar" onclick="salvarConfiguracaoDuplas()">
                Salvar
            </button>
        </div>
    </div>
</div>
<div id="modalHorarioPiramide" class="modal-overlay">
    <div class="modal-content">
        <div class="cabecalho-modal-duplas">
            <h2 style="margin: 0; padding: 0; line-height: 1; display: inline-block;">
                Horário de Pirâmide
            </h2>
            <div class="kebab-menu-container">
                <button type="button" id="btnKebabPiramide" class="btn-kebab" onclick="toggleMenuPiramide(event)">
                </button>
                <div id="menuDropdownPiramide" class="menu-dropdown-sumula">
                    <div class="menu-item-sumula">
                        <span>
                            Ativar
                        </span>
                        <label class="switch-sumula" onclick="event.stopPropagation();">
                            <input type="checkbox" id="switchAtivarPiramide" onchange="toggleAtivarPiramide(this.checked)">
                            <span class="slider-sumula">
                            </span>
                        </label>
                    </div>
                    <div class="menu-item-sumula">
                        <span>
                            Ranking
                        </span>
                        <label class="switch-sumula" onclick="event.stopPropagation();">
                            <input type="checkbox" id="switchRankingPiramide" onchange="toggleRankingPiramide(this.checked)">
                            <span class="slider-sumula">
                            </span>
                        </label>
                    </div>
                    <hr style="border: 0; border-top: 1px solid #eee; margin: 8px 0;">
                    <div class="menu-item-sumula menu-item-data-piramide" id="btnDataPiramideKebab" onclick="abrirModalDataPiramide(event)" style="justify-content: center; cursor: pointer; color: #4CAF50; font-weight: 500; white-space: nowrap; font-size: 15px !important;">
                        📅 Definir datas...
                    </div>
                </div>
            </div>
        </div>
        <div class="quadras-tabs-container">
            <button class="quadra-tab active" id="tabPiramideQ1" onclick="selecionarQuadraPiramide('Quadra1')">
                <span class="desktop-text">
                    Quadra 1 - Coberta
                </span>
                <span class="mobile-text">
                    Quadra 1
                    <br>
                    Coberta
                </span>
            </button>
            <button class="quadra-tab" id="tabPiramideQ2" onclick="selecionarQuadraPiramide('Quadra2')">
                <span class="desktop-text">
                    Quadra 2 - Aberta
                </span>
                <span class="mobile-text">
                    Quadra 2
                    <br>
                    Aberta
                </span>
            </button>
            <button class="quadra-tab" id="tabPiramideQ3" onclick="selecionarQuadraPiramide('Quadra3')">
                <span class="desktop-text">
                    Quadra 3 - Coberta
                </span>
                <span class="mobile-text">
                    Quadra 3
                    <br>
                    Coberta
                </span>
            </button>
        </div>
        <div class="painel-controle-duplas">
            <div class="linha-unica-flex" style="justify-content: space-between !important;">
                <label style="display: flex; align-items: center; cursor: pointer; margin: 0; white-space: nowrap;">
                    <input type="checkbox" id="checkboxAtivarQuadraPiramide" onchange="toggleAtivarQuadraPiramide(this.checked)" style="width: 18px; height: 18px; margin: 0 5px 0 0; cursor: pointer; accent-color: #2e7d32;">
                    <span style="font-weight: bold; color: #2e7d32; font-size: 15px;">
                        Liberar
                    </span>
                </label>
                <div class="grupo-botoes">
                    <button type="button" class="btn-mini" onclick="selecionarTudoPiramide()">
                        Selecionar Tudo
                    </button>
                    <button type="button" class="btn-mini outline" onclick="limparTudoPiramide()">
                        Limpar Tudo
                    </button>
                </div>
            </div>
        </div>
        <div id="tituloPiramideQuadra" style="text-align: center; font-weight: bold; margin: 5px 0; color: #333;">
            Quadra 1 - Coberta
        </div>
        <div class="tabela-horarios-scroll" style="border: none;">
            <table class="tabela-config-horarios tabela-aulas">
                <thead>
                    <tr>
                        <th class="sem-selecao" onclick="tratarCliqueHorarioPiramide(event)" title="Dê dois cliques para Tela Cheia" style="cursor: pointer;">
                            Horário
                        </th>
                        <th>
                            Seg
                        </th>
                        <th>
                            Ter
                        </th>
                        <th>
                            Qua
                        </th>
                        <th>
                            Qui
                        </th>
                        <th>
                            Sex
                        </th>
                        <th>
                            Sáb
                        </th>
                        <th>
                            Dom
                        </th>
                        <th class="sem-selecao" onclick="tratarCliqueHorarioPiramide(event)" title="Dê dois cliques para Tela Cheia" style="cursor: pointer;">
                            Horário
                        </th>
                    </tr>
                </thead>
                <tbody id="tabelaHorariosPiramide">
                </tbody>
            </table>
        </div>
        <div class="container modal-buttons" style="margin-top: 15px;">
            <button class="btn-fechar" onclick="document.getElementById('modalHorarioPiramide').style.display='none'">
                Fechar
            </button>
            <button class="btn-adicionar" onclick="salvarPiramide()">
                Salvar
            </button>
        </div>
    </div>
</div>
<div id="modalDataPiramide" class="modal-overlay" style="z-index: 10001;">
    <div class="modal-content" style="max-width: 350px;">
        <h2 style="margin-bottom: 20px;">
            Datas do Torneio
        </h2>
        <div class="container" style="flex-direction: column; align-items: flex-start; gap: 5px;">
            <label style="width: 100%; margin-bottom: 5px;">
                Data de Início:
            </label>
            <input type="date" id="inputDataInicioPiramide" style="width: 100%; height: 40px; text-align: center;">
        </div>
        <div class="container" style="flex-direction: column; align-items: flex-start; gap: 5px; margin-top: 15px;">
            <label style="width: 100%; margin-bottom: 5px;">
                Data de Fim:
            </label>
            <input type="date" id="inputDataFimPiramide" style="width: 100%; height: 40px; text-align: center;">
        </div>
        <div class="modal-buttons" style="margin-top: 25px; display: flex; justify-content: space-between; gap: 10px;">
            <button class="btn-fechar" onclick="fecharModalDataPiramide()" style="background-color: #6c757d; flex: 1; margin: 0;">
                Cancelar
            </button>
            <button class="btn-adicionar" onclick="salvarDataPiramide()" style="flex: 1; margin: 0;">
                Confirmar
            </button>
        </div>
    </div>
</div>
<div id="modalNovoPerfil" class="modal-overlay">
    <div class="modal-content">
        <h2>
            Criar Novo Perfil
        </h2>
        <div style="display: flex; align-items: center; justify-content: space-between; gap: 10px; width: 100%; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 5px; flex: 1; min-width: 0;">
                <label style="width: auto !important; min-width: 0 !important; margin: 0; font-weight: bold; font-size: 14px;">
                    Nome:
                </label>
                <input type="text" id="nomeNovoPerfil" placeholder="Ex: Professor" style="flex: 1; min-width: 50px; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
            </div>
            <div style="display: flex; align-items: center; gap: 5px; flex: 0 0 auto;">
                <label style="width: auto !important; min-width: 0 !important; margin: 0; font-weight: bold; font-size: 14px;">
                    Abrev:
                </label>
                <input type="text" id="abreviacaoNovoPerfil" placeholder="Ex:Prof" maxlength="8" style="width: 75px !important; text-align: center; padding: 6px 2px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
            </div>
            <div id="btnVisualCorNovo" class="botao-cor-custom" onclick="abrirSeletorInteligente('novo')" title="Escolher cor" style="margin: 0; flex-shrink: 0;">
            </div>
            <input type="hidden" id="corNovoPerfil" value="#007bff">
            <input type="color" id="nativeCorNovo" style="visibility:hidden; position:absolute; left:-9999px;" onchange="atualizarCorInteligente('novo', this.value)">
        </div>
        <div class="modal-buttons">
            <button class="btn-fechar" onclick="fecharModalNovoPerfil()">
                Cancelar
            </button>
            <button class="btn-adicionar" onclick="salvarNovoPerfilBanco()">
                Criar
            </button>
        </div>
    </div>
</div>
<div id="modalPermissoes" class="modal-overlay">
    <div class="modal-content" style="max-width: 450px;">
        <div class="header-flex-smart">
            <span class="titulo-smart">
                Permissões:
            </span>
            <div class="grupo-nome-lixo-smart">
                <span id="textoNomePerfil">
                    Carregando...
                </span>
                <div id="btnVisualCorEdicao" class="botao-cor-custom" onclick="abrirSeletorInteligente('edicao')" style="width: 30px; height: 30px; margin-right: 10px;">
                </div>
                <input type="hidden" id="corPerfilEdicao">
                <input type="color" id="nativeCorEdicao" style="visibility:hidden; position:absolute; left:-9999px;" onchange="atualizarCorInteligente('edicao', this.value)">
                <button id="btnExcluirPerfil" onclick="excluirPerfilAtual()" class="btn-lixo-smart" title="Excluir" style="display: none;">
                    🗑️
                </button>
            </div>
        </div>
        <div style="text-align: left; margin: 10px 0;">
            <p class="texto-instrucao" style="font-size: 14px; color: #666; margin-bottom: 15px;">
                Marque o que este perfil pode fazer:
            </p>
            <div class="lista-permissoes" style="display: flex; flex-direction: column; gap: 12px;">
                <label style="font-weight: normal; cursor: pointer; display: flex; align-items: center; background: #e3f2fd; padding: 8px; border-radius: 4px; border: 1px solid #bbdefb; width: 100%; box-sizing: border-box;">
                    <input type="checkbox" id="perm_super_admin" onchange="gerenciarPermissoesInterativas('MASTER')" style="width: auto; margin-right: 10px; transform: scale(1.2);">
                    ⚡
                    <strong>
                        Acesso Total (Super Admin)
                    </strong>
                </label>
                <hr style="width: 100%; border-top: 1px dashed #ccc; margin: 5px 0;">
                <label style="font-weight: normal; cursor: pointer; display: flex; align-items: center;">
                    <input type="checkbox" id="perm_acesso_config" onchange="gerenciarPermissoesInterativas('CHILD')" style="width: auto; margin-right: 10px;">
                    Acessar Configurações (Esta tela)
                </label>
                <label style="font-weight: normal; cursor: pointer; display: flex; align-items: center;">
                    <input type="checkbox" id="perm_gestao_jogadores" onchange="gerenciarPermissoesInterativas('CHILD')" style="width: auto; margin-right: 10px;">
                    Gestão de Jogadores (Cadastro)
                </label>
                <label style="font-weight: normal; cursor: pointer; display: flex; align-items: center;">
                    <input type="checkbox" id="perm_gerir_reservas" onchange="gerenciarPermissoesInterativas('CHILD')" style="width: auto; margin-right: 10px;">
                    Gerenciar Reservas (Editar/Cancelar terceiros)
                </label>
                <label style="font-weight: normal; cursor: pointer; display: flex; align-items: center;">
                    <input type="checkbox" id="perm_controle_quadras" onchange="gerenciarPermissoesInterativas('CHILD')" style="width: auto; margin-right: 10px;">
                    Controle de Quadras (Bloqueios)
                </label>
                <label style="font-weight: normal; cursor: pointer; display: flex; align-items: center;">
                    <input type="checkbox" id="perm_gestor_aulas" onchange="gerenciarPermissoesInterativas('CHILD')" style="width: auto; margin-right: 10px;">
                    Gestor de Aulas (Grade/Professor)
                </label>
                <label style="font-weight: normal; cursor: pointer; display: flex; align-items: center;">
                    <input type="checkbox" id="perm_gestor_torneios" onchange="gerenciarPermissoesInterativas('CHILD')" style="width: auto; margin-right: 10px;">
                    Gestor de Torneios (Ranking/Pirâmide)
                </label>
            </div>
        </div>
        <div class="modal-buttons">
            <button class="btn-fechar" onclick="fecharModalPermissoes()">
                Cancelar
            </button>
            <button class="btn-adicionar" onclick="salvarPermissoesBanco()">
                Salvar Alterações
            </button>
        </div>
    </div>
</div>
<button id="theme-toggle-button" onclick="toggleTheme()" title="Alternar Tema">
    🌙
</button>
<div id="toastContainer" class="toast-container">
</div>
<div id="modalConfirmacaoGlobal" class="modal-overlay" style="z-index: 10000;">
    <div class="modal-content">
        <h3 id="tituloConf">
            Confirmação
        </h3>
        <p id="textoConf">
            Tem certeza que deseja realizar esta ação?
        </p>
        <div class="modal-buttons" style="justify-content: center; gap: 15px;">
            <button class="btn-fechar" id="btnCancelarConf" style="background-color: #6c757d; width: 100px;">
                Não
            </button>
            <button class="btn-adicionar" id="btnConfirmarConf" style="width: 100px;">
                Sim
            </button>
        </div>
    </div>
</div>
<div id="modalInputGlobal" class="modal-overlay" style="z-index: 10001;">
    <div class="modal-content">
        <h3 id="tituloInput">
            Entrada de Dados
        </h3>
        <p id="textoInput">
            Por favor, digite abaixo:
        </p>
        <input type="text" id="campoInputGlobal" class="select-padrao" style="width: 100%; margin: 10px 0; border: 1px solid #ccc; padding: 8px;">
        <div class="modal-buttons" style="justify-content: center; gap: 15px;">
            <button class="btn-fechar" id="btnCancelarInput" style="background-color: #6c757d; width: 100px;">
                Cancelar
            </button>
            <button class="btn-adicionar" id="btnConfirmarInput" style="width: 100px;">
                OK
            </button>
        </div>
    </div>
</div>
<div id="modalSeletorPC" class="modal-overlay" style="z-index: 10002;">
    <div class="modal-content">
        <h3>
            Escolha uma Cor
        </h3>
        <div id="gridCoresPC" class="grid-cores-pc">
        </div>
        <div class="modal-buttons" style="justify-content: center; margin-top: 20px;">
            <button class="btn-fechar" onclick="document.getElementById('modalSeletorPC').style.display='none'">
                Cancelar
            </button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "agenda-5ce95.firebaseapp.com",
        databaseURL: "https://agenda-5ce95-default-rtdb.firebaseio.com/",
        projectId: "agenda-5ce95",
        storageBucket: "agenda-5ce95.appspot.com",
        messagingSenderId: "852007565195",
        appId: "1:852007565195:web:d7bd789d140858f53f618e"
    };
    const app = firebase.initializeApp(firebaseConfig); 
    const db = firebase.database();

    // VARIÁVEIS GLOBAIS
    let bloqueiosQuadra = {};
    let quebraHorarioQuadrasConfig = {};
    let listaUsuariosOnline = [];
    let quadraAtualParaBloqueio = null;
    let vlimparBloqueiosAntigos = false;

    // NOVAS GLOBAIS DE HORÁRIO
    let horariosGlobal = { Padrao: {}, Especiais: {} };
    let periodoEmEdicaoID = null;
		
	// --- VARIÁVEIS DO GERENCIADOR DE AULAS ---
	let configAulasGlobal = { Quadra1: {}, Quadra2: {}, Quadra3: {} };
	let quadraAulaAtual = 'Quadra1';
	
	let configDuplasGlobal = { 
    Quadra1: { Ativo: false, Ranking: false, Grade: {} }, 
    Quadra2: { Ativo: false, Ranking: false, Grade: {} }, 
    Quadra3: { Ativo: false, Ranking: false, Grade: {} } 
	};
	let quadraDuplasAtual = 'Quadra1';
	let carrinhoDuplas = {}; // Rascunho para salvar no final
	
	let perfilEmEdicaoAtual = null; // Guarda quem está sendo editado agora
	
	var dadosOriginaisCache = {};
	
	// --- VARIÁVEIS GLOBAIS DA PIRÂMIDE ---
	let configPiramideGlobal = { 
    Ativo: false, 
    Ranking: false, 
    Quadra1: { Grade: {} }, 
    Quadra2: { Grade: {} }, 
    Quadra3: { Grade: {} } 
	};
	let quadraPiramideAtual = 'Quadra1';
	let carrinhoPiramide = {}; // Carrinho para o salvamento final
	
	// --- VARIÁVEIS GLOBAIS DE CONVIDADOS ---
	let configConvidadosGlobal = { 
        Ativo: false, 
        Quadra1: { Ativa: false, Grade: {} }, 
        Quadra2: { Ativa: false, Grade: {} }, 
        Quadra3: { Ativa: false, Grade: {} } 
	};
	let quadraConvidadosAtual = 'Quadra1';
	let carrinhoConvidados = {};


// ==========================================================
    // === LÓGICA DE PERFIS E PERMISSÕES (Passo 2) ===
    // ==========================================================
    
    let perfisGlobal = {}; // Variável para guardar os perfis na memória do navegador
	
	// --- LÓGICA DO SELETOR DE CORES HÍBRIDO ---
	const CORES_DISPONIVEIS = [
		'#dc3545', '#007bff', '#28a745', '#ffc107', '#fd7e14', 
		'#6f42c1', '#e83e8c', '#17a2b8', '#343a40', '#6c757d'
	];
	let modoCorAtual = ''; // 'novo' ou 'edicao'
	

// --- VARIÁVEIS DE CONTROLE DE ESTADO ---
var existeAlteracaoPendente = false; // "Bandeira" que diz se mexeu em algo
var carrinhoPermissoes = {}; // O "Carrinho" onde guardaremos as mudanças da janelinha
var carrinhoAulas = {};      // Para a Grade de Aulas
var carrinhoHorarioPadrao = {}; // Para o Horário Padrão (Abre/Fecha)
var carrinhoHorarioEspecial = {};

var intervaloPontosBotao = null;


// --- FUNÇÃO QUE ATIVA O ALERTA (BOTÃO LARANJA) ---
function marcarComoAlterado() {
    if (!existeAlteracaoPendente) {
        existeAlteracaoPendente = true;
        
        const btn = document.getElementById('btnSalvarGlobal'); 
        if (btn) {
            btn.classList.add("botao-alterado"); 

            // Criamos uma estrutura onde o texto é fixo e os pontos ficam num "box" de tamanho fixo
            // O estilo inline width: 20px garante que o espaço dos 3 pontos já esteja reservado
            btn.innerHTML = `Salvar Alterações <span id="pontos-animados" style="display: inline-block; width: 20px; text-align: left;">.</span>`;
            
            let contador = 1;
            const spanPontos = document.getElementById('pontos-animados');

            if (intervaloPontosBotao) clearInterval(intervaloPontosBotao);

            intervaloPontosBotao = setInterval(() => {
                contador++;
                if (contador > 3) contador = 1;
                
                let pontos = ".".repeat(contador);
                if (spanPontos) spanPontos.innerText = pontos;
            }, 500);
        }

        window.onbeforeunload = function() {
            return "Você tem alterações não salvas.";
        };
    }
}

    // 1. OUVINTE DO BANCO (Funciona em Tempo Real)
    // Sempre que algo mudar em 'sistemas/config/Perfis', este código roda sozinho.
    db.ref('sistemas/config/Perfis').on('value', snapshot => {
        perfisGlobal = snapshot.val() || {};
        
        // Se for a primeira vez e não tiver nada, cria o Admin automaticamente
        if (Object.keys(perfisGlobal).length === 0) {
            criarPerfilPadraoAdmin();
        }
        
        atualizarDropdownPerfis();
    });

    function criarPerfilPadraoAdmin() {
        db.ref('sistemas/config/Perfis/Admin').set({
            descricao: "Super Usuário Padrão",
            permissoes: { super_admin: true }
        });
    }
	

// --- FUNÇÃO QUE DESATIVA O ALERTA (APÓS SALVAR COM SUCESSO) ---
function resetarEstadoAlteracao() {
    existeAlteracaoPendente = false;
    
    if (intervaloPontosBotao) {
        clearInterval(intervaloPontosBotao);
        intervaloPontosBotao = null;
    }

    const btn = document.getElementById('btnSalvarGlobal');
    if (btn) {
        btn.classList.remove("botao-alterado"); 
        btn.style.background = ""; 
        // Voltamos para texto puro para limpar o HTML da span
        btn.innerText = "Salvar Configurações"; 
    }
    
    window.onbeforeunload = null;
}



 // --- FUNÇÃO AUXILIAR BLINDADA: Pinta a caixinha com !important ---
    function atualizarCorDoCampo(select) {
        if (!select || select.selectedIndex < 0) return;
        
        const selectedOption = select.options[select.selectedIndex];
        
        // Se a opção tem uma cor salva (data-cor)
        if (selectedOption && selectedOption.getAttribute('data-cor')) {
            const cor = selectedOption.getAttribute('data-cor');
            
            // O segredo: 'important' impede que o navegador resete a cor ao clicar fora
            select.style.setProperty('background-color', cor, 'important');
            select.style.setProperty('color', '#ffffff', 'important');
            
            select.style.fontWeight = 'bold';
            select.style.border = '1px solid ' + cor;
        } else {
            // Volta ao padrão
            select.style.removeProperty('background-color');
            select.style.removeProperty('color');
            select.style.backgroundColor = '#ffffff';
            select.style.color = '#333';
            select.style.fontWeight = 'normal';
            select.style.border = '1px solid #ced4da';
        }
    }

    // Manipulador de eventos unificado
    function handleSelectEvent(e) {
        atualizarCorDoCampo(e.target);
        // Se for mudança de valor, atualiza o resumo
        if (e.type === 'change') {
            atualizarResumoVisual();
        }
    }

    // 2. PREENCHE O DROPDOWN (Menu de Perfis) - VERSÃO FINAL
    function atualizarDropdownPerfis() {
        const select = document.getElementById('perfilSelect');
        if (!select) return;

        const valorAtual = select.value; 
        select.innerHTML = ''; 
        
        // Cores Padrão
        const coresPadrao = {
            'Admin':     '#dc3545', // Vermelho
            'Professor': '#198754', // Verde
            'Arbitro':   '#fd7e14', // Laranja
            'Operador':  '#007bff', // Azul
            'Socio':     '#6c757d', // Cinza
            'Visitante': '#6c757d'  // Cinza
        };

        Object.keys(perfisGlobal).forEach(nomePerfil => {
            const dados = perfisGlobal[nomePerfil]; 
            const option = document.createElement('option');
            option.value = nomePerfil;
            option.textContent = nomePerfil;

            const corFinal = (dados && dados.cor) ? dados.cor : coresPadrao[nomePerfil];

            if (corFinal) {
                option.style.backgroundColor = corFinal;
                option.style.color = '#ffffff';
                option.style.fontWeight = 'bold';
                option.setAttribute('data-cor', corFinal); 
            }

            select.appendChild(option);
        });

        if (perfisGlobal[valorAtual]) {
            select.value = valorAtual;
        } else if (select.options.length > 0) {
            select.selectedIndex = 0;
        }
        
        // 1. Pinta imediatamente
        atualizarCorDoCampo(select);

        // 2. Remove listeners antigos para não acumular
        select.removeEventListener('change', handleSelectEvent);
        select.removeEventListener('blur', handleSelectEvent); // Novo: vigia quando clica fora
        
        // 3. Adiciona listeners para MUDANÇA e PERDA DE FOCO
        select.addEventListener('change', handleSelectEvent);
        select.addEventListener('blur', handleSelectEvent);

        atualizarResumoVisual();
    }
	
	
	
	
    // Manipulador separado para o evento de mudança
    function handleSelectChange(e) {
        atualizarCorDoCampo(e.target);
        // Se houver lógica original de mostrar detalhes no onchange do HTML, ela roda normalmente.
        // Se for necessário chamar explicitamente aqui: mostrarDetalhesPerfil();
    }



// 3. ATUALIZA O VISUAL DO CAMPO "PERMISSÕES" (Lista Apenas Leitura)
    function atualizarResumoVisual() {
        const perfilSelecionado = document.getElementById('perfilSelect').value;
        const dados = perfisGlobal[perfilSelecionado] || {};
        const perms = dados.permissoes || {};
        
        const selectResumo = document.getElementById('permissoesSelect');
        const btnLapis = document.getElementById('btnEditarPermissoes');
        
        // --- 1. REGRA DO LÁPIS ---
        if (perfilSelecionado === 'Admin') {
            if (btnLapis) {
                btnLapis.disabled = true; 
                btnLapis.title = "O perfil Admin possui acesso total irrestrito.";
            }
        } else {
            if (btnLapis) {
                btnLapis.disabled = false; 
                btnLapis.title = "Editar Permissões";
            }
        }

        // --- 2. REGRA DO CAMPO VISUAL ---
        const temAcessoTotal = (perfilSelecionado === 'Admin' || perms.super_admin === true);

        if (temAcessoTotal) {
            if (selectResumo) selectResumo.disabled = true; 
        } else {
            if (selectResumo) selectResumo.disabled = false; 
        }
        
        // --- 3. PREENCHER O CONTEÚDO ---
        selectResumo.innerHTML = ''; 
        
        // CENÁRIO A: ACESSO TOTAL
        if (temAcessoTotal) {
            const opt = document.createElement('option');
            opt.text = "⚡Acesso Total";
            opt.style.fontWeight = "bold";
            selectResumo.add(opt);
            return;
        }

        // CENÁRIO B: COLETAR PERMISSÕES
        const nomesCurtos = {
            acesso_config: "Configurações",
            gestao_jogadores: "Cadastro",
            gerir_reservas: "Reservas",
            controle_quadras: "Quadras",
            gestor_aulas: "Aulas",
            gestor_torneios: "Torneios"
        };

        let listaPermissoes = [];
        Object.keys(nomesCurtos).forEach(chave => {
            if (perms[chave] === true) {
                listaPermissoes.push(nomesCurtos[chave]);
            }
        });

        // CENÁRIO C: SEM ACESSO
        if (listaPermissoes.length === 0) {
            const opt = document.createElement('option');
            opt.text = "Sem Acesso";
            selectResumo.add(opt);
        } 
        // CENÁRIO D: PARCIAIS (LEITURA APENAS)
        else {
            // 1. CAPA (Parciais...)
            const optCapa = document.createElement('option');
            optCapa.text = "Parciais...";
            optCapa.value = "";
            optCapa.disabled = true; 
            optCapa.selected = true; 
            optCapa.hidden = true;   // Some ao abrir
            optCapa.style.fontStyle = "italic"; 
            selectResumo.add(optCapa);

            // 2. ITENS DA LISTA (Bloqueados para clique)
            listaPermissoes.forEach(nome => {
                const opt = document.createElement('option');
                opt.text = nome; // Ex: "Cadastro"
                
                // O TRUQUE: Desabilita o item para não ser selecionável
                opt.disabled = true; 
                
                // Tenta manter a cor escura para leitura (alguns browsers ignoram e deixam cinza)
                opt.style.color = "#000"; 
                opt.style.fontWeight = "bold";

                selectResumo.add(opt);
            });
        }
}	
	
	
	
    // Quando o usuário muda o perfil no dropdown, atualiza o resumo
    // Verifique se o elemento 'perfilSelect' existe antes de adicionar o evento
    const elPerfilSelect = document.getElementById('perfilSelect');
    if(elPerfilSelect) {
        elPerfilSelect.addEventListener('change', atualizarResumoVisual);
    }


    // --- FUNÇÕES DO MODAL "CRIAR NOVO PERFIL" (Botão +) ---

// SUBSTITUA A FUNÇÃO abrirModalAdicionarPerfil POR ESTA:
function abrirModalAdicionarPerfil() {
    // 1. Limpa os campos de texto
    document.getElementById('nomeNovoPerfil').value = '';
    document.getElementById('abreviacaoNovoPerfil').value = '';

    // 2. Define a cor inicial como Azul (#007bff)
    // Chama nossa função inteligente que já pinta o botão visual e atualiza os inputs escondidos
    atualizarCorInteligente('novo', '#007bff');
    
    // 3. Mostra o modal
    document.getElementById('modalNovoPerfil').style.display = 'flex';
    
    // 4. Foca no input de nome
    setTimeout(() => document.getElementById('nomeNovoPerfil').focus(), 100);
}

    function fecharModalNovoPerfil() {
        document.getElementById('modalNovoPerfil').style.display = 'none';
    }

// SUBSTITUA A FUNÇÃO salvarNovoPerfilBanco POR ESTA:
// ================================================================= 
// === FUNÇÃO ATUALIZADA: VALIDAÇÃO DE CAMPOS OBRIGATÓRIOS       === 
// ================================================================= 
function salvarNovoPerfilBanco() {
    // 1. Pega os valores brutos dos campos
    const inputNome = document.getElementById('nomeNovoPerfil').value;
    const inputAbrev = document.getElementById('abreviacaoNovoPerfil').value;
    const cor = document.getElementById('corNovoPerfil').value;

    // 2. APLICA A FORMATAÇÃO (Aqui está a mágica)
    // Transforma "joão silva" em "João Silva"
    const nome = formatarTexto(inputNome);
    const abreviacao = formatarTexto(inputAbrev);

    // 3. VALIDAÇÃO DO NOME (Obrigatório)
    if (!nome) {
        document.getElementById('nomeNovoPerfil').focus();
        return mostrarNotificacao("Por favor, digite um Nome para o perfil.", 'warning');
    }

    // 4. VALIDAÇÃO DA ABREVIAÇÃO (Obrigatório)
    if (!abreviacao) {
        document.getElementById('abreviacaoNovoPerfil').focus();
        return mostrarNotificacao("A Abreviação é obrigatória (Ex: Prof, Jog).", 'warning');
    }

    // 5. Verifica se já existe um perfil com esse nome exato
    if (perfisGlobal[nome]) {
        return mostrarNotificacao("Já existe um perfil com este nome.", 'error');
    }

    // 6. Salva no Banco de Dados
    db.ref(`sistemas/config/Perfis/${nome}`).set({
        descricao: "Criado via Configurações",
        abreviacao: abreviacao, // Agora salva formatado
        cor: cor,
        permissoes: { acesso_config: false } 
    }).then(() => {
        mostrarNotificacao(`Perfil "${nome}" criado com sucesso!`, 'success');
        fecharModalNovoPerfil();
    }).catch(error => {
        console.error(error);
        mostrarNotificacao("Erro ao criar perfil.", 'error');
    });
}



    // --- FUNÇÕES DO MODAL "EDITAR PERMISSÕES" (Botão Lápis ✏️) ---

function abrirModalPermissoes() {
    const perfil = document.getElementById('perfilSelect').value;
    if (!perfil) return mostrarNotificacao("Nenhum perfil selecionado.", 'warning');

    // 1. Guarda o perfil atual para saber quem editar
    perfilEmEdicaoAtual = perfil;

    // 2. Carrega os dados do perfil
    const dadosPerfil = perfisGlobal[perfil] || {};
    const corAtual = dadosPerfil.cor || '#000000'; // Usa preto se não tiver cor salva

    // 3. ATUALIZA O BOTÃO CAMALEÃO (Pinta o visual e prepara os inputs)
    atualizarCorInteligente('edicao', corAtual);

    // 4. Atualiza o título e mostra o modal
    document.getElementById('textoNomePerfil').innerText = perfil;
    document.getElementById('modalPermissoes').style.display = 'flex';

    // 5. Verifica se é Admin (para esconder o botão de excluir)
    if (perfil === 'Admin') {
        document.getElementById('btnExcluirPerfil').style.display = 'none';
    } else {
        document.getElementById('btnExcluirPerfil').style.display = 'inline-block';
    }

    // 6. Preenche os Checkboxes existentes (mantendo sua lógica original)
    const perms = dadosPerfil.permissoes || {};
    const mapa = {
        'perm_super_admin': 'super_admin',
        'perm_acesso_config': 'acesso_config',
        'perm_gestao_jogadores': 'gestao_jogadores',
        'perm_gerir_reservas': 'gerir_reservas',
        'perm_controle_quadras': 'controle_quadras',
        'perm_gestor_aulas': 'gestor_aulas',
        'perm_gestor_torneios': 'gestor_torneios',
        'perm_acesso_financeiro': 'acesso_financeiro'
    };

    for (const [idElemento, chaveBanco] of Object.entries(mapa)) {
        const el = document.getElementById(idElemento);
        if (el) {
            el.checked = (perms[chaveBanco] === true);
        }
    }
    
    // 7. Inicializa a interatividade (bloqueio de filhos se super admin estiver marcado)
    if (typeof gerenciarPermissoesInterativas === 'function') {
        gerenciarPermissoesInterativas('INIT');
    }
}




	


function excluirPerfilAtual() {
    if (!perfilEmEdicaoAtual) return;

    // Confirmação de segurança
    if (!confirm(`Tem certeza que deseja excluir o perfil "${perfilEmEdicaoAtual}"?\n\nISSO REMOVERÁ ESTE PERFIL DE TODOS OS JOGADORES QUE O POSSUEM.`)) {
        return;
    }

    const perfilParaApagar = perfilEmEdicaoAtual;

    mostrarNotificacao("Iniciando varredura e exclusão...", "info");

    // 1. PRIMEIRO: Remove a definição do perfil (Configurações)
    const p1 = db.ref(`sistemas/config/Perfis/${perfilParaApagar}`).remove();

    // 2. SEGUNDO: Varre todos os jogadores para remover esse perfil (Cadastro)
    const p2 = db.ref('sistemas/cadastro/jogadores').once('value').then(snapshot => {
        const updates = {};
        let count = 0;

        snapshot.forEach(childSnapshot => {
            const keyJogador = childSnapshot.key;
            const dadosJogador = childSnapshot.val();

            // Verifica se o jogador tem esse perfil
            if (dadosJogador.perfis && dadosJogador.perfis[perfilParaApagar]) {
                // Cria o comando para apagar APENAS essa chave específica
                updates[`sistemas/cadastro/jogadores/${keyJogador}/perfis/${perfilParaApagar}`] = null;
                count++;
            }
        });

        // Se encontrou jogadores com esse perfil, manda o update em lote
        if (count > 0) {
            console.log(`Removendo perfil de ${count} jogadores...`);
            return db.ref().update(updates);
        } else {
            return Promise.resolve();
        }
    });

    // Quando as duas tarefas terminarem
    Promise.all([p1, p2])
        .then(() => {
            mostrarNotificacao(`Perfil "${perfilParaApagar}" excluído e removido de todos os jogadores!`, "success");
            fecharModalPermissoes();
        })
        .catch(erro => {
            console.error(erro);
            mostrarNotificacao("Erro ao excluir perfil.", "error");
        });
}


    function fecharModalPermissoes() {
        document.getElementById('modalPermissoes').style.display = 'none';
    }




function salvarPermissoesBanco() {
    // Verifica se temos um perfil selecionado
    if (!perfilEmEdicaoAtual) {
        mostrarNotificacao("Erro: Nenhum perfil em edição.", "error");
        return;
    }

    const updates = {};
    
    // --- AQUI ESTAVA O ERRO E AQUI ESTÁ A CORREÇÃO ---
    // Antes: `sistemas/config/Perfis/...` (Isso duplicava o caminho)
    // Agora: `Perfis/...` (Isso encaixa perfeito no salvamento principal)
    const caminhoBase = `Perfis/${perfilEmEdicaoAtual}/permissoes`;

    // 1. CAPTURA O ESTADO DOS CHECKBOXES
    updates[`${caminhoBase}/super_admin`] = document.getElementById('perm_super_admin').checked;
    updates[`${caminhoBase}/acesso_config`] = document.getElementById('perm_acesso_config').checked;
    updates[`${caminhoBase}/gestao_jogadores`] = document.getElementById('perm_gestao_jogadores').checked;
    updates[`${caminhoBase}/gerir_reservas`] = document.getElementById('perm_gerir_reservas').checked;
    updates[`${caminhoBase}/controle_quadras`] = document.getElementById('perm_controle_quadras').checked;
    updates[`${caminhoBase}/gestor_aulas`] = document.getElementById('perm_gestor_aulas').checked;
    updates[`${caminhoBase}/gestor_torneios`] = document.getElementById('perm_gestor_torneios').checked;

    // 2. MÁGICA DO CARRINHO
    Object.assign(carrinhoPermissoes, updates);

    // 3. AVISO VISUAL
    marcarComoAlterado();

    // 4. FECHAR E AVISAR
    fecharModalPermissoes(); 
    mostrarNotificacao("Permissões no carrinho! <br>Clique em <b>Salvar Configurações</b> para gravar de verdade.", "info");
}




    window.onload = function() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('content').style.display = 'none';
        carregarConfiguracoes().then(() => {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
            atualizarEstadoSistema(); 
			// --- ADICIONE AQUI ---
			carregarListaProfessores(); 
			carregarListaFinanceiro();
			// ---------------------
        }).catch(console.error);
    };

    function carregarConfiguracoes() {
        return new Promise((resolve, reject) => {
            db.ref("sistemas/config").once("value").then(snapshot => {
                const data = snapshot.val();
                if(data) aplicarDadosConfig(data);
                resolve();
            }).catch(reject);

            db.ref("sistemas/config").on("value", snapshot => {
                const data = snapshot.val();
                if(data) aplicarDadosConfig(data);
            });
            
            // Listener de horários (SUBSTITUA POR ESTE BLOCO ATUALIZADO)
            db.ref("sistemas/config/Horarios").on("value", snapshot => {
                const data = snapshot.val() || { Padrao: {}, Especiais: {}, Aulas: {} }; 
                
                // 1. Atualiza a memória global
                horariosGlobal = data;

                // 2. Sincroniza a memória específica das aulas
                if (data.Aulas) {
                    configAulasGlobal = data.Aulas;
                } else {
                    configAulasGlobal = { Quadra1: {}, Quadra2: {}, Quadra3: {} };
                }

                // 3. O PULO DO GATO (ATUALIZAÇÃO EM TEMPO REAL):
                // Verifica se a janela de Aulas está aberta neste momento.
                const modalAulas = document.getElementById('modalHorarioAulas');
                
                if (modalAulas && modalAulas.style.display === 'flex') {
                    // Se estiver aberta, força o redesenho da tela!
                    // O parâmetro 'true' é CRUCIAL aqui: ele diz "apenas carregue, não salve o que está na tela agora"
                    // Isso impede que o celular (que tem dados velhos) sobrescreva os dados novos que acabaram de chegar do PC.
                    if (typeof selecionarQuadraAula === "function") {
                        selecionarQuadraAula(quadraAulaAtual, true);
                    }
                }
            });
        });
    }



function aplicarDadosConfig(data) {

    // --- CORREÇÃO: Cria uma CÓPIA SEGURA dos dados (Snapshot) ---
    // Isso impede que alterações na tela mudem o cache antes da hora
    dadosOriginaisCache = JSON.parse(JSON.stringify(data || {}));
	
    document.getElementById('sistema').value = data.Abrir ? 'ON' : 'OFF';

    document.getElementById('diasParaAgendar').value = (6 - (data.DiasParaLimpar || 6)).toString();
    document.getElementById('reservasPorConfirmacao').value = data.ReservasPorConfirmacao ? 'ON' : 'OFF';
    document.getElementById('horasParaExpirar').value = data.horasParaExpirar || '2';
    document.getElementById('edicaoOrganizador').value = data.OrganizadorEdicao ? 'ON' : 'OFF';


    // 1. Lê a nova chave 'OtimizacaoHorarios' (ou cria padrão desligado)
    const configOtimizacao = data.OtimizacaoHorarios || { ativa: false, quadras: {} };

    // 2. Aplica o valor ao select
    document.getElementById('otimizacaoHorarios').value = configOtimizacao.ativa ? 'ON' : 'OFF';

    // 3. Carrega as quadras na variável global
    quebraHorarioQuadrasConfig = configOtimizacao.quadras || {};

    // 4. Chama a função visual com o NOVO NOME
    atualizarVisualOtimizacao();


    atualizarEstadoConfirmacao();
    atualizarEstadoEdicaoOrganizador();

    bloqueiosQuadra = data.Quadras?.Bloqueios || {};
    document.getElementById('estadoQuadra1').value = data.Quadras?.Quadra1 || "liberada";
    document.getElementById('estadoQuadra2').value = data.Quadras?.Quadra2 || "liberada";
    document.getElementById('estadoQuadra3').value = data.Quadras?.Quadra3 || "liberada";


       

    // --- NOVA IMPLEMENTAÇÃO: LIMPEZA DO MURAL ---
    // 1. Recupera o valor salvo no Firebase ou usa 7 como padrão
    const diasMural = data.LimpezaMural || 7;
    const selectMural = document.getElementById('selectLimpezaMural');

    // Só executa se o elemento existir no HTML
    if (selectMural) {
        let opcaoEncontrada = false;

        // 2. Verifica se o valor salvo já existe nas opções padrão (1, 2, 3, 7, 30)
        for (let i = 0; i < selectMural.options.length; i++) {
            if (selectMural.options[i].value == diasMural) {
                selectMural.selectedIndex = i;
                opcaoEncontrada = true;
                break;
            }
        }

        // 3. Se não encontrou (é um valor personalizado, ex: 15), cria a opção visualmente
        if (!opcaoEncontrada) {
            // Remove opção custom anterior se houver (para não duplicar ao recarregar)
            const optAntiga = selectMural.querySelector('option[data-custom="true"]');
            if (optAntiga) optAntiga.remove();

            const novaOpcao = document.createElement('option');
            novaOpcao.value = diasMural;
            novaOpcao.text = `${diasMural} dias (Personalizado)`;
            novaOpcao.setAttribute('data-custom', 'true'); // Marca interna

            // Insere a nova opção antes do "Outros..." (value='custom')
            const opcaoOutros = selectMural.querySelector('option[value="custom"]');
            if (opcaoOutros) {
                selectMural.insertBefore(novaOpcao, opcaoOutros);
            } else {
                selectMural.appendChild(novaOpcao);
            }
            
            // Seleciona a nova opção criada
            selectMural.value = diasMural;
        }
    }
}


// --- FUNÇÃO AUXILIAR PARA TRADUZIR OS DIAS DO MURAL ---
function traduzirDiasMural(dias) {
    if (!dias) return "Não configurado";
    const mapa = {
        1: "1 dia",
        2: "2 dias",
        3: "3 dias",
        7: "1 semana (7 dias)",
        30: "1 mês (30 dias)"
    };
    return mapa[dias] || `${dias} dias (Personalizado)`;
}





function salvarConfiguracoes() {
    // --- 1. PREPARAÇÃO DOS VALORES NOVOS (DA TELA) ---
    const domSistema = document.getElementById('sistema').value === 'ON';
    const domDiasAgendar = parseInt(document.getElementById('diasParaAgendar').value);
    const domConfirmacao = document.getElementById('reservasPorConfirmacao').value === 'ON';
    const domHoras = parseInt(document.getElementById('horasParaExpirar').value);
    const domOrganizador = document.getElementById('edicaoOrganizador').value === 'ON';
    
    // Perfil Professor
    const elProfessor = document.getElementById('perfilSelect');
    const domProfessor = elProfessor ? elProfessor.value : "";

    // Otimização
    const domOtimizacao = document.getElementById('otimizacaoHorarios').value === 'ON';
    
    // Mural
    const selectMural = document.getElementById('selectLimpezaMural');
    const domMural = selectMural ? parseInt(selectMural.value) : 7;

    // Converte Dias Visuais para valor do Banco
    const diasBancoNovo = 6 - domDiasAgendar;

    // --- 2. MONTAGEM DO PACOTE BÁSICO ---
    const updates = {
        Abrir: domSistema,
        Professor: domProfessor,
        DiasParaLimpar: diasBancoNovo, 
        LimpezaMural: domMural,
        ReservasPorConfirmacao: domConfirmacao,
        horasParaExpirar: domHoras,
        OrganizadorEdicao: domOrganizador,
        OtimizacaoHorarios: {
            ativa: domOtimizacao,
            quadras: quebraHorarioQuadrasConfig
        },
        Quadras: {
            Quadra1: document.getElementById('estadoQuadra1').value,
            Quadra2: document.getElementById('estadoQuadra2').value,
            Quadra3: document.getElementById('estadoQuadra3').value,
            Bloqueios: bloqueiosQuadra
        }
    };

    // --- 3. INJEÇÃO DOS CARRINHOS (UNIFICAÇÃO) ---
    
    // Injeta Permissões
    if (Object.keys(carrinhoPermissoes).length > 0) {
        Object.assign(updates, carrinhoPermissoes);
    }

    // Injeta Grade de Aulas
    if (Object.keys(carrinhoAulas).length > 0) {
        Object.keys(carrinhoAulas).forEach(quadraKey => {
            updates[`Horarios/Aulas/${quadraKey}`] = carrinhoAulas[quadraKey];
        });
    }
    
    // Injeta Grade de Duplas
    if (Object.keys(carrinhoDuplas).length > 0) {
        Object.keys(carrinhoDuplas).forEach(quadraKey => {
            updates[`Horarios/Duplas/${quadraKey}`] = carrinhoDuplas[quadraKey];
        });
    }

    // Injeta Nova Grade da Pirâmide
    if (Object.keys(carrinhoPiramide).length > 0) {
        updates['Horarios/Piramide'] = carrinhoPiramide;
    }

    // --- NOVO: Injeta Nova Grade de Convidados ---
    if (Object.keys(carrinhoConvidados).length > 0) {
        updates['Horarios/Convidados'] = carrinhoConvidados;
    }

    // Injeta Horário Padrão (Abre/Fecha)
    if (Object.keys(carrinhoHorarioPadrao).length > 0) {
        updates['Horarios/Padrao'] = carrinhoHorarioPadrao;
    }

    // Injeta Horários Especiais
    if (Object.keys(carrinhoHorarioEspecial).length > 0) {
        Object.keys(carrinhoHorarioEspecial).forEach(id => {
            updates[`Horarios/Especiais/${id}`] = carrinhoHorarioEspecial[id];
        });
    }

    // --- 4. GERAÇÃO DO RELATÓRIO DE COMPARAÇÃO ---
    let listaAlteracoes = [];
    
    const memoria = (typeof dadosOriginaisCache !== 'undefined' && dadosOriginaisCache) ? dadosOriginaisCache : {};
    
    // -- GERAL --
    if (domSistema !== (memoria.Abrir ? true : false)) {
        listaAlteracoes.push(`<li><b>Sistema:</b> ${memoria.Abrir ? 'ON' : 'OFF'} ➝ <b>${domSistema ? 'ON' : 'OFF'}</b></li>`);
    }
    const diasBancoVelho = (memoria.DiasParaLimpar !== undefined) ? memoria.DiasParaLimpar : 6;
    if (diasBancoNovo !== diasBancoVelho) {
        listaAlteracoes.push(`<li><b>Dias para Agendar:</b> ${6 - diasBancoVelho} ➝ <b>${6 - diasBancoNovo}</b></li>`);
    }
    const muralVelho = memoria.LimpezaMural || 7;
    if (domMural !== muralVelho) {
        listaAlteracoes.push(`<li><b>Mural:</b> ${traduzirDiasMural(muralVelho)} ➝ <b>${traduzirDiasMural(domMural)}</b></li>`);
    }
    const confVelho = memoria.ReservasPorConfirmacao ? true : false;
    if (domConfirmacao !== confVelho) {
        listaAlteracoes.push(`<li><b>Confirmação:</b> ${confVelho ? 'ON' : 'OFF'} ➝ <b>${domConfirmacao ? 'ON' : 'OFF'}</b></li>`);
    }
    const horasVelho = memoria.horasParaExpirar || 2;
    if (domHoras !== horasVelho) {
        listaAlteracoes.push(`<li><b>Horas para Expirar:</b> ${horasVelho}h ➝ <b>${domHoras}h</b></li>`);
    }
    const orgVelho = memoria.OrganizadorEdicao ? true : false;
    if (domOrganizador !== orgVelho) {
        listaAlteracoes.push(`<li><b>Edição Organizador:</b> ${orgVelho ? 'ON' : 'OFF'} ➝ <b>${domOrganizador ? 'ON' : 'OFF'}</b></li>`);
    }
    const profVelho = memoria.Professor || "";
    if (domProfessor !== profVelho) {
        listaAlteracoes.push(`<li><b>Professor:</b> ${profVelho || "(Nenhum)"} ➝ <b>${domProfessor || "(Nenhum)"}</b></li>`);
    }

    // -- DETECÇÃO DOS CARRINHOS NO RELATÓRIO --
    if (Object.keys(carrinhoPermissoes).length > 0) {
        listaAlteracoes.push(`<li><b>Permissões de Perfil:</b> Atualizadas.</li>`);
    }
    if (Object.keys(carrinhoAulas).length > 0) {
        listaAlteracoes.push(`<li><b>Grade de Aulas:</b> Atualizada.</li>`);
    }
    if (Object.keys(carrinhoDuplas).length > 0) {
        listaAlteracoes.push(`<li><b>Grade de Duplas:</b> Atualizada.</li>`);
    }
    if (Object.keys(carrinhoPiramide).length > 0) {
        listaAlteracoes.push(`<li><b>Grade da Pirâmide:</b> Atualizada.</li>`);
    }
    // --- NOVO: Mensagem da Nova Grade de Convidados ---
    if (Object.keys(carrinhoConvidados).length > 0) {
        listaAlteracoes.push(`<li><b>Grade de Convidados:</b> Atualizada.</li>`);
    }
    
    if (Object.keys(carrinhoHorarioPadrao).length > 0) {
        listaAlteracoes.push(`<li><b>Horários Padrão (Abre/Fecha):</b> Atualizados.</li>`);
    }
    if (Object.keys(carrinhoHorarioEspecial).length > 0) {
        listaAlteracoes.push(`<li><b>Horários Especiais (Feriados/Exceções):</b> Atualizados.</li>`);
    }
    // ----------------------------

    // -- QUADRAS --
    const q1Velho = memoria.Quadras?.Quadra1 || "liberada";
    if (updates.Quadras.Quadra1 !== q1Velho) listaAlteracoes.push(`<li><b>Status Quadra 1:</b> mudou.</li>`);
    const q2Velho = memoria.Quadras?.Quadra2 || "liberada";
    if (updates.Quadras.Quadra2 !== q2Velho) listaAlteracoes.push(`<li><b>Status Quadra 2:</b> mudou.</li>`);
    const q3Velho = memoria.Quadras?.Quadra3 || "liberada";
    if (updates.Quadras.Quadra3 !== q3Velho) listaAlteracoes.push(`<li><b>Status Quadra 3:</b> mudou.</li>`);

    // -- ESPECIAIS --
    const otimVelho = (memoria.OtimizacaoHorarios && memoria.OtimizacaoHorarios.ativa) ? true : false;
    if (domOtimizacao !== otimVelho) {
        listaAlteracoes.push(`<li><b>Otimização:</b> ${otimVelho ? 'ON' : 'OFF'} ➝ <b>${domOtimizacao ? 'ON' : 'OFF'}</b></li>`);
    }
        

    // --- 5. ENVIO FINAL ---
    db.ref("sistemas/config").update(updates)
        .then(() => {
            if (listaAlteracoes.length > 0) {
                const mensagemHTML = `
                    <div style="text-align: left;">
                        Configurações atualizadas:<br>
                        <ul style="margin-top: 5px; padding-left: 20px; line-height: 1.5;">
                            ${listaAlteracoes.join('')}
                        </ul>
                    </div>
                `;
                mostrarNotificacao(mensagemHTML, 'success');
            } else {
                mostrarNotificacao("Configurações salvas (Nenhuma alteração detectada).", 'success');
            }
            
            // --- LIMPEZA E RESET ---
            dadosOriginaisCache = JSON.parse(JSON.stringify(updates));
            if (typeof resetarEstadoAlteracao === 'function') {
                resetarEstadoAlteracao(); 
            }
        })
        .catch(error => { 
            console.error(error);  
            mostrarNotificacao("Erro ao salvar.", 'error'); 
        });
}


	

    // --- FUNÇÕES DE HORÁRIO ---
// --- FUNÇÕES DE HORÁRIO (ATUALIZADA COM PIRÂMIDE) ---
function abrirGerenciadorHorarios(tipo) {
    const select = document.getElementById('tipoConfiguracaoHorario');
    
    if (tipo === 'padrao') {
        renderizarTabelaPadrao();
        document.getElementById('modalHorarioPadrao').style.display = 'flex';
    } 
    else if (tipo === 'especial') {
        if (horariosGlobal && horariosGlobal.Especiais) {
            carrinhoHorarioEspecial = JSON.parse(JSON.stringify(horariosGlobal.Especiais));
        }
        
        // Reset da Tela Especial
        periodoEmEdicaoID = null;
        atualizarDropdownPeriodos();
        document.getElementById('selectPeriodoEspecial').value = ""; 
        document.getElementById('nomePeriodo').value = '';
        document.getElementById('dataInicioPeriodo').value = '';
        document.getElementById('dataFimPeriodo').value = '';
        document.getElementById('regraMestraInicio').value = '08:00';
        document.getElementById('regraMestraFim').value = '17:00';
        
        const containerDias = document.getElementById('containerListaDiasEspeciais');
        containerDias.innerHTML = '<p style="text-align: center; color: #999; margin-top: 30px; font-style: italic;">Defina as datas acima e clique em <b>"Gerar / Atualizar Dias"</b>.</p>';
        
        atualizarVisibilidadeBotaoExpandir();
        const modalEspecial = document.getElementById('modalHorarioEspecial');
        if(modalEspecial.classList.contains('modo-foco')) {
            alternarTelaCheiaEspecial();  
        }

        alternarEstadoFormulario(false);
        // A linha "renderizarTabelaEspecial();" que quebrava tudo foi APAGADA DAQUI!
        modalEspecial.style.display = 'flex';
    }
    else if (tipo === 'aulas') {
        if (horariosGlobal && horariosGlobal.Aulas) {
            configAulasGlobal = JSON.parse(JSON.stringify(horariosGlobal.Aulas));
        }
        ['Quadra1', 'Quadra2', 'Quadra3'].forEach(q => {
            if (!configAulasGlobal[q]) configAulasGlobal[q] = { Ativo: false, Professor: '', Grade: {} };
        });
        document.getElementById('modalHorarioAulas').style.display = 'flex';
        selecionarQuadraAula('Quadra1', true);
    }
    else if (tipo === 'duplas') {
        if (horariosGlobal && horariosGlobal.Duplas) {
            configDuplasGlobal = JSON.parse(JSON.stringify(horariosGlobal.Duplas));
        }
        ['Quadra1', 'Quadra2', 'Quadra3'].forEach(q => {
            if (!configDuplasGlobal[q]) configDuplasGlobal[q] = { Ativo: false, Ranking: false, Grade: {} };
            if (!configDuplasGlobal[q].Grade) configDuplasGlobal[q].Grade = {};
        });

        document.getElementById('modalHorarioDuplas').style.display = 'flex';
        selecionarQuadraDuplas('Quadra1', true);
    }
    // === BLOCO ATUALIZADO: PIRÂMIDE ===
    else if (tipo === 'piramide') {
        // Carrega os dados do nó Horarios/Piramide
        if (horariosGlobal && horariosGlobal.Piramide) {
            configPiramideGlobal = JSON.parse(JSON.stringify(horariosGlobal.Piramide));
        } else {
            // Estado inicial caso não exista nada no banco
            configPiramideGlobal = { 
                Ativo: false, 
                Ranking: false, 
                Quadra1: { Grade: {} }, 
                Quadra2: { Grade: {} }, 
                Quadra3: { Grade: {} } 
            };
        }
        
        // Garante que a estrutura das quadras e das grades exista
        ['Quadra1', 'Quadra2', 'Quadra3'].forEach(q => {
            if (!configPiramideGlobal[q]) configPiramideGlobal[q] = { Grade: {} };
            if (!configPiramideGlobal[q].Grade) configPiramideGlobal[q].Grade = {};
        });

        // Sincroniza os Switches do Menu Kebab com o estado atual (Global)
        const swAtivo = document.getElementById('switchAtivarPiramide');
        const swRanking = document.getElementById('switchRankingPiramide');
        if (swAtivo) swAtivo.checked = configPiramideGlobal.Ativo || false;
        if (swRanking) swRanking.checked = configPiramideGlobal.Ranking || false;

        // ---> LINHA ADICIONADA AQUI <---
        atualizarTextoDataPiramide();

        document.getElementById('modalHorarioPiramide').style.display = 'flex';
        
        // Inicia na Quadra 1 e já aplica o bloqueio visual se Ativo for false
        selecionarQuadraPiramide('Quadra1'); 
    }
	else if (tipo === 'convidados') {
        // 1. Carrega os dados salvos no banco ou cria um novo limpo
        if (horariosGlobal && horariosGlobal.Convidados) {
            configConvidadosGlobal = JSON.parse(JSON.stringify(horariosGlobal.Convidados));
        } else {
            configConvidadosGlobal = { Ativo: false, Quadra1: { Ativa: false, Grade: {} }, Quadra2: { Ativa: false, Grade: {} }, Quadra3: { Ativa: false, Grade: {} } };
        }
        
        // 2. Garante que a estrutura existe para não dar erro
        ['Quadra1', 'Quadra2', 'Quadra3'].forEach(q => {
            if (!configConvidadosGlobal[q]) configConvidadosGlobal[q] = { Ativa: false, Grade: {} };
            if (!configConvidadosGlobal[q].Grade) configConvidadosGlobal[q].Grade = {};
        });

        // --- NOVO: Preenche os campos financeiros com o que veio do banco ---
        document.getElementById('taxaConvidado').value = configConvidadosGlobal.Taxa || "";
        const selRecebedor = document.getElementById('recebedorConvidado');
        if (selRecebedor) selRecebedor.value = configConvidadosGlobal.Recebedor || "";
        // --------------------------------------------------------------------
		
		document.getElementById('whatsappConvidado').value = configConvidadosGlobal.Whatsapp || "";

        // 3. Mostra a janela
        document.getElementById('modalHorarioConvidados').style.display = 'flex';
        
        // 4. A MÁGICA: Pede para desenhar a tabela da Quadra 1!
        selecionarQuadraConvidados('Quadra1'); 
    }

    if (select) select.value = ""; 
}




// 2. Função de Estado do Formulário (Lógica centralizada)
function alternarEstadoFormulario(ativo, modoCriacao = false) {
    const divForm = document.getElementById('formPeriodoEspecial');
    const btnSalvar = document.getElementById('btnSalvarEspecial'); 
    const btnExcluir = document.getElementById('btnExcluirPeriodo');
    const btnGerar = document.getElementById('btnGerarDias'); 

    // 1. Bloqueia/Desbloqueia campos internos
    const elementos = divForm.querySelectorAll('input, select');
    elementos.forEach(el => el.disabled = !ativo);

    // 2. Visual do Formulário
    divForm.style.opacity = ativo ? '1' : '0.4';
    divForm.style.pointerEvents = ativo ? 'auto' : 'none';

    // 3. Lógica do Botão GERAR / ATUALIZAR DIAS (Melhoria Visual)
    if (btnGerar) {
        btnGerar.disabled = !ativo;
        if (ativo) {
            // ATIVO: Amarelo, com borda escura e sombra (Visual de Botão)
            btnGerar.style.backgroundColor = '#ffc107'; 
            btnGerar.style.color = '#000000';
            btnGerar.style.cursor = 'pointer';
            btnGerar.style.border = '1px solid #d39e00'; // Borda definida
            btnGerar.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)'; // Sombra 3D
            btnGerar.style.borderRadius = '4px'; // Cantos arredondados
        } else {
            // TRAVADO: Cinza e chapado (sem sombra)
            btnGerar.style.backgroundColor = '#cccccc';
            btnGerar.style.color = '#666666';
            btnGerar.style.cursor = 'not-allowed';
            btnGerar.style.border = '1px solid #999999';
            btnGerar.style.boxShadow = 'none'; // Remove a profundidade
        }
    }

    // 4. Lógica do Botão EXCLUIR
    if (btnExcluir) {
        btnExcluir.style.display = 'block'; 
        const deveDesabilitar = (!ativo || modoCriacao);
        btnExcluir.disabled = deveDesabilitar;
        
        if (deveDesabilitar) {
            btnExcluir.style.backgroundColor = '#cccccc';
            btnExcluir.style.cursor = 'not-allowed';
        } else {
            btnExcluir.style.backgroundColor = '#dc3545';
            btnExcluir.style.cursor = 'pointer';
        }
    }

    // 5. Lógica do Botão SALVAR
    if (btnSalvar && !ativo) {
        btnSalvar.disabled = true;
        btnSalvar.style.backgroundColor = '#cccccc';
        btnSalvar.style.cursor = 'not-allowed';
    }
}




// Função 1: Acorda o botão (Fica Verde) quando você mexe na tela
    function monitorarAlteracoesParaSalvar() {
        // CORREÇÃO: Agora olhamos para os dois containers (Formulário Superior e Lista de Dias)
        // Isso garante que alterações na lista ativem o botão, independente do modo de tela
        const containers = [
            document.getElementById('formPeriodoEspecial'),
            document.getElementById('containerListaDiasEspeciais')
        ];
        
        const btnSalvar = document.getElementById('btnSalvarEspecial');
        
        const habilitar = () => {
            if (btnSalvar) {
                btnSalvar.disabled = false;
                btnSalvar.style.backgroundColor = '#28a745'; // FICA VERDE
                btnSalvar.style.cursor = 'pointer'; 
            }
        };

        // Adiciona os vigias em ambos os lugares
        containers.forEach(div => {
            if (div) {
                // Monitora inputs e selects
                const inputs = div.querySelectorAll('input, select');
                inputs.forEach(input => {
                    // Removemos ouvintes antigos para não duplicar e adicionamos os novos
                    input.removeEventListener('input', habilitar);
                    input.removeEventListener('change', habilitar);
                    input.addEventListener('input', habilitar);
                    input.addEventListener('change', habilitar);
                });
            }
        });
    }
	
	

// Função 2: Carrega a tela e RESETA o botão para Cinza
function carregarPeriodoEspecial(id) {
    if (!id) return;

    const isNovo = (id === 'novo');
    
    // Configura o formulário (Habilita campos se for novo ou edição)
    alternarEstadoFormulario(true, isNovo);

    periodoEmEdicaoID = isNovo ? null : id;
    const containerDias = document.getElementById('containerListaDiasEspeciais');

    if (isNovo) {
        // Modo NOVO: Limpa tudo para começar do zero
        document.getElementById('nomePeriodo').value = '';
        document.getElementById('dataInicioPeriodo').value = '';
        document.getElementById('dataFimPeriodo').value = '';
        document.getElementById('periodoAtivo').checked = true;
        
        // Reseta os horários do painel amarelo
        document.getElementById('regraMestraInicio').value = '08:00';
        document.getElementById('regraMestraFim').value = '17:00';
        
        // Limpa a lista de dias
        containerDias.innerHTML = '<p style="text-align: center; color: #999; margin-top: 30px;">Defina as datas e clique em <b>"Gerar / Atualizar Dias"</b>.</p>';
        
        atualizarVisibilidadeBotaoExpandir();
        
        // Foca no campo de nome
		setTimeout(() => document.getElementById('nomePeriodo').focus(), 100);
    } else {
        // Modo EDIÇÃO: Carrega os dados salvos
        const p = horariosGlobal.Especiais[id];
        document.getElementById('nomePeriodo').value = p.titulo;
        document.getElementById('dataInicioPeriodo').value = p.inicio;
        document.getElementById('dataFimPeriodo').value = p.fim;
        document.getElementById('periodoAtivo').checked = p.ativo;
        
        renderizarListaDias(p.dias);
    }

    // RESET FINAL: Garante que o botão Salvar comece CINZA (desabilitado)
    // pois acabamos de carregar e o usuário ainda não mexeu em nada.
    const btnSalvar = document.getElementById('btnSalvarEspecial');
    if (btnSalvar) {
        btnSalvar.disabled = true;
        btnSalvar.style.backgroundColor = '#cccccc'; 
        btnSalvar.style.cursor = 'not-allowed';
    }

    // --- ATUALIZA A COR DO TEXTO (Verde/Vermelho) ---
    atualizarCorPeriodoAtivo();

    // Inicia o monitoramento: Qualquer alteração a partir de agora acenderá o botão Salvar
    monitorarAlteracoesParaSalvar();
	// --- TRUQUE DO DROPDOWN LIMPO ---
        const select = document.getElementById('selectPeriodoEspecial');
        if(select) {
            Array.from(select.options).forEach(opt => {
                if(opt.value && opt.value !== 'novo' && opt.dataset.titulo) {
                    // O item selecionado mostra só o título. Os outros mostram completo!
                    opt.textContent = opt.selected ? opt.dataset.titulo : opt.dataset.completo;
                }
            });
        }
}



function fecharModalHorario(tipo) {
    if (tipo === 'padrao') {
        document.getElementById('modalHorarioPadrao').style.display = 'none';
    } else if (tipo === 'especial') {
        document.getElementById('modalHorarioEspecial').style.display = 'none';
    } else if (tipo === 'aulas') {
        document.getElementById('modalHorarioAulas').style.display = 'none';
    } else if (tipo === 'duplas') {
        document.getElementById('modalHorarioDuplas').style.display = 'none';
    }
}


function renderizarTabelaPadrao() {
    const tbody = document.getElementById('tbodyHorarioPadrao');
    tbody.innerHTML = '';
    const diasSemana = ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado', 'Domingo'];
    const padraoDB = horariosGlobal.Padrao || {};

    for (let i = 1; i <= 7; i++) {
        let defAbertura = '06:00';
        let defFechamento = '23:00';
        let defStatus = 'aberto';

        if (i === 6) { // Sábado
            defAbertura = '07:00';
            defFechamento = '21:00';
        }
        if (i === 7) { // Domingo
            defAbertura = '08:00';
            defFechamento = '17:00';
        }

        const configDia = padraoDB[i] || { status: defStatus, abertura: defAbertura, fechamento: defFechamento };
        
        // Verifica se está fechado para aplicar a cor
        const isFechado = configDia.status === 'fechado';
        const classeLinha = isFechado ? 'fechado-padrao' : '';

        const tr = document.createElement('tr');
        // Adicionamos um ID na linha (TR) para acharmos ela fácil depois
        tr.id = `tr_padrao_${i}`;
        tr.className = classeLinha;

        tr.innerHTML = `
            <td>${diasSemana[i-1]}</td>
            <td>
                <select id="padrao_status_${i}" onchange="toggleInputsPadrao(${i})" style="width: 100px;">
                    <option value="aberto" ${!isFechado ? 'selected' : ''}>Aberto</option>
                    <option value="fechado" ${isFechado ? 'selected' : ''}>Fechado</option>
                </select>
            </td>
            <td><input type="time" id="padrao_inicio_${i}" value="${configDia.abertura}" ${isFechado ? 'disabled' : ''}></td>
            <td><input type="time" id="padrao_fim_${i}" value="${configDia.fechamento}" ${isFechado ? 'disabled' : ''}></td>
        `;
        tbody.appendChild(tr); 
    }
}

function toggleInputsPadrao(diaIdx) {
    const status = document.getElementById(`padrao_status_${diaIdx}`).value;
    const disabled = status === 'fechado';
    
    // 1. Trava/Destrava os campos
    document.getElementById(`padrao_inicio_${diaIdx}`).disabled = disabled;
    document.getElementById(`padrao_fim_${diaIdx}`).disabled = disabled;

    // 2. Muda a cor da linha (Pega a TR pelo ID que criamos)
    const linha = document.getElementById(`tr_padrao_${diaIdx}`);
    if (disabled) {
        linha.classList.add('fechado-padrao');
    } else {
        linha.classList.remove('fechado-padrao');
    }
}



function salvarHorarioPadrao() {
    const novoPadrao = {};
    for (let i = 1; i <= 7; i++) {
        novoPadrao[i] = {
            status: document.getElementById(`padrao_status_${i}`).value,
            abertura: document.getElementById(`padrao_inicio_${i}`).value,
            fechamento: document.getElementById(`padrao_fim_${i}`).value
        };
    }
    // Guarda no carrinho
    carrinhoHorarioPadrao = novoPadrao;
    
    marcarComoAlterado();
    fecharModalHorario('padrao');
    mostrarNotificacao("Horários padrão armazenados no carrinho!", "info");
}


    function actualizarDropdownPeriodos() { // Alias para o nome correto
        atualizarDropdownPeriodos();
    }

function atualizarDropdownPeriodos() {
        const select = document.getElementById('selectPeriodoEspecial');
        // Adiciona a opção neutra (placeholder) no início
        select.innerHTML = '<option value="" disabled selected hidden>Selecione uma ação...</option><option value="novo">+ Criar Novo Período...</option>';
        
        const especiais = horariosGlobal.Especiais || {};
        Object.keys(especiais).forEach(id => {
            const p = especiais[id];
            const option = document.createElement('option');
            option.value = id;
            
            // GUARDA AS DUAS VERSÕES DO TEXTO NA PRÓPRIA OPÇÃO
            option.dataset.titulo = p.titulo;
            option.dataset.completo = `${p.titulo} (${formatarData(p.inicio)} - ${formatarData(p.fim)})`;
            
            // Define o texto inicial como completo
            option.textContent = option.dataset.completo;
            select.appendChild(option);
        });
    }


function gerarListaDias() {
    const inicio = document.getElementById('dataInicioPeriodo').value;
    const fim = document.getElementById('dataFimPeriodo').value;
    const mStatus = document.getElementById('regraMestraStatus').value;
    const mInicio = document.getElementById('regraMestraInicio').value;
    const mFim = document.getElementById('regraMestraFim').value;
    
    if (!inicio || !fim) return mostrarNotificacao("Defina as datas de Início e Fim.", 'warning');
    
    const diasObj = {};
    let atual = new Date(inicio + "T00:00:00");
    const dataFim = new Date(fim + "T00:00:00");
    const existente = (periodoEmEdicaoID && horariosGlobal.Especiais[periodoEmEdicaoID]) ? horariosGlobal.Especiais[periodoEmEdicaoID].dias : {};
    
    while (atual <= dataFim) {
        const dataStr = atual.toISOString().split('T')[0];
        diasObj[dataStr] = existente[dataStr] || { status: mStatus, abertura: mInicio, fechamento: mFim };
        atual.setDate(atual.getDate() + 1);
    }
    renderizarListaDias(diasObj);
}

function renderizarListaDias(diasObj) {
    const container = document.getElementById('containerListaDiasEspeciais');
    container.innerHTML = '';
    
    if (!diasObj) return;
    
    const datasOrdenadas = Object.keys(diasObj).sort();
    
    datasOrdenadas.forEach(data => {
        const config = diasObj[data];
        const div = document.createElement('div');
        
        // Define classe se estiver fechado
        div.className = `linha-dia-especial ${config.status === 'fechado' ? 'fechado' : ''}`;
        div.dataset.data = data;
        
        // CÁLCULO DAS DATAS (Normal vs Curta)
        const dateParts = data.split('-'); // [aaaa, mm, dd]
        const anoCompleto = dateParts[0];
        const anoCurto = dateParts[0].slice(2); // Pega só os 2 últimos dígitos
        const mes = dateParts[1];
        const dia = dateParts[2];
        
        const diaSemana = ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'][new Date(data + "T00:00:00").getDay()];
        
        // Criação das strings visuais
        const textoDesktop = `${dia}/${mes}/${anoCompleto} (${diaSemana})`;
        const textoMobile  = `${dia}/${mes}/${anoCurto} (${diaSemana})`;

        div.innerHTML = `
            <div class="dia-label">
                <span class="view-desktop">${textoDesktop}</span>
                <span class="view-mobile" style="display:none;">${textoMobile}</span>
            </div>
            
            <select class="status-dia" onchange="atualizarLinhaDia(this)">
                <option value="aberto" ${config.status === 'aberto' ? 'selected' : ''}>Aberto</option>
                <option value="fechado" ${config.status === 'fechado' ? 'selected' : ''}>Fechado</option>
            </select>
            
            <input type="time" class="inicio-dia" value="${config.abertura}" ${config.status === 'fechado' ? 'disabled' : ''}> 
            
            <span class="separador-hora">às</span>
            
            <input type="time" class="fim-dia" value="${config.fechamento}" ${config.status === 'fechado' ? 'disabled' : ''}>
        `;
        container.appendChild(div);
    });
	atualizarVisibilidadeBotaoExpandir();
}


    window.atualizarLinhaDia = function(select) {
        const linha = select.closest('.linha-dia-especial');
        const inputs = linha.querySelectorAll('input[type="time"]');
        if (select.value === 'fechado') { linha.classList.add('fechado'); inputs.forEach(i => i.disabled = true); }
        else { linha.classList.remove('fechado'); inputs.forEach(i => i.disabled = false); }
    };



function salvarPeriodoEspecial() {
    const titulo = document.getElementById('nomePeriodo').value.trim();
    const inicio = document.getElementById('dataInicioPeriodo').value;
    const fim = document.getElementById('dataFimPeriodo').value;
    
    if (!titulo || !inicio || !fim) return mostrarNotificacao("Preencha Nome e Datas.", 'warning');
    
    const linhas = document.querySelectorAll('.linha-dia-especial');
    if (linhas.length === 0) return mostrarNotificacao("Gere a lista de dias antes de salvar.", 'warning');
    
    const diasObj = {};
    linhas.forEach(linha => {
        diasObj[linha.dataset.data] = {
            status: linha.querySelector('.status-dia').value,
            abertura: linha.querySelector('.inicio-dia').value,
            fechamento: linha.querySelector('.fim-dia').value
        };
    });

    // Define o ID (se for novo, cria um timestamp)
    const novoID = periodoEmEdicaoID || `especial_${Date.now()}`;
    
    // Objeto do Período
    const dadosPeriodo = {
        titulo: titulo, 
        ativo: document.getElementById('periodoAtivo').checked, 
        inicio: inicio, 
        fim: fim, 
        dias: diasObj
    };

    // 1. Atualiza a memória local (para o usuário ver a mudança na lista imediatamente)
    if (!horariosGlobal.Especiais) horariosGlobal.Especiais = {};
    horariosGlobal.Especiais[novoID] = dadosPeriodo;

    // 2. Salva no Carrinho (Para envio posterior)
    carrinhoHorarioEspecial[novoID] = dadosPeriodo;

    // 3. Avisa o sistema que há alterações pendentes
    marcarComoAlterado(); 

    mostrarNotificacao("Período Especial armazenado no carrinho!", 'info'); 
    atualizarDropdownPeriodos(); 
    fecharModalHorario('especial'); 
}


function excluirPeriodoSelecionado() {
    if (!periodoEmEdicaoID) return mostrarNotificacao("Nenhum período selecionado.", 'warning');

    const periodo = horariosGlobal.Especiais[periodoEmEdicaoID];
    const nomeDoPeriodo = periodo ? periodo.titulo : "este período";

    mostrarConfirmacao(`Deseja remover o período "<b>${nomeDoPeriodo}</b>"?`, () => {
        
        // 1. Remove da memória local (Visual)
        delete horariosGlobal.Especiais[periodoEmEdicaoID];

        // 2. Marca como NULL no carrinho (Isso apaga do Firebase ao salvar)
        carrinhoHorarioEspecial[periodoEmEdicaoID] = null;

        // 3. Sinaliza alteração
        marcarComoAlterado();

        mostrarNotificacao("Período marcado para exclusão (no carrinho).", 'info'); 
        
        // Limpa a tela e volta ao estado inicial
        abrirGerenciadorHorarios('especial'); 
    });
}



    function formatarData(d) { if(!d) return ""; return d.split('-').reverse().join('/'); }

    // Helpers Gerais
    // Helpers Gerais
    function showTab(id) {
        // Esconde todos os conteúdos e tira o traço azul de todos
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('tab-content-active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        
        // Mostra o conteúdo da aba clicada
        document.getElementById(id).classList.add('tab-content-active');
        
        // Coloca o traço azul na aba correta (agora só existem 2)
        const tabBtns = document.querySelectorAll('.tab');
        if (id === 'reservas') tabBtns[0].classList.add('active');
        if (id === 'convidados') tabBtns[1].classList.add('active');
        
        // Atualiza os seletores caso volte para a aba reservas
        if (id === 'reservas') { 
            atualizarEstadoConfirmacao(); 
            atualizarEstadoEdicaoOrganizador(); 
            atualizarVisualOtimizacao();  
        }
    }
    
    function atualizarEstadoSistema() { 
		const s = document.getElementById('sistema'); 
		s.className = s.value === 'ON' ? 'on' : 'off'; 
	}
    


// --- NOVA LÓGICA PIRÂMIDE (MODERNA) ---


	
    db.ref("sistemas/usuariosOnline").on("value", s => {
        const n = s.numChildren(); document.getElementById('usuariosOnline').value = n.toString().padStart(3,'0');
        listaUsuariosOnline=[]; s.forEach(c => listaUsuariosOnline.push(c.val().usuario));
    });
	
    document.getElementById('usuariosOnline').addEventListener('click', () => {
        const msg = listaUsuariosOnline.length ? `<b>Usuários:</b><br>${listaUsuariosOnline.join("<br>")}` : "Ninguém online.";
        mostrarNotificacao(msg, 'info');
    });

   
    

    // Exceções e Bloqueios
    
    
    
	
	

	
	

    
    async function abrirModalBloqueio(n) {
        if(!vlimparBloqueiosAntigos) { await limparBloqueiosAntigos(); vlimparBloqueiosAntigos=true; }
        quadraAtualParaBloqueio = n; renderizarBloqueios(n);
        document.getElementById('modalBloqueioQuadra').style.display = 'flex';
    }
    function fecharModalBloqueio() { document.getElementById('modalBloqueioQuadra').style.display = 'none'; }
    function renderizarBloqueios(n) {
        const div = document.getElementById('listaBloqueios'); div.innerHTML='';
        const k = `Quadra-${n}`; const bl = bloqueiosQuadra[k] || {};
        if(Object.keys(bl).length===0) { div.innerHTML='<p>Nenhum bloqueio.</p>'; return; }
        const ul = document.createElement('ul');
        Object.keys(bl).sort().forEach(d => {
            const li = document.createElement('li');
            li.innerHTML = `<div><div><strong>${formatarData(d)}</strong></div><div style="font-size:0.9em;color:#666">${bl[d].descricao||''}</div><div>${bl[d].regras.inicio}-${bl[d].regras.fim}</div></div><button class="btn-remover" onclick="removerBloqueio('${k}','${d}')">X</button>`;
            ul.appendChild(li);
        });
        div.appendChild(ul);
    }
	
	
function adicionarBloqueio() {
    const desc=document.getElementById('bloqueioDescricao').value; 
    const d=document.getElementById('bloqueioData').value;
    const i=document.getElementById('bloqueioInicio').value; 
    const f=document.getElementById('bloqueioFim').value;
    
    if(!d||!i||!f) return mostrarNotificacao("Preencha tudo.", 'warning');
    
    const dp = d.replace(/-/g,'/'); 
    if(!/^\d{2}\/\d{2}\/\d{4}$/.test(dp)) return mostrarNotificacao("Data inválida.", 'error');
    
    const p = dp.split('/'); const dbDate = `${p[2]}-${p[1]}-${p[0]}`;
    const k = `Quadra-${quadraAtualParaBloqueio}`;
    
    if(bloqueiosQuadra[k] && bloqueiosQuadra[k][dbDate]) return mostrarNotificacao("Já existe bloqueio nesta data.", 'error');
    
    bloqueiosQuadra[k] = bloqueiosQuadra[k] || {};
    bloqueiosQuadra[k][dbDate] = { descricao:desc, regras:{inicio:i,fim:f} };
    
    mostrarNotificacao("Bloqueio adicionado (Temp). Salve as configurações.", 'success');
    document.getElementById('bloqueioDescricao').value=''; document.getElementById('bloqueioData').value='';
    renderizarBloqueios(quadraAtualParaBloqueio);
}
	
	
function removerBloqueio(k, d) { 
    mostrarConfirmacao("Remover este bloqueio?", () => {
        delete bloqueiosQuadra[k][d]; 
        renderizarBloqueios(quadraAtualParaBloqueio); 
        mostrarNotificacao("Removido (Temp). Salve as configurações.", 'success');
    });
}
    
    
    function limparBloqueiosAntigos() { return limparAntigos(bloqueiosQuadra, 'Quadras/Bloqueios'); }
    function limparAntigos(obj, pathMid) {
        const d7 = new Date(); d7.setDate(d7.getDate()-7); d7.setHours(0,0,0,0);
        const up = {};
        for(const k in obj) {
            for(const d in obj[k]) {
                if(new Date(d+'T00:00:00') < d7) up[`sistemas/config/${pathMid}/${k}/${d}`] = null;
            }
        }
        return Object.keys(up).length ? db.ref().update(up) : Promise.resolve();
    }


function handleEstadoQuadraChange(el, n) {
    if(el.oldValue==='bloqueada' && el.value!=='bloqueada' && bloqueiosQuadra[`Quadra-${n}`]) {
        mostrarConfirmacao("Remover todos os bloqueios desta quadra?", 
            () => { // Callback Confirmar
                delete bloqueiosQuadra[`Quadra-${n}`];
                mostrarNotificacao("Bloqueios removidos.", 'success');
            },
            // Se cancelar (fechar modal), precisamos reverter o valor visualmente
            // Como nosso modal simples não tem callback de cancelar explícito para reversão de estado,
            // o ideal é que a mudança só ocorra se confirmar.
            // O select já mudou visualmente. Se o usuário não confirmar (fechar modal), 
            // a lógica ideal seria voltar o select.
            // Para simplificar: Se ele fechar o modal, os bloqueios ficam lá (delete não roda).
            // Apenas o select mudou. Se ele salvar, salva sem apagar os bloqueios (o que é seguro).
        );
    }
    if(el.value==='bloqueada') abrirModalBloqueio(n);
    el.oldValue = el.value;
}


   

    // Eventos Gerais
    document.addEventListener("DOMContentLoaded", function() { 
        showTab('reservas');
        
        

        

        // Configurar Hold Events
        setupHoldEvent(document.getElementById('estadoQuadra1'), () => handleEstadoQuadraChange(document.getElementById('estadoQuadra1'), 1));
        setupHoldEvent(document.getElementById('estadoQuadra2'), () => handleEstadoQuadraChange(document.getElementById('estadoQuadra2'), 2));
        setupHoldEvent(document.getElementById('estadoQuadra3'), () => handleEstadoQuadraChange(document.getElementById('estadoQuadra3'), 3));
		setupHoldEvent(document.getElementById('otimizacaoHorarios'), mudarOtimizacao);
        

        // Tooltips
        const addTip = (id) => {
			const l = document.querySelector(`label[for="${id}"]`);
			if(l) {
				l.style.cursor='help';
				l.addEventListener('click', () => { 
					if(l.title) mostrarNotificacao(`ℹ️ <b>Informação:</b><br>${l.title.replace(/&#10;/g,'<br>')}`, 'info'); 
				});
			}
		};
        addTip('reservasPorConfirmacao'); addTip('horasParaExpirar'); addTip('edicaoOrganizador'); addTip('otimizacaoHorarios');

    });

    // Helpers UI
    function formatarDataInput(e) {
        let v = e.target.value.replace(/\D/g, '');
        if(v.length>8) v=v.substring(0,8);
        if(v.length>2) v=v.substring(0,2)+'/'+v.substring(2);
        if(v.length>5) v=v.substring(0,5)+'/'+v.substring(5);
        e.target.value = v;
    }
    
    function atualizarEstadoConfirmacao() {
        const s = document.getElementById('reservasPorConfirmacao');
        document.getElementById('horasParaExpirar').disabled = s.value !== 'ON';
        s.className = s.value==='ON'?'confirmacao-on':'confirmacao-off';
    }
    function atualizarEstadoEdicaoOrganizador() {
        const s = document.getElementById('edicaoOrganizador');
        s.className = s.value==='ON'?'edicao-on':'edicao-off';
    }
    
	// Função disparada ao mudar o select (ON/OFF)
    function mudarOtimizacao() {
        atualizarVisualOtimizacao();
        // Se ligou (ON), abre o modal para configurar
        if(document.getElementById('otimizacaoHorarios').value === 'ON') {
            abrirModalQuebraHorario();
        }
    }
    
    // Função que apenas ajusta a cor do botão (Verde/Cinza)
    function atualizarVisualOtimizacao() {
        const s = document.getElementById('otimizacaoHorarios');
        // Reutilizamos as classes CSS existentes (quebra-on/quebra-off) pois são apenas visuais
        s.className = s.value === 'ON' ? 'quebra-on' : 'quebra-off';
    }
	
    
    function abrirModalQuebraHorario() {
        document.getElementById('quebraHorarioQuadra1').checked = quebraHorarioQuadrasConfig['Quadra-1']||false;
        document.getElementById('quebraHorarioQuadra2').checked = quebraHorarioQuadrasConfig['Quadra-2']||false;
        document.getElementById('quebraHorarioQuadra3').checked = quebraHorarioQuadrasConfig['Quadra-3']||false;
        document.getElementById('modalQuebraHorarioQuadras').style.display='flex';
    }
    function fecharModalQuebraHorario() { document.getElementById('modalQuebraHorarioQuadras').style.display='none'; }

	
function salvarModalQuebraHorario() {
    quebraHorarioQuadrasConfig = { 
        'Quadra-1': document.getElementById('quebraHorarioQuadra1').checked, 
        'Quadra-2': document.getElementById('quebraHorarioQuadra2').checked, 
        'Quadra-3': document.getElementById('quebraHorarioQuadra3').checked 
    };
    fecharModalQuebraHorario();
    mostrarNotificacao("Seleção confirmada! Não esqueça de clicar em 'Salvar Configurações' no final.", 'success');
}
	
    
    function setupHoldEvent(el, cb) {
        let t;
        el.addEventListener('touchstart', () => t=setTimeout(cb,700));
        el.addEventListener('touchend', () => clearTimeout(t));
        el.addEventListener('touchmove', () => clearTimeout(t));
    }
    


function acionarZerarRanking() {
    // Fecha o menu de 3 pontinhos
    const menu = document.getElementById('menuDropdownDuplas');
    if (menu) menu.style.display = 'none';
    
    // Chama a função original que zera tudo
    zerarRankingDuplas();
}	
	
async function zerarRankingDuplas() {
    const snap = await db.ref('sistemas/cadastro/jogadores').once('value'); const j=snap.val();
    if(!j) return mostrarNotificacao("Banco de dados vazio.", 'error');
    
    const up={}; let count=0;
    for(const k in j) { if(j[k].jogosDeDuplasJogados || j[k].vitoriasEmDuplas) { up[`sistemas/cadastro/jogadores/${k}/jogosDeDuplasJogados`]=0; up[`sistemas/cadastro/jogadores/${k}/vitoriasEmDuplas`]=0; count++; } }
    
    if(!count) return mostrarNotificacao("Nada a zerar.", 'info');
    
    mostrarConfirmacao("⚠️ ATENÇÃO: Tem certeza absoluta que deseja ZERAR todo o Ranking de Duplas? Todos os pontos e vitórias de todos os jogadores serão apagados permanentemente.", async () => {
        await db.ref().update(up); 
        mostrarNotificacao("Ranking Zerado!", 'success');
    });
}
	
    
// ======================================================
// === LÓGICA DO GERENCIADOR DE AULAS ===
// ======================================================

// --- NOVA FUNÇÃO: Adicione esta função em qualquer lugar nos seus scripts ---
function preservarDadosInput() {
    // Pega os elementos da tela
    const checkAtivo = document.getElementById('aula-ativo');
    const inputProf = document.getElementById('aula-professor');

    // Garante que o objeto da quadra atual existe na memória
    if (!configAulasGlobal[quadraAulaAtual]) {
        configAulasGlobal[quadraAulaAtual] = { Ativo: false, Professor: '', Grade: {} };
    }

    // Salva o texto digitado na memória global
    if (checkAtivo) configAulasGlobal[quadraAulaAtual].Ativo = checkAtivo.checked;
    if (inputProf) configAulasGlobal[quadraAulaAtual].Professor = inputProf.value.trim();
}

// 1. Substitua a sua função selecionarQuadraAula por esta:
function selecionarQuadraAula(quadraKey, pularSalvamento = false) {
    
    // CORREÇÃO: Só salva o rascunho se NÃO for o carregamento inicial
    if (!pularSalvamento) {
        preservarDadosInput();
    }

    // Agora muda para a nova quadra
    quadraAulaAtual = quadraKey;
    
    // Atualiza visual dos botões
    ['Quadra1', 'Quadra2', 'Quadra3'].forEach((q, index) => {
        const btnId = `btn-aula-q${index+1}`; 
        const btn = document.getElementById(btnId);
        if (btn) {
            if (q === quadraKey) btn.classList.add('active');
            else btn.classList.remove('active');
        }
    });

    // Atualiza o Título
    const nomesPorExtenso = {
        'Quadra1': 'Quadra 1 - Coberta',
        'Quadra2': 'Quadra 2 - Aberta',
        'Quadra3': 'Quadra 3 - Coberta'
    };
    const elTitulo = document.getElementById('tituloAulaQuadra');
    if (elTitulo) {
        elTitulo.textContent = nomesPorExtenso[quadraKey];
    }

    // Carrega os dados da nova quadra para a tela
    const dados = configAulasGlobal[quadraKey] || { Ativo: false, Professor: '', Grade: {} };
    
    const checkAtivo = document.getElementById('aula-ativo');
    if(checkAtivo) checkAtivo.checked = dados.Ativo || false;
    
    const inputProf = document.getElementById('aula-professor');
    if(inputProf) {
        // Tenta definir o valor salvo no banco
        inputProf.value = dados.Professor || '';
        
        // CORREÇÃO: Verifica se a seleção funcionou.
        // Se inputProf.selectedIndex for -1, significa que o valor salvo (ex: "Rildo")
        // não existe na lista atual. Então forçamos para vazio.
        if (inputProf.selectedIndex === -1) {
            inputProf.value = "";
        }
    }

    renderizarTabelaAulas();
}



function salvarConfiguracaoAulas() {
    // 1. Garante que os dados de texto (Input 'Professor' e Checkbox 'Ativar')
    // sejam sincronizados da tela para a memória global antes de salvar.
    // (A função preservarDadosInput já faz isso para nós, capturando o que foi digitado)
    preservarDadosInput(); 

    // 2. Identifica qual quadra estamos editando agora (Controlada pelas abas)
    // Ex: "Quadra1", "Quadra2" ou "Quadra3"
    // (A variável 'quadraAulaAtual' é atualizada automaticamente ao clicar nas abas)
    const quadraKey = quadraAulaAtual; 

    // 3. Pega o objeto completo da memória (que já contém a Grade atualizada pelos cliques)
    const dadosQuadra = configAulasGlobal[quadraKey];

    if (!dadosQuadra) {
        return mostrarNotificacao(`Erro: Dados da ${quadraKey} não encontrados na memória. Tente recarregar a página.`, 'error');
    }

    // 4. Salva no Carrinho (Rascunho)
    // Coloca a configuração ATUAL desta quadra no pacote de envio
    carrinhoAulas[quadraKey] = dadosQuadra;

    // 5. Sinaliza alteração pendente (Acende o botão laranja principal)
    marcarComoAlterado();

    mostrarNotificacao(`Grade da ${quadraKey} salva no carrinho!`, 'info');
    
    // (Opcional) Fecha o modal automaticamente após salvar
    // Se preferir manter aberto para conferir, pode comentar a linha abaixo.
    fecharModalHorario('aulas'); 
}




// 2. Desenha a Grade (A Mágica acontece aqui)
function renderizarTabelaAulas() {
    const tbody = document.getElementById('tbodyAulas');
    if (!tbody) return;
    tbody.innerHTML = '';
    
    // Garante leitura segura (se não existir, usa vazio)
    const dadosQuadra = configAulasGlobal[quadraAulaAtual] || {};
    const gradeSalva = dadosQuadra.Grade || {};

    // Cria as linhas das 06:00 às 23:00
    for (let hora = 6; hora <= 22; hora++) {
        const tr = document.createElement('tr');
        
        // Texto do Horário (ex: "06:00 - 07:00")
        const horaInicio = String(hora).padStart(2,'0');
        const horaFim = String(hora + 1).padStart(2,'0');
        const textoHorario = `${horaInicio}:00 - ${horaFim}:00`;
        
        // 1. COLUNA DA ESQUERDA (Horário)
        const tdHoraEsq = document.createElement('td');
        tdHoraEsq.textContent = textoHorario;
        tr.appendChild(tdHoraEsq);

        // 2. COLUNAS DOS DIAS (Seg a Dom)
        for (let dia = 1; dia <= 7; dia++) {
            const td = document.createElement('td');
            const key = `${dia}_${hora}`; 

            // Verifica Horário Padrão
            const regrasPadrao = obterRegrasPadrao(dia);
            const estaAberto = verificarSeAbertoNoPadrao(regrasPadrao, hora);

            if (!estaAberto) {
                td.className = 'aula-cell-bloqueada';
            } else {
                const temAula = gradeSalva[key] === true;
                
                // Configuração visual inicial
                if (temAula) {
                    td.className = 'aula-cell-marcada';
                    td.textContent = 'Aula'; 
                } else {
                    td.className = 'aula-cell-livre';
                    td.textContent = '';
                }

                // --- EVENTO DE CLIQUE (AQUI ESTAVA O ERRO) ---
                td.onclick = () => {
                    // 1. SEGURANÇA: Garante que a estrutura existe na memória antes de gravar
                    if (!configAulasGlobal[quadraAulaAtual]) {
                        configAulasGlobal[quadraAulaAtual] = { Ativo: false, Professor: '', Grade: {} };
                    }
                    if (!configAulasGlobal[quadraAulaAtual].Grade) {
                        configAulasGlobal[quadraAulaAtual].Grade = {};
                    }

                    // 2. Agora é seguro gravar ou apagar
                    if (td.classList.contains('aula-cell-marcada')) {
                        td.className = 'aula-cell-livre';
                        td.textContent = '';
                        // Remove da memória
                        delete configAulasGlobal[quadraAulaAtual].Grade[key];
                    } else {
                        td.className = 'aula-cell-marcada';
                        td.textContent = 'Aula';
                        // Adiciona na memória (agora seguro)
                        configAulasGlobal[quadraAulaAtual].Grade[key] = true;
                    }
                };
            }
            tr.appendChild(td);
        }

        // 3. COLUNA DA DIREITA (Horário)
        const tdHoraDir = document.createElement('td');
        tdHoraDir.textContent = textoHorario;
        tr.appendChild(tdHoraDir);

        tbody.appendChild(tr);
    }
}




// 3. Funções Auxiliares de Horário
function obterRegrasPadrao(diaIdx) {
    if (horariosGlobal && horariosGlobal.Padrao) {
        return horariosGlobal.Padrao[diaIdx];
    }
    // Padrão de segurança se não carregar
    return { status: 'aberto', abertura: '06:00', fechamento: '23:00' };
}

function verificarSeAbertoNoPadrao(regra, hora) {
    if (!regra || regra.status === 'fechado') return false;
    const inicio = parseInt(regra.abertura.split(':')[0]);
    const fim = parseInt(regra.fechamento.split(':')[0]);
    return hora >= inicio && hora < fim;
}

// 4. Botões de Ação Rápida (Selecionar/Limpar)
function acaoAula(tipo) {
    const grade = configAulasGlobal[quadraAulaAtual].Grade || {};
    if (!configAulasGlobal[quadraAulaAtual].Grade) configAulasGlobal[quadraAulaAtual].Grade = grade;

    const tbody = document.getElementById('tbodyAulas');
    
    // Varre a tabela visual
    for (let r = 0; r < tbody.rows.length; r++) {
        const hora = r + 6;
        // As células clicáveis estão entre a coluna 1 e 7 (indices 1 a 7)
        // Lembre-se: Coluna 0 é horário, Coluna 8 é horário
        for (let c = 1; c <= 7; c++) {
            const cell = tbody.rows[r].cells[c];
            const key = `${c}_${hora}`;

            // Só altera se NÃO estiver bloqueado (Cinza)
            if (!cell.classList.contains('aula-cell-bloqueada')) {
                if (tipo === 'selecionar') {
                    // --- CORREÇÃO AQUI: Texto Padronizado "Aula" ---
                    cell.className = 'aula-cell-marcada';
                    cell.textContent = 'Aula';
                    grade[key] = true;
                } else {
                    cell.className = 'aula-cell-livre';
                    cell.textContent = '';
                    delete grade[key];
                }
            }
        }
    }
}







// Função para Maximizar/Restaurar a tela de aulas
// Função para Maximizar/Restaurar a tela de aulas
function alternarTelaCheiaAulas() {
    // 1. O PULO DO GATO: Remove qualquer seleção de texto (azul) imediatamente
    if (window.getSelection) {
        window.getSelection().removeAllRanges();
    }
    
    const modalContent = document.querySelector('#modalHorarioAulas .modal-content');
    
    if (modalContent) {
        // Alterna a classe 'maximizado'
        if (modalContent.classList.contains('maximizado')) {
            modalContent.classList.remove('maximizado');
        } else {
            modalContent.classList.add('maximizado');
        }
    }
}


// Variável global para controlar o tempo do clique
let ultimoTempoClique = 0;

function tratarCliqueHorario(event) {
    // 1. Remove qualquer seleção de texto (azul) imediatamente
    if (window.getSelection) {
        window.getSelection().removeAllRanges();
    }

    // 2. Calcula o tempo do clique atual
    const tempoAtual = new Date().getTime();
    const diferenca = tempoAtual - ultimoTempoClique;
    
    // 3. Verifica se foi um clique rápido (menos de 300ms) = Duplo Clique
    if (diferenca < 300 && diferenca > 0) {
        alternarTelaCheiaAulas(); // Maximiza a tela
        ultimoTempoClique = 0;    // Reseta para evitar triplo clique
    } else {
        // Se foi o primeiro clique, apenas guarda o tempo
        ultimoTempoClique = tempoAtual;
    }
}


// --- FUNÇÕES DO MODO FOCO (TELA CHEIA) ---

    // 1. Alterna entre Modo Foco e Normal
function alternarTelaCheiaEspecial() {
    const modal = document.getElementById('modalHorarioEspecial');
    const btn = document.getElementById('btnTelaCheiaEspecial');
    const iconSvg = document.getElementById('icon-fullscreen');
    
    // Paths dos desenhos (Opção 2: Explosão)
    const pathExpandir = "M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z";
    const pathComprimir = "M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z";

    // Ativa/Desativa o CSS
    modal.classList.toggle('modo-foco');
    
    // Troca o ícone e o título
    if (modal.classList.contains('modo-foco')) {
        // Mudou para Foco -> Mostra ícone de Comprimir (Setas para dentro)
        iconSvg.innerHTML = `<path d="${pathComprimir}"/>`;
        btn.title = "Minimizar (Voltar ao normal)";
    } else {
        // Voltou ao Normal -> Mostra ícone de Expandir (Setas para fora)
        iconSvg.innerHTML = `<path d="${pathExpandir}"/>`;
        btn.title = "Tela Cheia (Modo Foco)";
    }
}


// 2. Controla se o botão deve aparecer (só se houver lista)
function atualizarVisibilidadeBotaoExpandir() {
    const container = document.getElementById('containerListaDiasEspeciais');
    const btn = document.getElementById('btnTelaCheiaEspecial');
    
    // Conta quantos itens de dia existem
    const linhas = container.querySelectorAll('.linha-dia-especial');
    
    if (linhas.length > 0) {
        // Mostra o botão forçando FLEX (para alinhar o ícone) e vencendo o CSS
        btn.style.setProperty('display', 'flex', 'important');
    } else {
        // Esconde o botão com força total (!important)
        btn.style.setProperty('display', 'none', 'important');
        
        // Segurança: Se esvaziou a lista e estava em tela cheia, volta ao normal
        const modal = document.getElementById('modalHorarioEspecial');
        if(modal.classList.contains('modo-foco')) {
            alternarTelaCheiaEspecial();
        }
    }
}

function atualizarCorPeriodoAtivo() {
    const chk = document.getElementById('periodoAtivo');
    const texto = document.getElementById('textoPeriodoAtivo');
    
    if (chk && texto) {
        if (chk.checked) {
            texto.style.color = '#2e7d32'; // Verde Escuro (Ativado)
        } else {
            texto.style.color = '#d32f2f'; // Vermelho (Desativado)
        }
    }
}

// --- FUNÇÃO DE CONTROLE DOS CHECKBOXES (ESPELHO) ---
    function gerenciarPermissoesInterativas(origem) {
        const chkMaster = document.getElementById('perm_super_admin');
        
        // Lista de todos os checkboxes "filhos"
        const idsFilhos = [
            'perm_acesso_config',
            'perm_gestao_jogadores',
            'perm_gerir_reservas',
            'perm_controle_quadras',
            'perm_gestor_aulas',
            'perm_gestor_torneios'
        ];

        // CENÁRIO 1: Clicou no "Acesso Total"
        if (origem === 'MASTER') {
            const estadoMestre = chkMaster.checked;
            // Força todos os filhos a terem o mesmo estado do mestre
            idsFilhos.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.checked = estadoMestre;
            });
        } 
        // CENÁRIO 2: Clicou em um item individual
        else {
            let todosMarcados = true;
            
            // Verifica se SOBROU algum desmarcado
            idsFilhos.forEach(id => {
                const el = document.getElementById(id);
                if (el && !el.checked) todosMarcados = false;
            });

            // Se todos estiverem marcados, o mestre vira true. 
            // Se um estiver desmarcado, o mestre vira false.
            chkMaster.checked = todosMarcados;
        }
    }


// --- FUNÇÃO DE NOTIFICAÇÃO (TOAST) ---
function mostrarNotificacao(mensagem, tipo = 'success') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${tipo}`;
    
    // Adiciona o cursor de "mãozinha" para indicar que é clicável
    toast.style.cursor = 'pointer'; 
    
    // Ícone baseado no tipo
    let icone = '✅';
    if (tipo === 'error') icone = '❌';
    if (tipo === 'warning') icone = '⚠️';

    toast.innerHTML = `<span style="margin-right: 10px; font-size: 1.2em;">${icone}</span> <div>${mensagem}</div>`;
    
    container.appendChild(toast);

    // Função interna para remover o toast com animação
    const removerToast = () => {
        // Se já estiver removendo (animationName definido), não faz nada
        if (toast.style.animationName === 'fadeOutUp') return;

        toast.style.animation = 'fadeOutUp 0.3s forwards';
        toast.addEventListener('animationend', () => {
            if (toast.parentNode) {
                toast.remove();
            }
        });
    }; 

    // 1. EVENTO DE CLIQUE: Remove imediatamente
    toast.onclick = () => {
        removerToast();
    }; 

    // 2. TIMER AUTOMÁTICO: Remove após 4 segundos se ninguém clicar
    setTimeout(() => {
        // Verifica se o elemento ainda está na tela antes de tentar remover
        if (document.body.contains(toast)) {
            removerToast();
        }
    }, 4000);
}

// --- FUNÇÃO DE CONFIRMAÇÃO (MODAL) ---
function mostrarConfirmacao(mensagem, callbackConfirmar) {
    const modal = document.getElementById('modalConfirmacaoGlobal');
    const texto = document.getElementById('textoConf');
    const btnSim = document.getElementById('btnConfirmarConf');
    const btnNao = document.getElementById('btnCancelarConf');

    // Configura o texto
    texto.innerHTML = mensagem;
    modal.style.display = 'flex';

    // Ação do SIM (Remove listeners antigos para não duplicar)
    btnSim.onclick = function() {
        modal.style.display = 'none';
        if (callbackConfirmar) callbackConfirmar();
    };

    // Ação do NÃO
    btnNao.onclick = function() {
        modal.style.display = 'none';
    };
    
    // Focar no cancelar por segurança
    btnNao.focus();
}	


// --- FUNÇÃO DE INPUT (MODAL) ---
function mostrarInput(titulo, mensagem, placeholder, callbackConfirmar) {
    const modal = document.getElementById('modalInputGlobal');
    const tituloEl = document.getElementById('tituloInput');
    const textoEl = document.getElementById('textoInput');
    const inputEl = document.getElementById('campoInputGlobal');
    const btnSim = document.getElementById('btnConfirmarInput');
    const btnNao = document.getElementById('btnCancelarInput');

    tituloEl.textContent = titulo;
    textoEl.innerHTML = mensagem; // Permite HTML
    inputEl.value = '';
    inputEl.placeholder = placeholder || '';
    
    // Remove máscaras antigas se houver (opcional) e foca
    inputEl.oninput = null; 

    modal.style.display = 'flex';
    setTimeout(() => inputEl.focus(), 100);

    // Ação OK
    btnSim.onclick = function() {
        const valor = inputEl.value.trim();
        if (!valor) {
            mostrarNotificacao("O campo não pode ficar vazio.", "warning");
            inputEl.focus();
            return;
        }
        modal.style.display = 'none';
        if (callbackConfirmar) callbackConfirmar(valor);
    };

    // Ação Cancelar
    btnNao.onclick = function() {
        modal.style.display = 'none';
    };
}


// --- LÓGICA DE TEMA (CLARO/ESCURO) ---

function toggleTheme() {
    // 1. Alterna a classe no body
    document.body.classList.toggle('dark-mode');
    
    // 2. Verifica qual estado ficou
    const isDark = document.body.classList.contains('dark-mode');
    
    // 3. Salva na memória do navegador
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    
    // 4. Atualiza o ícone do botão
    atualizarIconeTema(isDark);
}

function atualizarIconeTema(isDark) {
    const btn = document.getElementById('theme-toggle-button');
    if (btn) {
        btn.textContent = isDark ? '☀️' : '🌙';
    }
}

// --- INICIALIZAÇÃO DO TEMA ---
document.addEventListener('DOMContentLoaded', () => {
    // Verifica se já existe preferência salva
    const savedTheme = localStorage.getItem('theme');
    
    // Se estiver salvo como 'dark', ativa. Caso contrário, mantém padrão (light).
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        atualizarIconeTema(true);
    } else {
        atualizarIconeTema(false);
    }
});



function abrirSeletorInteligente(modo) {
    modoCorAtual = modo;
    
    // DETECÇÃO DE CELULAR (Verifica se é touch ou tela pequena)
    const isMobile = ('ontouchstart' in window) || (window.innerWidth <= 800);

    if (isMobile) {
        // MODO CELULAR: Clica no input nativo invisível
        const idNative = modo === 'novo' ? 'nativeCorNovo' : 'nativeCorEdicao';
        document.getElementById(idNative).click();
    } else {
        // MODO PC: Abre nosso Modal de Bolinhas
        renderizarGridPC();
        document.getElementById('modalSeletorPC').style.display = 'flex';
    }
}

function renderizarGridPC() {
    const container = document.getElementById('gridCoresPC');
    container.innerHTML = '';
    
    CORES_DISPONIVEIS.forEach(cor => {
        const dot = document.createElement('div');
        dot.className = 'dot-pc';
        dot.style.backgroundColor = cor;
        dot.onclick = () => {
            atualizarCorInteligente(modoCorAtual, cor);
            document.getElementById('modalSeletorPC').style.display = 'none';
        };
        container.appendChild(dot);
    });
}

function atualizarCorInteligente(modo, cor) {
    if (modo === 'novo') {
        // Atualiza Modal Novo Perfil
        document.getElementById('corNovoPerfil').value = cor;
        document.getElementById('btnVisualCorNovo').style.backgroundColor = cor; 
        document.getElementById('nativeCorNovo').value = cor;
    } 
    else if (modo === 'edicao') {
        // Atualiza Modal Permissões (APENAS VISUALMENTE)
        document.getElementById('corPerfilEdicao').value = cor;
        document.getElementById('btnVisualCorEdicao').style.backgroundColor = cor;
        document.getElementById('nativeCorEdicao').value = cor;
        
    }
}

// --- Função para formatar texto (Title Case) ---  
function formatarTexto(texto) {
    if (!texto) return "";
    return texto
        .toLowerCase()          // 1. Tudo minúsculo
        .trim()                 // 2. Remove espaços nas pontas
        .split(' ')             // 3. Separa as palavras
        .filter(p => p !== "")  // 4. Remove espaços vazios duplos (segurança extra)
        .map(palavra => palavra.charAt(0).toUpperCase() + palavra.slice(1)) // 5. 1ª letra Maiúscula
        .join(' ');             // 6. Junta tudo de volta
}

function carregarListaProfessores() {
    db.ref('sistemas/cadastro/jogadores').on('value', snapshot => {
        const select = document.getElementById('aula-professor');
        
        // 1. Guarda quem estava selecionado antes da lista atualizar
        const valorAntesDaAtualizacao = select.value; 

        const jogadores = snapshot.val() || {};
        
        // Limpa e recria a opção padrão
        select.innerHTML = '<option value="">Sem Professor</option>';
        
        const listaNomesValidos = []; // Vamos usar isso para verificar depois

        Object.keys(jogadores).forEach(key => {
            const dados = jogadores[key];
            
            // Verifica se tem perfil "Professor"
            const ehProfessor = (dados.perfis && dados.perfis['Professor']) || 
                                (dados.funcoes && dados.funcoes.professor);

            if (ehProfessor) {
                const nomeExibicao = dados.apelido ? dados.apelido : key;
                const nomeFormatado = nomeExibicao.charAt(0).toUpperCase() + nomeExibicao.slice(1).toLowerCase();
                
                // Adiciona na lista de nomes válidos
                listaNomesValidos.push(nomeFormatado);
            }
        });

        listaNomesValidos.sort();

        // Cria as opções no HTML
        listaNomesValidos.forEach(nome => {
            const option = document.createElement('option');
            option.value = nome;
            option.textContent = nome;
            select.appendChild(option);
        });

        // 2. LÓGICA DE CORREÇÃO:
        // Se tínhamos alguém selecionado, verificamos se ele AINDA está na lista nova.
        if (valorAntesDaAtualizacao && listaNomesValidos.includes(valorAntesDaAtualizacao)) {
            // Se ele ainda é professor, mantém selecionado
            select.value = valorAntesDaAtualizacao;
        } else {
            // Se ele não é mais professor (foi excluído ou perdeu perfil), volta para o padrão
            select.value = ""; 
        }
    });
} 



// --- FUNÇÕES DA LIMPEZA AUTOMÁTICA DO MURAL ---

// --- NOVA LÓGICA DO MURAL (SEM SALVAR AUTOMATICAMENTE) ---

function verificarOpcaoMural(select) {
    const valor = select.value;

    if (valor === 'custom') {
        // Abre o modal para digitar o número
        mostrarInput(
            "Dias Personalizados", 
            "Por quantos dias as mensagens devem ficar visíveis?", 
            "Ex: 15", 
            (valorDigitado) => {
                const dias = parseInt(valorDigitado);
                if (dias && dias > 0) {
                    // CRIA A OPÇÃO TEMPORÁRIA NA TELA
                    aplicarOpcaoCustomizada(dias);
                } else {
                    mostrarNotificacao("Número inválido.", "warning");
                    // Se cancelar ou errar, volta para o padrão (7 dias ou o que estava antes)
                    select.value = "7"; 
                }
            }
        );
    }
    // Se for 1, 2, 7 ou 30, não faz nada. O valor fica selecionado no select 
    // esperando você clicar no botão "Salvar Configurações".
}

// Função auxiliar apenas para criar a opção visualmente no dropdown
function aplicarOpcaoCustomizada(dias) {
    const selectMural = document.getElementById('selectLimpezaMural');
    
    // Remove opção custom anterior se houver
    const optAntiga = selectMural.querySelector('option[data-custom="true"]');
    if (optAntiga) optAntiga.remove();

    const novaOpcao = document.createElement('option');
    novaOpcao.value = dias;
    novaOpcao.text = `${dias} dias (Personalizado)`;
    novaOpcao.setAttribute('data-custom', 'true');

    // Insere antes do "Outros..."
    const opcaoOutros = selectMural.querySelector('option[value="custom"]');
    selectMural.insertBefore(novaOpcao, opcaoOutros);
    
    // Seleciona a nova opção
    selectMural.value = dias;
}


/**
 * Controla a troca de abas (quadras) e sincroniza os checkboxes de Duplas
 */
/**
 * Controla a troca de abas (quadras) e sincroniza os checkboxes de Duplas
 * Versão Final: Blindada e Limpa
 */
/**
 * Controla a troca de abas (quadras) e sincroniza os checkboxes de Duplas
 * Versão Corrigida: Usa os novos Switches do Menu Kebab
 */
/**
 * Controla a troca de abas (quadras), sincroniza os switches e aplica o efeito visual (OFF)
 */
function selecionarQuadraDuplas(quadraKey, pularSincronia = false) {
    quadraDuplasAtual = quadraKey;

    // 1. Atualiza visual das abas
    ['Quadra1', 'Quadra2', 'Quadra3'].forEach((q, idx) => {
        const btn = document.getElementById(`btn-duplas-q${idx+1}`);
        if (btn) {
            if (q === quadraKey) btn.classList.add('active');
            else btn.classList.remove('active');
        }
    });

    // 2. Título
    const nomes = { 'Quadra1': 'Quadra 1 - Coberta', 'Quadra2': 'Quadra 2 - Aberta', 'Quadra3': 'Quadra 3 - Coberta' };
    const tituloElemento = document.getElementById('tituloDuplasQuadra');
    if (tituloElemento) {
        tituloElemento.innerHTML = nomes[quadraKey];
    }

    // 3. Garante estrutura da quadra na memória
    if (!configDuplasGlobal[quadraKey]) {
        configDuplasGlobal[quadraKey] = { Ativo: false, Grade: {} };
    }

    // 4. Sincroniza Kebab Global (O Chefe)
    const switchAtivar = document.getElementById('switchAtivarDuplas');
    const switchRanking = document.getElementById('switchRankingDuplas');
    if (switchAtivar) switchAtivar.checked = configDuplasGlobal.Ativo === true;
    if (switchRanking) switchRanking.checked = configDuplasGlobal.Ranking === true;

    // 5. Sincroniza o Checkbox da Quadra e aplica a Regra do Chefe
    const chkAtivarQuadra = document.getElementById('checkboxAtivarQuadraDuplas');
    if (chkAtivarQuadra) {
        // Verifica se a quadra está marcada como ativa
        const isAtiva = configDuplasGlobal[quadraKey].Ativo === true;
        chkAtivarQuadra.checked = isAtiva;
        
        // Regra do Chefe: Bloqueia e deixa cinza se o Torneio Geral estiver OFF
        const chefeAtivo = configDuplasGlobal.Ativo === true;
        chkAtivarQuadra.disabled = !chefeAtivo;
        
        const labelSpan = chkAtivarQuadra.nextElementSibling;
        if (labelSpan) {
            labelSpan.style.color = chefeAtivo ? '#2e7d32' : '#999';
        }
    }

    atualizarVisualDuplas();
    renderizarTabelaDuplas();
}

/**
 * Gera a grade visual de horários para as Duplas (A planilha que estava faltando)
 */
function renderizarTabelaDuplas() {
    const tbody = document.getElementById('tbodyDuplas');
    if (!tbody) return;
    tbody.innerHTML = '';

    const dadosQuadra = configDuplasGlobal[quadraDuplasAtual] || {};
    const gradeRascunho = dadosQuadra.Grade || {};

    for (let hora = 6; hora <= 22; hora++) {
        const tr = document.createElement('tr');
        const txtHora = `${String(hora).padStart(2,'0')}:00 - ${String(hora + 1).padStart(2,'0')}:00`;
        
        // Coluna Hora Esquerda
        let html = `<td ondblclick="alternarTelaCheiaDuplas()" style="cursor: pointer; user-select: none;" title="Duplo clique para Tela Cheia">${txtHora}</td>`;

        for (let dia = 1; dia <= 7; dia++) {
            const key = `${dia}_${hora}`;
            
            // --- NOVA LÓGICA: Verifica se o clube está aberto neste horário ---
            // Reutiliza as funções que já existem no seu sistema (usadas em Aulas)
            const regrasPadrao = obterRegrasPadrao(dia);
            const estaAberto = verificarSeAbertoNoPadrao(regrasPadrao, hora);

            if (!estaAberto) {
                // Se fechado: Célula Cinza e Bloqueada (Igual Aulas)
                html += `<td class="aula-cell-bloqueada"></td>`;
            } else {
                // Se aberto: Lógica normal de marcar/desmarcar
                const marcado = gradeRascunho[key] === true;
                const classe = marcado ? 'dupla-cell-marcada' : 'aula-cell-livre';
                const texto = marcado ? 'Duplas' : ''; // Texto corrigido para "Duplas" 
                
                html += `<td class="${classe}" id="cell-dupla-${key}" onclick="alternarSlotDupla('${key}')">${texto}</td>`;
            }
        }

        // Coluna Hora Direita
        html += `<td ondblclick="alternarTelaCheiaDuplas()" style="cursor: pointer; user-select: none;" title="Duplo clique para Tela Cheia">${txtHora}</td>`;
        
        tr.innerHTML = html;
        tbody.appendChild(tr);
    }
}



/**
 * Marca ou desmarca um horário específico na grade (fica Vermelho ao clicar)
 */
function alternarSlotDupla(key) {
    const isQuadraAtiva = configDuplasGlobal[quadraDuplasAtual] && configDuplasGlobal[quadraDuplasAtual].Ativo === true;
    if (!configDuplasGlobal.Ativo || !isQuadraAtiva) return;

    if (!configDuplasGlobal[quadraDuplasAtual].Grade) configDuplasGlobal[quadraDuplasAtual].Grade = {};
    const grade = configDuplasGlobal[quadraDuplasAtual].Grade;
    const cell = document.getElementById(`cell-dupla-${key}`);

    if (grade[key]) {
        delete grade[key];
        cell.className = 'aula-cell-livre';
        cell.textContent = '';
    } else {
        grade[key] = true;
        cell.className = 'dupla-cell-marcada';
        cell.textContent = 'Duplas';
    }
    marcarComoAlterado();
}

function acaoDuplas(tipo) {
    const isQuadraAtiva = configDuplasGlobal[quadraDuplasAtual] && configDuplasGlobal[quadraDuplasAtual].Ativo === true;
    if (!configDuplasGlobal.Ativo || !isQuadraAtiva) return;

    if (!configDuplasGlobal[quadraDuplasAtual].Grade) configDuplasGlobal[quadraDuplasAtual].Grade = {};
    const grade = configDuplasGlobal[quadraDuplasAtual].Grade;
    
    for (let hora = 6; hora <= 22; hora++) {
        for (let dia = 1; dia <= 7; dia++) {
            const key = `${dia}_${hora}`;
            const regrasPadrao = obterRegrasPadrao(dia);
            if (verificarSeAbertoNoPadrao(regrasPadrao, hora)) {
                if (tipo === 'selecionar') grade[key] = true;
                else delete grade[key];
            }
        }
    }
    renderizarTabelaDuplas();
    marcarComoAlterado();
}


function toggleAtivarDuplas(checked) {
    configDuplasGlobal.Ativo = checked; 
    
    const chkAtivarQuadra = document.getElementById('checkboxAtivarQuadraDuplas');
    if (chkAtivarQuadra) {
        chkAtivarQuadra.disabled = !checked;
        const labelSpan = chkAtivarQuadra.nextElementSibling;
        if (labelSpan) {
            labelSpan.style.color = checked ? '#2e7d32' : '#999';
        }
    }

    atualizarVisualDuplas();
    renderizarTabelaDuplas();
    marcarComoAlterado();
}

function toggleRankingDuplas(checked) {
    configDuplasGlobal.Ranking = checked;
    marcarComoAlterado();
}

function toggleAtivarQuadraDuplas(isAtivo) {
    if (!configDuplasGlobal.Ativo) {
        document.getElementById('checkboxAtivarQuadraDuplas').checked = false;
        return;
    }
    if (!configDuplasGlobal[quadraDuplasAtual]) {
        configDuplasGlobal[quadraDuplasAtual] = { Ativo: false, Grade: {} };
    }
    configDuplasGlobal[quadraDuplasAtual].Ativo = isAtivo;
    
    atualizarVisualDuplas();
    marcarComoAlterado();
}


/**
 * Aplica o rascunho de Duplas ao objeto principal de horários antes do salvamento final
 */
function salvarConfiguracaoDuplas() {
    // Sincroniza os switches globais antes de salvar
    configDuplasGlobal.Ativo = document.getElementById('switchAtivarDuplas').checked;
    configDuplasGlobal.Ranking = document.getElementById('switchRankingDuplas').checked;

    // --- REMOVE O 'RANKING' INTRUSO DAS QUADRAS (Limpeza do banco) ---
    ['Quadra1', 'Quadra2', 'Quadra3'].forEach(q => {
        if (configDuplasGlobal[q] && configDuplasGlobal[q].Ranking !== undefined) {
            delete configDuplasGlobal[q].Ranking;
        }
    });

    carrinhoDuplas = JSON.parse(JSON.stringify(configDuplasGlobal));
    
    if (!horariosGlobal) horariosGlobal = {};
    horariosGlobal.Duplas = carrinhoDuplas;

    fecharModalHorario('duplas');
    marcarComoAlterado();
    mostrarNotificacao("Configurações de Duplas prontas para salvar!", "info");
}


// Variável de controle para o duplo clique (pode ficar junto com as outras globais ou aqui mesmo)
let ultimoTempoCliqueDuplas = 0;

// Função que detecta o duplo clique no cabeçalho
function tratarCliqueHorarioDuplas(event) {
    if (window.getSelection) {
        window.getSelection().removeAllRanges(); // Evita selecionar o texto
    }

    const tempoAtual = new Date().getTime();
    const diferenca = tempoAtual - ultimoTempoCliqueDuplas;
    
    // Se o segundo clique for rápido (< 300ms), ativa a tela cheia
    if (diferenca < 300 && diferenca > 0) {
        alternarTelaCheiaDuplas();
        ultimoTempoCliqueDuplas = 0;
    } else {
        ultimoTempoCliqueDuplas = tempoAtual;
    }
}

// Função que alterna o CSS para maximizar
function alternarTelaCheiaDuplas() {
    if (window.getSelection) {
        window.getSelection().removeAllRanges();
    }
    
    const modalContent = document.querySelector('#modalHorarioDuplas .modal-content');
    
    if (modalContent) {
        if (modalContent.classList.contains('maximizado')) {
            modalContent.classList.remove('maximizado');
        } else {
            modalContent.classList.add('maximizado');
        }
    }
}


/* ================================================================= */
/* ===           LÓGICA DO MENU DE DUPLAS (KEBAB MENU)           === */
/* ================================================================= */

function toggleMenuDuplas(event) {
    // Passo crucial: Impede que o clique no botão se propague para o cabeçalho.
    // Sem isso, o sistema acharia que você quer maximizar a janela (duplo clique).
    event.stopPropagation();

    const menu = document.getElementById('menuDropdownDuplas');
    
    // Alterna entre mostrar e esconder
    if (menu.style.display === 'block') {
        menu.style.display = 'none';
    } else {
        menu.style.display = 'block';
    }
}

// Evento global para fechar o menu ao clicar fora dele
// Evento global para fechar os menus ao clicar fora deles
window.addEventListener('click', function(e) {
    
    // 1. Vigia o menu de Duplas
    const menuDuplas = document.getElementById('menuDropdownDuplas');
    const btnDuplas = document.getElementById('btnKebabDuplas');
    if (menuDuplas && menuDuplas.style.display === 'block') {
        if (!menuDuplas.contains(e.target) && (!btnDuplas || !btnDuplas.contains(e.target))) {
            menuDuplas.style.display = 'none'; 
        }
    }

    // 2. Vigia o menu de Pirâmide
    const menuPiramide = document.getElementById('menuDropdownPiramide');
    const btnPiramide = document.getElementById('btnKebabPiramide');
    if (menuPiramide && menuPiramide.style.display === 'block') {
        // Se não clicou dentro do menu e não clicou no botão dos 3 pontinhos...
        if (!menuPiramide.contains(e.target) && (!btnPiramide || !btnPiramide.contains(e.target))) {
            menuPiramide.style.display = 'none'; // ...então fecha o menu.
        }
    }
	
	// 3. Vigia o menu de Convidados
    const menuConvidados = document.getElementById('menuDropdownConvidados');
    const btnConvidados = document.getElementById('btnKebabConvidados');
    if (menuConvidados && menuConvidados.style.display === 'block') {
        if (!menuConvidados.contains(e.target) && (!btnConvidados || !btnConvidados.contains(e.target))) {
            menuConvidados.style.display = 'none'; 
        }
    }
	
});


/* --- FUNÇÃO AUXILIAR PARA O EFEITO VISUAL --- */
/* --- FUNÇÃO AUXILIAR PARA O EFEITO VISUAL E BLOQUEIO --- */
/* --- ATUALIZAÇÃO VISUAL: FOCO EXCLUSIVO EM SELECIONAR E LIMPAR --- */
// --- NOVA FUNÇÃO: Controle Visual da Capa Cinza nas Duplas ---
function atualizarVisualDuplas() {
    const titulo = document.getElementById('tituloPrincipalDuplas');
    const containerTabela = document.querySelector('#modalHorarioDuplas .tabela-horarios-scroll');
    const btnSelecionar = document.getElementById('btnSelecionarDuplas');
    const btnLimpar = document.getElementById('btnLimparDuplas');
    const tituloQuadra = document.getElementById('tituloDuplasQuadra');

    // Regras de liberação (O Chefe E a Quadra precisam estar ON)
    const chefeAtivo = configDuplasGlobal.Ativo === true;
    const quadraAtiva = configDuplasGlobal[quadraDuplasAtual] && configDuplasGlobal[quadraDuplasAtual].Ativo === true;
    const telaLiberada = chefeAtivo && quadraAtiva;

    if (telaLiberada) {
        if (containerTabela) {
            containerTabela.classList.remove('duplas-desativadas');
            containerTabela.style.pointerEvents = 'auto';
            containerTabela.style.opacity = '1';
            containerTabela.style.filter = 'none';
        }
        if (btnSelecionar) {
            btnSelecionar.classList.remove('btn-acao-desativado');
            btnSelecionar.style.setProperty('background-color', '#007bff', 'important');
            btnSelecionar.style.setProperty('color', '#ffffff', 'important');
            btnSelecionar.style.setProperty('opacity', '1', 'important');
            btnSelecionar.style.cursor = 'pointer';
            btnSelecionar.style.pointerEvents = 'auto';
        }
        if (btnLimpar) {
            btnLimpar.classList.remove('btn-acao-desativado');
            btnLimpar.style.setProperty('background-color', '#ffffff', 'important');
            btnLimpar.style.setProperty('color', '#333333', 'important');
            btnLimpar.style.setProperty('opacity', '1', 'important');
            btnLimpar.style.cursor = 'pointer';
            btnLimpar.style.pointerEvents = 'auto';
        }
    } else {
        if (containerTabela) {
            containerTabela.classList.add('duplas-desativadas');
            containerTabela.style.pointerEvents = 'none';
            containerTabela.style.opacity = '0.5';
            containerTabela.style.filter = 'grayscale(100%)';
        }
        [btnSelecionar, btnLimpar].forEach(btn => {
            if (btn) {
                btn.classList.add('btn-acao-desativado');
                btn.style.setProperty('background-color', '#e0e0e0', 'important');
                btn.style.setProperty('color', '#999999', 'important');
                btn.style.setProperty('border', '1px solid #d0d0d0', 'important');
                btn.style.setProperty('opacity', '0.6', 'important');
                btn.style.setProperty('cursor', 'not-allowed', 'important');
                btn.style.pointerEvents = 'none';
            }
        });
    }

    if (tituloQuadra) tituloQuadra.style.removeProperty('color');
    if (chefeAtivo) {
        if (titulo) titulo.style.removeProperty('color');
    } else {
        if (titulo) titulo.style.setProperty('color', '#ff4444', 'important');
    }
}





/* ================================================================= */
/* ===           MÓDULO DE LÓGICA: HORÁRIO DE PIRÂMIDE           === */
/* ================================================================= */

function selecionarQuadraPiramide(quadraKey) {
    quadraPiramideAtual = quadraKey;

    // 1. GERENCIAMENTO VISUAL DAS ABAS (Seu padrão mantido)
    for (let i = 1; i <= 3; i++) {
        const btn = document.getElementById(`tabPiramideQ${i}`);
        if (btn) {
            if (`Quadra${i}` === quadraKey) {
                btn.classList.add('active');
                btn.style.setProperty('background-color', '#4CAF50', 'important');
                btn.style.setProperty('color', 'white', 'important');
            } else {
                btn.classList.remove('active');
                btn.style.backgroundColor = '#f1f1f1';
                btn.style.color = '#555';
            }
        }
    }

    // 2. SINCRONIA DOS NOMES
    const nomesFieis = { 
        'Quadra1': 'Quadra 1 - Coberta', 
        'Quadra2': 'Quadra 2 - Aberta', 
        'Quadra3': 'Quadra 3 - Coberta' 
    };
    
    const elTitulo = document.getElementById('tituloPiramideQuadra');
    if (elTitulo) elTitulo.innerText = nomesFieis[quadraKey];

    // 3. ATUALIZAÇÃO DA TABELA E CHECKBOX (Lógica Global)
    if (!configPiramideGlobal[quadraKey]) configPiramideGlobal[quadraKey] = { Grade: {} };

    // Sincroniza o Switch do Menu Kebab com a chave Global
    const switchAtivar = document.getElementById('switchAtivarPiramide');
    if (switchAtivar) switchAtivar.checked = configPiramideGlobal.Ativo || false;

    // --- NOVO: Sincroniza o Checkbox da Quadra e aplica a Regra do Chefe ---
    const chkAtivarQuadra = document.getElementById('checkboxAtivarQuadraPiramide');
    if (chkAtivarQuadra) {
        // Verifica se esta quadra está marcada como ativa no banco
        const isAtiva = configPiramideGlobal[quadraKey].Ativa === true;
        chkAtivarQuadra.checked = isAtiva;
        
        // REGRA DO CHEFE: Bloqueia e deixa cinza se o Torneio Geral estiver OFF
        const chefeAtivo = configPiramideGlobal.Ativo;
        chkAtivarQuadra.disabled = !chefeAtivo;
        
        const labelSpan = chkAtivarQuadra.nextElementSibling; // Pega o <span>Ativar</span>
        if (labelSpan) {
            labelSpan.style.color = chefeAtivo ? '#2e7d32' : '#999'; // Verde se chefe ON, Cinza se chefe OFF
        }
    }

    // Aplica o bloqueio visual usando o Ativo Global
    atualizarVisualPiramide();
    renderizarTabelaPiramide();
}


function renderizarTabelaPiramide() {
    const tbody = document.getElementById('tabelaHorariosPiramide');
    if (!tbody) return;
    tbody.innerHTML = '';

    // Pegamos a grade da quadra atual
    const dadosQuadra = configPiramideGlobal[quadraPiramideAtual] || { Grade: {} };
    const grade = dadosQuadra.Grade || {};

    // Loop de horários (6h às 22h)
    for (let h = 6; h <= 22; h++) {
        const tr = document.createElement('tr');
        const txtHora = `${String(h).padStart(2, '0')}:00 - ${String(h + 1).padStart(2, '0')}:00`;

        // Coluna Horário (Esquerda)
        let tdEsq = document.createElement('td');
        tdEsq.className = "sem-selecao";
        tdEsq.textContent = txtHora;
        // Mantém a funcionalidade de tela cheia no duplo clique
        tdEsq.ondblclick = () => alternarTelaCheiaPiramide(); 
        tr.appendChild(tdEsq);

        // Dias da Semana (1 a 7)
        for (let dia = 1; dia <= 7; dia++) {
            const td = document.createElement('td');
            
            // --- NOVA CHAVE NUMÉRICA (Ex: "1_6") ---
            const key = `${dia}_${h}`; 

            // Verifica se o horário está aberto no Horário Padrão
            const regrasPadrao = obterRegrasPadrao(dia);
            const estaAberto = verificarSeAbertoNoPadrao(regrasPadrao, h);

            if (!estaAberto) {
                // Se a quadra está fechada no padrão, fica bloqueada
                td.className = 'aula-cell-bloqueada';
            } else {
                // Se está marcado na Pirâmide: Vermelho + "exceto"
                if (grade[key]) {
                    td.className = "aula-cell-marcada"; 
                    td.textContent = "exceto";
                } else {
                    td.className = "aula-cell-livre";
                    td.textContent = "";
                }

                // Ação do Clique
                td.onclick = () => {
                    // Só permite alteração se o Ativo Global E a Quadra estiverem ON
                    const isQuadraAtiva = configPiramideGlobal[quadraPiramideAtual] && configPiramideGlobal[quadraPiramideAtual].Ativa === true;
                    if (!configPiramideGlobal.Ativo || !isQuadraAtiva) return;

                    if (grade[key]) {
                        delete grade[key];
                        td.className = "aula-cell-livre";
                        td.textContent = "";
                    } else {
                        grade[key] = true;
                        td.className = "aula-cell-marcada";
                        td.textContent = "exceto";
                    }
                    marcarComoAlterado();
                };
            }
            tr.appendChild(td);
        }

        // Coluna Horário (Direita)
        let tdDir = document.createElement('td');
        tdDir.className = "sem-selecao";
        tdDir.textContent = txtHora;
        tdDir.ondblclick = () => alternarTelaCheiaPiramide();
        tr.appendChild(tdDir);

        tbody.appendChild(tr);
    }
}


// ==========================================================
// NOVAS FUNÇÕES TELA CHEIA - PIRÂMIDE (Adicione logo abaixo)
// ==========================================================

let ultimoTempoCliquePiramide = 0;

function tratarCliqueHorarioPiramide(event) {
    if (window.getSelection) {
        window.getSelection().removeAllRanges(); // Evita selecionar o texto de azul
    }

    const tempoAtual = new Date().getTime();
    const diferenca = tempoAtual - ultimoTempoCliquePiramide;
    
    // Se o segundo clique for rápido (< 300ms), ativa a tela cheia
    if (diferenca < 300 && diferenca > 0) {
        alternarTelaCheiaPiramide();
        ultimoTempoCliquePiramide = 0;
    } else {
        ultimoTempoCliquePiramide = tempoAtual;
    }
}

function alternarTelaCheiaPiramide() {
    if (window.getSelection) {
        window.getSelection().removeAllRanges();
    }
    
    const modalContent = document.querySelector('#modalHorarioPiramide .modal-content');
    
    if (modalContent) {
        if (modalContent.classList.contains('maximizado')) {
            modalContent.classList.remove('maximizado');
        } else {
            modalContent.classList.add('maximizado');
        }
    }
}



// Funções Auxiliares (Menu, Ativar, Salvar)
function toggleMenuPiramide(e) {
    if(e) e.stopPropagation();
    const menu = document.getElementById('menuDropdownPiramide');
    if(menu) menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
}


// --- 3. SWITCHES DO MENU KEBAB (Ativo e Ranking) ---
function toggleAtivarPiramide(checked) {
    configPiramideGlobal.Ativo = checked; // Salva na raiz (Global)
    
    // --- NOVO: Atualiza o visual do checkbox da quadra na mesma hora ---
    const chkAtivarQuadra = document.getElementById('checkboxAtivarQuadraPiramide');
    if (chkAtivarQuadra) {
        chkAtivarQuadra.disabled = !checked;
        const labelSpan = chkAtivarQuadra.nextElementSibling;
        if (labelSpan) {
            labelSpan.style.color = checked ? '#2e7d32' : '#999';
        }
    }

    atualizarVisualPiramide();
    renderizarTabelaPiramide();
    marcarComoAlterado();
}


function toggleAtivarQuadraPiramide(isAtivo) {
    // Regra do Chefe (Segurança Extra): se o torneio todo estiver OFF, ignora o clique
    if (!configPiramideGlobal.Ativo) {
        document.getElementById('checkboxAtivarQuadraPiramide').checked = false;
        return;
    }

    // Garante que a quadra atual existe no objeto global e salva a nova configuração
    if (!configPiramideGlobal[quadraPiramideAtual]) {
        configPiramideGlobal[quadraPiramideAtual] = { Grade: {} };
    }
    
    configPiramideGlobal[quadraPiramideAtual].Ativa = isAtivo;

    // ---> A MÁGICA QUE FALTOU AQUI <---
    // Atualiza a tela (tira ou coloca a capa cinza e trava/destrava os botões) na mesma hora
    atualizarVisualPiramide();

    // Avisa o botão "Salvar Configurações" que houve mudança
    marcarComoAlterado();
}



function toggleRankingPiramide(checked) {
    configPiramideGlobal.Ranking = checked; // Salva na raiz (Global)
    marcarComoAlterado();
}


function atualizarVisualPiramide() {
    // 1. Encontra os elementos
    const tabela = document.querySelector('#modalHorarioPiramide .tabela-horarios-scroll');
    const tituloQuadra = document.getElementById('tituloPiramideQuadra');
    const tituloPrincipal = document.querySelector('#modalHorarioPiramide h2');
    const btnSelecionar = document.querySelector('#modalHorarioPiramide .btn-mini:not(.outline)');
    const btnLimpar = document.querySelector('#modalHorarioPiramide .btn-mini.outline');

    // 2. Define as regras de liberação
    const chefeAtivo = configPiramideGlobal.Ativo === true;
    const quadraAtiva = configPiramideGlobal[quadraPiramideAtual] && configPiramideGlobal[quadraPiramideAtual].Ativa === true;
    const telaLiberada = chefeAtivo && quadraAtiva; // Só libera se o torneio E a quadra estiverem ON

    // 3. Aplica o visual da Planilha e Botões (Depende dos dois)
    if (telaLiberada) {
        if (tabela) { 
            tabela.style.setProperty('opacity', '1', 'important'); 
            tabela.style.setProperty('pointer-events', 'auto', 'important'); 
            tabela.style.setProperty('filter', 'none', 'important'); 
        }
        
        if (btnSelecionar) {
            btnSelecionar.classList.remove('btn-acao-desativado');
            btnSelecionar.style.removeProperty('background-color');
            btnSelecionar.style.removeProperty('color');
            btnSelecionar.style.removeProperty('cursor');
            btnSelecionar.style.removeProperty('pointer-events');
            btnSelecionar.style.removeProperty('opacity');
        }
        if (btnLimpar) {
            btnLimpar.classList.remove('btn-acao-desativado');
            btnLimpar.style.removeProperty('background-color');
            btnLimpar.style.removeProperty('color');
            btnLimpar.style.removeProperty('cursor');
            btnLimpar.style.removeProperty('pointer-events');
            btnLimpar.style.removeProperty('opacity');
        }
    } else {
        if (tabela) { 
            tabela.style.setProperty('opacity', '0.5', 'important'); 
            tabela.style.setProperty('pointer-events', 'none', 'important'); 
            tabela.style.setProperty('filter', 'grayscale(100%)', 'important'); 
        }
        
        if (btnSelecionar) {
            btnSelecionar.classList.add('btn-acao-desativado');
            btnSelecionar.style.setProperty('background-color', '#e0e0e0', 'important');
            btnSelecionar.style.setProperty('color', '#999999', 'important');
            btnSelecionar.style.setProperty('cursor', 'not-allowed', 'important');
            btnSelecionar.style.setProperty('pointer-events', 'none', 'important');
            btnSelecionar.style.setProperty('opacity', '0.6', 'important');
        }
        if (btnLimpar) {
            btnLimpar.classList.add('btn-acao-desativado');
            btnLimpar.style.setProperty('background-color', '#e0e0e0', 'important');
            btnLimpar.style.setProperty('color', '#999999', 'important');
            btnLimpar.style.setProperty('cursor', 'not-allowed', 'important');
            btnLimpar.style.setProperty('pointer-events', 'none', 'important');
            btnLimpar.style.setProperty('opacity', '0.6', 'important'); 
        }
    }

    // 4. Aplica o visual dos Títulos (O Título Principal depende SÓ do Chefe)
    if (tituloQuadra) tituloQuadra.style.removeProperty('color');
    
    if (chefeAtivo) {
        if (tituloPrincipal) tituloPrincipal.style.removeProperty('color'); // Deixa o CSS assumir (Branco no escuro, Preto no claro)
    } else {
        if (tituloPrincipal) tituloPrincipal.style.setProperty('color', '#ff4444', 'important'); // Mantém vermelho se estiver desligado
    }
}




function selecionarTudoPiramide() {
    // Bloqueio de segurança: Exige Chefe ON e Quadra ON
    const isQuadraAtiva = configPiramideGlobal[quadraPiramideAtual] && configPiramideGlobal[quadraPiramideAtual].Ativa === true;
    if (!configPiramideGlobal.Ativo || !isQuadraAtiva) return;

    const grade = configPiramideGlobal[quadraPiramideAtual].Grade;
    
    // Percorre dias (1-7) e horas (6-22)
    for (let d = 1; d <= 7; d++) {
        for (let h = 6; h <= 22; h++) {
            const regrasPadrao = obterRegrasPadrao(d);
            if (verificarSeAbertoNoPadrao(regrasPadrao, h)) {
                grade[`${d}_${h}`] = true;
            }
        }
    }
    renderizarTabelaPiramide();
    marcarComoAlterado();
}



function limparTudoPiramide() {
    // Bloqueio de segurança: Exige Chefe ON e Quadra ON
    const isQuadraAtiva = configPiramideGlobal[quadraPiramideAtual] && configPiramideGlobal[quadraPiramideAtual].Ativa === true;
    if (!configPiramideGlobal.Ativo || !isQuadraAtiva) return;

    configPiramideGlobal[quadraPiramideAtual].Grade = {};
    renderizarTabelaPiramide();
    marcarComoAlterado();
}



// --- 4. BOTÃO SALVAR (Prepara o rascunho para o banco) ---
function salvarPiramide() {
    // Sincroniza os switches com o objeto global por garantia
    configPiramideGlobal.Ativo = document.getElementById('switchAtivarPiramide').checked;
    configPiramideGlobal.Ranking = document.getElementById('switchRankingPiramide').checked;

    // Alimenta o carrinho que será enviado ao Firebase no salvamento geral da página
    carrinhoPiramide = JSON.parse(JSON.stringify(configPiramideGlobal));
    
    // Sincroniza com a variável de memória que o sistema usa para carregar as telas
    if (!horariosGlobal) horariosGlobal = {};
    horariosGlobal.Piramide = carrinhoPiramide;

    fecharModalHorarioPiramide();
    marcarComoAlterado();
    mostrarNotificacao("Configurações da Pirâmide prontas para salvar!", "info");
}

function fecharModalHorarioPiramide() {
    document.getElementById('modalHorarioPiramide').style.display = 'none';
    // Remove o modo maximizado caso tenha sido fechado nele
    const content = document.querySelector('#modalHorarioPiramide .modal-content');
    if (content) content.classList.remove('maximizado');
}





// ==========================================
// CONTROLE DE DATAS DO TORNEIO DA PIRÂMIDE
// ==========================================

function formatarDataBR(dataISO) {
    if (!dataISO) return "";
    const partes = dataISO.split('-');
    if (partes.length !== 3) return dataISO;
    // Retorna no formato DD/MM/AA para economizar espaço
    return `${partes[2]}/${partes[1]}/${partes[0].substring(2)}`;
}

function atualizarTextoDataPiramide() {
    const btnTexto = document.getElementById('btnDataPiramideKebab');
    if (!btnTexto) return;

    const inicio = configPiramideGlobal.Inicio;
    const fim = configPiramideGlobal.Fim;

    if (inicio && fim) {
        btnTexto.innerHTML = `📅 ${formatarDataBR(inicio)} à ${formatarDataBR(fim)}`;
        btnTexto.style.color = "#333"; // Cor normal se já tem data
    } else {
        btnTexto.innerHTML = `📅 Definir datas...`;
        btnTexto.style.color = "#4CAF50"; // Verde se precisar definir
    }
}

function abrirModalDataPiramide(event) {
    // 1. Fecha o menu Kebab para não atrapalhar
    if (event) event.stopPropagation();
    document.getElementById('menuDropdownPiramide').style.display = 'none';

    // 2. Preenche os inputs com os valores atuais do objeto global
    document.getElementById('inputDataInicioPiramide').value = configPiramideGlobal.Inicio || "";
    document.getElementById('inputDataFimPiramide').value = configPiramideGlobal.Fim || "";

    // 3. Abre a caixinha
    document.getElementById('modalDataPiramide').style.display = 'flex';
}

function fecharModalDataPiramide() {
    document.getElementById('modalDataPiramide').style.display = 'none';
}

function salvarDataPiramide() {
    const inicioStr = document.getElementById('inputDataInicioPiramide').value;
    const fimStr = document.getElementById('inputDataFimPiramide').value;

    // Validação básica
    if (!inicioStr || !fimStr) {
        alert("Por favor, preencha a data de início e a data de fim.");
        return;
    }
    if (inicioStr > fimStr) {
        alert("A data de fim não pode ser menor que a data de início.");
        return;
    }

    // Salva no objeto global
    configPiramideGlobal.Inicio = inicioStr;
    configPiramideGlobal.Fim = fimStr;

    // Atualiza o texto lá no menu dos 3 pontinhos
    atualizarTextoDataPiramide();

    // Fecha a janelinha
    fecharModalDataPiramide();

    // Acorda o botão "Salvar Configurações" avisando que teve alteração
    marcarComoAlterado();
}


/* ================================================================= */
/* ===           MÓDULO DE LÓGICA: HORÁRIO DE CONVIDADOS         === */
/* ================================================================= */

function selecionarQuadraConvidados(quadraKey) {
    quadraConvidadosAtual = quadraKey;

    // 1. GERENCIAMENTO VISUAL DAS ABAS
    for (let i = 1; i <= 3; i++) {
        const btn = document.getElementById(`tabConvidadosQ${i}`);
        if (btn) {
            if (`Quadra${i}` === quadraKey) {
                btn.classList.add('active');
                btn.style.setProperty('background-color', '#4CAF50', 'important'); 
                btn.style.setProperty('color', 'white', 'important');
            } else {
                btn.classList.remove('active');
                btn.style.backgroundColor = '#f1f1f1';
                btn.style.color = '#555';
            }
        }
    }

    // 2. TÍTULO
    const nomes = { 'Quadra1': 'Quadra 1 - Coberta', 'Quadra2': 'Quadra 2 - Aberta', 'Quadra3': 'Quadra 3 - Coberta' };
    const elTitulo = document.getElementById('tituloConvidadosQuadra');
    if (elTitulo) elTitulo.innerText = nomes[quadraKey];

    // 3. GARANTE EXISTÊNCIA
    if (!configConvidadosGlobal[quadraKey]) configConvidadosGlobal[quadraKey] = { Ativa: false, Grade: {} };

    // 4. SINCRONIZA MENU E CHECKBOX
    const switchAtivar = document.getElementById('switchAtivarConvidados');
    if (switchAtivar) switchAtivar.checked = configConvidadosGlobal.Ativo || false;

    const chkAtivarQuadra = document.getElementById('checkboxAtivarQuadraConvidados');
    if (chkAtivarQuadra) {
        chkAtivarQuadra.checked = configConvidadosGlobal[quadraKey].Ativa === true;
        chkAtivarQuadra.disabled = !configConvidadosGlobal.Ativo;
        const labelSpan = chkAtivarQuadra.nextElementSibling;
        if (labelSpan) labelSpan.style.color = configConvidadosGlobal.Ativo ? '#2e7d32' : '#999';
    }

    atualizarVisualConvidados();
    renderizarTabelaConvidados();
}

function renderizarTabelaConvidados() {
    const tbody = document.getElementById('tabelaHorariosConvidados');
    if (!tbody) return;
    tbody.innerHTML = '';

    const dadosQuadra = configConvidadosGlobal[quadraConvidadosAtual] || { Grade: {} };
    const grade = dadosQuadra.Grade || {};

    for (let h = 6; h <= 22; h++) {
        const tr = document.createElement('tr');
        const txtHora = `${String(h).padStart(2, '0')}:00 - ${String(h + 1).padStart(2, '0')}:00`;

        let tdEsq = document.createElement('td');
        tdEsq.className = "sem-selecao";
        tdEsq.textContent = txtHora;
        tdEsq.ondblclick = () => alternarTelaCheiaConvidados();
        tr.appendChild(tdEsq);

        for (let dia = 1; dia <= 7; dia++) {
            const td = document.createElement('td');
            const key = `${dia}_${h}`; 

            const regrasPadrao = obterRegrasPadrao(dia);
            const estaAberto = verificarSeAbertoNoPadrao(regrasPadrao, h);

            if (!estaAberto) {
                td.className = 'aula-cell-bloqueada';
            } else {
                // NOVA LÓGICA DE CORES: Vazia (Padrão) ou Vermelha (exceto)
                if (grade[key]) {
                    td.className = "aula-cell-marcada";
                    td.style.backgroundColor = "#ff3b30"; // Vermelho
                    td.style.color = "white";
                    td.textContent = "exceto";
                } else {
                    td.className = "aula-cell-livre";
                    td.style.backgroundColor = ""; // Deixa sem cor
                    td.style.color = ""; // Deixa sem cor de texto
                    td.textContent = ""; // Fica totalmente vazia
                }
                td.style.cursor = "pointer";

                // CLIQUE NA CÉLULA
                td.onclick = () => {
                    const isQuadraAtiva = configConvidadosGlobal[quadraConvidadosAtual] && configConvidadosGlobal[quadraConvidadosAtual].Ativa === true;
                    if (!configConvidadosGlobal.Ativo || !isQuadraAtiva) return;

                    if (grade[key]) {
                        delete grade[key];
                        td.className = "aula-cell-livre";
                        td.style.backgroundColor = "";
                        td.style.color = ""; 
                        td.textContent = ""; // Volta a ficar vazia
                    } else {
                        grade[key] = true;
                        td.className = "aula-cell-marcada";
                        td.style.backgroundColor = "#ff3b30"; // Vermelho
                        td.style.color = "white"; 
                        td.textContent = "exceto"; // Fica marcada com 'exceto'
                    }
                    marcarComoAlterado();
                };
            }
            tr.appendChild(td);
        }

        let tdDir = document.createElement('td');
        tdDir.className = "sem-selecao";
        tdDir.textContent = txtHora;
        tdDir.ondblclick = () => alternarTelaCheiaConvidados();
        tr.appendChild(tdDir);

        tbody.appendChild(tr);
    }
}


// === FUNÇÕES DE CONTROLE (Ativar, Menu, Limpar) ===

function toggleMenuConvidados(e) {
    if(e) e.stopPropagation();
    const menu = document.getElementById('menuDropdownConvidados');
    if(menu) menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
}

function toggleAtivarConvidados(checked) {
    configConvidadosGlobal.Ativo = checked;
    const chkAtivarQuadra = document.getElementById('checkboxAtivarQuadraConvidados');
    if (chkAtivarQuadra) {
        chkAtivarQuadra.disabled = !checked;
        const labelSpan = chkAtivarQuadra.nextElementSibling;
        if (labelSpan) labelSpan.style.color = checked ? '#2e7d32' : '#999';
    }
    atualizarVisualConvidados();
    renderizarTabelaConvidados();
    marcarComoAlterado();
}

function toggleAtivarQuadraConvidados(isAtivo) {
    if (!configConvidadosGlobal.Ativo) {
        document.getElementById('checkboxAtivarQuadraConvidados').checked = false;
        return;
    }
    if (!configConvidadosGlobal[quadraConvidadosAtual]) configConvidadosGlobal[quadraConvidadosAtual] = { Grade: {} };
    
    configConvidadosGlobal[quadraConvidadosAtual].Ativa = isAtivo;
    atualizarVisualConvidados();
    marcarComoAlterado();
}

function atualizarVisualConvidados() {
    const tabela = document.querySelector('#modalHorarioConvidados .tabela-horarios-scroll');
    const btnSelecionar = document.querySelector('#modalHorarioConvidados .btn-mini:not(.outline)');
    const btnLimpar = document.querySelector('#modalHorarioConvidados .btn-mini.outline');
    
    const chefeAtivo = configConvidadosGlobal.Ativo === true;
    const quadraAtiva = configConvidadosGlobal[quadraConvidadosAtual] && configConvidadosGlobal[quadraConvidadosAtual].Ativa === true;
    const telaLiberada = chefeAtivo && quadraAtiva;

    if (telaLiberada) {
        if (tabela) { 
            tabela.style.setProperty('opacity', '1', 'important'); 
            tabela.style.setProperty('pointer-events', 'auto', 'important'); 
            tabela.style.setProperty('filter', 'none', 'important'); 
        }
        if (btnSelecionar) {
            btnSelecionar.classList.remove('btn-acao-desativado');
            btnSelecionar.style.removeProperty('background-color');
            btnSelecionar.style.removeProperty('color');
            btnSelecionar.style.removeProperty('cursor');
            btnSelecionar.style.removeProperty('pointer-events');
            btnSelecionar.style.removeProperty('opacity');
        }
        if (btnLimpar) {
            btnLimpar.classList.remove('btn-acao-desativado');
            btnLimpar.style.removeProperty('background-color');
            btnLimpar.style.removeProperty('color');
            btnLimpar.style.removeProperty('cursor');
            btnLimpar.style.removeProperty('pointer-events');
            btnLimpar.style.removeProperty('opacity');
        }
    } else {
        if (tabela) { 
            tabela.style.setProperty('opacity', '0.5', 'important'); 
            tabela.style.setProperty('pointer-events', 'none', 'important'); 
            tabela.style.setProperty('filter', 'grayscale(100%)', 'important'); 
        }
        if (btnSelecionar) {
            btnSelecionar.classList.add('btn-acao-desativado');
            btnSelecionar.style.setProperty('background-color', '#e0e0e0', 'important');
            btnSelecionar.style.setProperty('color', '#999999', 'important');
            btnSelecionar.style.setProperty('cursor', 'not-allowed', 'important');
            btnSelecionar.style.setProperty('pointer-events', 'none', 'important');
            btnSelecionar.style.setProperty('opacity', '0.6', 'important');
        }
        if (btnLimpar) {
            btnLimpar.classList.add('btn-acao-desativado');
            btnLimpar.style.setProperty('background-color', '#e0e0e0', 'important');
            btnLimpar.style.setProperty('color', '#999999', 'important');
            btnLimpar.style.setProperty('cursor', 'not-allowed', 'important');
            btnLimpar.style.setProperty('pointer-events', 'none', 'important');
            btnLimpar.style.setProperty('opacity', '0.6', 'important'); 
        }
    }
}


function selecionarTudoConvidados() {
    const isQuadraAtiva = configConvidadosGlobal[quadraConvidadosAtual] && configConvidadosGlobal[quadraConvidadosAtual].Ativa === true;
    if (!configConvidadosGlobal.Ativo || !isQuadraAtiva) return;

    const grade = configConvidadosGlobal[quadraConvidadosAtual].Grade;
    for (let d = 1; d <= 7; d++) {
        for (let h = 6; h <= 22; h++) {
            if (verificarSeAbertoNoPadrao(obterRegrasPadrao(d), h)) {
                grade[`${d}_${h}`] = true;
            }
        }
    }
    renderizarTabelaConvidados();
    marcarComoAlterado();
}

function limparTudoConvidados() {
    const isQuadraAtiva = configConvidadosGlobal[quadraConvidadosAtual] && configConvidadosGlobal[quadraConvidadosAtual].Ativa === true;
    if (!configConvidadosGlobal.Ativo || !isQuadraAtiva) return;

    configConvidadosGlobal[quadraConvidadosAtual].Grade = {};
    renderizarTabelaConvidados();
    marcarComoAlterado();
}

function salvarConvidados() {
    configConvidadosGlobal.Ativo = document.getElementById('switchAtivarConvidados').checked;
    
    // --- NOVO: Captura os valores financeiros digitados ---
    configConvidadosGlobal.Taxa = document.getElementById('taxaConvidado').value;
    configConvidadosGlobal.Recebedor = document.getElementById('recebedorConvidado').value;
	configConvidadosGlobal.Whatsapp = document.getElementById('whatsappConvidado').value;

    carrinhoConvidados = JSON.parse(JSON.stringify(configConvidadosGlobal));
    
    if (!horariosGlobal) horariosGlobal = {};
    horariosGlobal.Convidados = carrinhoConvidados;

    fecharModalHorarioConvidados();
    marcarComoAlterado();
    mostrarNotificacao("Horários de Convidados no carrinho!", "info");
}

let ultimoTempoCliqueConvidados = 0;
function tratarCliqueHorarioConvidados(event) {
    if (window.getSelection) window.getSelection().removeAllRanges();
    const tempoAtual = new Date().getTime();
    if (tempoAtual - ultimoTempoCliqueConvidados < 300 && tempoAtual - ultimoTempoCliqueConvidados > 0) {
        alternarTelaCheiaConvidados();
        ultimoTempoCliqueConvidados = 0;
    } else {
        ultimoTempoCliqueConvidados = tempoAtual;
    }
}

function alternarTelaCheiaConvidados() {
    if (window.getSelection) window.getSelection().removeAllRanges();
    const modalContent = document.querySelector('#modalHorarioConvidados .modal-content');
    if (modalContent) modalContent.classList.toggle('maximizado');
}

function fecharModalHorarioConvidados() {
    document.getElementById('modalHorarioConvidados').style.display = 'none';
}


function carregarListaFinanceiro() {
    db.ref('sistemas/cadastro/jogadores').on('value', snapshot => {
        const select = document.getElementById('recebedorConvidado');
        if (!select) return;
        
        // Guarda o valor que estava selecionado para não apagar quando atualizar
        const valorAntes = select.value; 

        const jogadores = snapshot.val() || {};
        
        // Limpa e recria a opção padrão
        select.innerHTML = '<option value="">Selecione...</option>';
        
        const listaNomesValidos = []; 

        Object.keys(jogadores).forEach(key => {
            const dados = jogadores[key];
            
            // Verifica se o jogador tem o perfil "Financeiro" ativado
            const ehFinanceiro = dados.perfis && dados.perfis['Financeiro'] === true;

            if (ehFinanceiro) {
                const nomeExibicao = dados.apelido ? dados.apelido : key;
                // Separa o nome por espaços, põe a primeira letra de cada palavra em maiúscula e volta a juntar
				const nomeFormatado = nomeExibicao.split(' ').map(palavra => palavra.charAt(0).toUpperCase() + palavra.slice(1).toLowerCase()).join(' ');
                listaNomesValidos.push(nomeFormatado);
            }
        });

        // Ordena por ordem alfabética
        listaNomesValidos.sort();

        // Adiciona as opções no menu
        listaNomesValidos.forEach(nome => {
            const option = document.createElement('option');
            option.value = nome;
            option.textContent = nome;
            select.appendChild(option);
        });

        // Tenta manter selecionado o que já estava ou o que veio do banco de dados
        if (valorAntes && listaNomesValidos.includes(valorAntes)) {
            select.value = valorAntes;
        } else if (configConvidadosGlobal && configConvidadosGlobal.Recebedor && listaNomesValidos.includes(configConvidadosGlobal.Recebedor)) {
            select.value = configConvidadosGlobal.Recebedor;
        } else {
            select.value = ""; 
        }
    });
}

function aplicarMascaraReal(elemento) {
    // Remove tudo que não for número
    let valor = elemento.value.replace(/\D/g, ''); 
    
    if (valor === '') {
        elemento.value = '';
        return;
    }
    
    // Divide por 100 para ter os centavos
    valor = (parseInt(valor, 10) / 100).toFixed(2);
    
    // Troca o ponto pela vírgula e coloca os pontos de milhar
    valor = valor.replace('.', ',');
    valor = valor.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
    
    // Devolve o valor formatado para o campo
    elemento.value = valor;
}

function aplicarMascaraTelefone(elemento) {
    // Remove tudo que não for número
    let valor = elemento.value.replace(/\D/g, ''); 
    
    // Limita a 11 dígitos no máximo (DDD + 9 números)
    if (valor.length > 11) valor = valor.slice(0, 11); 
    
    // Aplica a formatação (XX) XXXXX-XXXX
    if (valor.length > 2) {
        valor = '(' + valor.substring(0, 2) + ') ' + valor.substring(2);
    }
    if (valor.length > 9) {
        valor = valor.substring(0, 10) + '-' + valor.substring(10);
    }
    
    // Devolve formatado para o campo
    elemento.value = valor;
}

</script>
</body>
</html>
