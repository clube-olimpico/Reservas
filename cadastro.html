<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Jogadores</title>
    <!-- Inclus√£o do Firebase App e Database -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <style>
        /* Estilos gerais da p√°gina */
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding-bottom: 60px; /* Espa√ßo para o rodap√© */
            position: relative;
            min-height: 100vh; 
        }

        /* Estilo do container das abas */
        .tab-container {
            display: flex; 
            justify-content: center;
            width: 100%;
            background-color: white;
            padding: 5px 0;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);    
            border-bottom: 3px solid #ccc;
            position: relative; 
        }

        /* Estilo dos bot√µes das abas */ 
        .tab-button {
            padding: 6px 20px;
            font-size: 16px;
            cursor: pointer;
            border: 2px solid transparent;
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
            margin: 0 10px;
            border-radius: 5px;
            transition: 0.3s;
            position: relative;
        }

        /* Estilo do bot√£o selecionado */
        .tab-button.selected {
            background-color: #228B22;
            border: 2px solid black;
        }

        /* Linha inferior do bot√£o selecionado */
        .tab-button.selected::after {
            content: "";
            display: block;
            width: 100%;
            height: 3px;
            background-color: #228B22;
            position: absolute;
            bottom: -8px;
            left: 0;
        }

        /* Estilo do container do formul√°rio */
        .form-container {
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
            width: 400px;
            text-align: center;
            margin-top: 10px;
        }
		
		.form-container h2 {
			margin-top: 0px; /* Remove o margin-top padr√£o do h2 */
		}

        /* Estilo dos grupos de campos do formul√°rio */
        .form-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            width: 100%;
        }

        /* Estilo dos r√≥tulos dos campos */
        label {
            flex: 1;
            text-align: left;
            min-width: 100px;
        }

        /* Estilo dos campos de entrada */
        input, select {
    flex: 3;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 3px;
    text-align: left;
    width: 100%; /* Garante que todos os campos tenham a mesma largura */
    box-sizing: border-box; /* Inclui padding e borda na largura total */
}

        /* Estilo do bot√£o de a√ß√£o */
        button {
            margin-top: 1px;
            width: 100%;
            padding: 8px 10px;
            background-color: #4CAF50;
            color: white;
			font-size: 16px; /* Ajuste o tamanho da fonte se necess√°rio */
            font-weight: bold;
            border: none;
            cursor: pointer;
            border-radius: 3px;
        }

        /* Estilo da tabela de jogadores */
        table {
            width: 99%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        /* Estilo das c√©lulas da tabela */ 
        th, td {
            border: 1px solid #ccc;
            padding: 7px;
            text-align: center;
        }

        /* Estilo do cabe√ßalho da tabela */
        th {
            background-color: #f2f2f2;
        }

      

/* Estilos responsivos para telas menores */
@media (max-width: 480px) {

.form-group label {
    vertical-align: middle; /* Alinhamento vertical para o meio */
    line-height: 30px;    /* Ajuste a altura da linha conforme necess√°rio */
    padding: 1px 0;       /* Adicione espa√ßamento superior e inferior */
  }

  .form-group input, .form-group select {
    vertical-align: middle; /* Alinhamento vertical para o meio */
  }
    .form-container {
        width: 85%; /* Ajusta a largura para ocupar at√© 90% da tela */
        max-width: 350px; /* Define um limite m√°ximo */
		margin-top: px;
	    }
    .form-group {
        position: relative;
        width: 100%;
		align-items: flex-start;
    }

    input, select {
        width: 100%; /* Garante que os campos ocupem 100% da largura dispon√≠vel */
        margin-left: 0; /* Remove o ajuste negativo */
        max-width: none; /* Remove o limite de largura */
    }

  label[for="niver"] {
    line-height: 1.1; /* Ajuste o valor conforme necess√°rio */
  }
  
  #classe {
        width: 139px !important;/* Reduz a largura do campo "Escolha a Classe" */
        margin-right: 10px; /* Ajusta a margem √† direita */
    }
  
   #piramide {
        margin-left: -5px !important; /* Ajuste a posi√ß√£o para a esquerda */
		width: 30px !important;
    }

    #simbolo_piramide {
        margin-left: -18px !important; /* Move ainda mais para a esquerda */
		align-items: center; /* Centraliza verticalmente */
    }
	
	  #filtrarPiramide {
        margin-left: 3px !important; /* Remove a margem √† esquerda */
        margin-top: 5px; /* Adiciona um espa√ßamento acima */
    }

}

        /* Estilo da tela de carregamento */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            z-index: 1000;
        }

        /* Estilo do rodap√© fixo com efeito de profundidade */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #f2f2f2; /* Cor cinza igual ao cabe√ßalho da tabela */
            color: #333; /* Cor do texto escura para contraste */
            text-align: center;
            padding: 10px 0;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0px -2px 10px rgba(0, 0, 0, 0.2); /* Efeito de profundidade */
            z-index: 1000;
        }/* Estiliza o select da classe */
#classe {
    width: 200px;
    margin-right: 110px;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 3px;
}



/* Estiliza o s√≠mbolo da pir√¢mide */
#simbolo_piramide {
    font-size: 24px; /* Aumenta o tamanho do s√≠mbolo */
    color: black;
    margin-left: 5px;
    display: flex;
    align-items: center; /* Centraliza verticalmente */
    justify-content: center;
    height: 100%; /* Faz com que ocupe toda a altura dispon√≠vel */
}

/* Classe para a pir√¢mide vermelha */
.piramide-vermelha {
    color: red; /* Cor vermelha */
}

/* Classe para a pir√¢mide preta */
.piramide-preta {
    color: black; /* Cor preta */
}

.piramide-clicada {
    color: blue !important; /* Muda a cor para azul */
    font-weight: bold;
    transform: scale(1.3) rotate(0deg); /* Aumenta e gira levemente */
    text-shadow: 2px 2px 8px rgba(0, 0, 255, 0.6); /* Brilho azul */
    transition: transform 0.2s ease-in-out, text-shadow 0.3s ease-in-out; 
}


		
		
		
    </style>
</head>
<body>
    <!-- Tela de carregamento -->
    <div id="loadingOverlay" class="loading-overlay"> 
        Carregando... Aguarde.
    </div>

    <!-- Container das abas -->
    <div class="tab-container">
        <button class="tab-button selected" onclick="mostrarCadastro(event)">Cadastro</button>
        <button class="tab-button" onclick="mostrarConsulta(event)">Consulta</button>
    </div>

    <!-- Container do formul√°rio -->
    <div class="form-container">
        <h2 id="titulo">Cadastro de Jogadores</h2>
        <div class="form-group">
            <label for="nome">Nome:</label>
            <input type="text" id="nome" placeholder="Digite o nome" required>
        </div>
        <div class="form-group">
            <label for="apelido">Apelido:</label>
            <input type="text" id="apelido" placeholder="Digite o apelido" required>
        </div>
		
		<div class="form-group">
            <label for="niver">Data de Nascimento:</label>
            <input type="date" id="niver">
        </div>
        <div class="form-group">
            <label for="socio">S√≥cio:</label>
            <select id="socio">
                <option value="" selected disabled>Escolha um tipo</option>
				<option value="titular">Titular</option>
                <option value="dependente">Dependente</option>
            </select>
        </div>
		
		
        <div class="form-group">
			<label for="classe">Classe:</label>
			<select id="classe" style="width: 200px; margin-right: 20px;">
				<option value="" selected disabled>Escolha a Classe</option>
				<option value="A">A</option>
				<option value="B">B</option>
				<option value="C">C</option>
				<option value="">(Sem classe)</option>
			</select>
			<span id="simbolo_piramide" style="margin-left: 10px; margin-right: 10px;">üî∫</span>
			<input type="text" id="piramide" maxlength="2" style="width: 40px; height: 35px; text-align: center; margin-left: 10px; font-size: 16px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;" value="">
			<input type="checkbox" id="filtrarPiramide" style="margin-left: 10px;"> 
		</div>



		
		
        <button id="botaoAcao" onclick="acaoFormulario()">Cadastrar</button>
		
    </div>

    <!-- Tabela de jogadores -->
    <table>
        <thead>
            <tr>
                <th>Nome</th>
                <th>Apelido</th>
				<th>S√≥cio</th>
            </tr>
        </thead>
        <tbody id="tabela-jogadores"></tbody>
    </table> 

    <!-- Rodap√© fixo com o total de jogadores -->
    <div class="footer" id="footer">
        Total de Jogadores: <span id="totalJogadores">0</span>
    </div>

    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "agenda-5ce95.firebaseapp.com",
            databaseURL: "https://agenda-5ce95-default-rtdb.firebaseio.com/",
            projectId: "agenda-5ce95",
            storageBucket: "agenda-5ce95.appspot.com",
            messagingSenderId: "852007565195",
            appId: "1:852007565195:web:d7bd789d140858f53f618e"
        };

        // Inicializa√ß√£o do Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        let modoCadastro = true; // Vari√°vel para alternar entre cadastro e consulta

        // Fun√ß√£o para atualizar o total de jogadores exibidos
        function atualizarTotalJogadores() {
            const totalJogadores = document.getElementById("tabela-jogadores").children.length;
            document.getElementById("totalJogadores").textContent = totalJogadores;
        }

 function acaoFormulario() {
    if (document.getElementById("botaoAcao").textContent === "Salvar") {
        salvarJogador();
    } else if (modoCadastro) {
        cadastrarJogador();
    } else {
        consultarJogador();
    }
}

		

let placeholderSpan = null; // Torna a vari√°vel global para manipular depois

function isMobile() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

if (isMobile()) {
    const niverInput = document.getElementById("niver");
    const niverLabel = document.querySelector('label[for="niver"]');

    placeholderSpan = document.createElement("span");
    placeholderSpan.textContent = "dd/mm/aaaa";
    placeholderSpan.style.color = "#999";
    placeholderSpan.style.position = "absolute";
    placeholderSpan.style.left = niverLabel.offsetWidth + 10 + "px";
    placeholderSpan.style.top = "8px";
    placeholderSpan.style.pointerEvents = "none";

    niverInput.parentNode.insertBefore(placeholderSpan, niverInput.nextSibling);

    niverInput.addEventListener("focus", () => placeholderSpan.style.display = "none");
    niverInput.addEventListener("blur", () => {
        if (niverInput.value === "") {
            placeholderSpan.style.display = "inline";
        }
    });
}


function cadastrarJogador() {
    const nome = document.getElementById("nome").value.trim().toUpperCase();
    let apelido = document.getElementById("apelido").value.trim();
    const socio = document.getElementById("socio").value;
    const classe = document.getElementById("classe").value;
    let niver = document.getElementById("niver").value;
    const piramide = document.getElementById("piramide").value.trim(); // Remove espa√ßos em branco

    // Valida√ß√£o dos campos
    if (nome === "" || apelido === "" || niver === "") {
        alert("Preencha todos os campos obrigat√≥rios.");
        return;
    }

    // Converte a data para o formato DD/MM/YYYY para salvar depois
    const partesData = niver.split("-");
    if (partesData.length === 3) {
        niver = `${partesData[2]}/${partesData[1]}/${partesData[0]}`;
    }

    // Valida√ß√£o adicional para o nome
    if (!/^[A-Z\s]+$/.test(nome)) {
        alert("O nome deve conter apenas letras e espa√ßos.");
        return;
    }

    // Valida√ß√£o para o campo S√≥cio
    if (socio === "") {
        alert("Escolha um tipo de s√≥cio.");
        return;
    }

    // Valida√ß√£o para o campo Classe
    if (classe === "" && document.getElementById("classe").selectedIndex === 0) {
        alert("Escolha uma classe ou selecione '(Sem classe)'");
        return;
    }

    // Formata o apelido para ter a primeira letra mai√∫scula
    apelido = apelido.toLowerCase().replace(/\b\w/g, letra => letra.toUpperCase());

    // Determina o valor de piramide
    const piramideValue = piramide.trim() === "" ? "" : piramide;

    const jogadorRef = database.ref("sistemas/cadastro/jogadores/" + nome);
    const apelidoRef = database.ref("sistemas/cadastro/apelidos/" + apelido);

    // Novo c√°lculo correto de idade
    const ano = parseInt(partesData[0]);
    const mes = parseInt(partesData[1]) - 1; // Meses come√ßam do 0
    const dia = parseInt(partesData[2]);
    const dataNascimento = new Date(ano, mes, dia);

    const hoje = new Date();
    let idade = hoje.getFullYear() - dataNascimento.getFullYear();

    if (
        hoje.getMonth() < dataNascimento.getMonth() ||
        (hoje.getMonth() === dataNascimento.getMonth() && hoje.getDate() < dataNascimento.getDate())
    ) {
        idade--;
    }

    if (idade > 21 && socio === "dependente") {
        const relacionamento = prompt("Dependente maior de 21 anos. √â c√¥njuge ou filho(a)?").trim().toLowerCase();
        const conjugeAceito = ["conjuge", "c√¥njuge", "esposa", "esposo", "marido"].includes(relacionamento);

        if (conjugeAceito) {
            // Cadastro prossegue normalmente
        } else {
            alert("N√£o √© poss√≠vel cadastrar filho(a) maior de 21 anos como dependente.");
            limparCampos();
            return;
        }
    }

    // Agora segue o cadastro normalmente
    jogadorRef.get().then(snapshot => {
        if (snapshot.exists()) {
            alert("J√° existe um jogador com esse Nome.");
            limparCampos();
            return;
        }

        apelidoRef.get().then(snapshot => {
            if (snapshot.exists()) {
                alert("J√° existe um jogador com esse Apelido.");
                limparCampos();
            } else {
                jogadorRef.set({ apelido, socio, classe, niver, piramide: piramideValue })
                    .then(() => {
                        apelidoRef.set(true)
                            .then(() => {
                                alert("Jogador cadastrado com sucesso!");
                                limparCampos();
                                carregarJogadores();
                            })
                            .catch(error => {
                                console.error("Erro ao salvar apelido:", error);
                                alert("Ocorreu um erro ao cadastrar o jogador. Tente novamente.");
                            });
                    })
                    .catch(error => {
                        console.error("Erro ao cadastrar jogador:", error);
                        alert("Ocorreu um erro ao cadastrar o jogador. Tente novamente.");
                    });
            }
        }).catch(error => {
            console.error("Erro ao verificar apelido:", error);
            alert("Ocorreu um erro ao verificar o apelido. Tente novamente.");
        });
    }).catch(error => {
        console.error("Erro ao verificar jogador:", error);
        alert("Ocorreu um erro ao verificar o jogador. Tente novamente.");
    });
}


// Fun√ß√£o para limpar os campos do formul√°rio
function limparCampos() {
    document.getElementById("nome").value = "";
    document.getElementById("apelido").value = "";
    document.getElementById("niver").value = "";
    document.getElementById("socio").value = "";
    document.getElementById("classe").value = "";
    document.getElementById("piramide").value = "";


    // Reativa o campo Nome e remove o efeito visual
    const nomeInput = document.getElementById("nome");
    nomeInput.disabled = false;
    nomeInput.style.backgroundColor = ""; // Volta ao padr√£o
    nomeInput.style.border = ""; // Volta ao padr√£o
}



let criteriosConsulta = {
    nome: "",
    apelido: "",
    socio: "",
    classe: "",
    niver: ""
};


// Fun√ß√£o para consultar jogadores
function consultarJogador() {
    // Atualiza os crit√©rios de consulta com os valores atuais dos campos
    criteriosConsulta.nome = document.getElementById("nome").value.trim().toUpperCase();
    criteriosConsulta.apelido = document.getElementById("apelido").value.trim().toLowerCase();
    criteriosConsulta.socio = document.getElementById("socio").value;
    const classeSelect = document.getElementById("classe");
    criteriosConsulta.classe = classeSelect.value;
    criteriosConsulta.niver = document.getElementById("niver").value;
    let piramide = document.getElementById("piramide").value.trim();
    const filtrarPiramide = document.getElementById("filtrarPiramide").checked;
    const simboloPiramide = document.getElementById("simbolo_piramide");
    const piramideAtivada = simboloPiramide.classList.contains("piramide-clicada");

    console.log("Crit√©rios de consulta:", criteriosConsulta);
    console.log("Valor de piramide:", piramide);
    console.log("Filtrar por piramide?", filtrarPiramide);
    console.log("Pir√¢mide ativada pelo clique?", piramideAtivada);

    const todosCamposVazios =
        criteriosConsulta.nome === "" &&
        criteriosConsulta.apelido === "" &&
        criteriosConsulta.socio === "" &&
        criteriosConsulta.classe === "" &&
        criteriosConsulta.niver === "" &&
        piramide === "" &&
        !filtrarPiramide &&
        !piramideAtivada;

    if (todosCamposVazios) {
        alert("Digite pelo menos um crit√©rio para consulta.");
        return;
    }

    const tabela = document.getElementById("tabela-jogadores");
    tabela.innerHTML = "";

    database.ref("sistemas/cadastro/jogadores").once("value", snapshot => {
        let encontrado = false;

        snapshot.forEach(childSnapshot => {
            const jogadorNome = childSnapshot.key;
            const jogador = childSnapshot.val();

            if (jogadorNome.toUpperCase() === "CONVIDADO") {
                return;
            }

            const jogadorApelido = jogador.apelido.toLowerCase();
            const jogadorSocio = jogador.socio;
            const jogadorClasse = jogador.classe || ""; // Garante que seja string
            const jogadorNiver = jogador.niver || "";
            const jogadorPiramide = jogador.piramide || "";

            console.log("Jogador:", jogadorNome, "Piramide:", jogadorPiramide);

            const filtroNome = criteriosConsulta.nome === "" || jogadorNome.includes(criteriosConsulta.nome);
            const filtroApelido = criteriosConsulta.apelido === "" || jogadorApelido.includes(criteriosConsulta.apelido);

            // Modifica√ß√µes importantes aqui:
            let filtroSocio = true;
            if (criteriosConsulta.socio !== "" && criteriosConsulta.socio !== "todos") {
                filtroSocio = jogadorSocio === criteriosConsulta.socio;
            }

            let filtroClasse = true;
            if (criteriosConsulta.classe === "todos") {
                // Se "Todos" foi selecionado, n√£o filtre por classe
            } else if (criteriosConsulta.classe === "") {
                // Se "Sem classe" foi selecionado, filtre por classe vazia
                filtroClasse = jogadorClasse === "";
            } else {
                // Se uma classe espec√≠fica foi selecionada, filtre por ela
                filtroClasse = jogadorClasse === criteriosConsulta.classe;
            }

            const filtroNiver = criteriosConsulta.niver === "" || jogadorNiver === criteriosConsulta.niver;

            let filtroPiramide = true;
            if (piramideAtivada && filtrarPiramide) {
                filtroPiramide = (jogadorPiramide === piramide) && (jogadorPiramide >= 1 && jogadorPiramide <= 99);
            } else if (piramideAtivada) {
                filtroPiramide = jogadorPiramide >= 1 && jogadorPiramide <= 99;
            } else if (filtrarPiramide) {
                filtroPiramide = piramide === "" ? jogadorPiramide === "" : jogadorPiramide === piramide;
            }

            console.log("Filtros aplicados:", {
                nome: filtroNome,
                apelido: filtroApelido,
                socio: filtroSocio,
                classe: filtroClasse,
                niver: filtroNiver,
                piramide: filtroPiramide
            });

            if (filtroNome && filtroApelido && filtroSocio && filtroClasse && filtroNiver && filtroPiramide) {
                encontrado = true;

                console.log("Jogador encontrado:", jogadorNome, "Piramide:", jogadorPiramide);

                const row = document.createElement("tr");
                row.innerHTML = `
                    <td style="text-align: left;">${jogadorNome}</td>
                    <td style="text-align: left;">${jogadorApelido.replace(/\b\w/g, letra => letra.toUpperCase())}</td>
                    <td style="text-align: center;">${jogadorSocio}</td>
                `;

                let clickTimeout;
                let isDoubleClick = false;

                row.addEventListener("click", (event) => {
                    clickTimeout = setTimeout(() => {
                        if (!isDoubleClick) {
                            excluirJogador(jogadorNome, jogador.apelido);
                        }
                    }, 300);
                });

                row.addEventListener("dblclick", (event) => {
                    isDoubleClick = true;
                    clearTimeout(clickTimeout);
                    editarJogador(jogadorNome);
                    setTimeout(() => { isDoubleClick = false; }, 350);
                });

                tabela.appendChild(row);
            }
        });

        if (!encontrado) {
            alert("Nenhum jogador encontrado.");
        }

        atualizarTotalJogadores();
    }).catch(error => {
        console.error("Erro ao consultar jogadores:", error);
        alert("Ocorreu um erro ao consultar os jogadores. Tente novamente.");
    });
}



function editarJogador(nome) {
    const jogadorRef = database.ref("sistemas/cadastro/jogadores/" + nome);

    jogadorRef.once("value").then((snapshot) => {
        if (snapshot.exists()) {
            const jogador = snapshot.val();

            // Preenche os campos do formul√°rio com os dados do jogador
            document.getElementById("nome").value = nome;
            document.getElementById("apelido").value = jogador.apelido;
            document.getElementById("socio").value = jogador.socio || "";
            document.getElementById("classe").value = jogador.classe || "";

            // Preenche o campo de data de nascimento
            const niverInput = document.getElementById("niver");
            if (jogador.niver) {
                niverInput.value = jogador.niver.split("/").reverse().join("-");
                if (placeholderSpan) placeholderSpan.style.display = "none"; // Esconde o placeholder
            } else {
                niverInput.value = "";
                if (placeholderSpan) placeholderSpan.style.display = "inline"; // Mostra o placeholder
            }

            // Preenche o campo de piramide com o valor correto
            const piramideInput = document.getElementById("piramide");
            piramideInput.value = jogador.piramide || ""; // Se n√£o houver valor, mant√©m vazio
            
            // Habilita o campo piramide ao editar
            piramideInput.disabled = false; 

            // Desabilita o campo de nome e aplica estilo visual
            const nomeInput = document.getElementById("nome");
            nomeInput.disabled = true;
            nomeInput.style.backgroundColor = "#e0e0e0";
            nomeInput.style.border = "2px solid #888";

            // Atualiza o texto do bot√£o para "Salvar"
            document.getElementById("botaoAcao").textContent = "Salvar";
            modoCadastro = false; // Altera o modo para edi√ß√£o
        } else {
            alert("Jogador n√£o encontrado.");
        }
    }).catch((error) => {
        console.error("Erro ao carregar jogador:", error);
    });
}





function salvarJogador() {
    const nome = document.getElementById("nome").value.trim().toUpperCase();
    let apelido = document.getElementById("apelido").value.trim();
    const socio = document.getElementById("socio").value;
    const classe = document.getElementById("classe").value;
    let niver = document.getElementById("niver").value;
    const piramideInput = document.getElementById("piramide");
    const filtrarPiramideCheckbox = document.getElementById("filtrarPiramide");
    const piramide = piramideInput.value.trim(); // Remove espa√ßos em branco

    console.log("Modo de cadastro:", modoCadastro);
    console.log("Dados do jogador a serem salvos:", { nome, apelido, socio, classe, niver, piramide });

    if (modoCadastro) {
        // Valida√ß√£o completa para novo cadastro (todos obrigat√≥rios)
        if (nome === "" || apelido === "" || socio === "" || classe === "" || niver === "") {
            alert("Preencha todos os campos obrigat√≥rios.");
            return;
        }
    } else {
        // Valida√ß√£o no modo edi√ß√£o (apenas nome obrigat√≥rio)
        if (nome === "") {
            alert("O nome √© obrigat√≥rio.");
            return;
        }
    }

    // Formatar data apenas se estiver preenchida
    if (niver) {
        const partesData = niver.split("-");
        niver = `${partesData[2]}/${partesData[1]}/${partesData[0]}`;

        // Calcula a idade
        const dataNascimento = new Date(partesData[2], partesData[1] - 1, partesData[0]);
        const hoje = new Date();
        let idade = hoje.getFullYear() - dataNascimento.getFullYear();
        const m = hoje.getMonth() - dataNascimento.getMonth();
        if (m < 0 || (m === 0 && hoje.getDate() < dataNascimento.getDate())) {
            idade--;
        }

        if (idade > 21 && socio === "dependente") {
            const relacionamento = prompt("Dependente maior de 21 anos. √â c√¥njuge, esposo(a) ou filho(a)?").trim().toLowerCase();
            const conjugeAceito = ["conjuge", "c√¥njuge", "esposa", "esposo", "marido"].includes(relacionamento);

            if (!conjugeAceito) {
                alert("N√£o √© poss√≠vel cadastrar filho(a) maior de 21 anos como dependente.");
                return; // Impede o salvamento
            }
        }
    } else {
        niver = ""; // Se n√£o informado, salva como vazio
    }

    // Formata o apelido para ter a primeira letra mai√∫scula
    apelido = apelido.toLowerCase().replace(/\b\w/g, letra => letra.toUpperCase());

    // Determina o valor de piramide (remove espa√ßos e garante que seja uma string vazia se n√£o houver valor)
    const piramideValue = piramide.trim() === "" ? "" : piramide;

    // Exibe uma mensagem de confirma√ß√£o com todos os dados do jogador
    let mensagemConfirmacao = `
        Confirme os dados do jogador:
        Nome: ${nome}
        Apelido: ${apelido}
        S√≥cio: ${socio}
        Classe: ${classe || "(Sem classe)"}
        Data de Nascimento: ${niver || "(N√£o informada)"}
        Pir√¢mide: ${piramideValue || "(N√£o informada)"}
    `;

    // Adiciona informa√ß√£o sobre o modo de opera√ß√£o
    mensagemConfirmacao += `\n\nModo de opera√ß√£o: ${modoCadastro ? "Cadastro" : "Edi√ß√£o"}`;

    const confirmacao = confirm(mensagemConfirmacao);
    if (!confirmacao) {
        return; // Cancela a opera√ß√£o se o usu√°rio n√£o confirmar
    }

    const jogadorRef = database.ref("sistemas/cadastro/jogadores/" + nome);

    // Armazena os crit√©rios de consulta originais antes de salvar
    const criteriosOriginais = { ...criteriosConsulta };

    jogadorRef.update({
        apelido: apelido || "",   // Se vazio, salva como string vazia
        socio: socio || "",        // Se vazio, salva como string vazia
        classe: classe || "",      // Se vazio, salva como string vazia
        niver: niver,               // Data j√° tratada
        piramide: piramideValue     // Pir√¢mide j√° tratada
    }).then(() => {
        console.log("Jogador atualizado com sucesso!");
        alert("Jogador atualizado com sucesso!");

        // Limpa os campos do formul√°rio
        limparCampos();

        // Desabilita o campo piramide ap√≥s salvar
        piramideInput.disabled = true;

        // Se o checkbox estiver marcado, desmarca ao salvar
        filtrarPiramideCheckbox.checked = false;

        // Reaplica os crit√©rios de consulta originais e refaz a consulta
        if (!modoCadastro && (criteriosOriginais.nome || criteriosOriginais.apelido || criteriosOriginais.socio ||
                      criteriosOriginais.classe || criteriosOriginais.niver || criteriosOriginais.piramide)) {
            console.log("Reexecutando consulta ap√≥s salvar...");
            criteriosConsulta = { ...criteriosOriginais };

            document.getElementById("nome").value = criteriosConsulta.nome;
            document.getElementById("apelido").value = criteriosConsulta.apelido;
            document.getElementById("socio").value = criteriosConsulta.socio;
            document.getElementById("classe").value = criteriosConsulta.classe || "";
            document.getElementById("niver").value = criteriosConsulta.niver;
            document.getElementById("piramide").value = criteriosConsulta.piramide || "";

            consultarJogador();
        } else {
            carregarJogadores();
        }

        // Atualiza texto do bot√£o conforme aba atual
        const abaAtual = document.querySelector(".tab-button.selected").textContent;
        if (abaAtual === "Cadastro") {
            document.getElementById("botaoAcao").textContent = "Cadastrar";
            modoCadastro = true;
        } else {
            document.getElementById("botaoAcao").textContent = "Consultar";
            modoCadastro = false;
        }
    }).catch((error) => {
        console.error("Erro ao atualizar jogador:", error);
        alert("Ocorreu um erro ao atualizar o jogador.");
    });
}



// Fun√ß√£o para carregar todos os jogadores na tabela
function carregarJogadores() {
    const tabela = document.getElementById("tabela-jogadores");

    database.ref("sistemas/cadastro/jogadores").on("value", (snapshot) => {
        tabela.innerHTML = ""; // Limpa a tabela antes de adicionar novos registros
        snapshot.forEach((childSnapshot) => {
            const nome = childSnapshot.key; // O nome √© a chave
            const jogador = childSnapshot.val();

            // Ignora o jogador "Convidado"
            if (nome.toUpperCase() === "CONVIDADO") {
                return;
            }

            // Cria uma nova linha na tabela
            const row = document.createElement("tr");
            row.innerHTML = `
                <td style="text-align: left;">${nome}</td>
                <td style="text-align: left;">${jogador.apelido}</td>
                <td style="text-align: center;">${jogador.socio}</td>
            `;

            let clickTimeout;
            let isDoubleClick = false;

            // Evento de clique para excluir
            row.addEventListener("click", (event) => {
                console.log(`Clique simples detectado em: ${nome}`);
                clickTimeout = setTimeout(() => {
                    if (!isDoubleClick) {
                        console.log(`Excluindo jogador: ${nome}`);
                        excluirJogador(nome, jogador.apelido);
                    }
                }, 300);
            });

            // Evento de duplo clique para editar
            row.addEventListener("dblclick", (event) => {
                console.log(`Duplo clique detectado em: ${nome}`);
                isDoubleClick = true;
                clearTimeout(clickTimeout); // Cancela o clique simples
                editarJogador(nome);
                setTimeout(() => { isDoubleClick = false; }, 350); // Reseta a vari√°vel ap√≥s o tempo limite
            });

            // Adiciona a linha na tabela
            tabela.appendChild(row);
        });

        // Atualiza o total de jogadores exibidos
        atualizarTotalJogadores();

        // Esconde a tela de carregamento ap√≥s carregar os dados
        document.getElementById("loadingOverlay").style.display = "none";
    });
}



function excluirJogador(nome, apelido) {
            // Confirma√ß√£o antes de excluir
            const confirmacao = confirm(`Tem certeza que deseja excluir o jogador ${nome} (${apelido})?`);
            if (!confirmacao) return;

            // Refer√™ncia ao jogador e ao apelido no banco de dados
            const jogadorRef = database.ref("sistemas/cadastro/jogadores/" + nome);
            const apelidoRef = database.ref("sistemas/cadastro/apelidos/" + apelido);

            // Remove o jogador e o apelido
            jogadorRef.remove()
                .then(() => {
                    apelidoRef.remove()
                        .then(() => {
                            alert("Jogador exclu√≠do com sucesso!");
                            carregarJogadores(); // Atualiza a tabela ap√≥s a exclus√£o
                        })
                        .catch(error => {
                            console.error("Erro ao excluir apelido:", error);
                            alert("Ocorreu um erro ao excluir o apelido. Tente novamente.");
                        });
                })
                .catch(error => { 
                    console.error("Erro ao excluir jogador:", error);
                    alert("Ocorreu um erro ao excluir o jogador. Tente novamente.");
                });
        }


// Fun√ß√£o para mostrar a aba de cadastro
function mostrarCadastro(event) {
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('selected'));
    event.target.classList.add('selected');

    atualizarAba("Cadastro de Jogadores", "Cadastrar");

    modoCadastro = true;
	
	// Habilita o campo piramide ao clicar no bot√£o Cadastro
    const piramideInput = document.getElementById("piramide");
    piramideInput.disabled = false;

    // Desmarca o checkbox "filtrarPiramide"
    document.getElementById("filtrarPiramide").checked = false;

    // Zera os crit√©rios da consulta para evitar exibi√ß√£o filtrada
    criteriosConsulta = {
        nome: "",
        apelido: "",
        socio: "",
        classe: "",
        niver: "",
        piramide: "" // Reseta crit√©rio da pir√¢mide
    };

    limparCampos();
    carregarJogadores(); // Agora carregar√° todos os jogadores corretamente
	
	// Remover a op√ß√£o "Todos" se existir
    const socioSelect = document.getElementById("socio");
    let todosOption = socioSelect.querySelector('option[value="todos"]');
    if (todosOption) {
        socioSelect.removeChild(todosOption);
    }
	
	// Remover a op√ß√£o "Todos" se existir
    const classeSelect = document.getElementById("classe");
    let classeOption = classeSelect.querySelector('option[value="todos"]');
    if (classeOption) {
        classeSelect.removeChild(classeOption);
    }
	

    // Atualiza o s√≠mbolo da pir√¢mide para vermelho üî∫
    const simboloPiramide = document.getElementById("simbolo_piramide");
    if (simboloPiramide) {
        simboloPiramide.textContent = "üî∫"; // Pir√¢mide vermelha
        simboloPiramide.dataset.cor = "vermelho"; // Armazena a cor atual
        simboloPiramide.classList.remove("piramide-clicada"); // Remove o estado clicado
        console.log("Pir√¢mide na aba Cadastro (vermelha)");
    }

    // Remove o evento de clique da pir√¢mide
    simboloPiramide.removeEventListener("click", alternarCorPiramide);
    document.getElementById("simbolo_piramide").style.cursor = "default";
}

// Fun√ß√£o para mostrar a aba de consulta
function mostrarConsulta(event) {
    atualizarAba("Consulta de Jogadores", "Consultar");
    modoCadastro = false;

    // Desmarca o checkbox "filtrarPiramide"
    document.getElementById("filtrarPiramide").checked = false;

    // Zera os crit√©rios da consulta para evitar exibi√ß√£o filtrada
    criteriosConsulta = {
        nome: "",
        apelido: "",
        socio: "",
        classe: "",
        niver: "",
        piramide: "" // Reseta crit√©rio da pir√¢mide
    };

    limparCampos(); // Limpa os campos ao mudar para a aba Consulta
    carregarJogadores(); // Adiciona os eventos de clique para exclus√£o na aba Consulta
	
	// Adicionar a op√ß√£o "Todos" se n√£o existir
    const socioSelect = document.getElementById("socio");
    let todosOption = socioSelect.querySelector('option[value="todos"]');

    if (!todosOption) {
        todosOption = document.createElement("option");
        todosOption.value = "todos";
        todosOption.textContent = "Todos";
        // Insere "Todos" ap√≥s a primeira op√ß√£o (Escolha um tipo)
        socioSelect.insertBefore(todosOption, socioSelect.options[1]);
    }
	
	// Seleciona a op√ß√£o "Todos"
    socioSelect.value = "todos";  // Adicione esta linha!
	
	// Adicionar a op√ß√£o "Todos" se n√£o existir
    const classeSelect = document.getElementById("classe");
    let classeOption = classeSelect.querySelector('option[value="todos"]');

    if (!classeOption) {
        classeOption = document.createElement("option");
        classeOption.value = "todos";
        classeOption.textContent = "Todos";
        // Insere "Todos" ap√≥s a primeira op√ß√£o (Escolha um tipo)
        classeSelect.insertBefore(classeOption, classeSelect.options[1]);
    }
	
	// Seleciona a op√ß√£o "Todos"
    classeSelect.value = "todos";  // Adicione esta linha!

    // Mant√©m a pir√¢mide vermelha ao entrar na tela de consulta
    const simboloPiramide = document.getElementById("simbolo_piramide");
    if (simboloPiramide) {
        simboloPiramide.textContent = "üî∫"; // Pir√¢mide vermelha
        simboloPiramide.dataset.cor = "vermelho"; // Armazena a cor atual
        simboloPiramide.classList.remove("piramide-clicada"); // Remove o estado clicado
        console.log("Pir√¢mide na aba Consulta (vermelha)");
    }

    // Adiciona o evento de clique na pir√¢mide para alternar entre vermelho e preto
    simboloPiramide.addEventListener("click", alternarCorPiramide);
    document.getElementById("simbolo_piramide").style.cursor = "pointer";
}


function alternarCorPiramide() {
    const simboloPiramide = document.getElementById("simbolo_piramide");

    if (simboloPiramide) {
        simboloPiramide.classList.toggle("piramide-clicada"); // Alterna o estado visual
        console.log("Crit√©rio de pir√¢mide alterado:", simboloPiramide.classList.contains("piramide-clicada"));
    }
}




        // Fun√ß√£o para atualizar a aba selecionada
        function atualizarAba(titulo, textoBotao) { 
            document.getElementById("titulo").textContent = titulo;
            document.getElementById("botaoAcao").textContent = textoBotao;
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        // Carrega os jogadores ao carregar a p√°gina
        window.onload = function() {
            carregarJogadores();
        };
		
document.addEventListener("DOMContentLoaded", function () {
        const piramideInput = document.getElementById("piramide");
        const filtrarPiramideCheckbox = document.getElementById("filtrarPiramide");
        const cadastroTab = document.querySelector(".tab-button:nth-child(1)"); // Aba Cadastro
        const consultaTab = document.querySelector(".tab-button:nth-child(2)"); // Aba Consulta

        // Garante que o campo piramide e o checkbox come√ßam desativados na aba Cadastro
        function configurarCadastro() {
            //piramideInput.disabled = true;
            piramideInput.value = ""; // Limpa o campo ao mudar para Cadastro
            filtrarPiramideCheckbox.checked = false;
            filtrarPiramideCheckbox.disabled = true; // Desabilita o checkbox na aba Cadastro
        }

        // Quando o checkbox for marcado, habilita o campo e coloca o foco nele
        filtrarPiramideCheckbox.addEventListener("change", function () {
            if (this.checked) {
                piramideInput.disabled = false;
                piramideInput.focus(); // Coloca o foco no campo
            } else {
                piramideInput.value = ""; // Limpa o campo antes de desabilitar
                piramideInput.disabled = true;
            }
        });

        // Selecione a aba Cadastro ao carregar a p√°gina e configure os campos
        configurarCadastro();

        // Evento ao clicar na aba Cadastro
        cadastroTab.addEventListener("click", function () {
            configurarCadastro();
        });

        // Evento ao clicar na aba Consulta
        consultaTab.addEventListener("click", function () {
            piramideInput.disabled = true;
            piramideInput.value = ""; // Limpa o campo ao mudar para Consulta
            filtrarPiramideCheckbox.checked = false;
            filtrarPiramideCheckbox.disabled = false; // Habilita o checkbox na aba Consulta
        });
    });
	


	
    </script>
</body>
</html>
