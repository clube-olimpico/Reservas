<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Reservas Exclu√≠das</title>
    <style>
        body {
            font-family: Arial, sans-serif;  
            margin: 0;
            padding: 10px;
            background-color: #f4f4f4;  
        }

        h1 {
            text-align: center; 
            font-size: 22px;
        }

        .filters {
            display: grid;  
            grid-template-columns: 120px 1fr;    
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            position: relative;
        }

        .filters label {
            font-size: 16px;
            font-weight: bold; 
            text-align: left;  
        }

        .filters input,
        .filters select,
        .filters button {
            font-size: 16px;
            padding: 8px;
            box-sizing: border-box;  
        }

        .filters input,
        .filters select {
            justify-self: end;
            width: calc(100% - 10px);
        }

        .filters button {
            grid-column: 1 / 3;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        .filters button:hover {
            background-color: #0056b3;
        }

        .log-entry {
            background: white;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-size: 16px;
        }

        .log-entry p {
            margin: 5px 0;
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 20px;
            }

            .filters {
                grid-template-columns: 1fr;
            }

            .filters label,
            .filters input,
            .filters select,
            .filters button {
                width: 100%;
            }
			
			.botoes-acoes {
				flex-wrap: nowrap;
			}

			.botoes-acoes button {
				font-size: 14px !important;
				padding: 8px !important;
			}

			.botoes-acoes .pdf-button {
				font-size: 12px !important;
				padding: 6px 8px !important;
				max-width: 50px !important;
				flex: 0 0 50px !important;
			}
			
			.botoes-acoes .ordenar-button {
			font-size: 18px !important; /* maior destaque */
			font-weight: bold !important; /* negrito */
			padding: 6px 8px !important;
			max-width: 50px !important;
			flex: 0 0 50px !important;
			text-align: center;
		}

        .icone-seta {
		  font-size: 24px !important;
		  font-weight: bold !important;
		  line-height: 1;
		}

			
			
        }
		
		#total-registros-container {
			position: fixed;
			bottom: 0;
			left: 0;
			width: 100%;
			background-color: #f8f9fa; /* Cor de fundo */
			text-align: center;
			font-weight: bold;
			padding: 10px;
			border-top: 2px solid #ccc; /* Linha separadora */
		}
		
		.botoes-acoes {
			grid-column: 1 / 3;
			display: flex;
			justify-content: space-between;
			gap: 10px;
		}

		.botoes-acoes button {
			font-size: 16px;
			padding: 10px;
			font-weight: bold;
			border: none;
			cursor: pointer;
			flex: 1;
			box-sizing: border-box;
		}

		.botoes-acoes .pdf-button {
			background-color: #28a745;
			color: white;
			max-width: 100px;
			flex: none;
		}
		
		.ordenar-button {
			max-width: 140px;
			padding: 6px 10px;
			font-size: 14px;
			flex: none;
		}

/* Estilos para a tela de carregamento */

/* --- IN√çCIO DO BLOCO DE C√ìDIGO CORRIGIDO --- */

/* Estilos para o novo placar de resultado */
.placar-container {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size: 1em;
    line-height: 1.6;
    margin-top: 5px;
    /* IMPORTANTE: Limita a largura m√°xima do placar em telas grandes */
    max-width: 450px; 
}


/* COLE ESTE BLOCO DE C√ìDIGO ABAIXO DO COMENT√ÅRIO */

.loading-screen {
    position: fixed;          /* Posi√ß√£o fixa para cobrir a tela inteira */
    top: 0;
    left: 0;
    width: 100%;              /* Ocupa toda a largura */
    height: 100vh;            /* Ocupa toda a altura */
    background-color: rgba(255, 255, 255, 0.95); /* Fundo branco para cobrir o conte√∫do */
    display: flex;            /* Usa flexbox para centralizar o conte√∫do */
    flex-direction: column;   /* Empilha o spinner e o texto verticalmente */
    justify-content: center;  /* Centraliza verticalmente */
    align-items: center;      /* Centraliza horizontalmente */
    z-index: 9999;            /* Garante que fique na frente de tudo */
    font-size: 1.2em;
    color: #333;
}

.loading-spinner {
    border: 8px solid #f3f3f3; /* Cinza claro */
    border-top: 8px solid #007bff; /* Azul, para combinar com o bot√£o */
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite; /* Anima√ß√£o de rota√ß√£o */
    margin-bottom: 20px; /* Espa√ßo entre o spinner e o texto */
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}


.placar-row {
    display: flex;
    align-items: center;
    padding: 3px 0;
    border-bottom: 1px solid #f0f0f0;
}
.placar-row:last-child {
    border-bottom: none;
}
.placar-nome {
    font-weight: normal;
    /* Faz o nome ocupar o espa√ßo vago, empurrando o placar para a direita */
    flex-grow: 1; 
}
.placar-sets {
    display: flex;
    gap: 15px;
    font-weight: bold;
    /* Impede que o placar seja "espremido" em telas menores */
    flex-shrink: 0; 
}
.set-score {
    width: 25px;
    text-align: center;
    color: #888;
}
.set-score.winner {
    color: #333;
    font-weight: 900;
}
.set-score sup {
    font-size: 0.7em;
    vertical-align: super;
    margin-left: -2px;
    font-weight: normal;
}
.placar-nome.match-winner {
    font-weight: 900;
    color: #333;
}
.placar-posicao {
    font-size: 0.8em; /* Menor que o nome */
    color: #888; /* Cor mais suave */
    margin-right: 8px; /* Espa√ßamento entre a posi√ß√£o e o nome */
    width: 25px; /* Largura fixa para alinhamento */
    text-align: right; /* Alinha o n√∫mero √† direita */
    flex-shrink: 0; /* Impede que seja espremido */
}

/* --- FIM DO BLOCO DE C√ìDIGO --- */	/* Fim de Estilos para o novo placar de resultado */


/* ADICIONE ESTE BLOCO DE CSS */
.matchup-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 2px 0;
    border-bottom: 1px solid #eee;
}
.matchup-row:last-child {
    border-bottom: none;
}
.team-names {
    font-size: 1em;
    text-align: center;
    flex-basis: 40%;
}
.score-input-container {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-basis: 20%;
    justify-content: center;
}

</style>
</head>

<body>

<div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div>Carregando... Aguarde.</div>
    </div>

    <div id="conteudo" style="display: none;">
    <h1>Reservas Exclu√≠das</h1>

    <div class="filters">
        <label for="quadra">Quadra:</label>
		<select id="quadra">
			<option value="">Todas</option>
			<option value="Quadra 1 - Coberta">Quadra 1 - Coberta</option>
			<option value="Quadra 2 - Aberta">Quadra 2 - Aberta</option>
			<option value="Quadra 3 - Coberta">Quadra 3 - Coberta</option>
		</select>

        <label for="data">Data da Reserva:</label>
        <input type="date" id="data">

        <label for="jogador">Jogador:</label>
        <input type="text" id="jogador" placeholder="Digite um nome">

        <label for="duracao">Dura√ß√£o:</label>
        <select id="duracao">
            <option value="">Todas</option>
            <option value="1 Hora">1 Hora</option>
            <option value="2 Horas">2 Horas</option>
            <option value="2 Horas - Pir√¢mide">Pir√¢mide</option>
			<option value="Convidado">Convidado</option>
        </select>
		
		<label for="status">Status:</label>
		<select id="status">
			<option value="">Todas</option>
			<option value="categoria_reserva">Reserva</option>
			<option value="categoria_jogo">Jogo</option>
		</select>

        <div class="botoes-acoes">
			<button onclick="filtrarLogs()">Filtrar</button>
			<button onclick="alternarOrdenacao()" id="botaoOrdenacao" class="ordenar-button">Ordenar</button>

			<button onclick="gerarPDF()" class="pdf-button">PDF</button>
		</div>

    </div>

    <div id="logs"></div>

<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script> 
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script> 

<script>
    
// Adicione este bloco no in√≠cio do seu script
const firebaseConfig = {
    apiKey: "SUA_API_KEY",
    authDomain: "agenda-5ce95.firebaseapp.com",
    databaseURL: "https://agenda-5ce95-default-rtdb.firebaseio.com/",
    projectId: "agenda-5ce95",
    storageBucket: "agenda-5ce95.appspot.com",
    messagingSenderId: "852007565195",
    appId: "1:852007565195:web:d7bd789d140858f53f618e"
};
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();




let logs = [];
let ordemCrescente = true; // A ordem inicial √© crescente
let logsFiltrados = []; // Armazena os dados filtrados
let githubToken = ''; // Vari√°vel global para armazenar o token

	
function isMobile() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
} 



// Substitua o seu bloco fetch original por este

// --- C√ìDIGO LIMPO E DEFINITIVO (M√âTODO PADR√ÉO) ---
    showLoading();

    // Adiciona o timestamp para for√ßar o navegador a buscar a vers√£o mais recente poss√≠vel
    const url = `https://clube-olimpico.github.io/Reservas/logs/reservas-excluidas.json?t=${new Date().getTime()}`;

    fetch(url)
      .then(r => r.json())
      .then(data => {
        // Mapeia IDs para controle interno
        const allLogsWithId = data.map((log, index) => ({ ...log, id: index }));
        
        // Filtra itens exclu√≠dos na sess√£o atual
        const idsExcluidos = JSON.parse(sessionStorage.getItem('idsExcluidos')) || [];
        logs = allLogsWithId.filter(log => !idsExcluidos.includes(log.id));

        // Ordena√ß√£o: Do mais recente para o mais antigo
        logs.sort((a, b) => {
          try {
              const [dataStrA, horaStrA] = a.exclusao.split(' ');
              const [dataStrB, horaStrB] = b.exclusao.split(' ');
              // Converte para data compar√°vel
              const dataA = new Date(dataStrA.split('/').reverse().join('-') + 'T' + horaStrA);
              const dataB = new Date(dataStrB.split('/').reverse().join('-') + 'T' + horaStrB);
              return dataA - dataB; // Se quiser o mais novo em cima, inverta para: dataB - dataA
          } catch (e) {
              return 0;
          }
        });

        exibirLogs(logs);

        const botao = document.getElementById("botaoOrdenacao");
        if(botao) {
            botao.innerHTML = isMobile() ? `<span class="icone-seta">‚Üì</span>` : "‚Üì Decrescente";
        }
        
        hideLoading();
      })
      .catch(error => {
        console.error('Erro ao carregar dados:', error);
        hideLoading();
        // Opcional: Avisar se falhar
        // alert('Ainda processando atualiza√ß√£o. Tente novamente em 1 minuto.');
      });
  
  
  
// Substitua sua fun√ß√£o inteira por esta
function alternarOrdenacao() {
  ordemCrescente = !ordemCrescente;

  // Usa a lista que est√° sendo exibida (filtrada ou n√£o) para reordenar
  const listaParaOrdenar = logsFiltrados.length ? logsFiltrados : logs;
  const botao = document.getElementById("botaoOrdenacao");
  const simbolo = ordemCrescente ? "‚Üì" : "‚Üë";

  listaParaOrdenar.sort((a, b) => {
    const [dataStrA, horaStrA] = a.exclusao.split(' ');
    const [dataStrB, horaStrB] = b.exclusao.split(' ');
    const dataA = new Date(dataStrA.split('/').reverse().join('-') + 'T' + horaStrA);
    const dataB = new Date(dataStrB.split('/').reverse().join('-') + 'T' + horaStrB);
    return ordemCrescente ? dataA - dataB : dataB - dataA;
  });

  botao.innerHTML = isMobile()
    ? `<span class="icone-seta">${simbolo}</span>`
    : (ordemCrescente ? "‚Üì Decrescente" : "‚Üë Crescente");

  exibirLogs(listaParaOrdenar);
}




		

        if (isMobile()) {
            const dataInput = document.getElementById("data");

            dataInput.type = "text";
            dataInput.value = "dd/mm/aaaa";

            dataInput.addEventListener("focus", () => {
                if (dataInput.value === "dd/mm/aaaa") {
                    dataInput.value = "";
                    dataInput.type = "date";
                    setTimeout(() => dataInput.showPicker(), 10);
                }
            });

            dataInput.addEventListener("blur", () => {
                if (dataInput.value === "") {
                    dataInput.type = "text";
                    dataInput.value = "dd/mm/aaaa";
                }
            });
        }
		
		

function exibirLogs(lista) {
    const logsContainer = document.getElementById('logs');
    logsContainer.innerHTML = '';
    const fragment = document.createDocumentFragment();

    lista.forEach((log) => {
        const logEntryDiv = document.createElement('div');
        logEntryDiv.className = 'log-entry';

        // --- Formata√ß√£o da Data ---
        let dataParts = log.exclusao.split(' ');
        let dataFormatada = dataParts[0].split('/').reverse().join('-') + 'T' + dataParts[1] + ':00';   
        let date = new Date(dataFormatada);
        let formattedDate = isNaN(date) ? 'Data inv√°lida' : date.toLocaleString('pt-BR', {
            day: '2-digit', month: '2-digit', year: 'numeric',
            hour: '2-digit', minute: '2-digit'
        }).replace(',', '');
        
        // --- Dura√ß√£o ---
        let duracaoDisplay = log.duracao;
        let isPiramide = false;
        if (typeof duracaoDisplay === 'number') {
            if (duracaoDisplay === 3) { duracaoDisplay = "2 Horas - Pir√¢mide"; isPiramide = true; }
            else if (duracaoDisplay === 2) duracaoDisplay = "2 Horas";
            else duracaoDisplay = "1 Hora";
        } else if (typeof duracaoDisplay === 'string' && duracaoDisplay.includes('Pir√¢mide')) {
            isPiramide = true;
        }

        // --- Jogadores (Cabe√ßalho - Usa APELIDOS) ---
        let listaDeApelidos = [];
        if (Array.isArray(log.jogadores)) {
            listaDeApelidos = log.jogadores.map(j => (typeof j === 'object' ? j.apelido : j));
        }

        const socios = listaDeApelidos.filter(j => !j.startsWith("Convidado"));
        const convidados = listaDeApelidos.filter(j => j.startsWith("Convidado - ")).map(j => j.replace("Convidado - ", ""));

        // Busca o status usando o Apelido como chave para pintar o cabe√ßalho
        const sociosFormatados = socios.map(apelido => {
            const apelidoLimpo = apelido.trim();
            let estilo = 'color: #ff9800; font-weight: bold;'; // Laranja (Padr√£o)
            
            if (log.confirmacoes && log.confirmacoes[apelidoLimpo]) {
                const valorBruto = log.confirmacoes[apelidoLimpo].toString();
                const statusReal = valorBruto.split('|')[0]; 

                if (statusReal === 'true' || statusReal === 'confirmado') {
                    estilo = 'color: #28a745; font-weight: bold;'; // Verde
                } else if (statusReal === 'recusado') {
                    estilo = 'color: #dc3545; text-decoration: line-through; font-weight: bold;'; // Vermelho Riscado
                }
            }
            if (log.organizadorDaReserva && apelidoLimpo.toLowerCase() === log.organizadorDaReserva.trim().toLowerCase()) {
                 if (!estilo.includes('line-through')) estilo = 'color: #28a745; font-weight: bold;';
            }
            return `<span style="${estilo}">${apelidoLimpo}</span>`;
        });

        let jogadoresHtml = sociosFormatados.join(', ');
        
        // ==================================================================================
        // --- Detalhes (Tabela - Usa NOMES COMPLETOS) ---
        // ==================================================================================
        let divDetalhesJogadores = '';
        
        if (!isPiramide && log.confirmacoes && Object.keys(log.confirmacoes).length > 0) {
            const confId = `conf-${log.id}`;
            
            jogadoresHtml += ` <a href="javascript:void(0);" onclick="toggleDisplay('${confId}', this)" style="margin-left: 10px; color: #007bff; text-decoration: none; cursor: pointer;">Detalhes</a>`;

            let rows = '';
            
            // 1. FILTRO: Removemos "Convidado" da lista de detalhes
            const nomesOrdenados = Object.keys(log.confirmacoes).filter(n => !n.startsWith('Convidado')).sort();
            
            nomesOrdenados.forEach(apelido => {
                const valorBruto = log.confirmacoes[apelido].toString(); 
                const partes = valorBruto.split('|');
                const rawStatus = partes[0];
                const nomeCompletoExibicao = partes[1] || apelido;

                // --- DEFINI√á√ÉO PADR√ÉO (PENDENTE) ---
                let statusTexto = 'Pendente';
                let statusCor = '#ff9800'; // Laranja
                
                // === AQUI EST√Å: ? GRANDE E EM NEGRITO ===
                let icone = '<span style="font-size: 16px; font-weight: bold; line-height: 1;">?</span>'; 

                // --- VERIFICA√á√ïES ---
                if (rawStatus === 'true' || rawStatus === 'confirmado') {
                    statusTexto = 'Confirmado'; 
                    statusCor = '#28a745'; // Verde
                    icone = '‚úì';
                } else if (rawStatus === 'recusado') {
                    statusTexto = 'Recusado'; 
                    statusCor = '#dc3545'; // Vermelho
                    icone = '‚úñ';
                }

                rows += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 8px 0; color: #333; text-align: left;">${capitalizarNome(nomeCompletoExibicao)}</td>
                        <td style="padding: 8px 0; text-align: right; color: ${statusCor}; font-weight: bold; white-space: nowrap;">
                            ${icone} ${statusTexto}
                        </td>
                    </tr>`;
            });

            divDetalhesJogadores = `
                <div id="${confId}" style="display: none; width: 100%; background: #fdfdfd; padding: 5px 15px; border: 1px solid #eee; border-radius: 5px; margin-top: 8px; margin-bottom: 10px; box-sizing: border-box;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                        ${rows}
                    </table>
                </div>`;
        }
        // ==================================================================================

        let convidadosHtml = ''; 
        if (convidados.length > 0) {
            convidadosHtml = `<p>Convidados: ${convidados.join(', ')}</p>`;
        }

        // --- Restante (Resultado, Status Geral, Motivo) ---
        let resultadoHtml = '';
        const resultadoId = `resultado-${log.id}`;
        let detalhesPlacar = '';
        if (log.resultado && Array.isArray(log.jogadores) && log.jogadores.length > 0) {
            detalhesPlacar = gerarPlacarPiramideHtml(log.resultado, log.jogadores);
        } else if (log.resultadoDuplas) {
            detalhesPlacar = gerarPlacarDuplasHtml(log.resultadoDuplas);
        }
        if (detalhesPlacar) {
            resultadoHtml = `
                <p style="margin-top: 8px; margin-bottom: 2px;">
                    <strong>Resultado do Jogo:</strong> 
                    <a href="javascript:void(0);" onclick="toggleDisplay('${resultadoId}', this)" style="color: #007bff; text-decoration: none;">Detalhes</a>
                </p>
                <div id="${resultadoId}" style="display: none;">${detalhesPlacar}</div>`;
        }

        let detalhesConfirmacao = '';
        if (log.statusNoMomentoDaExclusao) {
            const statusLower = log.statusNoMomentoDaExclusao.toLowerCase();
            let statusStyle = 'color: green;'; 
            if (statusLower.includes('pendente') || statusLower.includes('aguardando')) statusStyle = 'color: orange;';
            else if (statusLower.includes('expirada') || statusLower.includes('recusado')) statusStyle = 'color: red;';
            else if (statusLower.includes('cancelada')) statusStyle = 'color: #db7093;'; 
            else if (statusLower.includes('finalizada')) statusStyle = 'color: #007bff;';

            const statusFmt = capitalizarNome(log.statusNoMomentoDaExclusao.replace(/_/g, ' '));
            detalhesConfirmacao += `<p style="font-size: 0.9em; margin-top: 8px;"><strong>Status Geral:</strong> <span style="${statusStyle} font-weight: bold;">${statusFmt}</span></p>`;
            
            if (log.organizadorDaReserva) {
                detalhesConfirmacao += `<p style="font-size: 0.9em;"><strong>Organizador:</strong> ${log.organizadorDaReserva}</p>`;
            }
        }

        let motivoHtml = '';
        if (log.motivo) {
            let estilo = "font-style: italic; color: #555;";
            let icone = "";
            if (log.motivo.includes("Grade Fixa")) { estilo = "color: #28a745; font-weight: bold;"; icone = "üîì "; }
            else if (log.motivo.includes("Aula Extra")) { estilo = "color: #d9534f; font-weight: bold;"; icone = "üö´ "; }
            motivoHtml = `<p style="font-size: 0.9em;"><strong>Motivo:</strong> <span style="${estilo}">${icone}${log.motivo}</span></p>`;
        }

        logEntryDiv.innerHTML = `
            <button onclick="solicitarExclusaoLog(${log.id})" style="float: right; cursor: pointer; background: #f2f2f2; color: #dc3545; border: 1px solid #dc3545; border-radius: 50%; width: 24px; height: 24px; font-size: 14px; font-weight: bold; line-height: 22px; text-align: center; padding: 0;">X</button>
            <p><strong>Exclus√£o: ${formattedDate}</strong></p>
            <p><strong>Data da Reserva:</strong> ${log.data}</p>
            <p>${log.quadra} | ${log.horario}</p>
            <p>Dura√ß√£o: ${duracaoDisplay || 'N/A'}</p>
            
            <p>Jogadores: ${jogadoresHtml}</p>
            ${divDetalhesJogadores}
            
            ${convidadosHtml} 
            ${resultadoHtml}
            
            <p style="margin-top:10px;">Exclu√≠do por: <strong>${log.usuario || 'N/A'}</strong></p>
            ${detalhesConfirmacao}
            ${motivoHtml} 
            <hr>`;
        fragment.appendChild(logEntryDiv);
    });
    logsContainer.appendChild(fragment);
    document.getElementById('total-registros').textContent = `Total de registros: ${lista.length}`;
}


// Substitua sua fun√ß√£o solicitarExclusaoLog por esta
function solicitarExclusaoLog(logId) {
    // A fun√ß√£o agora encontra o log pelo 'id' persistente
    const logParaExcluir = logs.find(log => log.id === logId);

    if (!logParaExcluir) {
        alert("Erro: N√£o foi poss√≠vel encontrar o registro do log para exclus√£o.");
        return;
    }
	
	const nomesDosJogadores = logParaExcluir.jogadores.map(j => j.apelido).join(', ');
   

    const resumoDaReserva = `\n\nQuadra: ${logParaExcluir.quadra}\n` +
                           `Data: ${logParaExcluir.data}\n` +
                           `Hor√°rio: ${logParaExcluir.horario}\n` +
                           `Jogadores: ${nomesDosJogadores}`; // Usa a nova vari√°vel com os nomes corretos


    if (confirm(`‚ö†Ô∏è Aten√ß√£o!\n\nTem certeza que deseja excluir este registro do log permanentemente? A a√ß√£o n√£o pode ser desfeita.` + resumoDaReserva)) {
        
        // "Lembramos" o ID persistente do log que foi exclu√≠do
        let idsExcluidos = JSON.parse(sessionStorage.getItem('idsExcluidos')) || [];
        if (!idsExcluidos.includes(logId)) {
            idsExcluidos.push(logId);
        }
        sessionStorage.setItem('idsExcluidos', JSON.stringify(idsExcluidos));
        
        const indexParaRemover = logs.findIndex(log => log.id === logId);
        if (indexParaRemover > -1) {
            logs.splice(indexParaRemover, 1);
            if (logsFiltrados.length > 0) {
                const indexFiltrado = logsFiltrados.findIndex(log => log.id === logId);
                if (indexFiltrado > -1) {
                    logsFiltrados.splice(indexFiltrado, 1);
                }
            }
            const listaParaExibir = logsFiltrados.length > 0 ? logsFiltrados : logs;
            exibirLogs(listaParaExibir);
            salvarLogsNoGithub(logs);
        }
    }
}




// Substitua sua fun√ß√£o salvarLogsNoGithub por esta
async function salvarLogsNoGithub(logsParaSalvar) {
    const token = githubToken;
    if (!token) {
        alert("Token de autentica√ß√£o do GitHub n√£o foi carregado. A p√°gina ser√° recarregada para tentar novamente.");
        location.reload();
        return;
    }

    const usuarioGit = 'clube-olimpico';
    const repo = 'Reservas';
    const caminhoArquivo = 'logs/reservas-excluidas.json';
    const url = `https://api.github.com/repos/${usuarioGit}/${repo}/contents/${caminhoArquivo}`;

    try {
        let response = await fetch(url, { 
            headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' },
            cache: 'no-cache'
        });
        if (!response.ok) throw new Error(`Erro ao buscar arquivo: ${response.status}`);
        let fileData = await response.json();

        // Antes de salvar, remove o campo 'id' tempor√°rio para manter o arquivo limpo
        const logsLimpos = logsParaSalvar.map(({ id, ...resto }) => resto);

        response = await fetch(url, {
            method: 'PUT',
            headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: `Log removido por usu√°rio em ${new Date().toLocaleString('pt-BR')}`,
                content: utf8_to_b64(JSON.stringify(logsLimpos, null, 2)),
                sha: fileData.sha
            }),
            cache: 'no-cache'
        });

        if (!response.ok) throw new Error(`Falha no upload: ${response.status}`);
        
        console.log("‚úÖ Log exclu√≠do e salvo no GitHub com sucesso!");
        // A MENSAGEM DE SUCESSO AGORA √â OPCIONAL, POIS A UI J√Å FOI ATUALIZADA
        // alert("Registro de log exclu√≠do com sucesso!"); 
        
        // --- CORRE√á√ÉO PRINCIPAL ---
        // A linha location.reload() foi REMOVIDA daqui.

    } catch (erro) {
        console.error('‚ùå Erro ao salvar o arquivo de logs no GitHub:', erro);
        alert("Ocorreu um erro ao tentar salvar a exclus√£o do log. A p√°gina ser√° recarregada para garantir a consist√™ncia dos dados.");
        location.reload(true); // Recarrega a p√°gina apenas em caso de erro
    }
}


// ==========================================================
// SUBSTITUA SUA FUN√á√ÉO filtrarLogs() POR ESTA VERS√ÉO CORRIGIDA
// ==========================================================

// ===================================================================
// SUBSTITUA SUA FUN√á√ÉO filtrarLogs() POR ESTA VERS√ÉO CORRIGIDA
// ===================================================================

// ==========================================================
// VERS√ÉO FINAL E CORRIGIDA da fun√ß√£o filtrarLogs
// ==========================================================

function filtrarLogs() {
    const quadra = document.getElementById('quadra').value.trim();
    const dataInput = document.getElementById('data');
    const jogador = document.getElementById('jogador').value.toLowerCase().trim();
    const duracao = document.getElementById('duracao').value.trim();
    const status = document.getElementById('status').value.trim();
    const data = (dataInput.value === "dd/mm/aaaa" || dataInput.value === "") ? null : dataInput.value;

    logsFiltrados = logs.filter(log => {
        // As outras condi√ß√µes de filtro n√£o mudam
        const condQuadra = quadra === "" || quadra.toLowerCase() === "todas" || log.quadra === quadra;
        const condData = !data || log.data === data.split('-').reverse().join('-');
        const condJogador = !jogador || (log.jogadores && log.jogadores.some(j => {
            const apelido = (typeof j === "object" && j.apelido) ? j.apelido : (typeof j === "string" ? j : "");
            return apelido.toLowerCase().includes(jogador);
        }));
        let condDuracao = true;
        if (duracao === "Pir√¢mide") { /*...*/ } else if (duracao === "2 Horas") { /*...*/ } // ...l√≥gica de dura√ß√£o...

        // ==========================================================
        // L√ìGICA DE FILTRO DE STATUS QUE ENTENDE OS DADOS ATUAIS
        // ==========================================================
        let condStatus = true;
        const statusDoLog = (log.statusNoMomentoDaExclusao || 'sem_status'); // Mant√©m mai√∫sculas/min√∫sculas originais

        if (status && status !== 'voltar') {
            if (status.startsWith('categoria_')) {
                const categoria = status.split('_')[1]; // "reserva" ou "jogo"
                
                // Listas de status que definem cada categoria
                const statusesDeJogo = ['em_andamento', 'resultado_pendente', 'resultado_recusado', 'finalizada', 'Aguardando'];
                const statusesDeReserva = ['pendente', 'confirmada', 'expirada'];

                if (categoria === 'jogo') {
                    condStatus = statusesDeJogo.includes(statusDoLog);
                } else if (categoria === 'reserva') {
                    condStatus = statusesDeReserva.includes(statusDoLog);
                }
            } else {
                // Filtra pelo status espec√≠fico selecionado
                condStatus = statusDoLog === status;
            }
        }
        // ==========================================================

        return condQuadra && condData && condJogador && condDuracao && condStatus;
    });
     
    exibirLogs(logsFiltrados);
}


// ==========================================================
// VERS√ÉO CORRIGIDA - Usa os valores de status REAIS
// ==========================================================

function gerenciarFiltroStatusDinamico() {
    const statusSelect = document.getElementById('status');

    // A CORRE√á√ÉO EST√Å NOS 'value' ABAIXO
    const menus = {
        principal: [
            { value: "", text: "Todas" },
            { value: "categoria_reserva", text: "Reserva" },
            { value: "categoria_jogo", text: "Jogo" }
        ],
        reserva: [
            { value: "categoria_reserva", text: "Todas as Reservas" }, 
            { value: "pendente", text: "Pendente" },
            { value: "confirmada", text: "Confirmada" },
            { value: "expirada", text: "Expirada" },
			{ value: "cancelada", text: "Cancelada" }, 
            { value: "voltar", text: "‚Ü© Menu Principal" } 
        ],
        jogo: [
            { value: "categoria_jogo", text: "Todos os Jogos" },
			{ value: "Aguardando", text: "Aguardando" },
            { value: "em_andamento", text: "Em Andamento" },
            { value: "finalizada", text: "Finalizado" },
            { value: "Cancelada", text: "Cancelado" }, // Mantendo o "C" mai√∫sculo como nos seus dados
			{ value: "resultado_pendente", text: "Resultado Pendente" },
            { value: "resultado_recusado", text: "Resultado Recusado" },
            { value: "voltar", text: "‚Ü© Menu Principal" }
        ]
    };

    function popularOpcoes(nomeMenu) {
        statusSelect.innerHTML = '';
        menus[nomeMenu].forEach(opt => {
            const option = document.createElement('option');
            option.value = opt.value;
            option.textContent = opt.text;
            statusSelect.appendChild(option);
        });
    }

    statusSelect.addEventListener('change', function() {
        const valorSelecionado = this.value;

        if (valorSelecionado === 'categoria_reserva') {
            popularOpcoes('reserva');
        } else if (valorSelecionado === 'categoria_jogo') {
            popularOpcoes('jogo');
        } else if (valorSelecionado === 'voltar') {
            popularOpcoes('principal');
        }
    });
}


// Inicia a funcionalidade quando a p√°gina carrega
window.addEventListener('load', gerenciarFiltroStatusDinamico);
		
		
function gerarPDF() {
	const { jsPDF } = window.jspdf;
	const pdf = new jsPDF("p", "mm", "a4");
	const pageHeight = 297;
	const margin = 10;
	let y = margin;

	const totalContainer = document.getElementById("total-registros-container");
	totalContainer.style.display = "none";

	const logEntries = document.querySelectorAll('.log-entry');
	const total = document.getElementById("total-registros").textContent;

	let nomeArquivo = "Reservas";
	switch (document.getElementById("duracao").value) {
		case "1 Hora":
			nomeArquivo = "Reservas-1-Hora";
			break;
		case "2 Horas":
			nomeArquivo = "Reservas-2-Horas";
			break;
		case "2 Horas - Pir√¢mide":
			nomeArquivo = "Reservas-Piramide";
			break;
		case "Convidado":
			nomeArquivo = "Reservas-Convidados";
			break;
		default:
			nomeArquivo = "Reservas-Filtradas";
	}

	// Fun√ß√£o auxiliar para processar logs de forma ass√≠ncrona
	const processarLogs = async () => {
		for (let i = 0; i < logEntries.length; i++) {
			const entry = logEntries[i];
			await html2canvas(entry, { scale: 2 }).then(canvas => {
				const imgData = canvas.toDataURL('image/png');
				const imgWidth = 190; // largura com margens
				const imgHeight = (canvas.height * imgWidth) / canvas.width;

				// Se passar do limite da p√°gina, adiciona uma nova
				if (y + imgHeight > pageHeight - margin) {
					pdf.addPage();
					y = margin;
				}

				pdf.addImage(imgData, 'PNG', margin, y, imgWidth, imgHeight);
				y += imgHeight + 5; // espa√ßamento entre entradas
			});
		}

		// Ap√≥s todos os logs, adiciona o total de registros no final
		if (y + 10 > pageHeight - margin) {
			pdf.addPage();
			y = margin;
		}
		const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
		pdf.setFontSize(isMobile ? 30 : 12);
		pdf.text(total, margin, pageHeight - 10);


		pdf.save(`${nomeArquivo}.pdf`);
		totalContainer.style.display = "block";
	};

	processarLogs();
}







// Adicione esta nova fun√ß√£o ao seu script
function carregarToken() {
    db.ref('sistemas/config/githubToken').once('value', (snapshot) => {
        if (snapshot.exists()) {
            githubToken = snapshot.val();
            console.log("‚úÖ Token do GitHub carregado com sucesso.");
        } else {
            console.error("‚ùå Token do GitHub n√£o encontrado no Firebase em /sistemas/config/githubToken");
        }
    });
}

// Chama a fun√ß√£o para carregar o token quando a p√°gina carregar
window.onload = function() {
    carregarToken();
	atualizarCorStatus(document.getElementById('status'));
};

// Fun√ß√£o auxiliar para codificar corretamente strings com caracteres especiais
function utf8_to_b64(str) {
    return btoa(unescape(encodeURIComponent(str)));
}

function showLoading() {
    document.getElementById('loadingScreen').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loadingScreen').style.display = 'none';
    document.getElementById('conteudo').style.display = 'block';
}

function atualizarCorStatus(selectElement) {
    // Pega a op√ß√£o que est√° selecionada no momento
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    
    // Pega a cor e o peso da fonte do estilo da op√ß√£o selecionada
    const color = selectedOption.style.color;
    const fontWeight = selectedOption.style.fontWeight;

    // Aplica a cor e o peso da fonte ao pr√≥prio elemento <select>
    selectElement.style.color = color || 'black'; // Usa preto como padr√£o
    selectElement.style.fontWeight = fontWeight || 'normal'; // Usa peso normal como padr√£o
}

function mostrarStatusJogador(nomeJogador, status) {
    alert(`${nomeJogador}: ${status}`);
}


// Adicione esta nova fun√ß√£o ao seu script
// Fun√ß√£o gen√©rica para mostrar/esconder elementos (Placar ou Detalhes Jogadores)
// Fun√ß√£o gen√©rica para mostrar/esconder elementos
// Fun√ß√£o gen√©rica para mostrar/esconder elementos
function toggleDisplay(elementId, linkElement) {
    const el = document.getElementById(elementId);
    if (el) {
        if (el.style.display === 'none') {
            el.style.display = 'block';
            linkElement.textContent = 'Ocultar'; // Sem par√™nteses
        } else {
            el.style.display = 'none';
            linkElement.textContent = 'Detalhes'; // Sem par√™nteses
        }
    }
}


// Adicione esta nova fun√ß√£o ao seu script
function capitalizarNome(nome) {
    if (!nome || typeof nome !== 'string') return "";
    return nome.toLowerCase().split(' ').map(palavra => palavra.charAt(0).toUpperCase() + palavra.slice(1)).join(' ');
}

// Adicione esta fun√ß√£o "calculadora" ao seu script
function getDisplayRank(piramidePosStr) {
    if (!piramidePosStr || piramidePosStr === "0") {
        return null;
    }
    const piramidePos = parseInt(piramidePosStr, 10);
    if (isNaN(piramidePos)) {
        return null;
    }
    // Se a posi√ß√£o for 61 ou maior, subtrai 60 para obter o rank real da pir√¢mide feminina
    return piramidePos >= 61 ? piramidePos - 60 : piramidePos;
}


// COLE ESTA NOVA FUN√á√ÉO NO FINAL DO SEU SCRIPT
function gerarPlacarDuplasHtml(resultadoDuplas) {
    if (!resultadoDuplas || !resultadoDuplas.confrontos) return "";

    let html = '<div class="placar-container">';

    resultadoDuplas.confrontos.forEach(jogo => {
        const [placarA, placarB] = jogo.placar.split('x').map(Number);
        const timeAVenceu = placarA > placarB;

        const dupla1Nomes = jogo.dupla1.replace(' / ', '<br>');
        const dupla2Nomes = jogo.dupla2.replace(' / ', '<br>');

        let placarHtml;
        
        if (jogo.tiebreak) {
            const [tbA, tbB] = jogo.tiebreak.split('-');
            placarHtml = `
                <span class="set-score ${timeAVenceu ? 'winner' : ''}">${placarA}<sup>${tbA}</sup></span>
                <span>&times;</span>
                <span class="set-score ${!timeAVenceu ? 'winner' : ''}">${placarB}<sup>${tbB}</sup></span>
            `;
        } else {
            placarHtml = `
                <span class="set-score ${timeAVenceu ? 'winner' : ''}">${placarA}</span>
                <span>&times;</span>
                <span class="set-score ${!timeAVenceu ? 'winner' : ''}">${placarB}</span>
            `;
        }

        html += `
            <div class="matchup-row" style="padding: 2px 0; font-size: 0.95em; align-items: center;">
                <span class="team-names" style="font-weight: ${timeAVenceu ? 'bold' : 'normal'}; text-align: center; flex-basis: 40%;">${dupla1Nomes}</span>
                <div class="score-input-container" style="flex-basis: 20%; display: flex; justify-content: center; gap: 8px; font-weight: bold; font-size: 1.2em;">
                    ${placarHtml}
                </div>
                <span class="team-names" style="font-weight: ${!timeAVenceu ? 'bold' : 'normal'}; text-align: center; flex-basis: 40%;">${dupla2Nomes}</span>
            </div>
        `;
    });

    html += '</div>';
    
    const dataInformado = new Date(resultadoDuplas.dataInformado).toLocaleString('pt-BR');
    html += `<p style="text-align: left; font-size: 0.8em; color: #888; margin-top: 15px;">Informado por ${resultadoDuplas.informadoPor} em ${dataInformado}.</p>`;

    return html;
}


// ADICIONE ESTA NOVA FUN√á√ÉO AO SEU SCRIPT
// SUBSTITUA SUA FUN√á√ÉO ATUAL POR ESTA VERS√ÉO CORRIGIDA
// SUBSTITUA SUA FUN√á√ÉO ATUAL POR ESTA VERS√ÉO CORRIGIDA
function gerarPlacarPiramideHtml(resultado, jogadores) {
    if (!resultado || !Array.isArray(jogadores) || !resultado.vencedor) return '';

    // Jogadores na ordem em que foram salvos no log (fonte da verdade)
    const jogador1Obj = (typeof jogadores[0] === 'object') ? jogadores[0] : { apelido: jogadores[0], posicao: '0' };
    const jogador2Obj = (typeof jogadores[1] === 'object') ? jogadores[1] : { apelido: jogadores[1], posicao: '0' };

    // Identifica o vencedor e o perdedor DA PARTIDA para ordenar as linhas
    const jogador1DaListaEhVencedorDaPartida = resultado.vencedor.toUpperCase() === jogador1Obj.apelido.toUpperCase();
    const vencedorDaPartida = jogador1DaListaEhVencedorDaPartida ? jogador1Obj : jogador2Obj;
    const perdedorDaPartida = jogador1DaListaEhVencedorDaPartida ? jogador2Obj : jogador1Obj;

    // Arrays para guardar os scores HTML de cada set
    const scoresVencedorPartida = [];
    const scoresPerdedorPartida = []; 

    ['set1', 'set2', 'set3'].forEach(setKey => {
        const setData = resultado[setKey];
        if (setData) {
            const setPlacar = typeof setData === 'string' ? setData : setData.placar;
            const setTiebreak = typeof setData === 'object' ? setData.tiebreak : null;

            if (setPlacar && setPlacar.includes('x')) {
                // s1 √© o score do jogador1 da lista, s2 √© o score do jogador2 da lista
                const [s1_str, s2_str] = setPlacar.split('x');
                const s1 = parseInt(s1_str, 10);
                const s2 = parseInt(s2_str, 10);
                
                let tb1_str = '', tb2_str = '';
                if(setTiebreak && setTiebreak.includes('-')){
                    [tb1_str, tb2_str] = setTiebreak.split('-'); 
                }

                // Determina quem venceu ESTE SET para aplicar o negrito
                const jogador1VenceuEsteSet = s1 > s2;

                // Monta o HTML para o score de cada jogador neste set
                const score1Html = `<span class="set-score ${jogador1VenceuEsteSet ? 'winner' : ''}">${s1_str}${tb1_str ? `<sup>${tb1_str}</sup>` : ''}</span>`;
                const score2Html = `<span class="set-score ${!jogador1VenceuEsteSet ? 'winner' : ''}">${s2_str}${tb2_str ? `<sup>${tb2_str}</sup>` : ''}</span>`;

                // Adiciona o HTML do score no array correto (do vencedor da partida vs perdedor da partida)
                if (jogador1DaListaEhVencedorDaPartida) {
                    scoresVencedorPartida.push(score1Html);
                    scoresPerdedorPartida.push(score2Html);
                } else {
                    scoresVencedorPartida.push(score2Html);
                    scoresPerdedorPartida.push(score1Html);
                }
            }
        }
    });

    const rankVencedor = getDisplayRank(vencedorDaPartida.posicao);
    const rankPerdedor = getDisplayRank(perdedorDaPartida.posicao);
    const vencedorPosicaoHtml = rankVencedor ? `<span class="placar-posicao">${rankVencedor}</span>` : '';
    const perdedorPosicaoHtml = rankPerdedor ? `<span class="placar-posicao">${rankPerdedor}</span>` : '';

    return `
        <div class="placar-container">
            <div class="placar-row">
                ${vencedorPosicaoHtml}
                <span class="placar-nome match-winner">${capitalizarNome(vencedorDaPartida.apelido)}</span>
                <span class="placar-sets">${scoresVencedorPartida.join('')}</span>
            </div>
            <div class="placar-row">
                ${perdedorPosicaoHtml}
                <span class="placar-nome">${capitalizarNome(perdedorDaPartida.apelido)}</span>
                <span class="placar-sets">${scoresPerdedorPartida.join('')}</span>
            </div>
        </div>`;
}







</script>
	
<div id="total-registros-container">
    <span id="total-registros">Total de registros: 0</span>
</div>
</div>

</body>

</html>
